<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Therapy Field Dashboard</title>
<!-- D3.js for Bubble Chart -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Chart.js for Emotia Graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<!-- GSAP for Menu Animations -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
<style>
/* CRITICAL: Apple-like Design Override - Load First */
#therapist-step-2 {
  background: transparent !important;
  background-image: none !important;
  background-color: transparent !important;
}
#therapist-step-2 .location-photo-container,
#therapist-step-2 .criteria-photo-container,
#therapist-step-2 .quiz-photo-container {
  height: 200px !important;
  border-radius: 1rem !important;
  border: 1px solid rgba(0, 0, 0, 0.06) !important;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
}
#therapist-step-2 .location-gradient,
#therapist-step-2 .criteria-gradient,
#therapist-step-2 .quiz-gradient {
  background: none !important;
  border: none !important;
  box-shadow: none !important;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Icons+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAgD6VoceOC-vy4GJW82f0ZaHsv1-EwSyM&libraries=places" defer></script>
  <script src="therapist-data.js"></script>
  <script src="fix-therapist-countries.js"></script>
  <script>
    // IMMEDIATE FIX FOR BERLIN COUNTRY ASSIGNMENT
    // This runs immediately after therapist data is loaded to ensure Berlin = Germany
    console.log('üîß IMMEDIATE FIX: Ensuring Berlin therapists are assigned to Germany...');
    
    // Wait for therapist data to be available
    function ensureBerlinIsGermany() {
      if (window.therapistData && window.therapistData.length > 0) {
        console.log('üîß IMMEDIATE FIX: Therapist data found, fixing Berlin assignments...');
        
        let fixedCount = 0;
        window.therapistData.forEach(therapist => {
          // Fix any Berlin therapists
          if (therapist.cityKey === 'berlin' || therapist.city === 'Berlin' || 
              (therapist.address && therapist.address.includes('Berlin'))) {
            if (therapist.country !== 'Germany') {
              console.log(`üîß FIXING: ${therapist.first_name} ${therapist.last_name} - Berlin should be Germany, was: ${therapist.country}`);
              therapist.country = 'Germany';
              fixedCount++;
            }
          }
          
          // Fix Berlin area assignments
          if (therapist.areaKey === 'charlottenburg' || therapist.areaKey === 'mitte' ||
              therapist.area === 'Charlottenburg' || therapist.area === 'Mitte') {
            if (therapist.country !== 'Germany') {
              console.log(`üîß FIXING AREA: ${therapist.first_name} ${therapist.last_name} - ${therapist.area} should be Germany, was: ${therapist.country}`);
              therapist.country = 'Germany';
              fixedCount++;
            }
          }
        });
        
        console.log(`‚úÖ IMMEDIATE FIX: Fixed ${fixedCount} Berlin country assignments`);
        
        // Verify the fix worked
        const berlinTherapists = window.therapistData.filter(t => 
          t.cityKey === 'berlin' || t.city === 'Berlin' || 
          t.areaKey === 'charlottenburg' || t.areaKey === 'mitte'
        );
        
        console.log('üîç VERIFICATION: Berlin therapists after fix:');
        berlinTherapists.forEach(t => {
          console.log(`   ${t.first_name} ${t.last_name}: ${t.city} -> ${t.country}`);
        });
        
      } else {
        console.log('‚è≥ IMMEDIATE FIX: Waiting for therapist data...');
        setTimeout(ensureBerlinIsGermany, 100);
      }
    }
    
    // Run immediately
    ensureBerlinIsGermany();
    
    // Also run when DOM is loaded
    document.addEventListener('DOMContentLoaded', ensureBerlinIsGermany);
  </script>
  <script src="instant-filter-override.js"></script>
  <script src="improved-location-filter.js"></script>
  <script src="smart-country-extractor.js"></script>
  <script src="country-city-filter.js"></script>
  <script src="debug-country-detection.js"></script>
  <script src="fixed-country-extractor.js"></script>
  <script src="registration-address-extractor.js"></script>
  <script src="simple-data-driven-filter.js"></script>
<script src="therapist-availability.js"></script>
<script src="therapist-booking.js"></script>
<script src="quiz-system.js"></script>
<script src="localStorage-integration-fix.js"></script>
<script src="filter-fix-direct.js"></script>
<script src="filter-fix-aggressive.js"></script>
<script src="simple-filter-fix.js"></script>
<script src="berlin-diagnostic-system.js"></script>
<script src="authoritative-berlin-fix.js"></script>
<script src="therapy-session-cost-calculator.js"></script>
<link rel="stylesheet" href="landing-therapist-cards.css"/>
<style>
    /* Achievement button custom styles to ensure they use amber color */
    .quick-achievement-btn {
      background-color: rgba(251, 191, 36, 0.2) !important;
      color: rgb(180, 83, 9) !important;
    }
    .quick-achievement-btn:hover {
      background-color: rgba(251, 191, 36, 0.3) !important;
    }
    .quick-achievement-btn.selected, 
    .quick-achievement-btn.bg-amber-700 {
      background-color: rgb(180, 83, 9) !important;
      color: white !important;
    }
    
    /* Added styles for D3 Packed Bubble Chart animation */
    #emotions-chart-container .node .graph {
      opacity: 0;
      animation-name: animateIn;
      animation-duration: 0.8s;
      animation-fill-mode: forwards;
      transform-origin: center;
    }
    @keyframes animateIn {
      0% {
        opacity: 0;
        transform: scale(0.5) rotate(-10deg);
      }
      100% {
        opacity: 1;
        transform: scale(1) rotate(0);
      }
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f6f5fa;
    }
    .glassmorphism {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-primary {
      background-color: #8b5cf6;
      color: white;
    }
    .btn-primary:hover {
      background-color: #7c3aed;
    }
    .gradient-bg {
      background-image: linear-gradient(120deg, #8b5cf6 0%, #a78bfa 100%);
    }
    .mood-tracker-gradient {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        border:1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }
    /* Removed conflicting calendar-day.selected rule - using category-themed one instead */
    .calendar-dropdown {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
      z-index: 50;
      padding: 16px 24px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    .calendar-dropdown select {
      font-size: 1rem;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 6px 12px;
      outline: none;
      background: #f7f3ff;
      color: #4b2995;
      font-weight: 500;
    }
    .calendar-dropdown button {
      margin-top: 8px;
      background: #7b61ff;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 8px 0;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .calendar-dropdown button:hover {
      background: #6a5cff;
    }
    .calendar-month-year-btn {
      background: transparent;
      border: none;
      outline: none;
      box-shadow: none;
      color: #4b2995;
      font-size: 1.25rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
      transition: color 0.2s;
      text-decoration: none;
    }
    .calendar-month-year-btn:hover {
      color: #7b61ff;
      text-decoration: none;
    }
    .calendar-date-btn {
      transition: transform 0.15s cubic-bezier(.4,2,.6,1), box-shadow 0.15s;
      will-change: transform;
    }
    .calendar-date-btn:hover {
      transform: scale(1.13);
      z-index: 2;
      box-shadow: 0 2px 8px rgba(123,97,255,0.10);
    }
    .calendar-date-btn.selected {
      transform: scale(1.13);
      z-index: 2;
      box-shadow: 0 2px 8px rgba(123,97,255,0.18);
    }
    .mood-bg {
      position: absolute;
      inset: 0;
      z-index: 0;
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      filter: blur(32px) brightness(1.1) saturate(1.5);
      opacity: 0;
      transition: opacity 0.7s cubic-bezier(.4,2,.6,1);
      pointer-events: none;
      transform: scale(1.2);
      animation: gentle-pulse 12s infinite alternate ease-in-out;
    }
    
    /* Goal card button animations */
    .completed-today-btn:hover {
      transform: translateY(-2px) !important;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3) !important;
    }
    
    .update-goal-btn:hover {
      background-color: rgba(45, 107, 237, 0.05) !important;
      transform: translateY(-2px) !important;
    }
    
    /* Smoother transitions for all goal card buttons */
    .goal-card button {
      transition: transform 0.2s ease-in-out, 
                  box-shadow 0.2s ease-in-out, 
                  background-color 0.2s ease-in-out !important;
    }
    
    /* Focus states for accessibility */
    .goal-card button:focus {
      outline: 2px solid rgba(59, 130, 246, 0.5);
      outline-offset: 2px;
    }

    /* LIQUID GLASS BACK BUTTONS */
    #back-to-therapists-btn,
    #back-to-options-btn,
    #new-back-to-options-btn {
      background: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(25px) saturate(1.8) !important;
      -webkit-backdrop-filter: blur(25px) saturate(1.8) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.25),
        0 0 0 1px rgba(255, 255, 255, 0.05) !important;
      transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1) !important;
      position: relative;
      overflow: hidden;
    }

    #back-to-therapists-btn:before,
    #back-to-options-btn:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.6s;
    }

    #back-to-therapists-btn:hover,
    #back-to-options-btn:hover {
      background: rgba(255, 255, 255, 0.25) !important;
      transform: translateY(-2px) !important;
      box-shadow: 
        0 16px 40px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.35),
        0 0 0 1px rgba(255, 255, 255, 0.1) !important;
    }

    #back-to-therapists-btn:hover:before,
    #back-to-options-btn:hover:before {
      left: 100%;
    }

    /* LIQUID GLASS MENU BAR STYLES */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)"/></svg>');
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
    }

    #menu-toggle {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background-size: 200% 200%;
      animation: liquid-flow 15s ease infinite;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #menu-toggle.expanded {
      width: auto;
      min-width: 800px;
      height: 72px;
      border-radius: 36px;
      padding: 0 24px;
    }

    @keyframes liquid-flow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    #menu-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 28px;
      height: 28px;
      z-index: 3;
      transition: all 0.3s ease;
    }

    #menu-toggle.expanded #menu-icon {
      position: relative;
      top: auto;
      left: auto;
      transform: none;
      margin-right: 24px;
    }

    #menu-icon-material,
    #close-icon-material {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 28px;
      transition: opacity 0.4s ease;
      color: #9ca3af;
      filter: drop-shadow(0 1px 2px rgba(255, 255, 255, 0.8));
    }

    #close-icon-material {
      opacity: 0;
    }

    #menu-content {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      pointer-events: none;
      z-index: 3;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
    }

    #menu-toggle.expanded #menu-content {
      opacity: 1;
      transform: scale(1);
      pointer-events: all;
    }

    .menu-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 14px 18px;
      border-radius: 16px;
      text-decoration: none;
      color: #6b7280;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      font-size: 10px;
      white-space: nowrap;
      background: rgba(255, 255, 255, 0.05);
      border: none;
      transition: all 0.2s ease;
      cursor: pointer;
      user-select: none;
      min-width: 75px;
    }

    /* Mobile adjustments */
    @media (max-width: 768px) and (orientation: portrait) {
      .menu-item {
        gap: 4px;
        padding: 10px 12px;
        font-size: 9px;
        min-width: 60px;
      }
      
      #menu-toggle.expanded {
        min-width: 90vw;
        max-width: 90vw;
        height: auto;
        min-height: 80px;
        padding: 12px 16px;
      }
      
      #menu-content {
        flex-wrap: wrap;
        justify-content: center;
        max-width: 100%;
        gap: 6px;
      }
      
      #menu-container {
        bottom: 4px;
      }
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .menu-item:hover .menu-icon,
    .menu-item:hover .material-icons {
      transform: scale(1.1);
    }

    .menu-item span {
      transition: all 0.2s ease;
      transform-origin: center;
      filter: drop-shadow(0 1px 2px rgba(255, 255, 255, 0.8));
    }

    .menu-item:hover span {
      transform: scale(1.05);
      font-weight: 600;
    }

    .menu-item.active {
      background-color: rgba(255, 255, 255, 0.25);
      color: rgba(0, 0, 0, 0.85);
      font-weight: 600;
    }

    .menu-item.active .menu-icon {
      opacity: 1;
    }

    .menu-item-danger {
      color: rgba(255, 100, 100, 0.9) !important;
    }

    .menu-item-danger:hover {
      background-color: rgba(255, 100, 100, 0.15) !important;
    }

    .menu-item .material-icons {
      font-size: 26px;
      opacity: 0.9;
      color: #6b7280;
      transition: all 0.2s ease;
      transform-origin: center;
      filter: drop-shadow(0 1px 2px rgba(255, 255, 255, 0.8));
    }

    .menu-item .menu-icon {
      width: 26px;
      height: 26px;
      opacity: 0.9;
      transition: all 0.2s ease;
      transform-origin: center;
      filter: drop-shadow(0 1px 2px rgba(255, 255, 255, 0.8));
    }

    /* Mobile icon sizes */
    @media (max-width: 768px) and (orientation: portrait) {
      .menu-item .material-icons {
        font-size: 22px;
      }
      
      .menu-item .menu-icon {
        width: 22px;
        height: 22px;
      }
    }

    .menu-divider {
      width: 1px;
      height: 32px;
      background: rgba(255, 255, 255, 0.2);
      margin: 0 8px;
    }

    /* LIQUID GLASS EFFECTS */
    .liquid-glass-wrapper {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 0, 0, 0.1);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 2.2);
    }

    .liquid-glass-effect {
      position: absolute;
      z-index: 0;
      inset: 0;
      backdrop-filter: blur(20px) saturate(1.2);
      -webkit-backdrop-filter: blur(20px) saturate(1.2);
      filter: url(#glass-distortion);
      overflow: hidden;
      isolation: isolate;
      border-radius: inherit;
    }

    .liquid-glass-tint {
      z-index: 1;
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.25) 0%,
        rgba(255, 255, 255, 0.15) 50%,
        rgba(255, 255, 255, 0.1) 100%);
      border-radius: inherit;
    }

    .liquid-glass-shine {
      position: absolute;
      inset: 0;
      z-index: 2;
      overflow: hidden;
      border-radius: inherit;
      box-shadow: 
        inset 2px 2px 2px 0 rgba(255, 255, 255, 0.4),
        inset -2px -2px 2px 1px rgba(255, 255, 255, 0.2);
    }
    
    @keyframes gentle-pulse {
      0% { transform: scale(1.2); }
      100% { transform: scale(1.3); }
    }
    .mood-bg.active {
      opacity: 1;
    }
    .mood-btn img {
      transition: transform 0.18s cubic-bezier(.4,2,.6,1), box-shadow 0.18s;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 9999px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(123,97,255,0.08);
    }
    .mood-btn {
      border-radius: 9999px;
      background: transparent;
      padding: 25px 30px 20px 35px;
      outline: none;
      border: none;
    }
    .mood-btn:hover img,
    .mood-btn.selected img {
      transform: scale(1.18);
      box-shadow: 0 4px 24px 0 rgba(123,97,255,0.18);
      z-index: 2;
    }
    .modern-slider {
  width: 100%;
  max-width: 420px;
  height: 24px;
  display: flex;
  align-items: center;
  border-radius: 12px;
  background: linear-gradient(90deg, #e0d7fa 0%, #bba6fa 30%, #a78bfa 60%, #7b61ff 100%);
  outline: none;
  margin: 0 auto 0 auto;
  appearance: none;
  -webkit-appearance: none;
  position: relative;
  z-index: 2;
  box-shadow: 0 2px 16px 0 rgba(123,97,255,0.13);
  cursor: pointer;
  transition: all 0.6s cubic-bezier(.4,2,.6,1);
  border: 1.5px solid #e5e0fa;
}
    .modern-slider:hover, .modern-slider:focus {
      box-shadow: 0 4px 24px 0 rgba(123,97,255,0.18);
    }
    
    /* Emotia Animated Waves Styles */
    #emotia-waves-container {
      height: 450px;
      width: 400px;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 20px;
      overflow: visible;
    }
    
    /* Responsive waves container - bigger on larger screens */
    @media (min-width: 768px) {
      #emotia-waves-container {
        width: 550px !important;
      }
    }
    
    @media (min-width: 1024px) {
      #emotia-waves-container {
        width: 700px !important;
      }
    }
    
    @media (min-width: 1280px) {
      #emotia-waves-container {
        width: 800px !important;
      }
    }
    
    #emotia-waves {
      border-radius: 20px;
    }
    
    /* Glass Button Container */
    .glass-button {
      --bg-color: rgba(255, 255, 255, 0.25);
      --highlight: rgba(255, 255, 255, 0.75);
      --text: #ffffff;
      
      position: relative;
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      overflow: visible;
      background: transparent;
      transition: transform 0.2s ease;
      outline: none;
    }

    .glass-button:hover {
      transform: scale(1.05);
    }

    .glass-button:active {
      transform: scale(0.95);
    }

    .glass-filter,
    .glass-overlay,
    .glass-specular {
      position: absolute;
      inset: 0;
      border-radius: inherit;
    }

    .glass-filter {
      z-index: 1;
      backdrop-filter: blur(4px);
      filter: url(#glass-distortion) saturate(120%) brightness(1.15);
    }

    .glass-overlay {
      z-index: 2;
      background: var(--bg-color);
    }

    .glass-specular {
      z-index: 3;
      box-shadow: inset 1px 1px 1px var(--highlight);
    }

    .glass-content {
      position: relative;
      z-index: 4;
      color: var(--text);
      font-weight: 500;
      font-size: 16px;
    }

    /* Dark mode styles */
    @media (prefers-color-scheme: dark) {
      .glass-button {
        --bg-color: rgba(0, 0, 0, 0.25);
        --highlight: rgba(255, 255, 255, 0.15);
      }
    }
    
    /* Dusty Button Styles - matching mood selector */
    .dusty-button {
      background: rgba(139, 130, 116, 0.15);
      border: 1px solid rgba(139, 130, 116, 0.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: #4A4A4A;
      font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
      font-weight: 500;
      letter-spacing: -0.01em;
      box-shadow: 0 4px 16px rgba(139, 130, 116, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      outline: none;
    }
    
    .dusty-button:hover {
      background: rgba(139, 130, 116, 0.25);
      border: 1px solid rgba(139, 130, 116, 0.35);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 25px rgba(139, 130, 116, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }
    
    .dusty-button:active {
      transform: translateY(0px) scale(0.98);
      box-shadow: 0 2px 8px rgba(139, 130, 116, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    /* Mobile-specific styles for vertical view */
    @media (max-width: 768px) and (orientation: portrait) {
      .dusty-button {
        padding: 10px 20px;
        font-size: 0.875rem;
      }
      
      .modern-emotion-btn {
        padding: 10px 16px !important;
        font-size: 0.8rem !important;
        margin: 4px 2px !important;
      }
      
      #emotia-emotion-list {
        gap: 0.25rem !important;
      }
      
      /* Positivity Trend mobile adjustments */
              #emotia-positivity-filter .positivity-filter-btn {
          font-size: 12px !important;
          padding: 6px 12px !important;
        }
        
        /* Emotions Analysis mobile adjustments - same as positivity trend */
        #emotia-emotions-filter .emotions-filter-btn {
          font-size: 12px !important;
          padding: 6px 12px !important;
        }
        
        /* Smaller legend for mobile */
        #emotia-positivity-trend-chart {
          font-size: 10px !important;
        }
        
        .chart-legend {
          font-size: 10px !important;
        }
      
              /* Fix active button text color on mobile */
        #emotia-positivity-filter .positivity-filter-btn[style*="background: white"],
        #emotia-positivity-filter .positivity-filter-btn[style*="background:white"],
        #emotia-positivity-filter .positivity-filter-btn[style*="white"] {
          color: #374151 !important;
        }
        
        /* Force black text for active buttons */
        #emotia-positivity-filter .positivity-filter-btn {
          transition: all 0.2s ease !important;
        }
        
        #emotia-positivity-filter .positivity-filter-btn:active,
        #emotia-positivity-filter .positivity-filter-btn:focus {
          color: #374151 !important;
        }
        
        /* Grey container for mobile filters */
        #emotia-positivity-filter {
          background: rgba(243, 244, 246, 0.9) !important;
          border: 1px solid rgba(209, 213, 219, 0.8) !important;
        }
        
        /* Emotions filter mobile styling - same as positivity trend */
        #emotia-emotions-filter {
          background: rgba(243, 244, 246, 0.9) !important;
          border: 1px solid rgba(209, 213, 219, 0.8) !important;
        }
        
        /* Fix active button text color on mobile for emotions filter */
        #emotia-emotions-filter .emotions-filter-btn[style*="background: white"],
        #emotia-emotions-filter .emotions-filter-btn[style*="background:white"],
        #emotia-emotions-filter .emotions-filter-btn[style*="white"] {
          color: #374151 !important;
        }
        
        /* Force black text for active buttons */
        #emotia-emotions-filter .emotions-filter-btn {
          transition: all 0.2s ease !important;
        }
        
        #emotia-emotions-filter .emotions-filter-btn:active,
        #emotia-emotions-filter .emotions-filter-btn:focus {
          color: #374151 !important;
        }
        
        /* Ensure chart container has proper dimensions on mobile */
        #emotia-positivity-trend-chart {
          min-height: 300px !important;
          width: 100% !important;
        }
        
        /* Mobile emotions chart container optimization */
        #emotia-emotions-bubble-chart {
          width: 100% !important;
          max-width: 100% !important;
        }
        
        /* Make emotions chart fill container better on mobile */
        .h-\[500px\] {
          height: 450px !important; /* Slightly smaller for mobile */
          width: 100% !important;
          overflow: hidden !important;
        }
        
        /* Mobile emotion breakdown styling */
        .emotion-breakdown-item {
          padding: 8px 12px !important; /* Smaller padding */
        }
        
        .emotion-name {
          font-size: 12px !important; /* Smaller emotion name */
        }
        
        .emotion-stats {
          font-size: 10px !important; /* Smaller stats */
        }
        
        .emotion-count {
          font-size: 10px !important;
          margin-right: 4px !important;
        }
        
        .emotion-percentage {
          font-size: 9px !important; /* Smallest percentage text */
        }
        
        /* Emotion breakdown title */
        #emotion-details-container h3 {
          font-size: 14px !important; /* Smaller title */
          margin-bottom: 12px !important;
        }
        
        /* Total emotions text */
        #emotion-details-container .text-sm {
          font-size: 10px !important;
        }
        
        /* Mobile mood breakdown styling - same as emotions */
        .mood-breakdown-item {
          padding: 8px 12px !important; /* Smaller padding */
        }
        
        .mood-name {
          font-size: 12px !important; /* Smaller mood name */
        }
        
        .mood-stats {
          font-size: 10px !important; /* Smaller stats */
        }
        
        .mood-count {
          font-size: 10px !important;
          margin-right: 4px !important;
        }
        
        .mood-percentage {
          font-size: 9px !important; /* Smallest percentage text */
        }
        
        /* Mood breakdown title */
        #mood-analysis-details-container h3 {
          font-size: 14px !important; /* Smaller title */
          margin-bottom: 12px !important;
        }
        
        /* Total mood entries text */
        #mood-analysis-details-container .text-sm {
          font-size: 10px !important;
        }
        
        /* Mood filter mobile styling - same as other filters */
        #emotia-mood-analysis-filter .mood-filter-btn {
          font-size: 12px !important;
          padding: 6px 12px !important;
        }
        
        /* Grey container for mood filter on mobile */
        #emotia-mood-analysis-filter {
          background: rgba(243, 244, 246, 0.9) !important;
          border: 1px solid rgba(209, 213, 219, 0.8) !important;
        }
        
        /* Fix active button text color on mobile for mood filter */
        #emotia-mood-analysis-filter .mood-filter-btn[style*="background: white"],
        #emotia-mood-analysis-filter .mood-filter-btn[style*="background:white"],
        #emotia-mood-analysis-filter .mood-filter-btn[style*="white"] {
          color: #374151 !important;
        }
        
        /* Mood Factors filter mobile styling - same as other filters */
        #emotia-mood-factors-filter .mood-factors-filter-btn {
          font-size: 12px !important;
          padding: 6px 12px !important;
        }
        
        /* Grey container for mood factors filter on mobile */
        #emotia-mood-factors-filter {
          background: rgba(243, 244, 246, 0.9) !important;
          border: 1px solid rgba(209, 213, 219, 0.8) !important;
        }
        
        /* Fix active button text color on mobile for mood factors filter */
        #emotia-mood-factors-filter .mood-factors-filter-btn[style*="background: white"],
        #emotia-mood-factors-filter .mood-factors-filter-btn[style*="background:white"],
        #emotia-mood-factors-filter .mood-factors-filter-btn[style*="white"] {
          color: #374151 !important;
        }
        
        /* Ensure section is visible and properly sized */
        .emotia-positivity-section {
          min-height: 400px !important;
          display: block !important;
        }
      
      section h2 {
        font-size: 16px !important;
      }
      
      /* Animation for emotion details */
      .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    }
    
    /* Minimal Slider Styles */
    .emotia-minimal-slider {
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      background: rgba(128, 128, 128, 0.4);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .emotia-minimal-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      cursor: pointer;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    /* Force therapist card styling overrides */
    .therapist-card-title-fixed {
      color: #446081 !important;
    }
    
    .therapist-select-button-fixed {
      background: linear-gradient(135deg, #446081, #5a7ba0) !important;
      color: white !important;
      border: none !important;
    }op-filter: blur(12px);
      box-shadow: 0 2px 12px rgba(255, 255, 255, 0.3), 
                  0 1px 4px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .emotia-minimal-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 16px rgba(255, 255, 255, 0.4), 
                  0 2px 8px rgba(0, 0, 0, 0.15),
                  inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }
    
    .emotia-minimal-slider::-webkit-slider-thumb:active {
      transform: scale(1.3);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.5), 
                  0 3px 12px rgba(0, 0, 0, 0.2),
                  inset 0 1px 0 rgba(255, 255, 255, 1);
    }
    
    .emotia-minimal-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      cursor: pointer;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 2px 12px rgba(255, 255, 255, 0.3), 
                  0 1px 4px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .emotia-minimal-slider::-moz-range-thumb:hover {
      transform: scale(1.2);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 16px rgba(255, 255, 255, 0.4), 
                  0 2px 8px rgba(0, 0, 0, 0.15),
                  inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }
    
    .emotia-minimal-slider::-moz-range-thumb:active {
      transform: scale(1.3);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.5), 
                  0 3px 12px rgba(0, 0, 0, 0.2),
                  inset 0 1px 0 rgba(255, 255, 255, 1);
    }
     

     
           /* Dynamic mood-based background transitions */
      #emotia-mood-tracker-stepper {
        background: white !important;
      }
    .modern-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: var(--thumb-size, 28px);
  height: var(--thumb-size, 28px);
  margin-top: -20px;
  border-radius: 50%;
  background: linear-gradient(135deg, #fff 40%, #f5f1ff 100%);
  border: 3px solid rgba(167, 139, 250, 0.9);
  box-shadow: 0 0 0 6px #a78bfa33, 0 6px 18px 0 rgba(123,97,255,0.25);
  cursor: grab;
  transition: all 0.4s cubic-bezier(.4,2,.6,1);
  transform: scale(1);
  position: relative;
  z-index: 2;
}
    .modern-slider:active::-webkit-slider-thumb {
  cursor: grabbing;
  border: 3px solid #7b61ff;
  background: linear-gradient(135deg, #fff 50%, #e6deff 100%);
  box-shadow: 0 0 0 10px #a78bfa22, 0 8px 24px 0 rgba(123,97,255,0.3);
  transform: scale(1.15);
}
    .modern-slider::-moz-range-thumb {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  margin-top: -20px;
  background: linear-gradient(135deg, #fff 40%, #f5f1ff 100%);
  border: 3px solid rgba(167, 139, 250, 0.9);
  box-shadow: 0 0 0 6px #a78bfa33, 0 6px 18px 0 rgba(123,97,255,0.25);
  cursor: grab;
  transition: all 0.4s cubic-bezier(.4,2,.6,1);
  position: relative;
  z-index: 2;
}
    .modern-slider:active::-moz-range-thumb {
  cursor: grabbing;
  border: 3px solid #7b61ff;
  background: linear-gradient(135deg, #fff 50%, #e6deff 100%);
  box-shadow: 0 0 0 10px #a78bfa22, 0 8px 24px 0 rgba(123,97,255,0.3);
  transform: scale(1.15);
}
    .modern-slider:focus {
      outline: none;
      box-shadow: 0 0 0 4px #a78bfa44;
    }
    .modern-slider::-webkit-slider-runnable-track {
  height: 8px;
  border-radius: 4px;
      background: transparent;
      position: relative;
      top: 13px;
      transition: background 0.6s cubic-bezier(.4,2,.6,1);
    }
    .modern-slider::-moz-range-track {
  height: 8px;
  border-radius: 4px;
      background: transparent;
      position: relative;
      top: 13px;
    }
    .modern-slider::-ms-fill-lower,
    .modern-slider::-ms-fill-upper {
      background: transparent;
    }
    .mood-video {
      width: 398px;
      height: 370px;
      border-radius: 32px;
      object-fit: cover;
      box-shadow: 0 4px 32px 0 rgba(123,97,255,0.10);
      background: transparent;
      margin-bottom: 1.5rem;
      z-index: 2;
    }
    /* Blur transition for GIF */
    .transition-blur {
      transition: filter 0.7s cubic-bezier(.4,2,.6,1), opacity 0.7s cubic-bezier(.4,2,.6,1);
    }
    .blur-out {
      filter: blur(18px);
      opacity: 0;
    }
    .blur-in {
      filter: blur(18px);
      opacity: 0;
      animation: blurIn 0.7s cubic-bezier(.4,2,.6,1) forwards;
    }
    @keyframes blurIn {
      0% { filter: blur(18px); opacity: 0; }
      100% { filter: blur(0); opacity: 1; }
    }
    
    /* Glassmorphism Card Animation & Effects */
    .glassmorphism-card {
      transition: all 0.3s ease;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.08);
    }
    
    .glassmorphism-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 36px rgba(31, 38, 135, 0.15);
    }
    
    .glassmorphism-card .material-icons {
      transition: transform 0.5s ease;
    }
    
    .glassmorphism-card:hover .material-icons {
      transform: scale(1.15);
    }
    
    /* Info Panel and List Styling */
    .info-panel {
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.06);
      transition: all 0.3s ease;
    }
    
    .info-panel:hover {
      box-shadow: 0 12px 36px rgba(31, 38, 135, 0.1);
    }
    
    /* Custom scrollbar styling */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(243, 244, 246, 0.6);
      border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.3);
      border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.5);
    }
    .mood-next-btn {
      transition: background 0.4s cubic-bezier(.4,2,.6,1), color 0.4s cubic-bezier(.4,2,.6,1), box-shadow 0.4s cubic-bezier(.4,2,.6,1);
    }
    .mood-next-btn:hover {
      filter: brightness(0.95) saturate(1.2);
      box-shadow: 0 6px 24px 0 rgba(123,97,255,0.18);
      transform: translateY(-2px) scale(1.03);
    }
    /* Positivity Trend filter button overrides */
    #positivity-filter .filter-btn {
      color: #fff !important;
      background: rgba(255,255,255,0.18);
      transition: color 0.2s, background 0.2s;
    }
    #positivity-filter .filter-btn:hover {
      color: #222 !important;
      background: #fff;
    }
    #positivity-filter .filter-btn.bg-white {
      color: #222 !important;
      background: #fff !important;
    }
    /* Emotia Positivity Trend filter button overrides */
    #emotia-positivity-filter .positivity-filter-btn {
      color: #222 !important;
      background: rgba(255,255,255,0.18);
      transition: color 0.2s, background 0.2s;
    }
    #emotia-positivity-filter .positivity-filter-btn:hover:not(.bg-white) {
      color: #374151 !important;
      background: rgba(243, 244, 246, 0.8);
    }
    #emotia-positivity-filter .positivity-filter-btn.bg-white {
      color: #222 !important;
      background: #fff !important;
      cursor: default;
    }

    /* Activity Rings Styles */
    /* Beehive Styles */
    .beehive-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      min-height: 600px;
    }

    .beehive-wrapper {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .circles-wrapper {
      width: 800px;
      height: 500px;
      position: relative;
      overflow: hidden;
      background: transparent;
      margin: 0 auto;
    }
    
    /* Keep items contained on mobile portrait */
    @media screen and (max-width: 768px) and (orientation: portrait) {
      .circles-wrapper {
        overflow: hidden; /* Keep items within container bounds */
      }
    }

    .circles {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .circle {
      position: absolute;
      width: 120px;
      height: 120px;
      padding: 12px;
      cursor: pointer;
      transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
      animation: fadeIn 0.6s ease-out;
      will-change: transform;
    }

    /* Optimized transitions for mobile vertical */
    @media (max-width: 768px) and (orientation: portrait) {
      .circle {
        transition: transform 0.3s ease-out;
      }
      
      .circle .category-icon {
        transition: all 0.3s ease-out;
      }
      
      .circle .category-icon .material-icons {
        transition: all 0.3s ease-out;
      }
      
      .circle .category-icon::before {
        transition: all 0.3s ease-out;
      }
    }

    /* Category indicator for desktop horizontal */
    .desktop-horizontal-category-indicator {
      display: none;
      margin-bottom: 1.5rem;
    }

    .category-name-gradient {
      font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
      font-size: 1.125rem;
      font-weight: 300;
      letter-spacing: -0.01em;
      background: linear-gradient(135deg, #EF4444, #F59E0B);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
      transition: all 0.3s ease;
    }

    /* Hide bottom desktop category indicator by default */
    .desktop-category-indicator {
      display: none !important;
    }

    /* Show desktop horizontal category indicator only on desktop horizontal views */
    @media (min-width: 1024px) and (orientation: landscape) {
      .desktop-horizontal-category-indicator {
        display: block;
      }
      
      .mobile-category-indicator {
        display: none;
      }
      
      .desktop-category-indicator {
        display: none !important;
      }
    }

    /* Hide desktop horizontal indicator on mobile and tablet */
    @media (max-width: 1023px) {
      .desktop-horizontal-category-indicator {
        display: none !important;
      }
    }

    /* Hide desktop horizontal indicator on desktop portrait */
    @media (min-width: 1024px) and (orientation: portrait) {
      .desktop-horizontal-category-indicator {
        display: none !important;
      }
    }

    /* Category-specific gradients */
    .category-gradient-heart {
      background: linear-gradient(135deg, #EF4444, #FCA5A5) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-finance {
      background: linear-gradient(135deg, #F59E0B, #FCD34D) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-meditation {
      background: linear-gradient(135deg, #6366F1, #A5B4FC) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-fitness {
      background: linear-gradient(135deg, #EF4444, #FCA5A5) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-career {
      background: linear-gradient(135deg, #3B82F6, #93C5FD) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-studies {
      background: linear-gradient(135deg, #2563EB, #93C5FD) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-creativity {
      background: linear-gradient(135deg, #EC4899, #F9A8D4) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-food {
      background: linear-gradient(135deg, #10B981, #6EE7B7) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-sleep {
      background: linear-gradient(135deg, #6B7280, #D1D5DB) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-wellness {
      background: linear-gradient(135deg, #10B981, #6EE7B7) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-exploration {
      background: linear-gradient(135deg, #06B6D4, #67E8F9) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-joy {
      background: linear-gradient(135deg, #8B5CF6, #C4B5FD) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-social {
      background: linear-gradient(135deg, #EC4899, #F9A8D4) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-relaxation {
      background: linear-gradient(135deg, #C0C9EE, #E0E7FF) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-pet {
      background: linear-gradient(135deg, #87CEEB, #BFDBFE) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .category-gradient-hygiene {
      background: linear-gradient(135deg, #C9E9D2, #D1FAE5) !important;
      background-clip: text !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
    }

    .circle:hover {
      z-index: 10;
      filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.15));
    }

    .circle .category-icon {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .circle .category-icon::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
      transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .circle:hover .category-icon {
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      background: rgba(255, 255, 255, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 0 6px 16px rgba(0, 0, 0, 0.1);
      transform: translateY(-4px) scale(1.08);
    }

    .circle:hover .category-icon::before {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.1));
    }

    .circle .category-icon .material-icons {
      font-size: 44px;
      font-weight: 400;
      z-index: 2;
      position: relative;
      transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
    }

    .circle:hover .material-icons {
      transform: scale(1.1);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    /* Category-specific colors */
    .circle[data-category="heart"] .category-icon {
      background: rgba(254, 226, 226, 0.8);
      border-color: rgba(239, 68, 68, 0.3);
    }
    .circle[data-category="heart"] .material-icons {
      color: #EF4444;
    }

    .circle[data-category="finance"] .category-icon {
      background: rgba(254, 243, 199, 0.8);
      border-color: rgba(245, 158, 11, 0.3);
    }
    .circle[data-category="finance"] .material-icons {
      color: #F59E0B;
    }

    .circle[data-category="meditation"] .category-icon {
      background: rgba(224, 231, 255, 0.8);
      border-color: rgba(99, 102, 241, 0.3);
    }
    .circle[data-category="meditation"] .material-icons {
      color: #6366F1;
    }

    .circle[data-category="fitness"] .category-icon {
      background: rgba(254, 202, 202, 0.8);
      border-color: rgba(239, 68, 68, 0.3);
    }
    .circle[data-category="fitness"] .material-icons {
      color: #EF4444;
    }

    .circle[data-category="career"] .category-icon {
      background: rgba(219, 234, 254, 0.8);
      border-color: rgba(59, 130, 246, 0.3);
    }
    .circle[data-category="career"] .material-icons {
      color: #3B82F6;
    }

    .circle[data-category="studies"] .category-icon {
      background: rgba(219, 234, 254, 0.8);
      border-color: rgba(37, 99, 235, 0.3);
    }
    .circle[data-category="studies"] .material-icons {
      color: #2563EB;
    }

    .circle[data-category="creativity"] .category-icon {
      background: rgba(252, 231, 243, 0.8);
      border-color: rgba(236, 72, 153, 0.3);
    }
    .circle[data-category="creativity"] .material-icons {
      color: #EC4899;
    }

    .circle[data-category="food"] .category-icon {
      background: rgba(209, 250, 229, 0.8);
      border-color: rgba(16, 185, 129, 0.3);
    }
    .circle[data-category="food"] .material-icons {
      color: #10B981;
    }

    .circle[data-category="sleep"] .category-icon {
      background: rgba(243, 244, 246, 0.8);
      border-color: rgba(107, 114, 128, 0.3);
    }
    .circle[data-category="sleep"] .material-icons {
      color: #6b7280;
    }

    .circle[data-category="wellness"] .category-icon {
      background: rgba(209, 250, 229, 0.8);
      border-color: rgba(16, 185, 129, 0.3);
    }
    .circle[data-category="wellness"] .material-icons {
      color: #10b981;
    }

    .circle[data-category="exploration"] .category-icon {
      background: rgba(207, 250, 254, 0.8);
      border-color: rgba(6, 182, 212, 0.3);
    }
    .circle[data-category="exploration"] .material-icons {
      color: #06b6d4;
    }

    /* Dynamic border for habits section */
    .habits-section-border {
      border: 1px solid transparent;
      transition: border-color 0.4s ease, box-shadow 0.4s ease;
    }

    /* Category-specific border colors */
    .habits-section-border.border-heart {
      border-color: rgba(239, 68, 68, 0.15);
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.05);
    }

    .habits-section-border.border-finance {
      border-color: rgba(245, 158, 11, 0.15);
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.05);
    }

    .habits-section-border.border-meditation {
      border-color: rgba(99, 102, 241, 0.15);
      box-shadow: 0 0 12px rgba(99, 102, 241, 0.05);
    }

    .habits-section-border.border-fitness {
      border-color: rgba(239, 68, 68, 0.15);
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.05);
    }

    .habits-section-border.border-career {
      border-color: rgba(59, 130, 246, 0.15);
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.05);
    }

    .habits-section-border.border-studies {
      border-color: rgba(37, 99, 235, 0.15);
      box-shadow: 0 0 12px rgba(37, 99, 235, 0.05);
    }

    .habits-section-border.border-creativity {
      border-color: rgba(236, 72, 153, 0.15);
      box-shadow: 0 0 12px rgba(236, 72, 153, 0.05);
    }

    .habits-section-border.border-food {
      border-color: rgba(16, 185, 129, 0.15);
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.05);
    }

    .habits-section-border.border-sleep {
      border-color: rgba(107, 114, 128, 0.15);
      box-shadow: 0 0 12px rgba(107, 114, 128, 0.05);
    }

    .habits-section-border.border-wellness {
      border-color: rgba(16, 185, 129, 0.15);
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.05);
    }

    .habits-section-border.border-exploration {
      border-color: rgba(6, 182, 212, 0.15);
      box-shadow: 0 0 12px rgba(6, 182, 212, 0.05);
    }

    .habits-section-border.border-joy {
      border-color: rgba(139, 92, 246, 0.15);
      box-shadow: 0 0 12px rgba(139, 92, 246, 0.05);
    }

    .habits-section-border.border-social {
      border-color: rgba(236, 72, 153, 0.15);
      box-shadow: 0 0 12px rgba(236, 72, 153, 0.05);
    }

    .habits-section-border.border-relaxation {
      border-color: rgba(192, 201, 238, 0.15);
      box-shadow: 0 0 12px rgba(192, 201, 238, 0.05);
    }

    .habits-section-border.border-pet {
      border-color: rgba(135, 206, 235, 0.15);
      box-shadow: 0 0 12px rgba(135, 206, 235, 0.05);
    }

    .habits-section-border.border-hygiene {
      border-color: rgba(201, 233, 210, 0.15);
      box-shadow: 0 0 12px rgba(201, 233, 210, 0.05);
    }

    .circle[data-category="joy"] .category-icon {
      background: rgba(237, 233, 254, 0.8);
      border-color: rgba(139, 92, 246, 0.3);
    }
    .circle[data-category="joy"] .material-icons {
      color: #8B5CF6;
    }

    .circle[data-category="social"] .category-icon {
      background: rgba(252, 231, 243, 0.8);
      border-color: rgba(236, 72, 153, 0.3);
    }
    .circle[data-category="social"] .material-icons {
      color: #EC4899;
    }

    .circle[data-category="relaxation"] .category-icon {
      background: rgba(240, 243, 255, 0.8);
      border-color: rgba(192, 201, 238, 0.3);
    }
    .circle[data-category="relaxation"] .material-icons {
      color: #C0C9EE;
    }

    .circle[data-category="pet"] .category-icon {
      background: rgba(224, 246, 255, 0.8);
      border-color: rgba(135, 206, 235, 0.3);
    }
    .circle[data-category="pet"] .material-icons {
      color: #87CEEB;
    }

    .circle[data-category="hygiene"] .category-icon {
      background: rgba(240, 249, 242, 0.8);
      border-color: rgba(201, 233, 210, 0.3);
    }
    .circle[data-category="hygiene"] .material-icons {
      color: #C9E9D2;
    }

    /* Category Indicator Styles */
    .category-indicator {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* Mobile category indicator (between title and grid) */
    .mobile-category-indicator {
      display: none; /* Hidden by default */
      margin-top: 0;
      margin-bottom: 16px;
    }
    
    /* Desktop category indicator (below grid) */
    .desktop-category-indicator {
      display: none; /* Hidden by default, shown only when needed */
    }

    .category-name {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      font-family: 'Inter', sans-serif;
      letter-spacing: -0.02em;
      text-align: center;
      transition: color 0.3s ease;
    }

    .over-circles {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 3;
      top: 0;
      left: 0;
      cursor: grab;
    }

    .over-circles:active {
      cursor: grabbing;
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Tablet responsiveness */
    @media screen and (max-width: 1024px) and (min-width: 769px) {
      .circles-wrapper {
        width: 700px;
        height: 500px;
      }
      
      .circle {
        width: 110px;
        height: 110px;
        padding: 10px;
      }
      
      .circle .category-icon .material-icons {
        font-size: 40px;
      }
    }

    /* Mobile responsiveness */
    @media screen and (max-width: 768px) {
      .beehive-container {
        min-height: 550px;
      }
      
      .circles-wrapper {
        width: 400px;
        height: 650px; /* Increased height for vertical scrolling */
      }
      
      .circle {
        width: 80px;
        height: 80px;
        padding: 8px;
      }
      
      .circle .category-icon .material-icons {
        font-size: 28px;
      }
    }

    @media screen and (max-width: 640px) {
      .beehive-container {
        min-height: 500px;
      }
      
      .circles-wrapper {
        width: 350px;
        height: 550px; /* Increased height for vertical scrolling */
      }
      
      .circle {
        width: 70px; /* Bigger circles */
        height: 70px;
        padding: 6px; /* Increased padding for bigger gaps */
      }
      
      .circle .category-icon .material-icons {
        font-size: 24px; /* Bigger icons */
      }

      .category-indicator {
        margin-top: 12px;
      }

      .category-name {
        font-size: 16px;
      }
    }

    /* Portrait mobile specific adjustments */
    @media screen and (max-width: 640px) and (orientation: portrait) {
      .circles-wrapper {
        width: 320px;
        height: 520px; /* Reduced height for portrait */
      }
      
      .circle {
        width: 60px; /* Bigger for portrait */
        height: 60px;
        padding: 5px; /* More padding for better spacing */
      }
      
      .circle .category-icon .material-icons {
        font-size: 20px;
      }
      
      /* Show mobile category indicator, hide desktop one */
      .mobile-category-indicator {
        display: flex !important;
      }
      
      .desktop-category-indicator {
        display: none !important;
      }
    }
  </style>
</head>
<body class="flex h-screen">
<script>
// Make all charts take full container space and remove legends
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    // Get all chart instances
    if (window.Chart && Chart.instances) {
      Object.values(Chart.instances).forEach(chart => {
        // Make chart fill container
        if (chart.options) {
          chart.options.maintainAspectRatio = false;
          // Hide legend for all charts
          if (chart.options.plugins && chart.options.plugins.legend) {
            chart.options.plugins.legend.display = false;
          }
          chart.update();
        }
      });
    }
  }, 100);

// Immediate setup as backup
(function() {
})();});
</script>
<!-- Bottom Horizontal Menu Bar -->
<div id="menu-container" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50">
  <div id="menu-toggle" class="liquid-glass-wrapper">
    <!-- Liquid Glass Effects -->
    <div class="liquid-glass-effect"></div>
    <div class="liquid-glass-tint"></div>
    <div class="liquid-glass-shine"></div>
    
    <!-- Menu Icon (Center) -->
    <div id="menu-icon">
      <!-- Menu Icon (Closed state) -->
      <span id="menu-icon-material" class="material-icons text-white">apps</span>
      <!-- Close Icon (Open state) -->
      <span id="close-icon-material" class="material-icons text-white">close</span>
    </div>

    <!-- Horizontal Menu Content -->
    <div id="menu-content">
      <div class="menu-item" data-section="dashboard">
        <img src="https://img.icons8.com/?size=100&id=ZgfipSZIUMA3&format=png&color=6b7280" class="menu-icon" alt="Main">
        <span>Main</span>
      </div>
      <div class="menu-item" data-section="sessions">
        <img src="https://img.icons8.com/?size=100&id=35583&format=png&color=6b7280" class="menu-icon" alt="Therapy">
        <span>Therapy</span>
      </div>
      <div class="menu-item" data-section="emotia">
        <img src="https://img.icons8.com/?size=100&id=1893&format=png&color=6b7280" class="menu-icon" alt="Emotions">
        <span>Emotions</span>
      </div>
      <div class="menu-item" data-section="journalia">
        <img src="https://img.icons8.com/?size=100&id=77385&format=png&color=6b7280" class="menu-icon" alt="Moments">
        <span>Moments</span>
      </div>
      <div class="menu-item" data-section="momentum">
        <img src="https://img.icons8.com/?size=100&id=54062&format=png&color=6b7280" class="menu-icon" alt="Habits">
        <span>Habits</span>
      </div>
      <div class="menu-item" data-section="courses">
        <img src="https://img.icons8.com/?size=100&id=42437&format=png&color=6b7280" class="menu-icon" alt="Courses">
        <span>Courses</span>
      </div>
      <div class="menu-item" data-section="insights">
        <img src="https://img.icons8.com/?size=100&id=103102&format=png&color=6b7280" class="menu-icon" alt="Insights">
        <span>Insights</span>
      </div>
      <div class="menu-item" data-section="settings">
        <img src="https://img.icons8.com/?size=100&id=47834&format=png&color=6b7280" class="menu-icon" alt="Settings">
        <span>Settings</span>
      </div>
    </div>
  </div>
</div>

<!-- Settings Popup -->
<div id="settings-popup" class="fixed inset-0 bg-black bg-opacity-50 z-60 hidden flex items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden">
    <div class="p-6 border-b border-gray-100">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Settings</h3>
        <button id="close-settings" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
          <span class="material-icons text-gray-500">close</span>
      </div>
    </div>
    <div class="p-4">
      <div class="space-y-2">
        <button id="settings-language" class="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl transition-colors text-left">
          <img src="Sign Page Media/united-kingdom.png" alt="Language" class="w-6 h-6 rounded-full border border-gray-200" />
          <div>
            <div class="font-medium text-gray-900">Language</div>
            <div class="text-sm text-gray-500">English (UK)</div>
        </div>
          <span class="material-icons text-gray-400 ml-auto">chevron_right</span>
        <button id="settings-logout" class="w-full flex items-center gap-3 p-3 hover:bg-red-50 rounded-xl transition-colors text-left text-red-600">
          <span class="material-icons">logout</span>
          <div>
            <div class="font-medium">Logout</div>
            <div class="text-sm text-red-500">Sign out of your account</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Glass Distortion Filter -->
<svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
  <defs>
    <filter id="glass-distortion" x="-50%" y="-50%" width="200%" height="200%">
      <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="3" stitchTiles="stitch"/>
      <feDisplacementMap in="SourceGraphic" scale="2"/>
    </filter>
  </defs>
</svg>
<main id="main-content" class="w-full p-10 bg-[#f6f5fa] overflow-y-auto transition-all duration-300 min-h-screen">
  <!-- Dashboard Content -->
  <div id="dashboard-sections" class="flex flex-col gap-8">
  </div>
  <div id="sessions-sections" class="flex flex-col gap-8 hidden">
    <!-- Meet Your Therapist Section -->
    <section id="meet-therapist-section" class="bg-white shadow-xl p-4 md:p-12 flex flex-col w-full rounded-[35px]" style="border-radius: 35px; border: 0.5px solid #1CB5E0; box-shadow: 0 0 120px rgba(28, 181, 224, 0.08);">

      
      <!-- Step 1: Initial Landing (visible by default) -->
    <script>
    // Therapist Navigation Functions - IMMEDIATE SETUP
    window.navigateToTherapistStepOne = function() {
        console.log("üìç Navigating to Therapist Step 1 with booking state reset");
        try {
            // RESET BOOKING STATE WHEN RETURNING TO THERAPIST LIST
            if (window.bookingState) {
                window.bookingState = {
                    currentTherapist: null,
                    selectedDate: null,
                    selectedTime: null,
                    selectedDuration: 1,
                    selectedService: null,
                    currentMonth: new Date().getMonth(),
                    currentYear: new Date().getFullYear()
                };
                console.log("‚úÖ Booking state reset");
            }
            
            const step1 = document.getElementById("therapist-step-1");
            const step2 = document.getElementById("therapist-step-2");
            const step3 = document.getElementById("therapist-step-3-location");
            const stepBooking = document.getElementById("therapist-step-booking");
            const bookingCompleted = document.getElementById("booking-completed-section");
            
            if (step1) {
                step1.classList.remove("hidden");
                console.log("‚úÖ Step 1 shown");
            }
            if (step2) {
                step2.classList.add("hidden");
                console.log("‚úÖ Step 2 hidden");
            }
            if (step3) {
                step3.classList.add("hidden");
                console.log("‚úÖ Step 3 hidden");
            }
            if (stepBooking) {
                stepBooking.classList.add("hidden");
                stepBooking.style.display = "none";
                console.log("‚úÖ Booking step hidden");
            }
            if (bookingCompleted) {
                bookingCompleted.classList.add("hidden");
                bookingCompleted.style.display = "none";
                console.log("‚úÖ Booking completed section hidden");
            }
        } catch (error) {
            console.error("‚ùå Error in navigateToTherapistStepOne:", error);
        }
    };
    
    
    window.navigateToTherapistStepTwo = function() {
        console.log("üìç Navigating to Therapist Step 2");
        alert("Function called!");
        try {
            const step1 = document.getElementById("therapist-step-1");
            const step2 = document.getElementById("therapist-step-2");
            const step3 = document.getElementById("therapist-step-3-location");
            
            console.log("Step elements found:", {
                step1: !!step1,
                step2: !!step2, 
                step3: !!step3
            });
            
            if (step1) {
                step1.classList.add("hidden");
                step1.style.display = "none";
                console.log("‚úÖ Step 1 hidden");
            } else {
                console.error("‚ùå Step 1 not found");
            }
            
            if (step2) {
                step2.classList.remove("hidden");
                step2.style.display = "block";
                console.log("‚úÖ Step 2 shown");
                
                // Scroll to step 2
                setTimeout(() => {
                    step2.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            } else {
                console.error("‚ùå Step 2 not found");
            }
            
            if (step3) {
                step3.classList.add("hidden");
                step3.style.display = "none";
                console.log("‚úÖ Step 3 hidden");
            }
        } catch (error) {
            console.error("‚ùå Error in navigateToTherapistStepTwo:", error);
            alert("Error: " + error.message);
        }
    };
    
    window.navigateToTherapistStepThree = function() {
        console.log("üìç Navigating to Therapist Step 3");
        try {
            const step1 = document.getElementById("therapist-step-1");
            const step2 = document.getElementById("therapist-step-2");
            const step3 = document.getElementById("therapist-step-3-location");
            
            if (step1) {
                step1.classList.add("hidden");
                console.log("‚úÖ Step 1 hidden");
            }
            if (step2) {
                step2.classList.add("hidden");
                console.log("‚úÖ Step 2 hidden");
            }
            if (step3) {
                step3.classList.remove("hidden");
                console.log("‚úÖ Step 3 shown");
            }
        } catch (error) {
            console.error("‚ùå Error in navigateToTherapistStepThree:", error);
        }
    };
    console.log("‚úÖ Therapist navigation functions loaded!");
    
    // CRITERIA FUNCTIONS MOVED TO PROPER SCOPE AFTER HTML ELEMENTS  
    // This prevents function call dependency issues where early functions
    // try to call later-defined functions like initializeCriteriaFilters

    // REMOVED - Using navigateToBookingStep from therapist-booking.js instead
    // The modern booking system function is defined in therapist-booking.js

    // Create booking step (Step 4)
    window.createBookingStep = function(therapistId) {
        console.log(`üìÖ Creating booking step for therapist ID: ${therapistId}`);
        try {
            // Find therapist data - use external file
            const allTherapists = window.therapistData;
            
            const therapist = allTherapists.find(t => t.id == therapistId);
            if (!therapist) {
                console.error("‚ùå Therapist not found");
                return;
            }
            
            // Generate available time slots
            const timeSlots = window.generateTimeSlots(therapist.availability);
            
            // Create booking step HTML
            const therapyApproach = therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy";
        const bookingStepHTML = `
                <div id="therapist-step-4-booking" class="mb-6">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Book Your Session</h2>
                        <p class="text-gray-600">Choose your preferred date and time</p>
                    </div>
                    
                    <!-- Therapist Info -->
                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4 border border-gray-100">
                        <div class="flex items-center gap-3">
                            <img src="${therapist.image}" alt="${therapist.first_name} ${therapist.last_name}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-200">
                            <div>
                                <h3 class="text-base font-medium text-gray-600">${therapist.first_name} ${therapist.last_name}</h3>
                                <p class="text-sm text-gray-600 capitalize">${therapyApproach}</p>
                                <p class="text-xs text-gray-500 capitalize">${therapist.city}, ${therapist.area}</p>
                                <p class="text-xs text-green-600 font-medium">${therapist.services && therapist.services.in_person_therapy && therapist.services.online_therapy ? 'In-person & Online' : therapist.services && therapist.services.online_therapy ? 'Online' : 'In-person'} Therapy</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calendar and Time Selection -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-4">Select Date & Time</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Calendar -->
                            <div>
                                <h4 class="text-md font-medium text-gray-700 mb-3">Choose Date</h4>
                                <div id="booking-calendar" class="border border-gray-200 rounded-lg p-4">
                                    <div class="grid grid-cols-7 gap-1 text-center text-sm">
                                        <div class="font-semibold text-gray-500 p-2">Sun</div>
                                        <div class="font-semibold text-gray-500 p-2">Mon</div>
                                        <div class="font-semibold text-gray-500 p-2">Tue</div>
                                        <div class="font-semibold text-gray-500 p-2">Wed</div>
                                        <div class="font-semibold text-gray-500 p-2">Thu</div>
                                        <div class="font-semibold text-gray-500 p-2">Fri</div>
                                        <div class="font-semibold text-gray-500 p-2">Sat</div>
                                    </div>
                                    <div id="calendar-days" class="grid grid-cols-7 gap-1 mt-2">
                                        <!-- Calendar days will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Time Slots -->
                            <div>
                                <h4 class="text-md font-medium text-gray-700 mb-3">Available Times</h4>
                                <div id="time-slots-container" class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto">
                                    ${timeSlots.map(slot => `
                                        <button onclick="selectTimeSlot('${slot}')" class="time-slot-btn p-2 text-sm border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors">
                                            ${slot}
                                        </button>
                                    `).join("")}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Session Details -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-4">Session Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Session Type</label>
                                <select id="session-type" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="individual">Individual Session (50 min)</option>
                                    <option value="couple">Couple Session (60 min)</option>
                                    <option value="family">Family Session (60 min)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Session Format</label>
                                <select id="session-format" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="online">Online Session</option>
                                    <option value="in-person">In-Person Session</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes (Optional)</label>
                            <textarea id="session-notes" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Any specific concerns or topics you'd like to discuss..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Booking Summary -->
                    <div id="booking-summary" class="bg-blue-50 rounded-2xl p-6 mb-6 border border-blue-200 hidden">
                        <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-4">Booking Summary</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Therapist:</span>
                                <span class="font-medium">${therapist.first_name} ${therapist.last_name}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Date:</span>
                                <span id="summary-date" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Time:</span>
                                <span id="summary-time" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Duration:</span>
                                <span id="summary-duration" class="font-medium">50 minutes</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Format:</span>
                                <span id="summary-format" class="font-medium">Online</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-blue-200">
                                <span class="text-gray-600">Total Cost:</span>
                                <span class="font-bold text-blue-600">$120</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button onclick="window.navigateToTherapistStepTwo()" class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-gray-700 transition-colors">
                            Back to Search
                        </button>
                        <button id="confirm-booking-btn" onclick="confirmBooking()" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Confirm Booking
                        </button>
                    </div>
                </div>
            `;
            
            // Find the therapist section and add booking step
            const therapistSection = document.querySelector("#therapist-section");
            if (therapistSection) {
                // Remove existing booking step if any
                const existingBookingStep = document.getElementById("therapist-step-4-booking");
                if (existingBookingStep) {
                    existingBookingStep.remove();
                }
                
                // Add new booking step
                therapistSection.insertAdjacentHTML("beforeend", bookingStepHTML);
                
                // Initialize calendar
                setTimeout(() => {
                    window.initializeBookingCalendar();
                }, 100);
                
                // Show booking step
                const bookingStep = document.getElementById("therapist-step-4-booking");
                if (bookingStep) {
                    bookingStep.classList.remove("hidden");
                    bookingStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        } catch (error) {
            console.error("‚ùå Error creating booking step:", error);
    };

    // Generate time slots based on availability
    window.generateTimeSlots = function(availability) {
        const timeSlots = [];
        
        switch(availability) {
            case "morning":
                timeSlots.push("9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM");
                break;
            case "afternoon":
                timeSlots.push("1:00 PM", "2:00 PM", "3:00 PM", "4:00 PM");
                break;
            case "evening":
                timeSlots.push("5:00 PM", "6:00 PM", "7:00 PM", "8:00 PM");
                break;
            case "weekend":
                timeSlots.push("10:00 AM", "11:00 AM", "2:00 PM", "3:00 PM", "4:00 PM");
                break;
            default:
                timeSlots.push("9:00 AM", "10:00 AM", "2:00 PM", "3:00 PM", "6:00 PM");
        }
        
        return timeSlots;
    };

    // Select time slot
    window.selectTimeSlot = function(time) {
        console.log(`üïê Selected time slot: ${time}`);
        try {
            // Remove active class from all time slots
            document.querySelectorAll(".time-slot-btn").forEach(btn => {
                btn.classList.remove("bg-blue-600", "text-white");
                btn.classList.add("border-gray-300");
            });
            
            // Add active class to selected time slot
            event.target.classList.add("bg-blue-600", "text-white");
            event.target.classList.remove("border-gray-300");
            
            // Update summary
            document.getElementById("summary-time").textContent = time;
            
            // Check if date is also selected
            const selectedDate = document.querySelector(".calendar-day.selected");
            if (selectedDate) {
                document.getElementById("booking-summary").classList.remove("hidden");
                document.getElementById("confirm-booking-btn").disabled = false;
            }
        } catch (error) {
            console.error("‚ùå Error selecting time slot:", error);
        }
    };

    // Initialize booking calendar
    window.initializeBookingCalendar = function() {
        console.log("üìÖ Initializing booking calendar");
        try {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const calendarDays = document.getElementById("calendar-days");
            if (!calendarDays) return;
            
            let daysHTML = "";
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                daysHTML += `<div class="calendar-day p-2"></div>`;
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate();
                const isPast = day < today.getDate();
                const dayClass = isPast ? "text-gray-400 cursor-not-allowed" : "hover:bg-blue-50 cursor-pointer";
                const todayClass = isToday ? "bg-blue-100 font-semibold" : "";
                
                daysHTML += `
                    <div class="calendar-day p-2 text-center text-sm rounded-lg ${dayClass} ${todayClass}" ${!isPast ? `onclick="selectDate(${day})"` : ""}>
                        ${day}
                    </div>
                `;
            }
            
            calendarDays.innerHTML = daysHTML;
        } catch (error) {
            console.error("‚ùå Error initializing calendar:", error);
        }
    };

    // Select date - FIXED to use proper calendar month/year and call time slots
    window.selectDate = function(day) {
        console.log(`üìÖ Selected date: ${day}`);
        try {
            // Remove active class from all dates
            document.querySelectorAll(".calendar-day").forEach(dayEl => {
                dayEl.classList.remove("selected", "bg-blue-600", "text-white");
            });
            
            // Add active class to selected date
            event.target.classList.add("selected", "bg-blue-600", "text-white");
            
            // FIXED: Use the calendar's current month/year, not today's
            const calendarYear = window.calendarState ? window.calendarState.currentDate.getFullYear() : new Date().getFullYear();
            const calendarMonth = window.calendarState ? window.calendarState.currentDate.getMonth() : new Date().getMonth();
            const selectedDate = new Date(calendarYear, calendarMonth, day);
            
            // Create proper date string for API calls (YYYY-MM-DD format)
            const dateStr = selectedDate.toISOString().split('T')[0];
            console.log(`üìÖ FIXED: Selected date string: ${dateStr} (year: ${calendarYear}, month: ${calendarMonth}, day: ${day})`);
            
            // Store selected date properly
            if (window.bookingState) {
                window.bookingState.selectedDate = dateStr;
            }
            
            // Update UI display
            const dateString = selectedDate.toLocaleDateString("en-US", { 
                weekday: "long", 
                year: "numeric", 
                month: "long", 
                day: "numeric" 
            });
            const summaryDateEl = document.getElementById("summary-date");
            if (summaryDateEl) {
                summaryDateEl.textContent = dateString;
            }
            
            // FIXED: Call the proper time slots function with correct date
            if (typeof window.showTimeSlotsForDate === 'function' && window.bookingState?.currentTherapist) {
                console.log(`üïê FIXED: Showing time slots for ${dateStr}`);
                window.showTimeSlotsForDate(dateStr);
            } else if (typeof window.selectCalendarDate === 'function') {
                console.log(`üïê FIXED: Using selectCalendarDate for ${dateStr}`);
                window.selectCalendarDate(dateStr);
            }
            
            // Check if time is also selected
            const selectedTime = document.querySelector(".time-slot-btn.bg-blue-600");
            if (selectedTime) {
                const bookingSummary = document.getElementById("booking-summary");
                const confirmBtn = document.getElementById("confirm-booking-btn");
                if (bookingSummary) bookingSummary.classList.remove("hidden");
                if (confirmBtn) confirmBtn.disabled = false;
            }
        } catch (error) {
            console.error("‚ùå Error selecting date:", error);
        }
    };

    // Update session details
    window.updateSessionDetails = function() {
        try {
            const sessionType = document.getElementById("session-type").value;
            const sessionFormat = document.getElementById("session-format").value;
            
            let duration = "50 minutes";
            if (sessionType === "couple" || sessionType === "family") {
                duration = "60 minutes";
            }
            
            document.getElementById("summary-duration").textContent = duration;
            document.getElementById("summary-format").textContent = sessionFormat === "online" ? "Online" : "In-Person";
        } catch (error) {
            console.error("‚ùå Error updating session details:", error);
        }
    };

    // Confirm booking
    window.confirmBooking = function() {
        console.log("‚úÖ Confirming booking");
        try {
            const therapistName = document.getElementById("summary-date").closest("#booking-summary").querySelector("span:contains('Therapist')").nextElementSibling.textContent;
            const selectedDate = document.getElementById("summary-date").textContent;
            const selectedTime = document.getElementById("summary-time").textContent;
            const sessionType = document.getElementById("session-type").value;
            const sessionFormat = document.getElementById("session-format").value;
            const notes = document.getElementById("session-notes").value;
            
            // Create booking confirmation
            const bookingData = {
                therapistName,
                date: selectedDate,
                time: selectedTime,
                sessionType,
                sessionFormat,
                notes,
                timestamp: new Date().toISOString()
            };
            
            // Show success message
            const successHTML = `
                <div class="bg-green-50 border border-green-200 rounded-2xl p-6 text-center">
                    <div class="text-green-600 text-5xl mb-4">‚úÖ</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Booking Confirmed!</h2>
                    <p class="text-gray-600 mb-4">Your session has been successfully booked.</p>
                    <div class="bg-white rounded-lg p-4 mb-4 text-left">
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Date:</span>
                                <span class="font-medium">${selectedDate}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Time:</span>
                                <span class="font-medium">${selectedTime}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Format:</span>
                                <span class="font-medium">${sessionFormat === 'online' ? 'Online' : 'In-Person'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 justify-center">
                        <button onclick="window.navigateToTherapistStepOne()" class="bg-blue-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                            Book Another Session
                        </button>
                        <button onclick="window.location.reload()" class="bg-gray-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-gray-700 transition-colors">
                            Go to Dashboard
                        </button>
                    </div>
                </div>
            `;
            
            // Replace booking content with success message
            document.getElementById("therapist-step-4-booking").innerHTML = successHTML;
            
            console.log("‚úÖ Booking confirmed:", bookingData);
        } catch (error) {
            console.error("‚ùå Error confirming booking:", error);
        }
    };

    // Add event listeners for session details
    document.addEventListener("DOMContentLoaded", function() {
        setTimeout(() => {
            const sessionType = document.getElementById("session-type");
            const sessionFormat = document.getElementById("session-format");
            
            if (sessionType) {
                sessionType.addEventListener("change", window.updateSessionDetails);
            }
            if (sessionFormat) {
                sessionFormat.addEventListener("change", window.updateSessionDetails);
            }
        }, 1000);
    });

    // Navigation to quiz step (Step 3 - Quiz) - SIMPLIFIED AND WORKING
    window.navigateToTherapistStepThreeQuiz = function() {
        console.log("üß© Navigating to Therapist Step 3 - Quiz");
        try {
            // Get all step elements
            const step1 = document.getElementById("therapist-step-1");
            const step2 = document.getElementById("therapist-step-2");
            const step3Location = document.getElementById("therapist-step-3-location");
            const step3Criteria = document.getElementById("therapist-step-3-criteria");
            const step3Quiz = document.getElementById("therapist-step-3-quiz");
            
            console.log("üìã Found elements:", {
                step1: !!step1,
                step2: !!step2,
                step3Location: !!step3Location,
                step3Criteria: !!step3Criteria,
                step3Quiz: !!step3Quiz
            });
            
            // Hide all other steps
            [step1, step2, step3Location, step3Criteria].forEach(step => {
                if (step) {
                    step.classList.add("hidden");
                    step.style.display = "none";
                }
            });
            
            // Show quiz step
            if (step3Quiz) {
                console.log("‚úÖ Showing quiz step...");
                step3Quiz.classList.remove("hidden");
                step3Quiz.style.display = "block";
                
                // The embedded simple quiz system should work immediately
                console.log("üéØ Quiz step is now visible! The embedded quiz should be working.");
                
                // Scroll to quiz after a brief delay
                setTimeout(() => {
                    step3Quiz.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
            } else {
                console.error("‚ùå Quiz container element not found!");
            }
        } catch (error) {
            console.error("‚ùå Error in navigateToTherapistStepThreeQuiz:", error);
        }
    };

    // Navigation to criteria step (Step 3 - Criteria) - SIMPLE VERSION LIKE LOCATION
    window.navigateToTherapistStepThreeCriteria = function() {
        console.log("üîç Navigating to Therapist Step 3 - Criteria (Simple Version)");
        try {
            const step1 = document.getElementById("therapist-step-1");
            const step2 = document.getElementById("therapist-step-2");
            const step3Location = document.getElementById("therapist-step-3-location");
            const step3Criteria = document.getElementById("therapist-step-3-criteria");
            const step3Quiz = document.getElementById("therapist-step-3-quiz");
            
            if (step1) step1.classList.add("hidden");
            if (step2) step2.classList.add("hidden");
            if (step3Location) step3Location.classList.add("hidden");
            if (step3Quiz) step3Quiz.classList.add("hidden");
            if (step3Criteria) {
                step3Criteria.classList.remove("hidden");
                step3Criteria.scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log("‚úÖ Criteria step shown");
                // Initialize filters after a brief delay
                setTimeout(function() {
                    try {
                        console.log('üéØ CRITERIA NAV: Loading localStorage therapists for criteria step...');
                        
                        // FIRST: Force load localStorage therapists
                        if (typeof window.loadAndMergeLocalStorageTherapists === 'function') {
                            const added = window.loadAndMergeLocalStorageTherapists();
                            if (added.length > 0) {
                                console.log(`‚úÖ CRITERIA NAV: Added ${added.length} therapists from localStorage`);
                            }
                        }
                        
                        // SECOND: USE MASTER FILTER FIX (FIXES ALL FILTERS INCLUDING COUNTRY ISSUES)
                        if (typeof window.MASTER_FIX_ALL_FILTERS === 'function') {
                            console.log('üéØ CRITERIA NAV: Using MASTER filter fix for ALL filters...');
                            window.MASTER_FIX_ALL_FILTERS();
                            console.log('‚úÖ CRITERIA NAV: MASTER filter fix completed - all countries corrected!');
                        } else if (typeof window.fixAllFilters === 'function') {
                            console.log('üéØ CRITERIA NAV: Using UNIVERSAL filter fix for ALL filters...');
                            const filterCounts = window.fixAllFilters();
                            console.log(`‚úÖ CRITERIA NAV: ALL FILTERS REBUILT - ${filterCounts.titles} titles, ${filterCounts.languages} languages, ${filterCounts.approaches} therapy approaches, ${filterCounts.locations} locations, ${filterCounts.genders} genders!`);
                        } else {
                            console.log('‚ùå CRITERIA NAV: Universal filter fix not found - using fallback');
                            
                            // FALLBACK: Use location fix only
                            if (typeof window.fixAllLocationFilters === 'function') {
                                console.log('üéØ CRITERIA NAV: Using location fix as fallback...');
                                window.fixAllLocationFilters();
                            }
                        }
                        
                        // THIRD: Initialize criteria cards and update count
                        if (typeof window.populateCriteriaCards === 'function') {
                            console.log('üéØ CRITERIA NAV: Populating criteria cards...');
                            window.populateCriteriaCards();
                        } else {
                            // Fallback: Update count even if populateCriteriaCards isn't available
                            const resultsCount = document.getElementById('criteria-results-count');
                            if (resultsCount && window.therapistData) {
                                const totalCount = window.therapistData.length;
                                resultsCount.textContent = `${totalCount} therapist${totalCount !== 1 ? 's' : ''} found`;
                                console.log(`‚úÖ CRITERIA NAV: Fallback count set to ${totalCount} therapists`);
                            }
                        }
                        
                        // FALLBACK: Try legacy initialization method
                        if (window.initializeCriteriaFilters) {
                            window.initializeCriteriaFilters();
                        }
                    } catch (e) {
                        console.error("‚ùå Filter initialization failed:", e);
                    }
                }, 300);
            }
        } catch (error) {
            console.error("‚ùå Error in navigateToTherapistStepThreeCriteria:", error);
        }
    };

    // ========== COMPREHENSIVE QUIZ SYSTEM ==========
    window.initializeQuiz = function() {
        console.log("üß© Initializing Comprehensive Quiz System");
        try {
            // Reset quiz state
            window.currentQuizQuestion = 0;
            window.quizAnswers = {};
            window.quizUserLocation = null;
            
            // Start with first question
            window.showQuizQuestion(0);
        } catch (error) {
            console.error("‚ùå Error initializing quiz:", error);
        }
    };

    // Comprehensive Quiz Questions
    window.quizQuestions = [
        {
            id: 1,
            type: "language",
            question: "In which language would you like your therapist to communicate?",
            options: [] // Will be populated dynamically from therapist data
        },
        {
            id: 2,
            type: "age_group",
            question: "Is this therapy for a child or an adult?",
            options: [
                { value: "child", text: "Child (under 18)" },
                { value: "adult", text: "Adult (18+)" }
            ]
        },
        {
            id: 3,
            type: "service_type",
            question: "Which type of service are you looking for?",
            options: [] // Will be populated based on age group selection
        },
        {
            id: 4,
            type: "location_request",
            question: "To find therapists near you, we need access to your location. Is that okay?",
            options: [
                { value: "allow", text: "Allow location access" },
                { value: "deny", text: "Skip location (online services only)" }
            ],
            conditional: true // Only show for certain services
        },
        {
            id: 5,
            type: "therapy_approach",
            question: "Do you have any particular therapeutic approach preference?",
            options: [] // Will be populated from therapist data
        },
        {
            id: 6,
            type: "availability",
            question: "What is your preferred time for sessions?",
            options: [
                { value: "morning", text: "Morning (8AM - 12PM)" },
                { value: "noon", text: "Noon (12PM - 2PM)" },
                { value: "afternoon", text: "Afternoon (2PM - 5PM)" },
                { value: "evening", text: "Evening (5PM - 8PM)" },
                { value: "night", text: "Night (8PM - 10PM)" }
            ]
        }
    ];

    // Generate dynamic options for questions
    window.generateQuizOptions = function() {
        console.log("üîß Generating dynamic quiz options from therapist data");
        
        if (!window.therapistData || window.therapistData.length === 0) {
            console.error("‚ùå No therapist data available for quiz options");
            return;
        }
        
        // Extract unique languages
        const uniqueLanguages = [...new Set(window.therapistData.flatMap(t => t.languages || []))];
        window.quizQuestions[0].options = uniqueLanguages.map(lang => ({
            value: lang.toLowerCase(),
            text: lang
        }));
        
        // Extract unique therapy approaches
        const uniqueApproaches = [...new Set(window.therapistData.flatMap(t => t.therapy_approaches || []))];
        window.quizQuestions[4].options = [
            { value: "no_preference", text: "No Preference" },
            ...uniqueApproaches.map(approach => ({
                value: approach.toLowerCase().replace(/[^a-z0-9]/g, '_'),
                text: approach
            }))
        ];
        
        console.log("‚úÖ Dynamic quiz options generated");
    };

    // Show quiz question
    window.showQuizQuestion = function(questionIndex) {
        try {
            console.log(`üß© Showing quiz question ${questionIndex + 1}`);
            
            // Generate dynamic options if not done yet
            if (questionIndex === 0 && (!window.quizQuestions[0].options || window.quizQuestions[0].options.length === 0)) {
                window.generateQuizOptions();
            }
            
            const question = window.quizQuestions[questionIndex];
            const questionContainer = document.getElementById("quiz-question-container");
            const progressBar = document.getElementById("quiz-progress-bar");
            const progressText = document.getElementById("quiz-progress-text");
            
            if (!question || !questionContainer) return;
            
            // Check if this question should be skipped based on previous answers
            if (window.shouldSkipQuestion(questionIndex)) {
                console.log(`‚è≠Ô∏è Skipping question ${questionIndex + 1}`);
                window.nextQuizQuestion(questionIndex);
                return;
            }
            
            // Update progress
            const totalQuestions = window.quizQuestions.filter((q, i) => !window.shouldSkipQuestion(i)).length;
            const currentQuestionNum = window.quizQuestions.slice(0, questionIndex + 1).filter((q, i) => !window.shouldSkipQuestion(i)).length;
            const progress = (currentQuestionNum / totalQuestions) * 100;
            
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.textContent = `Question ${currentQuestionNum} of ${totalQuestions}`;
            
            // Handle service type question dynamically
            if (question.type === "service_type") {
                window.updateServiceOptions(question);
            }
            
            // Generate question HTML
            const questionHTML = `
                <div class="bg-white rounded-2xl shadow-lg p-8 max-w-2xl mx-auto">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">${question.question}</h3>
                    <div class="space-y-3">
                        ${question.options.map(option => `
                            <button 
                                onclick="selectQuizAnswer(${questionIndex}, '${option.value}')" 
                                class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md"
                            >
                                <span class="font-medium text-gray-800">${option.text}</span>
                            </button>
                        `).join("")}
                    </div>
                </div>
            `;
            
            questionContainer.innerHTML = questionHTML;
            
        } catch (error) {
            console.error("‚ùå Error showing quiz question:", error);
        }
    };

    // Check if question should be skipped
    window.shouldSkipQuestion = function(questionIndex) {
        const question = window.quizQuestions[questionIndex];
        
        if (question.type === "location_request") {
            // Skip location request for online therapy
            const serviceAnswer = window.quizAnswers[2]; // Service type question
            return serviceAnswer && serviceAnswer.answer === "online_therapy";
        }
        
        if (question.type === "therapy_approach") {
            // Skip therapy approach for psychometric evaluations
            const serviceAnswer = window.quizAnswers[2];
            return serviceAnswer && (
                serviceAnswer.answer === "psychometric_wisc" || 
                serviceAnswer.answer === "psychometric_wais" || 
                serviceAnswer.answer === "psychometric_mmpi2"
            );
        }
        
        return false;
    };

    // Update service options based on age group
    window.updateServiceOptions = function(question) {
        const ageGroupAnswer = window.quizAnswers[1];
        if (!ageGroupAnswer) return;
        
        if (ageGroupAnswer.answer === "child") {
            question.options = [
                { value: "in_person_therapy", text: "In-Person Therapy" },
                { value: "online_therapy", text: "Online Therapy" },
                { value: "psychometric_wisc", text: "Psychometric Evaluation WISC" },
                { value: "teen_counseling", text: "Teen Counseling" },
                { value: "parents_counseling", text: "Parents Counseling" }
            ];
        } else {
            question.options = [
                { value: "in_person_therapy", text: "In-Person Therapy" },
                { value: "online_therapy", text: "Online Therapy" },
                { value: "psychometric_wais", text: "Psychometric Evaluation WAIS" },
                { value: "psychometric_mmpi2", text: "Psychometric Evaluation MMPI2" },
                { value: "couples_therapy", text: "Couples Therapy" },
                { value: "parents_counseling", text: "Parents Counseling" }
            ];
        }
    };

    // Select quiz answer
    window.selectQuizAnswer = function(questionIndex, answer) {
        try {
            const question = window.quizQuestions[questionIndex];
            const selectedOption = question.options.find(opt => opt.value === answer);
            
            if (selectedOption) {
                window.quizAnswers[questionIndex] = {
                    question: question.question,
                    answer: answer,
                    type: question.type,
                    selectedText: selectedOption.text
                };
                
                console.log(`‚úÖ Quiz answer recorded: ${question.type} = ${answer}`);
                
                // Handle special cases
                if (question.type === "location_request" && answer === "allow") {
                    window.requestGeolocation(() => {
                        window.nextQuizQuestion(questionIndex);
                    });
                    return;
                }
                
                // Move to next question or show results
                window.nextQuizQuestion(questionIndex);
            }
        } catch (error) {
            console.error("‚ùå Error selecting quiz answer:", error);
        }
    };

    // Move to next question
    window.nextQuizQuestion = function(currentIndex) {
        const nextIndex = currentIndex + 1;
        
        if (nextIndex < window.quizQuestions.length) {
            setTimeout(() => {
                window.showQuizQuestion(nextIndex);
            }, 500);
        } else {
            setTimeout(() => {
                window.showQuizResults();
            }, 500);
        }
    };

    // Request geolocation
    window.requestGeolocation = function(callback) {
        console.log("üìç Requesting user location for therapist matching");
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    window.quizUserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log("‚úÖ Location obtained:", window.quizUserLocation);
                    callback();
                },
                function(error) {
                    console.warn("‚ö†Ô∏è Geolocation error:", error.message);
                    // Use Athens as fallback
                    window.quizUserLocation = { lat: 37.9838, lng: 23.7275 };
                    callback();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            console.error("‚ùå Geolocation not supported");
            window.quizUserLocation = { lat: 37.9838, lng: 23.7275 };
            callback();
        }
    };

    // Show quiz results with matching therapists
    window.showQuizResults = function() {
        try {
            console.log("üéØ Showing quiz results with matched therapists");
            
            // Calculate therapist matches
            const matchedTherapists = window.calculateTherapistMatches();
            
            // Display results
            const questionContainer = document.getElementById("quiz-question-container");
            const progressContainer = document.getElementById("quiz-progress-container");
            
            if (progressContainer) progressContainer.classList.add("hidden");
            
            const resultsHTML = `
                <div class="bg-white rounded-2xl shadow-lg p-8 max-w-6xl mx-auto">
                    <div class="text-center mb-8">
                        <h3 class="text-3xl font-bold text-gray-800 mb-4">Your Perfect Matches</h3>
                        <p class="text-lg text-gray-600">Based on your preferences, here are the top therapists for you:</p>
                    </div>
                    
                    <!-- Navigation buttons -->
                    <div class="flex justify-center gap-4 mb-8">
                        <button onclick="window.navigateToTherapistStepThreeCriteria()" 
                                class="px-6 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                            üîç Try Criteria Search
                        </button>
                        <button onclick="window.navigateToTherapistStepThree()" 
                                class="px-6 py-3 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                            üìç Try Location Search
                        </button>
                    </div>
                    
                    <!-- Matched therapists -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${matchedTherapists.map(match => window.generateMatchedTherapistCard(match)).join('')}
                    </div>
                </div>
            `;
            
            questionContainer.innerHTML = resultsHTML;
            
        } catch (error) {
            console.error("‚ùå Error showing quiz results:", error);
        }
    };

    // Calculate therapist matches based on quiz answers
    window.calculateTherapistMatches = function() {
        try {
            console.log("üîç Calculating therapist matches based on quiz answers");
            
            if (!window.therapistData || window.therapistData.length === 0) {
                console.error("‚ùå No therapist data available for matching");
                return [];
            }
            
            const matchedTherapists = window.therapistData.map(therapist => {
                let score = 0;
                let totalWeight = 0;
                
                // Language matching (highest priority)
                const languageAnswer = window.quizAnswers[0];
                if (languageAnswer && therapist.languageKeys) {
                    const therapistLanguages = therapist.languageKeys.map(lang => lang.toLowerCase());
                    if (therapistLanguages.includes(languageAnswer.answer.toLowerCase())) {
                        score += 25; // Very high weight for language match
                    }
                    totalWeight += 25;
                }
                
                // Age group matching (for child vs adult therapists)
                const ageGroupAnswer = window.quizAnswers[1];
                if (ageGroupAnswer && therapist.title) {
                    const isChildTherapist = therapist.title.toLowerCase().includes('child');
                    const needsChildTherapist = ageGroupAnswer.answer === 'child';
                    if (isChildTherapist === needsChildTherapist) {
                        score += 20; // High weight for age group match
                    }
                    totalWeight += 20;
                }
                
                // Service matching (very important)
                const serviceAnswer = window.quizAnswers[2];
                if (serviceAnswer && therapist.services) {
                    let hasService = false;
                    if (typeof therapist.services === 'object' && therapist.services[serviceAnswer.answer]) {
                        if (typeof therapist.services[serviceAnswer.answer] === 'object') {
                            hasService = therapist.services[serviceAnswer.answer].available;
                        } else {
                            hasService = therapist.services[serviceAnswer.answer] === true;
                        }
                    }
                    if (hasService) {
                        score += 20; // High weight for service availability
                    }
                    totalWeight += 20;
                }
                
                // Therapy approach matching
                const approachAnswer = window.quizAnswers[4];
                if (approachAnswer && approachAnswer.answer !== 'no_preference' && therapist.therapy_approaches_keys) {
                    const approachKey = approachAnswer.answer.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    if (therapist.therapy_approaches_keys.some(key => key.toLowerCase().includes(approachKey) || approachKey.includes(key.toLowerCase()))) {
                        score += 15; // Medium weight for approach match
                    }
                    totalWeight += 15;
                }
                
                // Availability matching
                const availabilityAnswer = window.quizAnswers[5];
                if (availabilityAnswer && therapist.availabilityKey) {
                    if (therapist.availabilityKey.toLowerCase() === availabilityAnswer.answer.toLowerCase()) {
                        score += 10; // Lower weight for availability
                    }
                    totalWeight += 10;
                }
                
                // Location proximity (if location was provided)
                if (window.quizUserLocation && therapist.distance !== undefined) {
                    // Bonus for closer therapists (within 5km)
                    if (therapist.distance <= 5) {
                        score += 10;
                    } else if (therapist.distance <= 10) {
                        score += 5;
                    }
                    totalWeight += 10;
                }
                
                // Calculate final match percentage
                const matchPercentage = totalWeight > 0 ? Math.round((score / totalWeight) * 100) : 50;
                
                return {
                    ...therapist,
                    matchScore: score,
                    totalWeight: totalWeight,
                    matchPercentage: matchPercentage
                };
            });
            
            // Sort by match score and return top 6
            const sortedMatches = matchedTherapists.sort((a, b) => b.matchScore - a.matchScore);
            const topMatches = sortedMatches.slice(0, 6);
            
            console.log(`‚úÖ Found ${topMatches.length} top matches`);
            return topMatches;
            
        } catch (error) {
            console.error("‚ùå Error calculating therapist matches:", error);
            return [];
        }
    };

    // Generate therapist card for quiz results
    window.generateMatchedTherapistCard = function(therapist) {
        try {
            const fullName = `Dr. ${therapist.first_name} ${therapist.last_name}`;
            const primaryApproach = therapist.therapy_approaches ? therapist.therapy_approaches[0] : 'General Therapy';
            const distance = therapist.distance || 0;
            
            return `
                <div class="bg-white rounded-2xl p-5 hover:shadow-lg transition-all duration-300 h-full" style="border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);">
                    <div class="h-full flex flex-col">
                        <!-- Therapist Image -->
                        <div class="mb-4">
                            <img src="${therapist.image || therapist.photo || 'User Panel Media/therapist1.png'}" alt="${fullName}" 
                                 class="w-20 h-20 rounded-2xl mx-auto object-cover shadow-sm"
                                 style="border: 1px solid rgba(0, 0, 0, 0.08);">
                        </div>
                        
                        <!-- Therapist Info -->
                        <div class="flex-1 text-center px-2">
                            <h3 class="font-semibold text-base mb-1" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
                                ${fullName}
                            </h3>
                            <p class="text-sm font-medium mb-2" style="color: #446081;">
                                ${therapist.title}
                            </p>
                            <p class="text-xs mb-3" style="color: #86868b; line-height: 1.4;">
                                ${primaryApproach}
                            </p>
                            
                            <!-- Location & Distance -->
                            <div class="space-y-1 mb-4">
                                <p class="text-xs" style="color: #86868b;">
                                    <span style="color: #1d1d1f; font-weight: 500;">${distance.toFixed(1)} km</span> ‚Ä¢ ${therapist.area || 'Athens'}
                                </p>
                                ${therapist.cost ? `
                                    <p class="text-xs" style="color: #86868b;">
                                        ‚Ç¨<span style="color: #1d1d1f; font-weight: 500;">${therapist.cost}</span>/session
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="mt-auto pt-2">
                            <button onclick="window.viewTherapistProfile(${therapist.id})" 
                                    class="w-full py-2 mb-2 rounded-xl font-medium text-sm transition-all duration-200"
                                    style="background-color: #f5f5f7; color: #446081; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                                View Profile
                            </button>
                            <button onclick="selectTherapist(${therapist.id})" 
                                    class="w-full py-2 rounded-xl font-medium text-sm transition-all duration-200"
                                    style="background-color: #446081; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                                Select Therapist
                            </button>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error("‚ùå Error generating matched therapist card:", error);
            return '';
        }
    };

    // ========== END OF COMPREHENSIVE QUIZ SYSTEM ==========

    // Legacy function for compatibility (kept for backwards compatibility)
    window.calculateTherapistScores = function() {
        console.warn("‚ö†Ô∏è Using legacy calculateTherapistScores - consider using calculateTherapistMatches instead");
        return window.calculateTherapistMatches();
    };

    // Setup event listeners as backup - COMMENTED OUT TO FIX SYNTAX ERRORS
    // document.addEventListener("DOMContentLoaded", function() {
    //     setTimeout(() => {
    //         const backToTherapistsBtn = document.getElementById("back-to-therapists-btn");
    //         const backToOptionsBtn = document.getElementById("back-to-options-btn");
    //         
    //         if (backToTherapistsBtn) {
    //             backToTherapistsBtn.addEventListener("click", function(e) {
    //                 e.preventDefault();
    //                 console.log("üîô Back to therapists clicked via listener");
    //                 if (window.navigateToTherapistStepOne) {
    //                     window.navigateToTherapistStepOne();
    //                 } else {
    //                     alert("Navigation function not found");
    //                 }
    //             });
    //             console.log("‚úÖ Back to therapists listener added");
    //         }
    //         
    //         if (backToOptionsBtn) {
    //             backToOptionsBtn.addEventListener("click", function(e) {
    //                 e.preventDefault();
    //                 console.log("üîô Back to options clicked via listener");
    //                 if (window.navigateToTherapistStepTwo) {
    //                     window.navigateToTherapistStepTwo();
    //                 } else {
    //                     alert("Navigation function not found");
    //                 }
    //             });
    //             console.log("‚úÖ Back to options listener added");
    //         }
    //     }, 100);
    // });

    // CRITICAL FIX: Move therapist navigation functions here to ensure proper scope for HTML elements below
    window.navigateToTherapistStepThreeCriteria = function() {
        console.log("üéØ Navigating to Therapist Step 3 - Criteria");
        try {
            const step1 = document.getElementById("therapist-step-1");
            const step2 = document.getElementById("therapist-step-2");
            const step3Location = document.getElementById("therapist-step-3-location");
            const step3Criteria = document.getElementById("therapist-step-3-criteria");
            
            if (step1) step1.classList.add("hidden");
            if (step2) step2.classList.add("hidden");
            if (step3Location) step3Location.classList.add("hidden");
            if (step3Criteria) {
                step3Criteria.classList.remove("hidden");
                step3Criteria.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(window.initializeCriteriaFilters, 100);
            }
        } catch (error) {
            console.error("‚ùå Error in navigateToTherapistStepThreeCriteria:", error);
        }
    };

    window.initializeCriteriaFilters = function() {
        try {
            console.log('üéØ INIT CRITERIA: Starting criteria filters initialization with localStorage...');
            
            // FIRST: Run comprehensive diagnostic
            console.log('üéØ INIT CRITERIA: Running Berlin country diagnostic...');
            if (typeof window.BerlinCountryDiagnostic === 'object') {
                const diagnosticReport = window.BerlinCountryDiagnostic.runCompleteDiagnostic();
                console.log('‚úÖ INIT CRITERIA: Diagnostic completed');
                
                // Check if we need to apply the authoritative fix
                if (diagnosticReport.filterState.incorrectOptions.length > 0 || 
                    diagnosticReport.therapistDataIntegrity.incorrectAssignments.length > 0) {
                    console.log('üöÄ INIT CRITERIA: Issues detected, applying authoritative fix...');
                    
                    if (typeof window.AuthoritativeBerlinFix === 'object') {
                        window.AuthoritativeBerlinFix.applyDefinitiveFix();
                        console.log('‚úÖ INIT CRITERIA: Authoritative fix applied');
                    }
                } else {
                    console.log('‚úÖ INIT CRITERIA: No issues detected, Berlin correctly assigned to Germany');
                }
            }
            
            // SECOND: Ensure master filter fix is called to correct country data
            if (typeof window.MASTER_FIX_ALL_FILTERS === 'function') {
                console.log('üéØ INIT CRITERIA: Running MASTER filter fix to correct countries...');
                window.MASTER_FIX_ALL_FILTERS();
                console.log('‚úÖ INIT CRITERIA: MASTER filter fix completed!');
            }
            
            // THIRD: Initialize the therapist count display
            setTimeout(() => {
                const resultsCount = document.getElementById('criteria-results-count');
                if (resultsCount && window.therapistData) {
                    const totalCount = window.therapistData.length;
                    resultsCount.textContent = `${totalCount} therapist${totalCount !== 1 ? 's' : ''} found`;
                    console.log(`‚úÖ INIT CRITERIA: Set initial count to ${totalCount} therapists`);
                }
            }, 100);
            
            // THIRD: Direct city filter fix to remove any remaining "Greece, Berlin" entries
            setTimeout(() => {
                console.log('üéØ INIT CRITERIA: Applying direct city filter fix...');
                const cityFilter = document.getElementById('city-filter');
                if (cityFilter) {
                    const options = Array.from(cityFilter.options);
                    let fixedCount = 0;
                    
                    options.forEach(option => {
                        const text = option.textContent || option.innerText || '';
                        if (text.includes('Greece, Berlin') || text.includes('Greece,Berlin')) {
                            console.log(`üîß Removing incorrect option: "${text}"`);
                            option.remove();
                            fixedCount++;
                        }
                    });
                    
                    // Add correct Berlin option if it doesn't exist
                    const hasCorrectBerlin = options.some(opt => 
                        (opt.textContent || '').includes('Germany, Berlin') || 
                        (opt.textContent || '').includes('Germany,Berlin')
                    );
                    
                    if (!hasCorrectBerlin) {
                        console.log('üîß Adding correct "Germany, Berlin" option');
                        const berlinOption = document.createElement('option');
                        berlinOption.value = 'berlin';
                        berlinOption.textContent = 'Germany, Berlin';
                        cityFilter.appendChild(berlinOption);
                        fixedCount++;
                    }
                    
                    console.log(`‚úÖ INIT CRITERIA: Fixed ${fixedCount} city filter entries`);
                }
            }, 500);
            
            // FIRST: Force load localStorage therapists before initializing filters
            if (typeof window.loadAndMergeLocalStorageTherapists === 'function') {
                console.log('üîÑ INIT CRITERIA: Loading localStorage therapists...');
                const added = window.loadAndMergeLocalStorageTherapists();
                if (added.length > 0) {
                    console.log(`‚úÖ INIT CRITERIA: Added ${added.length} therapists from localStorage`);
                }
            }
            
            // SECOND: Check if therapist data is available
            if (!window.therapistData || window.therapistData.length === 0) {
                console.error('‚ùå INIT CRITERIA: No therapist data available! Retrying in 1 second...');
                setTimeout(window.initializeCriteriaFilters, 1000);
                return;
            }
            
            console.log(`üéØ INIT CRITERIA: Found ${window.therapistData.length} therapists for filtering`);
            
            // THIRD: Use the proper dynamic filters initialization from therapist-data.js
            if (typeof window.initializeDynamicFilters === 'function') {
                console.log('üéØ INIT CRITERIA: Initializing dynamic filters...');
                window.initializeDynamicFilters();
                console.log('‚úÖ INIT CRITERIA: Dynamic filters initialized successfully');
            } else {
                console.error('‚ùå INIT CRITERIA: initializeDynamicFilters function not found!');
            }
            
            // FOURTH: Use the updated populateCriteriaCards function with all therapists
            if (typeof window.populateCriteriaCards === 'function') {
                console.log('üéØ INIT CRITERIA: Populating criteria cards...');
                window.populateCriteriaCards();
                console.log('‚úÖ INIT CRITERIA: Criteria filters and cards initialized with localStorage data');
            } else {
                console.error('‚ùå INIT CRITERIA: populateCriteriaCards function not found!');
            }
        } catch (error) {
            console.error("‚ùå Error initializing filters:", error);
            // Retry after a delay if there's an error
            setTimeout(window.initializeCriteriaFilters, 2000);
        }
    };

    // filterTherapistCards function removed - now using populateCriteriaCards from therapist-data.js

    window.clearAllFilters = function() {
        console.log("üßπ Clearing all filters");
        try {
            document.getElementById("city-filter").value = "";
            document.getElementById("area-filter").value = "";
            document.getElementById("language-filter").value = "";
            document.getElementById("therapy-approach-filter").value = "";
            document.getElementById("title-filter").value = "";
            document.getElementById("gender-filter").value = "";
            
            // Reset pagination to first page
            window.currentCriteriaPage = 0;
            
            // Use the updated populateCriteriaCards function with pagination
            if (typeof window.populateCriteriaCards === 'function') {
                window.populateCriteriaCards();
            }
            console.log("‚úÖ All filters cleared and pagination reset");
        } catch (error) {
            console.error("‚ùå Error clearing filters:", error);
        }
    };

    console.log("‚úÖ CRITICAL FIX APPLIED: Criteria functions now properly scoped and available!");

    // LOCATION VERIFICATION TEST - Check all cities and areas in therapist data
    window.testLocationFilters = function() {
        console.log('üó∫Ô∏è LOCATION FILTER TEST: Checking all cities and areas in therapist data...');
        console.log('‚ïê'.repeat(70));
        
        if (!window.therapistData || window.therapistData.length === 0) {
            console.log('‚ùå No therapist data available');
            return;
        }
        
        // Extract location data
        const locationData = new Map();
        
        window.therapistData.forEach((therapist, index) => {
            console.log(`${index + 1}. Dr. ${therapist.first_name} ${therapist.last_name}:`);
            console.log(`   City: ${therapist.city} (${therapist.cityKey})`);
            console.log(`   Area: ${therapist.area} (${therapist.areaKey})`);
            
            // Track cities
            if (therapist.cityKey) {
                if (!locationData.has(therapist.cityKey)) {
                    locationData.set(therapist.cityKey, {
                        key: therapist.cityKey,
                        name: therapist.city,
                        type: 'city',
                        therapists: []
                    });
                }
                locationData.get(therapist.cityKey).therapists.push(therapist.id);
            }
            
            // Track areas (if different from city)
            if (therapist.areaKey && therapist.areaKey !== therapist.cityKey) {
                if (!locationData.has(therapist.areaKey)) {
                    locationData.set(therapist.areaKey, {
                        key: therapist.areaKey,
                        name: therapist.area,
                        type: 'area',
                        parentCity: therapist.city,
                        therapists: []
                    });
                }
                locationData.get(therapist.areaKey).therapists.push(therapist.id);
            }
        });
        
        console.log('‚îÄ'.repeat(70));
        console.log(`üìä UNIQUE LOCATIONS FOUND: ${locationData.size}`);
        
        // Group by country for better display
        const countries = {};
        Array.from(locationData.values()).forEach(location => {
            let country = 'Unknown';
            const cityKey = location.type === 'area' ? 
                window.therapistData.find(t => t.areaKey === location.key)?.cityKey : 
                location.key;
                
            if (cityKey === 'athens') country = 'Greece';
            else if (cityKey === 'paris') country = 'France';
            else if (cityKey === 'berlin') country = 'Germany';
            else if (cityKey === 'rome') country = 'Italy';
            else if (cityKey === 'london') country = 'United Kingdom';
            
            if (!countries[country]) countries[country] = [];
            countries[country].push(location);
        });
        
        Object.keys(countries).sort().forEach(country => {
            console.log(`\nüè≥Ô∏è ${country}:`);
            countries[country].forEach(location => {
                const parentInfo = location.type === 'area' && location.parentCity ? 
                    ` (in ${location.parentCity})` : '';
                console.log(`   ${location.type === 'city' ? 'üèôÔ∏è' : 'üìç'} ${location.name}${parentInfo}: ${location.therapists.length} therapist(s) [${location.key}]`);
            });
        });
        
        console.log('‚îÄ'.repeat(70));
        
        // Check what's in the city/location filter dropdown
        const cityFilter = document.getElementById('city-filter');
        if (cityFilter) {
            console.log(`üìã LOCATION FILTER OPTIONS: ${cityFilter.options.length}`);
            Array.from(cityFilter.options).forEach((option, index) => {
                if (option.value) { // Skip the "All Locations" option
                    const locationInfo = locationData.get(option.value);
                    const count = locationInfo ? locationInfo.therapists.length : 0;
                    const status = count > 0 ? '‚úÖ' : '‚ö†Ô∏è';
                    console.log(`   ${status} ${option.text}: ${count} therapist(s) [${option.value}]`);
                }
            });
        }
        
        console.log('‚îÄ'.repeat(70));
        
        // Check for missing locations
        const filterOptions = Array.from(cityFilter.options)
            .map(opt => opt.value)
            .filter(val => val); // Remove empty value
            
        const allLocationKeys = Array.from(locationData.keys());
        const missingFromFilter = allLocationKeys.filter(key => !filterOptions.includes(key));
        const extraInFilter = filterOptions.filter(key => !allLocationKeys.includes(key));
        
        if (missingFromFilter.length > 0) {
            console.log(`‚ö†Ô∏è MISSING FROM FILTER: ${missingFromFilter.join(', ')}`);
            missingFromFilter.forEach(key => {
                const location = locationData.get(key);
                console.log(`   - ${location.name} (${location.type}): ${location.therapists.length} therapist(s)`);
            });
        }
        
        if (extraInFilter.length > 0) {
            console.log(`‚ÑπÔ∏è EXTRA IN FILTER (no therapists): ${extraInFilter.join(', ')}`);
        }
        
        if (missingFromFilter.length === 0) {
            console.log('üéâ PERFECT MATCH: All therapist locations are in the filter!');
        }
        
        // Special check for Zografou
        const zografouKey = 'zografou';
        const hasZografou = locationData.has(zografouKey) || locationData.has('zografou');
        if (hasZografou) {
            console.log('üéØ ZOGRAFOU FOUND in therapist data! ‚úÖ');
        } else {
            console.log('‚ö†Ô∏è Zografou not found in current therapist data');
            console.log('   This could mean:');
            console.log('   - Zografou therapists are in localStorage but not loaded yet');
            console.log('   - The areaKey for Zografou is different than expected');
            console.log('   - No therapists are currently registered in Zografou');
        }
        
        console.log('üó∫Ô∏è LOCATION FILTER TEST COMPLETE');
        console.log('‚ïê'.repeat(70));
    };

    // FORCE DYNAMIC FILTER INITIALIZATION - Test function to ensure filters are populated
    window.forceInitializeFilters = function() {
        console.log('üöÄ FORCE INITIALIZING DYNAMIC FILTERS...');
        console.log('‚ïê'.repeat(50));
        
        // Step 1: Check therapist data
        console.log(`üìä Therapist data: ${window.therapistData ? window.therapistData.length : 'NOT FOUND'} therapists`);
        
        if (!window.therapistData || window.therapistData.length === 0) {
            console.log('‚ùå No therapist data - cannot initialize filters');
            return;
        }
        
        // Step 2: Look for Zografou specifically
        const zografouTherapists = window.therapistData.filter(t => 
            (t.area && t.area.toLowerCase().includes('zografou')) ||
            (t.areaKey && t.areaKey.toLowerCase().includes('zografou'))
        );
        
        console.log(`üéØ Zografou therapists found: ${zografouTherapists.length}`);
        zografouTherapists.forEach(t => {
            console.log(`   - Dr. ${t.first_name} ${t.last_name} in ${t.area} (${t.areaKey})`);
        });
        
        // Step 3: Force call dynamic filter initialization
        if (typeof window.initializeDynamicFilters === 'function') {
            console.log('üîÑ Calling initializeDynamicFilters...');
            window.initializeDynamicFilters();
        } else {
            console.log('‚ùå initializeDynamicFilters function not found');
        }
        
        // Step 4: Check if Zografou is now in the city filter
        const cityFilter = document.getElementById('city-filter');
        if (cityFilter) {
            console.log(`üìã City filter now has ${cityFilter.options.length} options`);
            
            const zografouOption = Array.from(cityFilter.options).find(opt => 
                opt.value.toLowerCase().includes('zografou') || 
                opt.text.toLowerCase().includes('zografou')
            );
            
            if (zografouOption) {
                console.log(`‚úÖ ZOGRAFOU FOUND in filter: "${zografouOption.text}" (${zografouOption.value})`);
            } else {
                console.log('‚ùå Zografou still not found in city filter');
                console.log('Filter options:');
                Array.from(cityFilter.options).forEach(opt => {
                    if (opt.value) console.log(`   - ${opt.text} (${opt.value})`);
                });
            }
        }
        
        console.log('üöÄ FORCE INITIALIZATION COMPLETE');
        console.log('‚ïê'.repeat(50));
    };

    // COMPREHENSIVE LOCATION EXTRACTION AND FIX - Why locations are missing
    window.fixAllLocationFilters = function() {
        console.log('üîß COMPREHENSIVE LOCATION FIX: Ensuring ALL therapist locations appear...');
        console.log('‚ïê'.repeat(80));
        
        if (!window.therapistData || window.therapistData.length === 0) {
            console.log('‚ùå No therapist data available');
            return;
        }
        
        const cityFilter = document.getElementById('city-filter');
        if (!cityFilter) {
            console.log('‚ùå City filter element not found');
            return;
        }
        
        // STEP 1: Extract ALL unique locations from therapist data
        console.log('1Ô∏è‚É£ EXTRACTING: All unique locations from therapist data...');
        const locationMap = new Map();
        
        window.therapistData.forEach((therapist, index) => {
            console.log(`Therapist ${index + 1}: Dr. ${therapist.first_name} ${therapist.last_name}`);
            
            // Extract city information
            if (therapist.city && therapist.cityKey) {
                const cityKey = therapist.cityKey.toLowerCase().trim();
                if (!locationMap.has(cityKey)) {
                    locationMap.set(cityKey, {
                        key: cityKey,
                        displayName: therapist.city,
                        type: 'city',
                        country: getCountryFromCityKey(cityKey),
                        therapistCount: 0
                    });
                }
                locationMap.get(cityKey).therapistCount++;
                console.log(`   City: ${therapist.city} (${cityKey})`);
            } else {
                console.log(`   ‚ö†Ô∏è Missing city data: city="${therapist.city}", cityKey="${therapist.cityKey}"`);
            }
            
            // Extract area information (if different from city)
            if (therapist.area && therapist.areaKey) {
                const areaKey = therapist.areaKey.toLowerCase().trim();
                const cityKey = therapist.cityKey ? therapist.cityKey.toLowerCase().trim() : '';
                
                if (areaKey !== cityKey) {
                    if (!locationMap.has(areaKey)) {
                        locationMap.set(areaKey, {
                            key: areaKey,
                            displayName: therapist.area,
                            type: 'area',
                            parentCity: therapist.city,
                            country: getCountryFromCityKey(cityKey),
                            therapistCount: 0
                        });
                    }
                    locationMap.get(areaKey).therapistCount++;
                    console.log(`   Area: ${therapist.area} (${areaKey}) in ${therapist.city}`);
                } else {
                    console.log(`   Area same as city: ${therapist.area}`);
                }
            } else if (therapist.area) {
                console.log(`   ‚ö†Ô∏è Area without key: area="${therapist.area}", areaKey="${therapist.areaKey}"`);
            }
        });
        
        console.log(`üìä EXTRACTED: ${locationMap.size} unique locations`);
        
        // STEP 2: Clear and rebuild filter completely
        console.log('2Ô∏è‚É£ REBUILDING: City filter with all locations...');
        cityFilter.innerHTML = '';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'All Locations';
        cityFilter.appendChild(defaultOption);
        
        // STEP 3: Add all location options
        console.log('3Ô∏è‚É£ ADDING: Location options...');
        const sortedLocations = Array.from(locationMap.values()).sort((a, b) => {
            // Sort by country first, then by display name
            if (a.country !== b.country) {
                return a.country.localeCompare(b.country);
            }
            return a.displayName.localeCompare(b.displayName);
        });
        
        sortedLocations.forEach(location => {
            const option = document.createElement('option');
            option.value = location.key;
            
            // Create display text
            let displayText = '';
            if (location.country && location.country !== 'Unknown') {
                displayText += `${location.country} - `;
            }
            displayText += location.displayName;
            
            if (location.type === 'area' && location.parentCity && location.parentCity !== location.displayName) {
                displayText += ` (${location.parentCity})`;
            }
            
            option.textContent = displayText;
            cityFilter.appendChild(option);
            
            console.log(`   ‚úÖ Added: ${displayText} [${location.key}] - ${location.therapistCount} therapist(s)`);
        });
        
        console.log(`‚úÖ REBUILT: City filter with ${cityFilter.options.length} total options`);
        
        // STEP 4: Verify all therapist locations are now available
        console.log('4Ô∏è‚É£ VERIFYING: All therapist locations are in filter...');
        const filterKeys = Array.from(cityFilter.options)
            .map(opt => opt.value)
            .filter(val => val); // Remove empty value
        
        let missingLocations = 0;
        window.therapistData.forEach(therapist => {
            const cityMissing = therapist.cityKey && !filterKeys.includes(therapist.cityKey.toLowerCase().trim());
            const areaMissing = therapist.areaKey && therapist.areaKey !== therapist.cityKey && !filterKeys.includes(therapist.areaKey.toLowerCase().trim());
            
            if (cityMissing) {
                console.log(`‚ö†Ô∏è Missing city: ${therapist.city} (${therapist.cityKey}) for Dr. ${therapist.first_name} ${therapist.last_name}`);
                missingLocations++;
            }
            
            if (areaMissing) {
                console.log(`‚ö†Ô∏è Missing area: ${therapist.area} (${therapist.areaKey}) for Dr. ${therapist.first_name} ${therapist.last_name}`);
                missingLocations++;
            }
        });
        
        if (missingLocations === 0) {
            console.log('üéâ SUCCESS: All therapist locations are now in the filter!');
        } else {
            console.log(`‚ùå Still missing ${missingLocations} location(s)`);
        }
        
        console.log('üîß COMPREHENSIVE LOCATION FIX COMPLETE');
        console.log('‚ïê'.repeat(80));
        
        return locationMap.size;
    };
    
    // UNIVERSAL FILTER FIX - Fix ALL filters (city, therapy approach, etc.)
    window.fixAllFilters = function() {
        console.log('üöÄ UNIVERSAL FILTER FIX: Rebuilding ALL filters from therapist data...');
        console.log('‚ïê'.repeat(80));
        
        if (!window.therapistData || window.therapistData.length === 0) {
            console.log('‚ùå No therapist data available - cannot fix filters');
            return;
        }
        
        console.log(`üìä Processing ${window.therapistData.length} therapists...`);
        
        // EXTRACT ALL UNIQUE VALUES
        const extractedData = {
            titles: new Set(),
            languages: new Set(),
            therapyApproaches: new Map(), // key -> display name
            cities: new Set(),
            areas: new Map(), // key -> {name, city, country}
            genders: new Set()
        };
        
        console.log('1Ô∏è‚É£ EXTRACTING: All unique values from therapist data...');
        
        window.therapistData.forEach((therapist, index) => {
            console.log(`Processing: Dr. ${therapist.first_name} ${therapist.last_name}`);
            
            // Extract titles
            if (therapist.title) {
                extractedData.titles.add(therapist.title);
                console.log(`   Title: ${therapist.title}`);
            }
            
            // Extract languages
            if (therapist.languageKeys) {
                therapist.languageKeys.forEach(lang => {
                    extractedData.languages.add(lang);
                });
                console.log(`   Languages: ${therapist.languageKeys.join(', ')}`);
            }
            
            // Extract therapy approaches
            if (therapist.therapy_approaches && therapist.therapy_approaches_keys) {
                therapist.therapy_approaches_keys.forEach((key, idx) => {
                    const fullName = therapist.therapy_approaches[idx] || key;
                    extractedData.therapyApproaches.set(key, fullName);
                });
                console.log(`   Approaches: ${therapist.therapy_approaches.join(', ')}`);
            }
            
            // Extract cities and areas
            if (therapist.cityKey) {
                extractedData.cities.add(therapist.cityKey);
            }
            if (therapist.areaKey && therapist.areaKey !== therapist.cityKey) {
                let country = getCountryFromCityKey(therapist.cityKey);
                extractedData.areas.set(therapist.areaKey, {
                    name: therapist.area,
                    city: therapist.city,
                    country: country
                });
                console.log(`   Area: ${therapist.area} (${therapist.areaKey}) in ${therapist.city}`);
            }
            
            // Extract genders
            if (therapist.gender) {
                extractedData.genders.add(therapist.gender);
            }
        });
        
        console.log('üìä EXTRACTED SUMMARY:');
        console.log(`   Titles: ${extractedData.titles.size} (${Array.from(extractedData.titles).join(', ')})`);
        console.log(`   Languages: ${extractedData.languages.size} (${Array.from(extractedData.languages).join(', ')})`);
        console.log(`   Therapy Approaches: ${extractedData.therapyApproaches.size}`);
        Array.from(extractedData.therapyApproaches.entries()).forEach(([key, name]) => {
            console.log(`      ${name} (${key})`);
        });
        console.log(`   Cities: ${extractedData.cities.size} (${Array.from(extractedData.cities).join(', ')})`);
        console.log(`   Areas: ${extractedData.areas.size}`);
        Array.from(extractedData.areas.entries()).forEach(([key, info]) => {
            console.log(`      ${info.name} (${key}) in ${info.city}`);
        });
        console.log(`   Genders: ${extractedData.genders.size} (${Array.from(extractedData.genders).join(', ')})`);
        
        // REBUILD ALL FILTERS
        console.log('2Ô∏è‚É£ REBUILDING: All filter dropdowns...');
        
        // Helper function to rebuild a filter
        function rebuildFilter(filterId, items, createDisplayName) {
            const filter = document.getElementById(filterId);
            if (!filter) {
                console.log(`‚ùå Filter '${filterId}' not found`);
                return false;
            }
            
            console.log(`   Rebuilding ${filterId}...`);
            filter.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = filter.id.includes('city') ? 'All Locations' : 
                                       filter.id.includes('language') ? 'All Languages' :
                                       filter.id.includes('therapy') ? 'All Approaches' :
                                       filter.id.includes('title') ? 'All Titles' :
                                       filter.id.includes('gender') ? 'All Genders' : 'All';
            filter.appendChild(defaultOption);
            
            // Add all options
            items.forEach(item => {
                const {key, display} = createDisplayName(item);
                const option = document.createElement('option');
                option.value = key;
                option.textContent = display;
                filter.appendChild(option);
                console.log(`      ‚úÖ Added: ${display} (${key})`);
            });
            
            console.log(`   ‚úÖ ${filterId} rebuilt with ${filter.options.length} options`);
            return true;
        }
        
        // TITLE FILTER
        rebuildFilter('title-filter', Array.from(extractedData.titles).sort(), 
            title => ({key: title, display: title}));
        
        // LANGUAGE FILTER  
        rebuildFilter('language-filter', Array.from(extractedData.languages).sort(),
            lang => ({key: lang, display: lang.charAt(0).toUpperCase() + lang.slice(1)}));
        
        // THERAPY APPROACH FILTER
        rebuildFilter('therapy-approach-filter', Array.from(extractedData.therapyApproaches.entries()).sort((a,b) => a[1].localeCompare(b[1])),
            ([key, displayName]) => ({key: key, display: displayName}));
        
        // CITY/LOCATION FILTER (combine cities and areas)
        const allLocations = [];
        
        // Add cities
        extractedData.cities.forEach(cityKey => {
            const therapist = window.therapistData.find(t => t.cityKey === cityKey);
            if (therapist) {
                const country = getCountryFromCityKey(cityKey);
                allLocations.push({
                    key: cityKey,
                    display: `${country} - ${therapist.city}`,
                    sortKey: `${country}-${therapist.city}`
                });
            }
        });
        
        // Add areas
        extractedData.areas.forEach((areaInfo, areaKey) => {
            allLocations.push({
                key: areaKey,
                display: `${areaInfo.country} - ${areaInfo.name} (${areaInfo.city})`,
                sortKey: `${areaInfo.country}-${areaInfo.name}`
            });
        });
        
        rebuildFilter('city-filter', allLocations.sort((a,b) => a.sortKey.localeCompare(b.sortKey)),
            location => ({key: location.key, display: location.display}));
        
        // GENDER FILTER
        rebuildFilter('gender-filter', Array.from(extractedData.genders).sort(),
            gender => ({key: gender, display: gender.charAt(0).toUpperCase() + gender.slice(1)}));
        
        console.log('üéâ ALL FILTERS REBUILT FROM THERAPIST DATA!');
        console.log('‚ïê'.repeat(80));
        
        return {
            titles: extractedData.titles.size,
            languages: extractedData.languages.size,
            approaches: extractedData.therapyApproaches.size,
            locations: extractedData.cities.size + extractedData.areas.size,
            genders: extractedData.genders.size
        };
    };
    
    // Helper function to determine country from city key
    function getCountryFromCityKey(cityKey) {
        if (!cityKey) return 'Unknown';
        const key = cityKey.toLowerCase();
        if (key === 'athens') return 'Greece';
        if (key === 'paris') return 'France';
        if (key === 'berlin') return 'Germany';
        if (key === 'rome') return 'Italy';
        if (key === 'london') return 'United Kingdom';
        return 'Unknown';
    }

    // COMPREHENSIVE DIAGNOSTIC AND FIX SYSTEM - Top 10 Issues
    window.diagnoseCriteriaFilters = function() {
        console.log('üîç COMPREHENSIVE DIAGNOSTIC: Top 10 Issues Analysis...');
        console.log('‚ïê'.repeat(80));
        
        const issues = [];
        
        // ISSUE 1: Check if therapist-data.js is loaded
        console.log('1Ô∏è‚É£ CHECKING: therapist-data.js loaded...');
        if (typeof window.therapistData === 'undefined') {
            issues.push('therapist-data.js not loaded');
            console.log('‚ùå therapist-data.js NOT LOADED');
        } else {
            console.log(`‚úÖ therapist-data.js loaded with ${window.therapistData.length} therapists`);
            
            // Check for Zografou in data
            const zografouTherapists = window.therapistData.filter(t => 
                (t.area && t.area.toLowerCase().includes('zografou')) ||
                (t.areaKey && t.areaKey.toLowerCase().includes('zografou'))
            );
            console.log(`   üéØ Zografou therapists in data: ${zografouTherapists.length}`);
        }
        
        // ISSUE 2: Check if initializeDynamicFilters function exists
        console.log('2Ô∏è‚É£ CHECKING: initializeDynamicFilters function...');
        if (typeof window.initializeDynamicFilters !== 'function') {
            issues.push('initializeDynamicFilters function not found');
            console.log('‚ùå initializeDynamicFilters function NOT FOUND');
        } else {
            console.log('‚úÖ initializeDynamicFilters function exists');
        }
        
        // ISSUE 3: Check if city-filter element exists
        console.log('3Ô∏è‚É£ CHECKING: city-filter element...');
        const cityFilter = document.getElementById('city-filter');
        if (!cityFilter) {
            issues.push('city-filter element not found in DOM');
            console.log('‚ùå city-filter element NOT FOUND');
        } else {
            console.log(`‚úÖ city-filter element found with ${cityFilter.options.length} options`);
            
            // Check current options
            const hasZografou = Array.from(cityFilter.options).some(opt => 
                opt.value.toLowerCase().includes('zografou') || 
                opt.text.toLowerCase().includes('zografou')
            );
            console.log(`   üéØ Zografou in filter: ${hasZografou ? 'YES' : 'NO'}`);
        }
        
        // ISSUE 4: Test dynamic filter initialization
        console.log('4Ô∏è‚É£ TESTING: Dynamic filter initialization...');
        try {
            if (window.initializeDynamicFilters && cityFilter) {
                console.log('   Running initializeDynamicFilters...');
                window.initializeDynamicFilters();
                
                const afterInit = Array.from(cityFilter.options).some(opt => 
                    opt.value.toLowerCase().includes('zografou') || 
                    opt.text.toLowerCase().includes('zografou')
                );
                console.log(`   üéØ Zografou after init: ${afterInit ? 'YES' : 'NO'}`);
                
                if (!afterInit) {
                    issues.push('Zografou not appearing after dynamic filter init');
                }
            }
        } catch (error) {
            issues.push(`Error during filter init: ${error.message}`);
            console.log(`‚ùå Error: ${error.message}`);
        }
        
        // ISSUE 5: Manual fix attempt
        console.log('5Ô∏è‚É£ ATTEMPTING: Manual filter fix...');
        if (cityFilter && window.therapistData) {
            const zografouTherapist = window.therapistData.find(t => 
                (t.area && t.area.toLowerCase().includes('zografou')) ||
                (t.areaKey && t.areaKey.toLowerCase().includes('zografou'))
            );
            
            if (zografouTherapist) {
                console.log('   Found Zografou therapist, adding option manually...');
                
                // Check if option already exists
                const existingOption = Array.from(cityFilter.options).find(opt => 
                    opt.value === 'zografou'
                );
                
                if (!existingOption) {
                    const option = document.createElement('option');
                    option.value = 'zografou';
                    option.textContent = 'Greece - Zografou (Athens)';
                    cityFilter.appendChild(option);
                    console.log('   ‚úÖ Manually added Zografou option');
                } else {
                    console.log('   ‚úÖ Zografou option already exists');
                }
            } else {
                console.log('   ‚ùå No Zografou therapist found to add option for');
            }
        }
        
        console.log('‚îÄ'.repeat(80));
        
        // SUMMARY
        if (issues.length === 0) {
            console.log('üéâ NO MAJOR ISSUES FOUND');
        } else {
            console.log(`‚ùå FOUND ${issues.length} ISSUE(S):`);
            issues.forEach((issue, index) => {
                console.log(`   ${index + 1}. ${issue}`);
            });
        }
        
        // Final check
        const finalCheck = cityFilter && Array.from(cityFilter.options).some(opt => 
            opt.value.toLowerCase().includes('zografou') || 
            opt.text.toLowerCase().includes('zografou')
        );
        
        console.log('‚ïê'.repeat(80));
        if (finalCheck) {
            console.log('üéâ ZOGRAFOU IS NOW AVAILABLE IN CITY FILTER!');
        } else {
            console.log('‚ùå ZOGRAFOU STILL NOT AVAILABLE - CHECK CONSOLE ERRORS');
        }
        console.log('üîç DIAGNOSTIC COMPLETE');
        console.log('‚ïê'.repeat(80));
        
        return issues;
    };

    // LANGUAGE VERIFICATION TEST - Check all languages in therapist data
    window.testLanguageFilters = function() {
        console.log('üó£Ô∏è LANGUAGE FILTER TEST: Checking all languages in therapist data...');
        console.log('‚ïê'.repeat(60));
        
        if (!window.therapistData || window.therapistData.length === 0) {
            console.log('‚ùå No therapist data available');
            return;
        }
        
        // Extract all languages from therapist data
        const allLanguages = [];
        const languageFrequency = {};
        
        window.therapistData.forEach((therapist, index) => {
            if (therapist.languageKeys && therapist.languageKeys.length > 0) {
                therapist.languageKeys.forEach(lang => {
                    if (!allLanguages.includes(lang)) {
                        allLanguages.push(lang);
                    }
                    languageFrequency[lang] = (languageFrequency[lang] || 0) + 1;
                });
                console.log(`${index + 1}. Dr. ${therapist.first_name} ${therapist.last_name}: ${therapist.languageKeys.join(', ')}`);
            }
        });
        
        console.log('‚îÄ'.repeat(60));
        console.log(`üìä UNIQUE LANGUAGES FOUND: ${allLanguages.length}`);
        allLanguages.forEach(lang => {
            console.log(`   ${lang}: ${languageFrequency[lang]} therapist(s)`);
        });
        
        console.log('‚îÄ'.repeat(60));
        
        // Check what's in the language filter dropdown
        const languageFilter = document.getElementById('language-filter');
        if (languageFilter) {
            console.log(`üìã LANGUAGE FILTER OPTIONS: ${languageFilter.options.length}`);
            Array.from(languageFilter.options).forEach((option, index) => {
                if (option.value) { // Skip the "All Languages" option
                    const count = languageFrequency[option.value] || 0;
                    const status = count > 0 ? '‚úÖ' : '‚ö†Ô∏è';
                    console.log(`   ${status} ${option.text} (${option.value}): ${count} therapist(s)`);
                }
            });
        }
        
        console.log('‚îÄ'.repeat(60));
        
        // Check for missing languages
        const filterOptions = Array.from(languageFilter.options)
            .map(opt => opt.value)
            .filter(val => val); // Remove empty value
            
        const missingFromFilter = allLanguages.filter(lang => !filterOptions.includes(lang));
        const extraInFilter = filterOptions.filter(lang => !allLanguages.includes(lang));
        
        if (missingFromFilter.length > 0) {
            console.log(`‚ö†Ô∏è MISSING FROM FILTER: ${missingFromFilter.join(', ')}`);
        }
        
        if (extraInFilter.length > 0) {
            console.log(`‚ÑπÔ∏è EXTRA IN FILTER: ${extraInFilter.join(', ')}`);
        }
        
        if (missingFromFilter.length === 0 && extraInFilter.length === 0) {
            console.log('üéâ PERFECT MATCH: All therapist languages are in the filter!');
        }
        
        console.log('üó£Ô∏è LANGUAGE FILTER TEST COMPLETE');
        console.log('‚ïê'.repeat(60));
    };

    // COMPREHENSIVE TEST FUNCTION FOR DEBUGGING FILTERS
    window.testFilters = function() {
        console.log('üîß COMPREHENSIVE FILTER TEST: Starting complete filter system debug...');
        console.log('‚ïê'.repeat(80));
        
        // 1. Check therapist data availability
        console.log('üìä STEP 1: Therapist Data Check');
        if (window.therapistData) {
            console.log(`‚úÖ Therapist data: ${window.therapistData.length} therapists loaded`);
            
            // Show sample of first few therapists
            const sample = window.therapistData.slice(0, 3);
            sample.forEach((therapist, index) => {
                console.log(`   ${index + 1}. Dr. ${therapist.first_name} ${therapist.last_name} (${therapist.title}) - ${therapist.city}`);
                console.log(`      Languages: ${therapist.languageKeys?.join(', ') || 'N/A'}`);
                console.log(`      Approaches: ${therapist.therapy_approaches_keys?.join(', ') || 'N/A'}`);
                console.log(`      Gender: ${therapist.gender || 'N/A'}`);
            });
        } else {
            console.log('‚ùå No therapist data found');
        }
        
        console.log('‚îÄ'.repeat(80));
        
        // 2. Check filter elements existence and content
        console.log('üìã STEP 2: Filter Elements Check');
        const filterIds = ['title-filter', 'language-filter', 'therapy-approach-filter', 'city-filter', 'service-filter', 'gender-filter'];
        filterIds.forEach(filterId => {
            const element = document.getElementById(filterId);
            if (element) {
                const optionCount = element.options ? element.options.length : 0;
                console.log(`‚úÖ ${filterId}: Found with ${optionCount} options`);
                
                if (optionCount > 0) {
                    const options = Array.from(element.options).map(opt => `"${opt.text}" (${opt.value})`);
                    console.log(`   Options: ${options.join(', ')}`);
                } else {
                    console.log('   ‚ö†Ô∏è No options found!');
                }
            } else {
                console.log(`‚ùå ${filterId}: Element not found`);
            }
        });
        
        console.log('‚îÄ'.repeat(80));
        
        // 3. Test data extraction
        console.log('üîç STEP 3: Data Extraction Test');
        if (window.therapistData && window.therapistData.length > 0) {
            try {
                const uniqueTitles = [...new Set(window.therapistData.map(t => t.title).filter(Boolean))];
                const uniqueLanguages = [...new Set(window.therapistData.flatMap(t => t.languageKeys || []).filter(Boolean))];
                const uniqueApproaches = [...new Set(window.therapistData.flatMap(t => t.therapy_approaches_keys || []).filter(Boolean))];
                const uniqueCities = [...new Set(window.therapistData.map(t => t.cityKey).filter(Boolean))];
                const uniqueGenders = [...new Set(window.therapistData.map(t => t.gender).filter(Boolean))];
                
                console.log(`‚úÖ Extracted unique values:`);
                console.log(`   Titles (${uniqueTitles.length}): ${uniqueTitles.join(', ')}`);
                console.log(`   Languages (${uniqueLanguages.length}): ${uniqueLanguages.join(', ')}`);
                console.log(`   Approaches (${uniqueApproaches.length}): ${uniqueApproaches.join(', ')}`);
                console.log(`   Cities (${uniqueCities.length}): ${uniqueCities.join(', ')}`);
                console.log(`   Genders (${uniqueGenders.length}): ${uniqueGenders.join(', ')}`);
            } catch (error) {
                console.log(`‚ùå Data extraction failed: ${error.message}`);
            }
        }
        
        console.log('‚îÄ'.repeat(80));
        
        // 4. Force re-initialize filters
        console.log('üîÑ STEP 4: Force Filter Re-initialization');
        if (typeof window.initializeDynamicFilters === 'function') {
            console.log('üéØ Calling initializeDynamicFilters...');
            window.initializeDynamicFilters();
            console.log('‚úÖ Filter re-initialization complete');
        } else {
            console.log('‚ùå initializeDynamicFilters function not found');
        }
        
        console.log('‚îÄ'.repeat(80));
        
        // 5. Test filter functionality
        console.log('üß™ STEP 5: Filter Functionality Test');
        if (typeof window.populateCriteriaCards === 'function') {
            console.log('üéØ Testing populateCriteriaCards...');
            window.populateCriteriaCards();
            console.log('‚úÖ Card population test complete');
        } else {
            console.log('‚ùå populateCriteriaCards function not found');
        }
        
        console.log('‚îÄ'.repeat(80));
        
        // 6. Check localStorage integration
        console.log('üíæ STEP 6: localStorage Integration Check');
        try {
            const savedData = localStorage.getItem('therapistData');
            if (savedData) {
                const localTherapists = JSON.parse(savedData);
                console.log(`‚úÖ localStorage: ${localTherapists.length} therapists found`);
                
                // Check if they're merged
                const localIds = localTherapists.map(t => t.id);
                const globalIds = window.therapistData ? window.therapistData.map(t => t.id) : [];
                const merged = localIds.filter(id => globalIds.includes(id));
                console.log(`   Merged: ${merged.length}/${localIds.length} localStorage therapists found in global data`);
            } else {
                console.log('‚ÑπÔ∏è No localStorage therapist data found');
            }
        } catch (error) {
            console.log(`‚ùå localStorage check failed: ${error.message}`);
        }
        
        console.log('‚ïê'.repeat(80));
        
        // 7. Final status
        console.log('üìä STEP 7: Final System Status');
        const filterElements = filterIds.map(id => document.getElementById(id)).filter(Boolean);
        const filtersWithOptions = filterElements.filter(el => el.options && el.options.length > 1);
        
        console.log(`‚úÖ ${filterElements.length}/${filterIds.length} filter elements found`);
        console.log(`‚úÖ ${filtersWithOptions.length}/${filterElements.length} filters have options`);
        
        if (filtersWithOptions.length === filterElements.length) {
            console.log('üéâ ALL FILTERS WORKING CORRECTLY!');
        } else {
            console.log('‚ö†Ô∏è Some filters may need attention');
        }
        
        console.log('üîß COMPREHENSIVE FILTER TEST COMPLETE');
        console.log('‚ïê'.repeat(80));
    };
    </script>
      <div id="therapist-step-1">
        <!-- Therapist Pictures Grid - Landing Page Style -->
        <div class="flex justify-center items-center mb-16">
          <div class="landing-therapist-cards">
            <div class="landing-therapist-card card1" onclick="
              var step1 = document.getElementById('therapist-step-1');
              var step2 = document.getElementById('therapist-step-2');
              if (step1) { step1.style.display = 'none'; step1.classList.add('hidden'); }
              if (step2) { step2.style.display = 'block'; step2.classList.remove('hidden'); step2.scrollIntoView({behavior: 'smooth', block: 'start'}); }
            " style="cursor: pointer;">
              <img src="User Panel Media/therapist2.png" alt="Therapist 2" class="landing-therapist-img">
              <div class="landing-therapist-content">
                <div class="landing-therapist-title" style="color: #666 !important;">Dr. Emily Davis</div>
                <div class="landing-therapist-desc" style="color: #005A9C !important;">Family Therapist</div>
                <div class="landing-therapist-desc">Paris, France</div>
                <div class="landing-therapist-rating" style="color: #005A9C !important;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 4.9</div>
                <button class="landing-therapist-btn">View</button>
        </div>
        </div>
            <div class="landing-therapist-card card2" onclick="
              var step1 = document.getElementById('therapist-step-1');
              var step2 = document.getElementById('therapist-step-2');
              if (step1) { step1.style.display = 'none'; step1.classList.add('hidden'); }
              if (step2) { step2.style.display = 'block'; step2.classList.remove('hidden'); step2.scrollIntoView({behavior: 'smooth', block: 'start'}); }
            " style="cursor: pointer;">
              <img src="User Panel Media/therapist1.png" alt="Therapist 1" class="landing-therapist-img">
              <div class="landing-therapist-content">
                <div class="landing-therapist-title" style="color: #666 !important;">Dr. Sarah Johnson</div>
                <div class="landing-therapist-desc" style="color: #005A9C !important;">Clinical Psychologist</div>
                <div class="landing-therapist-desc">Athens, Greece</div>
                <div class="landing-therapist-rating" style="color: #005A9C !important;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 4.9</div>
                <button class="landing-therapist-btn">View</button>
        </div>
        </div>
            <div class="landing-therapist-card card3" onclick="
              var step1 = document.getElementById('therapist-step-1');
              var step2 = document.getElementById('therapist-step-2');
              if (step1) { step1.style.display = 'none'; step1.classList.add('hidden'); }
              if (step2) { step2.style.display = 'block'; step2.classList.remove('hidden'); step2.scrollIntoView({behavior: 'smooth', block: 'start'}); }
            " style="cursor: pointer;">
              <img src="User Panel Media/therapist3.png" alt="Therapist 3" class="landing-therapist-img">
              <div class="landing-therapist-content">
                <div class="landing-therapist-title" style="color: #666 !important;">Dr. Michael Chen</div>
                <div class="landing-therapist-desc" style="color: #005A9C !important;">Behavioral Therapist</div>
                <div class="landing-therapist-desc">Manhattan, NY</div>
                <div class="landing-therapist-rating" style="color: #005A9C !important;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 4.8</div>
                <button class="landing-therapist-btn">View</button>
        </div>
        </div>
        </div>
        </div>
        
        <!-- Find Therapist Button -->
        <div class="flex justify-center">
          <button id="find-therapist-btn" onclick="navigateToTherapistStepTwo(); console.log('Go to Step 2')" class="px-10 py-4 text-lg font-semibold rounded-full transform transition-all duration-300 hover:scale-105 hover:shadow-xl relative overflow-hidden" style="background: #212529; border: 1px solid #212529; color: white;">
            <span class="relative z-10">Find Therapist</span>
        </div>
      </div>

      <!-- Step 2: Selection Options (hidden by default) -->
      <div id="therapist-step-2" class="hidden" style="padding: 2rem 1rem;">        
        <h3 class="text-2xl font-medium text-gray-900 text-center mb-12" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #111827 !important;">Choose how to search for therapist</h3>        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto mb-12">
          <!-- Location Option -->
          <div id="location-option-btn" class="location-gradient relative group cursor-pointer transform transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]" onclick="navigateToTherapistStepThree(); console.log('Go to Step 3 - Location')">
            <div class="location-photo-container rounded-2xl text-black text-center shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden" style="background-image: url('./User Panel Media/locationphoto.png') !important; background-size: cover !important; background-position: center top !important; background-repeat: no-repeat !important; border: 1px solid rgba(0, 0, 0, 0.06) !important; height: 200px; width: 100%; position: relative;">
              <!-- Apple-like gradient overlay -->
              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent rounded-2xl"></div>
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <div class="bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm">
                  <h4 class="text-lg font-semibold mb-1" style="color: #446081 !important;">Location</h4>
                  <p class="text-sm font-medium" style="color: #446081 !important;">Find therapists near you</p>
                </div>
              </div>
        </div>
        </div>

          <!-- Criteria Option -->
          <div class="criteria-gradient relative group cursor-pointer transform transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]" onclick="
            document.getElementById('therapist-step-1').style.display = 'none';
            document.getElementById('therapist-step-1').classList.add('hidden');
            document.getElementById('therapist-step-2').style.display = 'none';
            document.getElementById('therapist-step-2').classList.add('hidden');
            document.getElementById('therapist-step-3-location').style.display = 'none';
            document.getElementById('therapist-step-3-location').classList.add('hidden');
            document.getElementById('therapist-step-3-quiz').style.display = 'none';
            document.getElementById('therapist-step-3-quiz').classList.add('hidden');
            document.getElementById('therapist-step-3-criteria').style.display = 'block';
            document.getElementById('therapist-step-3-criteria').classList.remove('hidden');
            document.getElementById('therapist-step-3-criteria').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        setTimeout(function() {
              console.log('üéØ CRITERIA: Initializing criteria step with localStorage integration...');
              
              // FIRST: Force load localStorage therapists
              if (typeof window.loadAndMergeLocalStorageTherapists === 'function') {
                console.log('üîÑ CRITERIA: Loading localStorage therapists first...');
                const added = window.loadAndMergeLocalStorageTherapists();
                if (added.length > 0) {
                  console.log(`‚úÖ CRITERIA: Added ${added.length} therapists from localStorage`);
                }
              }
              
              // SECOND: FORCE Initialize dynamic filters with updated data (CRITICAL!)
              if (typeof window.initializeDynamicFilters === 'function') {
                console.log('üéØ CRITERIA: FORCING dynamic filters initialization...');
                window.initializeDynamicFilters();
                console.log('‚úÖ CRITERIA: Dynamic filters initialized - Zografou should be available now!');
              } else {
                console.log('‚ùå CRITERIA: initializeDynamicFilters function not found!');
              }
              
              // THIRD: Populate cards with all therapists (including new ones)
              if (typeof window.populateCriteriaCards === 'function') {
                console.log('üéØ CRITERIA: Populating criteria cards...');
                window.populateCriteriaCards();
                console.log('‚úÖ CRITERIA: Therapist cards populated with localStorage data');
              }
            }, 300);
            
                         // ADDITIONAL SAFETY: Force filter initialization after a longer delay
             setTimeout(() => {
                 console.log('üõ°Ô∏è SAFETY: Additional filter initialization check...');
                 if (window.therapistData && window.therapistData.length > 0) {
                     if (typeof window.initializeDynamicFilters === 'function') {
                         console.log('üõ°Ô∏è SAFETY: Running additional filter initialization...');
                         window.initializeDynamicFilters();
                         console.log('üõ°Ô∏è SAFETY: Dynamic filters initialized - checking results...');
                         
                         // Verify filters were populated
                         const filterIds = ['title-filter', 'language-filter', 'therapy-approach-filter', 'city-filter', 'gender-filter'];
                         filterIds.forEach(filterId => {
                             const element = document.getElementById(filterId);
                             if (element && element.options) {
                                 console.log(`‚úÖ ${filterId}: ${element.options.length} options`);
                             }
                         });
                     }
                     if (typeof window.populateCriteriaCards === 'function') {
                         console.log('üõ°Ô∏è SAFETY: Running additional card population...');
                         window.populateCriteriaCards();
                     }
                 } else {
                     console.log('‚ö†Ô∏è SAFETY: No therapist data available, retrying...');
                     setTimeout(() => {
                         if (window.therapistData && window.therapistData.length > 0 && typeof window.initializeDynamicFilters === 'function') {
                             console.log('üîÑ RETRY: Running delayed filter initialization...');
                             window.initializeDynamicFilters();
                         }
                     }, 2000);
                 }
             }, 1000);
            
            console.log('‚úÖ Criteria Step - Step shown successfully');
            return false;
          ">
            <div class="criteria-photo-container rounded-2xl text-black text-center shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden" style="background-image: url('./User Panel Media/criteriaphoto.png') !important; background-size: cover !important; background-position: center top !important; background-repeat: no-repeat !important; border: 1px solid rgba(0, 0, 0, 0.06) !important; height: 200px; width: 100%; position: relative;">
              <!-- Apple-like gradient overlay -->
              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent rounded-2xl"></div>
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <div class="bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm">
                  <h4 class="text-lg font-semibold mb-1" style="color: #446081 !important;">Criteria</h4>
                  <p class="text-sm font-medium" style="color: #446081 !important;">Filter by specialties</p>
                </div>
              </div>
        </div>
        </div>

          <!-- Quiz Option -->
          <div class="quiz-gradient relative group cursor-pointer transform transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]" onclick="
            console.log('Quiz clicked - starting simple navigation');
            document.getElementById('therapist-step-1').style.display = 'none';
            document.getElementById('therapist-step-2').style.display = 'none';
            if(document.getElementById('therapist-step-3-location')) document.getElementById('therapist-step-3-location').style.display = 'none';
            if(document.getElementById('therapist-step-3-criteria')) document.getElementById('therapist-step-3-criteria').style.display = 'none';
            document.getElementById('therapist-step-3-quiz').style.display = 'block';
            document.getElementById('therapist-step-3-quiz').classList.remove('hidden');
            document.getElementById('therapist-step-3-quiz').scrollIntoView({ behavior: 'smooth' });
            console.log('Quiz step should now be visible');
          ">
            <div class="quiz-photo-container rounded-2xl text-black text-center shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden" style="background-image: url('./User Panel Media/quizphoto.png') !important; background-size: cover !important; background-position: center top !important; background-repeat: no-repeat !important; border: 1px solid rgba(0, 0, 0, 0.06) !important; height: 200px; width: 100%; position: relative;">
              <!-- Apple-like gradient overlay -->
              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent rounded-2xl"></div>
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <div class="bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm">
                  <h4 class="text-lg font-semibold mb-1" style="color: #446081 !important;">Quiz</h4>
                  <p class="text-sm font-medium" style="color: #446081 !important;">Personalized matching</p>
                </div>
              </div>
        </div>
        </div>
        </div>

        <div class="flex justify-center">
          <button id="working-back-to-therapists-btn" onclick="
            document.getElementById('therapist-step-2').style.display = 'none';
            document.getElementById('therapist-step-2').classList.add('hidden');
            document.getElementById('therapist-step-1').style.display = 'block';
            document.getElementById('therapist-step-1').classList.remove('hidden');
            document.getElementById('therapist-step-1').scrollIntoView({ behavior: 'smooth', block: 'start' });
            console.log('‚úÖ Back to Therapists - Step 2 hidden, Step 1 shown, scrolled to top');
            return false;
          " class="flex items-center gap-1 md:gap-2 px-4 md:px-8 py-2 md:py-3 text-gray-700 text-sm md:text-base rounded-lg md:rounded-xl bg-white hover:bg-gray-50 border border-gray-300 transition-all">
            <span class="material-icons text-lg md:text-xl">arrow_back</span>
            Back
          </button>
        </div>
      </div>

      <!-- Step 3: Location-based Search (hidden by default) -->
      <div id="therapist-step-3-location" class="hidden">
        <div class="text-center mb-3">
        </div>
        
        <!-- Map Container -->
        <div id="map-container" class="w-full h-96 bg-gray-100 rounded-none sm:rounded-lg mb-6 flex items-center justify-center text-gray-500 shadow-lg -mx-12 sm:mx-0" style="width: calc(100% + 6rem); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);" onload="window.adjustMapSize(this)" data-responsive-map="true">
          <div class="text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
            Loading map...
        </div>
        </div>
        
        <!-- Therapist Cards with Pagination -->
        <div class="mb-8 rounded-2xl bg-white border border-gray-100 p-6 shadow-sm">
          <div class="flex justify-between items-center mb-6">
            <h4 class="text-xl font-medium text-gray-900" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Available Therapists</h4>
        </div>
          <div id="therapist-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Cards will be populated by JavaScript with distance info -->
        </div>
        </div>

        <button id="working-back-btn" onclick="
          document.getElementById('therapist-step-3-location').style.display = 'none';
          document.getElementById('therapist-step-3-location').classList.add('hidden');
          document.getElementById('therapist-step-2').style.display = 'block';
          document.getElementById('therapist-step-2').classList.remove('hidden');
          document.getElementById('therapist-step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('‚úÖ Back to Options - Step 3 hidden, Step 2 shown, scrolled to top');
          return false;
        " class="flex items-center gap-1 md:gap-2 px-4 md:px-8 py-2 md:py-3 text-gray-700 text-sm md:text-base rounded-lg md:rounded-xl bg-white hover:bg-gray-50 border border-gray-300 transition-all">
          <span class="material-icons text-lg md:text-xl">arrow_back</span>
          Back to Options
        </button>
      </div>

      <!-- Step 3: Criteria-based Search (hidden by default) -->
      <div id="therapist-step-3-criteria" class="hidden">
        <div class="text-center mb-3">
        </div>
        
        <!-- Filters Section (replaces map) -->
        <div class="rounded-2xl bg-white border border-gray-100 p-6 mb-6 shadow-sm">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gray-50 rounded-lg flex items-center justify-center">
                <span class="material-icons text-gray-600 text-xl">tune</span>
              </div>
              <h3 class="text-xl font-medium text-gray-900" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Filter Therapists</h3>
            </div>
          </div>
          
          <!-- Mobile-First Filter Layout -->
          <div id="filters-container">
            <!-- Always Visible Filters (Mobile + Desktop) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <!-- Service Filter -->
              <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                <div class="flex items-center gap-2 mb-3">
                  <div class="w-5 h-5 flex items-center justify-center">
                    <img src="https://img.icons8.com/?size=100&id=cdQsUhm1JUus&format=png&color=666666" alt="Service" class="w-5 h-5 opacity-70">
                  </div>
                  <label class="text-sm font-medium text-gray-700" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Service</label>
                </div>
                <select id="service-filter" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400 transition-all bg-white text-gray-700 text-sm" onchange="window.resetCriteriaPageAndFilter()">
                  <option value="">All Services</option>
                  <option value="in_person_therapy">In-Person Therapy</option>
                  <option value="online_therapy">Online Therapy</option>
                  <option value="psychometric_mmpi2">Psychometric Evaluation MMPI-2</option>
                  <option value="psychometric_wisc">Psychometric Evaluation WISC</option>
                  <option value="psychometric_wais">Psychometric Evaluation WAIS</option>
                  <option value="teen_counseling">Teen Counseling</option>
                  <option value="parents_counseling">Parents Counseling</option>
                  <option value="couples_therapy">Couples Therapy</option>
                </select>
              </div>
              
              <!-- City Filter -->
              <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                <div class="flex items-center gap-2 mb-3">
                  <div class="w-5 h-5 flex items-center justify-center">
                    <img src="https://img.icons8.com/?size=100&id=XsvEZR0h6fav&format=png&color=666666" alt="City" class="w-5 h-5 opacity-70">
                  </div>
                  <label class="text-sm font-medium text-gray-700" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">City</label>
                </div>
                <select id="city-filter" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400 transition-all bg-white text-gray-700 text-sm" onchange="window.resetCriteriaPageAndFilter()">
                  <option value="">All Cities</option>
                  <!-- Dynamic options will be populated by JavaScript -->
                </select>
              </div>
            </div>
            
            <!-- More Filters Button (Mobile Only) -->
            <div class="md:hidden mb-4">
              <button id="more-filters-btn" onclick="toggleMoreFilters()" class="w-full bg-white rounded-xl p-4 shadow-sm border border-white/50 flex items-center justify-between hover:bg-gray-50 transition-colors">
                <div class="flex items-center gap-2">
                  <div class="w-5 h-5 flex items-center justify-center">
                    <img src="https://img.icons8.com/?size=100&id=cLD2wO8b2ptf&format=png&color=2563eb" alt="More Filters" class="w-5 h-5 opacity-70">
                  </div>
                  <span class="text-sm font-medium text-gray-700">More Filters</span>
                </div>
                <span id="more-filters-icon" class="material-icons text-gray-500 transition-transform">expand_more</span>
              </button>
            </div>
            
            <!-- Additional Filters (Hidden on Mobile, Always Visible on Desktop) -->
            <div id="additional-filters" class="hidden md:block">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Title Filter -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-white/50">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="w-5 h-5 flex items-center justify-center">
                      <img src="https://img.icons8.com/?size=100&id=m0c1h1XS3gNM&format=png&color=2563eb" alt="Title" class="w-5 h-5 opacity-70">
                    </div>
                    <label class="text-sm font-medium text-gray-700">Title</label>
                  </div>
                  <select id="title-filter" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-gray-700" onchange="window.resetCriteriaPageAndFilter()">
                    <option value="">All Titles</option>
                    <!-- Fallback options (will be replaced by dynamic ones) -->
                    <option value="Psychologist">Psychologist</option>
                    <option value="Child Psychologist">Child Psychologist</option>
                    <option value="Psychiatrist">Psychiatrist</option>
                    <option value="Child Psychiatrist">Child Psychiatrist</option>
                  </select>
                </div>
                
                <!-- Languages Filter -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-white/50">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="w-5 h-5 flex items-center justify-center">
                      <img src="https://img.icons8.com/?size=100&id=10lwQw8Al1lP&format=png&color=2563eb" alt="Language" class="w-5 h-5 opacity-70">
                    </div>
                    <label class="text-sm font-medium text-gray-700">Languages</label>
                  </div>
                  <select id="language-filter" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-gray-700" onchange="window.resetCriteriaPageAndFilter()">
                    <option value="">All Languages</option>
                    <!-- Fallback options (enhanced by dynamic system) -->
                    <option value="greek">Greek</option>
                    <option value="english">English</option>
                    <option value="french">French</option>
                    <option value="german">German</option>
                    <option value="italian">Italian</option>
                    <option value="spanish">Spanish</option>
                    <option value="danish">Danish</option>
                  </select>
                </div>
                
                <!-- Therapy Approach Filter -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-white/50">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="w-5 h-5 flex items-center justify-center">
                      <img src="https://img.icons8.com/?size=100&id=MEQHrqPxipjD&format=png&color=2563eb" alt="Therapy Approach" class="w-5 h-5 opacity-70">
                    </div>
                    <label class="text-sm font-medium text-gray-700">Therapy Approach</label>
                  </div>
                  <select id="therapy-approach-filter" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-gray-700" onchange="window.resetCriteriaPageAndFilter()">
                    <option value="">All Approaches</option>
                    <!-- Fallback options (will be enhanced by dynamic ones) -->
                    <option value="cbt">Cognitive Behavioral Therapy (CBT)</option>
                    <option value="psychodynamic">Psychodynamic Therapy</option>
                    <option value="psychoanalysis">Psychoanalysis</option>
                    <option value="humanistic">Humanistic Therapy</option>
                    <option value="family">Family Therapy</option>
                    <option value="gestalt">Gestalt Therapy</option>
                    <option value="emdr">EMDR</option>
                  </select>
                </div>
                
                <!-- Gender Filter -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-white/50">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="w-5 h-5 flex items-center justify-center">
                      <img src="https://img.icons8.com/?size=100&id=ZSjYyi88LXpt&format=png&color=2563eb" alt="Gender" class="w-5 h-5 opacity-70">
                    </div>
                    <label class="text-sm font-medium text-gray-700">Gender</label>
                  </div>
                  <select id="gender-filter" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-gray-700" onchange="window.resetCriteriaPageAndFilter()">
                    <option value="">All Genders</option>
                    <!-- Fallback options (will be replaced by dynamic ones) -->
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-8 pt-6 border-t border-blue-200">
            <div class="flex items-center gap-2">
              <span class="material-icons text-white text-lg">search</span>
              <div id="criteria-results-count" class="text-sm font-medium text-white">Loading therapists...</div>
            </div>
            <button id="clear-filters-btn" onclick="window.clearAllFilters()" class="text-black py-3 px-6 rounded-full text-sm font-medium flex items-center gap-2 shadow-md" style="background-color: white; transition: all 0.2s ease;">
              <span class="material-icons text-sm text-black">refresh</span>
              Clear All Filters
            </button>
          </div>
        </div>
        
        <script>
          // Add hover effect to Clear Filters button
          document.addEventListener('DOMContentLoaded', function() {
            const clearBtn = document.getElementById('clear-filters-btn');
            if (clearBtn) {
              // Hover effect
              clearBtn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-4px) scale(1.05)';
                this.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)';
              });
              
              // Remove hover effect
              clearBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
                this.style.boxShadow = '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)';
              });
              
              // Active/click effect
              clearBtn.addEventListener('mousedown', function() {
                this.style.transform = 'translateY(0) scale(1)';
              });
              
              // Return to hover state after click if still hovering
              clearBtn.addEventListener('mouseup', function() {
                if (this.matches(':hover')) {
                  this.style.transform = 'translateY(-4px) scale(1.05)';
                }
              });
            }
            
            // Fix only specific therapist select buttons
            function fixTherapistSelectButtons() {
              console.log('üé® Fixing therapist select buttons...');
              
              let fixedButtons = 0;
              
              // Find all buttons and check for specific select buttons
              const allButtons = document.querySelectorAll('button');
              allButtons.forEach(button => {
                const buttonText = button.textContent.trim();
                
                // Target "Select" buttons in therapist cards
                if (buttonText === 'Select') {
                  button.style.setProperty('background', '#446081', 'important');
                  button.style.setProperty('color', 'white', 'important');
                  button.style.setProperty('border', 'none', 'important');
                  fixedButtons++;
                  console.log('‚úÖ Fixed Select button');
                }
                
                // Target "Select Therapist" buttons in profile popup
                if (buttonText === 'Select Therapist') {
                  button.style.setProperty('background', '#446081', 'important');
                  button.style.setProperty('color', 'white', 'important');
                  button.style.setProperty('border', 'none', 'important');
                  button.style.setProperty('background-image', 'none', 'important');
                  // Remove any conflicting gradient classes
                  button.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-800', 'bg-blue-500', 'hover:bg-blue-600');
                  fixedButtons++;
                  console.log('‚úÖ Fixed Select Therapist button in popup');
                }
              });
              
              // Also specifically target popup buttons by context
              const popupButtons = document.querySelectorAll('.fixed button, [class*="popup"] button, [class*="modal"] button');
              popupButtons.forEach(button => {
                if (button.textContent.trim() === 'Select Therapist') {
                  button.style.setProperty('background', '#446081', 'important');
                  button.style.setProperty('color', 'white', 'important');
                  button.style.setProperty('border', 'none', 'important');
                  button.style.setProperty('background-image', 'none', 'important');
                  button.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-800', 'bg-blue-500', 'hover:bg-blue-600');
                  fixedButtons++;
                  console.log('‚úÖ Fixed Select Therapist button in popup context');
                }
              });
              
              console.log(`üé® Fixed ${fixedButtons} select buttons total`);
            }
            
            // Run immediately and also after a delay to catch dynamically loaded content
            fixTherapistSelectButtons();
            setTimeout(fixTherapistSelectButtons, 1000);
            setTimeout(fixTherapistSelectButtons, 3000);
            setTimeout(fixTherapistSelectButtons, 5000);
            
            // Ultra-aggressive continuous monitoring specifically for popup buttons
            setInterval(function() {
              // Target all buttons and check text content
              document.querySelectorAll('button').forEach(button => {
                const text = button.textContent.trim();
                if (text === 'Select' || text === 'Select Therapist') {
                  // Force the #446081 color with maximum priority and remove conflicting styles
                  button.style.cssText = 'background: #446081 !important; color: white !important; border: none !important; background-image: none !important; font-family: system-ui, -apple-system, BlinkMacSystemFont !important;';
                  // Remove conflicting classes immediately
                  button.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-800', 'bg-blue-500', 'hover:bg-blue-600', 'from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
                  console.log('üîß Forced Apple styling on button:', text);
                }
              });
              
              // Remove unwanted instructions from booking details
              const bookingDetails = document.getElementById('booking-completion-details');
              const serviceDetails = document.getElementById('service-location-details');
              
              [bookingDetails, serviceDetails].forEach(container => {
                if (container && container.innerHTML) {
                  let content = container.innerHTML;
                  // Remove specific unwanted instructions
                  content = content.replace(/‚Ä¢\s*Arrive\s+5-10\s+minutes\s+early/gi, '');
                  content = content.replace(/‚Ä¢\s*Bring\s+valid\s+ID\s+if\s+required/gi, '');
                  content = content.replace(/‚Ä¢\s*Parking\s+details\s+in\s+confirmation\s+email/gi, '');
                  // Remove empty bullet points or list items
                  content = content.replace(/<li>\s*<\/li>/gi, '');
                  content = content.replace(/‚Ä¢\s*$/gm, '');
                  // Clean up extra whitespace
                  content = content.replace(/\n\s*\n/g, '\n');
                  
                  if (content !== container.innerHTML) {
                    container.innerHTML = content;
                    console.log('üßπ Removed unwanted instructions from booking details');
                  }
                }
              });
            }, 1000); // Check every 1000ms (reduced frequency since we fixed root causes)
            
            // Also run when therapist cards are updated
            const observer = new MutationObserver(function(mutations) {
              mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                  // Immediate fix for new cards
                  fixTherapistSelectButtons();
                  // Also run after a short delay to catch any late styling
                  setTimeout(fixTherapistSelectButtons, 50);
                  setTimeout(fixTherapistSelectButtons, 200);
                }
              });
            });
            
            // Observe both therapist containers
            const locationContainer = document.getElementById('therapist-cards-container');
            const criteriaContainer = document.getElementById('criteria-therapist-cards-container');
            
            if (locationContainer) {
              observer.observe(locationContainer, { childList: true, subtree: true });
            }
            if (criteriaContainer) {
              observer.observe(criteriaContainer, { childList: true, subtree: true });
            }
          });

          // Toggle More Filters function for mobile
          function toggleMoreFilters() {
            const additionalFilters = document.getElementById('additional-filters');
            const moreFiltersIcon = document.getElementById('more-filters-icon');
            const moreFiltersBtn = document.getElementById('more-filters-btn');
            
            if (additionalFilters.classList.contains('hidden')) {
              // Show additional filters
              additionalFilters.classList.remove('hidden');
              additionalFilters.classList.add('block');
              moreFiltersIcon.textContent = 'expand_less';
              moreFiltersBtn.querySelector('span:last-child').textContent = 'Less Filters';
            } else {
              // Hide additional filters
              additionalFilters.classList.add('hidden');
              additionalFilters.classList.remove('block');
              moreFiltersIcon.textContent = 'expand_more';
              moreFiltersBtn.querySelector('span:last-child').textContent = 'More Filters';
            }
          }
        </script>
        
        <!-- Therapist Cards with Pagination (same as location step) -->
        <div class="mb-8 rounded-2xl bg-white border border-gray-100 p-6 shadow-sm">
          <div class="flex justify-between items-center mb-6">
            <h4 class="text-xl font-medium text-gray-900" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Available Therapists</h4>
          </div>
          <div id="criteria-therapist-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Cards will be populated by JavaScript with filter functionality -->
          </div>
        </div>

        <button onclick="
          document.getElementById('therapist-step-3-criteria').style.display = 'none';
          document.getElementById('therapist-step-3-criteria').classList.add('hidden');
          document.getElementById('therapist-step-2').style.display = 'block';
          document.getElementById('therapist-step-2').classList.remove('hidden');
          document.getElementById('therapist-step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('‚úÖ Back to Options - Criteria hidden, Step 2 shown');
          return false;
        " class="flex items-center gap-1 md:gap-2 px-4 md:px-8 py-2 md:py-3 text-gray-700 text-sm md:text-base rounded-lg md:rounded-xl bg-white hover:bg-gray-50 border border-gray-300 transition-all">
          <span class="material-icons text-lg md:text-xl">arrow_back</span>
          Back to Options
        </button>
      </div>

      <!-- Step 3: Quiz-based Search (hidden by default) -->
      <div id="therapist-step-3-quiz" class="hidden p-4 md:p-8">
        <div class="text-center mb-8">
          <h2 class="text-2xl font-medium text-gray-900 mb-3" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Find Your Perfect Match</h2>
          <p class="text-gray-600">Answer a few questions to find therapists best suited for you</p>
        </div>
        
        <!-- Quiz Progress -->
        <div id="quiz-progress-container" class="mb-8 max-w-2xl mx-auto">
          <div class="flex justify-between items-center mb-3">
            <span class="text-sm font-medium text-gray-600" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Progress</span>
            <span id="quiz-progress-text" class="text-sm font-medium text-gray-600">Question 1 of 5</span>
          </div>
          <div class="w-full bg-gray-100 rounded-full h-2">
            <div id="quiz-progress-bar" class="bg-gray-400 h-2 rounded-full transition-all duration-300" style="width: 20%"></div>
          </div>
        </div>
        
        <!-- Quiz Questions Container -->
        <div id="quiz-question-container" class="mb-8">
          <!-- Default quiz question will show immediately -->
          <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-8 max-w-2xl mx-auto">
            <h3 class="text-xl font-medium text-gray-900 mb-6 text-center" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">In which language would you like your therapist to communicate?</h3>
            <div class="space-y-3">
              <button onclick="selectQuizLanguage('greek')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">
                <span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Greek</span>
              </button>
              <button onclick="selectQuizLanguage('english')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">
                <span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">English</span>
              </button>
              <button onclick="selectQuizLanguage('french')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">
                <span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">French</span>
              </button>
              <button onclick="selectQuizLanguage('german')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">
                <span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">German</span>
              </button>
              <button onclick="selectQuizLanguage('italian')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">
                <span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">Italian</span>
              </button>
            </div>
          </div>
        </div>
        
        <script>
        // Simple embedded quiz system
        window.simpleQuizAnswers = {};
        window.simpleQuizStep = 0;
        
        function selectQuizLanguage(language) {
          console.log('üåê Selected language:', language);
          window.simpleQuizAnswers.language = language;
          showAgeGroupQuestion();
        }
        
        function showAgeGroupQuestion() {
          const container = document.getElementById('quiz-question-container');
          container.innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-2xl mx-auto">
              <h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Is this therapy for a child or an adult?</h3>
              <div class="space-y-3">
                <button onclick="selectQuizAgeGroup('child')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Child (under 18)</span>
                </button>
                <button onclick="selectQuizAgeGroup('adult')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Adult (18+)</span>
                </button>
              </div>
            </div>
          `;
          updateQuizProgress(2, 6);
        }
        
        function selectQuizAgeGroup(ageGroup) {
          console.log('üë∂ Selected age group:', ageGroup);
          window.simpleQuizAnswers.ageGroup = ageGroup;
          showServiceQuestion(ageGroup);
        }
        
        function showServiceQuestion(ageGroup) {
          const services = ageGroup === 'child' ? [
            { value: 'in_person_therapy', text: 'In-Person Therapy' },
            { value: 'online_therapy', text: 'Online Therapy' },
            { value: 'psychometric_wisc', text: 'Psychometric Evaluation WISC' },
            { value: 'teen_counseling', text: 'Teen Counseling' },
            { value: 'parents_counseling', text: 'Parents Counseling' }
          ] : [
            { value: 'in_person_therapy', text: 'In-Person Therapy' },
            { value: 'online_therapy', text: 'Online Therapy' },
            { value: 'psychometric_wais', text: 'Psychometric Evaluation WAIS' },
            { value: 'psychometric_mmpi2', text: 'Psychometric Evaluation MMPI2' },
            { value: 'couples_therapy', text: 'Couples Therapy' },
            { value: 'parents_counseling', text: 'Parents Counseling' }
          ];
          
          const container = document.getElementById('quiz-question-container');
          container.innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-2xl mx-auto">
              <h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Which type of service are you looking for?</h3>
              <div class="space-y-3">
                ${services.map(service => `
                  <button onclick="selectQuizService('${service.value}')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                    <span class="font-medium text-gray-800">${service.text}</span>
                  </button>
                `).join('')}
              </div>
            </div>
          `;
          updateQuizProgress(3, 6);
        }
        
        function selectQuizService(service) {
          console.log('üè• Selected service:', service);
          window.simpleQuizAnswers.service = service;
          
          if (service === 'online_therapy') {
            showAvailabilityQuestion();
          } else {
            showLocationQuestion();
          }
        }
        
        function showLocationQuestion() {
          const container = document.getElementById('quiz-question-container');
          container.innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-2xl mx-auto">
              <h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">To find therapists near you, we need access to your location. Is that okay?</h3>
              <div class="space-y-3">
                <button onclick="selectQuizLocation('allow')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Allow location access</span>
                </button>
                <button onclick="selectQuizLocation('deny')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Skip location</span>
                </button>
              </div>
            </div>
          `;
          updateQuizProgress(4, 6);
        }
        
                 function selectQuizLocation(location) {
           console.log('üìç Selected location:', location);
           window.simpleQuizAnswers.location = location;
           
           if (location === 'allow') {
             // Request geolocation
             if (navigator.geolocation) {
               console.log('üåç Requesting geolocation...');
               navigator.geolocation.getCurrentPosition(
                 function(position) {
                   window.simpleQuizAnswers.coordinates = {
                     lat: position.coords.latitude,
                     lng: position.coords.longitude
                   };
                   console.log('‚úÖ Location obtained:', window.simpleQuizAnswers.coordinates);
                   proceedAfterLocation();
                 },
                 function(error) {
                   console.warn('‚ö†Ô∏è Geolocation error:', error.message);
                   // Use Athens as fallback
                   window.simpleQuizAnswers.coordinates = { lat: 37.9838, lng: 23.7275 };
                   console.log('üìç Using Athens fallback location');
                   proceedAfterLocation();
                 },
                 {
                   enableHighAccuracy: true,
                   timeout: 10000,
                   maximumAge: 0
                 }
               );
             } else {
               console.error('‚ùå Geolocation not supported');
               window.simpleQuizAnswers.coordinates = { lat: 37.9838, lng: 23.7275 };
               proceedAfterLocation();
             }
           } else {
             proceedAfterLocation();
           }
           
           function proceedAfterLocation() {
             if (window.simpleQuizAnswers.service && window.simpleQuizAnswers.service.includes('psychometric')) {
               showAvailabilityQuestion();
             } else {
               showApproachQuestion();
             }
           }
         }
        
        function showApproachQuestion() {
          const container = document.getElementById('quiz-question-container');
          container.innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-2xl mx-auto">
              <h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Do you have any particular therapeutic approach preference?</h3>
              <div class="space-y-3">
                <button onclick="selectQuizApproach('no_preference')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">No Preference</span>
                </button>
                <button onclick="selectQuizApproach('cbt')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Cognitive Behavioral Therapy (CBT)</span>
                </button>
                <button onclick="selectQuizApproach('psychodynamic')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Psychodynamic Therapy</span>
                </button>
                <button onclick="selectQuizApproach('humanistic')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Humanistic Therapy</span>
                </button>
              </div>
            </div>
          `;
          updateQuizProgress(5, 6);
        }
        
        function selectQuizApproach(approach) {
          console.log('üß† Selected approach:', approach);
          window.simpleQuizAnswers.approach = approach;
          showAvailabilityQuestion();
        }
        
        function showAvailabilityQuestion() {
          const container = document.getElementById('quiz-question-container');
          container.innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-2xl mx-auto">
              <h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">What is your preferred time for sessions?</h3>
              <div class="space-y-3">
                <button onclick="selectQuizAvailability('morning')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Morning (8AM - 12PM)</span>
                </button>
                <button onclick="selectQuizAvailability('afternoon')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Afternoon (2PM - 5PM)</span>
                </button>
                <button onclick="selectQuizAvailability('evening')" class="w-full p-4 text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg transition-all duration-200 hover:shadow-md">
                  <span class="font-medium text-gray-800">Evening (5PM - 8PM)</span>
                </button>
              </div>
            </div>
          `;
          updateQuizProgress(6, 6);
        }
        
        function selectQuizAvailability(availability) {
          console.log('‚è∞ Selected availability:', availability);
          window.simpleQuizAnswers.availability = availability;
          showQuizResults();
        }
        
        // Remove custom profile function - use the standard viewTherapistProfile function
        
        // Use the global selectTherapist function defined elsewhere

        function showQuizResults() {
          console.log('üéØ Quiz completed! Answers:', window.simpleQuizAnswers);
          
          if (!window.therapistData || window.therapistData.length === 0) {
            console.error('‚ùå No therapist data available');
            return;
          }
          
                     // Comprehensive matching algorithm
           const scoredTherapists = window.therapistData.map(therapist => {
             let score = 0;
             let maxScore = 0;
             
             // 1. Language matching (highest priority - 25 points)
             maxScore += 25;
             if (therapist.languageKeys && therapist.languageKeys.includes(window.simpleQuizAnswers.language)) {
               score += 25;
             }
             
             // 2. Age group matching (high priority - 20 points)
             maxScore += 20;
             const isChildTherapist = therapist.title && therapist.title.toLowerCase().includes('child');
             const needsChildTherapist = window.simpleQuizAnswers.ageGroup === 'child';
             if (isChildTherapist === needsChildTherapist) {
               score += 20;
             }
             
             // 3. Service matching (very important - 20 points)
             maxScore += 20;
             if (therapist.services && window.simpleQuizAnswers.service) {
               const service = therapist.services[window.simpleQuizAnswers.service];
               if (service === true || (typeof service === 'object' && service.available)) {
                 score += 20;
               }
             }
             
             // 4. Therapeutic approach matching (medium priority - 15 points)
             if (window.simpleQuizAnswers.approach && window.simpleQuizAnswers.approach !== 'no_preference') {
               maxScore += 15;
               if (therapist.therapy_approaches_keys) {
                 const hasApproach = therapist.therapy_approaches_keys.some(key => 
                   key.toLowerCase().includes(window.simpleQuizAnswers.approach) || 
                   window.simpleQuizAnswers.approach.includes(key.toLowerCase())
                 );
                 if (hasApproach) {
                   score += 15;
                 }
               }
             }
             
             // 5. Availability matching (lower priority - 10 points)
             if (window.simpleQuizAnswers.availability) {
               maxScore += 10;
               if (therapist.availabilityKey && therapist.availabilityKey.toLowerCase() === window.simpleQuizAnswers.availability) {
                 score += 10;
               }
             }
             
             // 6. Location proximity bonus (if location provided - 10 points)
             if (window.simpleQuizAnswers.coordinates && therapist.distance !== undefined) {
               maxScore += 10;
               if (therapist.distance <= 5) {
                 score += 10; // Within 5km
               } else if (therapist.distance <= 10) {
                 score += 5; // Within 10km
               }
             }
             
             const matchPercentage = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;
             
             return {
               ...therapist,
               matchScore: score,
               maxScore: maxScore,
               matchPercentage: matchPercentage
             };
           });
           
           // Sort by match score and filter out very low matches
           const matches = scoredTherapists
             .filter(therapist => therapist.matchPercentage >= 30) // Only show decent matches
             .sort((a, b) => b.matchScore - a.matchScore)
             .slice(0, 6);
          
          const container = document.getElementById('quiz-question-container');
          container.innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-6xl mx-auto">
              <div class="text-center mb-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-4">Your Perfect Matches</h3>
                <p class="text-lg text-gray-600">Found ${matches.length} therapists matching your preferences:</p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${matches.map(therapist => `
                  <div class="bg-white rounded-2xl p-5 hover:shadow-lg transition-all duration-300 h-full" style="border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);">
                    <div class="h-full flex flex-col">
                      <!-- Therapist Image -->
                      <div class="mb-4">
                        <img src="${therapist.image || therapist.photo || 'User Panel Media/therapist1.png'}" 
                             alt="Dr. ${therapist.first_name} ${therapist.last_name}" 
                             class="w-20 h-20 rounded-2xl mx-auto object-cover shadow-sm"
                             style="border: 1px solid rgba(0, 0, 0, 0.08);">
                      </div>
                      
                      <!-- Therapist Info -->
                      <div class="flex-1 text-center px-2">
                        <h3 class="font-semibold text-base mb-1" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
                          Dr. ${therapist.first_name} ${therapist.last_name}
                        </h3>
                        <p class="text-sm font-medium mb-2" style="color: #446081;">
                          ${therapist.title}
                        </p>
                        <p class="text-xs mb-3" style="color: #86868b; line-height: 1.4;">
                          ${therapist.therapy_approaches ? therapist.therapy_approaches[0] : 'General Therapy'}
                        </p>
                        
                        <!-- Location & Distance -->
                        <div class="space-y-1 mb-4">
                          <p class="text-xs" style="color: #86868b;">
                            <span style="color: #1d1d1f; font-weight: 500;">${(therapist.distance || 0).toFixed(1)} km</span> ‚Ä¢ ${therapist.area || 'Athens'}
                          </p>
                          ${therapist.cost ? `
                            <p class="text-xs" style="color: #86868b;">
                              ‚Ç¨<span style="color: #1d1d1f; font-weight: 500;">${therapist.cost}</span>/session
                            </p>
                          ` : ''}
                        </div>
                      </div>
                      
                      <!-- Action Buttons -->
                      <div class="mt-auto pt-2">
                        <button onclick="viewTherapistProfile(${therapist.id})" 
                                class="w-full py-2 mb-2 rounded-xl font-medium text-sm transition-all duration-200"
                                style="background-color: #f5f5f7; color: #446081; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                          View Profile
                        </button>
                        <button onclick="window.navigateToBookingStep(${JSON.stringify(therapist).replace(/"/g, '&quot;')})" 
                                class="w-full py-2 rounded-xl font-medium text-sm transition-all duration-200"
                                style="background-color: #446081; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                          Select Therapist
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          
          updateQuizProgress(6, 6);
        }
        
        function updateQuizProgress(current, total) {
          const progressBar = document.getElementById('quiz-progress-bar');
          const progressText = document.getElementById('quiz-progress-text');
          
          if (progressBar) {
            const progress = (current / total) * 100;
            progressBar.style.width = progress + '%';
          }
          
          if (progressText) {
            progressText.textContent = `Question ${current} of ${total}`;
          }
        }
        
        // Function to reset quiz and go back to options
        function resetQuizAndGoBack() {
          // Reset both quiz systems for fresh start
          window.simpleQuizAnswers = {};
          window.simpleQuizStep = 0;
          window.quizAnswers = {};
          window.currentQuizQuestion = 0;
          window.quizUserLocation = null;
          
          // Reset quiz container to first question
          const quizContainer = document.getElementById('quiz-question-container');
          if (quizContainer) {
            quizContainer.innerHTML = 
              '<div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-8 max-w-2xl mx-auto">' +
                '<h3 class="text-xl font-medium text-gray-900 mb-6 text-center" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif;">In which language would you like your therapist to communicate?</h3>' +
                '<div class="space-y-3">' +
                  '<button onclick="selectQuizLanguage(\'greek\')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">' +
                    '<span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif;">Greek</span>' +
                  '</button>' +
                  '<button onclick="selectQuizLanguage(\'english\')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">' +
                    '<span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif;">English</span>' +
                  '</button>' +
                  '<button onclick="selectQuizLanguage(\'french\')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">' +
                    '<span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif;">French</span>' +
                  '</button>' +
                  '<button onclick="selectQuizLanguage(\'german\')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">' +
                    '<span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif;">German</span>' +
                  '</button>' +
                  '<button onclick="selectQuizLanguage(\'italian\')" class="w-full p-4 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-xl transition-all duration-200 hover:scale-[1.01] active:scale-[0.99]">' +
                    '<span class="font-medium text-gray-800" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif;">Italian</span>' +
                  '</button>' +
                '</div>' +
              '</div>';
          }
          
          // Reset quiz progress display to initial state
          const progressContainer = document.getElementById('quiz-progress-container');
          if (progressContainer) {
            progressContainer.classList.remove('hidden');
          }
          
          // Reset progress bar and text to question 1
          if (typeof updateQuizProgress === 'function') {
            updateQuizProgress(1, 6);
          } else {
            const progressBar = document.getElementById('quiz-progress-bar');
            const progressText = document.getElementById('quiz-progress-text');
            if (progressBar) progressBar.style.width = '16.67%';
            if (progressText) progressText.textContent = 'Question 1 of 6';
          }
          
          console.log('üîÑ Quiz data and progress completely reset for fresh start');
          
          // Navigate back to step 2 (selection options)
          document.getElementById('therapist-step-3-quiz').style.display = 'none';
          document.getElementById('therapist-step-3-quiz').classList.add('hidden');
          document.getElementById('therapist-step-2').style.display = 'block';
          document.getElementById('therapist-step-2').classList.remove('hidden');
          document.getElementById('therapist-step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('‚úÖ Back to Options - Quiz fully reset and Step 2 shown fresh');
          return false;
        }
        </script>
        
        <button onclick="resetQuizAndGoBack()" class="flex items-center gap-1 md:gap-2 px-4 md:px-8 py-2 md:py-3 text-gray-700 text-sm md:text-base rounded-lg md:rounded-xl bg-white hover:bg-gray-50 border border-gray-300 transition-all">
          <span class="material-icons text-lg md:text-xl">arrow_back</span>
          Back to Options
        </button>
      </div>

      <!-- Step 4: Appointment Booking (hidden by default) -->
      <div id="therapist-step-booking" class="hidden">
        <div class="text-center mb-3">
          <button onclick="window.goBackFromBooking()" class="flex items-center gap-1 md:gap-2 px-4 md:px-8 py-2 md:py-3 text-gray-700 text-sm md:text-base rounded-lg md:rounded-xl bg-white hover:bg-gray-50 border border-gray-300 transition-all mb-4">
            <span class="material-icons text-lg md:text-xl">arrow_back</span>
            Back to Therapists
          </button>
        </div>

        <!-- Therapist Info Header -->
        <div id="booking-therapist-info" class="bg-white/95 backdrop-blur-sm rounded-3xl shadow-sm p-6 md:p-8 mb-6 border border-gray-200/60 hover:shadow-md transition-all duration-300" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);">
          <!-- Therapist details will be populated by JavaScript -->
        </div>

        <!-- Service Selection -->
        <div id="service-selection-section" class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
          <div class="flex items-center gap-3 mb-4">
            <img src="https://img.icons8.com/?size=100&id=cdQsUhm1JUus&format=png&color=2563eb" alt="Choose Service" class="w-8 h-8">
            <h3 class="text-base md:text-lg font-semibold text-gray-800">Choose Service</h3>
          </div>
          <p class="text-sm text-gray-600 mb-4">Select the type of service you need</p>
          
          <div id="booking-services-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <!-- Service options will be populated by JavaScript based on therapist's offerings -->
          </div>
        </div>

        <!-- Service Important Notes -->
        <div id="service-notes-section" class="hidden bg-amber-50 rounded-2xl shadow-lg p-6 mb-6 border border-amber-200">
          <div class="flex items-center gap-3 mb-4">
            <img src="https://img.icons8.com/?size=100&id=PeGBhRJEYb2R&format=png&color=000000" alt="Important" class="w-8 h-8">
            <h3 class="text-base md:text-lg font-semibold text-amber-800">Important Information</h3>
          </div>
          <div id="service-notes-content" class="text-sm text-amber-700">
            <!-- Service-specific notes will be populated by JavaScript -->
          </div>
        </div>

        <!-- Quick Appointments Section -->
        <div id="quick-appointments-section" class="hidden bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-lg p-6 mb-6 border border-blue-100">
          <div class="flex items-center gap-3 mb-4">
            <img src="https://img.icons8.com/?size=100&id=89mMekprYMUs&format=png&color=2563eb" alt="Quick Booking" class="w-8 h-8">
            <h3 class="text-base md:text-lg font-semibold text-gray-800">Quick Booking</h3>
          </div>
          <p class="text-sm text-gray-600 mb-4">Select from the next available appointments</p>
          
          <div id="quick-appointments-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Quick appointment slots will be populated by JavaScript -->
          </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendar-section" class="hidden bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
          <!-- Mobile: Title Above Navigation -->
          <div class="md:hidden flex items-center gap-3 mb-4">
            <img src="https://img.icons8.com/?size=100&id=vf5h7oJLZ9Wd&format=png&color=2563eb" alt="Choose Date & Time" class="w-8 h-8">
            <h3 class="text-base font-semibold text-gray-800">Choose Your Date & Time</h3>
          </div>
          
          <!-- Mobile: Month Navigation Centered -->
          <div class="md:hidden flex items-center justify-center gap-2 mb-6">
            <button id="calendar-prev-month-mobile" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
              <span class="material-icons text-gray-600">chevron_left</span>
            </button>
            <span id="calendar-month-year-mobile" class="text-sm font-medium text-gray-700 px-3">January 2024</span>
            <button id="calendar-next-month-mobile" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
              <span class="material-icons text-gray-600">chevron_right</span>
            </button>
          </div>
          
          <!-- Desktop: Original Layout -->
          <div class="hidden md:flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <img src="https://img.icons8.com/?size=100&id=vf5h7oJLZ9Wd&format=png&color=2563eb" alt="Choose Date & Time" class="w-8 h-8">
              <h3 class="text-lg font-semibold text-gray-800">Choose Your Date & Time</h3>
            </div>
            <div class="flex items-center gap-2">
              <button id="calendar-prev-month" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                <span class="material-icons text-gray-600">chevron_left</span>
              </button>
              <span id="calendar-month-year" class="text-sm font-medium text-gray-700 px-3">January 2024</span>
              <button id="calendar-next-month" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                <span class="material-icons text-gray-600">chevron_right</span>
              </button>
            </div>
          </div>

          <!-- Calendar Grid -->
          <div class="grid grid-cols-7 gap-1 mb-4">
            <div class="text-center text-xs font-medium text-gray-500 py-2">Sun</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Mon</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Tue</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Wed</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Thu</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Fri</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Sat</div>
          </div>
          
          <div id="calendar-days-container" class="grid grid-cols-7 gap-1 mb-6">
            <!-- Calendar days will be populated by JavaScript -->
          </div>

          <!-- Time Slots for Selected Date -->
          <div id="time-slots-container" class="hidden">
            <div class="border-t border-gray-200 pt-6">
              <h4 class="text-md font-semibold text-gray-800 mb-4">Available Times for <span id="selected-date-display"></span></h4>
              
              <!-- Time periods -->
              <div class="space-y-4">
                <div id="morning-slots" class="hidden">
                  <h5 class="text-sm font-medium text-gray-600 mb-2 flex items-center gap-2">
                    <span class="material-icons text-sm text-orange-500">wb_sunny</span>
                    Morning (7:00 - 11:59)
                  </h5>
                  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2" data-period="morning">
                    <!-- Morning time slots -->
                  </div>
                </div>
                
                <div id="noon-slots" class="hidden">
                  <h5 class="text-sm font-medium text-gray-600 mb-2 flex items-center gap-2">
                    <span class="material-icons text-sm text-yellow-500">light_mode</span>
                    Noon (12:00 - 13:59)
                  </h5>
                  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2" data-period="noon">
                    <!-- Noon time slots -->
                  </div>
                </div>
                
                <div id="afternoon-slots" class="hidden">
                  <h5 class="text-sm font-medium text-gray-600 mb-2 flex items-center gap-2">
                    <span class="material-icons text-sm text-blue-500">wb_cloudy</span>
                    Afternoon (14:00 - 17:59)
                  </h5>
                  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2" data-period="afternoon">
                    <!-- Afternoon time slots -->
                  </div>
                </div>
                
                <div id="evening-slots" class="hidden">
                  <h5 class="text-sm font-medium text-gray-600 mb-2 flex items-center gap-2">
                    <span class="material-icons text-sm text-purple-500">nights_stay</span>
                    Evening (18:00 - 21:59)
                  </h5>
                  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2" data-period="evening">
                    <!-- Evening time slots -->
                  </div>
                </div>
                
                <div id="night-slots" class="hidden">
                  <h5 class="text-sm font-medium text-gray-600 mb-2 flex items-center gap-2">
                    <span class="material-icons text-sm text-indigo-500">bedtime</span>
                    Night (22:00 - 23:00)
                  </h5>
                  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2" data-period="night">
                    <!-- Night time slots -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Selected Appointment Summary -->
        <div id="appointment-summary" class="hidden">
          <!-- Modern Minimal Header -->
          <div class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-sm border border-gray-100/50 p-8 mb-6">
            <div class="text-center mb-8">
              <h3 class="text-xl font-semibold text-gray-900 mb-2" style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif; letter-spacing: -0.02em;">Ready to Book</h3>
              <p class="text-gray-500 text-sm" style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;">Please review your appointment details</p>
            </div>
            
            <div id="appointment-details" class="space-y-1">
              <!-- Appointment details will be populated by JavaScript -->
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 mt-8 pt-6 border-t border-gray-100">
              <button onclick="window.confirmBooking()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-4 px-6 rounded-2xl font-semibold transition-all duration-200 flex items-center justify-center gap-2 shadow-lg shadow-blue-600/25 hover:shadow-blue-600/40 hover:-translate-y-0.5 active:translate-y-0" style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Confirm Booking
              </button>
              <button onclick="window.clearSelectedAppointment()" class="sm:w-auto px-6 py-4 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-2xl font-medium transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0" style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;">
                Change Selection
              </button>
            </div>
          </div>
        </div>

                <!-- Booking Completed Section -->
        <div id="booking-completed-section" class="hidden max-w-4xl mx-auto px-2 md:px-4 py-6">
          <!-- Minimal Success Container -->
          <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            
            <!-- Clean Success Header -->
            <div class="text-center py-6 px-6 border-b border-gray-100">
              <h1 class="text-base font-medium text-gray-900 mb-1">Booking Request Submitted</h1>
              <p class="text-xs text-gray-500">We've received your appointment request</p>
            </div>

            <!-- Content Grid - Clean Layout -->
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- Appointment Summary -->
                <div class="md:col-span-2 space-y-4">
                  <!-- Booking Details -->
                  <div id="booking-completion-details" class="bg-gray-50 rounded-xl p-4">
                    <!-- Booking details will be populated by JavaScript -->
                  </div>

                  <!-- Location/Session Details -->
                  <div id="service-location-details" class="bg-gray-50 rounded-xl p-4">
                    <!-- Service-specific location or online link details -->
                  </div>
                </div>

                <!-- Next Steps Sidebar -->
                <div class="space-y-4">
                  <!-- Next Steps -->
                  <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Next Steps</h3>
                    
                    <!-- Clean Steps List -->
                    <div class="space-y-3">
                      <div class="flex items-start gap-3">
                        <div class="w-6 h-6 bg-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <span class="text-xs text-gray-600">1</span>
                        </div>
                        <div>
                          <p class="text-xs font-medium text-gray-800">Email sent</p>
                          <p class="text-xs text-gray-500">Check your inbox</p>
                        </div>
                      </div>
                      
                      <div class="flex items-start gap-3">
                        <div class="w-6 h-6 bg-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <span class="text-xs text-gray-600">2</span>
                        </div>
                        <div>
                          <p class="text-xs font-medium text-gray-800">Under review</p>
                          <p class="text-xs text-gray-500">Therapist notified</p>
                        </div>
                      </div>
                      
                      <div class="flex items-start gap-3">
                        <div class="w-6 h-6 bg-white rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <span class="text-xs text-gray-600">3</span>
                        </div>
                        <div>
                          <p class="text-xs font-medium text-gray-800">Confirmation</p>
                          <p class="text-xs text-gray-500">Within 24 hours</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="space-y-2">
                    <button onclick="window.viewMyAppointments()" class="w-full bg-gray-900 hover:bg-gray-800 text-white py-3 px-4 rounded-xl text-xs font-medium transition-colors duration-200 flex items-center justify-center gap-2">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                      My Appointments
                    </button>
                    <button onclick="window.agreeAndReturnToTherapists()" class="w-full bg-white hover:bg-gray-50 text-gray-700 py-3 px-4 rounded-xl text-xs font-medium transition-colors duration-200 border border-gray-200">
                      Browse Therapists
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>


  </div>
  <!-- SVG Filter for Glass Distortion -->
  <svg style="display: none">
    <filter id="glass-distortion">
      <feTurbulence type="turbulence" baseFrequency="0.008" numOctaves="2" result="noise" />
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="77" />
    </filter>
  </svg>

  <!-- Emotia SPA Section -->
  <div id="emotia-sections" class="flex flex-col gap-8 hidden">
    <!-- Mood Tracker Stepper (Emotia) -->
    <section id="emotia-mood-tracker-stepper" class="shadow-xl p-10 flex flex-col w-full items-center relative overflow-hidden" style="border-radius: 35px; box-shadow: 0 6px 20px rgba(139, 92, 246, 0.15); background: white; transition: box-shadow 0.6s cubic-bezier(0.23, 1, 0.32, 1);">
      <div id="emotia-mood-step-1" class="w-full max-w-2xl flex flex-col items-center gap-4 relative z-10">
        <h2 class="text-xl font-bold mb-4 text-center text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Choose how you're feeling<br/>right now</h2>
        
        <!-- Animated Waves Container -->
        <div id="emotia-waves-container" class="relative flex justify-center items-center" style="height: 450px; width: 400px;">
          <canvas id="emotia-waves" style="width: 100%; height: 100%;"></canvas>
        </div>
        
        <div id="emotia-mood-selected-label" class="text-3xl font-light mt-3 mb-6 text-center text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; letter-spacing: -0.02em;">Neutral</div>
        
        <!-- Minimal Slider -->
        <div class="w-full max-w-md relative">
          <div class="flex justify-between text-xs text-gray-500 mb-2 px-2">
            <span>VERY UNPLEASANT</span>
            <span>VERY PLEASANT</span>
        </div>
          <input id="emotia-mood-slider" type="range" min="0" max="6" step="0.01" value="3" class="emotia-minimal-slider w-full" />
        </div>
        
        <button id="emotia-mood-next-btn" class="dusty-button mt-6 font-bold py-3 px-12 rounded-xl transition-all text-lg" style="transform: scale(1);">
          <span>Next</span>
      </div>
      <div id="emotia-mood-step-2" class="w-full max-w-2xl flex flex-col items-center gap-4 relative z-10 hidden opacity-0" style="transition: opacity 0.7s cubic-bezier(.4,2,.6,1);">
        <h2 id="emotia-category-title" class="text-xl font-bold mb-4 text-center text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;"></h2>
        <div id="emotia-category-list" class="flex flex-wrap justify-center gap-3 mt-2 mb-6 max-w-lg"></div>
        <button id="emotia-category-submit-btn" class="dusty-button mt-3 font-bold py-2.5 px-10 rounded-xl transition-all text-lg" style="transform: scale(1);">
          <span>Next</span>
      </div>
      <div id="emotia-mood-step-3" class="w-full max-w-2xl flex flex-col items-center gap-4 relative z-10 hidden opacity-0" style="transition: opacity 0.7s cubic-bezier(.4,2,.6,1);">
        <h2 class="text-xl font-bold mb-4 text-center text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Choose up to 3 emotions<br/>that best describe how you feel</h2>
        <div id="emotia-emotion-list" class="flex flex-wrap justify-center gap-2 mt-2 mb-2"></div>
        <button id="emotia-emotion-submit-btn" class="dusty-button mt-6 font-bold py-3 px-12 rounded-xl transition-all text-lg" style="transform: scale(1);">
          <span>Finish</span>
      </div>
      <div id="emotia-mood-step-4" class="w-full max-w-2xl flex flex-col items-center gap-4 relative z-10 hidden opacity-0" style="transition: opacity 0.7s cubic-bezier(.4,2,.6,1);">
        <h2 class="text-xl font-bold mb-6 text-center text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">You have successfully submitted<br/>your Mood and Emotions!</h2>
        <div class="flex flex-row gap-4 mt-4">
          <button id="emotia-submit-again-btn" class="dusty-button mt-3 font-bold py-3 px-12 rounded-xl transition-all text-lg" style="transform: scale(1);">
            <span>Submit Again</span>
        </div>
      </div>
    </section>
    <!-- Positivity Trend (Emotia) -->
    <section class="relative rounded-[35px] p-8 w-full mt-10" style="border-radius: 35px; background: linear-gradient(145deg, #ffffff, #f8fafc); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.9);">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Positivity Trend</h2>
        <div id="emotia-positivity-filter" class="inline-flex rounded-xl p-1 gap-1" style="background: rgba(241, 245, 249, 0.8); border: 1px solid rgba(226, 232, 240, 0.6);">
          <button class="positivity-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; background: white; color: #374151; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);" data-range="week">Week</button>
          <button class="positivity-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #6b7280;" data-range="month">Month</button>
          <button class="positivity-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #6b7280;" data-range="year">Year</button>
        </div>
      </div>
      <div class="w-full rounded-2xl p-6" style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8)); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.8);">
        <div class="h-[320px]">
          <canvas id="emotia-positivity-trend-chart" height="320"></canvas>
        </div>
      </div>
    </section>
    <script>
        // --- Emotia Mood Tracker with Sine Waves Logic ---
    const emotiaMoodNames = [
      "Very Unpleasant",
      "Unpleasant",
      "Slightly Unpleasant", 
      "Neutral",
      "Slightly Pleasant",
      "Pleasant",
      "Very Pleasant"
    ];
    
    // Color schemes for each mood
    const emotiaMoodColors = [
      { primary: "#9333ea", secondary: "#c084fc", tertiary: "#a855f7" }, // Very Unpleasant - purple
      { primary: "#2563eb", secondary: "#60a5fa", tertiary: "#3b82f6" }, // Unpleasant - blue
      { primary: "#0ea5e9", secondary: "#7dd3fc", tertiary: "#38bdf8" }, // Slightly Unpleasant - light blue
      { primary: "#10b981", secondary: "#6ee7b7", tertiary: "#34d399" }, // Neutral - green
      { primary: "#f59e0b", secondary: "#fbbf24", tertiary: "#f3a308" }, // Slightly Pleasant - amber
      { primary: "#ef4444", secondary: "#f87171", tertiary: "#dc2626" }, // Pleasant - red
      { primary: "#ec4899", secondary: "#f472b6", tertiary: "#db2777" }  // Very Pleasant - pink
    ];
    
    // Gradients for each mood
    const emotiaMoodGradients = [
      "linear-gradient(135deg, #9333ea, #c084fc)", // Very Unpleasant - purple gradient
      "linear-gradient(135deg, #2563eb, #60a5fa)", // Unpleasant - blue gradient
      "linear-gradient(135deg, #0ea5e9, #7dd3fc)", // Slightly Unpleasant - light blue gradient
      "linear-gradient(135deg, #10b981, #6ee7b7)", // Neutral - green gradient
      "linear-gradient(135deg, #f59e0b, #fbbf24)", // Slightly Pleasant - amber gradient
      "linear-gradient(135deg, #ef4444, #f87171)", // Pleasant - red gradient
      "linear-gradient(135deg, #ec4899, #f472b6)"  // Very Pleasant - pink gradient
    ];
    
    const emotiaMoodSlider = document.getElementById('emotia-mood-slider');
    const emotiaMoodLabel = document.getElementById('emotia-mood-selected-label');
    const emotiaWavesCanvas = document.getElementById('emotia-waves');
    
    const emotiaMoodNextBtn = document.getElementById('emotia-mood-next-btn');
    let emotiaSelectedMood = 3; // Neutral by default
    let emotiaWaveGenerator = null;
    
    // Sine Wave Generator Class
    function SineWaveGenerator(options) {
      Object.assign(this, options || {});
      
      if(!this.el) { throw "No Canvas Selected"; }
      this.ctx = this.el.getContext('2d');
      
      if(!this.waves.length) { throw "No waves specified"; }
      
      // Internal
      this._resizeWidth();
      window.addEventListener('resize', this._resizeWidth.bind(this));
      // User
      this.resizeEvent();
      window.addEventListener('resize', this.resizeEvent.bind(this));
      
      if(typeof this.initialize === 'function') {
        this.initialize.call(this);
      }
      // Start the magic
      this.loop();
    }
    
    // Defaults
    SineWaveGenerator.prototype.speed = 10;
    SineWaveGenerator.prototype.amplitude = 50;
    SineWaveGenerator.prototype.wavelength = 50;
    SineWaveGenerator.prototype.segmentLength = 10;
    SineWaveGenerator.prototype.lineWidth = 2;
    SineWaveGenerator.prototype.strokeStyle = 'rgba(255, 255, 255, 0.2)';
    SineWaveGenerator.prototype.resizeEvent = function() {};
    
         // Fill the canvas
     SineWaveGenerator.prototype._resizeWidth = function() {
       this.dpr = window.devicePixelRatio || 1;
       
       // Responsive canvas sizing
       let canvasWidth = 400;
       if (window.innerWidth >= 1280) {
         canvasWidth = 800;
       } else if (window.innerWidth >= 1024) {
         canvasWidth = 700;
       } else if (window.innerWidth >= 768) {
         canvasWidth = 550;
       }
       
       this.width = this.el.width = canvasWidth * this.dpr;
       this.height = this.el.height = 400 * this.dpr;
       this.el.style.width = canvasWidth + 'px';
       this.el.style.height = '400px';
       
       this.waveWidth = this.width * 0.95;
       this.waveLeft = this.width * 0.025;
     }
    
    SineWaveGenerator.prototype.clear = function () {
      this.ctx.clearRect(0, 0, this.width, this.height);
    }
    
    SineWaveGenerator.prototype.time = 0;
    
    SineWaveGenerator.prototype.update = function(time) {  
      this.time = this.time - 0.007;
      if(typeof time === 'undefined') {
        time = this.time;
      }
    
      var index = -1;
      var length = this.waves.length;
    
      while(++index < length) {
        var timeModifier = this.waves[index].timeModifier || 1;
        this.drawSine(time * timeModifier, this.waves[index]);
      }
    }
    
    // Constants
    var PI2 = Math.PI * 2;
    var HALFPI = Math.PI / 2;
    
    SineWaveGenerator.prototype.ease = function(percent, amplitude) {
      return amplitude * (Math.sin(percent * PI2 - HALFPI) + 1) * 0.5;
    }
    
    SineWaveGenerator.prototype.drawSine = function(time, options) {
      options = options || {};
      var amplitude = options.amplitude || this.amplitude;
      var wavelength = options.wavelength || this.wavelength;
      var lineWidth = options.lineWidth || this.lineWidth;
      var strokeStyle = options.strokeStyle || this.strokeStyle;
      var segmentLength = options.segmentLength || this.segmentLength;
      
      var x = time;
      var y = 0;  
      var amp = this.amplitude;
     
      // Center the waves
      var yAxis = this.height / 2; 
      
      // Styles
      this.ctx.lineWidth = lineWidth * this.dpr;
      this.ctx.strokeStyle = strokeStyle;
      this.ctx.lineCap = 'round';
      this.ctx.lineJoin = 'round';
      this.ctx.beginPath();
      
      // Starting Line
      this.ctx.moveTo(0, yAxis);
      this.ctx.lineTo(this.waveLeft, yAxis);
      
      for(var i = 0; i < this.waveWidth; i += segmentLength) {
        x = (time * this.speed) + (-yAxis + i) / wavelength; 
        y = Math.sin(x); 
        
        // Easing
        amp = this.ease(i / this.waveWidth, amplitude); 
        
        this.ctx.lineTo(i + this.waveLeft, amp * y + yAxis);
      }
      
      // Ending Line
      this.ctx.lineTo(this.width, yAxis);
      
      // Stroke it
      this.ctx.stroke();
    } 
    
    SineWaveGenerator.prototype.loop = function() {
      this.clear();
      this.update();
      
      window.requestAnimationFrame(this.loop.bind(this));
    }
    
    // Create waves based on mood
    function createEmotiaWaves() {
      if (emotiaWaveGenerator) {
        // Stop existing animation
        return;
      }
      
      emotiaWaveGenerator = new SineWaveGenerator({
        el: emotiaWavesCanvas,
        speed: 8,
        waves: [
          {
            timeModifier: 1,
            lineWidth: 3,
            amplitude: 80,
            wavelength: 200,
            segmentLength: 20,
          },
          {
            timeModifier: 1,
            lineWidth: 2,
            amplitude: 60,
            wavelength: 100,
          },
          {
            timeModifier: 1,
            lineWidth: 1,
            amplitude: -40,
            wavelength: 50,
            segmentLength: 10,
          }
        ],
        
        initialize: function (){},
        
        resizeEvent: function() {
          updateWaveColors();
        }
      });
    }
    
    // Update wave colors and characteristics based on mood
    function updateWaveColors() {
      if (!emotiaWaveGenerator) return;
      
      const colorScheme = emotiaMoodColors[emotiaSelectedMood];
      const ctx = emotiaWaveGenerator.ctx;
      
      // Create gradient
      const gradient = ctx.createLinearGradient(0, 0, emotiaWaveGenerator.width, 0);
      gradient.addColorStop(0, "rgba(0, 0, 0, 0)");
      gradient.addColorStop(0.5, `${colorScheme.primary}80`);
      gradient.addColorStop(1, "rgba(0, 0, 0, 0)");
      
      // Update wave properties based on mood
      const distanceFromNeutral = Math.abs(emotiaSelectedMood - 3);
      const isPleasant = emotiaSelectedMood > 3;
      const isUnpleasant = emotiaSelectedMood < 3;
      
      emotiaWaveGenerator.waves.forEach((wave, index) => {
        wave.strokeStyle = gradient;
        
        // Adjust wave characteristics based on mood
        if (isUnpleasant) {
          // Unpleasant: slower, more chaotic waves
          wave.amplitude = [60 + distanceFromNeutral * 10, 40 + distanceFromNeutral * 8, -30 - distanceFromNeutral * 5][index];
          wave.wavelength = [180 - distanceFromNeutral * 20, 90 - distanceFromNeutral * 10, 45 - distanceFromNeutral * 5][index];
          emotiaWaveGenerator.speed = 6 - distanceFromNeutral * 0.5;
        } else if (isPleasant) {
          // Pleasant: faster, more harmonious waves
          wave.amplitude = [100 + distanceFromNeutral * 15, 80 + distanceFromNeutral * 12, -60 - distanceFromNeutral * 8][index];
          wave.wavelength = [220 + distanceFromNeutral * 30, 110 + distanceFromNeutral * 15, 55 + distanceFromNeutral * 8][index];
          emotiaWaveGenerator.speed = 10 + distanceFromNeutral * 1;
        } else {
          // Neutral: balanced waves
          wave.amplitude = [80, 60, -40][index];
          wave.wavelength = [200, 100, 50][index];
          emotiaWaveGenerator.speed = 8;
        }
      });
    }
    
              function emotiaUpdateMoodDisplay(rawIdx) {
       const floatIdx = Number(rawIdx);
       const idx = Math.round(floatIdx);
       
       emotiaSelectedMood = idx;
       emotiaMoodLabel.textContent = emotiaMoodNames[idx];
       
       // Update waves
       updateWaveColors();
       
       // Update slider pointer color
       const colorScheme = emotiaMoodColors[idx];
       const sliderStyle = document.createElement('style');
       sliderStyle.id = 'emotia-slider-dynamic-style';
       
       // Remove existing dynamic style if it exists
       const existingStyle = document.getElementById('emotia-slider-dynamic-style');
       if (existingStyle) {
         existingStyle.remove();
       }
       
       sliderStyle.textContent = `
         #emotia-mood-slider::-webkit-slider-thumb {
           background: ${colorScheme.primary} !important;
           box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 0 0 0 ${colorScheme.primary}14 !important;
         }
         #emotia-mood-slider::-webkit-slider-thumb:hover {
           box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1), 0 0 0 6px ${colorScheme.primary}0D !important;
         }
         #emotia-mood-slider::-webkit-slider-thumb:active {
           box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 0 0 8px ${colorScheme.primary}14 !important;
         }
         #emotia-mood-slider::-moz-range-thumb {
           background: ${colorScheme.primary} !important;
           box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 0 0 0 ${colorScheme.primary}14 !important;
         }
         #emotia-mood-slider::-moz-range-thumb:hover {
           box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1), 0 0 0 6px ${colorScheme.primary}0D !important;
         }
         #emotia-mood-slider::-moz-range-thumb:active {
           box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 0 0 8px ${colorScheme.primary}14 !important;
         }
       `;
       
       document.head.appendChild(sliderStyle);
       
       // Update container shadow color based on mood
       const moodContainer = document.getElementById('emotia-mood-tracker-stepper');
       if (moodContainer) {
         // Convert hex color to RGB for shadow
         const hex = colorScheme.primary.replace('#', '');
         const r = parseInt(hex.substr(0, 2), 16);
         const g = parseInt(hex.substr(2, 2), 16);
         const b = parseInt(hex.substr(4, 2), 16);
         
         moodContainer.style.boxShadow = `0 6px 20px rgba(${r}, ${g}, ${b}, 0.15)`;
       }
       
       // Update button colors with liquid glass effect
       emotiaMoodNextBtn.style.background = `linear-gradient(135deg, ${colorScheme.primary}40, ${colorScheme.tertiary}40)`;
       emotiaMoodNextBtn.style.borderColor = `${colorScheme.primary}60`;
     }
     
     // Initialize waves and event listeners
     createEmotiaWaves();
     
     // Handle resize for canvas width
     window.addEventListener('resize', () => {
       let newCanvasWidth = 400;
       if (window.innerWidth >= 1280) {
         newCanvasWidth = 800;
       } else if (window.innerWidth >= 1024) {
         newCanvasWidth = 700;
       } else if (window.innerWidth >= 768) {
         newCanvasWidth = 550;
       }
       
       if (emotiaWaveGenerator && emotiaWavesCanvas.width !== newCanvasWidth) {
         emotiaWavesCanvas.width = newCanvasWidth;
         emotiaWaveGenerator.width = newCanvasWidth;
         emotiaWavesCanvas.style.width = newCanvasWidth + 'px';
         updateWaveColors();
       }
     });
     
     emotiaMoodSlider.addEventListener('input', (e) => {
       emotiaUpdateMoodDisplay(e.target.value);
     });
     
     // Initialize with default mood
     emotiaUpdateMoodDisplay(emotiaSelectedMood);
    // Category step logic (match dashboard exactly)
    const emotiaCategories = [
      { name: 'Personal', color: '236,72,153' },
      { name: 'Social', color: '34,197,94' },
      { name: 'Family', color: '59,130,246' },
      { name: 'Career', color: '249,115,22' },
      { name: 'Studies', color: '245,158,11' },
      { name: 'Health', color: '239,68,68' },
      { name: 'Finance', color: '147,51,234' },
      { name: 'Fun', color: '56,178,172' }
    ];
    const emotiaMoodStep1 = document.getElementById('emotia-mood-step-1');
    const emotiaMoodStep2 = document.getElementById('emotia-mood-step-2');
    const emotiaCategoryTitle = document.getElementById('emotia-category-title');
    const emotiaCategoryList = document.getElementById('emotia-category-list');
    const emotiaCategorySubmitBtn = document.getElementById('emotia-category-submit-btn');
    let emotiaSelectedCategories = [];
    function emotiaShowCategoryStep() {
  emotiaMoodStep1.style.opacity = 0;
  setTimeout(() => {
    emotiaMoodStep1.classList.add('hidden');
    emotiaCategoryList.innerHTML = '';
    emotiaSelectedCategories = [];
    
    // Category submit button styling is handled by dusty-button CSS class
    
    // Add heading: "Select categories for your mood" 
    emotiaCategoryTitle.textContent = `Select categories affecting your ${emotiaMoodNames[emotiaSelectedMood].toLowerCase()} mood`;
    
    // Define icons for each category
    const categoryIcons = {
      'Personal': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/></svg>',
      'Social': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
      'Family': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>',
      'Career': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
      'Studies': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>',
      'Health': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/></svg>',
      'Finance': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
      'Fun': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>'
    };
    
    emotiaCategories.forEach(cat => {
      const btn = document.createElement('button');
      
      // Ultra-modern container with sophisticated layout
      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.alignItems = 'center';
      container.style.justifyContent = 'center';
      container.style.gap = '12px';
      container.style.padding = '20px 16px';
      container.style.width = '100%';
      container.style.height = '100%';
      container.style.position = 'relative';
      
      // Sleek icon container with modern styling
      const iconContainer = document.createElement('div');
      iconContainer.style.display = 'flex';
      iconContainer.style.alignItems = 'center';
      iconContainer.style.justifyContent = 'center';
      iconContainer.style.width = '44px';
      iconContainer.style.height = '44px';
      iconContainer.style.borderRadius = '14px';
      iconContainer.style.background = '#f1f5f9';
      iconContainer.style.color = '#475569';
      iconContainer.style.border = '1px solid #cbd5e1';
      iconContainer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
      iconContainer.style.position = 'relative';
      iconContainer.style.overflow = 'hidden';
      
      // Add subtle gradient overlay
      const gradientOverlay = document.createElement('div');
      gradientOverlay.style.position = 'absolute';
      gradientOverlay.style.inset = '0';
      gradientOverlay.style.background = `linear-gradient(135deg, rgba(${cat.color}, 0.05), rgba(${cat.color}, 0.02))`;
      gradientOverlay.style.opacity = '0';
      gradientOverlay.style.transition = 'opacity 0.3s ease';
      iconContainer.appendChild(gradientOverlay);
      
      // Modern icon styling
      const iconWrapper = document.createElement('div');
      iconWrapper.style.position = 'relative';
      iconWrapper.style.zIndex = '1';
      const iconSvg = categoryIcons[cat.name] || '';
      iconWrapper.innerHTML = iconSvg;
      iconContainer.appendChild(iconWrapper);
      
      // Contemporary typography
      const textSpan = document.createElement('span');
      textSpan.textContent = cat.name;
      textSpan.style.fontSize = '0.875rem';
      textSpan.style.fontWeight = '600';
      textSpan.style.color = '#374151';
      textSpan.style.textAlign = 'center';
      textSpan.style.lineHeight = '1.25';
      textSpan.style.width = '100%';
      textSpan.style.display = 'block';
      textSpan.style.letterSpacing = '-0.01em';
      textSpan.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      textSpan.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
      
      container.appendChild(iconContainer);
      container.appendChild(textSpan);
      
      btn.appendChild(container);
      btn.className = 'category-btn glassmorphism-btn';
      btn.style.display = 'inline-flex';
      btn.style.background = 'rgba(255, 255, 255, 0.15)';
      btn.style.border = '1px solid rgba(255, 255, 255, 0.2)';
      btn.style.backdropFilter = 'blur(20px)';
      btn.style.webkitBackdropFilter = 'blur(20px)';
      btn.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      btn.style.width = '100px';
      btn.style.height = '100px';
      btn.style.borderRadius = '24px';
      
      // Make bigger on desktop
      if (window.innerWidth >= 1024) {
        btn.style.width = '110px';
        btn.style.height = '110px';
      }
      btn.style.boxShadow = '0 8px 32px rgba(31, 38, 135, 0.37), inset 0 1px 0 rgba(255, 255, 255, 0.5)';
      btn.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
      btn.style.margin = '8px';
      btn.style.cursor = 'pointer';
      btn.style.position = 'relative';
      btn.style.overflow = 'hidden';
      btn.style.outline = 'none';
      
      // Add modern focus ring
      btn.style.setProperty('--ring-color', `rgba(${cat.color}, 0.2)`);
      btn.addEventListener('focus', () => {
        btn.style.boxShadow = `0 8px 32px rgba(31, 38, 135, 0.37), inset 0 1px 0 rgba(255, 255, 255, 0.5), 0 0 0 4px var(--ring-color)`;
      });
      btn.addEventListener('blur', () => {
        if (!emotiaSelectedCategories.includes(cat.name)) {
          btn.style.boxShadow = '0 8px 32px rgba(31, 38, 135, 0.37), inset 0 1px 0 rgba(255, 255, 255, 0.5)';
        }
      });
      
      btn.addEventListener('mouseenter', () => {
        if (!emotiaSelectedCategories.includes(cat.name)) {
          btn.style.transform = 'translateY(-3px) scale(1.02)';
          btn.style.background = 'rgba(255, 255, 255, 0.25)';
          btn.style.boxShadow = '0 12px 40px rgba(31, 38, 135, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.6)';
          btn.style.border = 'rgba(255, 255, 255, 0.3)';
          gradientOverlay.style.opacity = '1';
          iconContainer.style.background = 'rgba(255, 255, 255, 0.2)';
          iconContainer.style.border = `1px solid rgba(${cat.color}, 0.3)`;
          iconContainer.style.color = `rgba(${cat.color}, 0.9)`;
          iconContainer.style.transform = 'scale(1.08)';
          textSpan.style.color = '#374151';
          textSpan.style.fontWeight = '700';
        }
      });
      
      btn.addEventListener('mouseleave', () => {
        if (!emotiaSelectedCategories.includes(cat.name)) {
          btn.style.transform = 'translateY(0px) scale(1)';
          btn.style.background = 'rgba(255, 255, 255, 0.15)';
          btn.style.boxShadow = '0 8px 32px rgba(31, 38, 135, 0.37), inset 0 1px 0 rgba(255, 255, 255, 0.5)';
          btn.style.border = '1px solid rgba(255, 255, 255, 0.2)';
          gradientOverlay.style.opacity = '0';
          iconContainer.style.background = '#f1f5f9';
          iconContainer.style.border = '1px solid #cbd5e1';
          iconContainer.style.color = '#475569';
          iconContainer.style.transform = 'scale(1)';
          textSpan.style.color = '#374151';
          textSpan.style.fontWeight = '600';
        }
      });
      
      btn.addEventListener('click', () => {
        if (emotiaSelectedCategories.includes(cat.name)) {
          // Deselect - return to original glassmorphism state
          emotiaSelectedCategories = emotiaSelectedCategories.filter(c => c !== cat.name);
          btn.style.background = 'rgba(255, 255, 255, 0.15)';
          btn.style.filter = 'none';
          btn.style.border = '1px solid rgba(255, 255, 255, 0.2)';
          btn.style.backdropFilter = 'blur(20px)';
          btn.style.webkitBackdropFilter = 'blur(20px)';
          btn.style.boxShadow = '0 8px 32px rgba(31, 38, 135, 0.37), inset 0 1px 0 rgba(255, 255, 255, 0.5)';
          btn.style.transform = 'translateY(0px) scale(1)';
          gradientOverlay.style.opacity = '0';
          iconContainer.style.background = '#f1f5f9';
          iconContainer.style.border = '1px solid #cbd5e1';
          iconContainer.style.color = '#475569';
          iconContainer.style.transform = 'scale(1)';
          iconContainer.style.filter = 'none';
          textSpan.style.color = '#374151';
          textSpan.style.fontWeight = '600';
          textSpan.style.transform = 'translateY(0px)';
          textSpan.style.textShadow = 'none';
        } else {
          // Select with vivid color gradient (light but vibrant)
          emotiaSelectedCategories.push(cat.name);
          // Create vivid gradient versions
          const [r, g, b] = cat.color.split(',').map(n => parseInt(n.trim()));
          const lighterR = Math.min(255, Math.floor(r * 0.95 + 40)); // Add dusty tone
          const lighterG = Math.min(255, Math.floor(g * 0.9 + 35));  // Reduce saturation
          const lighterB = Math.min(255, Math.floor(b * 0.85 + 30)); // Add warmth
          const darkerR = Math.max(0, Math.floor(r * 0.7 + 10));     // Dustier darker tone
          const darkerG = Math.max(0, Math.floor(g * 0.65 + 8));
          const darkerB = Math.max(0, Math.floor(b * 0.6 + 5));
          
          btn.style.background = `linear-gradient(135deg, rgb(${lighterR}, ${lighterG}, ${lighterB}), rgb(${darkerR}, ${darkerG}, ${darkerB}))`;
          btn.style.filter = 'saturate(1.4) brightness(1.1)';
          btn.style.border = `1px solid rgb(${darkerR}, ${darkerG}, ${darkerB})`;
          btn.style.backdropFilter = 'none';
          btn.style.webkitBackdropFilter = 'none';
          btn.style.boxShadow = `0 12px 25px rgba(${cat.color}, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.4)`;
          btn.style.transform = 'translateY(-5px) scale(1.05)';
          gradientOverlay.style.opacity = '0';
          iconContainer.style.background = 'rgba(255, 255, 255, 0.25)';
          iconContainer.style.border = '1px solid rgba(255, 255, 255, 0.4)';
          iconContainer.style.color = '#ffffff';
          iconContainer.style.transform = 'scale(1.12)';
          iconContainer.style.filter = 'drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2))';
          textSpan.style.color = '#ffffff';
          textSpan.style.fontWeight = '700';
          textSpan.style.transform = 'translateY(-1px)';
          textSpan.style.textShadow = '0 1px 3px rgba(0, 0, 0, 0.4)';
        }
      });
      
      emotiaCategoryList.appendChild(btn);
    });
        emotiaMoodStep2.classList.remove('hidden');
        setTimeout(() => {
          emotiaMoodStep2.style.opacity = 1;
        }, 10);
      }, 500);
    }
    emotiaMoodNextBtn.addEventListener('click', function(e) {
      e.preventDefault();
      emotiaShowCategoryStep();
    });
    emotiaCategorySubmitBtn.addEventListener('click', function(e) {
      e.preventDefault();
      emotiaShowEmotionStep();
    });
    // Emotions step logic
    const emotiaEmotions = [
      { name: 'Joy', color: '#FBBF24', gradient: 'linear-gradient(135deg, #FEF3C7, #FBBF24)' },           // Golden yellow
      { name: 'Excitement', color: '#F97316', gradient: 'linear-gradient(135deg, #FFEDD5, #F97316)' },   // Vibrant orange
      { name: 'Love', color: '#EC4899', gradient: 'linear-gradient(135deg, #FCE7F3, #EC4899)' },         // Bright pink
      { name: 'Calmness', color: '#06B6D4', gradient: 'linear-gradient(135deg, #CFFAFE, #06B6D4)' },     // Cyan blue
      { name: 'Satisfaction', color: '#10B981', gradient: 'linear-gradient(135deg, #D1FAE5, #10B981)' }, // Emerald green
      { name: 'Relief', color: '#84CC16', gradient: 'linear-gradient(135deg, #ECFCCB, #84CC16)' },       // Lime green
      { name: 'Pride', color: '#8B5CF6', gradient: 'linear-gradient(135deg, #EDE9FE, #8B5CF6)' },        // Purple
      { name: 'Gratitude', color: '#F59E0B', gradient: 'linear-gradient(135deg, #FEF3C7, #F59E0B)' },    // Amber
      { name: 'Hope', color: '#3B82F6', gradient: 'linear-gradient(135deg, #DBEAFE, #3B82F6)' },         // Blue
      { name: 'Anxiety', color: '#EF4444', gradient: 'linear-gradient(135deg, #FEE2E2, #EF4444)' },      // Red
      { name: 'Fear', color: '#6B7280', gradient: 'linear-gradient(135deg, #F3F4F6, #6B7280)' },         // Gray
      { name: 'Anger', color: '#B91C1C', gradient: 'linear-gradient(135deg, #FECACA, #B91C1C)' },        // Darker red (different from anxiety)
      { name: 'Sadness', color: '#1E40AF', gradient: 'linear-gradient(135deg, #DBEAFE, #1E40AF)' },      // Dark blue
      { name: 'Disappointment', color: '#A16207', gradient: 'linear-gradient(135deg, #FEF3C7, #A16207)' }, // Dark yellow-brown (different from guilt)
      { name: 'Jealousy', color: '#047857', gradient: 'linear-gradient(135deg, #ECFDF5, #047857)' },     // Forest green (different from satisfaction)
      { name: 'Shame', color: '#C2185B', gradient: 'linear-gradient(135deg, #FDF2F8, #C2185B)' },        // Deeper pink (different from love/surprise)
      { name: 'Guilt', color: '#92400E', gradient: 'linear-gradient(135deg, #FED7AA, #92400E)' },        // Dark amber
      { name: 'Confusion', color: '#6D28D9', gradient: 'linear-gradient(135deg, #F3E8FF, #6D28D9)' },    // Deeper violet (different from pride)
      { name: 'Surprise', color: '#E11D48', gradient: 'linear-gradient(135deg, #FFE4E6, #E11D48)' }      // Rose-red (different from love/shame)
    ];
    
    // Emotion gradients
    const emotionGradients = {
      'Joy': 'linear-gradient(135deg, #90E1F9, #AEEBFF)',             // Sky blue gradient
      'Excitement': 'linear-gradient(135deg, #FFEF9B, #FFF4B8)',      // Lemon gradient
      'Love': 'linear-gradient(135deg, #FF9EAA, #FFB4BC)',            // Pink gradient
      'Calmness': 'linear-gradient(135deg, #D9E8E3, #F0F7F4)',        // Mint grey gradient
      'Satisfaction': 'linear-gradient(135deg, #98DED6, #AEEAE3)',    // Mint gradient
      'Relief': 'linear-gradient(135deg, #B9D8C3, #CFE8D8)',          // Mint green gradient
      'Pride': 'linear-gradient(135deg, #FFD194, #FFDDB0)',           // Peach gradient
      'Gratitude': 'linear-gradient(135deg, #D1BCD8, #E4D4EA)',       // Lilac gradient
      'Hope': 'linear-gradient(135deg, #FFCCE6, #FFE2F2)',            // Blush-pink gradient
      'Anxiety': 'linear-gradient(135deg, #D5D4CF, #E9E8E3)',         // Warm gray gradient
      'Fear': 'linear-gradient(135deg, #B3B6CC, #C7C9D9)',            // Slate blue-gray gradient
      'Anger': 'linear-gradient(135deg, #D69E9A, #E8B2AE)',           // Brick pink gradient
      'Sadness': 'linear-gradient(135deg, #A0A8BD, #C6CBD5)',         // Steel blue gradient
      'Disappointment': 'linear-gradient(135deg, #A6B1D3, #BEC6E0)',  // Periwinkle gradient
      'Jealousy': 'linear-gradient(135deg, #A990A3, #BFA6B8)',        // Rose purple gradient
      'Shame': 'linear-gradient(135deg, #ACBDAF, #C5CFC6)',           // Moss green gradient
      'Guilt': 'linear-gradient(135deg, #CFC0B7, #E3D7D2)',           // Clay gradient
      'Confusion': 'linear-gradient(135deg, #C1A99C, #D5C4BA)',       // Beige-pink gradient
      'Surprise': 'linear-gradient(135deg, #E5B9B9, #F1D4D4)'         // Coral-pink gradient
    };
    const emotiaMoodStep3 = document.getElementById('emotia-mood-step-3');
    const emotiaEmotionList = document.getElementById('emotia-emotion-list');
    const emotiaEmotionSubmitBtn = document.getElementById('emotia-emotion-submit-btn');
    let emotiaSelectedEmotions = [];
    function emotiaShowEmotionStep() {
      emotiaMoodStep2.style.opacity = 0;
      setTimeout(() => {
        emotiaMoodStep2.classList.add('hidden');
        
        // Set up step 3 title to match mood
        const emotiaEmotionTitle = document.getElementById('emotia-emotion-title');
        if (emotiaEmotionTitle) {
          emotiaEmotionTitle.innerHTML = `Select up to 3 emotions for your <span style='background:linear-gradient(135deg, #3730A3, #7C3AED);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700;'>${emotiaMoodNames[emotiaSelectedMood]}</span> mood`;
        }
        
        // Style the submit button with a gradient matching the mood  
        const gradientColor = emotiaMoodGradients[emotiaSelectedMood];
        // Glass button styling is handled by CSS classes now
        
        emotiaEmotionList.innerHTML = '';
        emotiaSelectedEmotions = [];
        emotiaEmotions.forEach(em => {
          const btn = document.createElement('button');
          btn.textContent = em.name;
          btn.className = 'emotion-btn modern-emotion-btn';
          
          // Modern styling with glassmorphism
          btn.style.background = 'rgba(255, 255, 255, 0.8)';
          btn.style.backdropFilter = 'blur(12px)';
          btn.style.webkitBackdropFilter = 'blur(12px)';
          btn.style.border = '1px solid rgba(255, 255, 255, 0.3)';
          btn.style.fontFamily = "'Inter', 'Helvetica Neue', Arial, sans-serif";
          btn.style.fontWeight = '500';
          btn.style.fontSize = '0.875rem';
          btn.style.letterSpacing = '-0.01em';
          btn.style.padding = '12px 20px';
          btn.style.borderRadius = '50px';
          btn.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.6)';
          btn.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
          btn.style.margin = '6px 4px';
          btn.style.cursor = 'pointer';
          btn.style.outline = 'none';
          btn.style.color = '#374151';
          btn.style.position = 'relative';
          btn.style.overflow = 'hidden';
          
          btn.addEventListener('mouseenter', () => {
            if (!emotiaSelectedEmotions.includes(em.name)) {
              btn.style.transform = 'translateY(-2px) scale(1.02)';
              btn.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.7)';
              btn.style.background = 'rgba(255, 255, 255, 0.9)';
            }
          });
          
          btn.addEventListener('mouseleave', () => {
            if (!emotiaSelectedEmotions.includes(em.name)) {
              btn.style.transform = 'translateY(0px) scale(1)';
              btn.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.6)';
              btn.style.background = 'rgba(255, 255, 255, 0.8)';
            }
          });
          
          btn.addEventListener('click', () => {
            if (emotiaSelectedEmotions.includes(em.name)) {
              // Deselect - return to exact original state
              emotiaSelectedEmotions = emotiaSelectedEmotions.filter(e => e !== em.name);
              btn.style.background = 'rgba(255, 255, 255, 0.8)';
              btn.style.backdropFilter = 'blur(12px)';
              btn.style.webkitBackdropFilter = 'blur(12px)';
              btn.style.border = '1px solid rgba(255, 255, 255, 0.3)';
              btn.style.color = '#374151';
              btn.style.fontWeight = '500'; // Reset to original weight
              btn.style.transform = 'translateY(0px) scale(1)';
              btn.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.6)';
              btn.style.textShadow = 'none'; // Remove text shadow
            } else {
              // Select
              if (emotiaSelectedEmotions.length >= 3) return;
              emotiaSelectedEmotions.push(em.name);
              btn.style.background = em.gradient;
              btn.style.backdropFilter = 'none';
              btn.style.webkitBackdropFilter = 'none';
              btn.style.border = `2px solid ${em.color}`;
              btn.style.color = '#ffffff';
              btn.style.fontWeight = '600';
              btn.style.transform = 'translateY(-3px) scale(1.05)';
              btn.style.boxShadow = `0 12px 30px rgba(0, 0, 0, 0.2), 0 4px 12px ${em.color}40`;
              btn.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
            }
          });
          
          emotiaEmotionList.appendChild(btn);
        });
        emotiaMoodStep3.classList.remove('hidden');
        setTimeout(() => {
          emotiaMoodStep3.style.opacity = 1;
          
          // Dusty buttons don't need mouse tracking - effects are handled by CSS
        }, 10);
      }, 500);
    }
    // Button effects are handled by dusty button CSS classes
    
    emotiaEmotionSubmitBtn.addEventListener('click', function(e) {
      e.preventDefault();
      emotiaShowSuccessStep();
    });
    // Success step logic
    const emotiaMoodStep4 = document.getElementById('emotia-mood-step-4');
    const emotiaSubmitAgainBtn = document.getElementById('emotia-submit-again-btn');
    function emotiaShowSuccessStep() {
      emotiaMoodStep3.style.opacity = 0;
      setTimeout(() => {
        emotiaMoodStep3.classList.add('hidden');
        emotiaMoodStep4.classList.remove('hidden');
        setTimeout(() => {
          emotiaMoodStep4.style.opacity = 1;
        }, 10);
      }, 500);
    }
    if (emotiaSubmitAgainBtn) {
      // Style submit again button with darker dusty appearance
      emotiaSubmitAgainBtn.style.background = 'rgba(95, 86, 74, 0.25)';
      emotiaSubmitAgainBtn.style.border = '1px solid rgba(95, 86, 74, 0.4)';
      emotiaSubmitAgainBtn.style.color = '#5F564A';
      
      // Add hover effect for submit again button
      emotiaSubmitAgainBtn.addEventListener('mouseenter', () => {
        emotiaSubmitAgainBtn.style.background = 'rgba(95, 86, 74, 0.35)';
        emotiaSubmitAgainBtn.style.border = '1px solid rgba(95, 86, 74, 0.5)';
      });
      emotiaSubmitAgainBtn.addEventListener('mouseleave', () => {
        emotiaSubmitAgainBtn.style.background = 'rgba(95, 86, 74, 0.25)';
        emotiaSubmitAgainBtn.style.border = '1px solid rgba(95, 86, 74, 0.4)';
      });
      
              emotiaSubmitAgainBtn.addEventListener('click', function() {
        emotiaMoodStep4.style.opacity = 0;
        setTimeout(() => {
          emotiaMoodStep4.classList.add('hidden');
          emotiaMoodStep1.classList.remove('hidden');
          emotiaMoodStep1.style.opacity = 1;
          
          // Reset to step 1 state
          emotiaMoodSlider.value = 3;
          emotiaSelectedMood = 3;
          emotiaUpdateMoodDisplay(3);
          
          // Clear any selected categories and emotions
          emotiaSelectedCategories = [];
          emotiaSelectedEmotions = [];
        }, 500);
      });
    }
    // Helper to convert hex to rgba
    function emotiaHexToRgba(hex, alpha) {
      hex = hex.replace('#', '');
      if (hex.length === 3) {
        hex = hex.split('').map(x => x + x).join('');
      }
      const r = parseInt(hex.substring(0,2), 16);
      const g = parseInt(hex.substring(2,4), 16);
      const b = parseInt(hex.substring(4,6), 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
    
    // Add a helper function to get contrast color for text
    function emotiaGetContrastColor(hexColor) {
      // Convert hex to RGB
      const r = parseInt(hexColor.slice(1, 3), 16);
      const g = parseInt(hexColor.slice(3, 5), 16);
      const b = parseInt(hexColor.slice(5, 7), 16);
      
      // Calculate brightness (YIQ formula)
      const brightness = (r * 299 + g * 587 + b * 114) / 1000;
      
      // Make all fonts dark for consistency
      return '#333333';
    }
    
    // Add a helper function to shade colors
    function emotiaShadeColor(color, percent) {
      let R = parseInt(color.substring(1,3),16);
      let G = parseInt(color.substring(3,5),16);
      let B = parseInt(color.substring(5,7),16);
      
      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);
      
      R = (R<255)?R:255;  
      G = (G<255)?G:255;  
      B = (B<255)?B:255;  
      
      R = Math.round(R);
      G = Math.round(G);
      B = Math.round(B);
      
      const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
      const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
      const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
      
      return "#"+RR+GG+BB;
    }
    </script>
    <script>
    // --- Emotia Positivity Trend Chart Logic ---
    const emotiaMoodToPercent = {
      'Very Unpleasant': 0,
      'Unpleasant': 16.67,
      'Slight Unpleasant': 33.33,
      'Neutral': 50,
      'Slight Pleasant': 66.67,
      'Pleasant': 83.33,
      'Very Pleasant': 100
    };

    // Sample data - you can replace with real data
    const emotiaTrendData = {
      week: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        data: [
          { positive: 85, negative: 15 },
          { positive: 45, negative: 55 },
          { positive: 92, negative: 8 },
          { positive: 65, negative: 35 },
          { positive: 78, negative: 22 },
          { positive: 88, negative: 12 },
          { positive: 95, negative: 5 }
        ]
      },
      month: {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        data: [
          { positive: 75, negative: 25 },
          { positive: 82, negative: 18 },
          { positive: 68, negative: 32 },
          { positive: 90, negative: 10 }
        ]
      },
      year: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        data: [
          { positive: 70, negative: 30 },
          { positive: 75, negative: 25 },
          { positive: 68, negative: 32 },
          { positive: 82, negative: 18 },
          { positive: 88, negative: 12 },
          { positive: 92, negative: 8 },
          { positive: 85, negative: 15 },
          { positive: 79, negative: 21 },
          { positive: 86, negative: 14 },
          { positive: 90, negative: 10 },
          { positive: 76, negative: 24 },
          { positive: 83, negative: 17 }
        ]
      }
    };

    let emotiaPositivityChart;

    function emotiaRenderPositivityChart(range) {
      const data = emotiaTrendData[range];
      
      if (emotiaPositivityChart) {
        emotiaPositivityChart.destroy();
      }

      const ctx = document.getElementById('emotia-positivity-trend-chart').getContext('2d');
      
      // Calculate trend line data (simple moving average of net positivity)
      const trendData = data.data.map(d => d.positive - d.negative);
      
      emotiaPositivityChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            {
              label: 'Negative',
              data: data.data.map(d => -d.negative),
              backgroundColor: '#93C5FD', // Solid color, no blur gradient
              borderColor: 'rgba(147, 197, 253, 0.5)',
              borderWidth: 1,
              borderRadius: 12, // All sides rounded
              borderSkipped: false,
              barPercentage: 0.3, // Even narrower bars
              categoryPercentage: 0.6,
              stack: 'stack1'
            },
            {
              label: 'Positive',
              data: data.data.map(d => d.positive),
              backgroundColor: '#F9A8D4', // Solid color, no blur gradient
              borderColor: 'rgba(251, 207, 232, 0.5)',
              borderWidth: 1,
              borderRadius: 12, // All sides rounded
              borderSkipped: false,
              barPercentage: 0.3, // Even narrower bars
              categoryPercentage: 0.6,
              stack: 'stack1'
            },
            {
              label: 'Trend',
              type: 'line',
              data: trendData,
              borderColor: '#9333ea',
              borderWidth: 1,
              backgroundColor: 'transparent',
              pointRadius: 0,
              pointHoverRadius: 3,
              pointBackgroundColor: '#9333ea',
              
              pointBorderWidth: 0, // No border for filled circles
              tension: 0.5,
              fill: false,
              order: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false
          },
          plugins: { whiteGlow: { enabled: true },
            legend: {
              display: !(window.innerWidth <= 768 && window.innerHeight > window.innerWidth),
              position: 'top',
              align: 'end',
              labels: {
                usePointStyle: true,
                pointStyle: 'circle',
                padding: window.innerWidth <= 768 && window.innerHeight > window.innerWidth ? 12 : 20,
                font: {
                  family: 'Inter',
                  size: window.innerWidth <= 768 && window.innerHeight > window.innerWidth ? 9 : 12,
                  weight: '500'
                },
                color: '#6b7280'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.98)',
              titleColor: '#374151',
              bodyColor: '#6b7280',
              borderColor: 'rgba(226, 232, 240, 0.6)',
              borderWidth: 1,
              cornerRadius: 16,
              titleFont: { family: 'Inter', size: 13, weight: '600' },
              bodyFont: { family: 'Inter', size: 12, weight: '500' },
              padding: 16,
              displayColors: true,
              usePointStyle: true,
              callbacks: {
                label: function(context) {
                  const value = Math.abs(context.raw);
                  const label = context.dataset.label;
                  if (context.dataset.label === 'Trend') return `Trend: ${value > 0 ? '+' : ''}${value}%`;
                  return `${label}: ${value}%`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              border: {
                display: false
              },
              ticks: {
                color: '#6b7280',
                font: {
                  family: 'Inter',
                  size: window.innerWidth <= 768 && window.innerHeight > window.innerWidth ? 10 : 12,
                  weight: '500'
                },
                padding: 8
              }
            },
            y: {
              min: -100,
              max: 100,
              grid: {
                color: 'rgba(226, 232, 240, 0.5)',
                lineWidth: 1
              },
              border: {
                display: false
              },
                              ticks: {
                color: '#9ca3af',
                font: {
                  family: 'Inter',
                  size: window.innerWidth <= 768 && window.innerHeight > window.innerWidth ? 8 : 11,
                  weight: '400'
                },
                padding: 8,
                stepSize: 50,
                callback: function(value) {
                  if (value === 0) return '0';
                  return Math.abs(value);
                }
              }
            }
          }
        }
      });
      
      // Mark chart as successfully initialized
      window.emotiaChartInitialized = true;
    }

    // Filter button logic
    const emotiaFilterBtns = document.querySelectorAll('#emotia-positivity-filter .positivity-filter-btn');
    emotiaFilterBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        // Reset all buttons
        emotiaFilterBtns.forEach(b => {
          b.style.background = '';
          b.style.color = '#6b7280';
          b.style.boxShadow = '';
        });
        
        // Activate clicked button
        btn.style.background = 'white';
        btn.style.color = '#374151 !important';
        btn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
        
        // Force black text on mobile
        btn.style.setProperty('color', '#374151', 'important');
        
        emotiaRenderPositivityChart(btn.getAttribute('data-range'));
      });
      
      btn.addEventListener('mouseenter', function() {
        if (btn.style.background !== 'white') {
          btn.style.background = 'rgba(243, 244, 246, 0.8)';
          btn.style.color = '#374151';
        }
      });
      
      btn.addEventListener('mouseleave', function() {
        if (btn.style.background !== 'white') {
          btn.style.background = '';
          btn.style.color = '#6b7280';
        }
      });
    });

    // Initial render - set week as default with mobile safety
    function initializeChart() {
      try {
        // Ensure canvas element and Chart.js are available
        const canvas = document.getElementById('emotia-positivity-trend-chart');
        if (!canvas || typeof Chart === 'undefined') {
          setTimeout(initializeChart, 50);
          return;
        }
        
        // Ensure container is visible
        const section = canvas.closest('section');
        if (section && section.style.display === 'none') {
          setTimeout(initializeChart, 100);
          return;
        }
        
        // Detect mobile device
        const isMobile = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
        
        // Pre-click week button for mobile to ensure proper initialization
        if (isMobile) {
          const weekBtn = document.querySelector('#emotia-positivity-filter .positivity-filter-btn[data-range="week"]');
          if (weekBtn) {
            // Programmatically trigger click event
            weekBtn.click();
            
            // Fallback: if click doesn't work, manually trigger the same logic
            setTimeout(() => {
              if (!window.emotiaChartInitialized) {
                emotiaRenderPositivityChart('week');
                weekBtn.style.background = 'white';
                weekBtn.style.setProperty('color', '#374151', 'important');
                weekBtn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                window.emotiaChartInitialized = true;
              }
            }, 100);

// Immediate setup as backup
(function() {
})();          }
        } else {
          // Desktop initialization
          emotiaRenderPositivityChart('week');
          
          // Set initial active state for week button
          setTimeout(() => {
            const weekBtn = document.querySelector('#emotia-positivity-filter .positivity-filter-btn[data-range="week"]');
            if (weekBtn) {
              weekBtn.style.background = 'white';
              weekBtn.style.setProperty('color', '#374151', 'important');
              weekBtn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
            }
          }, 50);
        }
        
      } catch(e) {
        console.log('Chart initialization delayed for mobile:', e);
        setTimeout(initializeChart, 200);
      }
    }
    
    // Initialize when DOM is ready and window is loaded (for mobile)
    let initialized = false;
    function safeInit() {
      if (!initialized) {
        initialized = true;
        
        // For mobile, add additional delay to ensure everything is ready
        const isMobile = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
        if (isMobile) {
          setTimeout(initializeChart, 300);
        } else {
          initializeChart();
        }
      }
    }
    
    // Multiple initialization points for better mobile compatibility
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', safeInit);
      window.addEventListener('load', safeInit);
    } else {
      safeInit();
    }
    
    // Additional mobile-specific initialization on resize/orientation change
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const isMobile = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
        if (isMobile && !initialized) {
          safeInit();
        }
      }, 250);
    });
    </script>
    <!-- Emotions Analysis Section -->
    <section class="relative rounded-[35px] p-8 w-full mt-10" style="border-radius: 35px; background: linear-gradient(145deg, #ffffff, #f8fafc); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.9);">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Emotions Analysis</h2>
        <div id="emotia-emotions-filter" class="inline-flex rounded-xl p-1 gap-1" style="background: rgba(241, 245, 249, 0.8); border: 1px solid rgba(226, 232, 240, 0.6);">
          <button class="emotions-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; background: white; color: #374151; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);" data-range="week">Week</button>
          <button class="emotions-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #6b7280;" data-range="month">Month</button>
          <button class="emotions-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #6b7280;" data-range="year">Year</button>
        </div>
      </div>
      <div class="w-full rounded-2xl p-6" style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8)); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.8);">
        <div class="h-[500px] relative">
          <canvas id="emotia-emotions-bubble-chart" height="500"></canvas>
        </div>
        <div class="flex justify-center mt-4">
          <button id="emotia-emotions-show-details" class="px-6 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; background: rgba(243, 244, 246, 0.8); color: #374151; border: 1px solid rgba(226, 232, 240, 0.6);">Show Details</button>
        </div>
      </div>
    </section>

    <!-- Mood Analysis Section - Completely Separate -->
    <section class="relative rounded-[35px] p-8 w-full mt-10" style="border-radius: 35px; background: linear-gradient(145deg, #ffffff, #f8fafc); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.9);">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Mood Analysis</h2>
        <div id="emotia-mood-analysis-filter" class="inline-flex rounded-xl p-1 gap-1" style="background: rgba(241, 245, 249, 0.8); border: 1px solid rgba(226, 232, 240, 0.6);">
          <button class="mood-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; background: white; color: #374151; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);" data-mood-range="week">Week</button>
          <button class="mood-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #6b7280;" data-mood-range="month">Month</button>
          <button class="mood-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #6b7280;" data-mood-range="year">Year</button>
        </div>
      </div>
      <div class="w-full rounded-2xl p-6" style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8)); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.8);">
        <div class="h-[500px] relative">
          <canvas id="emotia-mood-analysis-chart" height="500"></canvas>
        </div>
        <div class="flex justify-center mt-4">
          <button id="emotia-mood-show-details" class="px-6 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; background: rgba(243, 244, 246, 0.8); color: #374151; border: 1px solid rgba(226, 232, 240, 0.6);">Show More</button>
        </div>
      </div>
    </section>

    <!-- Mood Factors Section -->
    <section class="emotia-section mb-8">
      <div class="bg-white rounded-3xl p-8 shadow-lg border border-gray-200" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.98) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.6);">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-2xl text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">
            <span class="block sm:hidden">Mood</span>
            <span class="block sm:hidden">Factors</span>
            <span class="hidden sm:inline">Mood Factors</span>
          </h2>
          
          <!-- Filter Buttons -->
          <div id="emotia-mood-factors-filter" class="flex bg-gray-100 rounded-xl p-1 mt-4 sm:mt-0" style="background: rgba(248, 250, 252, 0.8); border: 1px solid rgba(226, 232, 240, 0.6);">
            <button class="mood-factors-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" data-factors-range="week" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #6b7280;">Week</button>
            <button class="mood-factors-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" data-factors-range="month" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #6b7280;">Month</button>
            <button class="mood-factors-filter-btn px-4 py-2 rounded-lg text-sm transition-all duration-300" data-factors-range="year" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; color: #6b7280;">Year</button>
        </div>
        </div>

        <!-- Chart Container -->
        <div class="w-full h-96 relative">
          <canvas id="emotia-mood-factors-chart"></canvas>
        </div>

        <!-- Show More Button -->
        <div class="flex justify-center mt-4">
          <button id="emotia-mood-factors-show-details" class="px-6 py-2 rounded-lg text-sm transition-all duration-300" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 500; background: rgba(243, 244, 246, 0.8); color: #374151; border: 1px solid rgba(226, 232, 240, 0.6);">Show More</button>
        </div>
      </div>
    </section>

    <script>
    // --- Mood Analysis Data and Logic (Completely Separate) ---
    window.emotiaMoodAnalysisData = {
      week: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        moods: {
          'Very Pleasant': [8, 12, 10, 15, 18, 22, 20],
          'Pleasant': [15, 18, 20, 22, 25, 28, 25],
          'Slight Pleasant': [10, 8, 12, 10, 8, 5, 8],
          'Neutral': [20, 15, 18, 12, 10, 8, 12],
          'Slight Unpleasant': [5, 8, 6, 4, 3, 2, 5],
          'Unpleasant': [3, 4, 2, 1, 2, 1, 3],
          'Very Unpleasant': [1, 2, 1, 0, 1, 0, 2]
        }
      },
      month: {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        moods: {
          'Very Pleasant': [45, 52, 48, 55],
          'Pleasant': [65, 72, 68, 75],
          'Slight Pleasant': [32, 28, 35, 30],
          'Neutral': [48, 42, 45, 38],
          'Slight Unpleasant': [15, 18, 12, 14],
          'Unpleasant': [8, 12, 6, 10],
          'Very Unpleasant': [5, 8, 4, 6]
        }
      },
      year: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        moods: {
          'Very Pleasant': [180, 195, 210, 225, 240, 255, 270, 260, 245, 220, 200, 185],
          'Pleasant': [260, 280, 295, 310, 325, 340, 355, 345, 330, 300, 275, 250],
          'Slight Pleasant': [128, 135, 142, 150, 138, 125, 115, 120, 132, 145, 155, 148],
          'Neutral': [192, 180, 168, 155, 142, 130, 125, 135, 150, 168, 185, 195],
          'Slight Unpleasant': [60, 65, 58, 52, 48, 45, 42, 46, 52, 58, 62, 65],
          'Unpleasant': [32, 38, 30, 25, 22, 20, 18, 22, 28, 35, 40, 42],
          'Very Unpleasant': [20, 25, 18, 15, 12, 10, 8, 12, 18, 22, 28, 30]
        }
      }
    };

    // Mood colors mapping for mood analysis chart (fixed colors from mood tracker)
    const moodAnalysisColors = {
      'Very Unpleasant': '#9333ea',
      'Unpleasant': '#2563eb', 
      'Slight Unpleasant': '#0ea5e9',
      'Neutral': '#10b981',
      'Slight Pleasant': '#f59e0b',
      'Pleasant': '#ef4444', // Fixed: Pleasant should be yellowish/cream 
      'Very Pleasant': '#ec4899' // Fixed: Very Pleasant should be pinkish
    };

    // Function to create gradient fills for better layer separation
    function createGradientFill(ctx, mood, chartArea) {
      const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
      const baseColor = moodAnalysisColors[mood];
      
      // Convert hex to RGB for gradient
      const r = parseInt(baseColor.slice(1, 3), 16);
      const g = parseInt(baseColor.slice(3, 5), 16);
      const b = parseInt(baseColor.slice(5, 7), 16);
      
      // Create vertical gradient from color to transparent
      gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.3)`); // Top: 30% opacity
      gradient.addColorStop(0.7, `rgba(${r}, ${g}, ${b}, 0.1)`); // Middle: 10% opacity
      gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`); // Bottom: transparent
      
      return gradient;
    }

    window.emotiaMoodAnalysisChart = null;

    function renderMoodAnalysisChart(range) {
      console.log('renderMoodAnalysisChart called with range:', range);
      
      const canvas = document.getElementById('emotia-mood-analysis-chart');
      if (!canvas) {
        console.error('Canvas element not found!');
        return;
      }
      
      if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded!');
        return;
      }
      
      const data = window.emotiaMoodAnalysisData[range];
      console.log('Data for range:', data);
      
      if (window.emotiaMoodAnalysisChart) {
        window.emotiaMoodAnalysisChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      
      // Create datasets and sort by average values to put lowest lines on top
      const datasetsTemp = Object.entries(data.moods).map(([mood, values]) => {
        const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
        return { mood, values, avg };
      });
      
      // Sort by average values (highest first, so lowest render on top)
      datasetsTemp.sort((a, b) => b.avg - a.avg);
      
      const datasets = datasetsTemp.map((item, index) => ({
        label: item.mood,
        data: item.values,
        backgroundColor: function(context) { const chart = context.chart; const {ctx, chartArea} = chart; if (!chartArea) return "transparent"; return createGradientFill(ctx, item.mood, chartArea); }, // Light transparency for fill
        borderColor: moodAnalysisColors[item.mood],
        borderWidth: 2.5, // Thinner but vivid lines
        fill: 'origin', // Fill to zero baseline, not stacked
        tension: 0.8, // Smoother spline curves for mood-wave effect
        pointRadius: 1.5, // Smaller filled circles
        pointHoverRadius: 4, // Proportional hover size
        pointBackgroundColor: moodAnalysisColors[item.mood],
        
        pointBorderWidth: 0, // No border for filled circles
        order: datasetsTemp.length - 1 - index // Lowest values get highest order (rendered last/on top)
      }));

      window.emotiaMoodAnalysisChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1500,
            easing: 'easeOutQuart'
          },
          plugins: { whiteGlow: { enabled: true },
            legend: {
              display: !(window.innerWidth <= 768 && window.innerHeight > window.innerWidth),
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: { family: 'Inter', size: 11, weight: '500' },
                color: '#6b7280'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.98)',
              titleColor: '#374151',
              bodyColor: '#6b7280',
              borderColor: 'rgba(226, 232, 240, 0.6)',
              borderWidth: 1,
              cornerRadius: 12,
              titleFont: { family: 'Inter', size: 13, weight: '600' },
              bodyFont: { family: 'Inter', size: 12, weight: '500' },
              padding: 12,
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                font: { family: 'Inter', size: 11, weight: '500' },
                color: '#9ca3af'
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(156, 163, 175, 0.2)',
                borderDash: [3, 3]
              },
              ticks: {
                font: { 
                  family: 'Inter', 
                  size: window.innerWidth <= 768 && window.innerHeight > window.innerWidth ? 8 : 11, 
                  weight: '500' 
                },
                color: '#9ca3af'
              }
            }
          },
          elements: {
            point: {
              radius: 0,
              hoverRadius: 4
            }
          }
        }
      });
    }

    // Mood Analysis filter button logic
    function initializeMoodFilterButtons() {
      const emotiaMoodFilterBtns = document.querySelectorAll('#emotia-mood-analysis-filter .mood-filter-btn');
      console.log('Initializing mood filter buttons:', emotiaMoodFilterBtns.length);
      
      emotiaMoodFilterBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
          console.log('Mood filter clicked:', btn.textContent);
          e.preventDefault();
          e.stopPropagation();
          
          // Reset all buttons
          emotiaMoodFilterBtns.forEach(b => {
            b.style.background = '';
            b.style.color = '#6b7280';
            b.style.boxShadow = '';
          });
          
          // Activate clicked button
          btn.style.background = 'white';
          btn.style.setProperty('color', '#374151', 'important');
          btn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
          
          renderMoodAnalysisChart(btn.getAttribute('data-mood-range'));
        });
      });
    }
    
    // Don't initialize buttons here - will be done in main initialization

    // Mood Analysis Show More button functionality  
    const emotiaMoodShowDetailsBtn = document.getElementById('emotia-mood-show-details');
    let moodDetailsVisible = false;

    if (emotiaMoodShowDetailsBtn) {
      emotiaMoodShowDetailsBtn.addEventListener('click', function() {
      if (!moodDetailsVisible) {
        const activeFilter = document.querySelector('#emotia-mood-analysis-filter .mood-filter-btn[style*="background: white"]') || 
                           document.querySelector('#emotia-mood-analysis-filter .mood-filter-btn[style*="background:white"]');
        const range = activeFilter ? activeFilter.getAttribute('data-mood-range') : 'week';
        const data = window.emotiaMoodAnalysisData[range];
        
        showMoodAnalysisDetails(data.moods, range);
        this.textContent = 'Hide Details';
        moodDetailsVisible = true;
      } else {
        hideMoodAnalysisDetails();
        this.textContent = 'Show More';
        moodDetailsVisible = false;
      }
    });
    }

    function showMoodAnalysisDetails(moods, range) {
      // Calculate totals for each mood
      const moodTotals = {};
      Object.entries(moods).forEach(([mood, values]) => {
        moodTotals[mood] = values.reduce((sum, val) => sum + val, 0);
      });
      
      const grandTotal = Object.values(moodTotals).reduce((sum, val) => sum + val, 0);
      
      // Create details container
      const detailsContainer = document.createElement('div');
      detailsContainer.id = 'mood-analysis-details-container';
      detailsContainer.className = 'mt-6 p-6 rounded-2xl bg-white border border-gray-200 animate-fade-in';
      
      const moodsList = Object.entries(moodTotals)
        .sort(([,a], [,b]) => b - a) // Sort by total descending
        .map(([mood, total]) => {
          const color = moodAnalysisColors[mood];
          const percentage = Math.round((total / grandTotal) * 100);
          
          return `
            <div class="flex items-center justify-between py-3 px-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors mood-breakdown-item">
              <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-3 mood-color-circle" style="background: ${color}CC; border: none;"></div>
                <span class="font-medium text-gray-700 mood-name">${mood}</span>
                </button>
        </div>
              <div class="flex items-center text-sm mood-stats">
                <span class="font-semibold text-gray-800 mr-2 mood-count">${total} times</span>
                <span class="text-gray-500 mood-percentage">(${percentage}%)</span>
                </button>
        </div>
              </button>
        </div>
          `;
        }).join('');

      detailsContainer.innerHTML = `
        <h3 class="text-lg font-semibold text-gray-800 mb-4" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;">
          Mood Breakdown - ${range.charAt(0).toUpperCase() + range.slice(1)}
        </h3>
        <div class="grid gap-2">
          ${moodsList}
        </div>
        <div class="mt-4 text-sm text-gray-600 text-center">
          Total mood entries: ${grandTotal}
        </div>
      `;

      // Insert after the chart container
      const chartContainer = document.querySelector('#emotia-mood-analysis-chart').closest('.w-full');
      chartContainer.parentNode.appendChild(detailsContainer);
    }

    function hideMoodAnalysisDetails() {
      const detailsContainer = document.getElementById('mood-analysis-details-container');
      if (detailsContainer) {
        detailsContainer.remove();
      }
    }

        // Initialize Mood Analysis Chart with proper visibility checks
    function initializeMoodAnalysisChart() {
      try {
        console.log('Attempting to initialize mood analysis chart...');
        
        // Ensure canvas element and Chart.js are available
        const canvas = document.getElementById('emotia-mood-analysis-chart');
        if (!canvas || typeof Chart === 'undefined') {
          console.log('Canvas or Chart.js not ready, retrying...');
          setTimeout(initializeMoodAnalysisChart, 50);
          return;
        }
        
        // Ensure container is visible (this is key!)
        const section = canvas.closest('section');
        if (section && (section.style.display === 'none' || section.offsetParent === null)) {
          console.log('Section not visible, retrying...');
          setTimeout(initializeMoodAnalysisChart, 100);
          return;
        }
        
        // Check if Emotia section is active
        const emotiaSection = document.querySelector('.emotia-sections');
        if (emotiaSection && emotiaSection.classList.contains('hidden')) {
          console.log('Emotia section hidden, retrying...');
          setTimeout(initializeMoodAnalysisChart, 100);
          return;
        }
        
        console.log('All conditions met, rendering chart...');
        
        // Detect mobile device
        const isMobile = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
        
                 // Initialize filter buttons
         initializeMoodFilterButtons();
        
        // Mobile-specific initialization
        if (isMobile) {
          const weekBtn = document.querySelector('#emotia-mood-analysis-filter .mood-filter-btn[data-mood-range="week"]');
          if (weekBtn) {
            // Programmatically trigger click event for mobile
            weekBtn.click();
            
            // Fallback: if click doesn't work, manually trigger the same logic
            setTimeout(() => {
              if (!window.emotiaMoodChartInitialized) {
                renderMoodAnalysisChart('week');
                weekBtn.style.background = 'white';
                weekBtn.style.setProperty('color', '#374151', 'important');
                weekBtn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                window.emotiaMoodChartInitialized = true;
              }
            }, 100);

// Immediate setup as backup
(function() {
})();          }
        } else {
          // Desktop initialization
          renderMoodAnalysisChart('week');
          
          // Set initial active state for week button
          setTimeout(() => {
            const weekBtn = document.querySelector('#emotia-mood-analysis-filter .mood-filter-btn[data-mood-range="week"]');
            if (weekBtn) {
              weekBtn.style.background = 'white';
              weekBtn.style.setProperty('color', '#374151', 'important');
              weekBtn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
            }
          }, 50);
        }
        
        // Mark chart as successfully initialized
        window.emotiaMoodChartInitialized = true;
        console.log('Mood analysis chart initialized successfully');
        
      } catch(e) {
        console.log('Mood analysis chart initialization delayed:', e);
        setTimeout(initializeMoodAnalysisChart, 200);
      }
    }

    // Safe initialization with multiple trigger points
    let moodChartInitialized = false;
    function safeMoodInit() {
      if (!moodChartInitialized) {
        moodChartInitialized = true;
        
        // For mobile, add additional delay to ensure everything is ready
        const isMobile = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
        if (isMobile) {
          setTimeout(initializeMoodAnalysisChart, 300);
        } else {
          initializeMoodAnalysisChart();
        }
      }
    }
    
    // Multiple initialization points for better compatibility
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', safeMoodInit);
      window.addEventListener('load', safeMoodInit);
    } else {
      safeMoodInit();
    }
    
    // Additional initialization on resize/orientation change for mobile
    let moodResizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(moodResizeTimeout);
      moodResizeTimeout = setTimeout(() => {
        const isMobile = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
        if (isMobile && !moodChartInitialized) {
          safeMoodInit();
        }
      }, 250);
    });
    </script>

    <script>
    // --- Mood Factors Data and Logic ---
    window.emotiaMoodFactorsData = {
      week: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        categories: {
          'Career': [3, 5, 4, 6, 8, 2, 1],
          'Personal': [4, 3, 5, 3, 2, 4, 6],
          'Family': [2, 4, 3, 4, 5, 7, 8],
          'Social': [1, 2, 3, 2, 3, 5, 4],
          'Health': [2, 1, 2, 3, 1, 2, 1],
          'Finance': [1, 2, 1, 2, 3, 1, 2],
          'Fun': [3, 4, 2, 3, 4, 6, 5],
          'Studies': [2, 3, 4, 2, 3, 1, 2]
        },
        moods: {
          'Career': ['Slight Unpleasant', 'Pleasant', 'Neutral', 'Pleasant', 'Very Pleasant', 'Unpleasant', 'Neutral'],
          'Personal': ['Pleasant', 'Neutral', 'Very Pleasant', 'Neutral', 'Slight Unpleasant', 'Pleasant', 'Very Pleasant'],
          'Family': ['Neutral', 'Pleasant', 'Neutral', 'Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant'],
          'Social': ['Neutral', 'Slight Pleasant', 'Pleasant', 'Slight Pleasant', 'Pleasant', 'Very Pleasant', 'Pleasant'],
          'Health': ['Unpleasant', 'Neutral', 'Slight Unpleasant', 'Neutral', 'Neutral', 'Slight Pleasant', 'Neutral'],
          'Finance': ['Very Unpleasant', 'Unpleasant', 'Neutral', 'Slight Unpleasant', 'Neutral', 'Neutral', 'Slight Pleasant'],
          'Fun': ['Pleasant', 'Very Pleasant', 'Neutral', 'Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant'],
          'Studies': ['Slight Unpleasant', 'Neutral', 'Pleasant', 'Neutral', 'Pleasant', 'Neutral', 'Slight Pleasant']
        }
      },
      month: {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        categories: {
          'Career': [15, 18, 12, 20],
          'Personal': [12, 15, 18, 14],
          'Family': [18, 20, 16, 22],
          'Social': [8, 12, 10, 15],
          'Health': [6, 8, 5, 9],
          'Finance': [5, 7, 4, 8],
          'Fun': [14, 16, 12, 18],
          'Studies': [10, 12, 8, 14]
        },
        moods: {
          'Career': ['Neutral', 'Pleasant', 'Slight Unpleasant', 'Pleasant'],
          'Personal': ['Pleasant', 'Pleasant', 'Very Pleasant', 'Pleasant'],
          'Family': ['Pleasant', 'Very Pleasant', 'Pleasant', 'Very Pleasant'],
          'Social': ['Slight Pleasant', 'Pleasant', 'Pleasant', 'Very Pleasant'],
          'Health': ['Slight Unpleasant', 'Neutral', 'Unpleasant', 'Neutral'],
          'Finance': ['Unpleasant', 'Slight Unpleasant', 'Very Unpleasant', 'Slight Unpleasant'],
          'Fun': ['Pleasant', 'Very Pleasant', 'Pleasant', 'Very Pleasant'],
          'Studies': ['Neutral', 'Pleasant', 'Slight Unpleasant', 'Pleasant']
        }
      },
      year: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        categories: {
          'Career': [45, 52, 48, 55, 60, 58, 62, 65, 60, 55, 50, 48],
          'Personal': [38, 42, 45, 40, 48, 52, 55, 50, 45, 42, 38, 40],
          'Family': [55, 60, 58, 65, 70, 68, 72, 75, 70, 65, 60, 58],
          'Social': [25, 30, 28, 35, 40, 38, 42, 45, 40, 35, 30, 28],
          'Health': [18, 22, 20, 25, 28, 25, 30, 32, 28, 25, 22, 20],
          'Finance': [15, 18, 16, 20, 22, 20, 25, 28, 25, 22, 18, 16],
          'Fun': [42, 48, 45, 52, 58, 55, 60, 65, 58, 52, 48, 45],
          'Studies': [32, 35, 38, 35, 40, 42, 45, 42, 38, 35, 32, 35]
        },
        moods: {
          'Career': ['Neutral', 'Pleasant', 'Neutral', 'Pleasant', 'Pleasant', 'Pleasant', 'Very Pleasant', 'Very Pleasant', 'Pleasant', 'Pleasant', 'Neutral', 'Neutral'],
          'Personal': ['Pleasant', 'Pleasant', 'Very Pleasant', 'Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Pleasant', 'Pleasant', 'Pleasant'],
          'Family': ['Pleasant', 'Very Pleasant', 'Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Pleasant', 'Pleasant'],
          'Social': ['Slight Pleasant', 'Pleasant', 'Slight Pleasant', 'Pleasant', 'Pleasant', 'Pleasant', 'Very Pleasant', 'Very Pleasant', 'Pleasant', 'Pleasant', 'Slight Pleasant', 'Slight Pleasant'],
          'Health': ['Slight Unpleasant', 'Neutral', 'Slight Unpleasant', 'Neutral', 'Neutral', 'Neutral', 'Slight Pleasant', 'Pleasant', 'Neutral', 'Neutral', 'Slight Unpleasant', 'Slight Unpleasant'],
          'Finance': ['Unpleasant', 'Slight Unpleasant', 'Unpleasant', 'Slight Unpleasant', 'Neutral', 'Neutral', 'Slight Pleasant', 'Pleasant', 'Neutral', 'Neutral', 'Slight Unpleasant', 'Unpleasant'],
          'Fun': ['Pleasant', 'Very Pleasant', 'Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Very Pleasant', 'Pleasant', 'Pleasant'],
          'Studies': ['Neutral', 'Pleasant', 'Neutral', 'Pleasant', 'Pleasant', 'Pleasant', 'Very Pleasant', 'Pleasant', 'Pleasant', 'Pleasant', 'Neutral', 'Neutral']
        }
      }
    };

         // Mood factor segmentation colors
     const moodFactorColors = {
       stress: '#ff4d6d',      // Red for stress alerts (negative)
       neutral: '#d8d8d8',     // Light grey for neutral
       positive: '#64dfdf'     // Teal for positive factors
     };

    // Function to categorize mood into stress/neutral/positive
    function categorizeMood(mood) {
      const stressMoods = ['Very Unpleasant', 'Unpleasant', 'Slight Unpleasant'];
      const neutralMoods = ['Neutral'];
      const positiveMoods = ['Slight Pleasant', 'Pleasant', 'Very Pleasant'];
      
      if (stressMoods.includes(mood)) return 'stress';
      if (neutralMoods.includes(mood)) return 'neutral';
      if (positiveMoods.includes(mood)) return 'positive';
      return 'neutral'; // fallback
    }

    window.emotiaMoodFactorsChart = null;

    function renderMoodFactorsChart(range) {
      console.log('renderMoodFactorsChart called with range:', range);
      
      const canvas = document.getElementById('emotia-mood-factors-chart');
      if (!canvas) {
        console.error('Mood factors canvas element not found!');
        return;
      }
      
      if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded for mood factors!');
        return;
      }
      
      const data = window.emotiaMoodFactorsData[range];
      console.log('Mood factors data for range:', data);
      
      if (window.emotiaMoodFactorsChart) {
        window.emotiaMoodFactorsChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      
      // Calculate segmented data for each category
      const processedData = {};
      Object.keys(data.categories).forEach(category => {
        processedData[category] = { stress: [], neutral: [], positive: [] };
        
        data.categories[category].forEach((count, index) => {
          const mood = data.moods[category][index];
          const segment = categorizeMood(mood);
          
          // Initialize all segments to 0 for this time period
          processedData[category].stress[index] = 0;
          processedData[category].neutral[index] = 0;
          processedData[category].positive[index] = 0;
          
          // Set the count for the appropriate segment
          processedData[category][segment][index] = count;
        });
      });

      // Create datasets for the stacked horizontal bar chart
      const datasets = [];
      
      Object.keys(processedData).forEach(category => {
        // Stress segment (red)
        datasets.push({
          label: `${category} - Stress`,
          data: processedData[category].stress,
          backgroundColor: moodFactorColors.stress,
          borderColor: moodFactorColors.stress,
          borderWidth: 0,
          borderRadius: 12,
          borderSkipped: false,
          stack: category,
          categoryPercentage: 0.8,
          barPercentage: 0.9
        });
        
        // Neutral segment (grey)
        datasets.push({
          label: `${category} - Neutral`,
          data: processedData[category].neutral,
          backgroundColor: moodFactorColors.neutral,
          borderColor: moodFactorColors.neutral,
          borderWidth: 0,
          borderRadius: 12,
          borderSkipped: false,
          stack: category,
          categoryPercentage: 0.8,
          barPercentage: 0.9
        });
        
        // Positive segment (green)
        datasets.push({
          label: `${category} - Positive`,
          data: processedData[category].positive,
          backgroundColor: moodFactorColors.positive,
          borderColor: moodFactorColors.positive,
          borderWidth: 0,
          borderRadius: 12,
          borderSkipped: false,
          stack: category,
          categoryPercentage: 0.8,
          barPercentage: 0.9
        });
      });

             window.emotiaMoodFactorsChart = new Chart(ctx, {
         type: 'bar',
         data: {
           labels: Object.keys(data.categories),
           datasets: [
             {
               label: 'Stress Alerts',
               data: Object.keys(data.categories).map(category => {
                 return data.categories[category].reduce((sum, count, index) => {
                   const mood = data.moods[category][index];
                   return sum + (categorizeMood(mood) === 'stress' ? count : 0);
                 }, 0);
               }),
               backgroundColor: moodFactorColors.stress,
               borderRadius: {
                 topLeft: 12,
                 topRight: 12,
                 bottomLeft: 12,
                 bottomRight: 12
               },
               borderSkipped: false
             },
             {
               label: 'Neutral',
               data: Object.keys(data.categories).map(category => {
                 return data.categories[category].reduce((sum, count, index) => {
                   const mood = data.moods[category][index];
                   return sum + (categorizeMood(mood) === 'neutral' ? count : 0);
                 }, 0);
               }),
               backgroundColor: moodFactorColors.neutral,
               borderRadius: {
                 topLeft: 12,
                 topRight: 12,
                 bottomLeft: 12,
                 bottomRight: 12
               },
               borderSkipped: false
             },
             {
               label: 'Positive Factors',
               data: Object.keys(data.categories).map(category => {
                 return data.categories[category].reduce((sum, count, index) => {
                   const mood = data.moods[category][index];
                   return sum + (categorizeMood(mood) === 'positive' ? count : 0);
                 }, 0);
               }),
               backgroundColor: moodFactorColors.positive,
               borderRadius: {
                 topLeft: 12,
                 topRight: 12,
                 bottomLeft: 12,
                 bottomRight: 12
               },
               borderSkipped: false
             }
           ]
         },
         options: {
           responsive: true,
           maintainAspectRatio: false,
           animation: {
             duration: 1500,
             easing: 'easeOutQuart'
           },
           plugins: {
             legend: {
               display: true,
               position: 'bottom',
               labels: {
                 usePointStyle: true,
                 padding: 20,
                 font: { family: 'Inter', size: 11, weight: '500' },
                 color: '#6b7280',
                 generateLabels: function(chart) {
                   return [
                     { text: 'Stress Alerts', fillStyle: moodFactorColors.stress, strokeStyle: 'transparent', lineWidth: 0 },
                     { text: 'Neutral', fillStyle: moodFactorColors.neutral, strokeStyle: 'transparent', lineWidth: 0 },
                     { text: 'Positive Factors', fillStyle: moodFactorColors.positive, strokeStyle: 'transparent', lineWidth: 0 }
                   ];
                 }
               }
             },
             tooltip: {
               backgroundColor: 'rgba(255, 255, 255, 0.98)',
               titleColor: '#374151',
               bodyColor: '#6b7280',
               borderColor: 'rgba(226, 232, 240, 0.6)',
               borderWidth: 1,
               cornerRadius: 12,
               titleFont: { family: 'Inter', size: 13, weight: '600' },
               bodyFont: { family: 'Inter', size: 12, weight: '500' },
               padding: 12,
               mode: 'index',
               intersect: false,
               callbacks: {
                 label: function(context) {
                   return context.dataset.label + ': ' + context.raw + ' entries';
                 }
               }
             }
           },
           scales: {
             x: {
               stacked: true,
               grid: {
                 display: false
               },
               ticks: {
                 font: { family: 'Inter', size: 10, weight: '500' },
                 color: '#9ca3af',
                 maxRotation: 45
               }
             },
             y: {
               stacked: true,
               beginAtZero: true,
               grid: {
                 color: 'rgba(156, 163, 175, 0.2)',
                 borderDash: [3, 3]
               },
               ticks: {
                 font: { 
                   family: 'Inter', 
                   size: window.innerWidth <= 768 && window.innerHeight > window.innerWidth ? 9 : 11, 
                   weight: '500' 
                 },
                 color: '#9ca3af'
               }
             }
           },
           elements: {
             bar: {
               borderRadius: 12
             }
           },
           categoryPercentage: window.innerWidth <= 768 && window.innerHeight > window.innerWidth ? 0.5 : 0.35,
           barPercentage: window.innerWidth <= 768 && window.innerHeight > window.innerWidth ? 0.6 : 0.4,
           layout: {
             padding: {
               top: 15,
               bottom: 15,
               left: 10,
               right: 10
             }
           }
         }
       });
    }

    // Mood Factors filter button logic
    function initializeMoodFactorsFilterButtons() {
      const emotiaFactorsFilterBtns = document.querySelectorAll('#emotia-mood-factors-filter .mood-factors-filter-btn');
      console.log('Initializing mood factors filter buttons:', emotiaFactorsFilterBtns.length);
      
      emotiaFactorsFilterBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
          console.log('Mood factors filter clicked:', btn.textContent);
          e.preventDefault();
          e.stopPropagation();
          
          // Reset all buttons
          emotiaFactorsFilterBtns.forEach(b => {
            b.style.background = '';
            b.style.color = '#6b7280';
            b.style.boxShadow = '';
          });
          
          // Activate clicked button
          btn.style.background = 'white';
          btn.style.setProperty('color', '#374151', 'important');
          btn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
          
          renderMoodFactorsChart(btn.getAttribute('data-factors-range'));
        });
      });
    }

    // Mood Factors Show More button functionality  
    const emotiaFactorsShowDetailsBtn = document.getElementById('emotia-mood-factors-show-details');
    let factorsDetailsVisible = false;

    if (emotiaFactorsShowDetailsBtn) {
      emotiaFactorsShowDetailsBtn.addEventListener('click', function() {
        if (!factorsDetailsVisible) {
          const activeFilter = document.querySelector('#emotia-mood-factors-filter .mood-factors-filter-btn[style*="background: white"]') || 
                             document.querySelector('#emotia-mood-factors-filter .mood-factors-filter-btn[style*="background:white"]');
          const range = activeFilter ? activeFilter.getAttribute('data-factors-range') : 'week';
          const data = window.emotiaMoodFactorsData[range];
          
          showMoodFactorsDetails(data, range);
          this.textContent = 'Hide Details';
          factorsDetailsVisible = true;
        } else {
          hideMoodFactorsDetails();
          this.textContent = 'Show More';
          factorsDetailsVisible = false;
        }
      });
    }

         function showMoodFactorsDetails(data, range) {
       // Calculate totals by category and segment
       const categoryTotals = {};
       const segmentTotals = { stress: 0, neutral: 0, positive: 0 };
       
       Object.keys(data.categories).forEach(category => {
         categoryTotals[category] = { stress: 0, neutral: 0, positive: 0, total: 0 };
         
         data.categories[category].forEach((count, index) => {
           const mood = data.moods[category][index];
           const segment = categorizeMood(mood);
           
           categoryTotals[category][segment] += count;
           categoryTotals[category].total += count;
           segmentTotals[segment] += count;
         });
       });
       
       const grandTotal = Object.values(segmentTotals).reduce((sum, val) => sum + val, 0);
       
       // Create details container
       const detailsContainer = document.createElement('div');
       detailsContainer.id = 'mood-factors-details-container';
       detailsContainer.className = 'mt-6 p-6 rounded-2xl bg-white border border-gray-200 animate-fade-in';
       
       // Create header
       const header = document.createElement('h3');
       // Mobile-specific font size for vertical orientation
       if (window.innerWidth <= 768 && window.innerHeight > window.innerWidth) {
         header.className = 'text-base font-semibold text-gray-800 mb-4';
       } else {
         header.className = 'text-lg font-semibold text-gray-800 mb-4';
       }
       header.style.fontFamily = 'Inter, Helvetica Neue, Arial, sans-serif';
       header.textContent = 'Mood Factors Breakdown - ' + range.charAt(0).toUpperCase() + range.slice(1);
       
       // Create summary cards container
       const summaryContainer = document.createElement('div');
       summaryContainer.className = 'grid grid-cols-3 gap-4 mb-6 items-stretch';
       
       // Stress card
       const stressCard = document.createElement('div');
       const isMobileVertical = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
       stressCard.className = 'bg-red-50 border border-red-200 rounded-xl p-4 text-center h-full';
       stressCard.innerHTML = '<div class="flex flex-col justify-between h-full">' +
                             '<div class="' + (isMobileVertical ? 'w-4 h-4' : 'w-6 h-6') + ' rounded-full mx-auto mb-2" style="background: ' + moodFactorColors.stress + ';"></div>' +
                             '<div class="' + (isMobileVertical ? 'text-xs' : 'text-sm') + ' font-medium text-red-700 mb-2">Stress Alerts</div>' +
                             '<div class="' + (isMobileVertical ? 'text-lg' : 'text-xl') + ' font-bold text-red-800 mb-1">' + segmentTotals.stress + '</div>' +
                             '<div class="' + (isMobileVertical ? 'text-xs' : 'text-xs') + ' text-red-600">' + Math.round((segmentTotals.stress / grandTotal) * 100) + '%</div>' +
                             '</div>';
       
       // Neutral card
       const neutralCard = document.createElement('div');
       neutralCard.className = 'bg-gray-50 border border-gray-200 rounded-xl p-4 text-center h-full';
       neutralCard.innerHTML = '<div class="flex flex-col justify-between h-full">' +
                              '<div class="' + (isMobileVertical ? 'w-4 h-4' : 'w-6 h-6') + ' rounded-full mx-auto mb-2" style="background: ' + moodFactorColors.neutral + ';"></div>' +
                              '<div class="' + (isMobileVertical ? 'text-xs' : 'text-sm') + ' font-medium text-gray-700 mb-2">Neutral</div>' +
                              '<div class="' + (isMobileVertical ? 'text-lg' : 'text-xl') + ' font-bold text-gray-800 mb-1">' + segmentTotals.neutral + '</div>' +
                              '<div class="' + (isMobileVertical ? 'text-xs' : 'text-xs') + ' text-gray-600">' + Math.round((segmentTotals.neutral / grandTotal) * 100) + '%</div>' +
                              '</div>';
       
       // Positive card
       const positiveCard = document.createElement('div');
       positiveCard.className = 'bg-green-50 border border-green-200 rounded-xl p-4 text-center h-full';
       positiveCard.innerHTML = '<div class="flex flex-col justify-between h-full">' +
                               '<div class="' + (isMobileVertical ? 'w-4 h-4' : 'w-6 h-6') + ' rounded-full mx-auto mb-2" style="background: ' + moodFactorColors.positive + ';"></div>' +
                               '<div class="' + (isMobileVertical ? 'text-xs' : 'text-sm') + ' font-medium text-green-700 mb-2">Positive Factors</div>' +
                               '<div class="' + (isMobileVertical ? 'text-lg' : 'text-xl') + ' font-bold text-green-800 mb-1">' + segmentTotals.positive + '</div>' +
                               '<div class="' + (isMobileVertical ? 'text-xs' : 'text-xs') + ' text-green-600">' + Math.round((segmentTotals.positive / grandTotal) * 100) + '%</div>' +
                               '</div>';
       
       summaryContainer.appendChild(stressCard);
       summaryContainer.appendChild(neutralCard);
       summaryContainer.appendChild(positiveCard);
       
       // Create category breakdown
       const categoryHeader = document.createElement('h4');
       categoryHeader.className = 'text-md font-medium text-gray-700 mb-3';
       categoryHeader.textContent = 'By Category';
       
       const categoriesContainer = document.createElement('div');
       categoriesContainer.className = 'grid gap-3';
       
       Object.entries(categoryTotals)
         .sort(([,a], [,b]) => b.total - a.total)
         .forEach(([category, totals]) => {
           const stressPercent = Math.round((totals.stress / totals.total) * 100);
           const neutralPercent = Math.round((totals.neutral / totals.total) * 100);
           const positivePercent = Math.round((totals.positive / totals.total) * 100);
           
           const categoryDiv = document.createElement('div');
           categoryDiv.className = 'bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors';
           categoryDiv.innerHTML = '<div class="flex justify-between items-center mb-3">' +
                                  '<span class="font-medium text-gray-800">' + category + '</span>' +
                                  '<span class="text-sm text-gray-600">' + totals.total + ' total</span>' +
                                  '</div>' +
                                  '<div class="flex rounded-lg overflow-hidden h-3 mb-2">' +
                                  '<div style="width: ' + stressPercent + '%; background: ' + moodFactorColors.stress + ';"></div>' +
                                  '<div style="width: ' + neutralPercent + '%; background: ' + moodFactorColors.neutral + ';"></div>' +
                                  '<div style="width: ' + positivePercent + '%; background: ' + moodFactorColors.positive + ';"></div>' +
                                  '</div>' +
                                  '<div class="flex justify-between text-xs text-gray-600">' +
                                  '<span>Stress: ' + totals.stress + ' (' + stressPercent + '%)</span>' +
                                  '<span>Neutral: ' + totals.neutral + ' (' + neutralPercent + '%)</span>' +
                                  '<span>Positive: ' + totals.positive + ' (' + positivePercent + '%)</span>' +
                                  '</div>';
           
           categoriesContainer.appendChild(categoryDiv);
         });
       
       // Assemble the container
       detailsContainer.appendChild(header);
       detailsContainer.appendChild(summaryContainer);
       detailsContainer.appendChild(categoryHeader);
       detailsContainer.appendChild(categoriesContainer);

       // Insert after the chart container
       const chartContainer = document.querySelector('#emotia-mood-factors-chart').closest('.w-full');
       chartContainer.parentNode.appendChild(detailsContainer);
     }

    function hideMoodFactorsDetails() {
      const detailsContainer = document.getElementById('mood-factors-details-container');
      if (detailsContainer) {
        detailsContainer.remove();
      }
    }

    // Initialize Mood Factors Chart
    function initializeMoodFactorsChart() {
      try {
        console.log('Attempting to initialize mood factors chart...');
        
        // Ensure canvas element and Chart.js are available
        const canvas = document.getElementById('emotia-mood-factors-chart');
        if (!canvas || typeof Chart === 'undefined') {
          console.log('Mood factors canvas or Chart.js not ready, retrying...');
          setTimeout(initializeMoodFactorsChart, 50);
          return;
        }
        
        // Ensure container is visible
        const section = canvas.closest('section');
        if (section && (section.style.display === 'none' || section.offsetParent === null)) {
          console.log('Mood factors section not visible, retrying...');
          setTimeout(initializeMoodFactorsChart, 100);
          return;
        }
        
        console.log('All conditions met for mood factors, rendering chart...');
        
        // Initialize filter buttons
        initializeMoodFactorsFilterButtons();
        
        // Render initial chart
        renderMoodFactorsChart('week');
        
        // Set initial active state for week button
        setTimeout(() => {
          const weekBtn = document.querySelector('#emotia-mood-factors-filter .mood-factors-filter-btn[data-factors-range="week"]');
          if (weekBtn) {
            weekBtn.style.background = 'white';
            weekBtn.style.setProperty('color', '#374151', 'important');
            weekBtn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
          }
        }, 50);
        
        console.log('Mood factors chart initialized successfully');
        
      } catch(e) {
        console.log('Mood factors chart initialization delayed:', e);
        setTimeout(initializeMoodFactorsChart, 200);
      }
    }

    // Initialize when ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeMoodFactorsChart);
      window.addEventListener('load', initializeMoodFactorsChart);
    } else {
      initializeMoodFactorsChart();
    }
    </script>

    <script>
    // --- Emotia Submissions Calendar Data (from Excel) ---
    const emotiaSubmissions = [
      // Career (formerly Professional)
      { date: '2025-03-24', time: '16:15', category: 'Career', mood: 'Pleasant', emotions: ['Joy','Excitement','Hope'] },
      { date: '2025-08-13', time: '17:30', category: 'Career', mood: 'Unpleasant', emotions: ['Disappointment'] },
      { date: '2025-07-30', time: '21:20', category: 'Career', mood: 'Very Pleasant', emotions: ['Pride','Joy'] },
      { date: '2025-11-12', time: '14:45', category: 'Career', mood: 'Slight Unpleasant', emotions: ['Anxiety','Confusion'] },
      { date: '2025-09-18', time: '10:30', category: 'Career', mood: 'Very Pleasant', emotions: ['Satisfaction','Pride'] },
      { date: '2025-05-06', time: '09:15', category: 'Career', mood: 'Neutral', emotions: ['Calmness'] },
      { date: '2025-01-22', time: '15:20', category: 'Career', mood: 'Pleasant', emotions: ['Hope','Gratitude'] },
      
      // Social (formerly Friends)
      { date: '2025-02-18', time: '18:45', category: 'Social', mood: 'Very Pleasant', emotions: ['Joy','Love','Pride'] },
      { date: '2025-10-25', time: '19:40', category: 'Social', mood: 'Pleasant', emotions: ['Love','Pride'] },
      { date: '2025-08-05', time: '13:35', category: 'Social', mood: 'Neutral', emotions: ['Calmness','Hope'] },
      { date: '2025-06-30', time: '20:15', category: 'Social', mood: 'Very Pleasant', emotions: ['Joy','Excitement'] },
      { date: '2025-04-14', time: '16:20', category: 'Social', mood: 'Slight Pleasant', emotions: ['Gratitude','Hope'] },
      { date: '2025-12-08', time: '19:00', category: 'Social', mood: 'Pleasant', emotions: ['Love','Satisfaction'] },
      { date: '2025-03-05', time: '17:45', category: 'Social', mood: 'Slight Unpleasant', emotions: ['Disappointment'] },
      
      // Fun (formerly Entertainment)
      { date: '2025-06-07', time: '10:05', category: 'Fun', mood: 'Neutral', emotions: ['Calmness','Hope'] },
      { date: '2025-03-12', time: '07:55', category: 'Fun', mood: 'Neutral', emotions: ['Hope','Joy'] },
      { date: '2025-09-21', time: '21:30', category: 'Fun', mood: 'Very Pleasant', emotions: ['Joy','Excitement','Surprise'] },
      { date: '2025-07-15', time: '14:40', category: 'Fun', mood: 'Pleasant', emotions: ['Joy','Satisfaction'] },
      { date: '2025-11-28', time: '18:25', category: 'Fun', mood: 'Very Pleasant', emotions: ['Excitement','Gratitude'] },
      { date: '2025-02-03', time: '20:10', category: 'Fun', mood: 'Pleasant', emotions: ['Joy','Calmness'] },
      { date: '2025-04-27', time: '16:55', category: 'Fun', mood: 'Slight Pleasant', emotions: ['Hope','Relief'] },
      
      // Family
      { date: '2024-12-15', time: '01:07', category: 'Family', mood: 'Neutral', emotions: ['Calmness','Relief'] },
      { date: '2024-12-11', time: '12:11', category: 'Family', mood: 'Slight Pleasant', emotions: ['Gratitude','Hope'] },
      { date: '2025-05-23', time: '16:00', category: 'Family', mood: 'Pleasant', emotions: ['Love','Calmness'] },
      { date: '2025-01-18', time: '12:30', category: 'Family', mood: 'Very Pleasant', emotions: ['Love','Joy','Pride'] },
      { date: '2025-08-25', time: '18:15', category: 'Family', mood: 'Pleasant', emotions: ['Gratitude','Love'] },
      { date: '2025-10-10', time: '14:20', category: 'Family', mood: 'Slight Unpleasant', emotions: ['Anxiety','Sadness'] },
      { date: '2025-06-22', time: '19:45', category: 'Family', mood: 'Very Pleasant', emotions: ['Joy','Love'] },
      
      // Personal
      { date: '2025-01-05', time: '09:30', category: 'Personal', mood: 'Unpleasant', emotions: ['Sadness'] },
      { date: '2025-09-09', time: '08:00', category: 'Personal', mood: 'Very Pleasant', emotions: ['Joy','Excitement','Gratitude'] },
      { date: '2025-06-14', time: '09:45', category: 'Personal', mood: 'Unpleasant', emotions: ['Sadness','Disappointment'] },
      { date: '2025-03-08', time: '11:15', category: 'Personal', mood: 'Pleasant', emotions: ['Satisfaction','Hope'] },
      { date: '2025-11-02', time: '07:30', category: 'Personal', mood: 'Slight Pleasant', emotions: ['Calmness','Gratitude'] },
      { date: '2025-07-08', time: '15:40', category: 'Personal', mood: 'Very Pleasant', emotions: ['Pride','Joy'] },
      { date: '2025-04-20', time: '13:25', category: 'Personal', mood: 'Neutral', emotions: ['Calmness'] },
      
      // Health
      { date: '2025-04-02', time: '14:20', category: 'Health', mood: 'Very Unpleasant', emotions: ['Anxiety'] },
      { date: '2025-11-03', time: '15:25', category: 'Health', mood: 'Neutral', emotions: ['Calmness'] },
      { date: '2025-02-14', time: '08:45', category: 'Health', mood: 'Slight Unpleasant', emotions: ['Anxiety','Fear'] },
      { date: '2025-08-19', time: '17:20', category: 'Health', mood: 'Pleasant', emotions: ['Relief','Satisfaction'] },
      { date: '2025-05-31', time: '10:30', category: 'Health', mood: 'Slight Pleasant', emotions: ['Hope','Relief'] },
      { date: '2025-09-26', time: '16:10', category: 'Health', mood: 'Unpleasant', emotions: ['Sadness','Anxiety'] },
      { date: '2025-12-17', time: '12:15', category: 'Health', mood: 'Pleasant', emotions: ['Gratitude','Joy'] },
      
      // Finance
      { date: '2025-05-10', time: '20:00', category: 'Finance', mood: 'Pleasant', emotions: ['Satisfaction','Gratitude'] },
      { date: '2025-12-29', time: '13:10', category: 'Finance', mood: 'Very Unpleasant', emotions: ['Anxiety','Disappointment'] },
      { date: '2025-01-28', time: '11:40', category: 'Finance', mood: 'Unpleasant', emotions: ['Anxiety','Fear'] },
      { date: '2025-07-12', time: '14:55', category: 'Finance', mood: 'Pleasant', emotions: ['Relief','Satisfaction'] },
      { date: '2025-03-19', time: '16:30', category: 'Finance', mood: 'Slight Unpleasant', emotions: ['Anxiety'] },
      { date: '2025-10-14', time: '09:20', category: 'Finance', mood: 'Very Pleasant', emotions: ['Joy','Pride'] },
      { date: '2025-06-03', time: '18:50', category: 'Finance', mood: 'Neutral', emotions: ['Calmness'] },
      
      // Studies
      { date: '2025-07-21', time: '11:50', category: 'Studies', mood: 'Slight Unpleasant', emotions: ['Relief'] },
      { date: '2025-04-18', time: '22:30', category: 'Studies', mood: 'Slight Pleasant', emotions: ['Gratitude','Hope'] },
      { date: '2025-02-25', time: '13:45', category: 'Studies', mood: 'Pleasant', emotions: ['Satisfaction','Pride'] },
      { date: '2025-09-15', time: '10:15', category: 'Studies', mood: 'Unpleasant', emotions: ['Confusion','Disappointment'] },
      { date: '2025-05-28', time: '19:20', category: 'Studies', mood: 'Very Pleasant', emotions: ['Joy','Pride'] },
      { date: '2025-08-07', time: '15:35', category: 'Studies', mood: 'Neutral', emotions: ['Calmness'] },
      { date: '2025-11-18', time: '08:25', category: 'Studies', mood: 'Slight Pleasant', emotions: ['Hope','Relief'] }
    ];
    // Add more demo Emotia submissions for the last 7 days
    (function addRecentDemoSubmissions() {
      const today = new Date();
      const demoWeek = [
        { mood: 'Pleasant', category: 'Personal', emotions: ['Joy','Hope'], time: '09:15' },
        { mood: 'Slight Pleasant', category: 'Social', emotions: ['Excitement','Gratitude'], time: '13:40' },
        { mood: 'Neutral', category: 'Career', emotions: ['Calmness','Relief'], time: '18:05' },
        { mood: 'Unpleasant', category: 'Health', emotions: ['Anxiety','Sadness'], time: '22:30' },
        { mood: 'Very Pleasant', category: 'Fun', emotions: ['Joy','Surprise'], time: '20:10' },
        { mood: 'Slight Unpleasant', category: 'Studies', emotions: ['Confusion','Disappointment'], time: '11:25' },
        { mood: 'Pleasant', category: 'Family', emotions: ['Love','Pride'], time: '16:50' }
      ];
      for (let i = 0; i < 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const dateStr = d.toISOString().slice(0,10);
        emotiaSubmissions.push({
          date: dateStr,
          time: demoWeek[i].time,
          category: demoWeek[i].category,
          mood: demoWeek[i].mood,
          emotions: demoWeek[i].emotions
        });
      }
    })();
    // --- Emotia Calendar Logic ---
    // (JS logic for toggling month/year, rendering grid, colored dots, navigation, and responsive design will be added here)
    const emotiaCalendarGrid = document.getElementById('emotia-calendar-grid');
    const emotiaMonthBtn = document.getElementById('emotia-calendar-month-btn');
    const emotiaYearBtn = document.getElementById('emotia-calendar-year-btn');
    const emotiaPrevBtn = document.getElementById('emotia-calendar-prev-btn');
    const emotiaNextBtn = document.getElementById('emotia-calendar-next-btn');
    
    const monthNamesEN = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const daysEN = ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'];
    let emotiaCalendarView = 'year';
    let emotiaCalendarYear = new Date().getFullYear();
    let emotiaCalendarMonth = new Date().getMonth();
    
    function getSubmissionColorDot(sub) {
      // Use mood color for dot (fallback to purple)
      const moodColors = {
        'Very Unpleasant': '#9333ea',
        'Unpleasant': '#2563eb',
        'Slight Unpleasant': '#0ea5e9',
        'Neutral': '#10b981',
        'Slight Pleasant': '#f59e0b',
        'Pleasant': '#FAE8F5',
        'Very Pleasant': '#FFF7E9'
      };
      return moodColors[sub.mood] || '#8b5cf6';
    }
    
    function renderEmotiaCalendar() {
      emotiaCalendarGrid.innerHTML = '';
      const submissionsList = document.getElementById('emotia-calendar-submissions-list');
      submissionsList.innerHTML = '';
      // Update current label
      const label = document.getElementById('emotia-calendar-current-label');
      if (emotiaCalendarView === 'year') {
        label.textContent = emotiaCalendarYear;
        selectedDay = null;
      } else {
        label.textContent = `${monthNamesEN[emotiaCalendarMonth]} ${emotiaCalendarYear}`;
      }
      if (emotiaCalendarView === 'year') {
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-4 md:grid-cols-6 gap-6 w-full max-w-5xl';
        for (let m = 0; m < 12; m++) {
          const monthBox = document.createElement('div');
          let isCurrentMonth = (emotiaCalendarYear === new Date().getFullYear() && m === new Date().getMonth());
          monthBox.className = 'rounded-2xl bg-purple-50 shadow-lg flex flex-col items-center justify-center p-8 min-h-[120px] min-w-[120px] transition-all cursor-pointer hover:bg-purple-100';
          if (isCurrentMonth) {
            monthBox.className += ' ring-4 ring-purple-400';
          }
          monthBox.style.borderRadius = '24px';
          monthBox.style.position = 'relative';
          monthBox.innerHTML = `<div class='text-lg font-semibold text-gray-900 mb-2' style='text-shadow:0 1px 4px rgba(255,255,255,0.7)'>${monthNamesEN[m]}</div>`;
          // Gradient background for emotions in this month (50% transparent)
          const subs = emotiaSubmissions.filter(s => {
            const d = new Date(s.date);
            return d.getFullYear() === emotiaCalendarYear && d.getMonth() === m;
          });
          let emotionColors = [];
          subs.forEach(sub => {
            if (sub.emotions && sub.emotions.length > 0) {
              sub.emotions.forEach(em => {
                const emData = emotiaEmotions.find(e => e.name === em);
                if (emData) {
                  let color = emData.color;
                  if (color.startsWith('rgba')) {
                    color = color.replace(/rgba\(([^,]+),([^,]+),([^,]+),[^)]+\)/, 'rgba($1,$2,$3,0.5)');
                  } else if (color.startsWith('#')) {
                    // Convert hex to rgba
                    let hex = color.replace('#', '');
                    if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
                    const r = parseInt(hex.substring(0,2), 16);
                    const g = parseInt(hex.substring(2,4), 16);
                    const b = parseInt(hex.substring(4,6), 16);
                    color = `rgba(${r},${g},${b},0.5)`;
                  }
                  emotionColors.push(color);
                }
              });
            }
          });
          if (emotionColors.length > 0) {
            let gradient = `linear-gradient(135deg, ${emotionColors.map((c, i) => {
              // Ensure c is rgba with 0.5 alpha
              if (c.startsWith('rgba')) {
                c = c.replace(/rgba\(([^,]+),([^,]+),([^,]+),[^)]+\)/, 'rgba($1,$2,$3,0.5)');
              } else if (c.startsWith('#')) {
                let hex = c.replace('#', '');
                if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
                const r = parseInt(hex.substring(0,2), 16);
                const g = parseInt(hex.substring(2,4), 16);
                const b = parseInt(hex.substring(4,6), 16);
                c = `rgba(${r},${g},${b},0.5)`;
              }
              return `${c} ${(i/(emotionColors.length-1))*100}%`;
            }).join(', ')})`;
            monthBox.style.background = gradient;
          } else {
            monthBox.style.background = '#f5f3ff';
          }
          // Remove blur for all months
          monthBox.style.filter = 'saturate(1.2)';
          monthBox.style.boxShadow = '0 4px 32px 0 rgba(123,97,255,0.10)';
          // Always add hover and click animation for all months
          monthBox.style.transition = 'transform 0.18s cubic-bezier(.4,2,.6,1), box-shadow 0.18s cubic-bezier(.4,2,.6,1)';
          monthBox.onmouseenter = () => {
            monthBox.style.transform = 'scale(1.045)';
            monthBox.style.boxShadow = '0 8px 32px 0 rgba(123,97,255,0.18)';
          };
          monthBox.onmouseleave = () => {
            monthBox.style.transform = 'scale(1)';
            monthBox.style.boxShadow = '0 4px 32px 0 rgba(123,97,255,0.10)';
          };
          monthBox.onmousedown = () => {
            monthBox.style.transform = 'scale(0.98)';
          };
          monthBox.onmouseup = () => {
            monthBox.style.transform = 'scale(1.045)';
          };
          // Do not set monthBox.style.opacity or any opacity on the monthBox or its text.
          monthBox.addEventListener('click', () => {
            emotiaCalendarView = 'month';
            emotiaCalendarMonth = m;
            emotiaCalendarYear = emotiaCalendarYear; // Ensure year is preserved
            emotiaMonthBtn.classList.add('bg-purple-100', 'text-purple-700');
            emotiaMonthBtn.classList.remove('bg-white/30', 'text-gray-700');
            emotiaYearBtn.classList.remove('bg-purple-100', 'text-purple-700');
            emotiaYearBtn.classList.add('bg-white/30', 'text-gray-700');
            renderEmotiaCalendar();
          });
          grid.appendChild(monthBox);
        }
        emotiaCalendarGrid.appendChild(grid);
      } else {
        // Month view: days of month grid
        const daysInMonth = new Date(emotiaCalendarYear, emotiaCalendarMonth + 1, 0).getDate();
        const firstDay = new Date(emotiaCalendarYear, emotiaCalendarMonth, 1).getDay();
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-7 gap-4 w-full max-w-5xl';
        daysEN.forEach(d => {
          const day = document.createElement('div');
          day.className = 'text-base font-semibold text-gray-900 text-center mb-1';
          day.style.textShadow = '0 1px 4px rgba(255,255,255,0.7)';
          day.textContent = d;
          grid.appendChild(day);
        });
        let dayOfWeek = (firstDay + 6) % 7;
        for (let i = 0; i < dayOfWeek; i++) {
          const empty = document.createElement('div');
          empty.className = 'opacity-0';
          grid.appendChild(empty);
        }
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${emotiaCalendarYear}-${(emotiaCalendarMonth+1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
          const cell = document.createElement('div');
          cell.className = 'rounded-2xl bg-purple-50 shadow flex flex-col items-center justify-center p-4 min-h-[90px] min-w-[70px] transition-all cursor-pointer';
          cell.style.borderRadius = '18px';
          cell.innerHTML = `<div class='text-base font-semibold text-gray-900 mb-1' style='text-shadow:0 1px 4px rgba(255,255,255,0.7)'>${d}</div>`;
          if (selectedDay === dateStr) {
            cell.className += ' ring-4 ring-purple-400';
          }
          // Gradient background for emotions in this day (50% transparent)
          const subs = emotiaSubmissions.filter(s => s.date === dateStr);
          let emotionColors = [];
          subs.forEach(sub => {
            if (sub.emotions && sub.emotions.length > 0) {
              sub.emotions.forEach(em => {
                const emData = emotiaEmotions.find(e => e.name === em);
                if (emData) {
                  let color = emData.color;
                  if (color.startsWith('rgba')) {
                    color = color.replace(/rgba\(([^,]+),([^,]+),([^,]+),[^)]+\)/, 'rgba($1,$2,$3,0.5)');
                  } else if (color.startsWith('#')) {
                    // Convert hex to rgba
                    let hex = color.replace('#', '');
                    if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
                    const r = parseInt(hex.substring(0,2), 16);
                    const g = parseInt(hex.substring(2,4), 16);
                    const b = parseInt(hex.substring(4,6), 16);
                    color = `rgba(${r},${g},${b},0.5)`;
                  }
                  emotionColors.push(color);
                }
              });
            }
          });
          if (emotionColors.length > 0) {
            let gradient = `linear-gradient(135deg, ${emotionColors.map((c, i) => {
              // Ensure c is rgba with 0.5 alpha
              if (c.startsWith('rgba')) {
                c = c.replace(/rgba\(([^,]+),([^,]+),([^,]+),[^)]+\)/, 'rgba($1,$2,$3,0.5)');
              } else if (c.startsWith('#')) {
                let hex = c.replace('#', '');
                if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
                const r = parseInt(hex.substring(0,2), 16);
                const g = parseInt(hex.substring(2,4), 16);
                const b = parseInt(hex.substring(4,6), 16);
                c = `rgba(${r},${g},${b},0.5)`;
              }
              return `${c} ${(i/(emotionColors.length-1))*100}%`;
            }).join(', ')})`;
            cell.style.background = gradient;
          } else {
            cell.style.background = '#f5f3ff';
          }
          // Remove blur for all days
          cell.style.filter = 'saturate(1.2)';
          cell.style.boxShadow = '0 4px 32px 0 rgba(123,97,255,0.10)';
          // Always add hover and click animation for all days
          cell.style.transition = 'transform 0.18s cubic-bezier(.4,2,.6,1), box-shadow 0.18s cubic-bezier(.4,2,.6,1)';
          cell.onmouseenter = () => {
            cell.style.transform = 'scale(1.045)';
            cell.style.boxShadow = '0 8px 32px 0 rgba(123,97,255,0.18)';
          };
          cell.onmouseleave = () => {
            cell.style.transform = 'scale(1)';
            cell.style.boxShadow = '0 4px 32px 0 rgba(123,97,255,0.10)';
          };
          cell.onmousedown = () => {
            cell.style.transform = 'scale(0.98)';
          };
          cell.onmouseup = () => {
            cell.style.transform = 'scale(1.045)';
          };
          // Do not set cell.style.opacity or any opacity on the cell or its text.
          cell.addEventListener('click', () => {
            selectedDay = dateStr;
            renderEmotiaCalendar();
          });
          grid.appendChild(cell);
        }
        emotiaCalendarGrid.appendChild(grid);
        // Listings logic
        let listings = [];
        if (selectedDay) {
          listings = emotiaSubmissions.filter(s => s.date === selectedDay);
        } else {
          listings = emotiaSubmissions.filter(s => {
            const d = new Date(s.date);
            return d.getFullYear() === emotiaCalendarYear && d.getMonth() === emotiaCalendarMonth;
          });
        }
        listings.sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
        if (listings.length === 0) {
          // Show latest 3 submissions overall
          const latest = emotiaSubmissions.slice().sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time)).slice(0, 3);
          latest.forEach(sub => {
            const card = document.createElement('div');
            card.className = 'flex flex-col md:flex-row items-center justify-between bg-purple-100/80 rounded-2xl p-6 shadow-md';
            card.innerHTML = `
              <div class='flex flex-col gap-1 mb-2 md:mb-0'>
                <div class='text-gray-900 text-lg font-semibold flex items-center gap-2' style='text-shadow:0 1px 4px rgba(255,255,255,0.7)'><span class='material-icons text-base align-middle'>calendar_today</span> ${sub.date}</div>
                <div class='text-gray-700 text-base font-medium'>${sub.category}</div>
                <div class='text-gray-500 text-sm'>${sub.time}</div>
                </button>
        </div>
              <div class='flex gap-2 mt-2 md:mt-0'>
                ${sub.emotions.map(em => {
                  const emData = emotiaEmotions.find(e => e.name === em);
                  const emColor = emData ? emData.color : '#8b5cf6';
                  let color = emColor.includes('rgba') ? emColor.replace(/,\s*[^,]+\)$/ , ',0.4)') : emColor + '66';
                  return `<span class='inline-block rounded-full emotion-badge' style='width: 28px; height: 28px; background: ${color}; box-shadow: none; display: flex; align-items: center; justify-content: center; font-size: 1.15rem; color: #333; font-weight: bold;' data-emotion='${em}'></span>`;
                }).join('')}
                <span class='inline-block rounded-full ml-2 mood-dot' style='width: 22px; height: 22px; background: ${getSubmissionColorDot(sub)}; box-shadow: none;' data-mood='${sub.mood}'></span>
                </button>
        </div>
            `;
            submissionsList.appendChild(card);
          });
        } else {
          listings.slice(0, 4).forEach(sub => {
            const card = document.createElement('div');
            card.className = 'flex flex-col md:flex-row items-center justify-between bg-purple-100/80 rounded-2xl p-6 shadow-md';
            card.innerHTML = `
              <div class='flex flex-col gap-1 mb-2 md:mb-0'>
                <div class='text-gray-900 text-lg font-semibold flex items-center gap-2' style='text-shadow:0 1px 4px rgba(255,255,255,0.7)'><span class='material-icons text-base align-middle'>calendar_today</span> ${sub.date}</div>
                <div class='text-gray-700 text-base font-medium'>${sub.category}</div>
                <div class='text-gray-500 text-sm'>${sub.time}</div>
                </button>
        </div>
              <div class='flex gap-2 mt-2 md:mt-0'>
                ${sub.emotions.map(em => {
                  const emData = emotiaEmotions.find(e => e.name === em);
                  const emColor = emData ? emData.color : '#8b5cf6';
                  let color = emColor.includes('rgba') ? emColor.replace(/,\s*[^,]+\)$/ , ',0.4)') : emColor + '66';
                  return `<span class='inline-block rounded-full emotion-badge' style='width: 28px; height: 28px; background: ${color}; box-shadow: none; display: flex; align-items: center; justify-content: center; font-size: 1.15rem; color: #333; font-weight: bold;' data-emotion='${em}'></span>`;
                }).join('')}
                <span class='inline-block rounded-full ml-2 mood-dot' style='width: 22px; height: 22px; background: ${getSubmissionColorDot(sub)}; box-shadow: none;' data-mood='${sub.mood}'></span>
                </button>
        </div>
            `;
            submissionsList.appendChild(card);
          });
        }
        // Add tooltip logic for emotion badges
        setTimeout(() => {
          document.querySelectorAll('.emotion-badge').forEach(badge => {
            badge.addEventListener('mouseenter', function(e) {
              let tooltip = document.createElement('div');
              tooltip.className = 'emotion-tooltip';
              tooltip.textContent = badge.getAttribute('data-emotion');
              tooltip.style.position = 'absolute';
              tooltip.style.background = 'rgba(30,30,30,0.95)';
              tooltip.style.color = '#fff';
              tooltip.style.fontSize = '0.85rem';
              tooltip.style.padding = '2px 10px';
              tooltip.style.borderRadius = '8px';
              tooltip.style.pointerEvents = 'none';
              tooltip.style.zIndex = 1000;
              tooltip.style.left = (e.clientX + 10) + 'px';
              tooltip.style.top = (e.clientY - 10) + 'px';
              tooltip.style.boxShadow = '0 2px 8px 0 rgba(0,0,0,0.18)';
              document.body.appendChild(tooltip);
              badge._tooltip = tooltip;
            });
            badge.addEventListener('mousemove', function(e) {
              if (badge._tooltip) {
                badge._tooltip.style.left = (e.clientX + 10) + 'px';
                badge._tooltip.style.top = (e.clientY - 10) + 'px';
              }
            });
            badge.addEventListener('mouseleave', function() {
              if (badge._tooltip) {
                badge._tooltip.remove();
                badge._tooltip = null;
              }
            });
          });
        }, 10);
      }
    }
    emotiaMonthBtn.addEventListener('click', () => {
      emotiaCalendarView = 'month';
      emotiaMonthBtn.classList.add('bg-purple-100', 'text-purple-700');
      emotiaMonthBtn.classList.remove('bg-white/30', 'text-gray-700');
      emotiaYearBtn.classList.remove('bg-purple-100', 'text-purple-700');
      emotiaYearBtn.classList.add('bg-white/30', 'text-gray-700');
      renderEmotiaCalendar();
    });
    emotiaYearBtn.addEventListener('click', () => {
      emotiaCalendarView = 'year';
      emotiaYearBtn.classList.add('bg-white/70', 'text-purple-700');
      emotiaMonthBtn.classList.remove('bg-white/70', 'text-purple-700');
      emotiaMonthBtn.classList.add('bg-white/30', 'text-white');
      renderEmotiaCalendar();
    });
    emotiaPrevBtn.addEventListener('click', () => {
      if (emotiaCalendarView === 'year') {
        emotiaCalendarYear--;
      } else {
        emotiaCalendarMonth--;
        if (emotiaCalendarMonth < 0) {
          emotiaCalendarMonth = 11;
          emotiaCalendarYear--;
        }
      }
      renderEmotiaCalendar();
    });
    emotiaNextBtn.addEventListener('click', () => {
      if (emotiaCalendarView === 'year') {
        emotiaCalendarYear++;
      } else {
        emotiaCalendarMonth++;
        if (emotiaCalendarMonth > 11) {
          emotiaCalendarMonth = 0;
          emotiaCalendarYear++;
        }
      }
      renderEmotiaCalendar();
    });
    // Initial render
    renderEmotiaCalendar();
    </script>
    <script>
    // --- Emotia Emotions Analysis Bubble Chart Logic ---
    const emotiaEmotionsData = {
      week: {
        labels: ['Last 7 days'],
        emotions: {
          'Joy': 15, 'Calmness': 12, 'Hope': 8, 'Love': 6, 'Anxiety': 10, 
          'Relief': 5, 'Gratitude': 4, 'Excitement': 3, 'Satisfaction': 2,
          'Fear': 3, 'Sadness': 4, 'Anger': 2
        }
      },
      month: {
        labels: ['Last 4 weeks'],
        emotions: {
          'Joy': 45, 'Calmness': 38, 'Hope': 25, 'Love': 20, 'Anxiety': 35,
          'Relief': 18, 'Gratitude': 15, 'Excitement': 12, 'Satisfaction': 8,
          'Fear': 12, 'Sadness': 15, 'Anger': 8, 'Pride': 10, 'Surprise': 6
        }
      },
      year: {
        labels: ['Last 12 months'],
        emotions: {
          'Joy': 180, 'Calmness': 165, 'Hope': 120, 'Love': 95, 'Anxiety': 140,
          'Relief': 75, 'Gratitude': 85, 'Excitement': 55, 'Satisfaction': 45,
          'Fear': 50, 'Sadness': 65, 'Anger': 35, 'Pride': 48, 'Surprise': 28,
          'Disappointment': 25, 'Confusion': 15, 'Guilt': 12
        }
      }
    };

    let emotiaEmotionsBubbleChart;

    function emotiaRenderEmotionsBubbleChart(range) {
      const data = emotiaEmotionsData[range];
      
      if (emotiaEmotionsBubbleChart) {
        emotiaEmotionsBubbleChart.destroy();
      }

      const ctx = document.getElementById('emotia-emotions-bubble-chart').getContext('2d');
      
      // Calculate total emotions and create bubble data
      const totalEmotions = Object.values(data.emotions).reduce((sum, count) => sum + count, 0);
      const emotionEntries = Object.entries(data.emotions)
        .map(([emotion, count]) => {
          const emotionData = emotiaEmotions.find(e => e.name === emotion);
          const color = emotionData ? emotionData.color : '#6b7280';
          const percentage = (count / totalEmotions) * 100;
          
          return {
            emotion,
            count,
            color,
            percentage
          };
        })
        .sort((a, b) => b.count - a.count); // Sort by count descending
      
      // Detect if mobile vertical view
      const isMobileVertical = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
      
      // Find the highest percentage to scale bubbles relatively
      const maxPercentage = Math.max(...emotionEntries.map(e => e.percentage));
      const minPercentage = Math.min(...emotionEntries.map(e => e.percentage));
      
      // Adjust bubble sizes and layout based on device type
      const layoutConfig = isMobileVertical ? {
        minRadius: 6,    // Smaller bubbles for mobile
        maxRadius: 28,   // Smaller max size for mobile
        spiralTightness: 0.6,  // Tighter spiral
        radiusMultiplier: 2.5, // Closer spacing
        containerPadding: 8    // Less padding from edges
      } : {
        minRadius: 12,   // Bigger bubbles for desktop
        maxRadius: 55,   // Larger max size for desktop
        spiralTightness: 0.8,  // Standard spiral
        radiusMultiplier: 3.5, // More spacing
        containerPadding: 5    // Standard padding
      };
      
      // Create bubble positions using spiral layout optimized for device
      const bubbleData = emotionEntries.map((emotionInfo, index) => {
        // Spiral positioning for even distribution
        const angle = index * layoutConfig.spiralTightness;
        const radius = 15 + (index * layoutConfig.radiusMultiplier);
        const centerX = 50;
        const centerY = 50;
        
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;
        
        // Bubble size based on RELATIVE percentage compared to other emotions
        const minRadius = layoutConfig.minRadius;
        const maxRadius = layoutConfig.maxRadius;
        
        // Calculate relative size: emotion with highest % gets maxRadius, lowest gets minRadius
        const relativePercentage = (emotionInfo.percentage - minPercentage) / (maxPercentage - minPercentage);
        const bubbleRadius = minRadius + (relativePercentage * (maxRadius - minRadius));
        
        // Ensure minimum size even for very small percentages
        const finalRadius = Math.max(minRadius, bubbleRadius);
        
        // Calculate dynamic padding based on bubble size to prevent clipping
        const bubblePadding = (finalRadius / (isMobileVertical ? 450 : 500)) * 100; // Convert radius to percentage
        const minPos = layoutConfig.containerPadding + bubblePadding;
        const maxPos = 100 - layoutConfig.containerPadding - bubblePadding;
        
        return {
          x: Math.max(minPos, Math.min(maxPos, x)), // Keep within bounds with dynamic padding
          y: Math.max(minPos, Math.min(maxPos, y)), // Keep within bounds with dynamic padding
          r: finalRadius,
          emotion: emotionInfo.emotion,
          count: emotionInfo.count,
          color: emotionInfo.color,
          percentage: emotionInfo.percentage
        };
      });

      emotiaEmotionsBubbleChart = new Chart(ctx, {
        type: 'bubble',
        data: {
          datasets: [{
            label: 'Emotions',
            data: bubbleData,
            backgroundColor: function(context) {
              return context.raw.color + 'B3'; // 70% opacity
            },
            borderColor: function(context) {
              return context.raw.color;
            },
            borderWidth: 2,
            hoverBackgroundColor: function(context) {
              return context.raw.color + 'E6'; // 90% opacity on hover
            },
            hoverBorderWidth: 3,
            hoverBorderColor: function(context) {
              // Darker border on hover
              const color = context.raw.color;
              if (color.startsWith('#')) {
                // Convert hex to darker version
                const hex = color.replace('#', '');
                const r = Math.max(0, parseInt(hex.substring(0,2), 16) - 40);
                const g = Math.max(0, parseInt(hex.substring(2,4), 16) - 40);
                const b = Math.max(0, parseInt(hex.substring(4,6), 16) - 40);
                return `rgb(${r},${g},${b})`;
              }
              return color;
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1800,
            easing: 'easeOutQuart'
          },
          plugins: { whiteGlow: { enabled: true },
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.98)',
              titleColor: '#374151',
              bodyColor: '#6b7280',
              borderColor: 'rgba(226, 232, 240, 0.6)',
              borderWidth: 1,
              cornerRadius: 16,
              titleFont: { family: 'Inter', size: 14, weight: '600' },
              bodyFont: { family: 'Inter', size: 12, weight: '500' },
              padding: 16,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return context[0].raw.emotion;
                },
                label: function(context) {
                  return `${context.raw.count} times (${context.raw.percentage.toFixed(1)}%)`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              position: 'bottom',
              display: false,
              min: 0,
              max: 100
            },
            y: {
              display: false,
              min: 0,
              max: 100
            }
          },
          onHover: (event, activeElements) => {
            event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
          },
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const element = activeElements[0];
              const emotion = element.element.$context.raw.emotion;
              console.log(`Clicked on ${emotion}`);
              // Could add click functionality here if needed
            }
          }
        }
      });
      
      // Mark chart as successfully initialized
      window.emotiaEmotionsChartInitialized = true;
    }

    // Filter button logic for emotions analysis
    const emotiaEmotionsFilterBtns = document.querySelectorAll('#emotia-emotions-filter .emotions-filter-btn');
    emotiaEmotionsFilterBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        // Reset all buttons
        emotiaEmotionsFilterBtns.forEach(b => {
          b.style.background = '';
          b.style.color = '#6b7280';
          b.style.boxShadow = '';
        });
        
        // Activate clicked button
        btn.style.background = 'white';
        btn.style.setProperty('color', '#374151', 'important');
        btn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
        
        emotiaRenderEmotionsBubbleChart(btn.getAttribute('data-range'));
      });
      
      btn.addEventListener('mouseenter', function() {
        if (btn.style.background !== 'white') {
          btn.style.background = 'rgba(243, 244, 246, 0.8)';
          btn.style.color = '#374151';
        }
      });
      
      btn.addEventListener('mouseleave', function() {
        if (btn.style.background !== 'white') {
          btn.style.background = '';
          btn.style.color = '#6b7280';
        }
      });
    });

    // Show Details button functionality
    const emotiaShowDetailsBtn = document.getElementById('emotia-emotions-show-details');
    let detailsVisible = false;

    emotiaShowDetailsBtn.addEventListener('click', function() {
      if (!detailsVisible) {
        // Show details - create a modal or expand area
        const activeFilter = document.querySelector('#emotia-emotions-filter .emotions-filter-btn[style*="background: white"]') || 
                           document.querySelector('#emotia-emotions-filter .emotions-filter-btn[style*="background:white"]');
        const range = activeFilter ? activeFilter.getAttribute('data-range') : 'week';
        const data = emotiaEmotionsData[range];
        
        showEmotionDetails(data.emotions, range);
        this.textContent = 'Hide Details';
        detailsVisible = true;
      } else {
        hideEmotionDetails();
        this.textContent = 'Show Details';
        detailsVisible = false;
      }
    });

    function showEmotionDetails(emotions, range) {
      const total = Object.values(emotions).reduce((sum, count) => sum + count, 0);
      
      // Create details container
      const detailsContainer = document.createElement('div');
      detailsContainer.id = 'emotion-details-container';
      detailsContainer.className = 'mt-6 p-6 rounded-2xl bg-white border border-gray-200 animate-fade-in';
      
      const emotionsList = Object.entries(emotions)
        .sort(([,a], [,b]) => b - a) // Sort by count descending
        .map(([emotion, count]) => {
          const emotionData = emotiaEmotions.find(e => e.name === emotion);
          const color = emotionData ? emotionData.color : '#6b7280';
          const percentage = Math.round((count / total) * 100);
          
          return `
            <div class="flex items-center justify-between py-3 px-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors emotion-breakdown-item">
              <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-3 emotion-color-circle" style="background: ${color}B3; border: none;"></div>
                <span class="font-medium text-gray-700 emotion-name">${emotion}</span>
                </button>
        </div>
              <div class="flex items-center text-sm emotion-stats">
                <span class="font-semibold text-gray-800 mr-2 emotion-count">${count} times</span>
                <span class="text-gray-500 emotion-percentage">(${percentage}%)</span>
                </button>
        </div>
              </button>
        </div>
          `;
        }).join('');

      detailsContainer.innerHTML = `
        <h3 class="text-lg font-semibold text-gray-800 mb-4" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;">
          Emotion Breakdown - ${range.charAt(0).toUpperCase() + range.slice(1)}
        </h3>
        <div class="grid gap-2">
          ${emotionsList}
        </div>
        <div class="mt-4 text-sm text-gray-600 text-center">
          Total emotions recorded: ${total}
        </div>
      `;

      // Insert after the chart container
      const chartContainer = document.querySelector('#emotia-emotions-bubble-chart').closest('.w-full');
      chartContainer.parentNode.appendChild(detailsContainer);
    }

    function hideEmotionDetails() {
      const detailsContainer = document.getElementById('emotion-details-container');
      if (detailsContainer) {
        detailsContainer.remove();
      }
    }

    // Initial render - set week as default
    function initializeEmotionsChart() {
      try {
        const canvas = document.getElementById('emotia-emotions-bubble-chart');
        if (!canvas || typeof Chart === 'undefined') {
          setTimeout(initializeEmotionsChart, 50);
          return;
        }
        
        emotiaRenderEmotionsBubbleChart('week');
        
        // Set initial active state for week button
        setTimeout(() => {
          const weekBtn = document.querySelector('#emotia-emotions-filter .emotions-filter-btn[data-range="week"]');
          if (weekBtn) {
            weekBtn.style.background = 'white';
            weekBtn.style.setProperty('color', '#374151', 'important');
            weekBtn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
          }
        }, 50);
        
      } catch(e) {
        console.log('Emotions chart initialization delayed:', e);
        setTimeout(initializeEmotionsChart, 200);
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeEmotionsChart);
    } else {
      initializeEmotionsChart();
    }
    </script>


    <script>
    // Sidebar logic
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebarToggleIcon = document.getElementById('sidebar-toggle-icon');
const mainContent = document.getElementById('main-content');

let sidebarOpen = true;

function setSidebar(open) {
  sidebarOpen = open;
  if (open) {
    sidebar.style.transform = '';
    sidebar.style.marginLeft = '';
    sidebarToggle.style.left = '16rem'; // 64px (w-64)
    sidebarToggleIcon.textContent = 'chevron_left';
    mainContent.style.marginLeft = '';
  } else {
    sidebar.style.transform = 'translateX(-100%)';
    sidebar.style.marginLeft = '-16rem';
    sidebarToggle.style.left = '1rem';
    sidebarToggleIcon.textContent = 'chevron_right';
    mainContent.style.marginLeft = '0';
  }
}

sidebarToggle.addEventListener('click', () => {
  setSidebar(!sidebarOpen);
});

// Responsive: close sidebar on small screens by default
if (window.innerWidth < 768) setSidebar(false);

window.addEventListener('resize', () => {
});
</script>

<script>
// SPA-like section switching logic with Menu Bar
const dashboardSections = document.getElementById('dashboard-sections');
const sessionsSections = document.getElementById('sessions-sections');
const emotiaSections = document.getElementById('emotia-sections');
const journaliaSections = document.createElement('div');
journaliaSections.id = 'journalia-sections';
journaliaSections.className = 'flex flex-col gap-8 hidden';
document.getElementById('main-content').appendChild(journaliaSections);
const momentumSections = document.createElement('div');
momentumSections.id = 'momentum-sections';
momentumSections.className = 'flex flex-col gap-8 hidden';
document.getElementById('main-content').appendChild(momentumSections);

// Menu Bar Navigation
menuItems.forEach(item => {
  item.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const section = this.getAttribute('data-section');
    
    // Close menu
    if (!tl.reversed()) {
      tl.reverse();
    }
    
    // Remove active class from all menu items
    menuItems.forEach(menuItem => menuItem.classList.remove('active'));
    
    // Add active class to clicked item
    this.classList.add('active');
    
    // Handle section switching
    switch(section) {
      case 'dashboard':
        dashboardSections.classList.remove('hidden');
        sessionsSections.classList.add('hidden');
        emotiaSections.classList.add('hidden');
        journaliaSections.classList.add('hidden');
        momentumSections.classList.add('hidden');
        break;
        
      case 'sessions':
        dashboardSections.classList.add('hidden');
        sessionsSections.classList.remove('hidden');
        emotiaSections.classList.add('hidden');
        journaliaSections.classList.add('hidden');
        momentumSections.classList.add('hidden');
        // Render sessions calendar/appointments if not already rendered
        renderCalendarSessions(calendarStateSessions.selectedDate);
    
    // FIX THERAPIST BUTTONS IMMEDIATELY WHEN SESSIONS TAB IS CLICKED
    setTimeout(function() {
      console.log("üîß Fixing therapist buttons after sessions tab click...");
      
      // Fix Find Therapist Button
      const findBtn = document.getElementById("find-therapist-btn");
      if (findBtn) {
        findBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Find Therapist clicked!");
          const step1 = document.getElementById("therapist-step-1");
          const step2 = document.getElementById("therapist-step-2");
          if (step1 && step2) {
            step1.style.display = "none";
            step1.classList.add("hidden");
            step2.style.display = "block";
            step2.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 2");
          }
          return false;
        };
        console.log("‚úÖ Find Therapist button fixed");
      }
      
      // Fix Location Button
      const locationBtn = document.querySelector(".location-gradient");
      if (locationBtn) {
        locationBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Location clicked!");
          const step2 = document.getElementById("therapist-step-2");
          const step3 = document.getElementById("therapist-step-3-location");
          if (step2 && step3) {
            step2.style.display = "none";
            step2.classList.add("hidden");
            step3.style.display = "block";
            step3.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 3");
            
            // Enhanced map and cards initialization
            setTimeout(function() {
              console.log("üó∫Ô∏è Initializing map and cards...");
              
              // Force map initialization
              if (typeof initializeMapContainer === "function") {
                console.log("üìç Calling initializeMapContainer...");
                try {
                  initializeMapContainer();
                  console.log("‚úÖ Map initialized successfully");
                } catch (e) {
                  console.error("‚ùå Map initialization error:", e);
                }
              } else {
                console.error("‚ùå initializeMapContainer function not found");
              }
              
              // Force therapist cards population
              if (typeof window.forcePopulateLocationCards === "function") {
                console.log("üë• Calling window.forcePopulateLocationCards...");
                try {
                  window.forcePopulateLocationCards();
                  console.log("‚úÖ Location therapist cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Cards population error:", e);
                }
              } else if (typeof window.populateLocationCards === "function") {
                console.log("üë• Calling window.populateLocationCards fallback...");
                try {
                  window.populateLocationCards();
                  console.log("‚úÖ Fallback location cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Fallback cards population error:", e);
                }
              } else {
                console.error("‚ùå No therapist card population function found");
              }
              
            }, 200);
            
            // Backup attempt
            setTimeout(function() {
              console.log("üîÑ Backup attempt for map and cards...");
              if (typeof initializeMapContainer === "function") initializeMapContainer();
              if (typeof window.forcePopulateLocationCards === "function") window.forcePopulateLocationCards();
              if (typeof window.populateLocationCards === "function") window.populateLocationCards();
            }, 500);
            
          }
          return false;
        };
        console.log("‚úÖ Location button fixed");      }
      
    }, 500);
        renderAppointmentsSessions(calendarStateSessions.selectedDate);
        break;
        
      case 'emotia':
        dashboardSections.classList.add('hidden');
        sessionsSections.classList.add('hidden');
        emotiaSections.classList.remove('hidden');
        journaliaSections.classList.add('hidden');
        momentumSections.classList.add('hidden');
        // Force rendering of mood stats charts when the Emotia tab is clicked
        setTimeout(function() {
          if (typeof emotiaRenderEmotionsBubbleChart === 'function') {
            emotiaRenderEmotionsBubbleChart("week"); 
            emotiaRenderPositivityChart("week");
          }
          // Initialize mood analysis chart
          if (typeof renderMoodAnalysisChart === "function") {
            renderMoodAnalysisChart("week");
          }
          if (typeof initializeMoodAnalysisChart === "function") {
            setTimeout(initializeMoodAnalysisChart, 300);
          }
        }, 200);
        break;
        
      case 'journalia':
        dashboardSections.classList.add('hidden');
        sessionsSections.classList.add('hidden');
        emotiaSections.classList.add('hidden');
        journaliaSections.classList.remove('hidden');
        momentumSections.classList.add('hidden');
        // Initialize Journalia sections if not already done
        initializeJournalia();
        break;
        
      case 'momentum':
        dashboardSections.classList.add('hidden');
        sessionsSections.classList.add('hidden');
        emotiaSections.classList.add('hidden');
        journaliaSections.classList.add('hidden');
        momentumSections.classList.remove('hidden');
        // Initialize Momentum sections if not already done
        initializeMomentum();
        // Ensure beehive icons are visible after tab switch with multiple checks
        setTimeout(() => {
          const circlesArr = document.getElementsByClassName("circle");
          if (circlesArr.length > 0) {
            for (let i = 0; i < circlesArr.length; i++) {
              circlesArr[i].style.display = 'block';
              circlesArr[i].style.visibility = 'visible';
              circlesArr[i].style.opacity = '1';
            }
          } else {
            // If no circles found, force re-initialization
            console.log('No circles found after tab switch, forcing re-initialization...');
            setTimeout(() => {
              const circles = document.getElementsByClassName("circles")[0];
              if (circles) {
                circles.innerHTML = '';
                initializeBeehive();
              }
            }, 50);
          }
        }, 100);

// Immediate setup as backup
(function() {
})();        break;
        
      case 'language':
      case 'settings':
        // Handle these sections as needed
        console.log(`${section} clicked`);
        break;
        
      case 'logout':
        // Handle logout
        if (confirm('Are you sure you want to logout?')) {
          // Add logout logic here
          console.log('Logout confirmed');
        }
        break;
    }
    
    // Scroll to top of content
    document.getElementById('main-content').scrollTo({ top: 0, behavior: 'smooth' });
  });
});

// Set Dashboard as active by default
const dashboardMenuItem = document.querySelector('.menu-item[data-section="dashboard"]');
if (dashboardMenuItem) {
  dashboardMenuItem.classList.add('active');
}
// ... existing code ...
</script>

<script>
// --- Sessions calendar/appointments logic ---
const todayDateSessions = new Date();
const appointmentsSessions = [
  { id: 100, therapist: 'Dr. Amelia Felix', role: 'Clinical Psychologist', location: 'Leoforos Galatsiou 92, Athens', date: '2025-05-20', time: '14:00 - 15:00', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBdijaA3DKytEIM8SGf6ukTSbTbdt1a77BKOsVP2BBCI6Mpii4PONFNs8Vm5A9TYgcOVYWre5pyQZFAXLIag3yJZ_5FbwYUMM2MRd76RqKaDyXY76qi0A6_A2v4Pptghg8GQMTKPZbcuJD0XFFYY6gTInWcKge63Wt0Mx5-p8w6qBgf4fHc7O586jt8BJgCHFCdwHStE6ZVTsLACpS30OLznb1lXsbiK8BltV8NSvSs3Ic12jsyYMXVFGVPntn20P0NYk5Gy9gdjX7Q', completed: true },
  { id: 101, therapist: 'Dr. John Locke', role: 'Counsellor Therapist', location: 'Mesologiou 7, Kaisariani', date: '2025-05-28', time: '11:00 - 12:00', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBInMXwIzV3tNDPBR9nJVFo_HnK3Nn3alr57DdSD4rCwlDNoVOcQbpmXGxsL-LpGp65uaTTRhMy5mw2653Liyb19cimWKAJSw_e-vNzWjdk-JGS-IA1JF8STMJ669a43XpZyj8B95J8GoyyvO0HiOQW5CxDYcIL0qvUHjvT-yecokgCpgGu9CEUhY1_-BkzQG1x2VIzn01sBaucN2cgwihr7fWWVVIFvapq-ZbCtcHrTntTFRV0ZtDLjyPy7nHRAJemdO41uB_svsR2', completed: true },
  { id: 102, therapist: 'Dr. Maria Papadopoulou', role: 'Psychiatrist', location: 'Kifisias 10, Marousi', date: '2025-06-01', time: '10:00 - 11:00', image: 'https://randomuser.me/api/portraits/women/44.jpg', completed: true },
  { id: 1, therapist: 'Dr. Amelia Felix', role: 'Clinical Psychologist', location: 'Leoforos Galatsiou 92, Athens', date: '2025-06-11', time: '14:00 - 15:00', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBdijaA3DKytEIM8SGf6ukTSbTbdt1a77BKOsVP2BBCI6Mpii4PONFNs8Vm5A9TYgcOVYWre5pyQZFAXLIag3yJZ_5FbwYUMM2MRd76RqKaDyXY76qi0A6_A2v4Pptghg8GQMTKPZbcuJD0XFFYY6gTInWcKge63Wt0Mx5-p8w6qBgf4fHc7O586jt8BJgCHFCdwHStE6ZVTsLACpS30OLznb1lXsbiK8BltV8NSvSs3Ic12jsyYMXVFGVPntn20P0NYk5Gy9gdjX7Q' },
  { id: 2, therapist: 'Dr. John Locke', role: 'Counsellor Therapist', location: 'Mesologiou 7, Kaisariani', date: '2025-06-11', time: '11:00 - 12:00', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBInMXwIzV3tNDPBR9nJVFo_HnK3Nn3alr57DdSD4rCwlDNoVOcQbpmXGxsL-LpGp65uaTTRhMy5mw2653Liyb19cimWKAJSw_e-vNzWjdk-JGS-IA1JF8STMJ669a43XpZyj8B95J8GoyyvO0HiOQW5CxDYcIL0qvUHjvT-yecokgCpgGu9CEUhY1_-BkzQG1x2VIzn01sBaucN2cgwihr7fWWVVIFvapq-ZbCtcHrTntTFRV0ZtDLjyPy7nHRAJemdO41uB_svsR2' },
  { id: 3, therapist: 'Dr. Maria Papadopoulou', role: 'Psychiatrist', location: 'Kifisias 10, Marousi', date: '2025-06-15', time: '10:00 - 11:00', image: 'https://randomuser.me/api/portraits/women/44.jpg' },
  { id: 4, therapist: 'Dr. George Smith', role: 'Therapist', location: 'Patision 100, Athens', date: '2025-06-18', time: '16:00 - 17:00', image: 'https://randomuser.me/api/portraits/men/32.jpg' },
  { id: 5, therapist: 'Dr. Eleni Kosta', role: 'Clinical Psychologist', location: 'Vouliagmenis 200, Glyfada', date: '2025-06-22', time: '09:00 - 10:00', image: 'https://randomuser.me/api/portraits/women/65.jpg' },
  { id: 6, therapist: 'Dr. Nikos Alexiou', role: 'Therapist', location: 'Sygrou 50, Athens', date: '2025-06-25', time: '13:00 - 14:00', image: 'https://randomuser.me/api/portraits/men/45.jpg' },
  { id: 7, therapist: 'Dr. Anna Vasileiou', role: 'Counsellor', location: 'Ermou 12, Athens', date: '2025-06-28', time: '15:00 - 16:00', image: 'https://randomuser.me/api/portraits/women/68.jpg' },
  { id: 8, therapist: 'Dr. Kostas Petrou', role: 'Psychiatrist', location: 'Panepistimiou 30, Athens', date: '2025-07-02', time: '12:00 - 13:00', image: 'https://randomuser.me/api/portraits/men/50.jpg' },
  { id: 9, therapist: 'Dr. Sofia Markou', role: 'Therapist', location: 'Akadimias 15, Athens', date: '2025-07-05', time: '10:00 - 11:00', image: 'https://randomuser.me/api/portraits/women/70.jpg' },
  { id: 10, therapist: 'Dr. Dimitris Lykos', role: 'Clinical Psychologist', location: 'Solonos 22, Athens', date: '2025-07-08', time: '14:00 - 15:00', image: 'https://randomuser.me/api/portraits/men/60.jpg' },
  { id: 11, therapist: 'Dr. Maria Ioannou', role: 'Counsellor', location: 'Stadiou 5, Athens', date: '2025-07-12', time: '11:00 - 12:00', image: 'https://randomuser.me/api/portraits/women/80.jpg' },
  { id: 12, therapist: 'Dr. Panos Georgiou', role: 'Therapist', location: 'Omonias 1, Athens', date: '2025-07-15', time: '16:00 - 17:00', image: 'https://randomuser.me/api/portraits/men/70.jpg' },
  { id: 13, therapist: 'Dr. Eleni Papadaki', role: 'Clinical Psychologist', location: 'Kallirois 18, Athens', date: '2025-07-18', time: '09:00 - 10:00', image: 'https://randomuser.me/api/portraits/women/90.jpg' },
  { id: 14, therapist: 'Dr. Giannis Kotsis', role: 'Psychiatrist', location: 'Vasilissis Sofias 40, Athens', date: '2025-07-22', time: '13:00 - 14:00', image: 'https://randomuser.me/api/portraits/men/80.jpg' },
  { id: 15, therapist: 'Dr. Katerina Mela', role: 'Therapist', location: 'Mitropoleos 8, Athens', date: '2025-07-25', time: '15:00 - 16:00', image: 'https://randomuser.me/api/portraits/women/95.jpg' },
  { id: 16, therapist: 'Dr. Nikos Papas', role: 'Counsellor', location: 'Peiraios 100, Athens', date: '2025-07-28', time: '10:00 - 11:00', image: 'https://randomuser.me/api/portraits/men/90.jpg' },
];
const monthsSessions = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
let calendarStateSessions = {
  year: 2025,
  month: 5, // June (0-indexed)
  selectedDate: new Date().toISOString().slice(0, 10),
  showDropdown: false
};
function renderCalendarSessions(selectedDate) {
  const today = new Date();
  const { year, month } = calendarStateSessions;
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  const calendar = document.getElementById('calendar-sessions');
  if (!calendar) return;
  calendar.innerHTML = '';
  // Header
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between mb-4 w-full max-w-lg relative';
  header.innerHTML = `
    <button id="prev-month-sessions" class="p-2 rounded-full hover:bg-gray-100"><span class="material-icons text-gray-600">chevron_left</span></button>
    <button id="calendar-month-year-sessions" class="calendar-month-year-btn">${monthsSessions[month]} <span class="font-normal">${year}</span> <span class="material-icons text-base">expand_more</span></button>
    <button id="next-month-sessions" class="p-2 rounded-full hover:bg-gray-100"><span class="material-icons text-gray-600">chevron_right</span></button>
  `;
  calendar.appendChild(header);
  // Days of week
  const daysRow = document.createElement('div');
  daysRow.className = 'grid grid-cols-7 gap-2 text-center text-sm text-gray-500 mb-2 w-full max-w-lg';
  daysRow.innerHTML = ['Mo','Tu','We','Th','Fr','Sa','Su'].map(d => `<span class="font-semibold">${d}</span>`).join('');
  calendar.appendChild(daysRow);
  // Dates grid
  const grid = document.createElement('div');
  grid.className = 'grid grid-cols-7 gap-2 text-center w-full max-w-lg';
  let dayCells = [];
  let dayOfWeek = (firstDay + 6) % 7; // Adjust so Monday is first
  for (let i = 0; i < dayOfWeek; i++) {
    grid.appendChild(document.createElement('span'));
  }
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${(month+1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === d;
    const isSelected = selectedDate === dateStr;
    const hasAppointment = appointmentsSessions.some(a => a.date === dateStr);
    const nextAppointment = appointmentsSessions.find(a => new Date(a.date) > today);
    const isNext = nextAppointment && nextAppointment.date === dateStr && (year > today.getFullYear() || month > today.getMonth() || d >= today.getDate());
    const cell = document.createElement('button');
    cell.className = 'calendar-date-btn rounded-full w-10 h-10 flex items-center justify-center font-bold transition-all duration-200';
    cell.textContent = d;
    if (isToday) cell.className += ' bg-purple-200 text-purple-700';
    if (isSelected) cell.className += ' bg-purple-500 text-white selected';
    if (isNext) cell.className += ' ring-2 ring-purple-700';
    if (hasAppointment && !isSelected && !isToday) cell.className += ' bg-purple-100 text-purple-700';
    cell.addEventListener('click', () => {
      calendarStateSessions.selectedDate = dateStr;
      renderCalendarSessions(dateStr);
      renderAppointmentsSessions(dateStr);
    });
    grid.appendChild(cell);
    dayCells.push(cell);
  }
          <!-- Glassmorphism Submissions Card -->
              <div class="relative w-full h-[300px]">
                <canvas id="mood-stats-monthly-line" width="100%" height="300"></canvas>
        </div>
        </div>
            <div class="flex-1 flex flex-col justify-center relative overflow-hidden rounded-2xl p-6 min-h-[320px] info-panel">
              <!-- Gradient background -->
              <div class="absolute inset-0 bg-gradient-to-br from-indigo-50 to-blue-50/40"></div>
              <!-- Decorative elements -->
              <div class="absolute top-0 right-0 w-64 h-64 rounded-full bg-gradient-to-br from-indigo-200/20 to-blue-100/20 blur-xl -translate-x-32 -translate-y-32"></div>
              <div class="absolute bottom-0 left-0 w-64 h-64 rounded-full bg-gradient-to-br from-blue-100/20 to-indigo-200/20 blur-xl translate-x-32 translate-y-32"></div>
              
              <!-- Content container -->
              <div class="relative z-10 flex flex-col h-full">
                <div class="flex items-center mb-4">
                  <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gradient-to-r from-indigo-600 to-blue-500 shadow-lg mr-3 border border-white">
                    <span class="material-icons text-white text-xl">trending_up</span>
        </div>
                  <div>
                    <h3 class="text-xl font-semibold text-indigo-700">Emotional Journey</h3>
                    <p class="text-xs text-gray-500">Your tracking progress over time</p>
                    </button>
        </div>
        </div>
                
                <div id="mood-stats-monthly-explanation" class="text-gray-600 text-base mb-4 p-3 bg-white/70 rounded-lg backdrop-blur-sm border border-indigo-100/80 shadow-sm relative overflow-hidden">
                  <div class="absolute top-0 left-0 w-2 h-full bg-gradient-to-b from-indigo-400 to-blue-500"></div>
                  <p class="ml-4 text-sm">This timeline shows your mood tracking activity over months, helping you visualize your consistency and emotional journey.</p>
        </div>
                
                <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                  <ul id="mood-stats-monthly-list" class="grid grid-cols-1 gap-2"></ul>
                  <div id="monthly-list-expand" class="hidden mt-3 text-center">
                    <button class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg transition-all shadow-sm see-more-btn">
                      <span class="expand-text">See More</span>
                      <span class="collapse-text hidden">See Less</span>
                    </button>
        </div>
        </div>
                </button>
        </div>
              </button>
        </div>
        </div>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
// --- Latest Articles Section Logic ---
const articles = [
  {
    title: 'How to Cope with Anxiety in Uncertain Times',
    image: 'https://images.unsplash.com/photo-1515378791036-46273834b3fb?auto=format&fit=crop&w=400&q=80',
    author: 'Dr. Maria Papadopoulou',
    date: '2024-06-18',
    description: 'Explore practical strategies and expert advice for managing anxiety during periods of uncertainty and change.'
  },
  {
    title: 'The Power of Mindfulness for Mental Health',
    image: 'https://images.unsplash.com/photo-1465101178521-c1a9136a3b43?auto=format&fit=crop&w=400&q=80',
    author: 'Nikos Alexiou, MSc',
    date: '2024-06-15',
    description: 'Learn how mindfulness practices can improve your emotional well-being and reduce stress.'
  },
  {
    title: 'Building Resilience: Tips for Everyday Life',
    image: 'https://images.unsplash.com/photo-1503676382389-4809596d5290?auto=format&fit=crop&w=400&q=80',
    author: 'Eleni Kosta, PhD',
    date: '2024-06-12',
    description: 'Discover simple ways to build resilience and bounce back from life\'s challenges.'
  },
  {
    title: 'Understanding Burnout and How to Prevent It',
    image: 'https://images.unsplash.com/photo-1462536943532-57a629f6cc60?auto=format&fit=crop&w=400&q=80',
    author: 'Dr. John Locke',
    date: '2024-06-10',
    description: 'Recognize the signs of burnout and learn actionable steps to protect your mental health.'
  },
  {
    title: 'The Importance of Social Support',
    image: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=400&q=80',
    author: 'Anna Vasileiou, LCSW',
    date: '2024-06-08',
    description: 'Understand why social connections matter and how to strengthen your support network.'
  }
];
const articlesCards = document.getElementById('articles-cards');
articles.forEach(article => {
  const card = document.createElement('div');
  card.className = 'flex-shrink-0 w-80 bg-gradient-to-br from-purple-50 to-white rounded-[32px] shadow-xl border border-[#ece6fc] p-6 flex flex-col gap-4 transition-transform duration-200 hover:scale-105';
  card.innerHTML = `
    <img src="${article.image}" alt="${article.title}" class="w-full h-40 object-cover rounded-2xl mb-2 shadow-md" />
    <h3 class="text-lg font-bold text-purple-700 mb-1" style="font-family: 'Helvetica Neue', Arial, sans-serif;">${article.title}</h3>
    <div class="flex items-center gap-2 text-xs text-gray-500 mb-1">
      <span class="material-icons text-base align-middle text-purple-400 mr-1">person</span>${article.author}
      <span class="material-icons text-base align-middle text-purple-400 ml-3 mr-1">calendar_today</span>${article.date}
    </div>
    <p class="text-gray-700 text-base mb-2" style="font-family: 'Inter', sans-serif;">${article.description}</p>
    <button class="mt-auto bg-purple-600 text-white py-2 px-6 rounded-full text-base font-semibold shadow-md hover:bg-purple-700 transition-all">Read More</button>
  `;
  articlesCards.appendChild(card);
});
</script>

<script>
// Enable drag-to-scroll for horizontally scrollable containers
function enableDragScroll(container) {
  let isDown = false;
  let startX;
  let scrollLeft;

  container.addEventListener('mousedown', (e) => {
    isDown = true;
    container.classList.add('cursor-grabbing');
    startX = e.pageX - container.offsetLeft;
    scrollLeft = container.scrollLeft;
  });
  container.addEventListener('mouseleave', () => {
    isDown = false;
    container.classList.remove('cursor-grabbing');
  });
  container.addEventListener('mouseup', () => {
    isDown = false;
    container.classList.remove('cursor-grabbing');
  });
  container.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - container.offsetLeft;
    const walk = (x - startX) * 1.2; // scroll-fast
    container.scrollLeft = scrollLeft - walk;
  });
  // Touch events for mobile
  container.addEventListener('touchstart', (e) => {
    isDown = true;
    startX = e.touches[0].pageX - container.offsetLeft;
    scrollLeft = container.scrollLeft;
  });
  container.addEventListener('touchend', () => {
    isDown = false;
  });
  container.addEventListener('touchmove', (e) => {
    if (!isDown) return;
    const x = e.touches[0].pageX - container.offsetLeft;
    const walk = (x - startX) * 1.2;
    container.scrollLeft = scrollLeft - walk;
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const coursesCards = document.getElementById('courses-cards');
  const articlesCards = document.getElementById('articles-cards');
  if (coursesCards) enableDragScroll(coursesCards);
  if (articlesCards) enableDragScroll(articlesCards);
});
</script>

<script>
// Liquid Glass Menu Bar Logic
const menuToggle = document.getElementById("menu-toggle");
const menuContainer = document.getElementById("menu-container");
const menuContent = document.getElementById("menu-content");
const menuIcon = document.getElementById("menu-icon");
const menuIconMaterial = document.getElementById("menu-icon-material");
const closeIconMaterial = document.getElementById("close-icon-material");
const menuItems = document.querySelectorAll(".menu-item");

// Calculate dynamic height
const topOffset = parseFloat(getComputedStyle(menuContent).top);
const menuContentHeight = menuContent.offsetHeight;
const requiredH = topOffset + menuContentHeight;

let isMenuOpen = false;

function toggleMenu() {
  isMenuOpen = !isMenuOpen;
  
  if (isMenuOpen) {
    menuToggle.classList.add('expanded');
    menuIconMaterial.style.opacity = '0';
    closeIconMaterial.style.opacity = '1';
  } else {
    menuToggle.classList.remove('expanded');
    menuIconMaterial.style.opacity = '1';
    closeIconMaterial.style.opacity = '0';
  }
}

menuToggle.addEventListener("click", (event) => {
  event.stopPropagation();
  toggleMenu();
});

document.addEventListener("click", () => {
  if (isMenuOpen) {
    toggleMenu();
  }
});

// Add click handlers for menu items
menuItems.forEach(item => {
  item.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const section = this.dataset.section;
    
    // Handle settings popup
    if (section === 'settings') {
      document.getElementById('settings-popup').classList.remove('hidden');
      toggleMenu(); // Close menu
      return;
    }
    
    // Remove active class from all menu items
    menuItems.forEach(menuItem => menuItem.classList.remove('active'));
    // Add active class to clicked item
    this.classList.add('active');
    
    // Close menu after selection
    toggleMenu();
    
    // Switch sections based on clicked item
    switchToSection(section);
  });
});

// Settings popup handlers
document.getElementById('close-settings').addEventListener('click', function() {
  document.getElementById('settings-popup').classList.add('hidden');
});

document.getElementById('settings-popup').addEventListener('click', function(e) {
  if (e.target === this) {
    this.classList.add('hidden');
  }
});

document.getElementById('settings-language').addEventListener('click', function() {
  // Handle language selection
  console.log('Language settings clicked');
  // You can implement language switching logic here
});

document.getElementById('settings-logout').addEventListener('click', function() {
  // Handle logout
  if (confirm('Are you sure you want to logout?')) {
    // Redirect to login page or handle logout
    window.location.href = 'auth.html';
  }
});

function switchToSection(sectionName) {
  // Hide all sections first
  const allSections = ['dashboard', 'sessions', 'emotia', 'journalia', 'momentum'];
  allSections.forEach(section => {
    const sectionElement = document.getElementById(`${section}-sections`);
    if (sectionElement) {
      sectionElement.classList.add('hidden');
    }
  });
  
  // Show the selected section
  const targetSection = document.getElementById(`${sectionName}-sections`);
  if (targetSection) {
    targetSection.classList.remove('hidden');
  }
  
  // Handle special section initialization
  switch(sectionName) {
    case 'sessions':
      if (typeof renderCalendarSessions === 'function') {
        renderCalendarSessions(calendarStateSessions.selectedDate);
    
    // FIX THERAPIST BUTTONS IMMEDIATELY WHEN SESSIONS TAB IS CLICKED
    setTimeout(function() {
      console.log("üîß Fixing therapist buttons after sessions tab click...");
      
      // Fix Find Therapist Button
      const findBtn = document.getElementById("find-therapist-btn");
      if (findBtn) {
        findBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Find Therapist clicked!");
          const step1 = document.getElementById("therapist-step-1");
          const step2 = document.getElementById("therapist-step-2");
          if (step1 && step2) {
            step1.style.display = "none";
            step1.classList.add("hidden");
            step2.style.display = "block";
            step2.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 2");
          }
          return false;
        };
        console.log("‚úÖ Find Therapist button fixed");
      }
      
      // Fix Location Button
      const locationBtn = document.querySelector(".location-gradient");
      if (locationBtn) {
        locationBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Location clicked!");
          const step2 = document.getElementById("therapist-step-2");
          const step3 = document.getElementById("therapist-step-3-location");
          if (step2 && step3) {
            step2.style.display = "none";
            step2.classList.add("hidden");
            step3.style.display = "block";
            step3.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 3");
            
            // Enhanced map and cards initialization
            setTimeout(function() {
              console.log("üó∫Ô∏è Initializing map and cards...");
              
              // Force map initialization
              if (typeof initializeMapContainer === "function") {
                console.log("üìç Calling initializeMapContainer...");
                try {
                  initializeMapContainer();
                  console.log("‚úÖ Map initialized successfully");
                } catch (e) {
                  console.error("‚ùå Map initialization error:", e);
                }
              } else {
                console.error("‚ùå initializeMapContainer function not found");
              }
              
              // Force therapist cards population
              if (typeof window.forcePopulateLocationCards === "function") {
                console.log("üë• Calling window.forcePopulateLocationCards...");
                try {
                  window.forcePopulateLocationCards();
                  console.log("‚úÖ Location therapist cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Cards population error:", e);
                }
              } else if (typeof window.populateLocationCards === "function") {
                console.log("üë• Calling window.populateLocationCards fallback...");
                try {
                  window.populateLocationCards();
                  console.log("‚úÖ Fallback location cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Fallback cards population error:", e);
                }
              } else {
                console.error("‚ùå No therapist card population function found");
              }
              
            }, 200);
            
            // Backup attempt
            setTimeout(function() {
              console.log("üîÑ Backup attempt for map and cards...");
              if (typeof initializeMapContainer === "function") initializeMapContainer();
              if (typeof window.forcePopulateLocationCards === "function") window.forcePopulateLocationCards();
              if (typeof window.populateLocationCards === "function") window.populateLocationCards();
            }, 500);
            
          }
          return false;
        };
        console.log("‚úÖ Location button fixed");      }
      
    }, 500);
        renderAppointmentsSessions(calendarStateSessions.selectedDate);
      }
      break;
    case 'emotia':
      setTimeout(function() {
        if (typeof emotiaRenderEmotionsBubbleChart === 'function') {
          emotiaRenderEmotionsBubbleChart("week");
          emotiaRenderPositivityChart("week");
        }
      }, 200);
      break;
    case 'journalia':
      if (typeof initializeJournalia === 'function') {
        initializeJournalia();
      }
      break;
    case 'momentum':
      if (typeof initializeMomentum === 'function') {
        initializeMomentum();
      }
      break;
  }
  
  // Scroll to top of content
  document.getElementById('main-content').scrollTo({ top: 0, behavior: 'smooth' });
}

// Fixed grey styling - no dynamic color switching needed

  // Set initial active state for dashboard
  document.addEventListener('DOMContentLoaded', function() {
    // Set dashboard as active by default
    const dashboardMenuItem = document.querySelector('.menu-item[data-section="dashboard"]');
    if (dashboardMenuItem) {
      dashboardMenuItem.classList.add('active');
    }
  });
</script>

<style>
/* Sidebar transition and hidden state */
#sidebar {
  transition: transform 0.35s cubic-bezier(.4,2,.6,1), margin 0.35s cubic-bezier(.4,2,.6,1);
  will-change: transform, margin;
  z-index: 40;
}
.sidebar-toggle-btn {
  transition: left 0.35s cubic-bezier(.4,2,.6,1), background 0.2s;
}
.sidebar-logo-gradient {
  user-select: none;
  background: linear-gradient(90deg, #7b61ff 0%, #60a5fa 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-fill-color: transparent;
  text-shadow: 0 4px 24px rgba(123,97,255,0.18);
}
</style>

<script>
// SPA-like section switching logic
const sidebarLinks = document.querySelectorAll('.sidebar-item');
const dashboardSections = document.getElementById('dashboard-sections');
const sessionsSections = document.getElementById('sessions-sections');
const emotiaSections = document.getElementById('emotia-sections');
const journaliaSections = document.createElement('div');
journaliaSections.id = 'journalia-sections';
journaliaSections.className = 'flex flex-col gap-8 hidden';
document.getElementById('main-content').appendChild(journaliaSections);
const momentumSections = document.createElement('div');
momentumSections.id = 'momentum-sections';
momentumSections.className = 'flex flex-col gap-8 hidden';
document.getElementById('main-content').appendChild(momentumSections);

const dashboardSidebarLink = Array.from(sidebarLinks).find(link => link.textContent.includes('Dashboard'));
const sessionsSidebarLink = Array.from(sidebarLinks).find(link => link.textContent.includes('Sessions'));
const emotiaSidebarLink = Array.from(sidebarLinks).find(link => link.textContent.includes('Emotia'));
const journaliaSidebarLink = Array.from(sidebarLinks).find(link => link.textContent.includes('Journalia'));
const momentumSidebarLink = Array.from(sidebarLinks).find(link => link.textContent.includes('Momentum'));

if (dashboardSidebarLink && sessionsSidebarLink && emotiaSidebarLink && journaliaSidebarLink && momentumSidebarLink) {
  dashboardSidebarLink.addEventListener('click', function(e) {
    e.preventDefault();
    dashboardSections.classList.remove('hidden');
    sessionsSections.classList.add('hidden');
    emotiaSections.classList.add('hidden');
    journaliaSections.classList.add('hidden');
    momentumSections.classList.add('hidden');
    sidebarLinks.forEach(link => link.classList.remove('active'));
    dashboardSidebarLink.classList.add('active');
    
    // Scroll to top of content
    document.getElementById('main-content').scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  sessionsSidebarLink.addEventListener('click', function(e) {
    e.preventDefault();
    dashboardSections.classList.add('hidden');
    sessionsSections.classList.remove('hidden');
    emotiaSections.classList.add('hidden');
    journaliaSections.classList.add('hidden');
    momentumSections.classList.add('hidden');
    sidebarLinks.forEach(link => link.classList.remove('active'));
    sessionsSidebarLink.classList.add('active');
    // Render sessions calendar/appointments if not already rendered
    renderCalendarSessions(calendarStateSessions.selectedDate);
    
    // FIX THERAPIST BUTTONS IMMEDIATELY WHEN SESSIONS TAB IS CLICKED
    setTimeout(function() {
      console.log("üîß Fixing therapist buttons after sessions tab click...");
      
      // Fix Find Therapist Button
      const findBtn = document.getElementById("find-therapist-btn");
      if (findBtn) {
        findBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Find Therapist clicked!");
          const step1 = document.getElementById("therapist-step-1");
          const step2 = document.getElementById("therapist-step-2");
          if (step1 && step2) {
            step1.style.display = "none";
            step1.classList.add("hidden");
            step2.style.display = "block";
            step2.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 2");
          }
          return false;
        };
        console.log("‚úÖ Find Therapist button fixed");
      }
      
      // Fix Location Button
      const locationBtn = document.querySelector(".location-gradient");
      if (locationBtn) {
        locationBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Location clicked!");
          const step2 = document.getElementById("therapist-step-2");
          const step3 = document.getElementById("therapist-step-3-location");
          if (step2 && step3) {
            step2.style.display = "none";
            step2.classList.add("hidden");
            step3.style.display = "block";
            step3.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 3");
            
            // Enhanced map and cards initialization
            setTimeout(function() {
              console.log("üó∫Ô∏è Initializing map and cards...");
              
              // Force map initialization
              if (typeof initializeMapContainer === "function") {
                console.log("üìç Calling initializeMapContainer...");
                try {
                  initializeMapContainer();
                  console.log("‚úÖ Map initialized successfully");
                } catch (e) {
                  console.error("‚ùå Map initialization error:", e);
                }
              } else {
                console.error("‚ùå initializeMapContainer function not found");
              }
              
              // Force therapist cards population
              if (typeof window.forcePopulateLocationCards === "function") {
                console.log("üë• Calling window.forcePopulateLocationCards...");
                try {
                  window.forcePopulateLocationCards();
                  console.log("‚úÖ Location therapist cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Cards population error:", e);
                }
              } else if (typeof window.populateLocationCards === "function") {
                console.log("üë• Calling window.populateLocationCards fallback...");
                try {
                  window.populateLocationCards();
                  console.log("‚úÖ Fallback location cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Fallback cards population error:", e);
                }
              } else {
                console.error("‚ùå No therapist card population function found");
              }
              
            }, 200);
            
            // Backup attempt
            setTimeout(function() {
              console.log("üîÑ Backup attempt for map and cards...");
              if (typeof initializeMapContainer === "function") initializeMapContainer();
              if (typeof window.forcePopulateLocationCards === "function") window.forcePopulateLocationCards();
              if (typeof window.populateLocationCards === "function") window.populateLocationCards();
            }, 500);
            
          }
          return false;
        };
        console.log("‚úÖ Location button fixed");      }
      
    }, 500);
    renderAppointmentsSessions(calendarStateSessions.selectedDate);
    
    // Scroll to top of content
    document.getElementById('main-content').scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  emotiaSidebarLink.addEventListener('click', function(e) {
    e.preventDefault();
    dashboardSections.classList.add('hidden');
    sessionsSections.classList.add('hidden');
    emotiaSections.classList.remove('hidden');
    journaliaSections.classList.add('hidden');
    momentumSections.classList.add('hidden');
    sidebarLinks.forEach(link => link.classList.remove('active'));
    emotiaSidebarLink.classList.add('active');
    
    // Force rendering of mood stats charts when the Emotia tab is clicked
    // This ensures all charts display immediately without needing to click a filter
    setTimeout(function() {
      if (typeof emotiaRenderEmotionsBubbleChart === 'function') {
        emotiaRenderEmotionsBubbleChart("week"); emotiaRenderPositivityChart("week");
      }
    }, 200);
    
    // Scroll to top of content
    document.getElementById('main-content').scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  journaliaSidebarLink.addEventListener('click', function(e) {
    e.preventDefault();
    dashboardSections.classList.add('hidden');
    sessionsSections.classList.add('hidden');
    emotiaSections.classList.add('hidden');
    journaliaSections.classList.remove('hidden');
    momentumSections.classList.add('hidden');
    sidebarLinks.forEach(link => link.classList.remove('active'));
    journaliaSidebarLink.classList.add('active');
    
    // Initialize Journalia sections if not already done
    initializeJournalia();
    
    // Scroll to top of content
    document.getElementById('main-content').scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  momentumSidebarLink.addEventListener('click', function(e) {
    e.preventDefault();
    dashboardSections.classList.add('hidden');
    sessionsSections.classList.add('hidden');
    emotiaSections.classList.add('hidden');
    journaliaSections.classList.add('hidden');
    momentumSections.classList.remove('hidden');
    sidebarLinks.forEach(link => link.classList.remove('active'));
    momentumSidebarLink.classList.add('active');
    
    // Initialize Momentum sections if not already done
    initializeMomentum();
    
    // Force refresh beehive visibility after tab switch without reinitializing
    setTimeout(() => {
      const circlesArr = document.getElementsByClassName("circle");
      if (circlesArr.length > 0) {
        // Just refresh the visibility and positioning - DO NOT reinitialize
        for (let i = 0; i < circlesArr.length; i++) {
          circlesArr[i].style.display = 'block';
          circlesArr[i].style.visibility = 'visible';
          circlesArr[i].style.opacity = '1';
        }
      }
    }, 100);

// Immediate setup as backup
(function() {
})();    
    // Scroll to top of content
    document.getElementById('main-content').scrollTo({ top: 0, behavior: 'smooth' });
  });
}
// ... existing code ...
</script>

<script>
// --- Sessions calendar/appointments logic ---
const todayDateSessions = new Date();
const appointmentsSessions = [
  { id: 100, therapist: 'Dr. Amelia Felix', role: 'Clinical Psychologist', location: 'Leoforos Galatsiou 92, Athens', date: '2025-05-20', time: '14:00 - 15:00', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBdijaA3DKytEIM8SGf6ukTSbTbdt1a77BKOsVP2BBCI6Mpii4PONFNs8Vm5A9TYgcOVYWre5pyQZFAXLIag3yJZ_5FbwYUMM2MRd76RqKaDyXY76qi0A6_A2v4Pptghg8GQMTKPZbcuJD0XFFYY6gTInWcKge63Wt0Mx5-p8w6qBgf4fHc7O586jt8BJgCHFCdwHStE6ZVTsLACpS30OLznb1lXsbiK8BltV8NSvSs3Ic12jsyYMXVFGVPntn20P0NYk5Gy9gdjX7Q', completed: true },
  { id: 101, therapist: 'Dr. John Locke', role: 'Counsellor Therapist', location: 'Mesologiou 7, Kaisariani', date: '2025-05-28', time: '11:00 - 12:00', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBInMXwIzV3tNDPBR9nJVFo_HnK3Nn3alr57DdSD4rCwlDNoVOcQbpmXGxsL-LpGp65uaTTRhMy5mw2653Liyb19cimWKAJSw_e-vNzWjdk-JGS-IA1JF8STMJ669a43XpZyj8B95J8GoyyvO0HiOQW5CxDYcIL0qvUHjvT-yecokgCpgGu9CEUhY1_-BkzQG1x2VIzn01sBaucN2cgwihr7fWWVVIFvapq-ZbCtcHrTntTFRV0ZtDLjyPy7nHRAJemdO41uB_svsR2', completed: true },
  { id: 102, therapist: 'Dr. Maria Papadopoulou', role: 'Psychiatrist', location: 'Kifisias 10, Marousi', date: '2025-06-01', time: '10:00 - 11:00', image: 'https://randomuser.me/api/portraits/women/44.jpg', completed: true },
  { id: 1, therapist: 'Dr. Amelia Felix', role: 'Clinical Psychologist', location: 'Leoforos Galatsiou 92, Athens', date: '2025-06-11', time: '14:00 - 15:00', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBdijaA3DKytEIM8SGf6ukTSbTbdt1a77BKOsVP2BBCI6Mpii4PONFNs8Vm5A9TYgcOVYWre5pyQZFAXLIag3yJZ_5FbwYUMM2MRd76RqKaDyXY76qi0A6_A2v4Pptghg8GQMTKPZbcuJD0XFFYY6gTInWcKge63Wt0Mx5-p8w6qBgf4fHc7O586jt8BJgCHFCdwHStE6ZVTsLACpS30OLznb1lXsbiK8BltV8NSvSs3Ic12jsyYMXVFGVPntn20P0NYk5Gy9gdjX7Q' },
  { id: 2, therapist: 'Dr. John Locke', role: 'Counsellor Therapist', location: 'Mesologiou 7, Kaisariani', date: '2025-06-11', time: '11:00 - 12:00', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBInMXwIzV3tNDPBR9nJVFo_HnK3Nn3alr57DdSD4rCwlDNoVOcQbpmXGxsL-LpGp65uaTTRhMy5mw2653Liyb19cimWKAJSw_e-vNzWjdk-JGS-IA1JF8STMJ669a43XpZyj8B95J8GoyyvO0HiOQW5CxDYcIL0qvUHjvT-yecokgCpgGu9CEUhY1_-BkzQG1x2VIzn01sBaucN2cgwihr7fWWVVIFvapq-ZbCtcHrTntTFRV0ZtDLjyPy7nHRAJemdO41uB_svsR2' },
  { id: 3, therapist: 'Dr. Maria Papadopoulou', role: 'Psychiatrist', location: 'Kifisias 10, Marousi', date: '2025-06-15', time: '10:00 - 11:00', image: 'https://randomuser.me/api/portraits/women/44.jpg' },
  { id: 4, therapist: 'Dr. George Smith', role: 'Therapist', location: 'Patision 100, Athens', date: '2025-06-18', time: '16:00 - 17:00', image: 'https://randomuser.me/api/portraits/men/32.jpg' },
  { id: 5, therapist: 'Dr. Eleni Kosta', role: 'Clinical Psychologist', location: 'Vouliagmenis 200, Glyfada', date: '2025-06-22', time: '09:00 - 10:00', image: 'https://randomuser.me/api/portraits/women/65.jpg' },
  { id: 6, therapist: 'Dr. Nikos Alexiou', role: 'Therapist', location: 'Sygrou 50, Athens', date: '2025-06-25', time: '13:00 - 14:00', image: 'https://randomuser.me/api/portraits/men/45.jpg' },
  { id: 7, therapist: 'Dr. Anna Vasileiou', role: 'Counsellor', location: 'Ermou 12, Athens', date: '2025-06-28', time: '15:00 - 16:00', image: 'https://randomuser.me/api/portraits/women/68.jpg' },
  { id: 8, therapist: 'Dr. Kostas Petrou', role: 'Psychiatrist', location: 'Panepistimiou 30, Athens', date: '2025-07-02', time: '12:00 - 13:00', image: 'https://randomuser.me/api/portraits/men/50.jpg' },
  { id: 9, therapist: 'Dr. Sofia Markou', role: 'Therapist', location: 'Akadimias 15, Athens', date: '2025-07-05', time: '10:00 - 11:00', image: 'https://randomuser.me/api/portraits/women/70.jpg' },
  { id: 10, therapist: 'Dr. Dimitris Lykos', role: 'Clinical Psychologist', location: 'Solonos 22, Athens', date: '2025-07-08', time: '14:00 - 15:00', image: 'https://randomuser.me/api/portraits/men/60.jpg' },
  { id: 11, therapist: 'Dr. Maria Ioannou', role: 'Counsellor', location: 'Stadiou 5, Athens', date: '2025-07-12', time: '11:00 - 12:00', image: 'https://randomuser.me/api/portraits/women/80.jpg' },
  { id: 12, therapist: 'Dr. Panos Georgiou', role: 'Therapist', location: 'Omonias 1, Athens', date: '2025-07-15', time: '16:00 - 17:00', image: 'https://randomuser.me/api/portraits/men/70.jpg' },
  { id: 13, therapist: 'Dr. Eleni Papadaki', role: 'Clinical Psychologist', location: 'Kallirois 18, Athens', date: '2025-07-18', time: '09:00 - 10:00', image: 'https://randomuser.me/api/portraits/women/90.jpg' },
  { id: 14, therapist: 'Dr. Giannis Kotsis', role: 'Psychiatrist', location: 'Vasilissis Sofias 40, Athens', date: '2025-07-22', time: '13:00 - 14:00', image: 'https://randomuser.me/api/portraits/men/80.jpg' },
  { id: 15, therapist: 'Dr. Katerina Mela', role: 'Therapist', location: 'Mitropoleos 8, Athens', date: '2025-07-25', time: '15:00 - 16:00', image: 'https://randomuser.me/api/portraits/women/95.jpg' },
  { id: 16, therapist: 'Dr. Nikos Papas', role: 'Counsellor', location: 'Peiraios 100, Athens', date: '2025-07-28', time: '10:00 - 11:00', image: 'https://randomuser.me/api/portraits/men/90.jpg' },
];
const monthsSessions = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
let calendarStateSessions = {
  year: 2025,
  month: 5, // June (0-indexed)
  selectedDate: new Date().toISOString().slice(0, 10),
  showDropdown: false
};
function renderCalendarSessions(selectedDate) {
  const today = new Date();
  const { year, month } = calendarStateSessions;
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  const calendar = document.getElementById('calendar-sessions');
  if (!calendar) return;
  calendar.innerHTML = '';
  // Header
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between mb-4 w-full max-w-lg relative';
  header.innerHTML = `
    <button id="prev-month-sessions" class="p-2 rounded-full hover:bg-gray-100"><span class="material-icons text-gray-600">chevron_left</span></button>
    <button id="calendar-month-year-sessions" class="calendar-month-year-btn">${monthsSessions[month]} <span class="font-normal">${year}</span> <span class="material-icons text-base">expand_more</span></button>
    <button id="next-month-sessions" class="p-2 rounded-full hover:bg-gray-100"><span class="material-icons text-gray-600">chevron_right</span></button>
  `;
  calendar.appendChild(header);
  // Days of week
  const daysRow = document.createElement('div');
  daysRow.className = 'grid grid-cols-7 gap-2 text-center text-sm text-gray-500 mb-2 w-full max-w-lg';
  daysRow.innerHTML = ['Mo','Tu','We','Th','Fr','Sa','Su'].map(d => `<span class="font-semibold">${d}</span>`).join('');
  calendar.appendChild(daysRow);
  // Dates grid
  const grid = document.createElement('div');
  grid.className = 'grid grid-cols-7 gap-2 text-center w-full max-w-lg';
  let dayCells = [];
  let dayOfWeek = (firstDay + 6) % 7; // Adjust so Monday is first
  for (let i = 0; i < dayOfWeek; i++) {
    grid.appendChild(document.createElement('span'));
  }
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${(month+1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === d;
    const isSelected = selectedDate === dateStr;
    const hasAppointment = appointmentsSessions.some(a => a.date === dateStr);
    const nextAppointment = appointmentsSessions.find(a => new Date(a.date) > today);
    const isNext = nextAppointment && nextAppointment.date === dateStr && (year > today.getFullYear() || month > today.getMonth() || d >= today.getDate());
    const cell = document.createElement('button');
    cell.className = 'calendar-date-btn rounded-full w-10 h-10 flex items-center justify-center font-bold transition-all duration-200';
    cell.textContent = d;
    if (isToday) cell.className += ' bg-purple-200 text-purple-700';
    if (isSelected) cell.className += ' bg-purple-500 text-white selected';
    if (isNext) cell.className += ' ring-2 ring-purple-700';
    if (hasAppointment && !isSelected && !isToday) cell.className += ' bg-purple-100 text-purple-700';
    cell.addEventListener('click', () => {
      calendarStateSessions.selectedDate = dateStr;
      renderCalendarSessions(dateStr);
      renderAppointmentsSessions(dateStr);
    });
    grid.appendChild(cell);
    dayCells.push(cell);
  }
  calendar.appendChild(grid);
  // Event listeners
  header.querySelector('#prev-month-sessions').onclick = () => {
    if (calendarStateSessions.month === 0) {
      calendarStateSessions.month = 11;
      calendarStateSessions.year--;
    } else {
      calendarStateSessions.month--;
    }
    renderCalendarSessions(calendarStateSessions.selectedDate);
    
    // FIX THERAPIST BUTTONS IMMEDIATELY WHEN SESSIONS TAB IS CLICKED
    setTimeout(function() {
      console.log("üîß Fixing therapist buttons after sessions tab click...");
      
      // Fix Find Therapist Button
      const findBtn = document.getElementById("find-therapist-btn");
      if (findBtn) {
        findBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Find Therapist clicked!");
          const step1 = document.getElementById("therapist-step-1");
          const step2 = document.getElementById("therapist-step-2");
          if (step1 && step2) {
            step1.style.display = "none";
            step1.classList.add("hidden");
            step2.style.display = "block";
            step2.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 2");
          }
          return false;
        };
        console.log("‚úÖ Find Therapist button fixed");
      }
      
      // Fix Location Button
      const locationBtn = document.querySelector(".location-gradient");
      if (locationBtn) {
        locationBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Location clicked!");
          const step2 = document.getElementById("therapist-step-2");
          const step3 = document.getElementById("therapist-step-3-location");
          if (step2 && step3) {
            step2.style.display = "none";
            step2.classList.add("hidden");
            step3.style.display = "block";
            step3.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 3");
            
            // Enhanced map and cards initialization
            setTimeout(function() {
              console.log("üó∫Ô∏è Initializing map and cards...");
              
              // Force map initialization
              if (typeof initializeMapContainer === "function") {
                console.log("üìç Calling initializeMapContainer...");
                try {
                  initializeMapContainer();
                  console.log("‚úÖ Map initialized successfully");
                } catch (e) {
                  console.error("‚ùå Map initialization error:", e);
                }
              } else {
                console.error("‚ùå initializeMapContainer function not found");
              }
              
              // Force therapist cards population
              if (typeof window.forcePopulateLocationCards === "function") {
                console.log("üë• Calling window.forcePopulateLocationCards...");
                try {
                  window.forcePopulateLocationCards();
                  console.log("‚úÖ Location therapist cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Cards population error:", e);
                }
              } else if (typeof window.populateLocationCards === "function") {
                console.log("üë• Calling window.populateLocationCards fallback...");
                try {
                  window.populateLocationCards();
                  console.log("‚úÖ Fallback location cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Fallback cards population error:", e);
                }
              } else {
                console.error("‚ùå No therapist card population function found");
              }
              
            }, 200);
            
            // Backup attempt
            setTimeout(function() {
              console.log("üîÑ Backup attempt for map and cards...");
              if (typeof initializeMapContainer === "function") initializeMapContainer();
              if (typeof window.forcePopulateLocationCards === "function") window.forcePopulateLocationCards();
              if (typeof window.populateLocationCards === "function") window.populateLocationCards();
            }, 500);
            
          }
          return false;
        };
        console.log("‚úÖ Location button fixed");      }
      
    }, 500);
    renderAppointmentsSessions(calendarStateSessions.selectedDate);
  };
  header.querySelector('#next-month-sessions').onclick = () => {
    if (calendarStateSessions.month === 11) {
      calendarStateSessions.month = 0;
      calendarStateSessions.year++;
    } else {
      calendarStateSessions.month++;
    }
    renderCalendarSessions(calendarStateSessions.selectedDate);
    
    // FIX THERAPIST BUTTONS IMMEDIATELY WHEN SESSIONS TAB IS CLICKED
    setTimeout(function() {
      console.log("üîß Fixing therapist buttons after sessions tab click...");
      
      // Fix Find Therapist Button
      const findBtn = document.getElementById("find-therapist-btn");
      if (findBtn) {
        findBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Find Therapist clicked!");
          const step1 = document.getElementById("therapist-step-1");
          const step2 = document.getElementById("therapist-step-2");
          if (step1 && step2) {
            step1.style.display = "none";
            step1.classList.add("hidden");
            step2.style.display = "block";
            step2.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 2");
          }
          return false;
        };
        console.log("‚úÖ Find Therapist button fixed");
      }
      
      // Fix Location Button
      const locationBtn = document.querySelector(".location-gradient");
      if (locationBtn) {
        locationBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Location clicked!");
          const step2 = document.getElementById("therapist-step-2");
          const step3 = document.getElementById("therapist-step-3-location");
          if (step2 && step3) {
            step2.style.display = "none";
            step2.classList.add("hidden");
            step3.style.display = "block";
            step3.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 3");
            
            // Enhanced map and cards initialization
            setTimeout(function() {
              console.log("üó∫Ô∏è Initializing map and cards...");
              
              // Force map initialization
              if (typeof initializeMapContainer === "function") {
                console.log("üìç Calling initializeMapContainer...");
                try {
                  initializeMapContainer();
                  console.log("‚úÖ Map initialized successfully");
                } catch (e) {
                  console.error("‚ùå Map initialization error:", e);
                }
              } else {
                console.error("‚ùå initializeMapContainer function not found");
              }
              
              // Force therapist cards population
              if (typeof window.forcePopulateLocationCards === "function") {
                console.log("üë• Calling window.forcePopulateLocationCards...");
                try {
                  window.forcePopulateLocationCards();
                  console.log("‚úÖ Location therapist cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Cards population error:", e);
                }
              } else if (typeof window.populateLocationCards === "function") {
                console.log("üë• Calling window.populateLocationCards fallback...");
                try {
                  window.populateLocationCards();
                  console.log("‚úÖ Fallback location cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Fallback cards population error:", e);
                }
              } else {
                console.error("‚ùå No therapist card population function found");
              }
              
            }, 200);
            
            // Backup attempt
            setTimeout(function() {
              console.log("üîÑ Backup attempt for map and cards...");
              if (typeof initializeMapContainer === "function") initializeMapContainer();
              if (typeof window.forcePopulateLocationCards === "function") window.forcePopulateLocationCards();
              if (typeof window.populateLocationCards === "function") window.populateLocationCards();
            }, 500);
            
          }
          return false;
        };
        console.log("‚úÖ Location button fixed");      }
      
    }, 500);
    renderAppointmentsSessions(calendarStateSessions.selectedDate);
  };
  header.querySelector('#calendar-month-year-sessions').onclick = (e) => {
    e.stopPropagation();
    // No dropdown in this minimal version
  };
}
function renderAppointmentsSessions(selectedDate) {
  const list = document.getElementById('appointments-list-sessions');
  if (!list) return;
  list.innerHTML = '';
  // Always show next appointment on top
  const today = new Date();
  const next = appointmentsSessions.find(a => new Date(a.date) > today) || appointmentsSessions[0];
  if (next) {
    list.appendChild(appointmentCardSessions(next, true));
  }
  // Show appointments for selected date (except next)
  if (selectedDate) {
    const filtered = appointmentsSessions.filter(a => a.date === selectedDate && a.id !== next.id);
    filtered.forEach(a => list.appendChild(appointmentCardSessions(a, false)));
  }
}
function appointmentCardSessions(a, highlight) {
  const div = document.createElement('div');
  div.className = `bg-[#f8f7fa] rounded-2xl p-4 flex items-center gap-4 shadow-sm ${highlight ? 'ring-2 ring-purple-400' : ''}`;
  const isPast = new Date(a.date) < todayDateSessions;
  // Check if rated
  const feedback = window.sessionFeedback && window.sessionFeedback[a.id];
  const rated = feedback && feedback.rating > 0 && feedback.submitted;
  div.innerHTML = `
    <img alt="${a.therapist} profile picture" class="w-12 h-12 rounded-full object-cover border-2 border-purple-100" src="${a.image}"/>
    <div class="flex-1">
      <p class="font-semibold text-gray-800">${a.therapist}</p>
      <p class="text-xs text-gray-500">${a.role}</p>
      <p class="text-xs text-gray-400">Athens, Greece</p>
      <a href="#" class="text-xs text-black hover:underline mt-1 inline-block">Check education and experience</a>
    </div>
    <div class="text-right">
      <p class="text-xs font-semibold text-gray-700">Appointment</p>
      <p class="text-xs text-gray-500">${a.location}</p>
      <p class="text-xs text-gray-500">${a.date}</p>
      <p class="text-xs text-gray-500">${a.time}</p>
    </div>
    <div class="flex flex-col gap-2 ml-4">
      <button class="bg-white border border-blue-200 text-blue-600 text-xs py-1 px-3 rounded-full hover:bg-blue-50 flex items-center justify-center"><span class="material-icons text-sm mr-1">call</span>Call</button>
      <button class="bg-white border border-gray-200 text-gray-600 text-xs py-1 px-3 rounded-full hover:bg-gray-50 flex items-center justify-center"><span class="material-icons text-sm mr-1">email</span>Email</button>
      ${isPast ? `<button class="rate-therapist-btn bg-purple-600 text-white py-1.5 px-4 rounded-full text-xs font-semibold shadow hover:bg-purple-700 transition-all mt-1 mb-1" data-session-id="${a.id}" ${rated ? 'disabled' : ''}>${rated ? 'Rated' : 'Rate Therapist'}</button>` : `<button class="bg-white border border-purple-200 text-black text-xs py-1 px-3 rounded-full hover:bg-purple-50">Request reschedule</button>`}
    </div>
  `;
  return div;
}

</script>



<script>
// --- Main Therapists Section Logic ---
function getUserTherapists() {
  // Collect unique therapists from all appointments (sessions)
  const all = appointmentsSessions.concat(appointments || []);
  const unique = {};
  all.forEach(a => {
    if (!unique[a.therapist]) {
      unique[a.therapist] = {
        name: a.therapist,
        role: a.role,
        image: a.image,
        id: a.id,
        location: a.location
      };
    }
  });
  return Object.values(unique);
}
let mainTherapist = null;
let mainTherapistRecurrence = null;
let mainTherapistApproval = null; // null: not requested, 'pending', 'approved', 'rejected'
function renderTherapistsList() {
  const list = document.getElementById('therapists-list');
  const info = document.getElementById('main-therapist-info');
  const scrollLeft = document.getElementById('therapist-scroll-left');
  const scrollRight = document.getElementById('therapist-scroll-right');
  const therapists = getUserTherapists();
  list.innerHTML = '';
  info.innerHTML = '';
  if (mainTherapist) {
    // Hide scroll buttons
    if (scrollLeft) scrollLeft.style.display = 'none';
    if (scrollRight) scrollRight.style.display = 'none';
    // Show main therapist info and recurrence
    let recurrenceText = '';
    if (mainTherapistRecurrence) {
      recurrenceText = `You are meeting <b>${mainTherapistRecurrence.freq}</b> every <b>${mainTherapistRecurrence.day}</b> at <b>${mainTherapistRecurrence.time}</b> until <b>${mainTherapistRecurrence.endDate}</b>.`;
    }
    let approvalText = '';
    if (mainTherapistApproval === 'pending') approvalText = '<span class="text-yellow-600 font-semibold">(Pending therapist approval)</span>';
    if (mainTherapistApproval === 'approved') approvalText = '<span class="text-green-600 font-semibold">(Approved by therapist)</span>';
    if (mainTherapistApproval === 'rejected') approvalText = '<span class="text-red-600 font-semibold">(Not approved by therapist)</span>';
    info.innerHTML = `
      <div class="flex items-center gap-4 p-4 bg-[#f7f3ff] rounded-2xl shadow-sm">
        <img src="${mainTherapist.image}" class="w-16 h-16 rounded-full object-cover border-2 border-purple-100" alt="${mainTherapist.name}"/>
        <div class="flex-1">
          <div class="font-bold text-lg text-purple-700">Your Main Therapist</div>
          <div class="text-gray-800 font-semibold">${mainTherapist.name}</div>
          <div class="text-gray-500 text-sm">${mainTherapist.role}</div>
          <div class="text-gray-500 text-sm">${mainTherapist.location}</div>
          <div class="mt-2 text-sm">${recurrenceText} ${approvalText}</div>
        </div>
      </div>
      <div class="mt-4 text-purple-700 font-semibold text-center">To change main therapist please refer to your therapist</div>
      ${mainTherapistApproval === 'rejected' ? `<div class='mt-2 text-red-600 font-semibold'>Sadly, the therapist didn't approve the booking. Please contact them or choose another main therapist.</div>` : ''}
    `;
    return;
  } else {
    // Show scroll buttons
    if (scrollLeft) scrollLeft.style.display = '';
    if (scrollRight) scrollRight.style.display = '';
  }
  therapists.forEach(t => {
    const card = document.createElement('div');
    card.className = 'flex flex-col items-center bg-[#f8f7fa] rounded-2xl p-6 shadow-sm w-80 flex-shrink-0';
    card.innerHTML = `
      <img src="${t.image}" class="w-16 h-16 rounded-full object-cover border-2 border-purple-100 mb-2" alt="${t.name}"/>
      <div class="font-semibold text-lg text-purple-700 mb-1">${t.name}</div>
      <div class="text-gray-500 text-sm mb-1">${t.role}</div>
      <div class="text-gray-400 text-xs mb-2">${t.location}</div>
      <button class="main-therapist-btn bg-purple-600 text-white px-3 py-1.5 rounded-full font-semibold text-sm mt-2 mb-1" style="min-width: 0; min-height: 0;" data-id="${t.id}">Set as Main Therapist</button>
      <button class="cv-btn border border-purple-300 text-purple-700 bg-white px-3 py-1.5 rounded-full font-semibold text-sm hover:bg-purple-50 transition-all" style="min-width: 0; min-height: 0;">Experience CV</button>
    `;
    list.appendChild(card);
  });
  // Add scroll buttons logic
  scrollLeft.style.width = scrollLeft.style.height = scrollRight.style.width = scrollRight.style.height = '48px';
  scrollLeft.style.borderRadius = scrollRight.style.borderRadius = '50%';
  scrollLeft.style.display = scrollRight.style.display = 'flex';
  scrollLeft.style.alignItems = scrollRight.style.alignItems = 'center';
  scrollLeft.style.justifyContent = scrollRight.style.justifyContent = 'center';
  scrollLeft.onclick = () => { list.scrollBy({ left: -320, behavior: 'smooth' }); };
  scrollRight.onclick = () => { list.scrollBy({ left: 320, behavior: 'smooth' }); };
  // Add event listeners for main therapist selection
  list.querySelectorAll('.main-therapist-btn').forEach(btn => {
    btn.onclick = function() {
      const id = btn.getAttribute('data-id');
      const t = therapists.find(x => x.id == id);
      mainTherapist = t;
      showRecurrenceModal();
    };
  });
  // Attach CV button event listeners after cards are appended
  list.querySelectorAll('.cv-btn').forEach((btn, idx) => {
    btn.onclick = function() {
      const t = therapists[idx];
      // Use showTherapistProfile from therapist-enhancements.js instead
      if (window.showTherapistProfile && t.id) {
        showTherapistProfile(t.id);
      }
    };
  });
}
function showRecurrenceModal() {
  // Simple modal for recurrence setup
  let modal = document.getElementById('recurrence-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'recurrence-modal';
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/40';
    modal.innerHTML = `
      <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md mx-4 flex flex-col items-center relative">
        <button id="close-recurrence-modal" class="absolute top-4 right-4 text-gray-400 hover:text-black text-2xl">&times;</button>
        <h2 class="text-2xl font-bold mb-4 text-purple-700">Set Up Recurring Appointments</h2>
        <label class="w-full mb-2 font-semibold">Frequency</label>
        <select id="recurrence-freq" class="w-full mb-4 p-2 rounded-lg border border-gray-200">
          <option value="weekly">Weekly</option>
          <option value="biweekly">Biweekly</option>
          <option value="monthly">Monthly</option>
        </select>
        <label class="w-full mb-2 font-semibold">Day of Week</label>
        <select id="recurrence-day" class="w-full mb-4 p-2 rounded-lg border border-gray-200">
          <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
        </select>
        <label class="w-full mb-2 font-semibold">Time</label>
        <input id="recurrence-time" type="time" class="w-full mb-4 p-2 rounded-lg border border-gray-200" value="19:30"/>
        <label class="w-full mb-2 font-semibold">End Date</label>
        <input id="recurrence-end-date" type="date" class="w-full mb-4 p-2 rounded-lg border border-gray-200"/>
        <button id="submit-recurrence" class="bg-purple-600 text-white py-2 px-8 rounded-full text-base font-semibold shadow-md hover:bg-purple-700 transition-all">Submit Request</button>
      </div>
    `;
    document.body.appendChild(modal);
  }
  modal.classList.remove('hidden');
  document.getElementById('close-recurrence-modal').onclick = function() {
    modal.classList.add('hidden');
  };
  document.getElementById('submit-recurrence').onclick = function() {
    // Save recurrence info and set approval to pending
    mainTherapistRecurrence = {
      freq: document.getElementById('recurrence-freq').value,
      day: document.getElementById('recurrence-day').value,
      time: document.getElementById('recurrence-time').value,
      endDate: document.getElementById('recurrence-end-date').value
    };
    mainTherapistApproval = 'pending';
    modal.classList.add('hidden');
    renderTherapistsList();
    // TODO: Send request to therapist for approval, add to appointments if approved
  };
}
document.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('therapists-list')) {
    renderTherapistsList();
  }
});
// ... existing code ...
list.querySelectorAll('.cv-btn').forEach((btn, idx) => {
  btn.onclick = function() {
    const t = therapists[idx];
          // Use showTherapistProfile from therapist-enhancements.js instead
      if (window.showTherapistProfile && t.id) {
        showTherapistProfile(t.id);
      }
  };
});
// ... existing code ...
// showCVModal function removed - using showTherapistProfile from therapist-enhancements.js instead
// ... existing code ...
</script>

<script>
// ... existing code ...
function updateMainTherapistDashboardSection() {
  const section = document.getElementById('main-therapist-dashboard-section');
  if (window.mainTherapist) {
    section.style.display = '';
    document.getElementById('main-therapist-dashboard-img').src = mainTherapist.image;
    document.getElementById('main-therapist-dashboard-name').textContent = mainTherapist.name;
    document.getElementById('main-therapist-dashboard-role').textContent = mainTherapist.role;
    document.getElementById('main-therapist-dashboard-location').textContent = mainTherapist.location;
    const btn = document.getElementById('update-emotia-btn');
    if (window.mainTherapistApproval === 'approved') {
      btn.disabled = false;
      btn.classList.remove('opacity-60', 'cursor-not-allowed');
      btn.title = '';
      btn.onclick = function() {
        alert('Emotia results sent to your main therapist!');
      };
    } else {
      btn.disabled = true;
      btn.classList.add('opacity-60', 'cursor-not-allowed');
      btn.title = 'This action will be available after your therapist approves.';
      btn.onclick = null;
    }
  } else {
    section.style.display = 'none';
  }
}
// Call this after mainTherapist is set/changed
// ... existing code ...
document.addEventListener('DOMContentLoaded', function() {
  // ... existing code ...
  updateMainTherapistDashboardSection();
});
// Also call updateMainTherapistDashboardSection() in renderTherapistsList after mainTherapist is set
// ... existing code ...
if (mainTherapist) {
  // ... existing code ...
  updateMainTherapistDashboardSection();
  return;
}
// ... existing code ...
</script>

<script>
// --- Mood Statistics & Progress Section Logic (Emotia Tab Only) ---
(function() {
  // Only run if Emotia tab is visible
  const statsSection = document.getElementById('emotia-mood-stats-section');
  if (!statsSection) return;

  // Helper: categorize emotions
  const positiveEmotions = [
    'Joy', 'Excitement', 'Love', 'Calmness', 'Satisfaction', 'Relief', 'Pride', 'Gratitude', 'Hope', 'Surprise'
  ];
  const negativeEmotions = [
    'Anxiety', 'Fear', 'Anger', 'Sadness', 'Disappointment', 'Jealousy', 'Shame', 'Guilt', 'Confusion'
  ];
  // Helper: mood categories
  const moodCategories = [
    'Very Unpleasant', 'Unpleasant', 'Slight Unpleasant', 'Neutral', 'Slight Pleasant', 'Pleasant', 'Very Pleasant'
  ];
  // Helper: time of day
  function getTimeOfDay(time) {
    const [h, m] = time.split(':').map(Number);
    if (h >= 5 && h < 12) return 'Morning';
    if (h >= 12 && h < 17) return 'Afternoon';
    if (h >= 17 && h < 22) return 'Evening';
    return 'Night';
  }
  // Filtering logic - set default to 'all'
  let currentStatsRange = 'all';
  
  // Ensure all buttons have correct styling from the start
  const filterBtns = Array.from(document.querySelectorAll('.mood-stats-filter-btn'));
  filterBtns.forEach(btn => {
    // Clear all previous styling
    btn.classList.remove('bg-purple-100', 'text-purple-700');
    btn.classList.add('bg-white/30', 'text-gray-700');
    
    // Set the "All" button as selected by default
    if (btn.getAttribute('data-range') === 'all') {
      btn.classList.add('bg-purple-100', 'text-purple-700');
      btn.classList.remove('bg-white/30', 'text-gray-700');
    }
    
    // Add click event to each button
    btn.addEventListener('click', function() {
      filterBtns.forEach(b => b.classList.remove('bg-purple-100', 'text-purple-700'));
      filterBtns.forEach(b => b.classList.add('bg-white/30', 'text-gray-700'));
      btn.classList.remove('bg-white/30', 'text-gray-700');
      btn.classList.add('bg-purple-100', 'text-purple-700');
      currentStatsRange = btn.getAttribute('data-range');
      emotiaRenderEmotionsBubbleChart("week"); emotiaRenderPositivityChart("week");
    });
  });
  // Get filtered submissions
  function getFilteredSubmissions() {
    const now = new Date();
    if (currentStatsRange === 'all') return emotiaSubmissions.slice();
    if (currentStatsRange === 'year') {
      return emotiaSubmissions.filter(s => new Date(s.date).getFullYear() === now.getFullYear());
    }
    if (currentStatsRange === 'month') {
      return emotiaSubmissions.filter(s => {
        const d = new Date(s.date);
        return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
      });
    }
    // week: last 7 days
    const weekAgo = new Date(now);
    weekAgo.setDate(now.getDate() - 6);
    return emotiaSubmissions.filter(s => {
      const d = new Date(s.date);
      return d >= weekAgo && d <= now;
    });
  }
  // Calculate stats - expose to global scope so it can be called from tab click
  window.renderMoodStats = function() {
    const filtered = getFilteredSubmissions();
    // Number of submissions
    document.getElementById('mood-stats-submissions').textContent = filtered.length;
    // Week completion % (for week: days with at least 1 submission / 7)
    let completion = 0;
    if (currentStatsRange === 'week') {
      const days = new Set(filtered.map(s => s.date));
      completion = Math.round((days.size / 7) * 100);
    } else if (currentStatsRange === 'month') {
      const now = new Date();
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      const days = new Set(filtered.map(s => s.date));
      completion = Math.round((days.size / daysInMonth) * 100);
    } else if (currentStatsRange === 'year') {
      const now = new Date();
      const weeks = 52;
      const weekNumbers = new Set(filtered.map(s => {
        const d = new Date(s.date);
        const firstJan = new Date(d.getFullYear(), 0, 1);
        return Math.ceil((((d - firstJan) / 86400000) + firstJan.getDay() + 1) / 7);
      }));
      completion = Math.round((weekNumbers.size / weeks) * 100);
    } else {
      completion = 100;
    }
    document.getElementById('mood-stats-completion').textContent = completion + '%';
    // Positivity ratio: positive emotions / all emotions
    let totalEmotions = 0, positiveCount = 0;
    filtered.forEach(s => {
      if (s.emotions) {
        totalEmotions += s.emotions.length;
        s.emotions.forEach(e => { if (positiveEmotions.includes(e)) positiveCount++; });
      }
    });
    const positivity = totalEmotions ? Math.round((positiveCount / totalEmotions) * 100) : 0;
    document.getElementById('mood-stats-positivity').textContent = positivity + '%';
    // Render charts
    renderMoodStatsCharts(filtered);
  }
  // Chart rendering
  let charts = {};
  function renderMoodStatsCharts(filtered) {
    // Destroy previous charts. Crucially, remove the old pie chart reference first.
    if (charts.emotionsPie) {
      delete charts.emotionsPie;
    }
    Object.values(charts).forEach(c => { if (c) c.destroy(); });
    charts = {};
    // --- Emotions Packed Bubble Chart (replaces Pie Chart) ---
    const emotionCounts = {};
    filtered.forEach(s => {
      if (s.emotions) s.emotions.forEach(e => { emotionCounts[e] = (emotionCounts[e] || 0) + 1; });
    });
    const emotionLabels = Object.keys(emotionCounts);
    const emotionData = emotionLabels.map(e => ({
      name: e,
      value: emotionCounts[e],
      color: (emotiaEmotions.find(x => x.name === e) || {color:'#ccc'}).color
    }));
    const chartContainer = document.getElementById('emotions-chart-container');
    chartContainer.innerHTML = ''; // Clear previous content
    const width = chartContainer.offsetWidth;
    const height = 320;
    if (width > 0 && emotionData.length > 0) {
      const diameter = Math.min(width, height);
      const pack = d3.pack()
        .size([diameter - 4, diameter - 4])
        .padding(8);
      const root = d3.hierarchy({ children: emotionData })
        .sum(d => d.value)
        .sort((a, b) => b.value - a.value);
      pack(root);
      const svg = d3.select(chartContainer)
        .append('svg')
        .attr('width', diameter)
        .attr('height', diameter)
        .attr('viewBox', `0 0 ${diameter} ${diameter}`)
        .style('display', 'block')
        .style('margin', 'auto');
      let tooltip = d3.select(chartContainer).select('.bubble-tooltip');
      if (tooltip.empty()) {
        tooltip = d3.select(chartContainer)
          .append('div')
          .attr('class', 'bubble-tooltip')
          .style('position', 'absolute').style('pointer-events', 'none')
          .style('background', 'rgba(34, 44, 60, 0.95)').style('color', 'white')
          .style('font-family', "'Helvetica Neue', Arial, sans-serif")
          .style('font-size', '0.9rem').style('font-weight', '600')
          .style('border-radius', '6px').style('box-shadow', '0 3px 12px rgba(0,0,0,0.25)')
          .style('padding', '8px 12px').style('z-index', 10).style('opacity', 0)
          .style('transition', 'opacity 0.2s ease');
      }
      const node = svg.selectAll('.node')
        .data(root.children)
        .enter().append('g')
        .attr('class', 'node')
        .attr('transform', d => `translate(${d.x}, ${d.y})`);
      const graph = node.append('g')
        .attr('class', 'graph')
        .style('animation-delay', (d, i) => `${i * 0.07}s`);
      // Create gradients for the bubbles
      const defs = svg.append('defs');
      
      // Create a gradient for each emotion
      emotionData.forEach((emotion, i) => {
        const baseColor = emotion.color;
        const color = d3.color(baseColor);
        const lighterColor = d3.rgb(
          Math.min(255, color.r + 40),
          Math.min(255, color.g + 40),
          Math.min(255, color.b + 40)
        ).formatHex();
        
        const gradient = defs.append('radialGradient')
          .attr('id', `bubble-gradient-${i}`)
          .attr('cx', '0.5')
          .attr('cy', '0.5')
          .attr('r', '0.5')
          .attr('fx', '0.4')
          .attr('fy', '0.4');
        
        gradient.append('stop')
          .attr('offset', '0%')
          .attr('stop-color', lighterColor);
        
        gradient.append('stop')
          .attr('offset', '100%')
          .attr('stop-color', baseColor);
      });
      
      graph.append('circle')
        .attr('r', d => d.r)
        .style('fill', (d, i) => `url(#bubble-gradient-${emotionData.findIndex(e => e.name === d.data.name)})`)
        .style('filter', 'drop-shadow(0 2px 8px rgba(0,0,0,0.1))')
        .style('transition', 'transform 0.2s ease')
        .on('mouseenter', function(e, d) {
          // Only subtle zoom effect on hover
          d3.select(this).style('transform', 'scale(1.05)');
          tooltip.transition().duration(120).style('opacity', 1);
          // Show emotion name and percentage in tooltip
          const totalValue = emotionData.reduce((sum, e) => sum + e.value, 0);
          const percentage = Math.round((d.data.value / totalValue) * 100);
          tooltip.html(`<b>${d.data.name}</b>: ${percentage}%`)
            .style('left', (e.clientX - chartContainer.getBoundingClientRect().left + 15) + 'px')
            .style('top', (e.clientY - chartContainer.getBoundingClientRect().top - 10) + 'px');
        })
        .on('mousemove', function(e) {
          tooltip.style('left', (e.clientX - chartContainer.getBoundingClientRect().left + 15) + 'px')
            .style('top', (e.clientY - chartContainer.getBoundingClientRect().top - 10) + 'px');
        })
        .on('mouseleave', function() {
          d3.select(this).style('transform', 'scale(1)');
          tooltip.transition().duration(120).style('opacity', 0);
        });
      
      // Add text only if it fits comfortably inside the bubble
      graph.append('text')
        .attr('dy', '.3em')
        .style('text-anchor', 'middle')
        .style('font-size', d => `${Math.max(9, d.r / 3.5)}px`)
        .style('font-family', "'Helvetica Neue', Arial, sans-serif")
        .style('fill', '#111')
        .style('font-weight', '600')
        .style('pointer-events', 'none')
        .style('opacity', d => {
          // Only show text if it fits comfortably inside the bubble
          const fontSize = Math.max(9, d.r / 3.5);
          const textWidth = d.data.name.length * (fontSize * 0.6); // Approximate width
          // More strict condition to ensure text fits nicely
          return textWidth < d.r * 1.6 ? 1 : 0;
        })
        .text(d => d.data.name);
    } else {
      chartContainer.innerHTML = '<div class="text-gray-500">No emotion data to display for this period.</div>';
    }
    // Emotions list - with enhanced modern styling and limited to top 6 items
    const emotionsList = document.getElementById('mood-stats-emotions-list');
    const emotionsExpandBtn = document.getElementById('emotions-list-expand');
    
    if (emotionData.length > 0) {
      // Sort by value descending to show most frequent emotions first
      emotionData.sort((a, b) => b.value - a.value);
      
      // Create emotion gradients
      const emotionGradients = {};
      emotionData.forEach(emotion => {
        const baseColor = emotion.color;
        // Create a lighter and darker version of the base color
        const color = d3.color(baseColor);
        const lighterColor = d3.rgb(
          Math.min(255, color.r + 40),
          Math.min(255, color.g + 40),
          Math.min(255, color.b + 40)
        ).formatHex();
        emotionGradients[emotion.name] = `linear-gradient(135deg, ${lighterColor}, ${baseColor})`;
      });
      
      const totalEmotions = emotionData.reduce((sum, e) => sum + e.value, 0) || 1;
      
      // Create list items for all emotions
      const allEmotionItems = emotionData.map((d, index) => {
        const percentage = Math.round((d.value / totalEmotions) * 100);
        return `
          <li class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-${d.color}/20 shadow-sm transition-all hover:shadow-md hover:bg-white ${index >= 6 ? 'hidden extra-item' : ''}">
            <div class="flex items-center justify-between">
              <div class="">
                <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${emotionGradients[d.name] || d.color};margin-right:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"></span>
                <span class="font-medium text-gray-700">${d.name}</span>
                </button>
        </div>
              <div class="">
                <span class="font-bold text-purple-700 mr-2">${d.value}</span>
                <span class="text-sm text-gray-500">(${percentage}%)</span>
                </button>
        </div>
              </button>
        </div>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-2 overflow-hidden">
              <div class="h-full rounded-full" style="width:${percentage}%;background:${emotionGradients[d.name] || d.color};"></div>
              </button>
        </div>
          </li>
        `;
      }).join('');
      
      emotionsList.innerHTML = allEmotionItems;
      
      // Show expand button only if we have more than 6 items
      if (emotionData.length > 6) {
        emotionsExpandBtn.classList.remove('hidden');
        
        // Add click event for the expand button
        const expandBtn = emotionsExpandBtn.querySelector('button');
        expandBtn.addEventListener('click', function() {
          const expandText = this.querySelector('.expand-text');
          const collapseText = this.querySelector('.collapse-text');
          const extraItems = emotionsList.querySelectorAll('.extra-item');
          
          // Toggle visibility of extra items
          extraItems.forEach(item => {
            item.classList.toggle('hidden');
          });
          
          // Toggle button text
          expandText.classList.toggle('hidden');
          collapseText.classList.toggle('hidden');
        });
      }
    } else {
      emotionsList.innerHTML = '<li class="bg-white/80 backdrop-blur-sm rounded-lg p-4 text-center text-gray-500">No emotion data available for this period.</li>';
      emotionsExpandBtn.classList.add('hidden');
    }
    // --- Mood Pie Chart ---
    const moodCounts = {};
    filtered.forEach(s => { moodCounts[s.mood] = (moodCounts[s.mood] || 0) + 1; });
    const moodLabels = moodCategories.filter(m => moodCounts[m]);
    const moodData = moodLabels.map(m => moodCounts[m]);
    // Gradient mood colors based on new color scheme
    const moodGradients = [
      'linear-gradient(135deg, #5B21B6, #6C2BD9)', // Very Unpleasant - purple
      'linear-gradient(135deg, #312E81, #3730A3)', // Unpleasant - dark blue
      'linear-gradient(135deg, #1E40AF, #2563EB)', // Slight Unpleasant - dark light blue
      'linear-gradient(135deg, #60A5FA, #93C5FD)', // Neutral - light blue
      'linear-gradient(135deg, #4ADE80, #86EFAC)', // Slight Pleasant - light green
      'linear-gradient(135deg, #FDE047, #FEF08A)', // Pleasant - light yellow
      'linear-gradient(135deg, #FB7185, #FDA4AF)'  // Very Pleasant - light pink
    ];
    const moodColors = ['#6C2BD9','#3730A3','#2563EB','#93C5FD','#86EFAC','#FEF08A','#FDA4AF'];
    charts.moodPie = new Chart(document.getElementById('mood-stats-mood-pie').getContext('2d'), {
      type: 'doughnut',
                data: { 
        labels: moodLabels, 
        datasets: [{ 
          data: moodData, 
          backgroundColor: moodColors.slice(0, moodLabels.length),
          borderWidth: 0,
          hoverOffset: 15,
          borderRadius: 4
        }] 
      },
      options: { 
        responsive: true,
        plugins: { whiteGlow: { enabled: true }, 
          legend: { 
            display: !(window.innerWidth <= 768 && window.innerHeight > window.innerWidth),
            position: 'bottom',
            labels: {
              boxWidth: 15,
              padding: 15,
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            titleColor: '#4B5563',
            bodyColor: '#374151',
            bodyFont: {
              size: 12
            },
            titleFont: {
              size: 13,
              weight: 'bold'
            },
            displayColors: false,
            padding: 10,
            borderColor: 'rgba(0, 0, 0, 0.1)',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                const value = context.raw;
                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                const percentage = Math.round((value / total) * 100);
                return `${context.label}: ${value} entries (${percentage}%)`;
              }
            }
          }
        },
        cutout: '60%',
        animation: {
          animateScale: true,
          animateRotate: true,
          duration: 1500
        }
      }
    });
    const moodList = document.getElementById('mood-stats-mood-list');
    const moodExpandBtn = document.getElementById('mood-list-expand');
    
    if (moodLabels.length > 0) {
      // Combine the labels and data for sorting
      const combinedMoodData = moodLabels.map((label, index) => ({
        label,
        count: moodData[index],
        color: moodColors[index]
      }));
      
      // Sort by count descending
      combinedMoodData.sort((a, b) => b.count - a.count);
      
      const totalMoods = moodData.reduce((sum, d) => sum + d, 0) || 1;
      
      // Create list items for all moods
      const allMoodItems = combinedMoodData.map((item, index) => {
        const percentage = Math.round((item.count / totalMoods) * 100);
        return `
          <li class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-${item.color}/20 shadow-sm transition-all hover:shadow-md hover:bg-white ${index >= 6 ? 'hidden extra-item' : ''}">
            <div class="flex items-center justify-between">
              <div class="">
                <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${moodGradients[moodColors.indexOf(item.color)] || item.color};margin-right:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"></span>
                <span class="font-medium text-gray-700">${item.label}</span>
                </button>
        </div>
              <div class="">
                <span class="font-bold text-blue-600 mr-2">${item.count}</span>
                <span class="text-sm text-gray-500">(${percentage}%)</span>
                </button>
        </div>
              </button>
        </div>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-2 overflow-hidden">
              <div class="h-full rounded-full" style="width:${percentage}%;background:${moodGradients[moodColors.indexOf(item.color)] || item.color};"></div>
              </button>
        </div>
          </li>
        `;
      }).join('');
      
      moodList.innerHTML = allMoodItems;
      
      // Show expand button only if we have more than 6 items
      if (combinedMoodData.length > 6) {
        moodExpandBtn.classList.remove('hidden');
        
        // Add click event for the expand button
        const expandBtn = moodExpandBtn.querySelector('button');
        expandBtn.addEventListener('click', function() {
          const expandText = this.querySelector('.expand-text');
          const collapseText = this.querySelector('.collapse-text');
          const extraItems = moodList.querySelectorAll('.extra-item');
          
          // Toggle visibility of extra items
          extraItems.forEach(item => {
            item.classList.toggle('hidden');
          });
          
          // Toggle button text
          expandText.classList.toggle('hidden');
          collapseText.classList.toggle('hidden');
        });
      } else {
        moodExpandBtn.classList.add('hidden');
      }
    } else {
      moodList.innerHTML = '<li class="bg-white/80 backdrop-blur-sm rounded-lg p-4 text-center text-gray-500">No mood data available for this period.</li>';
      moodExpandBtn.classList.add('hidden');
    }
    // Time of Day Pie
    const timeCounts = {};
    filtered.forEach(s => { const tod = getTimeOfDay(s.time); timeCounts[tod] = (timeCounts[tod] || 0) + 1; });
    const timeLabels = Object.keys(timeCounts);
    const timeData = timeLabels.map(t => timeCounts[t]);
    // Gradient time of day colors
    const timeGradients = [
      'linear-gradient(135deg, #FFD194, #FFDDB0)',  // Morning gradient (warm peach)
      'linear-gradient(135deg, #90E1F9, #AEEBFF)',  // Afternoon gradient (sky blue)
      'linear-gradient(135deg, #B9D8C3, #CFE8D8)',  // Evening gradient (soft green)
      'linear-gradient(135deg, #D1BCD8, #E4D4EA)'   // Night gradient (lavender)
    ];
    const timeColors = ['#FFDDB0','#AEEBFF','#CFE8D8','#E4D4EA'];
    charts.timePie = new Chart(document.getElementById('mood-stats-time-pie').getContext('2d'), {
      type: 'doughnut',
      data: { 
        labels: timeLabels, 
        datasets: [{ 
          data: timeData, 
          backgroundColor: timeColors.slice(0, timeLabels.length),
          borderWidth: 0,
          hoverOffset: 15,
          borderRadius: 4
        }] 
      },
      options: { 
        responsive: true,
        plugins: { whiteGlow: { enabled: true }, 
          legend: { 
            display: !(window.innerWidth <= 768 && window.innerHeight > window.innerWidth),
            position: 'bottom',
            labels: {
              boxWidth: 15,
              padding: 15,
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            titleColor: '#4B5563',
            bodyColor: '#374151',
            bodyFont: {
              size: 12
            },
            titleFont: {
              size: 13,
              weight: 'bold'
            },
            displayColors: false,
            padding: 10,
            borderColor: 'rgba(0, 0, 0, 0.1)',
            borderWidth: 1,
            callbacks: {
              title: function(context) {
                return context[0].label + ' Time';
              },
              label: function(context) {
                const value = context.raw;
                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                const percentage = Math.round((value / total) * 100);
                return `${value} entries (${percentage}% of all submissions)`;
              }
            }
          }
        },
        cutout: '60%',
        animation: {
          animateScale: true,
          animateRotate: true,
          duration: 1500
        }
      }
    });
    const timeList = document.getElementById('mood-stats-time-list');
    const timeExpandBtn = document.getElementById('time-list-expand');
    
    if (timeLabels.length > 0) {
      // Combine the labels and data for sorting
      const combinedTimeData = timeLabels.map((label, index) => ({
        label,
        count: timeData[index],
        color: timeColors[index]
      }));
      
      // Sort by count descending
      combinedTimeData.sort((a, b) => b.count - a.count);
      
      const totalTimes = timeData.reduce((sum, d) => sum + d, 0) || 1;
      
      // Create list items for all times
      const allTimeItems = combinedTimeData.map((item, index) => {
        const percentage = Math.round((item.count / totalTimes) * 100);
        return `
          <li class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-${item.color}/20 shadow-sm transition-all hover:shadow-md hover:bg-white ${index >= 6 ? 'hidden extra-item' : ''}">
            <div class="flex items-center justify-between">
              <div class="">
                <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${timeGradients[timeColors.indexOf(item.color)] || item.color};margin-right:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"></span>
                <span class="font-medium text-gray-700">${item.label}</span>
                </button>
        </div>
              <div class="">
                <span class="font-bold text-amber-600 mr-2">${item.count}</span>
                <span class="text-sm text-gray-500">(${percentage}%)</span>
                </button>
        </div>
              </button>
        </div>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-2 overflow-hidden">
              <div class="h-full rounded-full" style="width:${percentage}%;background:${timeGradients[timeColors.indexOf(item.color)] || item.color};"></div>
              </button>
        </div>
          </li>
        `;
      }).join('');
      
      timeList.innerHTML = allTimeItems;
      
      // Show expand button only if we have more than 6 items
      if (combinedTimeData.length > 6) {
        timeExpandBtn.classList.remove('hidden');
        
        // Add click event for the expand button
        const expandBtn = timeExpandBtn.querySelector('button');
        expandBtn.addEventListener('click', function() {
          const expandText = this.querySelector('.expand-text');
          const collapseText = this.querySelector('.collapse-text');
          const extraItems = timeList.querySelectorAll('.extra-item');
          
          // Toggle visibility of extra items
          extraItems.forEach(item => {
            item.classList.toggle('hidden');
          });
          
          // Toggle button text
          expandText.classList.toggle('hidden');
          collapseText.classList.toggle('hidden');
        });
      } else {
        timeExpandBtn.classList.add('hidden');
      }
    } else {
      timeList.innerHTML = '<li class="bg-white/80 backdrop-blur-sm rounded-lg p-4 text-center text-gray-500">No time data available for this period.</li>';
      timeExpandBtn.classList.add('hidden');
    }
    // Category Pie
    const catCounts = {};
    filtered.forEach(s => { catCounts[s.category] = (catCounts[s.category] || 0) + 1; });
    const catLabels = Object.keys(catCounts);
    const catData = catLabels.map(c => catCounts[c]);
    const catColors = ['#F9B5D0','#B6F5C9','#B5D8FF','#FFD6A5','#FFF7B2','#FFB5B5','#D1B5FF','#7ED6A7'];
    charts.catPie = new Chart(document.getElementById('mood-stats-category-pie').getContext('2d'), {
      type: 'doughnut',
      data: { 
        labels: catLabels, 
        datasets: [{ 
          data: catData, 
          backgroundColor: catColors.slice(0, catLabels.length),
          borderWidth: 0,
          hoverOffset: 15,
          borderRadius: 4
        }] 
      },
      options: { 
        responsive: true,
        plugins: { whiteGlow: { enabled: true }, 
          legend: { 
            display: !(window.innerWidth <= 768 && window.innerHeight > window.innerWidth),
            position: 'bottom',
            labels: {
              boxWidth: 15,
              padding: 15,
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            titleColor: '#4B5563',
            bodyColor: '#374151',
            bodyFont: {
              size: 12
            },
            titleFont: {
              size: 13,
              weight: 'bold'
            },
            displayColors: false,
            padding: 10,
            borderColor: 'rgba(0, 0, 0, 0.1)',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                const value = context.raw;
                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                const percentage = Math.round((value / total) * 100);
                return `${context.label}: ${value} entries (${percentage}%)`;
              }
            }
          }
        },
        cutout: '60%',
        animation: {
          animateScale: true,
          animateRotate: true,
          duration: 1500
        }
      }
    });
    const catList = document.getElementById('mood-stats-category-list');
    const catExpandBtn = document.getElementById('category-list-expand');
    
    if (catLabels.length > 0) {
      // Combine the labels and data for sorting
      const combinedCatData = catLabels.map((label, index) => ({
        label,
        count: catData[index],
        color: catColors[index]
      }));
      
      // Sort by count descending
      combinedCatData.sort((a, b) => b.count - a.count);
      
      const totalCats = catData.reduce((sum, d) => sum + d, 0) || 1;
      
      // Create list items for all categories
      const allCatItems = combinedCatData.map((item, index) => {
        const percentage = Math.round((item.count / totalCats) * 100);
        return `
          <li class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-${item.color}/20 shadow-sm transition-all hover:shadow-md hover:bg-white ${index >= 6 ? 'hidden extra-item' : ''}">
            <div class="flex items-center justify-between">
              <div class="">
                <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${categoryGradients[item.label] || item.color};margin-right:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"></span>
                <span class="font-medium text-gray-700">${item.label}</span>
                </button>
        </div>
              <div class="">
                <span class="font-bold text-green-600 mr-2">${item.count}</span>
                <span class="text-sm text-gray-500">(${percentage}%)</span>
                </button>
        </div>
              </button>
        </div>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-2 overflow-hidden">
              <div class="h-full rounded-full" style="width:${percentage}%;background:${categoryGradients[item.label] || item.color};"></div>
              </button>
        </div>
          </li>
        `;
      }).join('');
      
      catList.innerHTML = allCatItems;
      
      // Show expand button only if we have more than 6 items
      if (combinedCatData.length > 6) {
        catExpandBtn.classList.remove('hidden');
        
        // Add click event for the expand button
        const expandBtn = catExpandBtn.querySelector('button');
        expandBtn.addEventListener('click', function() {
          const expandText = this.querySelector('.expand-text');
          const collapseText = this.querySelector('.collapse-text');
          const extraItems = catList.querySelectorAll('.extra-item');
          
          // Toggle visibility of extra items
          extraItems.forEach(item => {
            item.classList.toggle('hidden');
          });
          
          // Toggle button text
          expandText.classList.toggle('hidden');
          collapseText.classList.toggle('hidden');
        });
      } else {
        catExpandBtn.classList.add('hidden');
      }
    } else {
      catList.innerHTML = '<li class="bg-white/80 backdrop-blur-sm rounded-lg p-4 text-center text-gray-500">No category data available for this period.</li>';
      catExpandBtn.classList.add('hidden');
    }
    // Positive vs Negative Emotions Bar
    let posCount = 0, negCount = 0;
    filtered.forEach(s => {
      if (s.emotions) s.emotions.forEach(e => {
        if (positiveEmotions.includes(e)) posCount++;
        if (negativeEmotions.includes(e)) negCount++;
      });
    });
    charts.posnegBar = new Chart(document.getElementById('mood-stats-posneg-bar').getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['Positive', 'Negative'],
        datasets: [{
          data: [posCount, negCount],
          backgroundColor: [
            'rgba(135, 211, 255, 0.9)',
            'rgba(255, 125, 138, 0.85)'
          ],
          borderWidth: 0,
          borderRadius: 18,
          barPercentage: 0.8,
          categoryPercentage: 0.75
        }]
      },
      options: { 
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 10,
            bottom: 10
          }
        },
        plugins: { whiteGlow: { enabled: true }, 
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            titleColor: '#4B5563',
            bodyColor: '#374151',
            bodyFont: {
              size: 12
            },
            titleFont: {
              size: 13,
              weight: 'bold'
            },
            displayColors: false,
            padding: 10,
            borderColor: 'rgba(0, 0, 0, 0.1)',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                const value = context.raw;
                const total = posCount + negCount || 1;
                const percentage = Math.round((value / total) * 100);
                return `${value} emotions (${percentage}%)`;
              }
            }
          }
        }, 
        indexAxis: 'y',
        scales: {
          x: {
            grid: {
              display: false,
              drawBorder: false
            },
            ticks: {
              display: false
            }
          },
          y: {
            grid: {
              display: false,
              drawBorder: false
            }
          }
        },
        animation: {
          duration: 1500,
          easing: 'easeOutQuart'
        }
      }
    });
    const posnegList = document.getElementById('mood-stats-posneg-list');
    const totalEmotions = posCount + negCount;
    if (totalEmotions > 0) {
      const posPercentage = Math.round((posCount / totalEmotions) * 100);
      const negPercentage = Math.round((negCount / totalEmotions) * 100);
      posnegList.innerHTML = `
        <li class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-gray-300/20 shadow-sm transition-all hover:shadow-md hover:bg-white mb-3">
          <div class="flex items-center justify-between">
            <div class="">
              <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg, #90E1F9, #AEEBFF);margin-right:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"></span>
              <span class="font-medium text-gray-700">Positive</span>
              </button>
        </div>
            <div class="">
              <span class="font-bold text-cyan-600 mr-2">${posCount}</span>
              <span class="text-sm text-gray-500">(${posPercentage}%)</span>
              </button>
        </div>
        </div>
          <div class="mt-2 w-full bg-gray-100 rounded-full h-2 overflow-hidden">
            <div class="h-full rounded-full" style="width:${posPercentage}%;background:linear-gradient(135deg, #90E1F9, #AEEBFF);"></div>
        </div>
        </li>
        <li class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-pink-100/20 shadow-sm transition-all hover:shadow-md hover:bg-white">
          <div class="flex items-center justify-between">
            <div class="">
              <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg, #FF9EAA, #E8B2AE);margin-right:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"></span>
              <span class="font-medium text-gray-700">Negative</span>
              </button>
        </div>
            <div class="">
              <span class="font-bold text-pink-600 mr-2">${negCount}</span>
              <span class="text-sm text-gray-500">(${negPercentage}%)</span>
              </button>
        </div>
        </div>
          <div class="mt-2 w-full bg-gray-100 rounded-full h-2 overflow-hidden">
            <div class="h-full rounded-full" style="width:${negPercentage}%;background:linear-gradient(135deg, #FF9EAA, #E8B2AE);"></div>
        </div>
        </li>
      `;
    } else {
      posnegList.innerHTML = '<li class="bg-white/80 backdrop-blur-sm rounded-lg p-4 text-center text-gray-500">No emotion data available for this period.</li>';
    }
    // Negativity by Category Bar
    const negCatCounts = {};
    filtered.forEach(s => {
      if (s.emotions && negativeEmotions.some(e => s.emotions.includes(e))) {
        negCatCounts[s.category] = (negCatCounts[s.category] || 0) + 1;
      }
    });
    const negCatLabels = Object.keys(negCatCounts);
    const negCatData = negCatLabels.map(c => negCatCounts[c]);
    charts.negcatBar = new Chart(document.getElementById('mood-stats-negcat-bar').getContext('2d'), {
      type: 'bar',
      data: {
        labels: negCatLabels,
        datasets: [{
          data: negCatData,
          backgroundColor: function(context) {
            const index = context.dataIndex;
            const value = context.dataset.data[index];
            // Create a gradient array of colors from red to orange
            const gradientColors = [
              'rgba(255, 99, 132, 0.9)',
              'rgba(255, 116, 97, 0.9)',
              'rgba(255, 133, 75, 0.9)',
              'rgba(255, 150, 50, 0.9)',
              'rgba(255, 167, 25, 0.9)',
              'rgba(255, 183, 0, 0.9)',
              'rgba(255, 200, 0, 0.9)',
              'rgba(255, 217, 0, 0.9)'
            ];
            return gradientColors[index % gradientColors.length];
          },
          borderWidth: 0,
          borderRadius: 18,
          barPercentage: 0.8,
          categoryPercentage: 0.75
        }]
      },
      options: { 
        responsive: true,
        maintainAspectRatio: false,
        plugins: { whiteGlow: { enabled: true }, 
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            titleColor: '#4B5563',
            bodyColor: '#374151',
            bodyFont: {
              size: 12
            },
            titleFont: {
              size: 13,
              weight: 'bold'
            },
            displayColors: false,
            padding: 10,
            borderColor: 'rgba(0, 0, 0, 0.1)',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                const value = context.raw;
                const total = negCatData.reduce((sum, val) => sum + val, 0) || 1;
                const percentage = Math.round((value / total) * 100);
                return `${value} entries (${percentage}% of negative emotions)`;
              }
            }
          }
        }, 
        indexAxis: 'y',
        scales: {
          x: {
            grid: {
              display: false,
              drawBorder: false
            },
            ticks: {
              display: false
            }
          },
          y: {
            grid: {
              display: false,
              drawBorder: false
            }
          }
        },
        animation: {
          delay: function(context) {
            return context.dataIndex * 100;
          },
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });
    const negcatList = document.getElementById('mood-stats-negcat-list');
    const negcatExpandBtn = document.getElementById('negcat-list-expand');
    
    if (negCatLabels.length > 0) {
      // Combine the labels and data for sorting
      const combinedNegCatData = negCatLabels.map((label, index) => ({
        label,
        count: negCatData[index],
        color: catColors[index % catColors.length]
      }));
      
      // Sort by count descending
      combinedNegCatData.sort((a, b) => b.count - a.count);
      
      const totalNegCats = negCatData.reduce((sum, d) => sum + d, 0) || 1;
      
      // Create list items for all negative categories
      const allNegCatItems = combinedNegCatData.map((item, index) => {
        const percentage = Math.round((item.count / totalNegCats) * 100);
        return `
          <li class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-${item.color}/20 shadow-sm transition-all hover:shadow-md hover:bg-white mb-2 ${index >= 6 ? 'hidden extra-item' : ''}">
            <div class="flex items-center justify-between">
              <div class="">
                <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${categoryGradients[item.label] || item.color};margin-right:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"></span>
                <span class="font-medium text-gray-700">${item.label}</span>
                </button>
        </div>
              <div class="">
                <span class="font-bold text-red-500 mr-2">${item.count}</span>
                <span class="text-sm text-gray-500">(${percentage}%)</span>
                </button>
        </div>
              </button>
        </div>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-2 overflow-hidden">
              <div class="h-full rounded-full" style="width:${percentage}%;background:${categoryGradients[item.label] || item.color};"></div>
              </button>
        </div>
          </li>
        `;
      }).join('');
      
      negcatList.innerHTML = allNegCatItems;
      
      // Show expand button only if we have more than 6 items
      if (combinedNegCatData.length > 6) {
        negcatExpandBtn.classList.remove('hidden');
        
        // Add click event for the expand button
        const expandBtn = negcatExpandBtn.querySelector('button');
        expandBtn.addEventListener('click', function() {
          const expandText = this.querySelector('.expand-text');
          const collapseText = this.querySelector('.collapse-text');
          const extraItems = negcatList.querySelectorAll('.extra-item');
          
          // Toggle visibility of extra items
          extraItems.forEach(item => {
            item.classList.toggle('hidden');
          });
          
          // Toggle button text
          expandText.classList.toggle('hidden');
          collapseText.classList.toggle('hidden');
        });
      } else {
        negcatExpandBtn.classList.add('hidden');
      }
    } else {
      negcatList.innerHTML = '<li class="bg-white/80 backdrop-blur-sm rounded-lg p-4 text-center text-gray-500">No negative category data available for this period.</li>';
      negcatExpandBtn.classList.add('hidden');
    }
    // Monthly Entries Line Chart
    const monthlyCounts = {};
    filtered.forEach(s => {
      const d = new Date(s.date);
      const key = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
      monthlyCounts[key] = (monthlyCounts[key] || 0) + 1;
    });
    const monthNamesShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const monthKeys = Object.keys(monthlyCounts).sort();
    const months = monthKeys.map(key => {
      const [year, m] = key.split('-');
      return monthNamesShort[parseInt(m, 10) - 1] + ' ' + year;
    });
    const monthData = monthKeys.map(m => monthlyCounts[m]);
    const ctx = document.getElementById('mood-stats-monthly-line').getContext('2d');
    function getLineGradient(ctx, chartArea) {
      const grad = ctx.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
      grad.addColorStop(0, '#6366F1');  // Indigo
      grad.addColorStop(0.25, '#8B5CF6'); // Purple
      grad.addColorStop(0.5, '#A855F7');  // Purple/Pink
      grad.addColorStop(0.75, '#EC4899'); // Pink
      grad.addColorStop(1, '#3B82F6');    // Blue
      return grad;
    }
    function getFillGradient(ctx, chartArea) {
      const grad = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
      grad.addColorStop(0, 'rgba(99, 102, 241, 0.25)');   // Indigo
      grad.addColorStop(0.25, 'rgba(139, 92, 246, 0.20)'); // Purple
      grad.addColorStop(0.5, 'rgba(168, 85, 247, 0.15)');  // Purple/Pink
      grad.addColorStop(0.75, 'rgba(236, 72, 153, 0.10)'); // Pink
      grad.addColorStop(1, 'rgba(59, 130, 246, 0.05)');    // Blue
      return grad;
    }
    const forecastCount = 3;
    const lastSolid = monthData.length - forecastCount > 0 ? monthData.length - forecastCount : monthData.length;
    const shadowPlugin = {
      id: 'shadowLine',
      beforeDatasetsDraw(chart) {
        const ctx = chart.ctx;
        ctx.save();
        ctx.shadowColor = 'rgba(139,92,246,0.13)';
        ctx.shadowBlur = 14;
      },
      afterDatasetsDraw(chart) {
        chart.ctx.restore();
      }
    };
    charts.monthlyLine = new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          data: monthData,
          label: 'Entries',
          fill: true,
          borderColor: function(context) {
            const chart = context.chart;
            const {ctx, chartArea} = chart;
            if (!chartArea) return '#B5AFFF';
            return getLineGradient(ctx, chartArea);
          },
          backgroundColor: function(context) {
            const chart = context.chart;
            const {ctx, chartArea} = chart;
            if (!chartArea) return 'rgba(181,175,255,0.10)';
            return getFillGradient(ctx, chartArea);
          },
          tension: 0.8, // Smoother spline curves for mood-wave effect
          pointRadius: 6,
          pointBackgroundColor: '#fff',
          pointBorderColor: '#B5AFFF',
          pointBorderWidth: 0, // No border for filled circles
          borderWidth: 4,
          segment: {
            borderDash: ctx => ctx.p0DataIndex >= lastSolid-1 ? [6,6] : [],
            borderColor: ctx => {
              const chart = ctx.chart;
              const {ctx: c, chartArea} = chart;
              if (!chartArea) return '#B5AFFF';
              return getLineGradient(c, chartArea);
            }
          },
          order: 1,
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 15,
            right: 15,
            bottom: 15,
            left: 15
          }
        },
        plugins: { whiteGlow: { enabled: true },
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#4B5563',
            bodyColor: '#374151',
            bodyFont: {
              size: 13
            },
            titleFont: {
              size: 14,
              weight: 'bold'
            },
            displayColors: false,
            padding: 12,
            borderColor: 'rgba(0, 0, 0, 0.05)',
            borderWidth: 1,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                return `${context.raw} entries recorded`;
              }
            }
          }
        },
        elements: { 
          line: { 
            borderJoinStyle: 'round',
            capBezierPoints: true,
            borderWidth: 5
          },
          point: {
            radius: 7,
            hoverRadius: 9,
            hoverBorderWidth: 3,
            hitRadius: 12,
            borderWidth: 3
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        },
        scales: {
          y: { 
            beginAtZero: true, 
            grid: { 
              display: !(window.innerWidth <= 768 && window.innerHeight > window.innerWidth),
              color: 'rgba(0, 0, 0, 0.05)',
              drawBorder: false
            },
            ticks: {
              padding: 10,
              color: 'rgba(0, 0, 0, 0.6)',
              font: {
                size: 11
              }
            }
          },
          x: { 
            grid: { 
              display: false,
              drawBorder: false
            },
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              padding: 10,
              color: 'rgba(0, 0, 0, 0.6)',
              font: {
                size: 11
              }
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutQuart'
        }
      },
      plugins: [shadowPlugin]
    });
    const monthlyList = document.getElementById('mood-stats-monthly-list');
    const monthlyExpandBtn = document.getElementById('monthly-list-expand');
    
    if (months.length > 0) {
      // Combine month labels and data for sorting
      const combinedMonthData = months.map((month, index) => ({
        month,
        count: monthData[index]
      }));
      
      // Sort by count descending (most entries first)
      combinedMonthData.sort((a, b) => b.count - a.count);
      
      const maxMonth = Math.max(...monthData);
      
      // Create list items for all months
      const allMonthItems = combinedMonthData.map((item, index) => {
        const percentage = Math.round((item.count / maxMonth) * 100); // Relative to max month
        return `
          <li class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-indigo-100/20 shadow-sm transition-all hover:shadow-md hover:bg-white mb-2 ${index >= 6 ? 'hidden extra-item' : ''}">
            <div class="flex items-center justify-between">
              <div class="">
                <span class="material-icons text-indigo-400 mr-2" style="font-size: 18px;">calendar_month</span>
                <span class="font-medium text-gray-700">${item.month}</span>
                </button>
        </div>
              <span class="font-bold text-indigo-600">${item.count}</span>
              </button>
        </div>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-2 overflow-hidden">
              <div class="h-full rounded-full bg-gradient-to-r from-indigo-500 to-blue-400" style="width:${percentage}%;"></div>
              </button>
        </div>
          </li>
        `;
      }).join('');
      
      monthlyList.innerHTML = allMonthItems;
      
      // Show expand button only if we have more than 6 items
      if (combinedMonthData.length > 6) {
        monthlyExpandBtn.classList.remove('hidden');
        
        // Add click event for the expand button
        const expandBtn = monthlyExpandBtn.querySelector('button');
        expandBtn.addEventListener('click', function() {
          const expandText = this.querySelector('.expand-text');
          const collapseText = this.querySelector('.collapse-text');
          const extraItems = monthlyList.querySelectorAll('.extra-item');
          
          // Toggle visibility of extra items
          extraItems.forEach(item => {
            item.classList.toggle('hidden');
          });
          
          // Toggle button text
          expandText.classList.toggle('hidden');
          collapseText.classList.toggle('hidden');
        });
      } else {
        monthlyExpandBtn.classList.add('hidden');
      }
    } else {
      monthlyList.innerHTML = '<li class="bg-white/80 backdrop-blur-sm rounded-lg p-4 text-center text-gray-500">No monthly data available for this period.</li>';
      monthlyExpandBtn.classList.add('hidden');
    }
  }
  // Make sure we render the charts immediately with ALL data when the section is visible
  // This needs to happen after the page has fully loaded so all elements are available
  window.addEventListener('DOMContentLoaded', function() {
    // Ensure All filter is selected
    const allFilterBtn = document.querySelector('.mood-stats-filter-btn[data-range="all"]');
    if (allFilterBtn) {
      allFilterBtn.classList.add('bg-purple-100', 'text-purple-700');
      allFilterBtn.classList.remove('bg-white/30', 'text-gray-700');
    }
    
    // Force the rendering with all data
    currentStatsRange = 'all';
    emotiaRenderEmotionsBubbleChart("week"); emotiaRenderPositivityChart("week");
    
    // Initialize therapist availability data
    if (typeof window.initializeAvailabilityData === 'function' && window.therapistData) {
      console.log('üóìÔ∏è Initializing therapist availability data on page load...');
      window.initializeAvailabilityData();
    }
  });
  
  // Also trigger the initial render directly to ensure it works even without the DOM event
  setTimeout(() => {
    emotiaRenderEmotionsBubbleChart("week"); emotiaRenderPositivityChart("week");
  }, 100);

// Immediate setup as backup
(function() {
})();})();
</script>




<!-- Journalia Logic -->
<script>
// Create Journey Section for Journalia
function createSummarySection() {
  const summarySection = document.createElement('div');
  summarySection.className = 'bg-white rounded-3xl p-8 shadow-lg';
  
  summarySection.innerHTML = `
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-xl font-bold text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Journey</h2>
      <div id="data-status" class="text-sm text-gray-500">Loading data...</div>
    </div>
    
    <!-- Sticky Notes Metrics -->
    <div class="sticky-notes-container">
      <div class="note-container">
        <div class="sticky-note sticky-note-one">
          <div class="note-value" id="total-entries">12</div>
          <div class="note-label">Total Entries</div>
        </div>
      </div>
      <div class="note-container">
        <div class="sticky-note sticky-note-two">
          <div class="note-value" id="longest-streak">7</div>
          <div class="note-label">Longest Streak</div>
          <div class="note-sublabel">days</div>
        </div>
      </div>
      <div class="note-container">
        <div class="sticky-note sticky-note-three">
          <div class="note-value" id="weekly-mood">Pleasant</div>
          <div class="note-label">Weekly Mood</div>
          <div class="note-sublabel">most frequent</div>
        </div>
      </div>
    </div>
    
    <!-- Affirmation Quote -->
    <div class="quote-box">
      <p class="quote-text" id="daily-affirmation">The story you tell yourself about yourself becomes your reality.</p>
      <div class="quote-author" id="quote-author">‚Äî Carl Jung</div>
    </div>
  `;
  
  journaliaSections.appendChild(summarySection);
  
  // Don't initialize Journey data here - wait for Story Threads data to be ready
}

// Initialize Journey Data
function initializeSummaryData() {
  // Calculate metrics
  calculateSummaryMetrics();
  
  // Set random affirmation quote
  setRandomAffirmationQuote();
}

// Calculate Journey Metrics
function calculateSummaryMetrics() {
  console.log('Calculating journey metrics...');
  
  // Get comprehensive entries from Story Threads data
  let allEntries = [];
  
  // Combine all Story Threads entries
  if (window.lifeChaptersData) {
    Object.values(window.lifeChaptersData).forEach(categoryEntries => {
      allEntries = allEntries.concat(categoryEntries);
    });
    console.log('Story Threads entries found:', allEntries.length);
  } else {
    console.log('No Story Threads data found');
  }
  
  // Also include basic journal entries
  const basicEntries = window.journaliaState?.entries || {};
  const basicEntriesArray = Object.keys(basicEntries).map(date => ({
    date: date,
    text: basicEntries[date],
    mood: 'neutral' // Default mood for basic entries
  }));
  
  allEntries = allEntries.concat(basicEntriesArray);
  console.log('Total entries (Story Threads + basic):', allEntries.length);
  
  const totalEntries = allEntries.length;
  
  // Calculate longest streak based on all entries
  const longestStreak = calculateLongestStreakFromEntries(allEntries);
  
  // Calculate weekly mood based on Story Threads data
  const weeklyMood = calculateWeeklyMoodFromEntries(allEntries);
  
  console.log('Journey metrics:', { totalEntries, longestStreak, weeklyMood });
  
  // Update the UI
  document.getElementById('total-entries').textContent = totalEntries;
  document.getElementById('longest-streak').textContent = longestStreak;
  document.getElementById('weekly-mood').textContent = weeklyMood;
  
  // Hide data status completely since we removed the entries loaded message
  const dataStatus = document.getElementById('data-status');
  if (dataStatus) {
    dataStatus.style.display = 'none';
  }
}

// Calculate longest writing streak from Story Threads entries
function calculateLongestStreakFromEntries(entries) {
  if (entries.length === 0) return 0;
  
  // Get unique dates and sort them
  const uniqueDates = [...new Set(entries.map(entry => entry.date))].sort();
  
  if (uniqueDates.length <= 1) return uniqueDates.length;
  
  let currentStreak = 1;
  let longestStreak = 1;
  
  for (let i = 1; i < uniqueDates.length; i++) {
    const currentDate = new Date(uniqueDates[i]);
    const previousDate = new Date(uniqueDates[i - 1]);
    const dayDifference = (currentDate - previousDate) / (1000 * 60 * 60 * 24);
    
    if (dayDifference === 1) {
      currentStreak++;
      longestStreak = Math.max(longestStreak, currentStreak);
    } else {
      currentStreak = 1;
    }
  }
  
  return longestStreak;
}

// Legacy function for backwards compatibility
function calculateLongestStreak(entries) {
  if (Object.keys(entries).length === 0) return 0;
  
  const dates = Object.keys(entries).sort();
  let currentStreak = 1;
  let longestStreak = 1;
  
  for (let i = 1; i < dates.length; i++) {
    const currentDate = new Date(dates[i]);
    const previousDate = new Date(dates[i - 1]);
    const dayDifference = (currentDate - previousDate) / (1000 * 60 * 60 * 24);
    
    if (dayDifference === 1) {
      currentStreak++;
      longestStreak = Math.max(longestStreak, currentStreak);
    } else {
      currentStreak = 1;
    }
  }
  
  return longestStreak;
}

// Calculate most frequent mood this week from Story Threads entries
function calculateWeeklyMoodFromEntries(entries) {
  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
  weekStart.setHours(0, 0, 0, 0);
  
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  weekEnd.setHours(23, 59, 59, 999);
  
  const moodCounts = {};
  
  // Count moods from entries within this week
  entries.forEach(entry => {
    const entryDate = new Date(entry.date);
    if (entryDate >= weekStart && entryDate <= weekEnd && entry.mood) {
      const moodLabel = getMoodLabel(entry.mood);
      moodCounts[moodLabel] = (moodCounts[moodLabel] || 0) + 1;
    }
  });
  
  // Find most frequent mood
  let mostFrequentMood = 'Pleasant'; // Default
  let maxCount = 0;
  
  for (const [mood, count] of Object.entries(moodCounts)) {
    if (count > maxCount) {
      maxCount = count;
      mostFrequentMood = mood;
    }
  }
  
  return mostFrequentMood;
}

// Legacy function for backwards compatibility
function calculateWeeklyMood() {
  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
  
  const moodCounts = {};
  
  // Check moods for this week
  for (let i = 0; i < 7; i++) {
    const checkDate = new Date(weekStart);
    checkDate.setDate(weekStart.getDate() + i);
    const dateString = checkDate.toISOString().split('T')[0];
    
    const moodKey = `journal-mood-${dateString}`;
    const mood = localStorage.getItem(moodKey);
    
    if (mood) {
      const moodLabel = getMoodLabel(mood);
      moodCounts[moodLabel] = (moodCounts[moodLabel] || 0) + 1;
    }
  }
  
  // Find most frequent mood
  let mostFrequentMood = 'Pleasant'; // Default
  let maxCount = 0;
  
  for (const [mood, count] of Object.entries(moodCounts)) {
    if (count > maxCount) {
      maxCount = count;
      mostFrequentMood = mood;
    }
  }
  
  return mostFrequentMood;
}

// Convert mood key to readable label
function getMoodLabel(moodKey) {
  const moodLabels = {
    'very-unpleasant': 'Very Unpleasant',
    'unpleasant': 'Unpleasant',
    'slight-unpleasant': 'Slight Unpleasant',
    'neutral': 'Neutral',
    'slight-pleasant': 'Slight Pleasant',
    'pleasant': 'Pleasant',
    'very-pleasant': 'Very Pleasant'
  };
  
  return moodLabels[moodKey] || 'Pleasant';
}

// Set Random Affirmation Quote
function setRandomAffirmationQuote() {
  const affirmationQuotes = [
    {
      text: "The story you tell yourself about yourself becomes your reality.",
      author: "Carl Jung"
    },
    {
      text: "Your life is your story. Write well. Edit often.",
      author: "Susan Statham"
    },
    {
      text: "The privilege of a lifetime is to become who you truly are.",
      author: "Carl Jung"
    },
    {
      text: "What lies behind us and what lies before us are tiny matters compared to what lies within us.",
      author: "Ralph Waldo Emerson"
    },
    {
      text: "You are the author of your own life story. Make it a bestseller.",
      author: "Unknown"
    },
    {
      text: "The cave you fear to enter holds the treasure you seek.",
      author: "Joseph Campbell"
    },
    {
      text: "Everything you need is inside you ‚Äì you just need to access it.",
      author: "Buddha"
    },
    {
      text: "Your thoughts become your words, your words become your actions, your actions become your destiny.",
      author: "Mahatma Gandhi"
    },
    {
      text: "The only way to make sense out of change is to plunge into it, move with it, and join the dance.",
      author: "Alan Watts"
    },
    {
      text: "What we think, we become. What we feel, we attract. What we imagine, we create.",
      author: "Buddha"
    },
    {
      text: "You have been assigned this mountain to show others it can be moved.",
      author: "Mel Robbins"
    },
    {
      text: "The most powerful relationship you will ever have is the relationship with yourself.",
      author: "Steve Maraboli"
    },
    {
      text: "Your journal is a place where you can be completely honest with yourself.",
      author: "Julia Cameron"
    },
    {
      text: "Writing is the painting of the voice.",
      author: "Voltaire"
    },
    {
      text: "The act of writing is the act of discovering what you believe.",
      author: "David Hare"
    }
  ];
  
  // Get a random quote
  const randomIndex = Math.floor(Math.random() * affirmationQuotes.length);
  const selectedQuote = affirmationQuotes[randomIndex];
  
  // Update the UI
  document.getElementById('daily-affirmation').textContent = selectedQuote.text;
  document.getElementById('quote-author').textContent = `‚Äî ${selectedQuote.author}`;
}

// Create Story Threads Section for Journalia
function createStoryThreadsSection() {
  const lifeChaptersSection = document.createElement('div');
  lifeChaptersSection.className = 'bg-white rounded-3xl p-8 shadow-lg  mt-8';
  
  lifeChaptersSection.innerHTML = `
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-xl font-bold text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Story Threads</h2>
    </div>
    
    <!-- Category Selection -->
    <div class="category-selection mb-8">
      <p class="category-instruction">Choose from below categories</p>
      <ul class="category-cloud" role="navigation" aria-label="Story threads categories">
        <li><a href="#" data-category="self" data-size="2.4rem" data-color="#F59E0B">Self</a></li>
        <li><a href="#" data-category="social" data-size="2.6rem" data-color="#6B7280">Social</a></li>
        <li><a href="#" data-category="friends" data-size="2.1rem" data-color="#3F3F46">Friends</a></li>
        <li><a href="#" data-category="family" data-size="2rem" data-color="#EF4444">Family</a></li>
        <li><a href="#" data-category="work" data-size="2.3rem" data-color="#3B82F6">Work</a></li>
        <li><a href="#" data-category="studies" data-size="1.9rem" data-color="#60A5FA">Studies</a></li>
        <li><a href="#" data-category="creativity" data-size="2.1rem" data-color="#10B981">Creativity</a></li>
        <li><a href="#" data-category="challenges" data-size="2.8rem" data-color="#EC4899">Challenges</a></li>
        <li><a href="#" data-category="health" data-size="2rem" data-color="#F87171">Health</a></li>
        <li><a href="#" data-category="finance" data-size="1.8rem" data-color="#8B5CF6">Finance</a></li>
        <li><a href="#" data-category="spirituality" data-size="1.7rem" data-color="#6366F1">Spirituality</a></li>
        <li><a href="#" data-category="joy-fun" data-size="2.2rem" data-color="#FBBF24">Joy & Fun</a></li>
        <li><a href="#" data-category="growth" data-size="1.9rem" data-color="#22D3EE">Growth</a></li>
        <li><a href="#" data-category="travel" data-size="2rem" data-color="#0EA5E9">Travel</a></li>
      </ul>
    </div>
    
    <!-- Timeline Container -->
    <div class="timeline-container" id="timeline-container" style="display: none;">
      <div class="timeline-header">
        <h3 id="timeline-title" class="timeline-title"></h3>
        <button class="timeline-close" id="timeline-close">
          <span class="material-icons">close</span>
      </div>
      <div class="timeline-content" id="timeline-content">
        <!-- Timeline items will be populated here -->
      </div>
    </div>
  `;
  
  journaliaSections.appendChild(lifeChaptersSection);
  
  // Initialize Story Threads functionality
  initializeLifeChapters();
}

// Initialize Story Threads functionality
function initializeLifeChapters() {
  console.log('Initializing Story Threads...');
  
  // Demo data for story threads (AI would categorize these in real implementation)
  const lifeChaptersData = {
    self: [
      { date: '2025-06-22', text: "Started a new morning routine with 10 minutes of journaling and meditation. Already feeling more centered and focused. It's amazing how small changes can have such a big impact on my mindset.", mood: 'pleasant', summary: "New morning routine success" },
      { date: '2025-06-20', text: "Had my therapy session today and we talked about my progress with anxiety management. Dr. Martinez says I'm making real strides in recognizing my triggers before they escalate.", mood: 'pleasant', summary: "Therapy progress check-in" },
      { date: '2025-06-18', text: "Finished reading 'Atomic Habits' and I'm inspired to implement some of the strategies. The concept of habit stacking really resonates with me - linking new habits to existing ones.", mood: 'pleasant', summary: "Self-improvement book insights" },
      { date: '2025-06-16', text: "Struggled with imposter syndrome at work today. Felt like I don't deserve the promotion I got last month. Need to work on my self-worth and remember my achievements.", mood: 'unpleasant', summary: "Imposter syndrome struggles" },
      { date: '2025-06-14', text: "Went for a solo walk in the park and practiced mindfulness. Noticed how much my mind wanders when I'm not actively focusing. This awareness itself feels like progress.", mood: 'pleasant', summary: "Mindfulness practice outdoors" },
      { date: '2025-06-12', text: "Had a panic attack this morning but managed to use the breathing techniques Dr. Martinez taught me. It passed much quicker than usual - I'm learning to trust the process.", mood: 'slight-unpleasant', summary: "Anxiety management success" },
      { date: '2025-06-10', text: "Reflected on how much I've grown this year. The challenges were hard but they've made me stronger and more resilient. I'm proud of how I've handled everything.", mood: 'pleasant', summary: "Personal growth reflection" },
      { date: '2025-06-08', text: "Started tracking my mood daily and noticed patterns I hadn't seen before. My anxiety spikes seem to correlate with poor sleep and too much caffeine.", mood: 'neutral', summary: "Self-awareness breakthrough" },
      { date: '2025-06-06', text: "Feeling overwhelmed with all the self-improvement goals I've set. Maybe I need to focus on one thing at a time instead of trying to change everything at once.", mood: 'slight-unpleasant', summary: "Goal overwhelm realization" },
      { date: '2025-06-04', text: "Celebrated a small victory today - I spoke up in the team meeting instead of staying silent. It felt scary but empowering at the same time.", mood: 'pleasant', summary: "Confidence building moment" }
    ],
    social: [
      { date: '2025-06-23', text: "Attended a networking event for professionals in my field. Met some interesting people and had great conversations about industry trends and future opportunities.", mood: 'pleasant', summary: "Professional networking success" },
      { date: '2025-06-21', text: "Mom called to check on me and we ended up talking for two hours. She shared some stories about her own struggles at my age that really put things in perspective.", mood: 'pleasant', summary: "Deep conversation with mom" },
      { date: '2025-06-20', text: "Had a disagreement with my colleague Sarah about the project approach. I felt frustrated but managed to stay calm and find a compromise. Our working relationship is stronger now.", mood: 'slight-unpleasant', summary: "Workplace conflict resolution" },
      { date: '2025-06-18', text: "My partner and I had our monthly relationship check-in. We talked about our goals, what's working, and what needs improvement. These conversations keep us connected.", mood: 'pleasant', summary: "Relationship maintenance talk" },
      { date: '2025-06-16', text: "Went to my nephew's birthday party. Watching him blow out his candles with such pure joy reminded me of the simple happiness that comes from family moments.", mood: 'very-pleasant', summary: "Family celebration joy" },
      { date: '2025-06-14', text: "Had coffee with my neighbor Mrs. Chen. She's 82 and full of wisdom about life. Her perspective on patience and resilience really struck a chord with me.", mood: 'pleasant', summary: "Intergenerational wisdom exchange" },
      { date: '2025-06-12', text: "My best friend Lisa is going through a tough divorce. I spent the evening just listening to her and offering support. Sometimes being present is the most valuable gift.", mood: 'neutral', summary: "Supporting friend through crisis" },
      { date: '2025-06-10', text: "Family dinner was chaotic with all the cousins visiting, but filled with laughter and stories. Sometimes I forget how lucky I am to have such a close-knit family.", mood: 'pleasant', summary: "Extended family gathering" },
      { date: '2025-06-08', text: "Had a meaningful conversation with my partner about our future plans. We talked about buying a house, maybe having kids someday. It feels good to dream together.", mood: 'very-pleasant', summary: "Future planning with partner" },
      { date: '2025-06-06', text: "Small argument with my partner about household chores, but we talked it through calmly. Learning that communication is key to our relationship working well.", mood: 'neutral', summary: "Relationship communication practice" },
      { date: '2025-06-04', text: "Reached out to an old friend I hadn't talked to in months. We made plans to meet up next week. It's funny how we assume people are too busy for us when they're usually just as eager to reconnect.", mood: 'pleasant', summary: "Reconnecting with old friend" }
    ],
    friends: [
      { date: '2025-06-23', text: "Had dinner with my college friends who were visiting from out of town. We laughed about old memories and I realized how much I've missed having that kind of deep connection with people.", mood: 'very-pleasant', summary: "College friends reunion" },
      { date: '2025-06-21', text: "My best friend Lisa is going through a tough divorce. I spent the evening just listening to her and offering support. Sometimes being present is the most valuable gift.", mood: 'neutral', summary: "Supporting friend through crisis" },
      { date: '2025-06-19', text: "Went to that new restaurant with friends and we laughed until our stomachs hurt. Good food, great company, and terrible jokes - perfect combination for happiness.", mood: 'very-pleasant', summary: "Friends dinner joy" },
      { date: '2025-06-17', text: "Had a disagreement with my best friend about something important to both of us. We haven't talked in three days and I'm not sure how to bridge this gap.", mood: 'unpleasant', summary: "Friendship conflict strain" },
      { date: '2025-06-15', text: "Reached out to an old friend I hadn't talked to in months. We made plans to meet up next week. It's funny how we assume people are too busy for us when they're usually just as eager to reconnect.", mood: 'pleasant', summary: "Reconnecting with old friend" }
    ],
    family: [
      { date: '2025-06-22', text: "Mom called to check on me and we ended up talking for two hours. She shared some stories about her own struggles at my age that really put things in perspective.", mood: 'pleasant', summary: "Deep conversation with mom" },
      { date: '2025-06-20', text: "Went to my nephew's birthday party. Watching him blow out his candles with such pure joy reminded me of the simple happiness that comes from family moments.", mood: 'very-pleasant', summary: "Family celebration joy" },
      { date: '2025-06-18', text: "Family dinner was chaotic with all the cousins visiting, but filled with laughter and stories. Sometimes I forget how lucky I am to have such a close-knit family.", mood: 'pleasant', summary: "Extended family gathering" },
      { date: '2025-06-16', text: "Dealing with my father's health scare has been emotionally draining. I'm trying to balance being supportive while also taking care of my own mental health.", mood: 'unpleasant', summary: "Family health crisis stress" },
      { date: '2025-06-14', text: "Had coffee with my neighbor Mrs. Chen. She's 82 and full of wisdom about life. Her perspective on patience and resilience really struck a chord with me.", mood: 'pleasant', summary: "Intergenerational wisdom exchange" }
    ],
    work: [
      { date: '2025-06-23', text: "Got assigned to lead the new sustainability initiative at work. It's exactly the kind of meaningful project I've been hoping for - something that aligns with my values and makes a real impact.", mood: 'very-pleasant', summary: "Meaningful project assignment" },
      { date: '2025-06-21', text: "Had my quarterly review and received really positive feedback. My manager mentioned that my communication skills have improved significantly since I started therapy.", mood: 'pleasant', summary: "Positive performance review" },
      { date: '2025-06-19', text: "Attended a professional development workshop on leadership. Learned about different management styles and realized I need to work on being more decisive in my approach.", mood: 'pleasant', summary: "Leadership development learning" },
      { date: '2025-06-17', text: "Feeling stuck in my current role and wondering if it's time for a career change. The work feels routine and I'm not learning anything new. Need to think about my next steps.", mood: 'slight-unpleasant', summary: "Career stagnation concerns" },
      { date: '2025-06-15', text: "Presented my project to the executive team and it went better than expected. They approved the budget increase I requested and praised the thoroughness of my research.", mood: 'very-pleasant', summary: "Executive presentation success" },
      { date: '2025-06-13', text: "Mentored a new intern today and remembered why I love helping others grow. Teaching someone else helped me see my own expertise more clearly.", mood: 'pleasant', summary: "Mentoring experience joy" },
      { date: '2025-06-11', text: "Struggled with the new software implementation. Felt frustrated and behind compared to my colleagues who seem to pick it up so easily. Imposter syndrome is creeping in again.", mood: 'unpleasant', summary: "Technology learning struggles" },
      { date: '2025-06-09', text: "Had a brainstorming session with my team and came up with some innovative solutions to our client's problems. I love these moments when creativity and collaboration come together.", mood: 'pleasant', summary: "Creative collaboration success" },
      { date: '2025-06-07', text: "Took an online course on project management during my lunch break. Investing in my skills feels empowering, even when I'm tired after a long day.", mood: 'pleasant', summary: "Skill development investment" },
      { date: '2025-06-05', text: "Feeling overwhelmed with work deadlines and competing priorities. Used the time management techniques from that productivity book I read. It helped me feel more in control.", mood: 'slight-unpleasant', summary: "Deadline pressure management" }
    ],
    finance: [
      { date: '2025-06-22', text: "Finally paid off my credit card debt completely! It took 18 months of disciplined budgeting but I did it. This feels like such a huge weight off my shoulders.", mood: 'very-pleasant', summary: "Debt freedom celebration" },
      { date: '2025-06-20', text: "Met with a financial advisor to discuss my retirement planning. It's overwhelming to think about but I'm glad I'm starting to plan for the future at my age.", mood: 'neutral', summary: "Retirement planning consultation" },
      { date: '2025-06-18', text: "Received my quarterly bonus and immediately transferred half to my emergency fund. It feels good to prioritize financial security over immediate gratification.", mood: 'pleasant', summary: "Emergency fund contribution" },
      { date: '2025-06-16', text: "Went grocery shopping with a strict budget and managed to stay under my limit. These small victories in financial discipline are adding up to bigger changes.", mood: 'pleasant', summary: "Budget discipline success" },
      { date: '2025-06-14', text: "Car repair bill was higher than expected and it stressed me out. But I realized I can handle it without going into debt, which shows my financial planning is working.", mood: 'slight-unpleasant', summary: "Unexpected expense handling" },
      { date: '2025-06-12', text: "Started using a budgeting app to track my expenses more carefully. Seeing where my money goes in real-time is eye-opening and a bit shocking.", mood: 'neutral', summary: "Expense tracking revelation" },
      { date: '2025-06-10', text: "Worried about upcoming expenses for my sister's wedding. Need to be more mindful about spending this month while still being able to celebrate with family.", mood: 'slight-unpleasant', summary: "Wedding expense anxiety" },
      { date: '2025-06-08', text: "Opened a high-yield savings account and set up automatic transfers. It's a small step but it feels like I'm finally taking control of my financial future.", mood: 'pleasant', summary: "Savings automation setup" },
      { date: '2025-06-06', text: "Declined going out to an expensive dinner with friends because it wasn't in my budget. It was hard but I'm learning to say no to things that don't align with my financial goals.", mood: 'neutral', summary: "Budget boundary setting" },
      { date: '2025-06-04', text: "Calculated my net worth for the first time and was surprised it's higher than I thought. All those small savings and debt payments are actually making a difference.", mood: 'pleasant', summary: "Net worth calculation surprise" }
    ],
    creativity: [
      { date: '2025-06-23', text: "Spent the entire Saturday afternoon painting in my makeshift studio. Lost track of time completely and emerged with a piece I'm actually proud of. Art is my sanctuary.", mood: 'very-pleasant', summary: "Artistic flow state achievement" },
      { date: '2025-06-21', text: "Joined a local photography club and went on my first group photo walk. Being around other creative people energized me and gave me new perspectives on composition.", mood: 'pleasant', summary: "Creative community connection" },
      { date: '2025-06-19', text: "Finished writing the first chapter of the novel I've been thinking about for years. It's rough but it exists, and that feels like a monumental achievement.", mood: 'very-pleasant', summary: "Novel writing breakthrough" },
      { date: '2025-06-17', text: "Tried a new recipe I found online and it turned out amazing. Cooking is becoming another creative outlet for me - there's something satisfying about creating something delicious from scratch.", mood: 'pleasant', summary: "Culinary creativity success" },
      { date: '2025-06-15', text: "Attended a pottery class and made my first bowl. It's lopsided and imperfect but I love it. There's something meditative about working with clay.", mood: 'pleasant', summary: "Pottery class discovery" },
      { date: '2025-06-13', text: "Struggling with creative block on my painting project. Every color choice feels wrong and I'm second-guessing every brushstroke. Maybe I need to step away for a while.", mood: 'slight-unpleasant', summary: "Creative block frustration" },
      { date: '2025-06-11', text: "Rearranged my living room to create a dedicated creative space. Having a designated area for my art supplies makes me more likely to actually use them.", mood: 'pleasant', summary: "Creative space organization" },
      { date: '2025-06-09', text: "Visited an art museum and felt inspired by the contemporary exhibits. Sometimes seeing other people's creativity is the best fuel for my own artistic endeavors.", mood: 'pleasant', summary: "Museum inspiration visit" },
      { date: '2025-06-07', text: "Started a creative journal where I sketch ideas and write random thoughts. It's becoming a repository of inspiration that I can return to when I'm feeling stuck.", mood: 'pleasant', summary: "Creative journal initiation" },
      { date: '2025-06-05', text: "Felt frustrated with my artistic abilities today. Comparing my work to others on social media is killing my motivation. Need to focus on my own journey and progress.", mood: 'unpleasant', summary: "Comparison trap struggle" }
    ],
    studies: [
      { date: '2025-06-23', text: "Finished my online course on data analysis and received my certificate. It feels great to be learning new skills that will help advance my career.", mood: 'pleasant', summary: "Course completion success" },
      { date: '2025-06-21', text: "Struggling with the advanced statistics module in my course. The concepts are challenging but I'm determined to push through and understand them.", mood: 'slight-unpleasant', summary: "Academic challenge persistence" },
      { date: '2025-06-19', text: "Joined a study group for my certification program. Having other people to discuss concepts with makes learning so much more engaging.", mood: 'pleasant', summary: "Study group collaboration" },
      { date: '2025-06-17', text: "Set up a dedicated study schedule with specific goals for each week. Organization and structure help me stay motivated and track progress.", mood: 'pleasant', summary: "Study routine establishment" },
      { date: '2025-06-15', text: "Aced my midterm exam! All those late-night study sessions and practice problems really paid off. Feeling confident about the rest of the course.", mood: 'very-pleasant', summary: "Academic achievement celebration" }
    ],
    health: [
      { date: '2025-06-23', text: "Started a new workout routine with a personal trainer. It's challenging but I can already feel myself getting stronger after just two weeks.", mood: 'pleasant', summary: "Fitness journey beginning" },
      { date: '2025-06-21', text: "Had my annual physical and all my numbers look good. Doctor said my blood pressure has improved since I started exercising regularly.", mood: 'pleasant', summary: "Positive health checkup" },
      { date: '2025-06-19', text: "Meal prepped for the entire week with healthy, balanced meals. Taking control of my nutrition feels empowering and saves time during busy weekdays.", mood: 'pleasant', summary: "Nutrition planning success" },
      { date: '2025-06-17', text: "Feeling under the weather with a cold. Taking time to rest and recover instead of pushing through like I usually do.", mood: 'slight-unpleasant', summary: "Self-care during illness" },
      { date: '2025-06-15', text: "Completed my first 5K run without stopping! Six months ago I could barely run for 5 minutes. Progress feels amazing.", mood: 'very-pleasant', summary: "Running milestone achievement" }
    ],
    'joy-fun': [
      { date: '2025-06-23', text: "Went to a concert with my partner and danced like nobody was watching. The music was incredible and I felt so alive and free. These moments remind me why life is beautiful.", mood: 'very-pleasant', summary: "Concert euphoria experience" },
      { date: '2025-06-21', text: "Planning our summer vacation to Costa Rica has me so excited. Researching activities and reading about the culture is almost as fun as the trip itself will be.", mood: 'very-pleasant', summary: "Vacation planning excitement" },
      { date: '2025-06-19', text: "Went to that new restaurant with friends and we laughed until our stomachs hurt. Good food, great company, and terrible jokes - perfect combination for happiness.", mood: 'very-pleasant', summary: "Friends dinner joy" },
      { date: '2025-06-17', text: "Discovered a new hiking trail and spent the morning exploring. The views were breathtaking and I felt so grateful to live in such a beautiful area.", mood: 'pleasant', summary: "Nature exploration adventure" },
      { date: '2025-06-15', text: "Had a game night with my neighbors and we played board games until 2 AM. It's been so long since I've laughed that hard. Simple pleasures are often the best.", mood: 'very-pleasant', summary: "Game night community fun" },
      { date: '2025-06-13', text: "Movie night with my partner - we watched an old comedy and ate way too much popcorn. Sometimes the simple pleasures are the most satisfying.", mood: 'pleasant', summary: "Cozy movie night" },
      { date: '2025-06-11', text: "Tried axe throwing for the first time and was surprisingly good at it! It was such a unique and fun way to spend an afternoon with friends.", mood: 'pleasant', summary: "New activity adventure" },
      { date: '2025-06-09', text: "Spent the day at the beach reading a book and swimming. The sun, sand, and waves created the perfect environment for pure relaxation and joy.", mood: 'pleasant', summary: "Beach relaxation day" },
      { date: '2025-06-07', text: "Went to a local farmers market and tried samples from different vendors. The community atmosphere and fresh produce made it feel like a little celebration.", mood: 'pleasant', summary: "Farmers market exploration" },
      { date: '2025-06-05', text: "Had a spontaneous dance party in my kitchen while cooking dinner. Sometimes the best fun happens when you're just being silly by yourself.", mood: 'pleasant', summary: "Spontaneous kitchen dance" }
    ],
    challenges: [
      { date: '2025-06-23', text: "My car broke down on the way to an important meeting. Instead of panicking, I called an Uber and arrived only 10 minutes late. I'm getting better at handling unexpected situations.", mood: 'slight-unpleasant', summary: "Unexpected crisis management" },
      { date: '2025-06-21', text: "Received some harsh feedback on my project at work. It stung initially but I'm trying to see it as an opportunity to grow rather than a personal attack.", mood: 'unpleasant', summary: "Difficult feedback processing" },
      { date: '2025-06-19', text: "Had to have a difficult conversation with my landlord about the rent increase. I was nervous but advocated for myself and we reached a compromise.", mood: 'slight-unpleasant', summary: "Landlord negotiation success" },
      { date: '2025-06-17', text: "Dealing with my father's health scare has been emotionally draining. I'm trying to balance being supportive while also taking care of my own mental health.", mood: 'unpleasant', summary: "Family health crisis stress" },
      { date: '2025-06-15', text: "The job interview I was excited about didn't go well. I felt unprepared and stumbled over my answers. It's a reminder that I need to practice more.", mood: 'unpleasant', summary: "Job interview disappointment" },
      { date: '2025-06-13', text: "Struggling with decision fatigue from all the choices I need to make about my career, relationships, and future. Sometimes having options feels overwhelming.", mood: 'slight-unpleasant', summary: "Decision fatigue overwhelm" },
      { date: '2025-06-11', text: "Worried about upcoming expenses and whether I can afford the lifestyle I want. Financial stress is affecting my sleep and overall well-being.", mood: 'unpleasant', summary: "Financial stress impact" },
      { date: '2025-06-09', text: "Had a disagreement with my best friend about something important to both of us. We haven't talked in three days and I'm not sure how to bridge this gap.", mood: 'unpleasant', summary: "Friendship conflict strain" },
      { date: '2025-06-07', text: "Struggling with time management and feeling like I'm always behind. There aren't enough hours in the day to do everything I want to accomplish.", mood: 'slight-unpleasant', summary: "Time management struggles" },
      { date: '2025-06-05', text: "Feeling overwhelmed with work deadlines and personal commitments. Used the breathing techniques from therapy which helped me regain some perspective.", mood: 'slight-unpleasant', summary: "Overwhelm management practice" }
    ],
    spirituality: [
      { date: '2025-06-22', text: "Attended a meditation retreat and felt more connected to myself than I have in months. The silence and introspection helped me find clarity about my life direction.", mood: 'very-pleasant', summary: "Meditation retreat enlightenment" },
      { date: '2025-06-20', text: "Watched the sunrise from my balcony and felt overwhelmed by gratitude for this moment, this life, this opportunity to experience beauty. These moments feel sacred.", mood: 'very-pleasant', summary: "Sunrise gratitude moment" },
      { date: '2025-06-18', text: "Volunteered at the local food bank and felt deeply connected to my community. Serving others always reminds me of what's truly important in life.", mood: 'pleasant', summary: "Community service connection" },
      { date: '2025-06-16', text: "Spent time in nature today - went hiking at the nearby trail. The fresh air, trees, and silence felt like a conversation with something larger than myself.", mood: 'pleasant', summary: "Nature spiritual connection" },
      { date: '2025-06-14', text: "Morning meditation session brought such clarity and peace. These quiet moments with myself are becoming essential for my mental and spiritual well-being.", mood: 'pleasant', summary: "Daily meditation practice" },
      { date: '2025-06-12', text: "Read a chapter from 'The Power of Now' and reflected on how much I live in the past or future instead of the present moment. Mindfulness is a daily practice.", mood: 'pleasant', summary: "Mindfulness book reflection" },
      { date: '2025-06-10', text: "Reflected on how much I've grown this year spiritually. The challenges were hard but they've deepened my understanding of resilience and inner strength.", mood: 'pleasant', summary: "Spiritual growth reflection" },
      { date: '2025-06-08', text: "Practiced gratitude journaling and listed 10 things I'm thankful for. This simple exercise always shifts my perspective from scarcity to abundance.", mood: 'pleasant', summary: "Gratitude practice benefits" },
      { date: '2025-06-06', text: "Feeling disconnected from my spiritual practice lately. I've been so busy with work and life that I've neglected the practices that ground me.", mood: 'slight-unpleasant', summary: "Spiritual practice neglect" },
      { date: '2025-06-04', text: "Had a deep conversation with a friend about the meaning of life and our purpose here. These philosophical discussions always leave me feeling more connected to something greater.", mood: 'pleasant', summary: "Philosophical life discussion" }
    ],
    growth: [
      { date: '2025-06-23', text: "Reflected on how much I've changed over the past year. The person I am today is more confident, resilient, and self-aware than I was 12 months ago.", mood: 'pleasant', summary: "Personal transformation reflection" },
      { date: '2025-06-21', text: "Started reading 'Mindset' by Carol Dweck and it's changing how I think about challenges and failures. Embracing a growth mindset feels liberating.", mood: 'pleasant', summary: "Mindset shift discovery" },
      { date: '2025-06-19', text: "Attended a personal development workshop on emotional intelligence. Learning about my own patterns and triggers is uncomfortable but necessary.", mood: 'neutral', summary: "Self-awareness workshop" },
      { date: '2025-06-17', text: "Set three specific goals for the next quarter focused on areas where I want to grow. Having clear targets makes progress feel more achievable.", mood: 'pleasant', summary: "Goal setting session" },
      { date: '2025-06-15', text: "Practiced saying 'no' to a commitment that didn't align with my priorities. Setting boundaries is still hard but getting easier with practice.", mood: 'pleasant', summary: "Boundary setting practice" }
    ],
    travel: [
      { date: '2025-06-23', text: "Planning our summer vacation to Costa Rica has me so excited. Researching activities and reading about the culture is almost as fun as the trip itself will be.", mood: 'very-pleasant', summary: "Vacation planning excitement" },
      { date: '2025-06-21', text: "Booked a weekend getaway to the mountains for next month. Even short trips help break routine and give me new perspectives on life.", mood: 'pleasant', summary: "Weekend trip planning" },
      { date: '2025-06-19', text: "Looking through photos from last year's trip to Italy and feeling grateful for those memories. Travel really does broaden your worldview.", mood: 'pleasant', summary: "Travel memory appreciation" },
      { date: '2025-06-17', text: "Started saving money specifically for a big international trip next year. Having something exciting to save for makes budgeting feel purposeful.", mood: 'pleasant', summary: "Travel fund establishment" },
      { date: '2025-06-15', text: "Explored a new neighborhood in my own city today. Sometimes the best adventures are close to home when you approach them with curiosity.", mood: 'pleasant', summary: "Local exploration adventure" }
    ]
  };
  
  // Store data globally
  window.lifeChaptersData = lifeChaptersData;
  console.log('Story Threads data initialized:', Object.keys(lifeChaptersData).length, 'categories');
  
  // Setup event listeners with retry logic
  setTimeout(() => {
    let attempts = 0;
    const maxAttempts = 5;
    
    function trySetupListeners() {
      attempts++;
      const success = setupCategoryEventListeners();
      
      if (!success && attempts < maxAttempts) {
        console.log(`Retrying category setup (attempt ${attempts}/${maxAttempts})`);
        setTimeout(trySetupListeners, 200);
      } else if (success) {
        console.log('Category event listeners setup successfully!');
      } else {
        console.error('Failed to setup category event listeners after', maxAttempts, 'attempts');
      }
    }
    
    trySetupListeners();
  }, 100);

// Immediate setup as backup
(function() {
})();}

// Setup category item event listeners (called multiple times to ensure they work)
function setupCategoryEventListeners() {
  const categoryLinks = document.querySelectorAll('.category-cloud a');
  console.log('Setting up category event listeners for', categoryLinks.length, 'links');
  
  if (categoryLinks.length === 0) {
    console.warn('No category links found - will retry');
    return false;
  }
  
  categoryLinks.forEach(link => {
    // Remove existing listeners to prevent duplicates
    link.removeEventListener('click', handleCategoryClick);
    link.addEventListener('click', handleCategoryClick);
  });
  
  // Setup magnifier effect for word cloud
  setupMagnifierEffect(categoryLinks);
  
  // Setup close button
  const timelineCloseBtn = document.getElementById('timeline-close');
  if (timelineCloseBtn) {
    timelineCloseBtn.removeEventListener('click', handleTimelineClose);
    timelineCloseBtn.addEventListener('click', handleTimelineClose);
  }
  
  return true;
}

// Setup proximity-based magnifier effect for word cloud
function setupMagnifierEffect(categoryLinks) {
  // Skip on mobile devices
  if (window.innerWidth <= 768) return;
  
  categoryLinks.forEach(link => {
    link.addEventListener('mouseenter', (e) => {
      const hoveredElement = e.target;
      const hoveredRect = hoveredElement.getBoundingClientRect();
      const hoveredCenter = {
        x: hoveredRect.left + hoveredRect.width / 2,
        y: hoveredRect.top + hoveredRect.height / 2
      };
      
      categoryLinks.forEach(otherLink => {
        if (otherLink === hoveredElement) return;
        
        const otherRect = otherLink.getBoundingClientRect();
        const otherCenter = {
          x: otherRect.left + otherRect.width / 2,
          y: otherRect.top + otherRect.height / 2
        };
        
        // Calculate distance between centers
        const distance = Math.sqrt(
          Math.pow(hoveredCenter.x - otherCenter.x, 2) + 
          Math.pow(hoveredCenter.y - otherCenter.y, 2)
        );
        
        // Only affect elements within 120px radius
        if (distance <= 120) {
          otherLink.classList.add('nearby');
        }
      });
    });
    
    link.addEventListener('mouseleave', () => {
      // Remove nearby class from all elements
      categoryLinks.forEach(otherLink => {
        otherLink.classList.remove('nearby');
      });
    });
  });
}

// Category click handler
function handleCategoryClick(e) {
  e.preventDefault(); // Prevent default link behavior
  const category = this.dataset.category;
  console.log('Category clicked:', category);
  
  // Single selection - remove all other selections first
  document.querySelectorAll('.category-cloud a').forEach(link => {
    link.classList.remove('selected');
  });
  
  // Select this category
  this.classList.add('selected');
  
  // Show timeline for this single category
  const selectedCategory = {
    key: category,
    label: this.textContent
  };
  
  showSingleTimeline(selectedCategory);
}

// Timeline close handler
function handleTimelineClose() {
  hideTimeline();
  document.querySelectorAll('.category-cloud a').forEach(link => link.classList.remove('selected'));
}

// Show timeline for single selected category
function showSingleTimeline(selectedCategory) {
  const timelineContainer = document.getElementById('timeline-container');
  const timelineTitle = document.getElementById('timeline-title');
  const timelineContent = document.getElementById('timeline-content');
  
  // Set title
  timelineTitle.textContent = selectedCategory.label;
  
  // Get data for this category
  const categoryData = window.lifeChaptersData[selectedCategory.key] || [];
  
  // Sort by date (newest first)
  const sortedData = categoryData.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // Clear previous content
  timelineContent.innerHTML = '';
  
  if (sortedData.length === 0) {
    timelineContent.innerHTML = `
      <div class="timeline-empty">
        <span class="material-icons">auto_stories</span>
        <p>No entries found for this category yet.</p>
        <p class="timeline-empty-subtitle">Keep journaling to see your story threads unfold!</p>
      </div>
    `;
  } else {
    // Create timeline items
    sortedData.forEach((item, index) => {
      const timelineItem = document.createElement('div');
      timelineItem.className = 'timeline-item';
      
      const formattedDate = new Date(item.date).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
      
      const moodColor = getMoodTimelineColor(item.mood);
      const moodBackground = getMoodCardBackground(item.mood);
      
      // Escape HTML characters in the text for safe display
      const escapedText = item.text.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
      
      timelineItem.innerHTML = `
        <div class="timeline-card" style="background: ${moodBackground};">
          <div class="timeline-actions">
            <button class="timeline-action-btn edit-btn" onclick="editEntryDirect('${item.date}')" title="Edit entry">
              <span class="material-icons">edit</span>
            <button class="timeline-action-btn recategorize-btn" onclick="openRecategorizeModal('${item.date}', '${selectedCategory.key}', event)" title="Recategorize">
              <span class="material-icons">category</span>
        </div>
          <div class="timeline-date">
            ${formattedDate}
        </div>
          <div class="timeline-text">${escapedText}</div>
        </div>
      `;
      
      timelineContent.appendChild(timelineItem);
    });
  }
  
  // Show timeline
  timelineContainer.style.display = 'block';
  setTimeout(() => {
    timelineContainer.classList.add('show');
  }, 10);
}

// Show timeline for multiple selected categories (legacy function, kept for compatibility)
function showMultipleTimelines(selectedCategories) {
  const timelineContainer = document.getElementById('timeline-container');
  const timelineTitle = document.getElementById('timeline-title');
  const timelineContent = document.getElementById('timeline-content');
  
  // Set title
  if (selectedCategories.length === 1) {
    timelineTitle.textContent = selectedCategories[0].label;
  } else {
    timelineTitle.textContent = `${selectedCategories.length} Story Threads`;
  }
  
  // Combine data from all selected categories
  let combinedData = [];
  selectedCategories.forEach(category => {
    const categoryData = window.lifeChaptersData[category.key] || [];
    categoryData.forEach(item => {
      // Add category info to each item and avoid duplicates
      const existingItem = combinedData.find(existing => 
        existing.date === item.date && existing.text === item.text
      );
      if (!existingItem) {
        combinedData.push({
          ...item,
          categories: [category.label]
        });
      } else {
        // Add category to existing item
        if (!existingItem.categories.includes(category.label)) {
          existingItem.categories.push(category.label);
        }
      }
    });
  });
  
  // Sort by date (newest first)
  const sortedData = combinedData.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // Clear previous content
  timelineContent.innerHTML = '';
  
  if (sortedData.length === 0) {
    timelineContent.innerHTML = `
      <div class="timeline-empty">
        <span class="material-icons">auto_stories</span>
        <p>No entries found for selected categories yet.</p>
        <p class="timeline-empty-subtitle">Keep journaling to see your story threads unfold!</p>
      </div>
    `;
  } else {
    // Create timeline items
    sortedData.forEach((item, index) => {
      const timelineItem = document.createElement('div');
      timelineItem.className = 'timeline-item';
      
      const formattedDate = new Date(item.date).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
      
      const moodColor = getMoodTimelineColor(item.mood);
      
      const moodBackground = getMoodCardBackground(item.mood);
      
      // Escape HTML characters in the text for safe display
      const escapedText = item.text.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
      
      timelineItem.innerHTML = `
        <div class="timeline-card" style="background: ${moodBackground};">
          <div class="timeline-actions">
            <button class="timeline-action-btn edit-btn" onclick="editEntryDirect('${item.date}')" title="Edit entry">
              <span class="material-icons">edit</span>
            <button class="timeline-action-btn recategorize-btn" onclick="openRecategorizeModal('${item.date}', '${item.categories[0] || 'self'}', event)" title="Recategorize">
              <span class="material-icons">category</span>
        </div>
          <div class="timeline-date">
            ${formattedDate}
        </div>
          <div class="timeline-text">${escapedText}</div>
          ${item.categories.length > 1 ? `<div class="timeline-categories">${item.categories.join(' ‚Ä¢ ')}</div>` : ''}
        </div>
      `;
      
      timelineContent.appendChild(timelineItem);
    });
  }
  
  // Show timeline
  timelineContainer.style.display = 'block';
  setTimeout(() => {
    timelineContainer.classList.add('show');
  }, 10);
}

// Hide timeline
function hideTimeline() {
  const timelineContainer = document.getElementById('timeline-container');
  timelineContainer.classList.remove('show');
  setTimeout(() => {
    timelineContainer.style.display = 'none';
  }, 300);
}

// Get mood color for timeline markers
function getMoodTimelineColor(mood) {
  const moodColors = {
    'very-unpleasant': '#9333ea',
    'unpleasant': '#1e40af',
    'slight-unpleasant': '#3b82f6',
    'neutral': '#6b7280',
    'slight-pleasant': '#22c55e',
    'pleasant': '#f59e0b',
    'very-pleasant': '#ec4899'
  };
  
  return moodColors[mood] || '#6b7280';
}

// Get mood-based background for timeline cards
function getMoodCardBackground(mood) {
  const moodBackgrounds = {
    'very-unpleasant': 'linear-gradient(135deg, rgba(186, 148, 255, 0.06), rgba(255, 255, 255, 0.15))', // Pastel purple
    'unpleasant': 'linear-gradient(135deg, rgba(99, 139, 207, 0.06), rgba(255, 255, 255, 0.15))', // Pastel dark blue
    'slight-unpleasant': 'linear-gradient(135deg, rgba(147, 197, 253, 0.06), rgba(255, 255, 255, 0.15))', // Pastel light blue
    'neutral': 'rgba(255, 255, 255, 0.15)', // Pure white
    'slight-pleasant': 'linear-gradient(135deg, rgba(134, 239, 172, 0.06), rgba(255, 255, 255, 0.15))', // Pastel light green
    'pleasant': 'linear-gradient(135deg, rgba(252, 211, 175, 0.06), rgba(255, 255, 255, 0.15))', // Pastel yellow-pink
    'very-pleasant': 'linear-gradient(135deg, rgba(251, 182, 206, 0.06), rgba(255, 255, 255, 0.15))' // Pastel light pink
  };
  
  return moodBackgrounds[mood] || 'rgba(255, 255, 255, 0.12)';
}



// Direct edit entry function (bypasses modal)
function editEntryDirect(date) {
  console.log('Direct editing entry for date:', date);
  
  // Switch to Journalia tab first
  const journaliaMenuItem = document.querySelector('.menu-item[data-section="journalia"]');
  if (journaliaMenuItem) {
    // Remove active class from all menu items
    document.querySelectorAll('.menu-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // Add active class to journalia
    journaliaMenuItem.classList.add('active');
    
    // Hide all sections
    document.getElementById('dashboard-sections').classList.add('hidden');
    document.getElementById('sessions-sections').classList.add('hidden');
    document.getElementById('emotia-sections').classList.add('hidden');
    document.getElementById('journalia-sections').classList.remove('hidden');
    document.getElementById('momentum-sections').classList.add('hidden');
    
    // Initialize Journalia if not already done
    initializeJournalia();
    
    // Wait a bit for the section to be visible, then open the entry
    setTimeout(() => {
      openJournalEntry(date);
    }, 200);
  } else {
    // If we're already in Journalia, just open the entry
    openJournalEntry(date);
  }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const recategorizeModal = document.getElementById('recategorize-modal');
    if (recategorizeModal && recategorizeModal.classList.contains('show')) {
      closeRecategorizeModal();
    }
  }
});

// Recategorization Modal Functions
let recategorizeData = {
  date: null,
  originalCategory: null,
  selectedCategory: null
};

function openRecategorizeModal(entryDate, currentCategory, event) {
  console.log('Opening recategorize modal for:', entryDate, currentCategory);
  
  // Prevent event bubbling if event is provided
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }
  
  recategorizeData.date = entryDate;
  recategorizeData.originalCategory = currentCategory;
  recategorizeData.selectedCategory = null;
  
  // Get modal element
  let modal = document.getElementById('recategorize-modal');
  if (!modal) {
    console.error('Recategorize modal not found!');
    return;
  }
  
  // NUCLEAR OPTION: Move modal to body end and force all styles
  document.body.appendChild(modal);
  
  // Apply all styles with !important via cssText
  modal.style.cssText = `
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.6) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    z-index: 2147483647 !important;
    visibility: visible !important;
    opacity: 1 !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
  `;
  
  // Force browser repaint
  modal.offsetHeight;
  
  console.log('Modal NUCLEAR display:', {
    display: modal.style.display,
    visibility: modal.style.visibility,
    opacity: modal.style.opacity,
    zIndex: modal.style.zIndex,
    computedDisplay: window.getComputedStyle(modal).display,
    computedVisibility: window.getComputedStyle(modal).visibility
  });
  
  // Clear all selections
  const categoryOptions = document.querySelectorAll('.category-option');
  console.log('Found category options:', categoryOptions.length);
  
  categoryOptions.forEach(option => {
    option.classList.remove('selected');
  });
  
  // Add click handlers for category selection
  categoryOptions.forEach(option => {
    option.onclick = function() {
      console.log('Category selected:', this.dataset.category);
      
      // Remove selection from all options
      categoryOptions.forEach(opt => opt.classList.remove('selected'));
      
      // Select this option
      this.classList.add('selected');
      recategorizeData.selectedCategory = this.dataset.category;
      
      // Enable the move button
      const moveButton = document.querySelector('.recategorize-btn-primary');
      if (moveButton) {
        moveButton.disabled = false;
        console.log('Move button enabled');
      }
    };
  });
  
  // Disable the move button initially
  const moveButton = document.querySelector('.recategorize-btn-primary');
  if (moveButton) {
    moveButton.disabled = true;
    console.log('Move button disabled initially');
  }
  
  // Prevent background scroll
  document.body.style.overflow = 'hidden';
  
  console.log('Recategorize modal NUCLEAR setup complete');
  
  return true;
}

function closeRecategorizeModal() {
  const modal = document.getElementById('recategorize-modal');
  
  // Reset all inline styles completely
  modal.style.cssText = '';
  
  // Hide the modal
  modal.style.display = 'none';
  
  // Restore background scroll
  document.body.style.overflow = '';
  
  // Reset data
  recategorizeData = {
    date: null,
    originalCategory: null,
    selectedCategory: null
  };
}

function saveRecategorization() {
  if (!recategorizeData.date || !recategorizeData.selectedCategory) {
    return;
  }
  
  const oldCategory = recategorizeData.originalCategory;
  const newCategory = recategorizeData.selectedCategory;
  const entryDate = recategorizeData.date;
  
  // Don't move if it's the same category
  if (oldCategory === newCategory) {
    closeRecategorizeModal();
    return;
  }
  
  console.log(`Moving entry from ${oldCategory} to ${newCategory} for date ${entryDate}`);
  
  // Find and move the entry in lifeChaptersData
  if (window.lifeChaptersData && window.lifeChaptersData[oldCategory] && window.lifeChaptersData[newCategory]) {
    const entryIndex = window.lifeChaptersData[oldCategory].findIndex(entry => entry.date === entryDate);
    if (entryIndex !== -1) {
      const entry = window.lifeChaptersData[oldCategory].splice(entryIndex, 1)[0];
      window.lifeChaptersData[newCategory].push(entry);
      
      // Re-sort the new category by date (newest first)
      window.lifeChaptersData[newCategory].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      console.log(`Entry moved successfully from ${oldCategory} to ${newCategory}`);
      
      // Refresh the timeline if we're currently viewing the affected category
      const currentlySelectedCategory = document.querySelector('.category-item.selected');
      if (currentlySelectedCategory) {
        const currentCategoryKey = currentlySelectedCategory.dataset.category;
        if (currentCategoryKey === oldCategory || currentCategoryKey === newCategory) {
          // Find the category object for the timeline
          const categoryMap = {
            'self': { key: 'self', label: 'Self' },
            'social': { key: 'social', label: 'Social' },
            'friends': { key: 'friends', label: 'Friends' },
            'family': { key: 'family', label: 'Family' },
            'work': { key: 'work', label: 'Work' },
            'studies': { key: 'studies', label: 'Studies' },
            'creativity': { key: 'creativity', label: 'Creativity' },
            'challenges': { key: 'challenges', label: 'Challenges' },
            'health': { key: 'health', label: 'Health' },
            'finance': { key: 'finance', label: 'Finance' },
            'spirituality': { key: 'spirituality', label: 'Spirituality' },
            'joy-fun': { key: 'joy-fun', label: 'Joy & Fun' },
            'growth': { key: 'growth', label: 'Growth' },
            'travel': { key: 'travel', label: 'Travel' }
          };
          
          const categoryObj = categoryMap[currentCategoryKey];
          if (categoryObj) {
            showTimeline(categoryObj);
          }
        }
      }
    }
  }
  
  closeRecategorizeModal();
  
  // Show success message
  setTimeout(() => {
    // Create a modern toast notification instead of alert
    showToast('Entry moved successfully!', 'success');
  }, 100);

// Immediate setup as backup
(function() {
})();}

// Toast notification function
function showToast(message, type = 'success') {
  // Remove existing toast if any
  const existingToast = document.querySelector('.toast-notification');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div class="toast-content ${type}">
      <span class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</span>
      <span class="toast-message">${message}</span>
    </div>
  `;
  
  // Add to body
  document.body.appendChild(toast);
  
  // Show with animation
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);
  
  // Remove after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// Close recategorize modal when clicking outside
document.addEventListener('click', function(event) {
  const modal = document.getElementById('recategorize-modal');
  if (event.target === modal && modal.classList.contains('show')) {
    closeRecategorizeModal();
  }
});



// Journalia Logic
function initializeJournalia() {
  if (journaliaSections.children.length > 0) {
    // Already initialized, but make sure all data is connected properly
    console.log('Journalia already initialized, refreshing data connections...');
    
    setTimeout(() => {
      // Ensure Story Threads data is available
      if (!window.lifeChaptersData) {
        initializeLifeChapters();
      }
      
      // Refresh all sections with current data
      setTimeout(() => {
        calculateSummaryMetrics();
        displayDailyEntries();
        // Ensure category event listeners are working
        setupCategoryEventListeners();
        console.log('Journalia data refreshed!');
      }, 100);

// Immediate setup as backup
(function() {
})();    }, 50);
    
    return;
  }
  
  // Create the Journalia UI structure
  createJournaliaStructure();
  
  // Initialize journal data
  const journalEntries = {
    '2025-06-01': 'Dear Diary,\n\nToday was surprisingly refreshing. I started with a morning walk and felt more energetic throughout the day. My therapy exercises are helping me manage stress better.',
    '2025-06-05': 'Dear Diary,\n\nFeeling overwhelmed with work deadlines. I noticed my anxiety rising in the afternoon. Used the breathing techniques from therapy which helped calm me down.',
    '2025-06-08': 'Dear Diary,\n\nHad a meaningful conversation with my partner about our future. I felt heard and understood. These moments of connection make everything worthwhile.',
    '2025-06-12': 'Dear Diary,\n\nStruggled with negative thoughts today. Found myself dwelling on past mistakes. Need to practice the mindfulness exercises more consistently.',
    '2025-06-15': 'Dear Diary,\n\nSpent time in nature today - went hiking at the nearby trail. The fresh air and physical activity boosted my mood significantly. Want to make this a weekly habit.',

    '2025-06-20': 'Dear Diary,\n\nHad a disagreement with a colleague that left me feeling frustrated. Managed to use the communication skills I\'ve been working on instead of shutting down.'
  };
  
  // Set journal state
  window.journaliaState = {
    entries: journalEntries,
    selectedDate: new Date().toISOString().slice(0, 10),
    attachedPhotos: [],
    currentPhotos: []
  };
  
  // Set today's date in the date picker
  const today = new Date();
  const dateInput = document.getElementById('journal-date');
  dateInput.value = today.toISOString().slice(0, 10);
  
  // Load today's entry if exists
  const todayEntry = journaliaState.entries[journaliaState.selectedDate] || '';
  document.getElementById('journal-content').value = todayEntry;
  
  // Setup event listeners
  setupJournalEventListeners();
}

function setupJournalEventListeners() {
  // Date change handler
  const dateInput = document.getElementById('journal-date');
  dateInput.addEventListener('change', function() {
    journaliaState.selectedDate = this.value;
    loadJournalEntry(this.value);
  });
  
  // Mood selector handler
  const moodSelector = document.getElementById('mood-selector');
  moodSelector.addEventListener('change', function() {
    const selectedMood = this.value;
    const currentDate = document.getElementById('journal-date').value;
    
    if (selectedMood) {
      // Update journal color immediately
      updateJournalColorByMood(selectedMood);
      
      // Save mood for current date
      const moodKey = `journal-mood-${currentDate}`;
      localStorage.setItem(moodKey, selectedMood);
    } else {
      // If no mood selected, revert to original color system
      updateJournalColorForDate(currentDate);
    }
  });
  
  // Photo upload functionality
  const photoUploadArea = document.getElementById('photo-upload-area');
  const photoInput = document.getElementById('photo-input');
  const attachedPhotosContainer = document.getElementById('attached-photos');
  
  // Click to upload
  photoUploadArea.addEventListener('click', () => {
    photoInput.click();
  });
  
  // File input change
  photoInput.addEventListener('change', function(e) {
    handlePhotoUpload(e.target.files);
  });
  
  // Drag and drop functionality
  photoUploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
  });
  
  photoUploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
  });
  
  photoUploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    handlePhotoUpload(e.dataTransfer.files);
  });
  
  // Save journal entry
  document.getElementById('save-journal-entry').addEventListener('click', saveNewJournalEntry);
  
  // Placeholder text behavior for journal content
  const journalContent = document.getElementById('journal-content');
  const defaultText = "Dear Diary,\n\nWrite about your day, thoughts, feelings, and experiences...";
  
  journalContent.addEventListener('focus', function() {
    if (this.value === defaultText) {
      this.value = '';
      this.style.color = '#313638'; // Dark gray for user content
    }
  });
  
  journalContent.addEventListener('blur', function() {
    if (this.value.trim() === '') {
      this.value = defaultText;
      this.style.color = '#9ca3af'; // Light gray for placeholder
    }
  });
  
  // Also handle typing to ensure user text stays dark
  journalContent.addEventListener('input', function() {
    if (this.value !== defaultText && this.value.trim() !== '') {
      this.style.color = '#313638'; // Dark gray for user content
    }
  });
}

function handlePhotoUpload(files) {
  const attachedPhotosContainer = document.getElementById('attached-photos');
  const maxPhotos = 3;
  
  // Check current photo count
  const currentPhotoCount = journaliaState.currentPhotos.length;
  const availableSlots = maxPhotos - currentPhotoCount;
  
  if (availableSlots <= 0) {
    showSaveStatus(`Maximum of ${maxPhotos} photos allowed per entry.`, 'error');
    return;
  }
  
  // Only process files up to the available slots
  const filesToProcess = Array.from(files).slice(0, availableSlots);
  
  if (files.length > availableSlots) {
    showSaveStatus(`Only ${availableSlots} more photo(s) can be added. Maximum ${maxPhotos} photos per entry.`, 'error');
  }
  
  filesToProcess.forEach(file => {
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const photoId = Date.now() + Math.random();
        journaliaState.currentPhotos.push({
          id: photoId,
          data: e.target.result,
          name: file.name
        });
        
        // Create thumbnail
        const thumbnail = document.createElement('div');
        thumbnail.className = 'photo-thumbnail';
        thumbnail.innerHTML = `
          <img src="${e.target.result}" alt="${file.name}">
          <button class="photo-remove" data-photo-id="${photoId}">√ó</button>
        `;
        
        // Add event listener to remove button
        const removeBtn = thumbnail.querySelector('.photo-remove');
        removeBtn.addEventListener('click', () => removePhoto(photoId));
        
        attachedPhotosContainer.appendChild(thumbnail);
        
        // Update upload area text if at limit
        updatePhotoUploadArea();
      };
      reader.readAsDataURL(file);
    }
  });
}

// Update photo upload area based on current photo count
function updatePhotoUploadArea() {
  const photoUploadArea = document.getElementById('photo-upload-area');
  const maxPhotos = 3;
  const currentCount = journaliaState.currentPhotos.length;
  
  if (currentCount >= maxPhotos) {
    photoUploadArea.style.opacity = '0.5';
    photoUploadArea.style.pointerEvents = 'none';
    photoUploadArea.innerHTML = `
      <div class="flex flex-col items-center">
        <span class="material-icons text-gray-400 text-3xl mb-2">check_circle</span>
        <p class="text-sm text-gray-600 mb-1">Maximum photos reached (${maxPhotos})</p>
        <p class="text-xs text-gray-500">Remove a photo to add more</p>
      </div>
    `;
  } else {
    photoUploadArea.style.opacity = '1';
    photoUploadArea.style.pointerEvents = 'auto';
    photoUploadArea.innerHTML = `
      <div class="flex flex-col items-center">
        <span class="material-icons text-gray-400 text-3xl mb-2">cloud_upload</span>
        <p class="text-sm text-gray-600 mb-1">Click to upload photos</p>
        <p class="text-xs text-gray-500">or drag and drop (${currentCount}/${maxPhotos})</p>
      </div>
    `;
  }
}

function removePhoto(photoId) {
  journaliaState.currentPhotos = journaliaState.currentPhotos.filter(p => p.id !== photoId);
  
  // Remove from UI
  const thumbnails = document.querySelectorAll('.photo-thumbnail');
  thumbnails.forEach(thumb => {
    const img = thumb.querySelector('img');
    const photo = journaliaState.currentPhotos.find(p => p.data === img.src);
    if (!photo) {
      thumb.remove();
    }
  });
  
  // Update upload area after removal
  updatePhotoUploadArea();
}

function loadJournalEntry(date) {
  // Look for entry in both basic entries and Story Threads data
  let content = journaliaState.entries[date] || '';
  
  // If not found in basic entries, check Story Threads data
  if (!content && window.lifeChaptersData) {
    for (const categoryEntries of Object.values(window.lifeChaptersData)) {
      const entry = categoryEntries.find(e => e.date === date);
      if (entry) {
        content = entry.text;
        break;
      }
    }
  }
  
  const defaultText = "Dear Diary,\n\nWrite about your day, thoughts, feelings, and experiences...";
  const journalContent = document.getElementById('journal-content');
  
  if (content) {
    journalContent.value = content;
    journalContent.style.color = '#313638'; // Dark gray for actual content
  } else {
    journalContent.value = defaultText;
    journalContent.style.color = '#9ca3af'; // Light gray for placeholder
  }
  
  // Load saved mood for this date
  const moodKey = `journal-mood-${date}`;
  const savedMood = localStorage.getItem(moodKey);
  const moodSelector = document.getElementById('mood-selector');
  
  if (savedMood && moodSelector) {
    moodSelector.value = savedMood;
  } else if (moodSelector) {
    moodSelector.value = '';
  }
  
  // Update journal color for the selected date
  updateJournalColorForDate(date);
  
  // Clear current photos when loading different entry
  journaliaState.currentPhotos = [];
  document.getElementById('attached-photos').innerHTML = '';
  
  // Reset upload area
  updatePhotoUploadArea();
}

function saveNewJournalEntry() {
  const journalContent = document.getElementById('journal-content');
  const defaultText = "Dear Diary,\n\nWrite about your day, thoughts, feelings, and experiences...";
  const content = journalContent.value.trim();
  const date = document.getElementById('journal-date').value;
  const statusDiv = document.getElementById('journal-save-status');
  
  if (!content || content === defaultText) {
    showSaveStatus('Please write something before saving.', 'error');
    return;
  }
  
  // Save entry to basic journal entries
  journaliaState.entries[date] = content;
  
  // Also update Story Threads data if this entry exists there
  if (window.lifeChaptersData) {
    for (const categoryEntries of Object.values(window.lifeChaptersData)) {
      const entryIndex = categoryEntries.findIndex(e => e.date === date);
      if (entryIndex !== -1) {
        // Update the text in Story Threads as well
        categoryEntries[entryIndex].text = content;
        console.log('Updated Story Threads entry for date:', date);
        break;
      }
    }
  }
  
  // Save photos (in real app, this would upload to server)
  if (journaliaState.currentPhotos.length > 0) {
    journaliaState.attachedPhotos[date] = [...journaliaState.currentPhotos];
  }
  
  showSaveStatus('Journal entry saved successfully!', 'success');
  
  // Refresh My Entries display if it's currently visible
  if (document.getElementById('entries-carousel') && !document.getElementById('journalia-sections').classList.contains('hidden')) {
    setTimeout(() => {
      displayDailyEntries();
    }, 100);

// Immediate setup as backup
(function() {
})();  }
}

function showSaveStatus(message, type) {
  const statusDiv = document.getElementById('journal-save-status');
  statusDiv.textContent = message;
  statusDiv.className = `mt-3 p-3 rounded-lg text-sm text-center ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
  statusDiv.classList.remove('hidden');
  
  setTimeout(() => {
    statusDiv.classList.add('hidden');
  }, 3000);
}

function clearJournal() {
  if (confirm('Are you sure you want to clear the current entry? This action cannot be undone.')) {
    document.getElementById('journal-content').value = '';
    journaliaState.currentPhotos = [];
    document.getElementById('attached-photos').innerHTML = '';
    
    // Reset date to today
    const today = new Date().toISOString().slice(0, 10);
    document.getElementById('journal-date').value = today;
    journaliaState.selectedDate = today;
  }
}

function setupMyEntriesEventListeners() {
    // Direct date selection - the button IS the date input
    document.getElementById('filter-choose-day').addEventListener('change', function() {
      const selectedDate = this.value;
      if (selectedDate) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        this.parentElement.classList.add('active');
        displayDailyEntries(selectedDate);
      }
    });
    
    // Set initial value
    const dateInput = document.getElementById('filter-choose-day');
    dateInput.value = currentCenterDate || new Date().toISOString().slice(0, 10);
}

function openJournalEntry(date) {
  console.log('Opening journal entry for date:', date);
  
  // Set the date in the main journal editor
  document.getElementById('journal-date').value = date;
  journaliaState.selectedDate = date;
  
  // Load the entry content
  loadJournalEntry(date);
  
  // Scroll to the "Write about your day" section (first section in journalia)
  const writeSection = document.querySelector('#journalia-sections section:first-child');
  if (writeSection) {
    writeSection.scrollIntoView({ 
      behavior: 'smooth',
      block: 'start'
    });
  } else {
    // Fallback to journal content if section not found
    document.querySelector('#journal-content').scrollIntoView({ 
      behavior: 'smooth',
      block: 'center'
    });
  }
  
  // Focus on the editor after scrolling
  setTimeout(() => {
    const journalContent = document.getElementById('journal-content');
    if (journalContent) {
      journalContent.focus();
      // Place cursor at the end of existing content
      journalContent.setSelectionRange(journalContent.value.length, journalContent.value.length);
    }
  }, 800);
}

function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day;
  return new Date(d.setDate(diff));
}

function getWeekDates(startDate) {
  const dates = [];
  const start = new Date(startDate);
  
  for (let i = 0; i < 7; i++) {
    const date = new Date(start);
    date.setDate(start.getDate() + i);
    dates.push(date.toISOString().slice(0, 10));
  }
  
  return dates;
}

let currentActiveCard = 3; // Start with middle card active (today will be in center)
let currentCenterDate = new Date().toISOString().slice(0, 10); // Today's date

// Update the current viewing date display
function updateCurrentViewingDate(date) {
  const dateObj = new Date(date);
  const formattedDate = dateObj.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  const dateSpan = document.getElementById('current-viewing-date');
  if (dateSpan) {
    dateSpan.textContent = formattedDate;
  }
}

function generateCarouselDates(centerDate, totalCards = 7) {
  const dates = [];
  const center = new Date(centerDate);
  const halfCards = Math.floor(totalCards / 2);
  
  // Generate dates around the center date
  for (let i = -halfCards; i <= halfCards; i++) {
    const date = new Date(center);
    date.setDate(center.getDate() + i);
    dates.push(date.toISOString().slice(0, 10));
  }
  
  return dates;
}

function displayDailyEntries(jumpToDate = null) {
  const carousel = document.getElementById('entries-carousel');
  if (!carousel) {
    console.error('Carousel not found');
    return;
  }
  
  console.log('Displaying daily entries...');
  
  // Combine basic journal entries with Story Threads entries
  const basicEntries = journaliaState.entries;
  const allEntries = { ...basicEntries };
  
  console.log('Basic entries:', Object.keys(basicEntries).length);
  
  // Add Story Threads entries
  if (window.lifeChaptersData) {
    let lifeChaptersCount = 0;
    Object.values(window.lifeChaptersData).forEach(categoryEntries => {
      categoryEntries.forEach(entry => {
        if (!allEntries[entry.date]) {
          // Use only the personal entry text, not the summary
          allEntries[entry.date] = entry.text;
          lifeChaptersCount++;
        }
      });
    });
    console.log('Story Threads entries added:', lifeChaptersCount);
  } else {
    console.log('No Story Threads data available for My Entries');
  }
  
  console.log('Total entries for My Entries:', Object.keys(allEntries).length);
  
  const entries = allEntries;
  
  // If jumping to specific date, set it as center
  if (jumpToDate) {
    currentCenterDate = jumpToDate;
    currentActiveCard = 3; // Reset to center
  }
  
  // Update the date display
  updateCurrentViewingDate(currentCenterDate);
  
  // Generate 7 dates around the center date
  const visibleDates = generateCarouselDates(currentCenterDate, 7);
  
  // Clear existing content
  carousel.innerHTML = '';
  
  // Create cards for visible dates
  visibleDates.forEach((date, index) => {
    const dayDate = new Date(date);
    const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'long' });
    const formattedDate = dayDate.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric'
    });
    
    const entry = entries[date];
    const hasEntry = !!entry;
    
    let title = dayName;
    let content = '';
    let photos = '';
    
    if (hasEntry) {
      // For personal journal entries, just use the day name as title and show the full entry as content
      title = dayName;
      
      // Clean up the entry text - remove "Dear Diary" if present and show the personal content
      content = entry.replace(/^Dear Diary,?\s*/i, '').trim();
      
      // If it's a very long entry, truncate for display in the card
      if (content.length > 200) {
        content = content.substring(0, 200) + '...';
      }
      
      // Add photos if any exist for this date
      if (journaliaState.attachedPhotos && journaliaState.attachedPhotos[date]) {
        const photosArray = journaliaState.attachedPhotos[date];
        photos = `
          <div class="photos">
            ${photosArray.slice(0, 3).map((photo, index) => `<img src="${photo.data}" alt="${photo.name}" onclick="event.stopPropagation(); openPhotoPopup('${photo.data}')" style="cursor: pointer;">`).join('')}
        </div>
        `;
      }
    }
    
    const cardContainer = document.createElement('div');
    cardContainer.className = 'entry-card-container';
    cardContainer.dataset.date = date;
    
    // Apply 3D transform with explicit calculations for cross-browser consistency
    const offsetFromCenter = currentActiveCard - index;
    const absOffsetFromCenter = Math.abs(offsetFromCenter);
    const normalizedOffset = offsetFromCenter / 3;
    const absNormalizedOffset = absOffsetFromCenter / 3;
    const direction = offsetFromCenter === 0 ? 0 : (offsetFromCenter > 0 ? 1 : -1);
    
    // Ensure center card is fully visible and active
    const isActive = index === currentActiveCard;
    const rotateY = normalizedOffset * 50;
    const scaleY = 1 - (absNormalizedOffset * 0.4);
    const translateZ = -absNormalizedOffset * 30;
    const translateX = direction * -5;
    const blur = absNormalizedOffset * 1;
    const opacity = absOffsetFromCenter >= 3 ? 0 : 1;
    
    cardContainer.style.transform = `rotateY(${rotateY}deg) scaleY(${scaleY}) translateZ(${translateZ}rem) translateX(${translateX}rem)`;
    cardContainer.style.filter = `blur(${blur}rem)`;
    cardContainer.style.opacity = opacity;
    cardContainer.style.pointerEvents = isActive ? 'auto' : 'none';
    cardContainer.style.zIndex = isActive ? '10' : '1';
    
    // Add special styling for today
    const isToday = date === new Date().toISOString().slice(0, 10);
    const cardClass = isToday ? 'entry-card today' : 'entry-card';
    
    // Get the saved solid color for this date
    const dateColor = getSolidColorForDate(date);
    
    cardContainer.innerHTML = `
      <div class="${cardClass}" onclick="openJournalEntry('${date}')" style="background-color: ${dateColor};">
        <div class="date-badge">${isToday ? 'TODAY - ' : ''}${formattedDate}</div>
        <h3>${title}</h3>
        ${hasEntry ? 
          `<div class="content">${content}</div>${photos}` : 
          `<div class="no-entry">No Entry</div>`
        }
      </div>
    `;
    
    carousel.appendChild(cardContainer);
  });
  
  // Add navigation buttons - always show both for endless navigation
  const leftNav = document.createElement('button');
  leftNav.className = 'carousel-nav left';
  leftNav.innerHTML = '‚Äπ';
  leftNav.title = 'Previous day';
  leftNav.onclick = () => navigateCarousel(-1);
  carousel.appendChild(leftNav);
  
  const rightNav = document.createElement('button');
  rightNav.className = 'carousel-nav right';
  rightNav.innerHTML = '‚Ä∫';
  rightNav.title = 'Next day';
  rightNav.onclick = () => navigateCarousel(1);
  carousel.appendChild(rightNav);
  
  carousel.addEventListener("touchmove", (e) => {
    if (!isDragging) return;
    e.preventDefault();
  });
  
  carousel.addEventListener("touchend", (e) => {
    if (!isDragging) return;
    isDragging = false; carousel.style.transform = "scale(1)"; carousel.style.transition = "transform 0.2s ease-out";
    
    const endX = e.changedTouches[0].clientX;
    const diffX = startX - endX;
    
    if (Math.abs(diffX) > 50) {
      if (navigator.vibrate) navigator.vibrate(50); if (diffX > 0) {
        navigateCarousel(1);
      } else {
        navigateCarousel(-1);
      }
    }
  });}

function navigateCarousel(direction) {
  const carousel = document.getElementById('entries-carousel');
  const cards = carousel.querySelectorAll('.entry-card-container');
  
  // Get the current center date
  const centerDate = new Date(currentCenterDate);
  
  if (direction < 0) {
    // Moving left (back in time)
    centerDate.setDate(centerDate.getDate() - 1);
    currentCenterDate = centerDate.toISOString().slice(0, 10);
  } else {
    // Moving right (forward in time)
    centerDate.setDate(centerDate.getDate() + 1);
    currentCenterDate = centerDate.toISOString().slice(0, 10);
  }
  
  // Regenerate the carousel with new center date
  displayDailyEntries();
  
  // Update the date display
  updateCurrentViewingDate(currentCenterDate);
function setupCarouselSwipe() {
  const carousel = document.getElementById("entries-carousel");
  if (!carousel) return;
  
  let startX = 0;
  let isDragging = false; carousel.style.transform = "scale(1)"; carousel.style.transition = "transform 0.2s ease-out";
  
  carousel.addEventListener("touchstart", (e) => {
    startX = e.touches[0].clientX;
    isDragging = true; carousel.style.transform = "scale(0.98)"; carousel.style.transition = "transform 0.1s ease";
  });
  
  carousel.addEventListener("touchmove", (e) => {
    if (!isDragging) return;
    e.preventDefault();
  });
  
  carousel.addEventListener("touchend", (e) => {
    if (!isDragging) return;
    isDragging = false; carousel.style.transform = "scale(1)"; carousel.style.transition = "transform 0.2s ease-out";
    
    const endX = e.changedTouches[0].clientX;
    const diffX = startX - endX;
    
    if (Math.abs(diffX) > 50) {
      if (navigator.vibrate) navigator.vibrate(50); if (diffX > 0) {
        navigateCarousel(1);
      } else {
        navigateCarousel(-1);
      }
    }
  });
}
}

function createJournaliaStructure() {
  // Write About Your Day Section
  const writeJournalSection = document.createElement('section');
  writeJournalSection.className = 'bg-white p-8 shadow-lg border border-gray-200';
  writeJournalSection.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.98) 100%)';
  writeJournalSection.style.backdropFilter = 'blur(12px)';
  writeJournalSection.style.border = '1px solid rgba(226, 232, 240, 0.6)';
  writeJournalSection.style.borderRadius = '2rem';
  
  writeJournalSection.innerHTML = `
    <!-- Google font for handwriting -->
    <style>
      @import url('https://fonts.googleapis.com/css?family=Dancing+Script');
      
      /* Paper notebook styling */
      @import url('https://fonts.googleapis.com/css?family=Indie+Flower');
      
      .journal-letter {
        position: relative;
        height: 550px;
        width: 450px;
        max-width: 90vw;
        background: #fff;
        margin: 26px auto 0;
        padding: 24px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        z-index: 1;
      }
      
      .journal-letter:before, .journal-letter:after {
        content: "";
        height: 98%;
        position: absolute;
        width: 100%;
        z-index: -1;
        transition: background-color 0.3s ease;
      }
      
      .journal-letter:before {
        background: var(--journal-bg-color-1, #fafafa);
        box-shadow: 0 0 8px rgba(0,0,0,0.2);
        left: -5px;
        top: 4px;
        transform: rotate(-2.5deg);
      }
      
      .journal-letter:after {
        background: var(--journal-bg-color-2, #f6f6f6);
        box-shadow: 0 0 3px rgba(0,0,0,0.2);
        right: -3px;
        top: 1px;
        transform: rotate(1.4deg);
      }
      
      .lines {
        margin-top: 20px;
        height: calc(100% - 40px);
        width: 100%;
        background-image: repeating-linear-gradient(transparent 0px, transparent 24px, #ddd 25px);
        position: relative;
      }
      
      .lines::before {
        content: '';
        position: absolute;
        left: 20px;
        height: 100%;
        width: 2px;
        background: rgba(255,0,0,0.3);
        z-index: 1;
      }
      
      #journal-content {
        position: absolute;
        top: 25px;
        left: 35px;
        bottom: 10px;
        right: 10px;
        line-height: 25px;
        font-family: 'Indie Flower', cursive;
        font-size: 18px;
        overflow: visible;
        outline: none;
        background: transparent;
        border: none;
        resize: none;
        color: #313638;
        z-index: 2;
      }

      #journal-content::placeholder {
        color: #9ca3af;
        font-style: italic;
      }
      


      /* Mobile responsive adjustments */
      @media (max-width: 768px) {
        .journal-letter {
          width: 75vw; 
          max-width: 300px;
          height: 450px;
          margin: 20px auto 0;
          padding: 20px;
        }
        
        .lines::before {
          left: 15px;
        }
        
        #journal-content {
          font-size: 16px;
          left: 25px;
          top: 25px;
        }
        
        #journal-date {
          border-radius: 9999px !important;
          -webkit-border-radius: 9999px !important;
          -moz-border-radius: 9999px !important;
          -webkit-appearance: none !important;
          -moz-appearance: none !important;
          appearance: none !important;
        }
      }
      
      /* Extra specific mobile portrait mode */
      @media (max-width: 480px), (max-height: 896px) and (max-width: 768px) {
        #journal-date {
          border-radius: 50px !important;
          -webkit-border-radius: 50px !important;
          -moz-border-radius: 50px !important;
          -webkit-appearance: none !important;
          -moz-appearance: none !important;
          appearance: none !important;
          border: 1px solid #e5e7eb !important;
        }
      }

      .photo-upload-area {
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .photo-upload-area:hover {
        border-color: #ec4899;
        background-color: #fdf2f8;
      }

      .photo-upload-area.dragover {
        border-color: #ec4899;
        background-color: #fdf2f8;
      }

      .attached-photos {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 12px;
      }

      .photo-thumbnail {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: visible;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .photo-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .photo-remove {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 20px;
        height: 20px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        line-height: 1;
      }
      
      /* Typing Effect Styles */
      .typing-effect-container {
        overflow: hidden;
        width: 100%;
        max-width: 100%;
      }
      
      #typing-text {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      @media (max-width: 768px) {
        #typing-text {
          min-height: 7rem !important;
          max-height: 7rem !important;
          font-size: 1.25rem !important;
          padding: 0.75rem !important;
        }
        
        #typed-content {
          max-width: 100%;
          word-wrap: break-word;
          hyphens: auto;
        }
      }
      
      @media (max-width: 480px) {
        #typing-text {
          min-height: 8rem !important;
          max-height: 8rem !important;
          font-size: 1.125rem !important;
          padding: 0.5rem !important;
        }
      }
      
      #typing-cursor {
        color: #db2777;
        font-weight: 300;
        animation: blink 1s infinite;
      }
      
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }
      
      .typed-bold {
        font-weight: 600;
        color: #6b7280;
      }
      
      #typed-content {
        transition: all 0.3s ease;
      }
      
      /* Mood Selector Styles */
      .mood-selector-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      #mood-selector {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
      }
      
      #mood-selector:focus {
        outline: none;
        border-color: #fbb6ce;
        box-shadow: 0 0 0 1px #fbb6ce;
      }
      
      /* Photo Popup Styles */
      .photo-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .photo-popup-overlay.show {
        opacity: 1;
      }
      
      .photo-popup-content {
        max-width: 90vw;
        max-height: 90vh;
        position: relative;
        transform: scale(0.8);
        transition: transform 0.3s ease;
      }
      
      .photo-popup-overlay.show .photo-popup-content {
        transform: scale(1);
      }
      
      .photo-popup-image {
        max-width: 100%;
        max-height: 100%;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      }
      
      .photo-popup-close {
        position: absolute;
        top: -15px;
        right: -15px;
        width: 40px;
        height: 40px;
        background: #fff;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: bold;
        color: #333;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease;
      }
      
      .photo-popup-close:hover {
        transform: scale(1.1);
        background: #f8f9fa;
      }
      
      /* Journey Section - Sticky Notes Styles */
      @import url('https://fonts.googleapis.com/css?family=Roboto:300,400,500,600');
      
      .sticky-notes-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
        justify-items: center;
      }
      
      .note-container {
        justify-self: center;
      }
      
      .sticky-note {
        width: 200px;
        min-height: 200px;
        padding: 1rem;
        font-size: 14px;
        letter-spacing: 0.5px;
        outline: none;
        position: relative;
        margin-top: 40px;
        margin-bottom: 10px;
        padding-top: 40px;
        text-align: center;
        font-family: 'Roboto', sans-serif;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      
      .sticky-note::before {
        content: "";
        position: absolute;
        display: block;
      }
      
      .sticky-note::after {
        content: "";
        position: absolute;
        bottom: 0;
        border-width: 12px 12px 12px 12px;
        border-style: solid;
      }
      
      .sticky-note:hover {
        transform: translateY(-5px) rotate(1deg);
      }
      
      .sticky-note-one {
        background-color: #FAE3E3;
        box-shadow: 9px 0px 10px -5px rgba(0,0,0,0.42);
        transform: rotate(-2deg);
      }
      
      .sticky-note-one::before {
        background-color: rgba(173, 216, 230, 0.8);
        width: 80px;
        height: 25px;
        left: 50%;
        top: -12px;
        transform: translateX(-50%) rotate(3deg);
      }
      
      .sticky-note-one::after {
        left: 0;
        border-top-color: #B8D4E3;
        border-right-color: #B8D4E3;
        border-bottom-color: transparent;
        border-left-color: transparent;
      }
      
      .sticky-note-two {
        background-color: #B8E6FF;
        box-shadow: -9px 0px 10px -5px rgba(0,0,0,0.42);
        transform: rotate(1deg);
      }
      
      .sticky-note-two::before {
        background-color: rgba(250, 227, 227, 0.8);
        height: 50px;
        width: 35px;
        left: 50%;
        top: -25px;
        transform: rotate(-3deg) translateX(-50%);
      }
      
      .sticky-note-two::after {
        right: 0;
        border-top-color: #DDC6C3;
        border-left-color: #DDC6C3;
        border-bottom-color: transparent;
        border-right-color: transparent;
      }
      
      .sticky-note-three {
        background-color: #E8F5E8;
        box-shadow: 9px 0px 10px -5px rgba(0,0,0,0.42);
        transform: rotate(-1deg);
      }
      
      .sticky-note-three::before {
        background-color: rgba(255, 182, 193, 0.7);
        width: 70px;
        height: 30px;
        left: 50%;
        top: -15px;
        transform: translateX(-50%) rotate(2deg);
      }
      
      .sticky-note-three::after {
        left: 0;
        border-top-color: #D4E6D4;
        border-right-color: #D4E6D4;
        border-bottom-color: transparent;
        border-left-color: transparent;
      }
      
      .note-value {
        font-size: 1.8rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        font-family: 'Roboto', sans-serif;
      }
      
      .note-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #555;
        margin-bottom: 0.25rem;
        font-family: 'Roboto', sans-serif;
      }
      
      .note-sublabel {
        font-size: 0.75rem;
        color: #777;
        font-family: 'Roboto', sans-serif;
        font-weight: 400;
      }
      
      /* Quote Sticky Note Styles */
      .quote-box {
        width: 100%;
        max-width: 500px;
        min-height: 120px;
        padding: 1.5rem;
        font-size: 14px;
        letter-spacing: 0.5px;
        outline: none;
        position: relative;
        margin: 40px auto 10px auto;
        padding-top: 50px;
        text-align: center;
        font-family: 'Roboto', sans-serif;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: #FBFBFB;
        box-shadow: 9px 0px 10px -5px rgba(0,0,0,0.42);
        transform: rotate(0.5deg);
      }
      
      .quote-box::before {
        content: "";
        position: absolute;
        display: block;
        background-color: rgba(248, 187, 217, 0.7);
        width: 120px;
        height: 30px;
        left: 50%;
        top: -15px;
        transform: translateX(-50%) rotate(-1deg);
      }
      
      .quote-box::after {
        content: "";
        position: absolute;
        bottom: 0;
        border-width: 12px 12px 12px 12px;
        border-style: solid;
        right: 0;
        border-top-color: #E8E8E8;
        border-left-color: #E8E8E8;
        border-bottom-color: transparent;
        border-right-color: transparent;
      }
      
      .quote-box:hover {
        transform: translateY(-5px) rotate(1deg);
      }
      
      .circle {
        display: none;
      }
      
      .quote-text {
        font-size: 0.9rem;
        font-weight: 400;
        color: #333;
        line-height: 1.5;
        margin-bottom: 0.75rem;
        font-style: italic;
        font-family: 'Roboto', sans-serif;
      }
      
      .quote-author {
        font-size: 0.75rem;
        font-weight: 500;
        color: #555;
        font-family: 'Roboto', sans-serif;
      }
        
        /* Story Threads Styles */
        .category-instruction {
          text-align: center;
          font-size: 0.875rem;
          color: #6b7280;
          margin-bottom: 1.5rem;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          letter-spacing: -0.01em;
        }
        
        ul.category-cloud {
          list-style: none;
          padding-left: 0;
          display: flex;
          flex-wrap: wrap;
          align-items: center;
          justify-content: center;
          line-height: 3.25rem;
          width: 100%;
          max-width: 600px;
          margin: 0 auto 1.5rem auto;
        }
        
        ul.category-cloud a {
          display: block;
          padding: 0.125rem 0.25rem;
          position: relative;
          text-decoration: none;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          font-weight: 500;
          letter-spacing: -0.01em;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        ul.category-cloud a[data-category="self"] { 
          font-size: 2.8rem; 
          background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="social"] { 
          font-size: 3.1rem; 
          background: linear-gradient(135deg, #4ECDC4, #44A08D);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="friends"] { 
          font-size: 2.5rem; 
          background: linear-gradient(135deg, #FFD93D, #6BCF7F);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="family"] { 
          font-size: 2.4rem; 
          background: linear-gradient(135deg, #FBBF24, #F472B6);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="work"] { 
          font-size: 2.7rem; 
          background: linear-gradient(135deg, #667EEA, #764BA2);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="studies"] { 
          font-size: 2.3rem; 
          background: linear-gradient(135deg, #74B9FF, #0984E3);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="creativity"] { 
          font-size: 2.5rem; 
          background: linear-gradient(135deg, #A8E6CF, #88D8A3);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="challenges"] { 
          font-size: 3.3rem; 
          background: linear-gradient(135deg, #FD79A8, #E84393);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="health"] { 
          font-size: 2.4rem; 
          background: linear-gradient(135deg, #00B894, #00CEC9);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="finance"] { 
          font-size: 2.2rem; 
          background: linear-gradient(135deg, #FDCB6E, #E17055);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="spirituality"] { 
          font-size: 2.0rem; 
          background: linear-gradient(135deg, #A29BFE, #6C5CE7);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="joy-fun"] { 
          font-size: 2.6rem; 
          background: linear-gradient(135deg, #FFEAA7, #FDCB6E);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="growth"] { 
          font-size: 2.3rem; 
          background: linear-gradient(135deg, #55EFC4, #00B894);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        ul.category-cloud a[data-category="travel"] { 
          font-size: 2.4rem; 
          background: linear-gradient(135deg, #74B9FF, #0984E3);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        
        ul.category-cloud a:focus {
          outline: 1px dashed;
        }
        
        ul.category-cloud a::before {
          content: "";
          position: absolute;
          top: 0;
          left: 50%;
          width: 0;
          height: 100%;
          background: rgba(255, 255, 255, 0.1);
          transform: translate(-50%, 0);
          opacity: 0;
          transition: all 0.25s ease;
          border-radius: 0.25rem;
        }
        
        ul.category-cloud a:focus::before,
        ul.category-cloud a:hover::before {
          width: 100%;
          opacity: 1;
        }
        
        ul.category-cloud a:hover {
          transform: translateY(-1px) scale(1.15);
          filter: brightness(1.1) saturate(1.2);
          z-index: 10;
          position: relative;
        }
        
        /* Magnifier effect - proximity-based scaling */
        ul.category-cloud a.nearby {
          transform: scale(1.02);
          filter: brightness(0.95) saturate(0.9);
          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        ul.category-cloud a.selected {
          font-weight: 600;
          transform: translateY(-2px);
          filter: brightness(1.2) saturate(1.3) drop-shadow(0 2px 2px rgba(0, 0, 0, 0.3));
        }
        
        ul.category-cloud a.selected::before {
          width: 100%;
          background: rgba(236, 72, 153, 0.08);
          opacity: 1;
          backdrop-filter: none;
          -webkit-backdrop-filter: none;
        }
        
        @media (prefers-reduced-motion) {
          ul.category-cloud * {
            transition: none !important;
          }
        }
        
        /* Timeline Styles */
        .timeline-container {
          background: rgba(255, 255, 255, 0.08);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.15);
          border-radius: 1.5rem;
          padding: 2rem;
          margin-top: 2rem;
          opacity: 0;
          transform: translateY(20px);
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .timeline-container.show {
          opacity: 1;
          transform: translateY(0);
        }
        
        .timeline-header {
          display: flex;
          align-items: center;
          justify-content: between;
          margin-bottom: 2rem;
          padding-bottom: 1rem;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .timeline-title {
          font-size: 1.25rem;
          font-weight: 600;
          color: #1f2937;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          letter-spacing: -0.02em;
          flex: 1;
        }
        
        .timeline-close {
          background: rgba(255, 255, 255, 0.1);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 0.5rem;
          padding: 0.5rem;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .timeline-close:hover {
          background: rgba(255, 255, 255, 0.2);
          border-color: rgba(255, 255, 255, 0.3);
        }
        
        .timeline-close .material-icons {
          color: #6b7280;
          font-size: 1.125rem;
        }
        
        .timeline-content {
          position: relative;
        }
        
        .timeline-content::before {
          content: '';
          position: absolute;
          left: 0.5rem;
          top: 0;
          bottom: 0;
          width: 2px;
          background: linear-gradient(to bottom, 
            rgba(236, 72, 153, 0.3),
            rgba(236, 72, 153, 0.1),
            rgba(236, 72, 153, 0.3)
          );
          border-radius: 1px;
        }
        
        .timeline-item {
          margin-bottom: 2rem;
          position: relative;
          padding-left: 1.5rem;
        }
        
        .timeline-item:last-child {
          margin-bottom: 0;
        }
        

        
        .timeline-card {
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.15);
          border-radius: 1rem;
          padding: 1.25rem;
          flex: 1;
          box-shadow: 
            0 4px 16px rgba(0, 0, 0, 0.05),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }
        
        .timeline-card:hover {
          border-color: rgba(255, 255, 255, 0.25);
          transform: translateY(-1px);
          box-shadow: 
            0 6px 20px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .timeline-summary {
          font-size: 0.8rem;
          font-weight: 600;
          color: #4b5563;
          margin-bottom: 0.75rem;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          letter-spacing: -0.01em;
          opacity: 0.9;
        }
        
        .timeline-date {
          font-size: 0.75rem;
          font-weight: 600;
          color: #6b7280;
          margin-bottom: 0.5rem;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          letter-spacing: 0.02em;
          text-transform: uppercase;
        }
        
        .timeline-text {
          font-size: 0.9rem;
          color: #374151;
          line-height: 1.5;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          letter-spacing: -0.01em;
        }
        
        .timeline-categories {
          font-size: 0.7rem;
          color: #9ca3af;
          margin-top: 0.5rem;
          font-weight: 500;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          letter-spacing: 0.01em;
        }
        
        .timeline-empty {
          text-align: center;
          padding: 3rem 2rem;
          color: #6b7280;
        }
        
        .timeline-empty .material-icons {
          font-size: 3rem;
          color: #d1d5db;
          margin-bottom: 1rem;
        }
        
        .timeline-empty p {
          font-size: 1rem;
          font-weight: 500;
          margin-bottom: 0.5rem;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .timeline-empty-subtitle {
          font-size: 0.875rem !important;
          color: #9ca3af !important;
          font-weight: 400 !important;
        }
        
        .timeline-actions {
          position: absolute;
          top: 1rem;
          right: 1rem;
          display: flex;
          gap: 0.5rem;
          opacity: 0;
          transition: all 0.2s ease;
        }
        
        .timeline-card:hover .timeline-actions {
          opacity: 1;
        }
        
        .timeline-action-btn {
          width: 2rem;
          height: 2rem;
          border-radius: 50%;
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid rgba(0, 0, 0, 0.1);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.2s ease;
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
        }
        
        .timeline-action-btn:hover {
          background: rgba(255, 255, 255, 0.95);
          transform: scale(1.05);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .timeline-action-btn .material-icons {
          font-size: 1rem;
        }
        
        .edit-btn .material-icons {
          color: #3b82f6;
        }
        
        .edit-btn:hover {
          background: rgba(59, 130, 246, 0.1);
        }
        
        .recategorize-btn .material-icons {
          color: #ec4899;
        }
        
        .recategorize-btn:hover {
          background: rgba(236, 72, 153, 0.1);
        }
        

        
        /* Recategorize Modal Styles */
        .recategorize-modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 99999;
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
        }
        

        
        .recategorize-content {
          background: white;
          border-radius: 2rem;
          padding: 2rem;
          max-width: 600px;
          width: 95%;
          max-height: 85vh;
          overflow-y: auto;
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        
        .recategorize-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
          padding-bottom: 1rem;
          border-bottom: 2px solid #f3f4f6;
        }
        
        .recategorize-title {
          display: flex;
          align-items: center;
          gap: 0.75rem;
          font-size: 1.5rem;
          font-weight: 700;
          color: #1f2937;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .recategorize-icon {
          color: #ec4899;
          font-size: 1.75rem;
        }
        
        .recategorize-close {
          width: 2.5rem;
          height: 2.5rem;
          border-radius: 50%;
          background: #f3f4f6;
          border: none;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        
        .recategorize-close:hover {
          background: #e5e7eb;
          transform: scale(1.05);
        }
        
        .recategorize-description {
          color: #6b7280;
          font-size: 1rem;
          margin-bottom: 2rem;
          text-align: center;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .recategorize-categories {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 1rem;
          margin-bottom: 2rem;
          max-height: 400px;
          overflow-y: auto;
          padding-right: 0.5rem;
        }
        
        .category-option {
          display: flex;
          align-items: center;
          gap: 1rem;
          padding: 1rem;
          border: 2px solid #f3f4f6;
          border-radius: 1rem;
          cursor: pointer;
          transition: all 0.2s ease;
          background: rgba(255, 255, 255, 0.8);
        }
        
        .category-option:hover {
          border-color: #ec4899;
          background: rgba(236, 72, 153, 0.02);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .category-option.selected {
          border-color: #ec4899;
          background: rgba(236, 72, 153, 0.05);
          box-shadow: 0 4px 20px rgba(236, 72, 153, 0.15);
        }
        
        .category-color {
          width: 3rem;
          height: 3rem;
          border-radius: 0.75rem;
          flex-shrink: 0;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .category-info {
          flex: 1;
        }
        
        .category-name {
          font-size: 1rem;
          font-weight: 600;
          color: #1f2937;
          margin-bottom: 0.25rem;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          text-align: left;
        }
        
        .category-desc {
          font-size: 0.875rem;
          color: #6b7280;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          text-align: left;
        }
        
        .recategorize-actions {
          display: flex;
          gap: 1rem;
          justify-content: flex-end;
          padding-top: 1.5rem;
          border-top: 2px solid #f3f4f6;
        }
        
        .recategorize-btn-secondary {
          padding: 0.75rem 1.5rem;
          border-radius: 1rem;
          font-size: 0.875rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          background: #f3f4f6;
          color: #6b7280;
          border: 2px solid #e5e7eb;
        }
        
        .recategorize-btn-secondary:hover {
          background: #e5e7eb;
          border-color: #d1d5db;
        }
        
        .recategorize-btn-primary {
          padding: 0.75rem 1.5rem;
          border-radius: 1rem;
          font-size: 0.875rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          background: #ec4899;
          color: white;
          border: 2px solid #ec4899;
        }
        
        .recategorize-btn-primary:hover:not(:disabled) {
          background: #db2777;
          border-color: #db2777;
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }
        
        .recategorize-btn-primary:disabled {
          background: #d1d5db;
          color: #9ca3af;
          border-color: #d1d5db;
          cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
          .recategorize-content {
            padding: 1.25rem;
            max-height: 90vh;
          }
          
          .recategorize-title {
            font-size: 1.25rem;
            gap: 0.5rem;
          }
          
          .recategorize-icon {
            font-size: 1.5rem;
          }
          
          .recategorize-close {
            width: 2rem;
            height: 2rem;
          }
          
          .recategorize-description {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
          }
          
          .recategorize-categories {
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            max-height: 350px;
          }
          
          .category-option {
            padding: 0.75rem;
            gap: 0.75rem;
          }
          
          .category-color {
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
          }
          
          .category-name {
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
          }
          
          .category-desc {
            font-size: 0.75rem;
          }
          
          .recategorize-actions {
            flex-direction: column;
            gap: 0.75rem;
            padding-top: 1.25rem;
          }
          
          .recategorize-btn-secondary,
          .recategorize-btn-primary {
            width: 100%;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            font-size: 0.8125rem;
          }
        }
        
        /* Toast Notification Styles */
        .toast-notification {
          position: fixed;
          top: 2rem;
          right: 2rem;
          z-index: 10000;
          transform: translateX(100%);
          transition: all 0.3s ease;
        }
        
        .toast-notification.show {
          transform: translateX(0);
        }
        
        .toast-content {
          display: flex;
          align-items: center;
          gap: 0.75rem;
          padding: 1rem 1.5rem;
          border-radius: 1rem;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          font-weight: 500;
          min-width: 200px;
        }
        
        .toast-content.success {
          background: rgba(34, 197, 94, 0.9);
          color: white;
          border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .toast-content.error {
          background: rgba(239, 68, 68, 0.9);
          color: white;
          border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .toast-message {
          font-size: 0.875rem;
        }
        
        @media (max-width: 768px) {
          .toast-notification {
            top: 1rem;
            right: 1rem;
            left: 1rem;
            transform: translateY(-100%);
          }
          
          .toast-notification.show {
            transform: translateY(0);
          }
        }
        
        @media (max-width: 768px) {
          .category-grid {
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
          }
          
          .category-item {
            padding: 0.5rem;
          }
          
          .category-icon {
            padding: 0.375rem;
          }
          
          .category-icon .material-icons {
            font-size: 0.875rem;
          }
          
          .category-label {
            font-size: 0.625rem;
          }
          
          .timeline-container {
            padding: 1.5rem;
          }
          
          .timeline-content::before {
            left: 0.375rem;
          }
          
          .timeline-item {
            padding-left: 1.25rem;
          }
          
          /* Mobile Word Cloud Adjustments */
          ul.category-cloud {
            max-width: 350px;
            line-height: 2.5rem;
          }
          
          ul.category-cloud a[data-category="self"] { font-size: 1.8rem !important; }
          ul.category-cloud a[data-category="social"] { font-size: 2.0rem !important; }
          ul.category-cloud a[data-category="friends"] { font-size: 1.6rem !important; }
          ul.category-cloud a[data-category="family"] { font-size: 1.5rem !important; }
          ul.category-cloud a[data-category="work"] { font-size: 1.7rem !important; }
          ul.category-cloud a[data-category="studies"] { font-size: 1.4rem !important; }
          ul.category-cloud a[data-category="creativity"] { font-size: 1.6rem !important; }
          ul.category-cloud a[data-category="challenges"] { font-size: 2.1rem !important; }
          ul.category-cloud a[data-category="health"] { font-size: 1.5rem !important; }
          ul.category-cloud a[data-category="finance"] { font-size: 1.3rem !important; }
          ul.category-cloud a[data-category="spirituality"] { font-size: 1.2rem !important; }
          ul.category-cloud a[data-category="joy-fun"] { font-size: 1.7rem !important; }
          ul.category-cloud a[data-category="growth"] { font-size: 1.4rem !important; }
          ul.category-cloud a[data-category="travel"] { font-size: 1.5rem !important; }
          
          /* Disable magnifier effect on mobile */
          ul.category-cloud a:hover {
            transform: translateY(-1px) scale(1.05);
          }
          
          ul.category-cloud:hover a:not(:hover) {
            transform: none;
            filter: none;
          }
          
          /* Mobile Sticky Notes Adjustments */
          .sticky-notes-container {
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
          }
          
          .sticky-note {
            width: 150px;
            min-height: 130px;
            padding: 0.5rem;
            font-size: 10px;
            margin-top: 25px;
            padding-top: 25px;
          }
          
          .sticky-note::before {
            width: 60px !important;
            height: 20px !important;
            top: -10px !important;
          }
          
          .sticky-note::after {
            border-width: 8px 8px 8px 8px !important;
          }
          
          .note-value {
            font-size: 1.25rem;
          }
          
          .note-label {
            font-size: 0.625rem;
          }
          
          .note-sublabel {
            font-size: 0.5rem;
          }
          
          .quote-box {
            max-width: 280px;
            min-height: 90px;
            padding: 1rem;
            padding-top: 35px;
            margin: 30px auto 10px auto;
          }
          
          .quote-box::before {
            width: 80px !important;
            height: 20px !important;
            top: -10px !important;
          }
          
          .quote-box::after {
            border-width: 8px 8px 8px 8px !important;
          }
          
          .quote-text {
            font-size: 0.75rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
          }
          
          .quote-author {
            font-size: 0.625rem;
          }
        }
      </style>

    <div class="flex flex-col items-center mb-8" style="margin-top: 1rem;">
      <h2 class="text-xl font-bold text-gray-800 mb-6 text-center" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Write about your day</h2>
      
      <!-- Typing Effect Container -->
      <div class="typing-effect-container mb-20 text-center" style="margin-top: 0.5rem;">
        <p id="typing-text" class="text-2xl text-gray-600 flex items-center justify-center" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 300; letter-spacing: -0.01em; min-height: 6rem; max-height: 6rem; padding: 1rem; display: flex; align-items: center; justify-content: center; overflow: hidden;">
          <span id="typed-content" style="text-align: center; line-height: 1.4;"></span>
          <span id="typing-cursor" class="ml-1 animate-pulse">|</span>
        </p>
      </div>
      
      <input type="date" id="journal-date" class="px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:border-transparent transition-all shadow-sm" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; border-radius: 9999px !important;">
    </div>

    <div class="flex flex-col items-center">
      <!-- Letter Journal -->
      <div class="w-full max-w-4xl">
        <div class="journal-letter">
          <div class="lines">
            <textarea id="journal-content" class="placeholder-gray" style="color: #9ca3af;" placeholder="Dear Diary,

Write about your day, thoughts, feelings, and experiences...">Dear Diary,

Write about your day, thoughts, feelings, and experiences...</textarea>
        </div>
        </div>
      </div>

      <!-- Mood Selector -->
      <div class="mood-selector-container mt-6 mb-4">
        <label class="text-sm font-medium text-gray-700 mb-2 block text-center" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;">My mood is</label>
        <select id="mood-selector" class="px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-pink-300 focus:border-pink-300 transition-all shadow-sm" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; border-radius: 9999px !important; min-width: 200px;">
          <option value="">Select your mood...</option>
          <option value="very-unpleasant">Very Unpleasant</option>
          <option value="unpleasant">Unpleasant</option>
          <option value="slight-unpleasant">Slight Unpleasant</option>
          <option value="neutral">Neutral</option>
          <option value="slight-pleasant">Slight Pleasant</option>
          <option value="pleasant">Pleasant</option>
          <option value="very-pleasant">Very Pleasant</option>
        </select>
      </div>

      <!-- Photo Upload -->
      <div class="w-full max-w-4xl mt-8">
        <div class="bg-gray-50 rounded-3xl p-6">
          <h3 class="text-lg font-medium text-gray-800 mb-4 ">
            <span class="material-icons mr-2 text-black">photo_camera</span>
            Attach Photos
          </h3>
          
          <div class="photo-upload-area" id="photo-upload-area">
            <input type="file" id="photo-input" accept="image/*" multiple class="hidden">
            <div class="flex flex-col items-center">
              <span class="material-icons text-gray-400 text-3xl mb-2">cloud_upload</span>
              <p class="text-sm text-gray-600 mb-1">Click to upload photos</p>
              <p class="text-xs text-gray-500">or drag and drop</p>
              </button>
        </div>
        </div>
          
          <div id="attached-photos" class="attached-photos"></div>
        </div>
      </div>

      <!-- Save Button -->
      <div class="w-full max-w-4xl mt-6 flex justify-center">
        <button id="save-journal-entry" class="bg-white rounded-full px-8 py-3 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-all shadow-sm border border-gray-200 ">
          
          Save Entry
      </div>
      
      <div id="journal-save-status" class="hidden mt-3 p-3 rounded-lg text-sm text-center max-w-md"></div>
    </div>
  `;
  
  // Add section to journalia-sections container
  journaliaSections.appendChild(writeJournalSection);
  
  // Initialize typing effect and paper color
  initializeTypingEffect();
  initializePaperColor();
  
  // Create My Entries section
  createMyEntriesSection();
  
  // Create Summary section
  createSummarySection();
  
  // Create Story Threads section
      createStoryThreadsSection();
  
  // Create and add the Recategorize Modal (only for Moments tab)
  createRecategorizeModal();
  
  // Initialize Story Threads data AFTER all sections are created
  setTimeout(() => {
    console.log('Starting Story Threads initialization...');
    initializeLifeChapters();
    
    // After Story Threads data is loaded, initialize all dependent sections
    setTimeout(() => {
              console.log('Initializing Journey and My Entries with Story Threads data...');
      
              // Initialize Journey section with Story Threads data
      initializeSummaryData();
      
              // Initialize My Entries display with Story Threads data
      displayDailyEntries();
      
      console.log('All Moments sections initialized successfully!');
    }, 150);
  }, 100);

// Immediate setup as backup
(function() {
})();}

// Create Recategorize Modal (only for Moments tab)
function createRecategorizeModal() {
  // Create modal HTML
  const modalHTML = `
    <!-- Recategorize Entry Modal (Moments Tab Only) -->
    <div id="recategorize-modal" class="recategorize-modal">
      <div class="recategorize-content">
        <div class="recategorize-header">
          <div class="recategorize-title">
            <span class="material-icons recategorize-icon">category</span>
            Recategorize Entry
        </div>
          <button class="recategorize-close" onclick="closeRecategorizeModal()">
            <span class="material-icons">close</span>
        </div>
        
        <div class="recategorize-description">
          Move this entry to a different story thread category.
        </div>
        
        <div class="recategorize-categories">
          <div class="category-option" data-category="self">
            <div class="category-color" style="background: linear-gradient(135deg, #FF6B6B, #FF8E8E);"></div>
            <div class="category-info">
              <div class="category-name">Self</div>
              <div class="category-desc">Personal growth & reflection</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="social">
            <div class="category-color" style="background: linear-gradient(135deg, #4ECDC4, #44A08D);"></div>
            <div class="category-info">
              <div class="category-name">Social</div>
              <div class="category-desc">Social interactions & community</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="friends">
            <div class="category-color" style="background: linear-gradient(135deg, #FFD93D, #6BCF7F);"></div>
            <div class="category-info">
              <div class="category-name">Friends</div>
              <div class="category-desc">Friendships & peer connections</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="family">
            <div class="category-color" style="background: linear-gradient(135deg, #FBBF24, #F472B6);"></div>
            <div class="category-info">
              <div class="category-name">Family</div>
              <div class="category-desc">Family relationships & bonds</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="work">
            <div class="category-color" style="background: linear-gradient(135deg, #667EEA, #764BA2);"></div>
            <div class="category-info">
              <div class="category-name">Work</div>
              <div class="category-desc">Career & professional life</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="studies">
            <div class="category-color" style="background: linear-gradient(135deg, #74B9FF, #0984E3);"></div>
            <div class="category-info">
              <div class="category-name">Studies</div>
              <div class="category-desc">Learning & education</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="creativity">
            <div class="category-color" style="background: linear-gradient(135deg, #A8E6CF, #88D8A3);"></div>
            <div class="category-info">
              <div class="category-name">Creativity</div>
              <div class="category-desc">Creative projects & expression</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="challenges">
            <div class="category-color" style="background: linear-gradient(135deg, #FD79A8, #E84393);"></div>
            <div class="category-info">
              <div class="category-name">Challenges</div>
              <div class="category-desc">Obstacles & difficult times</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="health">
            <div class="category-color" style="background: linear-gradient(135deg, #00B894, #00CEC9);"></div>
            <div class="category-info">
              <div class="category-name">Health</div>
              <div class="category-desc">Physical & mental wellness</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="finance">
            <div class="category-color" style="background: linear-gradient(135deg, #FDCB6E, #E17055);"></div>
            <div class="category-info">
              <div class="category-name">Finance</div>
              <div class="category-desc">Money & financial planning</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="spirituality">
            <div class="category-color" style="background: linear-gradient(135deg, #A29BFE, #6C5CE7);"></div>
            <div class="category-info">
              <div class="category-name">Spirituality</div>
              <div class="category-desc">Faith & spiritual practices</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="joy-fun">
            <div class="category-color" style="background: linear-gradient(135deg, #FFEAA7, #FDCB6E);"></div>
            <div class="category-info">
              <div class="category-name">Joy & Fun</div>
              <div class="category-desc">Entertainment & leisure</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="growth">
            <div class="category-color" style="background: linear-gradient(135deg, #55EFC4, #00B894);"></div>
            <div class="category-info">
              <div class="category-name">Growth</div>
              <div class="category-desc">Personal development</div>
              </button>
        </div>
        </div>
          
          <div class="category-option" data-category="travel">
            <div class="category-color" style="background: linear-gradient(135deg, #74B9FF, #0984E3);"></div>
            <div class="category-info">
              <div class="category-name">Travel</div>
              <div class="category-desc">Adventures & exploration</div>
              </button>
        </div>
        </div>
        </div>
        
        <div class="recategorize-actions">
          <button class="recategorize-btn-secondary" onclick="closeRecategorizeModal()">Cancel</button>
          <button class="recategorize-btn-primary" onclick="saveRecategorization()" disabled>Move Entry</button>
        </div>
      </div>
    </div>
  `;
  
  // Add the modal to the journalia sections
  journaliaSections.insertAdjacentHTML('beforeend', modalHTML);
  
  console.log('Recategorize modal created for Moments tab');
}

// Typing Effect Function
function initializeTypingEffect() {
  const typingPrompts = [
    { text: "Create <strong>stories</strong> from your everyday.", boldWords: ["stories"] },
    { text: "Reflect on your day, <strong>emotions</strong>, <strong>experiences</strong>.", boldWords: ["emotions", "experiences"] },
    { text: "Record the <strong>thoughts</strong> that matter.", boldWords: ["thoughts"] },
    { text: "Make <strong>space</strong> for what you feel.", boldWords: ["space"] },
    { text: "Write it out. <strong>Breathe</strong> it in.", boldWords: ["Breathe"] },
    { text: "Track your <strong>journey</strong>, one entry at a time.", boldWords: ["journey"] },
    { text: "Your thoughts have a <strong>home</strong> here.", boldWords: ["home"] },
    { text: "Capture <strong>moments</strong> that shape you.", boldWords: ["moments"] },
    { text: "Let your <strong>feelings</strong> find their voice.", boldWords: ["feelings"] },
    { text: "Transform <strong>experiences</strong> into wisdom.", boldWords: ["experiences"] }
  ];
  
  let currentPromptIndex = 0;
  let currentCharIndex = 0;
  let isDeleting = false;
  let typingSpeed = 80;
  let deletingSpeed = 40;
  let pauseTime = 2000;
  
  const typedContent = document.getElementById('typed-content');
  const typingCursor = document.getElementById('typing-cursor');
  
  if (!typedContent || !typingCursor) return;
  
  function typeText() {
    const currentPrompt = typingPrompts[currentPromptIndex];
    const fullText = currentPrompt.text.replace(/<\/?strong>/g, ''); // Remove HTML tags for typing
    
    if (!isDeleting) {
      // Typing forward
      if (currentCharIndex < fullText.length) {
        let currentText = fullText.substring(0, currentCharIndex + 1);
        
        // Apply bold formatting
        currentPrompt.boldWords.forEach(word => {
          const regex = new RegExp(`\\b${word}\\b`, 'gi');
          currentText = currentText.replace(regex, `<strong class="typed-bold">${word}</strong>`);
        });
        
        typedContent.innerHTML = currentText;
        currentCharIndex++;
        setTimeout(typeText, typingSpeed);
      } else {
        // Finished typing, wait before deleting
        setTimeout(() => {
          isDeleting = true;
          typeText();
        }, pauseTime);
      }
    } else {
      // Deleting
      if (currentCharIndex > 0) {
        let currentText = fullText.substring(0, currentCharIndex - 1);
        
        // Apply bold formatting
        currentPrompt.boldWords.forEach(word => {
          const regex = new RegExp(`\\b${word}\\b`, 'gi');
          currentText = currentText.replace(regex, `<strong class="typed-bold">${word}</strong>`);
        });
        
        typedContent.innerHTML = currentText;
        currentCharIndex--;
        setTimeout(typeText, deletingSpeed);
      } else {
        // Finished deleting, move to next prompt
        isDeleting = false;
        currentPromptIndex = (currentPromptIndex + 1) % typingPrompts.length;
        setTimeout(typeText, 500);
      }
    }
  }
  
  // Start the typing effect after a short delay
  setTimeout(typeText, 1000);
}

// Paper Color System
function initializePaperColor() {
  // Pastel colors from the image + white
  const pastelColors = [
    '#ffffff', // White
    '#e8f5e8', // Pastel green
    '#f0e6ff', // Pastel purple/lavender
    '#fff9e6', // Pastel yellow/cream
    '#e6f3ff'  // Pastel blue
  ];
  
  const today = new Date().toISOString().split('T')[0];
  const colorKey = `journal-color-${today}`;
  
  // Check if we already have a color for today
  let todayColor = localStorage.getItem(colorKey);
  
  if (!todayColor) {
    // Randomly select a color for today
    todayColor = pastelColors[Math.floor(Math.random() * pastelColors.length)];
    localStorage.setItem(colorKey, todayColor);
  }
  
  // Apply the color to the journal
  document.documentElement.style.setProperty('--journal-color', todayColor);
  
  return todayColor;
}

// Get color for a specific date
function getColorForDate(date) {
  // First check if there's a mood-based color
  const moodKey = `journal-mood-${date}`;
  const savedMood = localStorage.getItem(moodKey);
  
  if (savedMood) {
    return getMoodColor(savedMood);
  }
  
  // Fallback to original random color system
  const colorKey = `journal-color-${date}`;
  return localStorage.getItem(colorKey) || '#ffffff';
}

// Get solid (non-transparent) color for entry cards in My Entries section
function getSolidColorForDate(date) {
  // First check if there's a mood-based color
  const moodKey = `journal-mood-${date}`;
  const savedMood = localStorage.getItem(moodKey);
  
  if (savedMood) {
    return getSolidMoodColor(savedMood);
  }
  
  // Fallback to original random color system with solid colors
  const colorKey = `journal-color-${date}`;
  const savedColor = localStorage.getItem(colorKey);
  
  if (savedColor && savedColor.startsWith('rgba(')) {
    // Convert transparent color to solid version
    return convertToSolidColor(savedColor);
  }
  
  return savedColor || '#ffffff';
}

// Get solid mood colors for entry cards - a bit more mood color but still very light
function getSolidMoodColor(mood) {
  const solidMoodColors = {
    'very-unpleasant': '#f9f7fb', // Light with subtle purple hint
    'unpleasant': '#f8f9fc',      // Light with subtle blue hint  
    'slight-unpleasant': '#f9fafd', // Light with subtle blue hint
    'neutral': '#f7f8f9',         // Light gray
    'slight-pleasant': '#f8fcf9', // Light with subtle green hint
    'pleasant': '#fcfaf7',        // Light with subtle yellow hint
    'very-pleasant': '#fcf8fa'    // Light with subtle pink hint
  };
  
  return solidMoodColors[mood] || '#ffffff';
}

// Convert RGBA to solid light color - super white
function convertToSolidColor(rgba) {
  if (rgba.startsWith('rgba(')) {
    const values = rgba.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
    if (values) {
      const r = parseInt(values[1]);
      const g = parseInt(values[2]);
      const b = parseInt(values[3]);
      
      // Create an almost white solid version with very subtle color hint
      const lightR = Math.round(r + (255 - r) * 0.97);
      const lightG = Math.round(g + (255 - g) * 0.97);
      const lightB = Math.round(b + (255 - b) * 0.97);
      
      return `rgb(${lightR}, ${lightG}, ${lightB})`;
    }
  }
  return rgba;
}

// Mood to color mapping for journal paper - mainly white with just a tone of mood color
function getMoodColor(mood) {
  const moodColors = {
    'very-unpleasant': 'rgba(147, 51, 234, 0.015)', // Purple with very subtle tone (mainly white)
    'unpleasant': 'rgba(30, 64, 175, 0.015)',       // Dark blue with very subtle tone (mainly white)  
    'slight-unpleasant': 'rgba(59, 130, 246, 0.015)', // Blue with very subtle tone (mainly white)
    'neutral': 'rgba(156, 163, 175, 0.012)',        // Gray with very subtle tone (mainly white)
    'slight-pleasant': 'rgba(34, 197, 94, 0.015)',  // Light green with very subtle tone (mainly white)
    'pleasant': 'rgba(245, 158, 11, 0.015)',        // Yellow with very subtle tone (mainly white)
    'very-pleasant': 'rgba(236, 72, 153, 0.015)'    // Pink with very subtle tone (mainly white)
  };
  
  return moodColors[mood] || 'rgba(255, 255, 255, 1)'; // Default to white
}

// Update journal color based on mood
function updateJournalColorByMood(mood) {
  const moodColor = getMoodColor(mood);
  // Create slightly different tones for the background layers
  const darkerTone = adjustRGBAOpacity(moodColor, -0.01);
  
  document.documentElement.style.setProperty('--journal-bg-color-1', moodColor);
  document.documentElement.style.setProperty('--journal-bg-color-2', darkerTone);
}

// Helper function to adjust RGBA opacity
function adjustRGBAOpacity(rgba, factor) {
  if (rgba.startsWith('rgba(')) {
    // Extract values from rgba string
    const values = rgba.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
    if (values) {
      const r = values[1];
      const g = values[2];
      const b = values[3];
      const a = parseFloat(values[4]);
      
      // Adjust opacity
      const newA = Math.max(0, Math.min(1, a + factor));
      return `rgba(${r}, ${g}, ${b}, ${newA})`;
    }
  }
  return rgba; // Return original if not rgba format
}

// Helper function to adjust color brightness (for hex colors)
function adjustColorBrightness(hex, factor) {
  if (hex.startsWith('#')) {
    // Convert hex to RGB
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    
    // Adjust brightness
    const newR = Math.max(0, Math.min(255, Math.round(r + (255 - r) * factor)));
    const newG = Math.max(0, Math.min(255, Math.round(g + (255 - g) * factor)));
    const newB = Math.max(0, Math.min(255, Math.round(b + (255 - b) * factor)));
    
    // Convert back to hex
    return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
  }
  return hex; // Return original if not hex format
}

// Update journal color for a specific date (keeping original random system as fallback)
function updateJournalColorForDate(date) {
  // Check if there's a saved mood for this date
  const moodKey = `journal-mood-${date}`;
  const savedMood = localStorage.getItem(moodKey);
  
  if (savedMood) {
    // Use mood-based color
    updateJournalColorByMood(savedMood);
    // Update the mood selector to show the saved mood
    const moodSelector = document.getElementById('mood-selector');
    if (moodSelector) {
      moodSelector.value = savedMood;
    }
  } else {
    // Fallback to original random color system with very light transparency
    const pastelColors = [
      'rgba(255, 255, 255, 1)',     // White
      'rgba(34, 197, 94, 0.03)',    // Very light green with transparency
      'rgba(147, 51, 234, 0.03)',   // Very light purple with transparency  
      'rgba(245, 158, 11, 0.03)',   // Very light yellow with transparency
      'rgba(59, 130, 246, 0.03)'    // Very light blue with transparency
    ];
    
    const colorKey = `journal-color-${date}`;
    let dateColor = localStorage.getItem(colorKey);
    
    if (!dateColor) {
      // Randomly select a color for this date
      dateColor = pastelColors[Math.floor(Math.random() * pastelColors.length)];
      localStorage.setItem(colorKey, dateColor);
    }
    
    // Apply the color to the journal background layers
    const darkerTone = dateColor.startsWith('rgba(') ? 
      adjustRGBAOpacity(dateColor, -0.01) : 
      adjustColorBrightness(dateColor, -0.02);
    document.documentElement.style.setProperty('--journal-bg-color-1', dateColor);
    document.documentElement.style.setProperty('--journal-bg-color-2', darkerTone);
  }
}

// Photo popup functions
function openPhotoPopup(imageSrc) {
  // Create popup overlay
  const overlay = document.createElement('div');
  overlay.className = 'photo-popup-overlay';
  overlay.innerHTML = `
    <div class="photo-popup-content">
      <img src="${imageSrc}" alt="Full size photo" class="photo-popup-image">
      <button class="photo-popup-close" onclick="closePhotoPopup()">&times;</button>
    </div>
  `;
  
  // Add to document
  document.body.appendChild(overlay);
  
  // Show with animation
  setTimeout(() => {
    overlay.classList.add('show');
  }, 10);
  
  // Close on overlay click
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      closePhotoPopup();
    }
  });
  
  // Close on escape key
  const handleEscape = (e) => {
    if (e.key === 'Escape') {
      closePhotoPopup();
      document.removeEventListener('keydown', handleEscape);
    }
  };
  document.addEventListener('keydown', handleEscape);
  
  // Prevent body scroll
  document.body.style.overflow = 'hidden';
}

function closePhotoPopup() {
  const overlay = document.querySelector('.photo-popup-overlay');
  if (overlay) {
    overlay.classList.remove('show');
    setTimeout(() => {
      overlay.remove();
      document.body.style.overflow = 'auto';
    }, 300);
  }
}

// Make functions globally accessible
window.removePhoto = removePhoto;
window.openJournalEntry = openJournalEntry;
window.openPhotoPopup = openPhotoPopup;
window.closePhotoPopup = closePhotoPopup;

function createMyEntriesSection() {
  const myEntriesSection = document.createElement('section');
  myEntriesSection.className = 'bg-white rounded-3xl p-8 shadow-lg border border-gray-200 mt-8';
  myEntriesSection.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.98) 100%)';
  myEntriesSection.style.backdropFilter = 'blur(12px)';
  myEntriesSection.style.border = '1px solid rgba(226, 232, 240, 0.6)';
  
    myEntriesSection.innerHTML = `
    <style>
      .entries-carousel-container {
        width: 100%;
        height: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        margin: 20px 0;
        overflow: visible;
        max-width: 100vw;
      }
      
      
      .mobile-swipe-instructions {
        display: none;
      }

      .entries-carousel {
        position: relative;
        width: 300px;
        height: 450px;
        perspective: 500px;
        transform-style: preserve-3d;
      }
      
      .entry-card-container {
        position: absolute;
        width: 100%;
        height: 100%;
        transition: all 0.3s ease-out;
      }
      
      .entry-card {
        width: 100%;
        height: 100%;
        padding: 25px 30px 20px 35px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        border: 1px solid rgba(139, 92, 246, 0.2);
        box-shadow: 0px 0px 6px 0px rgba(136, 136, 136, 0.6);
        color: #313638;
        text-align: left;
        transition: all 0.3s ease-out;
        overflow: visible;
        display: flex;
        flex-direction: column;
        position: relative;
        font-family: 'Indie Flower', cursive;
      }
      
      .entry-card::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        height: 100%;
        width: 2px;
        background: rgba(255, 0, 0, 0.4);
        z-index: 1;
      }
      
      .entry-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: repeating-linear-gradient(
          transparent 0px,
          transparent 23px,
          rgba(70, 130, 180, 0.3) 24px,
          rgba(70, 130, 180, 0.3) 25px
        );
        z-index: 1;
        pointer-events: none;
      }
      
      .entry-card.today {
        border: 2px solid rgba(219, 112, 147, 0.6);
      }
      
      .entry-card.today .date-badge {
        color: #374151 !important;
        font-weight: 600;
      }
      .entry-card h3 {
        text-align: center;
        font-size: 1.15rem;
        font-weight: bold;
        margin: 0 0 0.5em;
        color: #000000 !important;
        transition: all 0.3s ease-out;
        line-height: 1.2; position: relative; z-index: 2;
      }
      
      .entry-card .date-badge {
        text-align: center;
        font-size: 0.75rem;
        font-weight: 500;
        color: #374151 !important;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px; position: relative; z-index: 2;
      }
      
      .entry-card .content {
        flex: 1;
        font-size: 1rem;
        line-height: 1.5;
        color: #000000 !important;
        overflow: visible;
        text-align: left;
        transition: all 0.3s ease-out;
        padding: 0 5px 5px 5px;
        margin: 0;
        position: relative;
        z-index: 2;
        max-height: none;
        word-wrap: break-word;
      }
      
      .entry-card .no-entry {
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
        font-size: 1.15rem;
        color: #6B7280 !important;
        font-style: italic;
      }
      
      .entry-card .photos {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 120px;
        overflow: visible;
      }
      
      .entry-card .photos img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .carousel-nav {
        color: #DB7093;
        font-size: 2rem;
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        top: 50%;
        z-index: 2;
        cursor: pointer;
        user-select: none;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(219, 112, 147, 0.2);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        backdrop-filter: blur(10px);
        transition: all 0.2s ease;
      }
      
      .carousel-nav:hover {
        background: rgba(219, 112, 147, 0.1);
        transform: scale(1.1);
      }
      
      .carousel-nav.left {
        left: -80px;
        transform: translateY(-50%);
      }
      
      .carousel-nav.right {
        right: -80px;
        transform: translateY(-50%);
      }
      
      .filter-buttons {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .filter-btn {
         padding: 8px 16px;
         background: white;
         border: 1px solid #e5e7eb;
         border-radius: 9999px;
         font-size: 14px;
         font-weight: 500;
         color: #374151;
         cursor: pointer;
         transition: all 0.2s;
         box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
       }
       
       .filter-btn:hover {
         background: #f9fafb;
       }
      
      .filter-btn.active {
        background: #8b5cf6;
        color: white;
        border-color: #8b5cf6;
      }
      
      #week-picker-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      
      .week-picker-content {
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        max-width: 300px;
        width: 90%;
      }
      
      @media (max-width: 768px) {
        body {
          overflow-x: hidden;
          max-width: 100vw;
        }
        
        html {
          overflow-x: hidden;
          max-width: 100vw;
        }
        
        * {
          max-width: 100vw;
          box-sizing: border-box;
        }
        
        .entries-carousel {
          width: 280px;
          height: 380px;
        }
        
        .entry-card {
          padding: 15px 20px 15px 25px;
        }
        
        .entry-card .content {
          padding: 0 3px 3px 3px;
          font-size: 0.875rem;
        }
        
        .carousel-nav {
          font-size: 1.6rem;
          width: 40px;
          height: 40px;
        }
        
        .carousel-nav {
          display: none;
        }
        
        .entries-carousel-container {
          overflow: visible;
          max-width: 100vw;
          margin: 20px 0;
          touch-action: pan-x; overflow: hidden;
        }
        
        .entries-carousel {
          width: 280px;
          height: 380px;
        }
        .mobile-swipe-instructions {
          display: block;
          text-align: center;
          font-size: 0.8rem;
          color: #666;
          margin-top: 8px;
          padding: 8px 16px;
          background: rgba(139, 92, 246, 0.1);
          border-radius: 12px;
          border: 1px solid rgba(139, 92, 246, 0.2);
          max-width: 280px;
          margin-left: auto;
          margin-right: auto;
        }

        .mobile-swipe-instructions {
          display: block;
          text-align: center;
          font-size: 0.8rem;
          color: #666;
          margin-top: 8px;
          padding: 8px 16px;
          background: rgba(139, 92, 246, 0.1);
          border-radius: 12px;
          border: 1px solid rgba(139, 92, 246, 0.2);
          max-width: 280px;
          margin-left: auto;
          margin-right: auto;
        }
        
      }
    </style>
    
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold text-gray-800" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">My Entries</h2>
    </div>
    
    <div class="filter-buttons">
      <div class="filter-btn-container" style="position: relative; display: inline-block;">
        <input type="date" id="filter-choose-day" style="
          position: absolute;
          opacity: 0;
          width: 100%;
          height: 100%;
          cursor: pointer;
          z-index: 2;
        ">
        <div class="filter-btn" style="
          font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; 
          font-weight: 500;
          display: flex;
          align-items: center;
          padding: 8px 16px;
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid rgba(139, 92, 246, 0.2);
          border-radius: 8px;
          color: #374151;
          cursor: pointer;
          transition: all 0.2s ease;
        ">
          <span class="material-icons mr-2" style="font-size: 18px;">calendar_today</span>
          <span id="current-viewing-date"></span>
        </div>
      </div>
      <div class="mobile-swipe-instructions">‚Üê Swipe to navigate days ‚Üí</div>
    </div>
    
    <div class="entries-carousel-container">
      <div class="entries-carousel" id="entries-carousel">
        <!-- Carousel entries will be populated here -->
      </div>
    </div>
  `;
  
  // Add section to journalia-sections container
  journaliaSections.appendChild(myEntriesSection);
  
      // Setup event listeners but don't display entries yet - wait for Story Threads data
  setTimeout(() => {
    setupMyEntriesEventListeners(); 
    setupCarouselSwipe();
    // Initialize the date display
    updateCurrentViewingDate(currentCenterDate);
function setupCarouselSwipe() {
  const carousel = document.getElementById("entries-carousel");
  if (!carousel) return;
  
  let startX = 0;
  let isDragging = false; carousel.style.transform = "scale(1)"; carousel.style.transition = "transform 0.2s ease-out";
  
  carousel.addEventListener("touchstart", (e) => {
    startX = e.touches[0].clientX;
    isDragging = true; carousel.style.transform = "scale(0.98)"; carousel.style.transition = "transform 0.1s ease";
  });
  
  carousel.addEventListener("touchmove", (e) => {
    if (!isDragging) return;
    e.preventDefault();
  });
  
  carousel.addEventListener("touchend", (e) => {
    if (!isDragging) return;
    isDragging = false; carousel.style.transform = "scale(1)"; carousel.style.transition = "transform 0.2s ease-out";
    
    const endX = e.changedTouches[0].clientX;
    const diffX = startX - endX;
    
    if (Math.abs(diffX) > 50) {
      if (navigator.vibrate) navigator.vibrate(50); if (diffX > 0) {
        navigateCarousel(1);
      } else {
        navigateCarousel(-1);
      }
    }
  });
}
  }, 100);

// Immediate setup as backup
(function() {
})();}

function renderJournaliaCalendar() {
  const { year, month, selectedDate } = journaliaState;
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  const calendar = document.getElementById('journalia-calendar');
  calendar.innerHTML = '';
  
  // Header
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between mb-4 w-full';
  header.innerHTML = `
    <button id="journalia-prev-month" class="p-2 rounded-full hover:bg-gray-100"><span class="material-icons text-gray-600">chevron_left</span></button>
    <h3 class="text-lg font-semibold text-gray-800">${months[month]} ${year}</h3>
    <button id="journalia-next-month" class="p-2 rounded-full hover:bg-gray-100"><span class="material-icons text-gray-600">chevron_right</span></button>
  `;
  calendar.appendChild(header);
  
  // Days of week
  const daysRow = document.createElement('div');
  daysRow.className = 'grid grid-cols-7 gap-1 text-center text-xs font-medium text-gray-500 mb-2';
  daysRow.innerHTML = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<span>${d}</span>`).join('');
  calendar.appendChild(daysRow);
  
  // Calendar grid
  const grid = document.createElement('div');
  grid.className = 'grid grid-cols-7 gap-1 text-center';
  
  // Empty cells for days before the first of the month
  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'h-12 flex items-center justify-center';
    grid.appendChild(emptyCell);
  }
  
  // Day cells
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === new Date().toISOString().slice(0, 10);
    const isSelected = dateStr === selectedDate;
    const hasEntry = !!journaliaState.entries[dateStr];
    
    const dayCell = document.createElement('div');
    dayCell.className = 'h-12 flex items-center justify-center relative';
    
    const dayButton = document.createElement('button');
    dayButton.className = 'w-9 h-9 rounded-full flex items-center justify-center transition-all duration-200';
    dayButton.textContent = day;
    
    // Apply appropriate styling
    if (isToday) {
      dayButton.className += ' bg-purple-100 text-purple-800 font-semibold';
    }
    
    if (isSelected) {
      dayButton.className += ' bg-gradient-to-r from-purple-600 to-blue-500 text-white font-bold';
    }
    
    if (hasEntry && !isSelected) {
      dayButton.className += ' border-2 border-green-500 text-gray-800 font-medium';
    }
    
    // Select date on click
    dayButton.addEventListener('click', () => {
      journaliaState.selectedDate = dateStr;
      renderJournaliaCalendar();
      displaySelectedEntry();
    });
    
    dayCell.appendChild(dayButton);
    grid.appendChild(dayCell);
  }
  
  calendar.appendChild(grid);
  
  // Add event listeners for month navigation
  document.getElementById('journalia-prev-month').addEventListener('click', () => {
    journaliaState.month--;
    if (journaliaState.month < 0) {
      journaliaState.month = 11;
      journaliaState.year--;
    }
    renderJournaliaCalendar();
  });
  
  document.getElementById('journalia-next-month').addEventListener('click', () => {
    journaliaState.month++;
    if (journaliaState.month > 11) {
      journaliaState.month = 0;
      journaliaState.year++;
    }
    renderJournaliaCalendar();
  });
}

function setupQuickSelectionButtons() {
  // Set up mood buttons
  document.querySelectorAll('.quick-mood-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all mood buttons
      document.querySelectorAll('.quick-mood-btn').forEach(b => {
        b.classList.remove('bg-purple-700', 'text-white', 'shadow');
        b.classList.add('bg-purple-50', 'text-purple-700');
      });
      // Add active class to clicked button
      this.classList.remove('bg-purple-50', 'text-purple-700');
      this.classList.add('bg-purple-700', 'text-white', 'shadow');
      // Store selected value
      journaliaState.selectedQuickOptions.mood = this.dataset.value;
    });
  });
  
  // Set up energy buttons
  document.querySelectorAll('.quick-energy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all energy buttons
      document.querySelectorAll('.quick-energy-btn').forEach(b => {
        b.classList.remove('bg-blue-700', 'text-white', 'shadow');
        b.classList.add('bg-blue-50', 'text-blue-700');
      });
      // Add active class to clicked button
      this.classList.remove('bg-blue-50', 'text-blue-700');
      this.classList.add('bg-blue-700', 'text-white', 'shadow');
      // Store selected value
      journaliaState.selectedQuickOptions.energy = this.dataset.value;
    });
  });
  
  // Set up focus buttons
  document.querySelectorAll('.quick-focus-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all focus buttons
      document.querySelectorAll('.quick-focus-btn').forEach(b => {
        b.classList.remove('bg-green-700', 'text-white', 'shadow');
        b.classList.add('bg-green-50', 'text-green-700');
      });
      // Add active class to clicked button
      this.classList.remove('bg-green-50', 'text-green-700');
      this.classList.add('bg-green-700', 'text-white', 'shadow');
      // Store selected value
      journaliaState.selectedQuickOptions.focus = this.dataset.value;
    });
  });
  
  // Set up achievement buttons
  document.querySelectorAll('.quick-achievement-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all achievement buttons
      document.querySelectorAll('.quick-achievement-btn').forEach(b => {
        b.classList.remove('bg-amber-700', 'text-white', 'shadow', 'selected');
        b.classList.add('bg-amber-50', 'text-amber-700');
      });
      // Add active class to clicked button
      this.classList.remove('bg-amber-50', 'text-amber-700');
      this.classList.add('bg-amber-700', 'text-white', 'shadow', 'selected');
      // Store selected value
      journaliaState.selectedQuickOptions.achievement = this.dataset.value;
    });
  });
}

function saveJournalEntry() {
  let entryText = document.getElementById('journalia-today-entry').value.trim();
  const { mood, energy, focus, achievement } = journaliaState.selectedQuickOptions;
  
  // Create prefix with selected quick options if any
  let quickOptionsPrefix = '';
  let quickOptions = [];
  
  if (mood) quickOptions.push(`Mood: ${mood}`);
  if (energy) quickOptions.push(`Energy: ${energy}`);
  if (focus) quickOptions.push(`Focus: ${focus}`);
  if (achievement) quickOptions.push(`Achievement: ${achievement}`);
  
  if (quickOptions.length > 0) {
    quickOptionsPrefix = quickOptions.join(' | ') + '\n\n';
  }
  
  // Save entry with quick options if there's actual entry text
  if (entryText || quickOptions.length > 0) {
    const today = new Date().toISOString().slice(0, 10);
    journaliaState.entries[today] = quickOptionsPrefix + entryText;
    document.getElementById('journalia-entry-saved').classList.remove('hidden');
    
    // Hide success message after 3 seconds
    setTimeout(() => {
      document.getElementById('journalia-entry-saved').classList.add('hidden');
    }, 3000);
    
    // Update calendar to show the new entry
    renderJournaliaCalendar();
    
    // If today is the selected date, update the selected entry view
    if (journaliaState.selectedDate === today) {
      displaySelectedEntry();
    }
    
    // Reset the quick option buttons
    document.querySelectorAll('.quick-mood-btn').forEach(b => {
      b.classList.remove('bg-purple-700', 'text-white', 'shadow');
      b.classList.add('bg-purple-50', 'text-purple-700');
    });
    document.querySelectorAll('.quick-energy-btn').forEach(b => {
      b.classList.remove('bg-blue-700', 'text-white', 'shadow');
      b.classList.add('bg-blue-50', 'text-blue-700');
    });
    document.querySelectorAll('.quick-focus-btn').forEach(b => {
      b.classList.remove('bg-green-700', 'text-white', 'shadow');
      b.classList.add('bg-green-50', 'text-green-700');
    });
    document.querySelectorAll('.quick-achievement-btn').forEach(b => {
      b.classList.remove('bg-amber-700', 'text-white', 'shadow', 'selected');
      b.classList.add('bg-amber-50', 'text-amber-700');
    });
    
    // Reset the stored quick options
    journaliaState.selectedQuickOptions = {
      mood: '',
      energy: '',
      focus: '',
      achievement: ''
    };
  }
}

function displaySelectedEntry() {
  const { selectedDate } = journaliaState;
  const entryContent = journaliaState.entries[selectedDate];
  const dateObj = new Date(selectedDate);
  const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  
  // Update the date display
  document.getElementById('journalia-selected-date').textContent = formattedDate;
  
  // Show or hide edit/delete buttons based on whether there's an entry
  const hasEntry = !!entryContent;
  document.getElementById('journalia-edit-entry').style.display = hasEntry ? 'block' : 'none';
  document.getElementById('journalia-delete-entry').style.display = hasEntry ? 'block' : 'none';
  
  // Set the content
  const contentElement = document.getElementById('journalia-selected-entry-content');
  
  if (journaliaState.editMode) {
    contentElement.innerHTML = `<textarea id="journalia-edit-textarea" class="w-full h-full p-3 border border-purple-200 rounded-lg">${entryContent || ''}</textarea>`;
    document.getElementById('journalia-edit-controls').classList.remove('hidden');
  } else {
    if (hasEntry) {
      // Check if there are quick options in the content
      if (entryContent.includes(' | ') && entryContent.includes('\n\n')) {
        const parts = entryContent.split('\n\n');
        const quickOptions = parts[0];
        const mainContent = parts.slice(1).join('\n\n');
        
        // Format quick options as badges
        const badges = quickOptions.split(' | ').map(option => {
          const [category, value] = option.split(': ');
          let badgeColor = '';
          
          switch(category) {
            case 'Mood':
              badgeColor = 'bg-purple-100 text-purple-800 border-purple-200';
              break;
            case 'Energy':
              badgeColor = 'bg-blue-100 text-blue-800 border-blue-200';
              break;
            case 'Focus':
              badgeColor = 'bg-green-100 text-green-800 border-green-200';
              break;
            case 'Achievement':
              badgeColor = 'bg-amber-100 text-amber-800 border-amber-200';
              break;
            default:
              badgeColor = 'bg-gray-100 text-gray-800 border-gray-200';
          }
          
          return `<span class="inline-block px-2.5 py-1 rounded-full text-xs font-medium ${badgeColor} border mb-1 mr-1">${option}</span>`;
        }).join('');
        
        contentElement.innerHTML = `
          <div class="mb-4">${badges}</div>
          <p>${mainContent}</p>
        `;
      } else {
        contentElement.innerHTML = `<p>${entryContent}</p>`;
      }
    } else {
      contentElement.innerHTML = `<p class="text-gray-500">No entry for this date. Create one in the Daily Journal section above.</p>`;
    }
    document.getElementById('journalia-edit-controls').classList.add('hidden');
  }
}

function editSelectedEntry() {
  journaliaState.editMode = true;
  displaySelectedEntry();
}

function deleteSelectedEntry() {
  if (confirm('Are you sure you want to delete this journal entry?')) {
    delete journaliaState.entries[journaliaState.selectedDate];
    renderJournaliaCalendar();
    displaySelectedEntry();
  }
}

function saveEditedEntry() {
  const editedText = document.getElementById('journalia-edit-textarea').value.trim();
  if (editedText) {
    journaliaState.entries[journaliaState.selectedDate] = editedText;
  } else {
    delete journaliaState.entries[journaliaState.selectedDate];
  }
  
  journaliaState.editMode = false;
  renderJournaliaCalendar();
  displaySelectedEntry();
}

function cancelEditEntry() {
  journaliaState.editMode = false;
  displaySelectedEntry();
}
</script>

<!-- Momentum Logic -->
<script>
// Momentum Goals State
let momentumState = {
  goals: [
    { 
      id: 1, 
      title: 'Call or message a loved one', 
      category: 'heart', 
      deadline: '2025-07-30', 
      priority: 'medium',
      frequency: 'daily',
      weeklyTarget: null,
      monthlyTarget: null,
      dateCreated: '2025-05-25',
      time: '18:00',
      completions: [
        { date: '2025-05-25', completed: true },
        { date: '2025-05-26', completed: true },
        { date: '2025-05-27', completed: false },
        { date: '2025-05-28', completed: true },
        { date: '2025-05-29', completed: true },
        { date: '2025-05-30', completed: true },
        { date: '2025-05-31', completed: false },
        { date: '2025-06-01', completed: true },
        { date: '2025-06-02', completed: true },
        { date: '2025-06-03', completed: true },
        { date: '2025-06-04', completed: false },
        { date: '2025-06-05', completed: true },
        { date: '2025-06-06', completed: true },
        { date: '2025-06-07', completed: true }
      ]
    },
    { 
      id: 2, 
      title: 'Walk 7,000 steps', 
      category: 'fitness', 
      deadline: '2025-07-15', 
      priority: 'high',
      frequency: 'daily',
      weeklyTarget: null,
      monthlyTarget: null,
      dateCreated: '2025-05-20',
      time: 'Throughout day',
      completions: [
        { date: '2025-05-20', completed: true },
        { date: '2025-05-21', completed: true },
        { date: '2025-05-22', completed: false },
        { date: '2025-05-23', completed: true },
        { date: '2025-05-24', completed: true },
        { date: '2025-05-25', completed: false },
        { date: '2025-05-26', completed: true },
        { date: '2025-05-27', completed: true },
        { date: '2025-05-28', completed: true },
        { date: '2025-05-29', completed: false },
        { date: '2025-05-30', completed: true },
        { date: '2025-05-31', completed: true },
        { date: '2025-06-01', completed: true },
        { date: '2025-06-02', completed: false },
        { date: '2025-06-03', completed: true },
        { date: '2025-06-04', completed: false },
        { date: '2025-06-05', completed: true },
        { date: '2025-06-06', completed: true },
        { date: '2025-06-07', completed: true }
      ]
    },
    { 
      id: 3, 
      title: '5-minute meditation', 
      category: 'meditation', 
      deadline: '2025-08-01', 
      priority: 'high',
      frequency: 'daily',
      weeklyTarget: null,
      monthlyTarget: null,
      dateCreated: '2025-05-28',
      time: '07:30',
      completions: [
        { date: '2025-05-28', completed: true },
        { date: '2025-05-29', completed: true },
        { date: '2025-05-30', completed: true },
        { date: '2025-05-31', completed: false },
        { date: '2025-06-01', completed: true, notes: 'Felt more focused today' },
        { date: '2025-06-02', completed: true },
        { date: '2025-06-03', completed: true },
        { date: '2025-06-04', completed: true },
        { date: '2025-06-05', completed: true },
        { date: '2025-06-06', completed: false },
        { date: '2025-06-07', completed: true }
      ]
    },
    { 
      id: 4, 
      title: 'Plan daily tasks/priorities', 
      category: 'career', 
      deadline: '2025-12-31', 
      priority: 'high',
      frequency: 'weekly',
      weeklyTarget: 5,
      monthlyTarget: null,
      dateCreated: '2025-05-26',
      time: '09:00',
      completions: [
        { date: '2025-05-26', completed: true },
        { date: '2025-05-27', completed: true },
        { date: '2025-05-28', completed: true },
        { date: '2025-05-29', completed: true },
        { date: '2025-05-30', completed: true },
        { date: '2025-06-02', completed: true },
        { date: '2025-06-03', completed: true },
        { date: '2025-06-04', completed: true },
        { date: '2025-06-05', completed: true },
        { date: '2025-06-06', completed: false },
        { date: '2025-06-07', completed: true }
      ]
    },
    { 
      id: 5, 
      title: 'Review weekly finances', 
      category: 'finance', 
      deadline: '2025-08-15', 
      priority: 'medium',
      frequency: 'weekly',
      weeklyTarget: 2,
      monthlyTarget: null,
      dateCreated: '2025-05-20',
      time: '20:00',
      completions: [
        { date: '2025-05-21', completed: true },
        { date: '2025-05-23', completed: true },
        { date: '2025-05-28', completed: true },
        { date: '2025-05-30', completed: false },
        { date: '2025-06-03', completed: true },
        { date: '2025-06-05', completed: true },
        { date: '2025-06-07', completed: false }
      ]
    },
    { 
      id: 6, 
      title: 'Deep work session', 
      category: 'studies', 
      deadline: '2025-07-01', 
      priority: 'high',
      frequency: 'weekly',
      weeklyTarget: 3,
      monthlyTarget: null,
      dateCreated: '2025-05-30',
      time: '14:00',
      completions: [
        { date: '2025-05-30', completed: true },
        { date: '2025-06-01', completed: true },
        { date: '2025-06-03', completed: true },
        { date: '2025-06-05', completed: false },
        { date: '2025-06-06', completed: true },
        { date: '2025-06-07', completed: true }
      ]
    },
    { 
      id: 7, 
      title: 'Creative hobby time', 
      category: 'creativity', 
      deadline: '2025-09-30', 
      priority: 'low',
      frequency: 'weekly',
      weeklyTarget: 2,
      monthlyTarget: null,
      dateCreated: '2025-06-01',
      time: '19:00',
      completions: [
        { date: '2025-06-01', completed: true },
        { date: '2025-06-03', completed: false },
        { date: '2025-06-05', completed: true },
        { date: '2025-06-07', completed: true }
      ]
    },
    { 
      id: 8, 
      title: 'Drink 2L of water', 
      category: 'food', 
      deadline: '2025-09-30', 
      priority: 'medium',
      frequency: 'daily',
      weeklyTarget: null,
      monthlyTarget: null,
      dateCreated: '2025-06-03',
      time: 'Throughout day',
      completions: [
        { date: '2025-06-03', completed: true },
        { date: '2025-06-04', completed: true },
        { date: '2025-06-05', completed: false },
        { date: '2025-06-06', completed: true },
        { date: '2025-06-07', completed: true }
      ]
    },
    { 
      id: 9, 
      title: 'Monthly deep clean', 
      category: 'wellness', 
      deadline: '2025-12-31', 
      priority: 'low',
      frequency: 'monthly',
      weeklyTarget: null,
      monthlyTarget: 1,
      dateCreated: '2025-05-01',
      time: 'Weekend',
      completions: [
        { date: '2025-05-15', completed: true },
        { date: '2025-06-01', completed: false }
      ]
    }
  ],
  categories: [
    { id: 'heart', name: 'Love', color: '#EF4444', icon: 'favorite' },
    { id: 'finance', name: 'Finance', color: '#F59E0B', icon: 'account_balance_wallet' },
    { id: 'meditation', name: 'Meditation', color: '#6366F1', icon: 'self_improvement' },
    { id: 'fitness', name: 'Fitness', color: '#EF4444', icon: 'fitness_center' },
    { id: 'career', name: 'Career', color: '#3B82F6', icon: 'work' },
    { id: 'studies', name: 'Studies', color: '#2563EB', icon: 'school' },
    { id: 'creativity', name: 'Creativity', color: '#EC4899', icon: 'palette' },
    { id: 'food', name: 'Food', color: '#10B981', icon: 'restaurant' },
    { id: 'sleep', name: 'Sleep', color: '#6b7280', icon: 'bedtime' },
    { id: 'wellness', name: 'Wellness', color: '#10b981', icon: 'spa' },
    { id: 'exploration', name: 'Exploration', color: '#06b6d4', icon: 'explore' },
    { id: 'joy', name: 'Joy / Games', color: '#8B5CF6', icon: 'sports_esports' },
    { id: 'social', name: 'Social', color: '#EC4899', icon: 'group' },
    { id: 'relaxation', name: 'Relaxation', color: '#C0C9EE', icon: 'beach_access' },
    { id: 'pet', name: 'Pet Care', color: '#87CEEB', icon: 'pets' },
    { id: 'hygiene', name: 'Hygiene', color: '#C9E9D2', icon: 'clean_hands' }
  ],
  priorities: [
    { id: 'low', name: 'Low', color: 'blue' },
    { id: 'medium', name: 'Medium', color: 'amber' },
    { id: 'high', name: 'High', color: 'red' }
  ],
  frequencies: [
    { id: 'daily', name: 'Daily', description: 'Every day' },
    { id: 'weekly', name: 'Weekly', description: 'Several times per week' },
    { id: 'monthly', name: 'Monthly', description: 'Several times per month' },
    { id: 'custom', name: 'Custom', description: 'Specific dates' }
  ]
};

// Initialize Momentum Tab
function initializeMomentum() {
  // Check if already initialized
  const existingInitialized = momentumSections.querySelector('.momentum-initialized');
  const existingBeehive = momentumSections.querySelector('.beehive-container');
  
  if (existingInitialized && existingBeehive) {
    // If already initialized, ensure beehive is properly visible and re-initialize it
    setTimeout(() => {
      const circlesArr = document.getElementsByClassName("circle");
      if (circlesArr.length > 0) {
        // Make sure circles are visible
        for (let i = 0; i < circlesArr.length; i++) {
          circlesArr[i].style.display = 'block';
          circlesArr[i].style.visibility = 'visible';
          circlesArr[i].style.opacity = '1';
        }
              } else {
          // If circles don't exist, clear and re-initialize the beehive
          const circles = document.getElementsByClassName("circles")[0];
          if (circles) {
            circles.innerHTML = '';
          }
          initializeBeehive();
        }
    }, 50);
    return;
  }
  
  // Mark as initialized
  const initialized = document.createElement('div');
  initialized.className = 'momentum-initialized hidden';
  momentumSections.appendChild(initialized);
  
  // Momentum Hero Section with Activity Rings
  const heroSection = document.createElement('section');
  heroSection.id = 'habits-hero-section';
  heroSection.className = 'bg-white rounded-[35px] p-10 shadow-xl relative flex flex-col items-center justify-center min-h-[400px] w-full habits-section-border';
  heroSection.style.borderRadius = '35px';
  
  heroSection.innerHTML = `
    <div class="flex flex-col items-center mb-8" style="margin-top: 1rem;">
      <h2 class="text-xl font-bold text-gray-800 mb-6 text-center" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Introduce a new habit by selecting a category</h2>
      
      <!-- Category indicator for desktop horizontal (between title and grid) -->
      <div class="category-indicator desktop-horizontal-category-indicator">
        <span id="current-category-name-desktop-horizontal" class="category-name-gradient">Fitness</span>
      </div>
      
      <!-- Category indicator moved here for mobile -->
      <div class="category-indicator mobile-category-indicator">
        <span id="current-category-name" class="category-name">Fitness</span>
      </div>
    </div>
    
    <div class="beehive-container">
      <div class="beehive-wrapper">
        <div class="circles-wrapper">
          <div class="circles"></div>
          <div class="over-circles"></div>
        </div>
      </div>
      <!-- Category indicator for desktop (hidden on mobile) -->
      <div class="category-indicator desktop-category-indicator">
        <span id="current-category-name-desktop" class="category-name">Fitness</span>
      </div>
    </div>
  `;
  
  momentumSections.appendChild(heroSection);
  
  // Initialize Beehive Grid with a small delay to ensure DOM is ready
  setTimeout(() => {
    initializeBeehive();
    // Additional safety check to ensure circles are visible
    setTimeout(() => {
      const circlesArr = document.getElementsByClassName("circle");
      if (circlesArr.length === 0) {
        console.log('Circles still not found, retrying initialization...');
        initializeBeehive();
      }
    }, 200);
  }, 10);
  



  

  
  // Goals Summary Section with enhanced design
  const goalsSummary = document.createElement('section');
  goalsSummary.className = 'bg-white rounded-[35px] p-8 shadow-xl w-full relative overflow-hidden';
  goalsSummary.style.borderRadius = '35px';
  
  goalsSummary.innerHTML = `
    <!-- Glassmorphism background effects -->
    <div class="absolute inset-0 backdrop-blur-sm bg-white/10"></div>
    <div class="absolute top-1/4 -right-20 w-60 h-60 bg-white/10 rounded-full blur-3xl animate-pulse"></div>
    <div class="absolute bottom-1/4 -left-20 w-40 h-40 bg-white/15 rounded-full blur-2xl animate-pulse" style="animation-delay: 1s;"></div>
    
    <div class="relative z-10">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <div>
          <h2 class="text-2xl font-light text-gray-800 mb-2" style="font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: -0.5px;">Progress</h2>
                      <p class="text-gray-600 text-sm">Click habit to update progress</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="relative group">
            <select id="momentum-filter" class="appearance-none rounded-xl bg-gray-50 text-gray-800 font-medium text-sm px-5 py-3 pr-10 border border-gray-200 shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all cursor-pointer">
              <option value="all">All Categories</option>
              ${momentumState.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
            </select>
            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
              <span class="material-icons text-gray-500 text-sm">expand_more</span>
              </button>
        </div>
        </div>
        </div>
      </div>
      
      <div id="goals-progress-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        ${renderGoalCards()}
      </div>
      
      <div id="show-all-container" class="text-center mt-6" style="display: none;">
        <button id="show-all-goals-btn" class="px-4 py-2 bg-white/20 backdrop-blur-md border border-white/30 text-gray-700 rounded-xl font-medium hover:bg-white/30 hover:scale-[1.02] hover:shadow-lg transition-all duration-300 flex items-center gap-2 mx-auto">
          <span class="material-icons text-sm">visibility</span>
          <span>Show all</span>
      </div>
    </div>
  `;
  
  momentumSections.appendChild(goalsSummary);
  
  // Calculate average completion rate across all goals
  const calculateAvgCompletionRate = () => {
    if (momentumState.goals.length === 0) return 0;
    const totalProgress = momentumState.goals.reduce((sum, goal) => sum + goal.progress, 0);
    return Math.round(totalProgress / momentumState.goals.length);
  };
  
  // Calculate category completion rate
  const calculateCategoryCompletionRate = (categoryId) => {
    const categoryGoals = momentumState.goals.filter(g => g.category === categoryId);
    if (categoryGoals.length === 0) return 0;
    const totalProgress = categoryGoals.reduce((sum, goal) => sum + goal.progress, 0);
    return Math.round(totalProgress / categoryGoals.length);
  };

  
  // Create Goal Calendar Section
  const goalCalendarSection = document.createElement('div');
  goalCalendarSection.className = 'bg-white rounded-[35px] p-8 shadow-xl w-full';
  goalCalendarSection.style.borderRadius = '35px';
  goalCalendarSection.innerHTML = `
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h2 class="text-2xl font-light text-gray-800 mb-1" style="font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: -0.5px;">Habits Calendar</h2>
        <p class="text-sm text-gray-500 hidden md:block">Click on specific day to review scheduled habits</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <div class="flex bg-gray-50 rounded-full p-0.5 shadow-sm">
          <button id="view-month" class="calendar-view-btn active px-4 py-1.5 rounded-full text-xs font-medium transition-all hover:scale-105" data-view="month">Month</button>
          <button id="view-week" class="calendar-view-btn px-4 py-1.5 rounded-full text-xs font-medium transition-all hover:scale-105" data-view="week">Week</button>
          <button id="view-day" class="calendar-view-btn px-4 py-1.5 rounded-full text-xs font-medium transition-all hover:scale-105" data-view="day">Day</button>
        </div>
        
        <!-- Mobile Orientation Message (Hidden on Desktop) -->
        <div class="orientation-message hidden">
          <div class="flex items-center justify-center gap-2 mb-2">
            <span class="material-icons text-blue-600 text-lg">screen_rotation</span>
            <span class="font-medium">Rotate your phone</span>
        </div>
          <p class="text-xs">Turn your device to landscape mode to access Month and Week views with better visibility</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="sync-apple" class="flex items-center gap-2 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-full px-3 py-1.5 text-xs font-medium transition-all">
            <img src="https://img.icons8.com/?size=100&id=30840&format=png&color=000000" class="w-4 h-4 object-contain" alt="Apple">
            <span>Apple</span>
          <button id="sync-google" class="flex items-center gap-2 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-full px-3 py-1.5 text-xs font-medium transition-all">
            <img src="https://img.icons8.com/?size=100&id=YpTJTJYKapL1&format=png&color=000000" class="w-4 h-4 object-contain" alt="Google">
            <span>Google</span>
        </div>
      </div>
    </div>
    
    <!-- Calendar Navigation -->
    <div class="flex justify-between items-center mb-6 bg-gray-50 rounded-xl p-2.5 shadow-sm">
      <div class="flex items-center gap-3">
        <button id="prev-period" class="w-9 h-9 flex items-center justify-center bg-white rounded-full shadow-sm hover:shadow-md transition-all hover:scale-110 border border-gray-300">
          <span class="material-icons text-gray-600 text-sm">chevron_left</span>
        </button>
        <h3 id="calendar-title" class="text-lg font-medium text-gray-800 min-w-0 px-2">June 2025</h3>
        <button id="next-period" class="w-9 h-9 flex items-center justify-center bg-white rounded-full shadow-sm hover:shadow-md transition-all hover:scale-110 border border-gray-300">
          <span class="material-icons text-gray-600 text-sm">chevron_right</span>
        </button>
      </div>
      <button id="today-btn" class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-full text-xs font-medium transition-all hover:scale-105 flex items-center gap-1.5 shadow-sm">
        <span class="material-icons text-xs">today</span>
        <span>Today</span>
      </button>
    </div>
    
    <!-- Calendar Views Container -->
    <div class="calendar-container">
      <!-- Month View (Default) -->
      <div id="month-view" class="calendar-view active">
        <!-- Month overview banner -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 mb-4 shadow-lg">
          <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2">
            <div class="flex items-center gap-2 mb-1 md:mb-0">
              <span class="material-icons text-white">calendar_month</span>
              <h4 class="text-sm font-medium text-white">Month Overview</h4>
              <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm text-white text-xs rounded-full font-medium" id="month-name-badge"></span>
              </button>
        </div>
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-1">
                <span class="material-icons text-white text-sm">flag</span>
                                  <p class="text-xs text-white font-thin">Number: <span id="month-total-goals" class="font-light text-white">0</span></p>
        </div>
                <div class="flex items-center gap-1">
                  <span class="material-icons text-white text-sm">check_circle</span>
                  <p class="text-xs text-white font-thin">Completed: <span id="month-completed-goals" class="font-light text-white">0</span></p>
        </div>
                <div class="flex items-center gap-1">
                  <span class="material-icons text-white text-sm">pending</span>
                  <p class="text-xs text-white font-thin">Pending: <span id="month-pending-goals" class="font-light text-white">0</span></p>
                </button>
        </div>
              </button>
        </div>
        </div>
        </div>
        
        <!-- Days of week header -->
        <div class="grid grid-cols-7 mb-4 bg-gray-50 rounded-xl py-3">
          <div class="text-center text-sm font-medium text-gray-600 uppercase tracking-wide">Mon</div>
          <div class="text-center text-sm font-medium text-gray-600 uppercase tracking-wide">Tue</div>
          <div class="text-center text-sm font-medium text-gray-600 uppercase tracking-wide">Wed</div>
          <div class="text-center text-sm font-medium text-gray-600 uppercase tracking-wide">Thu</div>
          <div class="text-center text-sm font-medium text-gray-600 uppercase tracking-wide">Fri</div>
          <div class="text-center text-sm font-medium text-gray-600 uppercase tracking-wide">Sat</div>
          <div class="text-center text-sm font-medium text-gray-600 uppercase tracking-wide">Sun</div>
        </div>
        
        <!-- Calendar grid -->
        <div id="month-grid" class="grid grid-cols-7 gap-2 h-[500px]">
          <!-- Calendar cells will be generated dynamically -->
        </div>
      </div>
      
      <!-- Week View -->
      <div id="week-view" class="calendar-view hidden">
        <div class="flex flex-col h-[720px]">
          <!-- Week overview banner -->
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 mb-4 shadow-lg">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2">
              <div class="flex items-center gap-2 mb-1 md:mb-0">
                <span class="material-icons text-white">date_range</span>
                <h4 class="text-sm font-medium text-white">Week Overview</h4>
                <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm text-white text-xs rounded-full font-medium" id="week-number-badge"></span>
                </button>
        </div>
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-1">
                  <span class="material-icons text-white text-sm">flag</span>
                  <p class="text-xs text-white font-thin">Number: <span id="week-total-goals" class="font-light text-white">0</span></p>
        </div>
                <div class="flex items-center gap-1">
                  <span class="material-icons text-white text-sm">check_circle</span>
                  <p class="text-xs text-white font-thin">Completed: <span id="week-completed-goals" class="font-light text-white">0</span></p>
        </div>
                <div class="flex items-center gap-1">
                  <span class="material-icons text-white text-sm">pending</span>
                  <p class="text-xs text-white font-thin">Pending: <span id="week-pending-goals" class="font-light text-white">0</span></p>
        </div>
                </button>
        </div>
              </button>
        </div>
        </div>
          

          
          <!-- Week grid with hours -->
          <div class="flex flex-1 border border-gray-200 rounded-xl overflow-hidden shadow-sm bg-white">
            <!-- Time column -->
            <div class="w-32 border-r border-gray-200 bg-gradient-to-b from-gray-50 to-gray-100">
              <div class="h-16 flex items-center justify-center border-b border-gray-200 bg-gray-100">
                <span class="text-xs font-bold text-gray-700 uppercase tracking-wider">Time Period</span>
                </button>
        </div>
              <div class="flex flex-col">
                <div style="height: 120px;" class="text-sm font-semibold text-gray-700 text-center flex items-center justify-center border-b border-gray-200">
                  <div class="text-center">
                    <div class="w-8 h-8 mx-auto mb-2 flex items-center justify-center">
                      <img src="https://img.icons8.com/?size=100&id=118932&format=png&color=000000" class="w-8 h-8 object-contain" alt="Morning">
                      </button>
        </div>
                    <div class="text-xs text-gray-600 font-semibold">Morning</div>
                    <div class="text-xs text-gray-400">6AM - 12PM</div>
                    </button>
        </div>
        </div>
                <div style="height: 120px;" class="text-sm font-semibold text-gray-700 text-center flex items-center justify-center border-b border-gray-200">
                  <div class="text-center">
                    <div class="w-8 h-8 mx-auto mb-2 flex items-center justify-center">
                      <img src="https://img.icons8.com/?size=96&id=GIywaBFJCJiI&format=png" class="w-8 h-8 object-contain" alt="Afternoon">
                      </button>
        </div>
                    <div class="text-xs text-gray-600 font-semibold">Afternoon</div>
                    <div class="text-xs text-gray-400">12PM - 6PM</div>
                    </button>
        </div>
        </div>
                <div style="height: 120px;" class="text-sm font-semibold text-gray-700 text-center flex items-center justify-center border-b border-gray-200">
                  <div class="text-center">
                    <div class="w-8 h-8 mx-auto mb-2 flex items-center justify-center">
                      <img src="https://img.icons8.com/?size=160&id=111581&format=png" class="w-8 h-8 object-contain" alt="Evening">
                      </button>
        </div>
                    <div class="text-xs text-gray-600 font-semibold">Evening</div>
                    <div class="text-xs text-gray-400">6PM - 10PM</div>
                    </button>
        </div>
        </div>
                <div style="height: 120px;" class="text-sm font-semibold text-gray-700 text-center flex items-center justify-center border-b border-gray-200">
                  <div class="text-center">
                    <div class="w-8 h-8 mx-auto mb-2 flex items-center justify-center">
                      <img src="https://img.icons8.com/?size=128&id=1SUhM4MGNydC&format=png" class="w-8 h-8 object-contain" alt="Night">
                      </button>
        </div>
                    <div class="text-xs text-gray-600 font-semibold">Night</div>
                    <div class="text-xs text-gray-400">10PM - 6AM</div>
                    </button>
        </div>
        </div>
                <div style="height: 120px;" class="text-sm font-semibold text-gray-700 text-center flex items-center justify-center">
                  <div class="text-center">
                    <div class="w-8 h-8 mx-auto mb-2 flex items-center justify-center">
                      <img src="https://img.icons8.com/?size=160&id=hhUrGZKc66Si&format=png" class="w-8 h-8 object-contain" alt="Any Time">
                      </button>
        </div>
                    <div class="text-xs text-gray-600 font-semibold">Any Time</div>
                    <div class="text-xs text-gray-400">Flexible</div>
                    </button>
        </div>
        </div>
                </button>
        </div>
              </button>
        </div>
            
            <!-- Days section -->
            <div class="flex-1 flex flex-col">
              <!-- Day headers -->
              <div id="week-header" class="grid grid-cols-7 h-16 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                <!-- Will be populated dynamically -->
                </button>
        </div>
              
              <!-- Days grid -->
              <div id="week-grid" class="flex-1 flex flex-col gap-0 bg-white">
                <!-- Will be populated dynamically as time period rows -->
                </button>
        </div>
              </button>
        </div>
        </div>
        </div>
      </div>
      
      <!-- Day View (List View) -->
      <div id="day-view" class="calendar-view hidden">
        <div class="flex flex-col h-auto md:h-[500px]">
          <!-- Day overview banner -->
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 mb-4 shadow-lg">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2">
              <div class="flex items-center gap-2 mb-1 md:mb-0">
                <span class="material-icons text-white">today</span>
                <h4 class="text-sm font-medium text-white">Day Overview</h4>
                <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm text-white text-xs rounded-full font-medium" id="day-date-badge"></span>
                </button>
        </div>
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-1">
                  <span class="material-icons text-white text-sm">flag</span>
                  <p class="text-xs text-white font-thin">Number: <span id="day-total-goals" class="font-light text-white">0</span></p>
        </div>
                <div class="flex items-center gap-1">
                  <span class="material-icons text-white text-sm">check_circle</span>
                  <p class="text-xs text-white font-thin">Completed: <span id="day-completed-goals" class="font-light text-white">0</span></p>
        </div>
                <div class="flex items-center gap-1">
                  <span class="material-icons text-white text-sm">pending</span>
                  <p class="text-xs text-white font-thin">Pending: <span id="day-pending-goals" class="font-light text-white">0</span></p>
        </div>
                </button>
        </div>
              </button>
        </div>
        </div>
          
          <!-- Day header -->
          <div id="day-header" class="py-3 px-4 bg-white rounded-xl mb-4 ">
            <!-- Will be populated dynamically -->
        </div>
          
          <!-- Day schedule list -->
          <div id="day-list" class="flex-1 overflow-visible md:overflow-y-auto">
            <!-- Will be populated dynamically -->
        </div>
          
          <!-- Mobile Day List (Hidden on Desktop) -->
          <div id="mobile-day-list" class="mobile-day-list hidden">
            <!-- Will be populated dynamically with upcoming days -->
        </div>
        </div>
      </div>
    </div>
    
    <!-- Category Filter Dropdown -->
    <div class="mt-6 pt-4 border-t border-gray-100">
      <div class="flex justify-between items-center mb-4">
        <h4 class="text-xs font-thin text-gray-600">Filter by Category</h4>
        <span class="text-xs text-gray-400">Select multiple categories</span>
      </div>
      <div class="relative">
        <button id="category-filter-dropdown" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-left text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hover:border-gray-300 transition-all duration-200">
          <div class="flex items-center justify-between">
            <span id="selected-categories-text" class="text-gray-700">All Categories</span>
            <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        
        <div id="category-filter-options" class="absolute top-full left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-lg z-50 max-h-64 overflow-y-auto hidden">
          <div class="p-2">
            <!-- All Categories option -->
            <label class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors duration-150">
              <input type="checkbox" id="filter-all-categories" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
              <span class="text-sm font-medium text-gray-700">All Categories</span>
            </label>
            
            <!-- Individual category options will be populated here -->
            <div id="individual-category-filters" class="mt-2 pt-2 border-t border-gray-100">
              <!-- Will be populated dynamically -->
              </button>
        </div>
        </div>
        </div>
      </div>
    </div>
  `;
  
  momentumSections.appendChild(goalCalendarSection);
  
  // Create Update Goal Modal (but not Add Goal Modal since we're using a dedicated section now)
  const updateGoalModal = document.createElement('div');
  updateGoalModal.id = 'update-goal-modal';
  updateGoalModal.className = 'fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 flex items-center justify-center hidden';
  
  document.body.appendChild(updateGoalModal);
  
  // Create Completion Rates Section matching Progress section style
  const completionGraphSection = document.createElement('div');
  completionGraphSection.className = 'bg-white rounded-[35px] p-8 shadow-xl w-full relative overflow-hidden';
  completionGraphSection.style.borderRadius = '35px';
  
  completionGraphSection.innerHTML = `
    <!-- Glassmorphism background effects -->
    <div class="absolute inset-0 backdrop-blur-sm bg-white/10"></div>
    <div class="absolute top-1/4 -right-20 w-60 h-60 bg-white/10 rounded-full blur-3xl animate-pulse"></div>
    <div class="absolute bottom-1/4 -left-20 w-40 h-40 bg-white/15 rounded-full blur-2xl animate-pulse" style="animation-delay: 1s;"></div>
    
    <div class="relative z-10">
      <div class="mb-8">
        <h2 class="text-2xl font-light text-gray-800 mb-2" style="font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: -0.5px;">Completion Rates</h2>
        <p class="text-gray-600 text-sm">Completion percentages for all categories and overall average</p>
      </div>
      
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4" id="completion-charts-grid">
        <!-- Will be populated with simple category containers -->
      </div>
    </div>
  `;
  
  momentumSections.appendChild(completionGraphSection);
  
  // Set up completion category charts
  setTimeout(() => {
    renderCompletionCharts();
  }, 200);
  
  // Function to render all completion charts
  function renderCompletionCharts() {
    const chartsContainer = document.getElementById('completion-charts-grid');
    if (!chartsContainer) {
      console.log('Charts container not found');
      return;
    }
    
    // Sample completion rates data (would be real data in production)
    const completionRates = {
      'love': 82,
      'health': 65,
      'work': 78,
      'leisure': null, // No data - will show "No Habits"
      'finance': 84,
      'personal': undefined, // No data - will show "No Habits"  
      'social': 73
    };
    
    // Define categories manually to ensure they always display
    const defaultCategories = [
      { id: 'love', name: 'Love', color: '#EF4444' },
      { id: 'health', name: 'Health', color: '#10B981' },
      { id: 'work', name: 'Work', color: '#3B82F6' },
      { id: 'leisure', name: 'Leisure', color: '#8B5CF6' },
      { id: 'finance', name: 'Finance', color: '#F59E0B' },
      { id: 'personal', name: 'Personal', color: '#6B7280' },
      { id: 'social', name: 'Social', color: '#F97316' }
    ];
    
    // Use momentumState categories if available, otherwise use default
    const categoriesToUse = (momentumState && momentumState.categories && momentumState.categories.length > 0) 
      ? momentumState.categories 
      : defaultCategories;
    
    console.log('Using categories:', categoriesToUse.length);
    
    // Clear container
    chartsContainer.innerHTML = '';
    
    // Add "All Categories" card first - spans 2 columns
    const overallHtml = `
      <div class="completion-card transform transition-all duration-300 hover:scale-105 col-span-2">
        <div class="px-3 py-4 rounded-xl shadow-md text-center h-20 flex flex-col justify-center" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.8)); backdrop-filter: blur(10px);">
          <h3 class="text-sm font-medium text-white mb-1" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);">All Categories</h3>
          <p class="text-2xl font-bold text-white" style="text-shadow: 0 1px 3px rgba(0,0,0,0.4);">76%</p>
        </div>
      </div>
    `;
    chartsContainer.innerHTML = overallHtml;
    
    // Create simple card for each category
    categoriesToUse.forEach((category, index) => {
      const percentage = completionRates[category.id];
      const categoryColor = category.color || '#6B7280'; // Use direct color or fallback
      
      // Convert hex to rgba with transparency
      const rgbaColor = hexToRgba(categoryColor, 0.8);
      const rgbaColorDarker = hexToRgba(getDarkerColor(categoryColor), 0.8);
      
      // Determine display text and styling
      const hasData = percentage !== undefined && percentage !== null;
      const displayText = hasData ? `${percentage}%` : 'No Habits';
      const textSize = hasData ? 'text-2xl' : 'text-sm';
      
      const cardHtml = `
        <div class="completion-card transform transition-all duration-300 hover:scale-105" style="animation-delay: ${(index + 1) * 0.1}s;">
          <div class="px-3 py-4 rounded-xl shadow-md text-center h-20 flex flex-col justify-center" style="background: linear-gradient(135deg, ${rgbaColor}, ${rgbaColorDarker}); backdrop-filter: blur(10px);">
            <h3 class="text-sm font-medium text-white mb-1" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${category.name}</h3>
            <p class="${textSize} font-bold text-white" style="text-shadow: 0 1px 3px rgba(0,0,0,0.4);">${displayText}</p>
        </div>
        </div>
      `;
      
      chartsContainer.innerHTML += cardHtml;
    });
    
    console.log('Rendered', categoriesToUse.length + 1, 'completion cards');
  }
  
  // Helper function to create a darker version of a color
  function getDarkerColor(hexColor) {
    let r = parseInt(hexColor.slice(1, 3), 16);
    let g = parseInt(hexColor.slice(3, 5), 16);
    let b = parseInt(hexColor.slice(5, 7), 16);
    
    r = Math.max(0, r - 40);
    g = Math.max(0, g - 40);
    b = Math.max(0, b - 40);
    
    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
  }
  
  // Helper function to convert hex to rgba
  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }
  
  // Set up event listeners
  setupMomentumEventListeners();
}

// Helper function to render goal cards with liquid glass effects
function renderGoalCards(goals = momentumState.goals, showAll = false) {
  // Sort goals by date added (newest first) - if no dateAdded, put at end
  const sortedGoals = [...goals].sort((a, b) => {
    if (!a.dateAdded && !b.dateAdded) return 0;
    if (!a.dateAdded) return 1;
    if (!b.dateAdded) return -1;
    return new Date(b.dateAdded) - new Date(a.dateAdded);
  });
  
  // Check if mobile viewport
  const isMobile = window.innerWidth <= 768;
  const maxVisible = isMobile ? 5 : 9; // Show max 5 on mobile, 9 on desktop
  
  // Show limited goals unless showAll is true
  const displayGoals = showAll ? sortedGoals : sortedGoals.slice(0, maxVisible);
  const hasMoreGoals = sortedGoals.length > maxVisible;
  
  // Update show all button visibility
  setTimeout(() => {
    const showAllContainer = document.getElementById('show-all-container');
    if (showAllContainer) {
      showAllContainer.style.display = hasMoreGoals && !showAll ? 'block' : 'none';
    }
  }, 100);

// Immediate setup as backup
(function() {
})();  
  return displayGoals.map((goal, index) => {
    const category = momentumState.categories.find(c => c.id === goal.category);
    const gradientColors = getGradientColors(category.color);
    const animationDelay = index * 0.1;
    
    // Get frequency icon
    const frequencyIcon = goal.frequency === 'daily' ? 'schedule' : 
                         goal.frequency === 'weekly' ? 'view_week' : 
                         goal.frequency === 'monthly' ? 'calendar_month' : 'event_note';
    
    const frequencyText = goal.frequency === 'daily' ? 'Daily' : 
                         goal.frequency === 'weekly' ? `${goal.weeklyTarget || 3}x/Week` : 
                         goal.frequency === 'monthly' ? `${goal.monthlyTarget || 5}x/Month` : 
                         'Custom';
    
    return `
      <div class="goal-card-modern relative group cursor-pointer transform transition-all duration-300 hover:scale-[1.03] hover:-translate-y-1 hover:shadow-3xl" 
           style="animation-delay: ${animationDelay}s;" 
           data-goal-id="${goal.id}"
           onclick="showUpdateGoalModal(momentumState.goals.find(g => g.id === ${goal.id}))">
        
        <!-- Main card with glassmorphism -->
        <div class="relative overflow-hidden rounded-3xl bg-white/30 backdrop-blur-lg border border-white/40 shadow-2xl h-48">
          
          <!-- Liquid background effects -->
          <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-white/5"></div>
          <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl transform translate-x-8 -translate-y-8 group-hover:scale-150 transition-transform duration-700"></div>
          <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/15 rounded-full blur-xl transform -translate-x-4 translate-y-4 group-hover:scale-125 transition-transform duration-500"></div>
          
          <!-- Category gradient overlay -->
          <div class="absolute inset-0 bg-gradient-to-br opacity-100 group-hover:opacity-110 transition-opacity duration-300" style="background: linear-gradient(135deg, ${gradientColors[0]}DD, ${gradientColors[1]}EE);"></div>
          
          <!-- Content -->
          <div class="relative z-10 p-6 h-full flex flex-col">
            
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center border border-white/30 shadow-lg">
                  <span class="material-icons text-white text-lg">${category.icon}</span>
        </div>
                <div>
                  <h3 class="text-white font-semibold text-sm" style="text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">${category.name}</h3>
        </div>
                </button>
        </div>
              
              <!-- Progress circle -->
              <div class="relative w-12 h-12">
                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                  <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                        fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>
                  <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                        fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" 
                        stroke-dasharray="${calculateCompletionRate(goal)}, 100" class="transition-all duration-1000"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span class="text-white font-bold text-xs" style="text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">${calculateCompletionRate(goal)}%</span>
        </div>
                </button>
        </div>
              </button>
        </div>
            
            <!-- Goal title -->
            <div class="flex-1 mb-4">
              <h2 class="text-white font-bold text-lg leading-tight mb-2 line-clamp-2" title="${goal.title}" style="text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">
                ${goal.title}
              </h2>
              
              <!-- Frequency info -->
              <div class="flex items-center gap-1 text-white text-xs">
                <span class="material-icons text-xs">${frequencyIcon}</span>
                <span>${frequencyText}</span>
                </button>
        </div>
              </button>
        </div>
            
            <!-- Creation date -->
            <div class="flex justify-end text-white text-xs opacity-80">
              Since ${new Date(goal.dateCreated).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
              </button>
        </div>

        </div>
          

        </div>
        
        <!-- Hover glow effect -->
        <div class="absolute inset-0 rounded-3xl bg-gradient-to-br opacity-0 group-hover:opacity-25 transition-all duration-300 pointer-events-none shadow-xl group-hover:shadow-2xl" 
             style="background: linear-gradient(135deg, ${gradientColors[0]}, ${gradientColors[1]}); filter: blur(1px);"></div>
      </div>
    `;
  }).join('');
}

// Handle window resize to update visible habit limits
window.addEventListener('resize', () => {
  // Re-render goals with updated viewport-based limits
  const progressGrid = document.getElementById('goals-progress-grid');
  if (progressGrid && typeof renderGoalCards === 'function') {
    progressGrid.innerHTML = renderGoalCards();
  }
});

// Initialize date options for deadline selection
function initializeDateOptions() {
  const today = new Date();
  
  // Set minimum date to today
  const goalDeadline = document.getElementById('goal-deadline');
  if (goalDeadline) {
    goalDeadline.min = today.toISOString().split('T')[0];
  }
  
  // Update date displays for quick options
  const dateOptions = [
    { id: 'date-30', days: 30 },
    { id: 'date-90', days: 90 },
    { id: 'date-180', days: 180 },
    { id: 'date-365', days: 365 }
  ];
  
  dateOptions.forEach(option => {
    const element = document.getElementById(option.id);
    if (element) {
      const futureDate = new Date();
      futureDate.setDate(today.getDate() + option.days);
      element.textContent = futureDate.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric' 
      });
    }
  });
}

// Populate frequency-specific options
function populateFrequencyOptions(frequencyId) {
  const container = document.getElementById('frequency-specific-options');
  if (!container) return;
  
  let content = '';
  
  switch (frequencyId) {
    case 'weekly':
      content = `
        <div class="bg-white/10 backdrop-blur-md p-6 rounded-2xl border border-white/20 mb-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <span class="material-icons text-white">view_week</span>
            Which days of the week?
          </h3>
          <div class="grid grid-cols-7 gap-2">
            ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, index) => `
              <button type="button" class="weekly-day-btn flex flex-col items-center p-3 rounded-xl bg-white/20 border border-white/30 hover:bg-white/30 transition-all text-white text-sm font-medium" data-day="${index}">
                <span class="text-xs text-white">${day}</span>
            `).join('')}
        </div>
          <p class="text-white/70 text-sm mt-3">Select one or more days when you want to work on this goal</p>
          <input type="hidden" id="selected-days" value="">
        </div>
      `;
      break;
      
    case 'monthly':
      content = `
        <div class="bg-white/10 backdrop-blur-md p-6 rounded-2xl border border-white/20 mb-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <span class="material-icons text-white">calendar_month</span>
            Monthly recurrence pattern
          </h3>
          
          <div class="space-y-4">
            <div class="flex items-center gap-4">
              <input type="radio" id="monthly-pattern" name="monthly-type" value="pattern" class="text-blue-600 focus:ring-blue-500" checked>
              <label for="monthly-pattern" class="text-white font-medium">Recurring pattern</label>
              </button>
        </div>
            
            <div id="monthly-pattern-container" class="ml-6">
              <div id="recurring-patterns-list" class="space-y-3 mb-4">
                <div class="recurring-pattern-item bg-white/20 rounded-xl p-4 border border-white/30">
                  <div class="flex items-center gap-3">
                    <select class="monthly-occurrence bg-white/90 rounded-lg px-3 py-2 text-gray-800 text-sm font-medium">
                      <option value="first">First</option>
                      <option value="second">Second</option>
                      <option value="third">Third</option>
                      <option value="fourth">Fourth</option>
                      <option value="last">Last</option>
                    </select>
                    <select class="monthly-weekday bg-white/90 rounded-lg px-3 py-2 text-gray-800 text-sm font-medium">
                      <option value="monday">Monday</option>
                      <option value="tuesday">Tuesday</option>
                      <option value="wednesday">Wednesday</option>
                      <option value="thursday">Thursday</option>
                      <option value="friday">Friday</option>
                      <option value="saturday">Saturday</option>
                      <option value="sunday">Sunday</option>
                    </select>
                    <span class="text-white text-sm">of each month</span>
                    <button type="button" class="remove-pattern-btn ml-auto w-8 h-8 rounded-full bg-red-500/20 hover:bg-red-500/30 text-white flex items-center justify-center transition-all" style="display: none;">
                      <span class="material-icons text-sm">close</span>
                    </button>
        </div>
        </div>
                </button>
        </div>
              <button type="button" id="add-pattern-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-600/30 hover:bg-blue-600/40 text-white rounded-xl border border-blue-400/30 transition-all">
                <span class="material-icons text-sm">add</span>
                <span class="text-white">Add another pattern</span>
              <p class="text-white/70 text-xs mt-2">e.g., "First Monday of each month"</p>
              </button>
        </div>
            
            <div class="flex items-center gap-4">
              <input type="radio" id="monthly-specific" name="monthly-type" value="specific" class="text-blue-600 focus:ring-blue-500">
              <label for="monthly-specific" class="text-white font-medium">Specific dates each month</label>
              </button>
        </div>
            
            <div id="monthly-specific-container" class="ml-6 hidden">
              <div class="grid grid-cols-7 gap-2 mb-4">
                ${Array.from({length: 31}, (_, i) => i + 1).map(day => `
                  <button type="button" class="monthly-day-btn flex items-center justify-center w-8 h-8 rounded-lg bg-white/20 border border-white/30 hover:bg-white/30 transition-all text-white text-sm" data-day="${day}">
                    ${day}
                `).join('')}
                </button>
        </div>
              <p class="text-white/70 text-xs">Select specific dates (e.g., 1st, 15th of each month)</p>
              <p class="text-white/60 text-xs mt-2 italic">Note: If you select day 31, it will automatically adjust to the last day of months that don't have 31 days.</p>
              </button>
        </div>
        </div>
          <input type="hidden" id="monthly-config" value="">
        </div>
      `;
      break;
      
    case 'custom':
      content = `
        <div class="bg-white/10 backdrop-blur-md p-6 rounded-2xl border border-white/20 mb-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <span class="material-icons text-white">event_note</span>
            Custom schedule
          </h3>
          
          <div class="space-y-4">
            <div class="flex items-center gap-4">
              <input type="radio" id="custom-interval" name="custom-type" value="interval" class="text-blue-600 focus:ring-blue-500" checked>
              <label for="custom-interval" class="text-white font-medium">Repeat every</label>
              </button>
        </div>
            
            <div id="custom-interval-container" class="ml-6">
              <div class="flex items-center gap-3">
                <input type="number" id="interval-number" min="1" max="30" value="7" class="w-16 bg-white/90 rounded-lg px-3 py-2 text-gray-800 text-center font-medium">
                <select id="interval-unit" class="bg-white/90 rounded-lg px-3 py-2 text-gray-800 font-medium">
                  <option value="days">days</option>
                  <option value="weeks">weeks</option>
                  <option value="months">months</option>
                </select>
                </button>
        </div>
              <p class="text-white/70 text-xs mt-2">e.g., "Every 7 days", "Every 2 weeks", or "Every 3 months"</p>
              </button>
        </div>
            
            <div class="flex items-center gap-4">
              <input type="radio" id="custom-dates" name="custom-type" value="dates" class="text-blue-600 focus:ring-blue-500">
              <label for="custom-dates" class="text-white font-medium">Pick specific dates</label>
              </button>
        </div>
            
            <div id="custom-dates-container" class="ml-6 hidden">
              <div class="bg-white/20 rounded-2xl p-6 border border-white/30">
                <div class="flex items-center justify-between mb-6">
                  <button type="button" id="custom-prev-month" class="w-10 h-10 rounded-full bg-white/30 hover:bg-white/40 text-white flex items-center justify-center transition-all shadow-lg">
                    <span class="material-icons">chevron_left</span>
                  <div class="flex gap-3">
                    <select id="custom-calendar-month" class="bg-white rounded-xl px-4 py-2 text-gray-800 font-medium shadow-md">
                      ${Array.from({length: 12}, (_, i) => {
                        const date = new Date(2024, i, 1);
                        return `<option value="${i}">${date.toLocaleDateString('en-US', { month: 'long' })}</option>`;
                      }).join('')}
                    </select>
                    <select id="custom-calendar-year" class="bg-white rounded-xl px-4 py-2 text-gray-800 font-medium shadow-md">
                      ${Array.from({length: 3}, (_, i) => new Date().getFullYear() + i).map(year => 
                        `<option value="${year}">${year}</option>`
                      ).join('')}
                    </select>
                    </button>
        </div>
                  <button type="button" id="custom-next-month" class="w-10 h-10 rounded-full bg-white/30 hover:bg-white/40 text-white flex items-center justify-center transition-all shadow-lg">
                    <span class="material-icons">chevron_right</span>
        </div>
                
                <div class="grid grid-cols-7 gap-2 text-center mb-4">
                  ${['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(day => 
                    `<div class="text-white font-medium text-sm p-2">${day}</div>`
                  ).join('')}
        </div>
                
                <div id="custom-calendar-grid" class="grid grid-cols-7 gap-2 mb-4">
                  <!-- Calendar days will be populated by JavaScript -->
        </div>
                
                <div class="flex items-center justify-between pt-4 border-t border-white/20">
                  <button type="button" id="clear-selected-dates" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-all flex items-center gap-2">
                    <span class="material-icons text-sm">clear</span>
                    <span class="text-white">Clear all</span>
                  <span class="text-white font-medium" id="selected-dates-count">0 dates selected</span>
        </div>
                </button>
        </div>
              </button>
        </div>
        </div>
          <input type="hidden" id="custom-config" value="">
        </div>
      `;
      break;
      
    default:
      // For daily, no additional options needed
      content = '';
      break;
  }
  
  container.innerHTML = content;
  
  // Add event listeners for the new elements
  setupFrequencySpecificListeners(frequencyId);
}

// Setup event listeners for frequency-specific options
function setupFrequencySpecificListeners(frequencyId) {
  switch (frequencyId) {
    case 'weekly':
      document.querySelectorAll('.weekly-day-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const isSelected = this.classList.contains('selected');
          
          if (isSelected) {
            // Deselect
            this.classList.remove('selected');
            this.classList.add('bg-white/20', 'border-white/30', 'text-white');
            this.querySelector('span').classList.remove('text-white');
            this.querySelector('span').classList.add('text-white');
          } else {
            // Select
            this.classList.remove('bg-white/20', 'border-white/30', 'text-white');
            this.classList.add('selected');
            this.querySelector('span').classList.remove('text-white');
            this.querySelector('span').classList.add('text-white');
          }
          
          // Update selected days
          const selectedDays = Array.from(document.querySelectorAll('.weekly-day-btn.selected'))
            .map(btn => btn.getAttribute('data-day'));
          document.getElementById('selected-days').value = selectedDays.join(',');
        });
      });
      break;
      
    case 'monthly':
      // Monthly type radio buttons
      document.querySelectorAll('input[name="monthly-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const specificContainer = document.getElementById('monthly-specific-container');
          const patternContainer = document.getElementById('monthly-pattern-container');
          
          if (this.value === 'specific') {
            specificContainer.classList.remove('hidden');
            patternContainer.classList.add('hidden');
          } else {
            specificContainer.classList.add('hidden');
            patternContainer.classList.remove('hidden');
          }
        });
      });
      
      // Monthly day buttons
      document.querySelectorAll('.monthly-day-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('selected');
          this.classList.toggle('bg-white/20');
          this.classList.toggle('border-white/30');
          
          // Update config
          updateMonthlyConfig();
        });
      });
      
      // Add pattern button
      document.getElementById('add-pattern-btn')?.addEventListener('click', function() {
        const patternsList = document.getElementById('recurring-patterns-list');
        const patternCount = patternsList.children.length;
        
        const newPattern = document.createElement('div');
        newPattern.className = 'recurring-pattern-item bg-white/20 rounded-xl p-4 border border-white/30';
        newPattern.innerHTML = `
          <div class="flex items-center gap-3">
            <select class="monthly-occurrence bg-white/90 rounded-lg px-3 py-2 text-gray-800 text-sm font-medium">
              <option value="first">First</option>
              <option value="second">Second</option>
              <option value="third">Third</option>
              <option value="fourth">Fourth</option>
              <option value="last">Last</option>
            </select>
            <select class="monthly-weekday bg-white/90 rounded-lg px-3 py-2 text-gray-800 text-sm font-medium">
              <option value="monday">Monday</option>
              <option value="tuesday">Tuesday</option>
              <option value="wednesday">Wednesday</option>
              <option value="thursday">Thursday</option>
              <option value="friday">Friday</option>
              <option value="saturday">Saturday</option>
              <option value="sunday">Sunday</option>
            </select>
            <span class="text-white text-sm">of each month</span>
            <button type="button" class="remove-pattern-btn ml-auto w-8 h-8 rounded-full bg-red-500/20 hover:bg-red-500/30 text-white flex items-center justify-center transition-all">
              <span class="material-icons text-sm">close</span>
        </div>
        `;
        
        patternsList.appendChild(newPattern);
        
        // Add event listeners to new pattern
        const removeBtn = newPattern.querySelector('.remove-pattern-btn');
        removeBtn.addEventListener('click', function() {
          newPattern.remove();
          updateMonthlyConfig();
          updateRemoveButtonsVisibility();
        });
        
        newPattern.querySelector('.monthly-occurrence').addEventListener('change', updateMonthlyConfig);
        newPattern.querySelector('.monthly-weekday').addEventListener('change', updateMonthlyConfig);
        
        updateMonthlyConfig();
        updateRemoveButtonsVisibility();
      });
      
      // Remove pattern buttons
      document.querySelectorAll('.remove-pattern-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.closest('.recurring-pattern-item').remove();
          updateMonthlyConfig();
          updateRemoveButtonsVisibility();
        });
      });
      
      // Monthly pattern selects
      document.querySelectorAll('.monthly-occurrence').forEach(select => {
        select.addEventListener('change', updateMonthlyConfig);
      });
      document.querySelectorAll('.monthly-weekday').forEach(select => {
        select.addEventListener('change', updateMonthlyConfig);
      });
      
      // Initialize remove button visibility
      updateRemoveButtonsVisibility();
      break;
      
    case 'custom':
      // Custom type radio buttons
      document.querySelectorAll('input[name="custom-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const intervalContainer = document.getElementById('custom-interval-container');
          const datesContainer = document.getElementById('custom-dates-container');
          
          if (this.value === 'interval') {
            intervalContainer.classList.remove('hidden');
            datesContainer.classList.add('hidden');
          } else {
            intervalContainer.classList.add('hidden');
            datesContainer.classList.remove('hidden');
            renderCustomCalendar();
          }
        });
      });
      
      // Interval inputs
      document.getElementById('interval-number')?.addEventListener('change', updateCustomConfig);
      document.getElementById('interval-unit')?.addEventListener('change', updateCustomConfig);
      
      // Calendar navigation
      document.getElementById('custom-prev-month')?.addEventListener('click', () => navigateCustomCalendar(-1));
      document.getElementById('custom-next-month')?.addEventListener('click', () => navigateCustomCalendar(1));
      document.getElementById('custom-calendar-month')?.addEventListener('change', renderCustomCalendar);
      document.getElementById('custom-calendar-year')?.addEventListener('change', renderCustomCalendar);
      
      // Clear selected dates button
      document.getElementById('clear-selected-dates')?.addEventListener('click', function() {
        selectedCustomDates.clear();
        renderCustomCalendar(); // Re-render to update visual state
        updateCustomConfig();
      });
      
      // Initialize calendar
      renderCustomCalendar();
      break;
  }
}

// Helper functions for monthly configuration
function updateMonthlyConfig() {
  const type = document.querySelector('input[name="monthly-type"]:checked')?.value;
  let config = { type };
  
  if (type === 'specific') {
    const selectedDays = Array.from(document.querySelectorAll('.monthly-day-btn.selected'))
      .map(btn => btn.getAttribute('data-day'));
    config.days = selectedDays;
  } else {
    const patterns = [];
    document.querySelectorAll('.recurring-pattern-item').forEach(item => {
      const occurrence = item.querySelector('.monthly-occurrence').value;
      const weekday = item.querySelector('.monthly-weekday').value;
      patterns.push({ occurrence, weekday });
    });
    config.patterns = patterns;
  }
  
  document.getElementById('monthly-config').value = JSON.stringify(config);
}

// Update remove button visibility for monthly patterns
function updateRemoveButtonsVisibility() {
  const patterns = document.querySelectorAll('.recurring-pattern-item');
  patterns.forEach((pattern, index) => {
    const removeBtn = pattern.querySelector('.remove-pattern-btn');
    if (patterns.length > 1) {
      removeBtn.style.display = 'flex';
    } else {
      removeBtn.style.display = 'none';
    }
  });
}

// Update selected dates count for custom calendar
function updateSelectedDatesCount() {
  const selectedCount = selectedCustomDates.size;
  const countElement = document.getElementById('selected-dates-count');
  if (countElement) {
    countElement.textContent = `${selectedCount} date${selectedCount !== 1 ? 's' : ''} selected`;
  }
}

// Helper functions for custom configuration
function updateCustomConfig() {
  const type = document.querySelector('input[name="custom-type"]:checked')?.value;
  let config = { type };
  
  if (type === 'interval') {
    config.number = document.getElementById('interval-number')?.value;
    config.unit = document.getElementById('interval-unit')?.value;
  } else {
    config.dates = Array.from(selectedCustomDates);
  }
  
  document.getElementById('custom-config').value = JSON.stringify(config);
}

// Global variable to store selected dates across months
let selectedCustomDates = new Set();

// Calendar rendering for custom dates
function renderCustomCalendar() {
  const monthSelect = document.getElementById('custom-calendar-month');
  const yearSelect = document.getElementById('custom-calendar-year');
  const calendarGrid = document.getElementById('custom-calendar-grid');
  
  if (!monthSelect || !yearSelect || !calendarGrid) return;
  
  const month = parseInt(monthSelect.value);
  const year = parseInt(yearSelect.value);
  
  // Set current month/year if not set
  if (!monthSelect.value) {
    const now = new Date();
    monthSelect.value = now.getMonth();
    yearSelect.value = now.getFullYear();
    return renderCustomCalendar();
  }
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  let html = '';
  
  // Empty cells for days before month starts
  for (let i = 0; i < firstDay; i++) {
    html += '<div class="calendar-day-empty w-10 h-10"></div>';
  }
  
  // Days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isSelected = selectedCustomDates.has(dateStr);
    const selectedClass = isSelected ? 'selected' : 'bg-white/20 text-white';
    
    html += `
      <button type="button" class="calendar-day w-10 h-10 rounded-lg hover:bg-white/30 text-xs transition-all font-medium ${selectedClass}" data-date="${dateStr}">
        ${day}
    `;
  }
  
  calendarGrid.innerHTML = html;
  
  // Add click listeners to calendar days
  document.querySelectorAll('.calendar-day').forEach(day => {
    day.addEventListener('click', function() {
      const dateStr = this.getAttribute('data-date');
      
      if (this.classList.contains('selected')) {
        // Deselect
        this.classList.remove('selected');
        this.classList.add('bg-white/20');
        selectedCustomDates.delete(dateStr);
      } else {
        // Select
        this.classList.add('selected');
        this.classList.remove('bg-white/20');
        selectedCustomDates.add(dateStr);
      }
      
      updateSelectedDatesCount();
      updateCustomConfig();
    });
  });
  
  // Update the selected dates count after rendering
  updateSelectedDatesCount();
}

function navigateCustomCalendar(direction) {
  const monthSelect = document.getElementById('custom-calendar-month');
  const yearSelect = document.getElementById('custom-calendar-year');
  
  if (!monthSelect || !yearSelect) return;
  
  let month = parseInt(monthSelect.value);
  let year = parseInt(yearSelect.value);
  
  month += direction;
  
  if (month < 0) {
    month = 11;
    year--;
  } else if (month > 11) {
    month = 0;
    year++;
  }
  
  // Ensure we don't go too far back or forward
  const currentYear = new Date().getFullYear();
  if (year < currentYear) {
    year = currentYear;
    month = 0;
  } else if (year > currentYear + 2) {
    year = currentYear + 2;
    month = 11;
  }
  
  // Update the year select options if needed
  const yearOptions = Array.from(yearSelect.options).map(opt => parseInt(opt.value));
  if (!yearOptions.includes(year)) {
    // Add the new year option
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
  
  monthSelect.value = month;
  yearSelect.value = year;
  
  renderCustomCalendar();
}

// Set up event listeners for Momentum tab
function setupMomentumEventListeners() {
  // Initialize Goal Calendar
  initializeGoalCalendar();
  
  // Initialize Completion Trend Chart with a slight delay to ensure DOM is ready
  setTimeout(() => {
    initializeCompletionTrendChart();
  }, 500);
  
  // Filter by category
  const categoryFilter = document.getElementById('momentum-filter');
  let showAllGoals = false;
  
  if (categoryFilter) {
    categoryFilter.addEventListener('change', function() {
      // Filter goals by selected category
      const filtered = categoryFilter.value === 'all' 
        ? momentumState.goals
        : momentumState.goals.filter(g => g.category === categoryFilter.value);
      
      // Reset show all state when filtering
      showAllGoals = false;
      
      // Re-render goals grid
      document.getElementById('goals-progress-grid').innerHTML = renderGoalCards(filtered, showAllGoals);
      
      // Re-attach event listeners to new buttons
      setupGoalButtonListeners();
    });
  }
  
  // Show All Goals button
  setTimeout(() => {
    const showAllBtn = document.getElementById('show-all-goals-btn');
    if (showAllBtn) {
      showAllBtn.addEventListener('click', function() {
        showAllGoals = true;
        
        // Get current filtered goals
        const filtered = categoryFilter && categoryFilter.value !== 'all' 
          ? momentumState.goals.filter(g => g.category === categoryFilter.value)
          : momentumState.goals;
        
        // Re-render with all goals
        document.getElementById('goals-progress-grid').innerHTML = renderGoalCards(filtered, showAllGoals);
        
        // Re-attach event listeners
        setupGoalButtonListeners();
        
        // Update button text and styling
        this.className = "px-6 py-3 bg-gray-50 border border-gray-200 text-gray-700 rounded-full font-medium hover:bg-gray-100 hover:scale-105 transition-all duration-300 flex items-center gap-2 mx-auto shadow-lg";
        this.innerHTML = `
          <span class="material-icons text-sm">visibility_off</span>
          <span>Show Less</span>
        `;
        
        // Change functionality to show less
        this.onclick = function() {
          showAllGoals = false;
          const filtered = categoryFilter && categoryFilter.value !== 'all' 
            ? momentumState.goals.filter(g => g.category === categoryFilter.value)
            : momentumState.goals;
          
          document.getElementById('goals-progress-grid').innerHTML = renderGoalCards(filtered, showAllGoals);
          setupGoalButtonListeners();
          
          this.className = "px-6 py-3 bg-blue-50 border border-blue-200 text-blue-700 rounded-full font-medium hover:bg-blue-100 hover:scale-105 transition-all duration-300 flex items-center gap-2 mx-auto shadow-lg";
          this.innerHTML = `
            <span class="material-icons text-sm">visibility</span>
            <span>Show All Goals</span>
          `;
          this.onclick = arguments.callee.caller; // Reset to original function
        };
      });
    }
  }, 100);

// Immediate setup as backup
(function() {
})();  
  // New Multi-Step Goal Form Navigation
  const goalStep1 = document.getElementById('goal-step-1');
  const goalStep2 = document.getElementById('goal-step-2');
  const goalStep3 = document.getElementById('goal-step-3');
  const goalStep4 = document.getElementById('goal-step-4');
  
  // Step 1 to Step 2 (Goal Title to Category)
  const goalNext1 = document.getElementById('goal-next-1');
  if (goalNext1) {
    goalNext1.addEventListener('click', function() {
      const goalTitle = document.getElementById('goal-title');
      if (goalTitle && goalTitle.value.trim()) {
        // Update the goal name display in Step 2
        const goalNameDisplay = document.getElementById('goal-name-display');
        if (goalNameDisplay) {
          goalNameDisplay.textContent = goalTitle.value.trim();
        }
        
        // Animate transition
        goalStep1.style.opacity = '0';
        goalStep1.style.transform = 'translateX(-20px)';
        goalStep1.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          goalStep1.classList.add('hidden');
          goalStep2.classList.remove('hidden');
          goalStep2.style.opacity = '0';
          goalStep2.style.transform = 'translateX(20px)';
          
          // Force reflow
          void goalStep2.offsetWidth;
          
          goalStep2.style.opacity = '1';
          goalStep2.style.transform = 'translateX(0)';
          goalStep2.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        }, 300);
      }
    });
  }
  
  // Step 2 back to Step 1
  const goalBack2 = document.getElementById('goal-back-2');
  if (goalBack2) {
    goalBack2.addEventListener('click', function() {
      // Animate transition
      goalStep2.style.opacity = '0';
      goalStep2.style.transform = 'translateX(20px)';
      goalStep2.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      
      setTimeout(() => {
        goalStep2.classList.add('hidden');
        goalStep1.classList.remove('hidden');
        goalStep1.style.opacity = '0';
        goalStep1.style.transform = 'translateX(-20px)';
        
        // Force reflow
        void goalStep1.offsetWidth;
        
        goalStep1.style.opacity = '1';
        goalStep1.style.transform = 'translateX(0)';
        goalStep1.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      }, 300);
    });
  }
  
  // Category buttons (Step 2)
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const categoryId = this.getAttribute('data-category-id');
      document.getElementById('goal-category').value = categoryId;
      
      // Reset all buttons
      document.querySelectorAll('.category-btn').forEach(b => {
        b.classList.remove('bg-white/40');
        b.classList.remove('border-white/50');
        b.classList.remove('scale-105');
      });
      
      // Highlight selected button
      this.classList.add('bg-white/40');
      this.classList.add('border-white/50');
      this.classList.add('scale-105');
      
      // Animate transition to next step after a brief delay
      setTimeout(() => {
        // Animate transition
        goalStep2.style.opacity = '0';
        goalStep2.style.transform = 'translateX(-20px)';
        goalStep2.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          goalStep2.classList.add('hidden');
          goalStep3.classList.remove('hidden');
          goalStep3.style.opacity = '0';
          goalStep3.style.transform = 'translateX(20px)';
          
          // Force reflow
          void goalStep3.offsetWidth;
          
          goalStep3.style.opacity = '1';
          goalStep3.style.transform = 'translateX(0)';
          goalStep3.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        }, 300);
      }, 500);
    });
  });
  
  // Step 3 back to Step 2
  const goalBack3 = document.getElementById('goal-back-3');
  if (goalBack3) {
    goalBack3.addEventListener('click', function() {
      // Animate transition
      goalStep3.style.opacity = '0';
      goalStep3.style.transform = 'translateX(20px)';
      goalStep3.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      
      setTimeout(() => {
        goalStep3.classList.add('hidden');
        goalStep2.classList.remove('hidden');
        goalStep2.style.opacity = '0';
        goalStep2.style.transform = 'translateX(-20px)';
        
        // Force reflow
        void goalStep2.offsetWidth;
        
        goalStep2.style.opacity = '1';
        goalStep2.style.transform = 'translateX(0)';
        goalStep2.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      }, 300);
    });
  }
  
  // Priority buttons (Step 3)
  document.querySelectorAll('.priority-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const priorityId = this.getAttribute('data-priority-id');
      document.getElementById('goal-priority').value = priorityId;
      
      // Reset all buttons
      document.querySelectorAll('.priority-btn').forEach(b => {
        b.classList.remove('bg-white/40');
        b.classList.remove('border-white/50');
        b.classList.remove('scale-105');
      });
      
      // Highlight selected button
      this.classList.add('bg-white/40');
      this.classList.add('border-white/50');
      this.classList.add('scale-105');
      
      // Animate transition to next step after a brief delay
      setTimeout(() => {
        // Animate transition
        goalStep3.style.opacity = '0';
        goalStep3.style.transform = 'translateX(-20px)';
        goalStep3.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          goalStep3.classList.add('hidden');
          goalStep4.classList.remove('hidden');
          goalStep4.style.opacity = '0';
          goalStep4.style.transform = 'translateX(20px)';
          
          // Force reflow
          void goalStep4.offsetWidth;
          
          goalStep4.style.opacity = '1';
          goalStep4.style.transform = 'translateX(0)';
          goalStep4.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        }, 300);
      }, 500);
    });
  });
  
  // Step 4 back to Step 3
  const goalBack4 = document.getElementById('goal-back-4');
  if (goalBack4) {
    goalBack4.addEventListener('click', function() {
      // Animate transition
      goalStep4.style.opacity = '0';
      goalStep4.style.transform = 'translateX(20px)';
      goalStep4.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      
      setTimeout(() => {
        goalStep4.classList.add('hidden');
        goalStep3.classList.remove('hidden');
        goalStep3.style.opacity = '0';
        goalStep3.style.transform = 'translateX(-20px)';
        
        // Force reflow
        void goalStep3.offsetWidth;
        
        goalStep3.style.opacity = '1';
        goalStep3.style.transform = 'translateX(0)';
        goalStep3.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      }, 300);
    });
  }
  
  // Frequency buttons (Step 4)
  document.querySelectorAll('.frequency-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const frequencyId = this.getAttribute('data-frequency-id');
      document.getElementById('goal-frequency').value = frequencyId;
      
      // Reset all buttons
      document.querySelectorAll('.frequency-btn').forEach(b => {
        b.classList.remove('bg-white/40');
        b.classList.remove('border-white/50');
        b.classList.remove('scale-105');
      });
      
      // Highlight selected button
      this.classList.add('bg-white/40');
      this.classList.add('border-white/50');
      this.classList.add('scale-105');
      
      // Animate transition to Step 5 (Time and Deadline) after a brief delay
      setTimeout(() => {
        // Animate transition
        goalStep4.style.opacity = '0';
        goalStep4.style.transform = 'translateX(-20px)';
        goalStep4.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          goalStep4.classList.add('hidden');
          const goalStep5 = document.getElementById('goal-step-5');
          goalStep5.classList.remove('hidden');
          goalStep5.style.opacity = '0';
          goalStep5.style.transform = 'translateX(20px)';
          
          // Force reflow
          void goalStep5.offsetWidth;
          
          goalStep5.style.opacity = '1';
          goalStep5.style.transform = 'translateX(0)';
          goalStep5.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          
          // Initialize deadline date options
          initializeDateOptions();
          
          // Populate frequency-specific options
          populateFrequencyOptions(frequencyId);
        }, 300);
      }, 500);
      

    });
  });
  
  // Step 5 back to Step 4
  const goalBack5 = document.getElementById('goal-back-5');
  if (goalBack5) {
    goalBack5.addEventListener('click', function() {
      const goalStep5 = document.getElementById('goal-step-5');
      // Animate transition
      goalStep5.style.opacity = '0';
      goalStep5.style.transform = 'translateX(20px)';
      goalStep5.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      
      setTimeout(() => {
        goalStep5.classList.add('hidden');
        goalStep4.classList.remove('hidden');
        goalStep4.style.opacity = '0';
        goalStep4.style.transform = 'translateX(-20px)';
        
        // Force reflow
        void goalStep4.offsetWidth;
        
        goalStep4.style.opacity = '1';
        goalStep4.style.transform = 'translateX(0)';
        goalStep4.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      }, 300);
    });
  }
  
  // Time period buttons (Step 5)
  document.querySelectorAll('.time-period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const period = this.getAttribute('data-period');
      document.getElementById('goal-time-period').value = period;
      
      // Reset all buttons
      document.querySelectorAll('.time-period-btn').forEach(b => {
        b.classList.remove('bg-white/40');
        b.classList.remove('border-white/50');
        b.classList.remove('scale-105');
      });
      
      // Highlight selected button
      this.classList.add('bg-white/40');
      this.classList.add('border-white/50');
      this.classList.add('scale-105');
      
      // Show custom time input for specific periods (not for "anytime")
      const customTimeInput = document.getElementById('custom-time-input');
      if (period !== 'anytime') {
        customTimeInput.classList.remove('hidden');
        customTimeInput.style.opacity = '0';
        
        // Force reflow
        void customTimeInput.offsetWidth;
        
        customTimeInput.style.opacity = '1';
        customTimeInput.style.transition = 'opacity 0.3s ease';
      } else {
        customTimeInput.classList.add('hidden');
        document.getElementById('goal-time').value = '';
      }
    });
  });
  
  // Clear time button
  const clearTimeBtn = document.getElementById('clear-time');
  if (clearTimeBtn) {
    clearTimeBtn.addEventListener('click', function() {
      document.getElementById('goal-time').value = '';
    });
  }
  
  // Deadline buttons (Step 5)
  document.querySelectorAll('.deadline-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const days = parseInt(this.getAttribute('data-days'));
      const deadline = new Date();
      deadline.setDate(deadline.getDate() + days);
      
      // Set the date input
      document.getElementById('goal-deadline').value = deadline.toISOString().split('T')[0];
      
      // Reset all buttons
      document.querySelectorAll('.deadline-btn').forEach(b => {
        b.classList.remove('bg-white/40');
        b.classList.remove('border-white/50');
        b.classList.remove('scale-105');
      });
      
      // Highlight selected button
      this.classList.add('bg-white/40');
      this.classList.add('border-white/50');
      this.classList.add('scale-105');
    });
  });
  

  

  
  // Create goal button
  const createGoalBtn = document.getElementById('create-goal-btn');
  if (createGoalBtn) {
    createGoalBtn.addEventListener('click', function() {
      const title = document.getElementById('goal-title').value.trim();
      const category = document.getElementById('goal-category').value;
      const priority = document.getElementById('goal-priority').value;
      const frequency = document.getElementById('goal-frequency').value;
      const deadline = document.getElementById('goal-deadline').value;
      const notes = ''; // No notes section anymore
      
      // Basic validation
      if (!title) {
        alert('Please enter a goal title');
        return;
      }
      
      if (!category) {
        alert('Please select a category');
        return;
      }
      
      if (!priority) {
        alert('Please select a priority');
        return;
      }
      
      if (!frequency) {
        alert('Please select a frequency');
        return;
      }
      
      if (!deadline) {
        alert('Please select a target date');
        return;
      }
      
      // Get time period and specific time if set
      const timePeriod = document.getElementById('goal-time-period').value;
      const timeInput = document.getElementById('goal-time');
      const specificTime = timeInput && timeInput.value ? timeInput.value : '';
      
      // Create new goal with the updated data structure
      const newGoal = {
        id: momentumState.goals.length > 0 ? Math.max(...momentumState.goals.map(g => g.id)) + 1 : 1,
        title,
        category,
        deadline,
        priority,
        frequency,
        weeklyTarget: null,
        monthlyTarget: null,
        dateCreated: new Date().toISOString().split('T')[0],
        time: specificTime || timePeriod || 'anytime',
        completions: []
      };
      
      // Add frequency-specific properties
      if (frequency === 'weekly') {
        const selectedDays = document.getElementById('selected-days')?.value;
        newGoal.weeklyDays = selectedDays ? selectedDays.split(',').map(d => parseInt(d)) : [];
        newGoal.weeklyTarget = newGoal.weeklyDays.length || 3;
      } else if (frequency === 'monthly') {
        const monthlyConfig = document.getElementById('monthly-config')?.value;
        if (monthlyConfig) {
          newGoal.monthlyConfig = JSON.parse(monthlyConfig);
        }
        newGoal.monthlyTarget = parseInt(document.getElementById('monthly-target')?.value) || 5;
      } else if (frequency === 'custom') {
        const customConfig = document.getElementById('custom-config')?.value;
        if (customConfig) {
          newGoal.customConfig = JSON.parse(customConfig);
        }
      }
      
      // Add to state
      momentumState.goals.push(newGoal);
      
      // Re-render goals grid
      document.getElementById('goals-progress-grid').innerHTML = renderGoalCards();
      
      // Update calendar if it exists
      if (calendarState && typeof renderCurrentView === 'function') {
        renderCurrentView();
      }
      
      // Show success message in step 5
      const goalStep5 = document.getElementById('goal-step-5');
      goalStep5.innerHTML = `
        <div class="flex flex-col items-center justify-center text-center py-8">
          <div class="w-20 h-20 rounded-full bg-white flex items-center justify-center mb-6">
            <span class="material-icons-outlined text-green-500" style="font-size: 40px;">check_circle</span>
        </div>
          <h3 class="text-white text-2xl font-bold mb-4">Goal Created Successfully!</h3>
          <p class="text-white/80 mb-8">Your goal "${title}" has been added to your list.</p>
          <button type="button" id="add-another-goal" class="px-8 py-4 rounded-2xl bg-white text-blue-600 hover:bg-blue-50 transition-all shadow-lg hover:shadow-xl font-bold text-lg flex items-center justify-center mx-auto">
            <span class="material-icons-outlined mr-2" style="font-size: 24px;">add</span> Add Another Goal
        </div>
      `;
      
      // Add event listener to the "Add Another Goal" button
      setTimeout(() => {
        const addAnotherBtn = document.getElementById('add-another-goal');
        if (addAnotherBtn) {
          addAnotherBtn.addEventListener('click', function() {
            resetGoalForm();
          });
        }
      }, 100);

// Immediate setup as backup
(function() {
})();      
      // Re-attach event listeners
      setupGoalButtonListeners();
    });
  }
  


  // Initial setup of goal button listeners
  setupGoalButtonListeners();
}

// Helper functions for frequency selection have been replaced by the showFrequencyDetailScreen function

// Helper functions for the number input controls
function incrementTarget(inputId, max) {
  const input = document.getElementById(inputId);
  const currentValue = parseInt(input.value) || 0;
  if (currentValue < max) {
    input.value = currentValue + 1;
  }
}

function decrementTarget(inputId, min) {
  const input = document.getElementById(inputId);
  const currentValue = parseInt(input.value) || 0;
  if (currentValue > min) {
    input.value = currentValue - 1;
  }
}

// Helper function to reset the goal form
function resetGoalForm() {
  // Reset to step 1
  document.getElementById('goal-step-1').classList.remove('hidden');
  document.getElementById('goal-step-1').style.opacity = '1';
  document.getElementById('goal-step-1').style.transform = 'translateX(0)';
  
  document.getElementById('goal-step-2').classList.add('hidden');
  document.getElementById('goal-step-3').classList.add('hidden');
  document.getElementById('goal-step-4').classList.add('hidden');
  document.getElementById('goal-step-5').classList.add('hidden');
  document.getElementById('custom-time-input').classList.add('hidden');
  
  // Clear frequency-specific options
  const frequencyOptionsContainer = document.getElementById('frequency-specific-options');
  if (frequencyOptionsContainer) {
    frequencyOptionsContainer.innerHTML = '';
  }
  
  // Clear selected custom dates
  if (typeof selectedCustomDates !== 'undefined') {
    selectedCustomDates.clear();
  }
  
  // Clear input values
  document.getElementById('goal-title').value = '';
  document.getElementById('goal-category').value = '';
  document.getElementById('goal-priority').value = '';
  document.getElementById('goal-frequency').value = '';
  document.getElementById('goal-time-period').value = '';
  document.getElementById('goal-deadline').value = '';
  if (document.getElementById('goal-time')) {
    document.getElementById('goal-time').value = '';
  }
  document.getElementById('title-char-count').textContent = '0';
  
  // Reset all button selections
  document.querySelectorAll('.category-btn, .priority-btn, .frequency-btn, .time-period-btn, .deadline-btn').forEach(btn => {
    btn.classList.remove('bg-white/40', 'border-white/50', 'scale-105');
  });
  
  // Hide create goal button
  const createGoalBtn = document.getElementById('create-goal-btn');
  if (createGoalBtn) {
    createGoalBtn.style.display = 'none';
  }
  
  // Disable next button
  document.getElementById('goal-next-1').disabled = true;
}

// Function to update character count for the goal title in the old form
function updateCharacterCount(input) {
  const charCount = document.getElementById('title-char-count');
  if (charCount) {
    charCount.textContent = input.value.length;
    
    // Add visual feedback as user approaches the limit
    if (input.value.length > 35) {
      charCount.classList.add('text-red-600');
      charCount.classList.remove('text-amber-600', 'text-gray-500');
    } else if (input.value.length > 30) {
      charCount.classList.add('text-amber-600');
      charCount.classList.remove('text-red-600', 'text-gray-500');
    } else {
      charCount.classList.add('text-gray-500');
      charCount.classList.remove('text-amber-600', 'text-red-600');
    }
  }
}

// Function to update character count for the new goal form
function updateGoalCharCount(input) {
  const charCount = document.getElementById('title-char-count');
  if (charCount) {
    charCount.textContent = input.value.length;
    
    // Add visual feedback as user approaches the limit
    if (input.value.length > 25) {
      charCount.classList.add('text-red-600');
      charCount.classList.remove('text-amber-600', 'text-gray-500');
    } else if (input.value.length > 20) {
      charCount.classList.add('text-amber-600');
      charCount.classList.remove('text-red-600', 'text-gray-500');
    } else {
      charCount.classList.add('text-gray-500');
      charCount.classList.remove('text-amber-600', 'text-red-600');
    }
    
    // Enable/disable next button based on input
    const nextButton = document.getElementById('goal-next-1');
    if (nextButton) {
      if (input.value.trim().length > 0) {
        nextButton.disabled = false;
      } else {
        nextButton.disabled = true;
      }
    }
  }
}

// Helper function to get gradient colors based on category color
function getGradientColors(color) {
  // If color is already a hex color, generate lighter and darker versions
  if (color && color.startsWith('#')) {
    // Convert hex to RGB
    const hex = color.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    
    // Create lighter version (add 20 to each component, max 255)
    const lighter = `#${Math.min(255, r + 20).toString(16).padStart(2, '0')}${Math.min(255, g + 20).toString(16).padStart(2, '0')}${Math.min(255, b + 20).toString(16).padStart(2, '0')}`;
    
    // Create darker version (subtract 20 from each component, min 0)
    const darker = `#${Math.max(0, r - 20).toString(16).padStart(2, '0')}${Math.max(0, g - 20).toString(16).padStart(2, '0')}${Math.max(0, b - 20).toString(16).padStart(2, '0')}`;
    
    return [lighter, darker];
  }
  
  // Fallback for old color names
  const colorMap = {
    'blue': ['#5CA0F9', '#2A68EC'],
    'green': ['#4CD280', '#25A653'],
    'purple': ['#A78BFA', '#8B5CF6'],
    'red': ['#F87171', '#DC2626'],
    'amber': ['#FBBF24', '#D97706'],
    'indigo': ['#818CF8', '#6366F1'],
    'pink': ['#F9A8D4', '#EC4899'],
    'teal': ['#5EEAD4', '#14B8A6']
  };
  
  return colorMap[color] || ['#5CA0F9', '#2A68EC']; // Default to blue if color not found
}

// Helper function to get progress color
function getProgressColor(color) {
  // If color is already a hex color, return it directly
  if (color && color.startsWith('#')) {
    return color;
  }
  
  // Fallback for old color names
  const colorMap = {
    'blue': '#2D6BED',
    'green': '#10B981',
    'purple': '#8B5CF6',
    'red': '#EF4444',
    'amber': '#F59E0B',
    'indigo': '#6366F1',
    'pink': '#EC4899',
    'teal': '#14B8A6'
  };
  
  return colorMap[color] || '#2D6BED'; // Default to blue if color not found
}

// Helper function to get button gradient colors
function getButtonGradient(color) {
  // If color is already a hex color, use the same logic as getGradientColors
  if (color && color.startsWith('#')) {
    return getGradientColors(color);
  }
  
  // Fallback for old color names
  const colorMap = {
    'blue': ['#3170EE', '#386BD0'],
    'green': ['#10B981', '#059669'],
    'purple': ['#8B5CF6', '#7C3AED'],
    'red': ['#EF4444', '#DC2626'],
    'amber': ['#F59E0B', '#D97706'],
    'indigo': ['#6366F1', '#4F46E5'],
    'pink': ['#EC4899', '#DB2777'],
    'teal': ['#14B8A6', '#0D9488']
  };
  
  return colorMap[color] || ['#3170EE', '#386BD0']; // Default to blue if color not found
}

// Helper to set up event listeners for goal buttons
function setupGoalButtonListeners() {
  // Update goal buttons
  document.querySelectorAll('.update-goal-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const goalId = parseInt(btn.getAttribute('data-goal-id'));
      const goal = momentumState.goals.find(g => g.id === goalId);
      
      if (goal) {
        // Create and show the update modal
        showUpdateGoalModal(goal);
      }
    });
  });
  
  // Completed Today buttons
  document.querySelectorAll('.goal-card').forEach(card => {
    // Get the Completed Today button
    const completeBtn = card.querySelector('.completed-today-btn');
    if (completeBtn) {
      completeBtn.addEventListener('click', function() {
        const goalId = parseInt(card.getAttribute('data-goal-id'));
        const goal = momentumState.goals.find(g => g.id === goalId);
        
        if (goal) {
          // Add a check-in for today
          const today = new Date().toISOString().slice(0, 10);
          goal.checkIns.push({
            date: today,
            completed: true,
            notes: 'Marked as completed'
          });
          
          // Update goal progress
          updateGoalProgress(goal);
          
          // Update completion rates
          updateCompletionRates();
          
          // Re-render goals grid
          document.getElementById('goals-progress-grid').innerHTML = renderGoalCards(
            document.getElementById('momentum-filter').value === 'all' 
              ? momentumState.goals 
              : momentumState.goals.filter(g => g.category === document.getElementById('momentum-filter').value)
          );
          
          // Re-attach event listeners
          setupGoalButtonListeners();
        }
      });
    }
  });
}

// Helper functions for calculating progress
function calculateWeeklyProgress(goal) {
  const today = new Date();
  const startOfWeek = new Date(today);
  startOfWeek.setDate(today.getDate() - today.getDay()); // Sunday as start of week
  
  return goal.checkIns.filter(checkIn => {
    const checkInDate = new Date(checkIn.date);
    return checkInDate >= startOfWeek && checkIn.completed;
  }).length;
}

function calculateMonthlyProgress(goal) {
  const today = new Date();
  const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  
  return goal.checkIns.filter(checkIn => {
    const checkInDate = new Date(checkIn.date);
    return checkInDate >= startOfMonth && checkIn.completed;
  }).length;
}

// Update goal progress based on frequency
function updateGoalProgress(goal) {
  switch(goal.frequency) {
    case 'daily':
      // Calculate percentage of days completed
      const totalDays = goal.checkIns.length;
      const completedDays = goal.checkIns.filter(c => c.completed).length;
      goal.progress = Math.round((completedDays / totalDays) * 100);
      break;
    case 'weekly':
      // Calculate percentage of weekly target achieved
      const weeklyProgress = calculateWeeklyProgress(goal);
      goal.progress = Math.min(100, Math.round((weeklyProgress / (goal.weeklyTarget || 3)) * 100));
      break;
    case 'monthly':
      // Calculate percentage of monthly target achieved
      const monthlyProgress = calculateMonthlyProgress(goal);
      goal.progress = Math.min(100, Math.round((monthlyProgress / (goal.monthlyTarget || 5)) * 100));
      break;
    case 'custom':
      // For custom dates, progress is percentage of completed dates
      if (goal.customDates && goal.customDates.length > 0) {
        const completedCustomDates = goal.customDates.filter(d => 
          goal.checkIns.some(c => c.date === d && c.completed)
        ).length;
        goal.progress = Math.round((completedCustomDates / goal.customDates.length) * 100);
      }
      break;
  }
}

// Function to update all completion rates in the UI
function updateCompletionRates() {
  // Calculate new average completion rate using the new method
  const avgCompletionRate = calculateAvgCompletionRateNew();
  
  // Update the average completion percentage text
  const avgCompletionElement = document.querySelector('.bg-transparent .absolute.inset-0.flex.items-center.justify-center');
  if (avgCompletionElement) {
    avgCompletionElement.textContent = `${avgCompletionRate}%`;
  }
  
  // Update the average completion circle
  const avgCompletionPath = document.querySelector('.bg-transparent .circle-progress path[stroke="url(#blueGradient)"]');
  if (avgCompletionPath) {
    avgCompletionPath.setAttribute('stroke-dasharray', `${avgCompletionRate}, 100`);
  }
  
  // Update each category's completion rate
  document.querySelectorAll('.category-card').forEach(card => {
    // Find the category name
    const categoryNameElement = card.querySelector('h3.font-bold.text-white.text-lg');
    if (!categoryNameElement) return;
    
    // Find the matching category in our state
    const category = momentumState.categories.find(c => c.name === categoryNameElement.textContent);
    if (!category) return;
    
    // Calculate the new completion rate for this category using the new method
    const categoryCompletionRate = calculateCategoryCompletionRateNew(category.id);
    
    // Update the category completion percentage text
    const percentageElement = card.querySelector('.font-bold.text-3xl.text-white');
    if (percentageElement) {
      percentageElement.textContent = `${categoryCompletionRate}%`;
    }
    
    // Update the category progress circle
    const progressPath = card.querySelector('.progress-circle-path');
    if (progressPath) {
      progressPath.setAttribute('stroke-dasharray', `${categoryCompletionRate}, 100`);
    }
    
    // Update the progress status text
    const statusElement = card.querySelector('.flex.items-center.gap-1.bg-white\\/20 .text-sm.font-medium.text-white');
    if (statusElement) {
      let newStatus = 'Needs Focus';
      if (categoryCompletionRate > 75) {
        newStatus = 'Excellent';
      } else if (categoryCompletionRate > 50) {
        newStatus = 'Good';
      } else if (categoryCompletionRate > 25) {
        newStatus = 'In Progress';
      }
      statusElement.textContent = newStatus;
    }
    
    // Update the status icon
    const iconElement = card.querySelector('.material-icons-outlined.text-sm.text-white');
    if (iconElement) {
      let newIcon = 'priority_high';
      if (categoryCompletionRate > 75) {
        newIcon = 'emoji_events';
      } else if (categoryCompletionRate > 50) {
        newIcon = 'trending_up';
      } else if (categoryCompletionRate > 25) {
        newIcon = 'trending_flat';
      }
      iconElement.textContent = newIcon;
    }
  });
}

// Calculate average completion rate across all habits using new method
function calculateAvgCompletionRateNew() {
  if (!momentumState.goals || momentumState.goals.length === 0) return 0;
  
  const totalRate = momentumState.goals.reduce((sum, goal) => {
    return sum + calculateCompletionRate(goal);
  }, 0);
  
  return Math.round(totalRate / momentumState.goals.length);
}

// Calculate completion rate for a specific category using new method
function calculateCategoryCompletionRateNew(categoryId) {
  const categoryGoals = momentumState.goals.filter(g => g.category === categoryId);
  if (categoryGoals.length === 0) return 0;
  
  const totalRate = categoryGoals.reduce((sum, goal) => {
    return sum + calculateCompletionRate(goal);
  }, 0);
  
  return Math.round(totalRate / categoryGoals.length);
}

// Function to show the comprehensive habit update modal
function showUpdateGoalModal(goal) {
  // Check if modal already exists
  let updateModal = document.getElementById('update-goal-modal');
  
  if (!updateModal) {
    // Create modal if it doesn't exist
    updateModal = document.createElement('div');
    updateModal.id = 'update-goal-modal';
    updateModal.className = 'fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 flex items-center justify-center';
    
    document.body.appendChild(updateModal);
  }
  
  // Get category information
  const category = momentumState.categories.find(c => c.id === goal.category);
  const completionRate = calculateCompletionRate(goal);
  const today = new Date().toISOString().split('T')[0];
  
  updateModal.innerHTML = `
    <div class="relative overflow-hidden rounded-[35px] p-8 w-full max-w-2xl mx-4 shadow-2xl bg-white border border-gray-200">
      
      <!-- Header -->
      <div class="flex justify-between items-center mb-5 p-4 rounded-2xl shadow-lg" 
           style="background: ${category.color};">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-full flex items-center justify-center text-white bg-white/20">
            <span class="material-icons text-sm">${category.icon}</span>
        </div>
          <div>
            <h3 class="text-lg md:text-lg text-white" style="font-weight: 300; font-family: \'Inter\', sans-serif;">${goal.title}</h3>
            <div class="flex items-center gap-2 mt-0.5">
              <span class="px-2 py-0.5 rounded-full text-white" style="font-size: 10px; background: rgba(255,255,255,0.2);">${category.name}</span>
              </button>
        </div>
        </div>
        </div>
        <button id="close-update-modal" class="text-white hover:text-gray-200 bg-white/20 p-2 rounded-full transition-all hover:bg-white/30">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
      </div>
      
      <!-- Action Buttons -->
      <div id="action-buttons-section" class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-5">
        <!-- Complete Today Button -->
        <button id="complete-today-btn" class="flex flex-col items-center justify-center p-2 md:p-3 rounded-xl text-white shadow-lg hover:shadow-xl transition-all duration-200 group"
                style="background: #10b981; font-family: 'Inter', sans-serif;">
          <div class="w-5 h-5 md:w-6 md:h-6 flex items-center justify-center mb-1 group-hover:scale-110 transition-transform">
            <img src="https://img.icons8.com/?size=100&id=3NdzgFsefaFS&format=png&color=FFFFFF" 
                 alt="Complete" class="w-full h-full"/>
        </div>
          <h4 class="text-xs font-light">Completed Today</h4>
          <p class="text-xs opacity-80 text-center leading-tight hidden md:block">Mark as complete</p>
        
        <!-- Update Progress Button -->
        <button id="update-progress-btn" class="flex flex-col items-center justify-center p-2 md:p-3 rounded-xl text-white shadow-lg hover:shadow-xl transition-all duration-200 group"
                style="background: #0ea5e9; font-family: 'Inter', sans-serif;">
          <div class="w-5 h-5 md:w-6 md:h-6 flex items-center justify-center mb-1 group-hover:scale-110 transition-transform">
            <img src="https://img.icons8.com/?size=100&id=11680&format=png&color=FFFFFF" 
                 alt="Update" class="w-full h-full"/>
        </div>
          <h4 class="text-xs font-light">Update Progress</h4>
          <p class="text-xs opacity-80 text-center leading-tight hidden md:block">Mark past dates</p>
        
        <!-- Delete Habit Button -->
        <button id="delete-habit-btn" class="flex flex-col items-center justify-center p-2 md:p-3 rounded-xl text-white shadow-lg hover:shadow-xl transition-all duration-200 group"
                style="background: #ef4444; font-family: 'Inter', sans-serif;">
          <div class="w-5 h-5 md:w-6 md:h-6 flex items-center justify-center mb-1 group-hover:scale-110 transition-transform">
            <img src="https://img.icons8.com/?size=100&id=R0peoyLmehLl&format=png&color=FFFFFF" 
                 alt="Delete" class="w-full h-full"/>
        </div>
          <h4 class="text-xs font-light">Delete Habit</h4>
          <p class="text-xs opacity-80 text-center leading-tight hidden md:block">Remove permanently</p>
      </div>
      
      <!-- Progress Overview -->
      <div id="progress-overview" class="p-4 rounded-2xl bg-white border border-gray-200 shadow-lg mb-5">
        <h4 class="text-xs font-light text-gray-700 mb-3">Progress Overview</h4>
        <div class="grid grid-cols-2 gap-3">
          <div class="text-center">
            <div class="text-lg font-semibold" style="color: ${category.color};">${completionRate}%</div>
            <div class="text-xs text-gray-500">Overall Rate</div>
        </div>
          <div class="text-center">
            <div class="text-lg font-semibold text-gray-700">${getExpectedCount(goal)}</div>
            <div class="text-xs text-gray-500">Expected</div>
        </div>
        </div>
      </div>
      
      <!-- Progress List Section (Initially Hidden) -->
      <div id="progress-calendar-section" class="hidden p-4 rounded-2xl bg-white border border-gray-200 shadow-lg mb-5">
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-xs font-light text-gray-700">Update Progress</h4>
          <div class="flex gap-2">
            <button id="done-btn" class="px-3 py-1.5 rounded-lg text-white text-xs font-light shadow-lg hover:shadow-xl transition-all"
                    style="background: ${category.color};">
              <span class="material-icons text-xs mr-1">check</span>
              Done
            <button id="mark-all-btn" class="px-3 py-1.5 rounded-lg bg-gray-500 text-white text-xs font-light shadow-lg hover:shadow-xl transition-all">
              <span class="material-icons text-xs mr-1">done_all</span>
              Mark All
            <button id="back-to-overview-btn" class="px-3 py-1.5 rounded-lg bg-gray-400 text-white text-xs font-light shadow-lg hover:shadow-xl transition-all">
              <span class="material-icons text-xs mr-1">arrow_back</span>
        </div>
        </div>
        <div id="progress-dates-list" class="max-h-64 overflow-y-auto space-y-2">
          <!-- Date list will be generated here -->
        </div>
      </div>
      
      <!-- Delete Confirmation Section (Initially Hidden) -->
      <div id="delete-confirmation-section" class="hidden p-6 rounded-3xl backdrop-blur-md border border-red-300 shadow-lg mb-6" 
           style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));">
        <h4 class="text-lg font-bold text-red-800 mb-2">Delete Habit</h4>
        <p class="text-gray-700 mb-4">Are you sure you want to delete "${goal.title}"? This action cannot be undone and all progress data will be lost.</p>
        <div class="flex gap-3">
          <button id="cancel-delete-btn" class="px-4 py-2 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
            Cancel
          <button id="confirm-delete-btn" class="px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600 transition-colors">
            Yes, Delete
        </div>
      </div>
    </div>
  `;
  
  // Show the modal
  updateModal.classList.remove('hidden');
  
  // Set up event listeners
  document.getElementById('close-update-modal').addEventListener('click', function() {
    updateModal.classList.add('hidden');
  });
  
  // Complete Today Button
  document.getElementById('complete-today-btn').addEventListener('click', function() {
    markHabitCompleteToday(goal);
    updateModal.classList.add('hidden');
    refreshAllViews();
  });
  
  // Update Progress Button
  document.getElementById('update-progress-btn').addEventListener('click', function() {
    showProgressDateList(goal);
  });
  
  // Delete Habit Button
  document.getElementById('delete-habit-btn').addEventListener('click', function() {
    showDeleteConfirmation();
  });
  
  // Delete confirmation handlers
  const showDeleteConfirmation = () => {
    document.getElementById('progress-overview').style.display = 'none';
    document.getElementById('delete-confirmation-section').classList.remove('hidden');
  };
  
  document.getElementById('cancel-delete-btn').addEventListener('click', function() {
    document.getElementById('delete-confirmation-section').classList.add('hidden');
    document.getElementById('progress-overview').style.display = 'block';
  });
  
  document.getElementById('confirm-delete-btn').addEventListener('click', function() {
    deleteHabit(goal.id);
    updateModal.classList.add('hidden');
    refreshAllViews();
  });
  
  // Progress date list handlers
  const showProgressDateList = (goal) => {
    document.getElementById('progress-overview').style.display = 'none';
    // Hide action buttons when showing update progress
    const actionButtons = document.getElementById('action-buttons-section');
    if (actionButtons) {
      actionButtons.style.display = 'none';
    }
    document.getElementById('progress-calendar-section').classList.remove('hidden');
    generateProgressDateList(goal);
  };
  
  // Back to overview button
  document.getElementById('back-to-overview-btn').addEventListener('click', function() {
    document.getElementById('progress-calendar-section').classList.add('hidden');
    document.getElementById('progress-overview').style.display = 'block';
    // Show action buttons again when going back to overview
    const actionButtons = document.getElementById('action-buttons-section');
    if (actionButtons) {
      actionButtons.style.display = 'grid';
    }
  });
  
  // Done button - save all marked dates
  document.getElementById('done-btn').addEventListener('click', function() {
    // Get all checked checkboxes
    const checkedBoxes = document.querySelectorAll('.date-checkbox:checked');
    checkedBoxes.forEach(checkbox => {
      const date = checkbox.dataset.date;
      markHabitCompleteForDate(goal, date);
    });
    
    // Hide the progress calendar section
    document.getElementById('progress-calendar-section').classList.add('hidden');
    document.getElementById('progress-overview').style.display = 'block';
    
    // Show action buttons again
    const actionButtons = document.getElementById('action-buttons-section');
    if (actionButtons) {
      actionButtons.style.display = 'grid';
    }
    
    // Update the UI
    refreshAllViews();
  });
  
  // Mark Selected button
  document.getElementById('mark-selected-btn').addEventListener('click', function() {
    markSelectedDatesComplete(goal);
  });
  
  // Mark All button
  document.getElementById('mark-all-btn').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('.date-checkbox:not(:checked):not([disabled])');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    updateMarkSelectedButton();
  });
}

// Helper functions for habit management

// Calculate overall completion rate for a habit
function calculateCompletionRate(goal) {
  if (!goal.completions || goal.completions.length === 0) return 0;
  
  const dateCreated = new Date(goal.dateCreated);
  const today = new Date();
  const daysDiff = Math.ceil((today - dateCreated) / (1000 * 60 * 60 * 24)) + 1;
  
  let expectedCompletions = 0;
  
  switch(goal.frequency) {
    case 'daily':
      expectedCompletions = daysDiff;
      break;
    case 'weekly':
      const weeksDiff = Math.ceil(daysDiff / 7);
      expectedCompletions = weeksDiff * (goal.weeklyTarget || 3);
      break;
    case 'monthly':
      const monthsDiff = Math.ceil(daysDiff / 30);
      expectedCompletions = monthsDiff * (goal.monthlyTarget || 5);
      break;
    default:
      expectedCompletions = daysDiff;
  }
  
  const actualCompletions = goal.completions.filter(c => c.completed).length;
  return Math.min(100, Math.round((actualCompletions / expectedCompletions) * 100));
}

// Get total completed count
function getCompletedCount(goal) {
  if (!goal.completions) return 0;
  return goal.completions.filter(c => c.completed).length;
}

// Get expected completion count
function getExpectedCount(goal) {
  const dateCreated = new Date(goal.dateCreated);
  const today = new Date();
  const daysDiff = Math.ceil((today - dateCreated) / (1000 * 60 * 60 * 24)) + 1;
  
  switch(goal.frequency) {
    case 'daily':
      return daysDiff;
    case 'weekly':
      const weeksDiff = Math.ceil(daysDiff / 7);
      return weeksDiff * (goal.weeklyTarget || 3);
    case 'monthly':
      const monthsDiff = Math.ceil(daysDiff / 30);
      return monthsDiff * (goal.monthlyTarget || 5);
    default:
      return daysDiff;
  }
}

// Get current streak
function getCurrentStreak(goal) {
  if (!goal.completions || goal.completions.length === 0) return 0;
  
  const sortedCompletions = goal.completions
    .filter(c => c.completed)
    .sort((a, b) => new Date(b.date) - new Date(a.date));
  
  if (sortedCompletions.length === 0) return 0;
  
  let streak = 0;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  for (let i = 0; i < sortedCompletions.length; i++) {
    const completionDate = new Date(sortedCompletions[i].date);
    completionDate.setHours(0, 0, 0, 0);
    
    const expectedDate = new Date(today);
    expectedDate.setDate(today.getDate() - streak);
    
    if (completionDate.getTime() === expectedDate.getTime()) {
      streak++;
    } else {
      break;
    }
  }
  
  return streak;
}

// Mark habit as complete for today
function markHabitCompleteToday(goal) {
  const today = new Date().toISOString().split('T')[0];
  
  if (!goal.completions) {
    goal.completions = [];
  }
  
  const existingCompletion = goal.completions.find(c => c.date === today);
  
  if (existingCompletion) {
    existingCompletion.completed = true;
  } else {
    goal.completions.push({
      date: today,
      completed: true
    });
  }
}

// Delete a habit
function deleteHabit(goalId) {
  const index = momentumState.goals.findIndex(g => g.id === goalId);
  if (index > -1) {
    momentumState.goals.splice(index, 1);
  }
}

// Generate progress calendar for the Update Progress section
function generateProgressCalendar(goal) {
  const today = new Date();
  const dateCreated = new Date(goal.dateCreated);
  const calendarContainer = document.getElementById('progress-calendar-content');
  const category = momentumState.categories.find(c => c.id === goal.category);
  
  if (!calendarContainer) return;
  
  let html = '<div class="space-y-3">';
  
  // Generate days from creation date to today
  const currentDate = new Date(dateCreated);
  const days = [];
  
  while (currentDate <= today) {
    const dateString = currentDate.toISOString().split('T')[0];
    const existingCompletion = goal.completions.find(c => c.date === dateString);
    const isCompleted = existingCompletion ? existingCompletion.completed : false;
    
    days.push({
      date: dateString,
      completed: isCompleted,
      dayName: currentDate.toLocaleDateString('en-US', { weekday: 'short' }),
      dayNumber: currentDate.getDate(),
      monthName: currentDate.toLocaleDateString('en-US', { month: 'short' })
    });
    
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  // Group days by week for better layout
  for (let i = 0; i < days.length; i += 7) {
    const weekDays = days.slice(i, i + 7);
    html += '<div class="grid grid-cols-7 gap-2 mb-2">';
    
    weekDays.forEach(day => {
      const isToday = day.date === today.toISOString().split('T')[0];
      html += `
        <div class="text-center">
          <div class="text-xs text-gray-500 mb-1">${day.dayName}</div>
          <button class="habit-day-btn w-10 h-10 rounded-full border transition-all ${
            day.completed 
              ? 'text-white border-transparent' 
              : 'text-gray-600 border-gray-300 hover:border-gray-400'
          } ${isToday ? 'ring-2 ring-blue-400' : ''}"
                  style="${day.completed ? `background: ${category.color};` : 'background: white;'}"
                  data-date="${day.date}"
                  onclick="toggleDayCompletion('${goal.id}', '${day.date}')">
            <div class="text-xs font-medium">${day.dayNumber}</div>
        </div>
      `;
    });
    
    html += '</div>';
  }
  
  html += '</div>';
  calendarContainer.innerHTML = html;
}

// Toggle day completion
function toggleDayCompletion(goalId, date) {
  const goal = momentumState.goals.find(g => g.id === goalId);
  if (!goal) return;
  
  if (!goal.completions) {
    goal.completions = [];
  }
  
  const existingCompletion = goal.completions.find(c => c.date === date);
  
  if (existingCompletion) {
    existingCompletion.completed = !existingCompletion.completed;
  } else {
    goal.completions.push({
      date: date,
      completed: true
    });
  }
  
  // Refresh the calendar and overview
  generateProgressCalendar(goal);
  updateProgressOverview(goal);
}

// Mark all expected days as complete
function markAllDaysComplete(goal) {
  const today = new Date();
  const dateCreated = new Date(goal.dateCreated);
  
  if (!goal.completions) {
    goal.completions = [];
  }
  
  const currentDate = new Date(dateCreated);
  while (currentDate <= today) {
    const dateString = currentDate.toISOString().split('T')[0];
    const existingCompletion = goal.completions.find(c => c.date === dateString);
    
    if (existingCompletion) {
      existingCompletion.completed = true;
    } else {
      goal.completions.push({
        date: dateString,
        completed: true
      });
    }
    
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  // Refresh the calendar and overview
  generateProgressCalendar(goal);
  updateProgressOverview(goal);
}

// Update progress overview in modal
function updateProgressOverview(goal) {
  const completionRate = calculateCompletionRate(goal);
  const expectedCount = getExpectedCount(goal);
  
  const overview = document.getElementById('progress-overview');
  if (overview) {
    const stats = overview.querySelectorAll('.text-xl');
    if (stats.length >= 2) {
      stats[0].textContent = `${completionRate}%`;
      stats[1].textContent = expectedCount;
    }
  }
}

// Generate list of expected dates for progress updating
function generateProgressDateList(goal) {
  const container = document.getElementById('progress-dates-list');
  if (!container) return;
  
  const expectedDates = getExpectedDatesForGoal(goal);
  const today = new Date().toISOString().split('T')[0];
  
  container.innerHTML = expectedDates.map(dateStr => {
    const completion = goal.completions?.find(c => c.date === dateStr);
    const isCompleted = completion?.completed || false;
    const isPast = dateStr <= today;
    const date = new Date(dateStr);
    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    
    return `
      <label class="flex items-center justify-between p-3 rounded-xl bg-white/40 backdrop-blur-md border border-white/50 hover:bg-white/50 transition-all cursor-pointer ${!isPast ? 'opacity-50' : ''}">
        <div class="flex items-center gap-3">
          <input type="checkbox" 
                 class="date-checkbox w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-2" 
                 data-date="${dateStr}" 
                 ${isCompleted ? 'checked' : ''} 
                 ${!isPast ? 'disabled' : ''}>
          <div class="flex flex-col">
            <span class="text-sm font-medium text-gray-800">${formattedDate}</span>
            <span class="text-xs text-gray-600">${dayName}</span>
        </div>
        </div>
        <div class="flex items-center gap-2">
          ${isCompleted ? 
            '<span class="text-green-600 text-xs font-medium flex items-center gap-1"><span class="material-icons text-xs">check_circle</span>Completed</span>' : 
            (isPast ? '<span class="text-gray-500 text-xs">Not completed</span>' : '<span class="text-gray-400 text-xs">Future date</span>')
          }
        </div>
      </label>
    `;
  }).join('');
  
  // Add event listeners for checkboxes
  const checkboxes = container.querySelectorAll('.date-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateMarkSelectedButton();
    });
  });
  
  updateMarkSelectedButton();
}

// Get expected dates for a goal based on its frequency
function getExpectedDatesForGoal(goal) {
  const dates = [];
  const startDate = new Date(goal.dateCreated);
  const today = new Date();
  
  // Add a few future dates for planning
  const endDate = new Date(today);
  endDate.setDate(today.getDate() + 7);
  
  let currentDate = new Date(startDate);
  
  switch (goal.frequency) {
    case 'daily':
      while (currentDate <= endDate) {
        dates.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + 1);
      }
      break;
      
    case 'weekly':
      // For weekly habits, show all days but focus on target days
      while (currentDate <= endDate) {
        dates.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + 1);
      }
      break;
      
    case 'monthly':
      // For monthly habits, show monthly intervals
      while (currentDate <= endDate) {
        dates.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + 7); // Weekly intervals for monthly habits
      }
      break;
      
    default:
      // Default to daily
      while (currentDate <= endDate) {
        dates.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + 1);
      }
  }
  
  return dates.sort().reverse(); // Most recent first
}

// Update the Mark Selected button state
function updateMarkSelectedButton() {
  const button = document.getElementById('mark-selected-btn');
  const checkboxes = document.querySelectorAll('.date-checkbox:not([disabled])');
  const uncheckedBoxes = Array.from(checkboxes).filter(cb => !cb.checked);
  
  if (uncheckedBoxes.length > 0) {
    button.disabled = false;
    button.innerHTML = '<span class="material-icons text-xs mr-1">done</span>Mark Selected (' + uncheckedBoxes.length + ')';
  } else {
    button.disabled = true;
    button.innerHTML = '<span class="material-icons text-xs mr-1">done</span>All Completed';
  }
}

// Mark selected dates as complete
function markSelectedDatesComplete(goal) {
  const checkboxes = document.querySelectorAll('.date-checkbox:not(:checked):not([disabled])');
  
  checkboxes.forEach(checkbox => {
    const date = checkbox.dataset.date;
    markHabitCompleteForDate(goal, date);
    checkbox.checked = true;
  });
  
  updateMarkSelectedButton();
  refreshAllViews();
}

// Mark habit complete for specific date
function markHabitCompleteForDate(goal, date) {
  if (!goal.completions) {
    goal.completions = [];
  }
  
  const existingCompletion = goal.completions.find(c => c.date === date);
  
  if (existingCompletion) {
    existingCompletion.completed = true;
  } else {
    goal.completions.push({
      date: date,
      completed: true
    });
  }
}

// Refresh all views after changes
function refreshAllViews() {
  // Re-render goals if we have a goals grid
  const goalsGrid = document.getElementById('goals-progress-grid');
  if (goalsGrid) {
    goalsGrid.innerHTML = renderGoalCards();
    
    // Re-attach event listeners
    if (typeof setupGoalButtonListeners === 'function') {
      setupGoalButtonListeners();
    }
  }
  
  // Re-render the calendar views if we're in calendar mode
  if (calendarState && typeof renderCurrentView === 'function') {
    renderCurrentView();
  }
  
  // Update completion rates section
  if (typeof updateCompletionRates === 'function') {
    updateCompletionRates();
  }
}

// Step navigation functions for goal creation
function goToStep1() {
  // Get all the steps with the correct IDs
  const step1 = document.getElementById('goal-step-1');
  const step2 = document.getElementById('goal-step-2');
  const step3 = document.getElementById('goal-step-3');
  const step4 = document.getElementById('goal-step-4');
  const frequencyDetailStep = document.getElementById('goal-step-frequency-detail');
  
  // Reset form fields
  const goalTitle = document.getElementById('goal-title');
  if (goalTitle) {
    goalTitle.value = '';
    updateGoalCharCount(goalTitle);
  }
  
  // Hide all steps and reset form
  document.querySelectorAll('.goal-step').forEach(step => {
    step.classList.add('hidden');
  });
  
  // Clear any frequency detail step content
  if (frequencyDetailStep) {
    frequencyDetailStep.classList.add('hidden');
  }
  
  // Show step 1
  if (step1) {
    step1.classList.remove('hidden');
    step1.classList.add('active');
  }
  
  // Reset other form fields
  document.getElementById('goal-category').value = '';
  document.getElementById('goal-priority').value = '';
  document.getElementById('goal-frequency').value = '';
  
  if (document.getElementById('goal-notes')) {
    document.getElementById('goal-notes').value = '';
  }
  
  // Reset the next button disabled state
  const nextButton = document.getElementById('goal-next-1');
  if (nextButton) {
    nextButton.disabled = true;
  }
}

window.goToGoalStep2 = function() {
  const step1 = document.getElementById('goal-step-1');
  const step2 = document.getElementById('goal-step-2');
  
  if (step1 && step2) {
    step1.classList.add('hidden');
    step1.classList.remove('active');
    step2.classList.remove('hidden');
    
    // Set goal name in the display
    const goalTitle = document.getElementById('goal-title').value;
    const goalNameDisplay = document.getElementById('goal-name-display');
    if (goalNameDisplay) {
      goalNameDisplay.textContent = goalTitle;
    }
  }
}

// Helper function to select category with button interface
function selectCategory(button) {
  // Remove active state from all category buttons
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.classList.remove('ring-2', 'ring-offset-2');
    const catColor = btn.dataset.categoryId.split('-')[0];
    btn.classList.remove('bg-' + catColor + '-50');
  });
  
  // Add active state to the selected button
  const categoryId = button.dataset.categoryId;
  const catColor = categoryId.split('-')[0];
  button.classList.add('ring-2', 'ring-offset-2', 'ring-' + catColor + '-400');
  button.classList.add('bg-' + catColor + '-50');
  
  // Set the hidden input value
  document.getElementById('goal-category').value = categoryId;
}

// Helper function to select priority with button interface
function selectPriority(button) {
  // Remove active state from all priority buttons
  document.querySelectorAll('.priority-btn').forEach(btn => {
    btn.classList.remove('ring-2', 'ring-offset-2');
    const prioColor = btn.dataset.priorityId.split('-')[0];
    btn.classList.remove('bg-' + prioColor + '-50');
  });
  
  // Add active state to the selected button
  const priorityId = button.dataset.priorityId;
  const prioColor = priorityId.split('-')[0];
  button.classList.add('ring-2', 'ring-offset-2', 'ring-' + prioColor + '-400');
  button.classList.add('bg-' + prioColor + '-50');
  
  // Set the hidden input value
  document.getElementById('goal-priority').value = priorityId;
}

// Helper function to select frequency with button interface
function selectFrequency(button) {
  // Get the frequency ID from the button data attribute
  const frequencyId = button.dataset.frequencyId;
  
  // Reset all frequency buttons
  document.querySelectorAll('.frequency-btn').forEach(btn => {
    // Reset the background
    btn.classList.remove('bg-white/40');
    btn.classList.add('bg-white/20');
    
    // Reset the icon color
    const icon = btn.querySelector('.frequency-icon');
    if (icon) {
      icon.classList.remove('text-blue-800');
      icon.classList.add('text-white');
    }
    
    // Reset the text color
    const title = btn.querySelector('.frequency-title');
    const desc = btn.querySelector('.frequency-desc');
    if (title) {
      title.classList.remove('text-blue-800');
      title.classList.add('text-white');
    }
    if (desc) {
      desc.classList.remove('text-blue-800');
      desc.classList.add('text-white');
    }
  });
  
  // Highlight the selected button
  button.classList.remove('bg-white/20');
  button.classList.add('bg-white/40');
  
  // Change icon and text to dark blue
  const icon = button.querySelector('.frequency-icon');
  if (icon) {
    icon.classList.remove('text-white');
    icon.classList.add('text-blue-800');
  }
  
  // Change text to dark blue
  const title = button.querySelector('.frequency-title');
  const desc = button.querySelector('.frequency-desc');
  if (title) {
    title.classList.remove('text-white');
    title.classList.add('text-blue-800');
  }
  if (desc) {
    desc.classList.remove('text-white');
    desc.classList.add('text-blue-800');
  }
  
  // Set the hidden input value
  document.getElementById('goal-frequency').value = frequencyId;
  
  // Show frequency details screen
  showFrequencyDetailScreen(frequencyId);
}

// Function to show the goal modal
function showGoalModal() {
  const goalModal = document.getElementById('add-goal-modal');
  if (goalModal) {
    goalModal.classList.remove('hidden');
    
    // Show step 1 by default
    goToGoalStep1();
    
    // Initialize character count for goal title
    const goalTitle = document.getElementById('goal-title');
    if (goalTitle) {
      goalTitle.value = ''; // Clear the input
      updateGoalCharCount(goalTitle); // Reset counter to 0
    }
    
    // Set default category and priority
    setTimeout(() => {
      const firstCategoryBtn = document.querySelector('.category-btn');
      if (firstCategoryBtn) selectCategory(firstCategoryBtn);
      
      const firstPriorityBtn = document.querySelector('.priority-btn');
      if (firstPriorityBtn) selectPriority(firstPriorityBtn);
      
      const firstFrequencyBtn = document.querySelector('.frequency-btn');
      if (firstFrequencyBtn) selectFrequency(firstFrequencyBtn);
    }, 100);

// Immediate setup as backup
(function() {
})();  }
}

// Function to hide the goal modal
function hideGoalModal() {
  const goalModal = document.getElementById('add-goal-modal');
  if (goalModal) {
    goalModal.classList.add('hidden');
  }
}



// Add document-level event listeners for the multi-step form
document.addEventListener('click', (e) => {
  if (e.target.matches('#add-goal-btn')) {
    showGoalModal();
  } else if (e.target.matches('#close-goal-modal') || e.target.matches('#cancel-goal-btn-1') || e.target.matches('#cancel-goal-btn-2')) {
    hideGoalModal();
  } else if (e.target.matches('#next-goal-step')) {
    goToGoalStep2();
  } else if (e.target.matches('#prev-goal-step')) {
    goToGoalStep1();
  } else if (e.target.closest('.category-btn')) {
    selectCategory(e.target.closest('.category-btn'));
  } else if (e.target.closest('.priority-btn')) {
    selectPriority(e.target.closest('.priority-btn'));
  } else if (e.target.closest('.frequency-btn')) {
    selectFrequency(e.target.closest('.frequency-btn'));
  } else if (e.target.matches('#create-goal-btn')) {
    // Create new goal
    const title = document.getElementById('goal-title').value;
    const category = document.getElementById('goal-category').value;
    const priority = document.getElementById('goal-priority').value;
    const deadline = document.getElementById('goal-deadline').value;
    const frequency = document.getElementById('goal-frequency').value;
    const notes = document.getElementById('goal-notes').value;
    
    if (!title) {
      alert('Please enter a goal title');
      goToGoalStep1();
      return;
    }
    
    // Create new goal
    const newGoal = {
      id: momentumState.goals.length + 1,
      title,
      category,
      deadline,
      priority,
      frequency,
      progress: 0,
      notes,
      checkIns: [],
      dateCreated: new Date().toISOString().split('T')[0]
    };
    
    // Add frequency-specific properties
    if (frequency === 'weekly') {
      const weeklyTarget = parseInt(document.getElementById('weekly-target')?.value) || 3;
      newGoal.weeklyTarget = weeklyTarget;
    } else if (frequency === 'monthly') {
      const monthlyTarget = parseInt(document.getElementById('monthly-target')?.value) || 5;
      newGoal.monthlyTarget = monthlyTarget;
    } else if (frequency === 'custom') {
      // For custom frequency, we could store specific dates
      newGoal.customDates = [];
    }
    
    // Add to goals array
    momentumState.goals.push(newGoal);
    
    // Update UI
    document.getElementById('goals-progress-grid').innerHTML = renderGoalCards();
    
    // Show success message
    showGoalSuccessMessage(newGoal.title);
    
    // Close modal after a short delay
    setTimeout(() => {
      hideGoalModal();
      
      // Re-attach event listeners
      setupGoalButtonListeners();
    }, 1500);
  }
  });



// Function to display a success message when a goal is created
function showGoalSuccessMessage(goalTitle) {
  // Get the form container
  const formContainer = document.getElementById('add-goal-form-container');
  if (!formContainer) return;
  
  // Hide all steps
  document.querySelectorAll('.goal-step').forEach(step => {
    step.classList.add('hidden');
    step.classList.remove('active');
  });
  
  // Create success message with just content elements, no background
  const successMessage = document.createElement('div');
  successMessage.className = 'goal-step flex flex-col items-center justify-center p-8 animate-fade-in';
  successMessage.id = 'goal-success-message';
  // No background applied - fully transparent
  
  // Add just the content elements
  successMessage.innerHTML = `
    <div class="w-24 h-24 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-white/30">
      <span class="material-icons-outlined text-white" style="font-size: 48px;">check</span>
    </div>
    <h3 class="text-3xl font-bold text-white mb-3" style="font-family: 'Helvetica Neue', Arial, sans-serif; font-weight: 500; letter-spacing: -0.5px;">Goal Added!</h3>
    <p class="text-white text-xl opacity-90 mb-8">"${goalTitle}" has been added to your goals.</p>
    <button type="button" id="add-another-goal" class="px-8 py-4 rounded-full bg-white text-blue-600 hover:bg-blue-700 hover:text-white transition-all shadow-lg hover:shadow-xl font-bold flex items-center mx-auto">
      <span class="material-icons-outlined mr-2">add_task</span> Add Another Goal
  `;
  
  // Add to form container
  formContainer.appendChild(successMessage);
  
  // Add click handler to the "Add Another Goal" button
  const addAnotherBtn = document.getElementById('add-another-goal');
  if (addAnotherBtn) {
    addAnotherBtn.addEventListener('click', function() {
      // Animate the success message out
      successMessage.style.opacity = '0';
      successMessage.style.transform = 'translateY(20px)';
      successMessage.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      
      setTimeout(() => {
        // Remove success message
        successMessage.remove();
        
        // Reset all form fields and states
        const goalTitle = document.getElementById('goal-title');
        if (goalTitle) {
          goalTitle.value = '';
          updateGoalCharCount(goalTitle);
        }
        
        // Reset hidden input values
        document.getElementById('goal-category').value = '';
        document.getElementById('goal-priority').value = '';
        document.getElementById('goal-frequency').value = '';
        
        if (document.getElementById('goal-notes')) {
          document.getElementById('goal-notes').value = '';
        }
        
        // Reset all button selections
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('bg-white/40', 'border-white/50', 'scale-105');
        });
        
        document.querySelectorAll('.priority-btn').forEach(btn => {
          btn.classList.remove('bg-white/40', 'border-white/50', 'scale-105');
        });
        
        document.querySelectorAll('.frequency-btn').forEach(btn => {
          btn.classList.remove('bg-white/40');
          btn.classList.add('bg-white/20');
          
          const icon = btn.querySelector('.frequency-icon');
          if (icon) {
            icon.classList.remove('text-blue-800');
            icon.classList.add('text-white');
          }
          
          const title = btn.querySelector('.frequency-title');
          const desc = btn.querySelector('.frequency-desc');
          if (title) {
            title.classList.remove('text-blue-800');
            title.classList.add('text-white');
          }
          if (desc) {
            desc.classList.remove('text-blue-800');
            desc.classList.add('text-white');
          }
        });
        
        // Hide all steps except step 1
        const goalStep1 = document.getElementById('goal-step-1');
        const goalStep2 = document.getElementById('goal-step-2');
        const goalStep3 = document.getElementById('goal-step-3');
        const goalStep4 = document.getElementById('goal-step-4');
        const frequencyDetailStep = document.getElementById('goal-step-frequency-detail');
        
        // Clear any frequency detail step content
        if (frequencyDetailStep) {
          frequencyDetailStep.innerHTML = '';
          frequencyDetailStep.classList.add('hidden');
        }
        
        // Hide all other steps
        if (goalStep2) goalStep2.classList.add('hidden');
        if (goalStep3) goalStep3.classList.add('hidden');
        if (goalStep4) goalStep4.classList.add('hidden');
        
        // Show step 1 with animation
        if (goalStep1) {
          goalStep1.classList.remove('hidden');
          goalStep1.classList.add('active');
          goalStep1.style.opacity = '0';
          goalStep1.style.transform = 'translateY(-20px)';
          
          // Force reflow
          void goalStep1.offsetWidth;
          
          goalStep1.style.opacity = '1';
          goalStep1.style.transform = 'translateY(0)';
          goalStep1.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        }
        
        // Reset the next button disabled state
        const nextButton = document.getElementById('goal-next-1');
        if (nextButton) {
          nextButton.disabled = true;
        }
      }, 300);
    });
  }
}


</script>

<style>


/* Animation classes */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.animate-fade-in {
  animation: fadeIn 0.5s ease-out forwards;
}

.animate-bounce {
  animation: bounce 1s ease-in-out infinite;
}

/* Custom select styling */
select#momentum-filter {
  /* Removed background arrow since we have a custom Material Icons arrow */
}

select#momentum-filter:focus {
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
}

/* Custom select option hover */
select#momentum-filter option:hover,
select#momentum-filter option:focus {
  background-color: #3b82f6;
  color: white;
}

/* SVG Circle Progress */
.circle-progress {
  transform: rotate(-90deg);
  transform-origin: 50% 50%;
}

/* Modern animations for category cards */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulseSlow {
  0%, 100% { 
    opacity: 1;
    transform: scale(1);
  }
  50% { 
    opacity: 0.9;
    transform: scale(1.05);
  }
}

@keyframes progressGrow {
  from {
    width: 0%;
  }
  to {
    width: var(--final-width);
  }
}

@keyframes bounceSubtle {
  0%, 100% { transform: translateY(0); }
  25% { transform: translateY(-2px); }
  75% { transform: translateY(2px); }
}

@keyframes liquidMove {
  0%, 100% {
    border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
    transform: translate(0, 0) rotate(0deg);
  }
  25% {
    border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%;
    transform: translate(-10px, 5px) rotate(-5deg);
  }
  50% {
    border-radius: 50% 50% 20% 80% / 25% 80% 20% 75%;
    transform: translate(5px, -10px) rotate(5deg);
  }
  75% {
    border-radius: 40% 60% 60% 40% / 70% 30% 50% 40%;
    transform: translate(10px, 5px) rotate(-2deg);
  }
}

.animate-fade-in-up {
  animation: fadeInUp 0.8s ease-out forwards;
}

.animate-pulse-slow {
  animation: pulseSlow 3s ease-in-out infinite;
}

.animate-liquid-slow {
  animation: liquidMove 15s ease-in-out infinite;
}

.progress-bar-animate {
  animation: progressGrow 1.5s ease-out forwards;
  --final-width: 0%;
}

.animate-bounce-subtle {
  animation: bounceSubtle 2s infinite;
}

/* Glassmorphism styles */
.glassmorphism-card {
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.18);
}

.category-card {
  border-radius: 28px !important;
}

.category-card * {
  color: white !important;
}

/* Hover effects for elements inside the average completion container */
.relative.z-10.transform:hover {
  filter: drop-shadow(0px 0px 4px rgba(59, 130, 246, 0.5));
}

/* Custom styled progress slider */
.progress-slider {
  cursor: pointer;
  opacity: 0;
}

.progress-slider:focus {
  outline: none;
}

.progress-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  border-radius: 50%;
  background: var(--thumb-color, #3B82F6);
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
  cursor: pointer;
  position: relative;
  z-index: 3;
  opacity: 1;
}

.progress-slider::-moz-range-thumb {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  background: var(--thumb-color, #3B82F6);
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
  cursor: pointer;
  position: relative;
  z-index: 3;
  border: none;
}

/* Animation for the progress bar fill */
@keyframes progressFill {
  from { width: 0; }
  to { width: var(--progress-width); }
}

.progress-bar-fill {
  transition: width 0.3s ease;
}

/* Hover effects */
.category-card:hover .progress-circle-path {
  stroke-width: 4px;
  transition: all 0.3s ease;
}

/* Scale factor for hover effects */
.transform.hover\:scale-102:hover {
  transform: scale(1.02);
}
</style>

<!-- Goal Calendar Script -->
<script>
// Initialize and handle the Goal Calendar functionality
function initializeGoalCalendar() {
  console.log('Initializing goal calendar');
  
  // Get calendar elements
  const viewMonthBtn = document.getElementById('view-month');
  const viewWeekBtn = document.getElementById('view-week');
  const viewDayBtn = document.getElementById('view-day');
  const prevPeriodBtn = document.getElementById('prev-period');
  const nextPeriodBtn = document.getElementById('next-period');
  const todayBtn = document.getElementById('today-btn');
  const calendarTitle = document.getElementById('calendar-title');
  const monthView = document.getElementById('month-view');
  const weekView = document.getElementById('week-view');
  const dayView = document.getElementById('day-view');
  const monthGrid = document.getElementById('month-grid');
  const weekHeader = document.getElementById('week-header');
  const weekGrid = document.getElementById('week-grid');
  const dayHeader = document.getElementById('day-header');
  const dayList = document.getElementById('day-list');
  
  // Debug element existence
  console.log('Calendar elements found:', {
    viewMonthBtn: !!viewMonthBtn,
    viewWeekBtn: !!viewWeekBtn,
    viewDayBtn: !!viewDayBtn,
    calendarTitle: !!calendarTitle,
    monthView: !!monthView,
    weekView: !!weekView,
    dayView: !!dayView
  });
  
  if (!viewMonthBtn) return; // Exit if calendar elements don't exist
  
  // Calendar state
  let calendarState = {
    currentDate: new Date(),
    currentView: 'month', // 'month', 'week', or 'day'
    selectedDate: new Date(),
    filteredCategories: [] // To store filtered category IDs
  };
  
  // Helper function to format date
  function formatDate(date) {
    const options = { month: 'long', year: 'numeric' };
    return date.toLocaleDateString('en-US', options);
  }
  
  // Helper function to format day
  function formatDay(date) {
    const options = { weekday: 'short', day: 'numeric', month: 'short' };
    return date.toLocaleDateString('en-US', options);
  }
  
  // Update calendar title based on current view and date
  function updateCalendarTitle() {
    switch(calendarState.currentView) {
      case 'month':
        calendarTitle.textContent = formatDate(calendarState.currentDate);
        break;
      case 'week':
        const weekStart = getWeekStartDate(calendarState.currentDate);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        // Handle month spanning weeks
        if (weekStart.getMonth() !== weekEnd.getMonth()) {
          calendarTitle.textContent = `${weekStart.getDate()} ${weekStart.toLocaleDateString('en-US', { month: 'short' })} - ${weekEnd.getDate()} ${weekEnd.toLocaleDateString('en-US', { month: 'short' })} ${weekStart.getFullYear()}`;
        } else {
          calendarTitle.textContent = `${weekStart.getDate()} - ${weekEnd.getDate()} ${weekStart.toLocaleDateString('en-US', { month: 'long' })} ${weekStart.getFullYear()}`;
        }
        
        // Get week number
        const weekNumber = Math.ceil((((weekStart - new Date(weekStart.getFullYear(), 0, 1)) / 86400000) + 1) / 7);
        
        // Add a small week number indicator
        const weekNumberEl = document.createElement('span');
        weekNumberEl.className = 'ml-2 px-1.5 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full';
        weekNumberEl.textContent = `Week ${weekNumber}`;
        
        // Clear any existing week number element
        const existingWeekNumber = calendarTitle.querySelector('span');
        if (existingWeekNumber) {
          existingWeekNumber.remove();
        }
        
        calendarTitle.appendChild(weekNumberEl);
        break;
      case 'day':
        calendarTitle.textContent = formatDay(calendarState.currentDate);
        break;
    }
  }
  
  // Helper function to get the start date of the week
  function getWeekStartDate(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
    return new Date(d.setDate(diff));
  }
  
  // Switch between calendar views
  function switchView(view) {
    const previousView = calendarState.currentView;
    calendarState.currentView = view;
    
    // Hide all views and remove active class
    document.querySelectorAll('.calendar-view').forEach(el => {
      el.classList.remove('active');
      el.classList.add('hidden');
    });
    
    // Remove active class from all view buttons
    viewMonthBtn.classList.remove('active', 'bg-blue-500', 'text-white');
    viewWeekBtn.classList.remove('active', 'bg-blue-500', 'text-white');
    viewDayBtn.classList.remove('active', 'bg-blue-500', 'text-white');
    
    // If we're switching from month to week view, adjust the date to the week containing the selected date
    if (previousView === 'month' && view === 'week') {
      // Use the selected date as the focus for the week view
      calendarState.currentDate = new Date(calendarState.selectedDate);
    }
    
    // If we're switching from month or week to day view, use the selected date
    if ((previousView === 'month' || previousView === 'week') && view === 'day') {
      calendarState.currentDate = new Date(calendarState.selectedDate);
    }
    
    // Show selected view
    switch(view) {
      case 'month':
        monthView.classList.remove('hidden');
        monthView.classList.add('active');
        viewMonthBtn.classList.add('active', 'bg-blue-500', 'text-white');
        renderMonthView();
        break;
      case 'week':
        weekView.classList.remove('hidden');
        weekView.classList.add('active');
        viewWeekBtn.classList.add('active', 'bg-blue-500', 'text-white');
        renderWeekView();
        break;
      case 'day':
        dayView.classList.remove('hidden');
        dayView.classList.add('active');
        viewDayBtn.classList.add('active', 'bg-blue-500', 'text-white');
        renderDayView();
        break;
    }
    
    updateCalendarTitle();
    
    console.log(`Switched to ${view} view`); // Debug logging
  }
  
  // Navigate to previous period
  function goToPrevPeriod() {
    switch(calendarState.currentView) {
      case 'month':
        calendarState.currentDate.setMonth(calendarState.currentDate.getMonth() - 1);
        break;
      case 'week':
        calendarState.currentDate.setDate(calendarState.currentDate.getDate() - 7);
        break;
      case 'day':
        calendarState.currentDate.setDate(calendarState.currentDate.getDate() - 1);
        break;
    }
    
    updateCalendarTitle();
    renderCurrentView();
  }
  
  // Navigate to next period
  function goToNextPeriod() {
    switch(calendarState.currentView) {
      case 'month':
        calendarState.currentDate.setMonth(calendarState.currentDate.getMonth() + 1);
        break;
      case 'week':
        calendarState.currentDate.setDate(calendarState.currentDate.getDate() + 7);
        break;
      case 'day':
        calendarState.currentDate.setDate(calendarState.currentDate.getDate() + 1);
        break;
    }
    
    updateCalendarTitle();
    renderCurrentView();
  }
  
  // Go to today
  function goToToday() {
    calendarState.currentDate = new Date();
    calendarState.selectedDate = new Date();
    
    // Switch to day view when clicking Today button
    switchView('day');
  }
  
  // Helper function to debounce function calls
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // Add window resize listener to handle responsive layout changes
  window.addEventListener('resize', debounce(() => {
    // Re-render current view when window size changes
    renderCurrentView();
  }, 250)); // Debounce to prevent excessive re-renders
  
  // Render the current view
  function renderCurrentView() {
    switch(calendarState.currentView) {
      case 'month':
        renderMonthView();
        break;
      case 'week':
        renderWeekView();
        break;
      case 'day':
        renderDayView();
        break;
    }
  }
  
  // Render month view
  function renderMonthView() {
    monthGrid.innerHTML = '';
    
    const year = calendarState.currentDate.getFullYear();
    const month = calendarState.currentDate.getMonth();
    
    // Update month overview stats
    const monthTotalGoalsEl = document.getElementById('month-total-goals');
    const monthCompletedGoalsEl = document.getElementById('month-completed-goals');
    const monthPendingGoalsEl = document.getElementById('month-pending-goals');
    const monthNameBadge = document.getElementById('month-name-badge');
    
    let totalMonthGoals = 0;
    let completedMonthGoals = 0;
    
    // Set month name for the badge
    const monthName = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    if (monthNameBadge) monthNameBadge.textContent = monthName;
    
    // Count goals for the entire month
    const totalDaysInMonth = new Date(year, month + 1, 0).getDate();
    for (let day = 1; day <= totalDaysInMonth; day++) {
      const date = new Date(year, month, day);
      const goalsForDay = getGoalsForDate(date);
      totalMonthGoals += goalsForDay.length;
      
      // Count completed goals
      goalsForDay.forEach(goal => {
        const dateString = date.toISOString().slice(0, 10);
        
        if (goal.checkIns && goal.checkIns.some(check => check.date === dateString && check.completed)) {
          completedMonthGoals++;
        }
      });
    }
    
    // Calculate pending goals
    const pendingMonthGoals = totalMonthGoals - completedMonthGoals;
    
    // Update UI elements
    if (monthTotalGoalsEl) monthTotalGoalsEl.textContent = totalMonthGoals;
    if (monthCompletedGoalsEl) monthCompletedGoalsEl.textContent = completedMonthGoals;
    if (monthPendingGoalsEl) monthPendingGoalsEl.textContent = pendingMonthGoals;
    
    // Add completion percentage if there are any goals
    if (totalMonthGoals > 0 && monthCompletedGoalsEl) {
      const completionPercentage = Math.round((completedMonthGoals / totalMonthGoals) * 100);
      monthCompletedGoalsEl.textContent = `${completedMonthGoals} (${completionPercentage}%)`;
    }
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    // Get day of week for first day (0 = Sunday, 1 = Monday, etc.)
    let firstDayOfWeek = firstDay.getDay();
    // Adjust for Monday as first day of week
    firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
    
    // Create cells for previous month
    for (let i = 0; i < firstDayOfWeek; i++) {
      const prevMonthDay = new Date(year, month, -firstDayOfWeek + i + 1);
      const dayCell = createDayCell(prevMonthDay, true);
      monthGrid.appendChild(dayCell);
    }
    
    // Create cells for current month
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dayCell = createDayCell(date);
      monthGrid.appendChild(dayCell);
    }
    
    // Fill remaining cells with next month
    const totalCells = 42; // 6 rows of 7 days
    const remainingCells = totalCells - (firstDayOfWeek + daysInMonth);
    for (let i = 1; i <= remainingCells; i++) {
      const nextMonthDay = new Date(year, month + 1, i);
      const dayCell = createDayCell(nextMonthDay, true);
      monthGrid.appendChild(dayCell);
    }
    
    // Render goal legend
    renderGoalLegend();
  }
  
  // Create a day cell for month view
  function createDayCell(date, isOutsideMonth = false) {
    const cell = document.createElement('div');
    cell.className = `relative p-3 ${isOutsideMonth ? 'bg-gray-50/50' : 'bg-white'} rounded-xl hover:bg-gray-50 hover:scale-105 transition-all duration-200 min-h-[180px] cursor-pointer border ${isOutsideMonth ? 'border-gray-100/30' : 'border-gray-100/50'} hover:shadow-md`;
    
    // Check if it's today
    const isToday = date.toDateString() === new Date().toDateString();
    if (isToday) {
      cell.classList.add('ring-2', 'ring-blue-400', 'bg-blue-50/30');
    }
    
    // Check if it's selected date
    const isSelected = date.toDateString() === calendarState.selectedDate.toDateString();
    if (isSelected && !isToday) {
      cell.classList.add('bg-blue-50/50', 'ring-1', 'ring-blue-300');
    }
    
    // Day number with modern styling
    const dayNumber = document.createElement('div');
    
    if (isToday) {
      dayNumber.className = 'h-7 w-7 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-semibold mb-2 shadow-sm';
    } else if (isSelected) {
      dayNumber.className = 'h-7 w-7 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-semibold mb-2';
    } else {
      dayNumber.className = `text-sm font-medium ${isOutsideMonth ? 'text-gray-300' : 'text-gray-800'} mb-2 h-7 flex items-center`;
    }
    
    dayNumber.textContent = date.getDate();
    cell.appendChild(dayNumber);
    
    // Add goals for this day
    const goalsForDay = getGoalsForDate(date);
    if (goalsForDay.length > 0) {
      const goalsContainer = document.createElement('div');
      goalsContainer.className = 'flex flex-wrap gap-1.5 mt-2';
      
      // Show up to 15 goals to utilize the increased container height, with a "+X more" indicator if there are more
      const displayGoals = goalsForDay.slice(0, 15);
      const remainingGoals = goalsForDay.length - displayGoals.length;
      
      displayGoals.forEach(goal => {
        const category = momentumState.categories.find(c => c.id === goal.category);
        const goalItem = document.createElement('div');
        
        // Create different layouts for mobile and desktop
        const isMobile = isMobileDevice();
        
        // Both mobile and desktop: Show colored circles with slightly increased size
        goalItem.className = 'w-4 h-4 rounded-full cursor-pointer hover:scale-125 transition-all duration-200 shadow-sm hover:shadow-md flex-shrink-0';
        
        // Apply category color with softer opacity
        if (isOutsideMonth) {
          goalItem.style.backgroundColor = getCategoryColor(category.color);
          goalItem.style.opacity = '0.3';
        } else {
          goalItem.style.backgroundColor = getCategoryColor(category.color);
          goalItem.style.opacity = '0.7'; // Softer version of category colors
        }
        
        // Add title attribute for tooltip on hover
        goalItem.title = goal.title;
        
        // Add click event to show goal details
        goalItem.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent cell click
          showGoalDetails(goal);
        });
        
        goalsContainer.appendChild(goalItem);
      });
      
      // Add "more" indicator if needed
      if (remainingGoals > 0) {
        const moreIndicator = document.createElement('div');
        const isMobile = isMobileDevice();
        
        // Small +N indicator that matches the circle design
        if (isOutsideMonth) {
          moreIndicator.className = 'text-[10px] text-white font-bold w-4 h-4 bg-gray-400 hover:bg-gray-500 rounded-full flex items-center justify-center cursor-pointer transition-all hover:scale-125 shadow-sm opacity-60';
        } else {
          moreIndicator.className = 'text-[10px] text-white font-bold w-4 h-4 bg-gray-600 hover:bg-gray-700 rounded-full flex items-center justify-center cursor-pointer transition-all hover:scale-125 shadow-sm';
        }
        moreIndicator.textContent = `+${remainingGoals}`;
        
        // Add click event to switch to day view
        moreIndicator.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent cell click
          calendarState.currentDate = new Date(date);
          calendarState.selectedDate = new Date(date);
          switchView('day');
        });
        
        goalsContainer.appendChild(moreIndicator);
      }
      
      cell.appendChild(goalsContainer);
    }
    
    // Add click event to select date
    cell.addEventListener('click', () => {
      calendarState.selectedDate = date;
      if (calendarState.currentView === 'month') {
        renderMonthView();
      } else {
        // If clicked on a date outside current month, switch to that month
        if (isOutsideMonth) {
          calendarState.currentDate = new Date(date);
          updateCalendarTitle();
          renderMonthView();
        }
      }
    });
    
    // Add double-click event to switch to day view
    cell.addEventListener('dblclick', () => {
      calendarState.currentDate = date;
      calendarState.selectedDate = date;
      switchView('day');
    });
    
    return cell;
  }
  
  // Render week view
  function renderWeekView() {
    const weekHeaderEl = document.getElementById('week-header');
    const weekGridEl = document.getElementById('week-grid');
    
    if (weekHeaderEl) weekHeaderEl.innerHTML = '';
    if (weekGridEl) weekGridEl.innerHTML = '';
    
    // Get start of week (Monday)
    const weekStart = getWeekStartDate(calendarState.currentDate);
    
    // Update week overview stats
    const weekTotalGoalsEl = document.getElementById('week-total-goals');
    const weekCompletedGoalsEl = document.getElementById('week-completed-goals');
    const weekPendingGoalsEl = document.getElementById('week-pending-goals');
    const weekNumberBadge = document.getElementById('week-number-badge');
    
    let totalWeekGoals = 0;
    let completedWeekGoals = 0;
    
    // Get week number for the badge
    const weekNumber = Math.ceil((((weekStart - new Date(weekStart.getFullYear(), 0, 1)) / 86400000) + 1) / 7);
    if (weekNumberBadge) weekNumberBadge.textContent = `Week ${weekNumber}`;
    
    // Count goals for the week
    for (let i = 0; i < 7; i++) {
      const date = new Date(weekStart);
      date.setDate(date.getDate() + i);
      const goalsForDay = getGoalsForDate(date);
      totalWeekGoals += goalsForDay.length;
      
      // Count completed goals
      goalsForDay.forEach(goal => {
        const today = new Date().toISOString().slice(0, 10);
        const dateString = date.toISOString().slice(0, 10);
        
        if (goal.checkIns && goal.checkIns.some(check => check.date === dateString && check.completed)) {
          completedWeekGoals++;
        }
      });
    }
    
    // Calculate pending goals
    const pendingWeekGoals = totalWeekGoals - completedWeekGoals;
    
    // Update UI elements
    if (weekTotalGoalsEl) weekTotalGoalsEl.textContent = totalWeekGoals;
    if (weekCompletedGoalsEl) weekCompletedGoalsEl.textContent = completedWeekGoals;
    if (weekPendingGoalsEl) weekPendingGoalsEl.textContent = pendingWeekGoals;
    
    // Add completion percentage if there are any goals
    if (totalWeekGoals > 0 && weekCompletedGoalsEl) {
      const completionPercentage = Math.round((completedWeekGoals / totalWeekGoals) * 100);
      weekCompletedGoalsEl.textContent = `${completedWeekGoals} (${completionPercentage}%)`;
    }
    
    // Create day headers
    for (let i = 0; i < 7; i++) {
      const date = new Date(weekStart);
      date.setDate(date.getDate() + i);
      
      const isToday = date.toDateString() === new Date().toDateString();
      const isSelected = date.toDateString() === calendarState.selectedDate.toDateString();
      
      // Create day header
      if (weekHeaderEl) {
        const dayHeader = document.createElement('div');
        dayHeader.className = `flex flex-col items-center justify-center p-3 cursor-pointer transition-all duration-200 hover:bg-blue-100 rounded-lg mx-1 ${isToday ? 'bg-blue-200 text-blue-900 shadow-sm' : ''} ${isSelected ? 'bg-blue-50' : ''}`;
        
        // Simple transition for the zoom effect only
        dayHeader.style.transition = 'transform 0.2s ease';
        
        dayHeader.addEventListener('click', () => {
          // Brief visual feedback
          const dayNumber = dayHeader.querySelector('div:nth-child(2)');
          dayHeader.style.transform = 'scale(1.05)';
          if (dayNumber) {
            dayNumber.style.fontWeight = '900';
          }
          
          // Switch to day view for the clicked date
          calendarState.currentDate = new Date(date);
          calendarState.selectedDate = new Date(date);
          
          // Brief delay to show the visual feedback before switching views
          setTimeout(() => {
            switchView('day');
          }, 150);
        });
        
        const dayName = document.createElement('div');
        dayName.className = 'text-xs font-thin text-gray-600 uppercase tracking-wide mb-1';
        dayName.textContent = date.toLocaleDateString('en-US', { weekday: 'short' });
        
        const dayNumber = document.createElement('div');
        if (isToday) {
          dayNumber.className = 'text-lg font-thin text-blue-900';
        } else {
          dayNumber.className = `text-lg font-thin ${isSelected ? 'text-blue-700' : 'text-gray-800'}`;
        }
        dayNumber.textContent = date.getDate();
        
        dayHeader.appendChild(dayName);
        dayHeader.appendChild(dayNumber);
        weekHeaderEl.appendChild(dayHeader);
      }
    }

    // Create Excel-like table structure with time periods as rows
    if (weekGridEl) {
      const timePeriods = [
        { name: 'morning', label: 'Morning', range: [6, 12] },
        { name: 'afternoon', label: 'Afternoon', range: [12, 18] },
        { name: 'evening', label: 'Evening', range: [18, 22] },
        { name: 'night', label: 'Night', range: [22, 6] },
        { name: 'anytime', label: 'Any Time', range: null }
      ];
      
      // Create time period rows
      timePeriods.forEach((timePeriod, rowIndex) => {
        const timeRow = document.createElement('div');
        timeRow.className = 'grid grid-cols-7 gap-0 border-b border-gray-200';
        timeRow.style.height = '120px'; // Fixed height for Excel-like layout
        
        // Create cells for each day in this time period
        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
          const date = new Date(weekStart);
          date.setDate(date.getDate() + dayIndex);
          
          const isToday = date.toDateString() === new Date().toDateString();
          const isSelected = date.toDateString() === calendarState.selectedDate.toDateString();
          
          const dayCell = document.createElement('div');
          dayCell.className = `relative border-r border-gray-200 last:border-r-0 p-2 hover:bg-blue-50/50 transition-all duration-200 cursor-pointer group ${isToday ? 'bg-blue-50/50' : ''} ${isSelected ? 'bg-blue-50/70' : ''}`;
          
          // Get goals for this day and time period
          const goalsForDay = getGoalsForDate(date);
          
          // Filter goals that belong to this time period
          let periodGoals = [];
          if (timePeriod.name === 'anytime') {
            periodGoals = goalsForDay.filter(goal => 
              goal.timePeriod === 'anytime' || 
              (!goal.timePeriod && (!goal.time || goal.time === 'No specific time')) ||
              (!goal.time || goal.time === 'No specific time') && 
              (!goal.scheduledTime || goal.scheduledTime === 'No specific time')
            );
          } else {
            periodGoals = goalsForDay.filter(goal => {
              if (goal.timePeriod && goal.timePeriod === timePeriod.name) {
                return true;
              }
              
              const goalTime = goal.time || goal.scheduledTime;
              if (goalTime && goalTime !== 'No specific time') {
                const goalHour = parseInt(goalTime.split(':')[0]);
                const [startHour, endHour] = timePeriod.range;
                
                if (timePeriod.name === 'night') {
                  return goalHour >= startHour || goalHour < endHour;
                } else {
                  return goalHour >= startHour && goalHour < endHour;
                }
              }
              return false;
            });
          }
          
          // Sort goals by time within each time period
          const sortedPeriodGoals = periodGoals.sort((a, b) => {
            const timeToMinutes = (timeStr) => {
              if (!timeStr || timeStr === 'No specific time') return Number.MAX_SAFE_INTEGER;
              const [hours, minutes] = timeStr.split(':').map(Number);
              return hours * 60 + (minutes || 0);
            };
            
            const timeA = timeToMinutes(a.time || a.scheduledTime);
            const timeB = timeToMinutes(b.time || b.scheduledTime);
            
            return timeA - timeB;
          });
          
          // Display up to 4 goals per cell
          sortedPeriodGoals.slice(0, 4).forEach((goal, goalIndex) => {
            const category = momentumState.categories.find(c => c.id === goal.category);
            const goalItem = document.createElement('div');
            const isMobile = isMobileDevice();
            
            const topPosition = goalIndex * 25 + 4; // Vertical spacing
            
            if (isMobile) {
              goalItem.className = 'absolute rounded-full cursor-pointer hover:scale-110 transition-all duration-200 shadow-sm';
              goalItem.style.backgroundColor = getCategoryColor(category.color);
              goalItem.style.width = '16px';
              goalItem.style.height = '16px';
              goalItem.style.top = `${topPosition}px`;
              goalItem.style.left = '50%';
              goalItem.style.transform = 'translateX(-50%)';
              
              if (goal.time && goal.time !== 'No specific time') {
                const timeDot = document.createElement('div');
                timeDot.className = 'w-1 h-1 bg-white rounded-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2';
                goalItem.appendChild(timeDot);
              }
            } else {
              goalItem.className = 'absolute inset-x-1 rounded-lg px-1.5 py-0.5 text-xs cursor-pointer hover:scale-[1.02] transition-all duration-200 flex items-center gap-1 border';
              goalItem.style.backgroundColor = `rgba(${getCategoryRGBA(category.color)}, 0.12)`;
              goalItem.style.borderColor = `rgba(${getCategoryRGBA(category.color)}, 0.25)`;
              goalItem.style.top = `${topPosition}px`;
              goalItem.style.height = '20px';
              
              const titleSpan = document.createElement('span');
              titleSpan.className = 'font-thin text-gray-700 flex-1 text-xs leading-tight truncate';
              titleSpan.textContent = goal.title;
              goalItem.appendChild(titleSpan);
            }
            
            goalItem.title = `${timePeriod.label} - ${goal.title}`;
            
            goalItem.addEventListener('click', (e) => {
              e.stopPropagation();
              showGoalDetails(goal);
            });
            
            dayCell.appendChild(goalItem);
          });
          
          // Show "+X more" if there are more goals
          if (sortedPeriodGoals.length > 4) {
            const moreElement = document.createElement('div');
            const isMobile = isMobileDevice();
            
            if (isMobile) {
              moreElement.className = 'absolute bottom-1 left-1/2 transform -translate-x-1/2 text-xs text-white font-medium w-5 h-5 bg-blue-500 hover:bg-blue-600 rounded-full flex items-center justify-center cursor-pointer transition-all hover:scale-110 shadow-sm';
              moreElement.textContent = `+${sortedPeriodGoals.length - 4}`;
            } else {
              moreElement.className = 'absolute bottom-1 right-1 text-xs text-blue-600 hover:text-blue-800 cursor-pointer font-semibold bg-white/80 px-1.5 py-0.5 rounded-full shadow-sm transition-all duration-200 hover:shadow-md';
              moreElement.textContent = `+${sortedPeriodGoals.length - 4}`;
            }
            
            moreElement.addEventListener('click', (e) => {
              e.stopPropagation();
              calendarState.currentDate = date;
              calendarState.selectedDate = date;
              switchView('day');
            });
            dayCell.appendChild(moreElement);
          }
          
          // Empty cells have no special hover effect (removed add button as requested)
          
          // Add click event to select date
          dayCell.addEventListener('click', () => {
            calendarState.selectedDate = date;
            renderWeekView();
          });
          
          // Add double-click event to switch to day view
          dayCell.addEventListener('dblclick', () => {
            calendarState.currentDate = date;
            calendarState.selectedDate = date;
            switchView('day');
          });
          
          timeRow.appendChild(dayCell);
        }
        
        weekGridEl.appendChild(timeRow);
      });
    }
    
    // Render goal legend
    renderGoalLegend();
  }
  
  // Render day view (list view)
  function renderDayView() {
    dayHeader.innerHTML = '';
    dayList.innerHTML = '';
    
    const date = calendarState.currentDate;
    const isToday = date.toDateString() === new Date().toDateString();
    
    // Update day overview stats
    const dayTotalGoalsEl = document.getElementById('day-total-goals');
    const dayCompletedGoalsEl = document.getElementById('day-completed-goals');
    const dayPendingGoalsEl = document.getElementById('day-pending-goals');
    const dayDateBadge = document.getElementById('day-date-badge');
    
    // Get goals for this day
    const dayGoals = getGoalsForDate(date);
    let completedDayGoals = 0;
    
    // Set date for the badge
    const dateString = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    if (dayDateBadge) dayDateBadge.textContent = dateString;
    
    // Count completed goals
    const dayDateString = date.toISOString().slice(0, 10);
    dayGoals.forEach(goal => {
      if (goal.checkIns && goal.checkIns.some(check => check.date === dayDateString && check.completed)) {
        completedDayGoals++;
      }
    });
    
    // Calculate pending goals
    const pendingDayGoals = dayGoals.length - completedDayGoals;
    
    // Update UI elements
    if (dayTotalGoalsEl) dayTotalGoalsEl.textContent = dayGoals.length;
    if (dayCompletedGoalsEl) dayCompletedGoalsEl.textContent = completedDayGoals;
    if (dayPendingGoalsEl) dayPendingGoalsEl.textContent = pendingDayGoals;
    
    // Add completion percentage if there are any goals
    if (dayGoals.length > 0 && dayCompletedGoalsEl) {
      const completionPercentage = Math.round((completedDayGoals / dayGoals.length) * 100);
      dayCompletedGoalsEl.textContent = `${completedDayGoals} (${completionPercentage}%)`;
    }
    
    // Create day header
    const headerContent = document.createElement('div');
    headerContent.className = 'flex items-center justify-between';
    
    const dayInfo = document.createElement('div');
    dayInfo.className = 'flex flex-col';
    
    const dayTitle = document.createElement('h3');
    dayTitle.className = 'text-base font-medium text-gray-900 mb-0.5';
    dayTitle.textContent = formatDay(date);
    
    const daySubtitle = document.createElement('p');
    daySubtitle.className = 'text-xs text-gray-400';
    daySubtitle.textContent = date.toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    dayInfo.appendChild(dayTitle);
    dayInfo.appendChild(daySubtitle);
    
    const todayIndicator = document.createElement('div');
    if (isToday) {
      todayIndicator.className = 'px-3 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full';
      todayIndicator.textContent = 'Today';
    } else {
      // Show how many days from today
      const diffFromToday = Math.round((date - new Date()) / (1000 * 60 * 60 * 24));
      const daysText = Math.abs(diffFromToday) === 1 ? 'day' : 'days';
      
      if (diffFromToday !== 0) {
        todayIndicator.className = 'px-3 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded-full';
        todayIndicator.textContent = diffFromToday < 0 
          ? `${Math.abs(diffFromToday)} ${daysText} ago` 
          : `In ${diffFromToday} ${daysText}`;
      }
    }
    
    headerContent.appendChild(dayInfo);
    if (todayIndicator.textContent) {
      headerContent.appendChild(todayIndicator);
    }
    
    dayHeader.appendChild(headerContent);
    
    // Get goals for this day
    const goalsForDay = getGoalsForDate(date);
    
    // Add simple header
    const timeBlocksHeader = document.createElement('div');
    timeBlocksHeader.className = 'flex items-center justify-between mb-5';
    
    const timeBlocksTitle = document.createElement('h4');
    timeBlocksTitle.className = 'text-sm font-thin text-gray-800';
    timeBlocksTitle.textContent = 'Habits for Today';
    
    const totalGoalsCount = document.createElement('span');
    totalGoalsCount.className = 'text-xs text-gray-500 bg-gray-50 border border-gray-200 px-2.5 py-1 rounded-full';
    totalGoalsCount.textContent = `${goalsForDay.length} habit${goalsForDay.length !== 1 ? 's' : ''}`;
    
    timeBlocksHeader.appendChild(timeBlocksTitle);
    timeBlocksHeader.appendChild(totalGoalsCount);
    
    if (goalsForDay.length > 0) {
      dayList.appendChild(timeBlocksHeader);
      
      // Group goals by time periods
      const timePeriods = {
        morning: { label: 'Morning', time: '6:00 - 12:00', goals: [] },
        afternoon: { label: 'Afternoon', time: '12:00 - 18:00', goals: [] },
        evening: { label: 'Evening', time: '18:00 - 22:00', goals: [] },
        night: { label: 'Night', time: '22:00 - 6:00', goals: [] },
        noTime: { label: 'No specific time', time: '', goals: [] }
      };
      
             // Distribute goals into time periods based on their timePeriod or scheduled time
       goalsForDay.forEach((goal) => {
         // First check if goal has the new timePeriod field
         if (goal.timePeriod) {
           if (goal.timePeriod === 'anytime') {
             timePeriods.noTime.goals.push(goal);
           } else if (timePeriods[goal.timePeriod]) {
             timePeriods[goal.timePeriod].goals.push(goal);
           } else {
             // Unknown time period, put in noTime
             timePeriods.noTime.goals.push(goal);
           }
           return;
         }
         
         // Fall back to parsing time for backward compatibility
         // If goal doesn't have a time, assign it to the noTime category
         if (!goal.time && !goal.scheduledTime) {
           goal.time = 'No specific time';
           goal.scheduledTime = 'No specific time';
           timePeriods.noTime.goals.push(goal);
           return;
         }
         
         // Use the existing time if available
         const goalTime = goal.time || goal.scheduledTime;
         
         // If it's "No specific time", put it in the noTime category
         if (goalTime === 'No specific time') {
           timePeriods.noTime.goals.push(goal);
           return;
         }
         
         // Parse the time to get the hour
         const hourMatch = goalTime.match(/^(\d+):/);
         if (!hourMatch) {
           // If time format is invalid, put in noTime
           timePeriods.noTime.goals.push(goal);
           return;
         }
         
         const hour = parseInt(hourMatch[1]);
         
         // Categorize based on hour
         let periodKey;
         if (hour >= 6 && hour < 12) {
           periodKey = 'morning';
         } else if (hour >= 12 && hour < 18) {
           periodKey = 'afternoon';
         } else if (hour >= 18 && hour < 22) {
           periodKey = 'evening';
         } else {
           periodKey = 'night';
         }
         
         // Ensure both time properties are set
         goal.scheduledTime = goalTime;
         goal.time = goalTime;
         
         // Add to the appropriate time period
         timePeriods[periodKey].goals.push(goal);
       });
      
      // Render each time period
      Object.entries(timePeriods).forEach(([key, period]) => {
        if (period.goals.length > 0) {
          const periodSection = document.createElement('div');
          periodSection.className = 'mb-8';
          
          const periodHeader = document.createElement('div');
          periodHeader.className = 'flex items-center gap-3 mb-4';
          
          const periodIcon = document.createElement('div');
          
          // Use new icons with strictly standardized size
          periodIcon.className = 'w-6 h-6 flex items-center justify-center overflow-hidden';
          
          // Create a common wrapper with fixed dimensions for all icons
          const iconWrapper = document.createElement('div');
          iconWrapper.className = 'w-5 h-5 flex items-center justify-center overflow-hidden';
          iconWrapper.style.width = '18px';
          iconWrapper.style.height = '18px';
          
          if (key === 'morning') {
            iconWrapper.innerHTML = `<img src="https://img.icons8.com/?size=100&id=118932&format=png&color=000000" style="width: 18px; height: 18px; object-fit: contain; object-position: center;" alt="Morning">`;
          } else if (key === 'afternoon') {
            iconWrapper.innerHTML = `<img src="https://img.icons8.com/?size=96&id=GIywaBFJCJiI&format=png" style="width: 18px; height: 18px; object-fit: contain; object-position: center;" alt="Afternoon">`;
          } else if (key === 'evening') {
            iconWrapper.innerHTML = `<img src="https://img.icons8.com/?size=160&id=111581&format=png" style="width: 18px; height: 18px; object-fit: contain; object-position: center;" alt="Evening">`;
          } else if (key === 'night') {
            iconWrapper.innerHTML = `<img src="https://img.icons8.com/?size=128&id=1SUhM4MGNydC&format=png" style="width: 18px; height: 18px; object-fit: contain; object-position: center;" alt="Night">`;
          } else {
            iconWrapper.innerHTML = `<img src="https://img.icons8.com/?size=160&id=hhUrGZKc66Si&format=png" style="width: 18px; height: 18px; object-fit: contain; object-position: center;" alt="No specific time">`;
          }
          
          periodIcon.appendChild(iconWrapper);
          
          const periodInfo = document.createElement('div');
          
          const periodTitle = document.createElement('h4');
          periodTitle.className = 'text-sm font-thin text-gray-800';
          periodTitle.textContent = period.label;
          
          if (period.time) {
            const periodTime = document.createElement('p');
            periodTime.className = 'text-xs text-gray-400';
            periodTime.textContent = period.time;
            periodInfo.appendChild(periodTime);
          }
          
          periodInfo.appendChild(periodTitle);
          
          periodHeader.appendChild(periodIcon);
          periodHeader.appendChild(periodInfo);
          
          periodSection.appendChild(periodHeader);
          
          // Goals list for this period
          const periodGoalsList = document.createElement('div');
          periodGoalsList.className = 'space-y-2 ml-6';
          
          period.goals.forEach(goal => {
            const category = momentumState.categories.find(c => c.id === goal.category);
            
            const goalItem = document.createElement('div');
            goalItem.className = 'flex items-center p-2.5 bg-white  rounded-lg hover:bg-gray-50 hover:border-gray-200 hover:scale-[1.02] transition-all duration-200 cursor-pointer hover:shadow-sm';
            
            const goalLeftSide = document.createElement('div');
            goalLeftSide.className = 'flex items-center gap-3';
            
            const colorIndicator = document.createElement('div');
            colorIndicator.className = 'w-2.5 h-2.5 rounded-full flex-shrink-0';
            colorIndicator.style.backgroundColor = getCategoryColor(category.color);
            
            const goalInfo = document.createElement('div');
            goalInfo.className = 'flex flex-col';
            
            const goalTitle = document.createElement('div');
            goalTitle.className = 'text-sm font-thin text-gray-800';
            goalTitle.textContent = goal.title;
            
            const goalMeta = document.createElement('div');
            goalMeta.className = 'flex items-center gap-2 mt-1';
            
            if (goal.scheduledTime) {
              const timeSpan = document.createElement('span');
              timeSpan.className = 'text-xs text-blue-700 font-medium bg-blue-50 border border-blue-200 px-2 py-0.5 rounded-md';
              timeSpan.textContent = goal.scheduledTime;
              goalMeta.appendChild(timeSpan);
            }
            
            const categoryBadge = document.createElement('span');
            categoryBadge.className = 'px-2 py-0.5 text-xs rounded-md';
            categoryBadge.textContent = category.name;
            
            // Apply category color to the badge
            const categoryColor = getCategoryColor(category.color);
            const rgbaColor = getCategoryRGBA(category.color);
            categoryBadge.style.backgroundColor = `rgba(${rgbaColor}, 0.15)`;
            categoryBadge.style.color = categoryColor;
            categoryBadge.style.border = `1px solid ${categoryColor}`;
            
            goalMeta.appendChild(categoryBadge);
            
            goalInfo.appendChild(goalTitle);
            goalInfo.appendChild(goalMeta);
            
            goalLeftSide.appendChild(colorIndicator);
            goalLeftSide.appendChild(goalInfo);
            
            goalItem.appendChild(goalLeftSide);
            
            goalItem.addEventListener('click', () => showGoalDetails(goal));
            
            periodGoalsList.appendChild(goalItem);
          });
          
          periodSection.appendChild(periodGoalsList);
          dayList.appendChild(periodSection);
        }
      });
    } else {
      // No goals for this day
      const noGoals = document.createElement('div');
      noGoals.className = 'flex flex-col items-center justify-center h-64 text-center p-8 bg-gray-50 rounded-xl';
      
      const noGoalsIcon = document.createElement('div');
      noGoalsIcon.className = 'text-gray-300 mb-4';
      noGoalsIcon.innerHTML = '<span class="material-icons text-6xl">event_busy</span>';
      
      const noGoalsText = document.createElement('div');
      noGoalsText.className = 'text-gray-500 mb-4';
      noGoalsText.innerHTML = '<p class="font-thin mb-1">No habits scheduled for this day</p><p class="text-sm font-thin">Add a habit to get started with your momentum journey.</p>';
      
      const addGoalBtn = document.createElement('button');
      addGoalBtn.className = 'mt-4 px-4 py-2 bg-purple-600 text-white rounded-full text-sm font-medium hover:bg-purple-700 transition-all shadow-sm flex items-center gap-1.5';
      
      const addIcon = document.createElement('span');
      addIcon.className = 'material-icons text-sm';
      addIcon.textContent = 'add';
      
      addGoalBtn.appendChild(addIcon);
      addGoalBtn.appendChild(document.createTextNode('Add a habit'));
      
      addGoalBtn.addEventListener('click', () => {
        // Scroll to the add goal section
        document.getElementById('add-goal-section').scrollIntoView({ behavior: 'smooth' });
      });
      
      noGoals.appendChild(noGoalsIcon);
      noGoals.appendChild(noGoalsText);
      noGoals.appendChild(addGoalBtn);
      
      dayList.appendChild(noGoals);
    }
    
    // Render goal legend
    renderGoalLegend();
  }
  
  // Render goal legend as dropdown
  function renderGoalLegend() {
    const individualFilters = document.getElementById('individual-category-filters');
    if (!individualFilters) return;
    
    individualFilters.innerHTML = '';
    
    // Create dropdown items for each category
    momentumState.categories.forEach(category => {
      const labelElement = document.createElement('label');
      labelElement.className = 'flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors duration-150';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
      checkbox.id = `filter-category-${category.id}`;
      
      // Check if category is currently filtered
      const isFiltered = calendarState.filteredCategories && calendarState.filteredCategories.includes(category.id);
      checkbox.checked = isFiltered;
      
      const categoryColor = document.createElement('div');
      categoryColor.className = 'w-3 h-3 rounded-full flex-shrink-0';
      categoryColor.style.backgroundColor = getCategoryColor(category.color);
      
      const categoryInfo = document.createElement('div');
      categoryInfo.className = 'flex-1 flex items-center justify-between';
      
      const categoryName = document.createElement('span');
      categoryName.className = 'text-sm text-gray-700';
      categoryName.textContent = category.name;
      
      const goalCount = momentumState.goals.filter(goal => goal.category === category.id).length;
      const countBadge = document.createElement('span');
      countBadge.className = 'text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full';
      countBadge.textContent = goalCount;
      
      categoryInfo.appendChild(categoryName);
      categoryInfo.appendChild(countBadge);
      
      labelElement.appendChild(checkbox);
      labelElement.appendChild(categoryColor);
      labelElement.appendChild(categoryInfo);
      
      // Add change event to handle filtering
      checkbox.addEventListener('change', () => {
        updateCategoryFilters();
      });
      
      individualFilters.appendChild(labelElement);
    });
    
    // Set up dropdown toggle functionality
    setupCategoryFilterDropdown();
    
    // Update the display text
    updateSelectedCategoriesDisplay();
  }
  
  // Set up category filter dropdown functionality
  function setupCategoryFilterDropdown() {
    const dropdownButton = document.getElementById('category-filter-dropdown');
    const dropdownOptions = document.getElementById('category-filter-options');
    const allCategoriesCheckbox = document.getElementById('filter-all-categories');
    
    if (!dropdownButton || !dropdownOptions || !allCategoriesCheckbox) return;
    
    // Remove existing listeners to avoid duplicates
    const newDropdownButton = dropdownButton.cloneNode(true);
    dropdownButton.parentNode.replaceChild(newDropdownButton, dropdownButton);
    
    // Toggle dropdown
    newDropdownButton.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = dropdownOptions.classList.contains('hidden');
      
      if (isHidden) {
        dropdownOptions.classList.remove('hidden');
        newDropdownButton.querySelector('svg').style.transform = 'rotate(180deg)';
      } else {
        dropdownOptions.classList.add('hidden');
        newDropdownButton.querySelector('svg').style.transform = 'rotate(0deg)';
      }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!newDropdownButton.contains(e.target) && !dropdownOptions.contains(e.target)) {
        dropdownOptions.classList.add('hidden');
        newDropdownButton.querySelector('svg').style.transform = 'rotate(0deg)';
      }
    });
    
    // Handle "All Categories" checkbox
    allCategoriesCheckbox.addEventListener('change', () => {
      if (allCategoriesCheckbox.checked) {
        // Uncheck all individual categories
        const individualCheckboxes = document.querySelectorAll('#individual-category-filters input[type="checkbox"]');
        individualCheckboxes.forEach(cb => cb.checked = false);
        
        // Clear filters
        calendarState.filteredCategories = [];
      } else {
        // If unchecking "All Categories", don't do anything special
        // Let user select individual categories
      }
      
      updateCategoryFilters();
    });
  }
  
  // Update category filters based on checkbox states
  function updateCategoryFilters() {
    const allCategoriesCheckbox = document.getElementById('filter-all-categories');
    const individualCheckboxes = document.querySelectorAll('#individual-category-filters input[type="checkbox"]');
    
    if (!allCategoriesCheckbox) return;
    
    // Get selected categories
    const selectedCategories = [];
    individualCheckboxes.forEach(checkbox => {
      if (checkbox.checked) {
        const categoryId = checkbox.id.replace('filter-category-', '');
        selectedCategories.push(categoryId);
      }
    });
    
    // Update calendar state
    if (selectedCategories.length === 0) {
      calendarState.filteredCategories = [];
      allCategoriesCheckbox.checked = true;
    } else {
      calendarState.filteredCategories = selectedCategories;
      allCategoriesCheckbox.checked = false;
    }
    
    // Update display and re-render
    updateSelectedCategoriesDisplay();
    renderCurrentView();
  }
  
  // Update the selected categories display text
  function updateSelectedCategoriesDisplay() {
    const displayText = document.getElementById('selected-categories-text');
    if (!displayText) return;
    
    if (!calendarState.filteredCategories || calendarState.filteredCategories.length === 0) {
      displayText.textContent = 'All Categories';
      displayText.className = 'text-gray-700';
    } else if (calendarState.filteredCategories.length === 1) {
      const category = momentumState.categories.find(c => c.id === calendarState.filteredCategories[0]);
      displayText.textContent = category ? category.name : 'Selected Category';
      displayText.className = 'text-blue-700 font-medium';
    } else {
      displayText.textContent = `${calendarState.filteredCategories.length} Categories Selected`;
      displayText.className = 'text-blue-700 font-medium';
    }
  }
  
  // Helper function to check if a date matches a monthly pattern
  function matchesMonthlyPattern(date, pattern) {
    const { occurrence, weekday } = pattern;
    
    // Get the day of week (0 = Sunday, 1 = Monday, etc.)
    const dayOfWeek = date.getDay();
    const weekdayMap = {
      'sunday': 0, 'monday': 1, 'tuesday': 2, 'wednesday': 3,
      'thursday': 4, 'friday': 5, 'saturday': 6
    };
    
    // Check if the day of week matches
    if (dayOfWeek !== weekdayMap[weekday]) {
      return false;
    }
    
    // Calculate which occurrence of this weekday it is in the month
    const year = date.getFullYear();
    const month = date.getMonth();
    const dayOfMonth = date.getDate();
    
    // Find all occurrences of this weekday in the month
    const occurrences = [];
    for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
      const testDate = new Date(year, month, day);
      if (testDate.getDay() === dayOfWeek) {
        occurrences.push(day);
      }
    }
    
    // Check which occurrence this date is
    const occurrenceIndex = occurrences.indexOf(dayOfMonth);
    if (occurrenceIndex === -1) return false;
    
    switch (occurrence) {
      case 'first': return occurrenceIndex === 0;
      case 'second': return occurrenceIndex === 1;
      case 'third': return occurrenceIndex === 2;
      case 'fourth': return occurrenceIndex === 3;
      case 'last': return occurrenceIndex === occurrences.length - 1;
      default: return false;
    }
  }

  // Helper function to get goals for a specific date
  function getGoalsForDate(date) {
    const dateString = date.toISOString().slice(0, 10);
    
    // First filter goals for this date
    const filteredGoals = momentumState.goals.filter(goal => {
      // Check if we need to filter by category
      if (calendarState.filteredCategories && calendarState.filteredCategories.length > 0) {
        if (!calendarState.filteredCategories.includes(goal.category)) {
          return false;
        }
      }
      
      // Show goals based on frequency and configuration
      switch(goal.frequency) {
        case 'daily':
          return true; // Show on every day
        case 'weekly':
          // Use weeklyDays if available, otherwise show on all days
          if (goal.weeklyDays && goal.weeklyDays.length > 0) {
            return goal.weeklyDays.includes(date.getDay());
          }
          return true; // Fallback to show on all days
        case 'monthly':
          // Use monthlyConfig if available
          if (goal.monthlyConfig) {
            const config = goal.monthlyConfig;
            if (config.type === 'specific' && config.days) {
              return config.days.includes(date.getDate());
            } else if (config.type === 'pattern' && config.patterns) {
              // Check if date matches any of the patterns
              return config.patterns.some(pattern => {
                return matchesMonthlyPattern(date, pattern);
              });
            }
          }
          // Fallback: show on same day of month as creation
          const creationDate = new Date(goal.deadline || Date.now());
          return date.getDate() === creationDate.getDate();
        case 'custom':
          // Use customConfig if available
          if (goal.customConfig) {
            const config = goal.customConfig;
            if (config.type === 'dates' && config.dates) {
              return config.dates.includes(dateString);
            } else if (config.type === 'interval') {
              // For interval-based custom goals, show based on interval
              const creationDate = new Date(goal.deadline || Date.now());
              const daysDiff = Math.floor((date - creationDate) / (1000 * 60 * 60 * 24));
              const interval = parseInt(config.number) || 1;
              
              if (config.unit === 'days') {
                return daysDiff % interval === 0;
              } else if (config.unit === 'weeks') {
                return daysDiff % (interval * 7) === 0;
              } else if (config.unit === 'months') {
                // For monthly intervals, check if it's the same day of month
                return date.getDate() === creationDate.getDate() && 
                       (date.getMonth() - creationDate.getMonth()) % interval === 0;
              }
            }
          }
          return false;
        default:
          return false;
      }
    });
    
    // Then sort goals by time
    return filteredGoals.sort((a, b) => {
      // Helper function to convert time string to minutes since midnight
      const timeToMinutes = (timeStr) => {
        if (!timeStr || timeStr === 'No specific time') return Number.MAX_SAFE_INTEGER; // Put "No specific time" at the end
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + (minutes || 0);
      };
      
      const timeA = timeToMinutes(a.time || a.scheduledTime);
      const timeB = timeToMinutes(b.time || b.scheduledTime);
      
      return timeA - timeB; // Sort ascending by time
    });
  }
  
  // Helper function to show goal details
  function showGoalDetails(goal) {
    // For now, just update the goal modal
    showUpdateGoalModal(goal);
  }
  
  // Helper function to mark goal as completed
  function markGoalCompleted(goal) {
    // Initialize checkIns array if it doesn't exist
    if (!goal.checkIns) {
      goal.checkIns = [];
    }
    
    // Add a check-in for today
    const today = new Date().toISOString().slice(0, 10);
    
    // Check if we already have a check-in for today
    const existingCheckInIndex = goal.checkIns.findIndex(check => check.date === today);
    
    if (existingCheckInIndex >= 0) {
      // Update existing check-in
      goal.checkIns[existingCheckInIndex].completed = true;
    } else {
      // Add new check-in
      goal.checkIns.push({
        date: today,
        completed: true,
        notes: 'Marked as completed from calendar'
      });
    }
    
    // Show success message
    const successMessage = document.createElement('div');
    successMessage.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm z-50';
    successMessage.textContent = 'Goal marked as completed!';
    document.body.appendChild(successMessage);
    
    // Remove success message after 2 seconds
    setTimeout(() => {
      if (successMessage.parentNode) {
        successMessage.parentNode.removeChild(successMessage);
      }
    }, 2000);
    
    // Re-render current view
    renderCurrentView();
  }
  
  // Helper function to get category color
  function getCategoryColor(color) {
    // If it's already a hex color, return it directly
    if (color && color.startsWith('#')) {
      return color;
    }
    
    // Map color name to actual color for backward compatibility
    const colorMap = {
      'purple': '#8b5cf6',
      'blue': '#3b82f6',
      'green': '#10b981',
      'yellow': '#f59e0b',
      'amber': '#f59e0b',
      'red': '#ef4444',
      'pink': '#ec4899',
      'indigo': '#6366f1',
      'gray': '#6b7280'
    };
    
    return colorMap[color] || color || '#8b5cf6';
  }
  
  // Helper function to check if the device is mobile
  function isMobileDevice() {
    return window.innerWidth < 768;
  }
  
  // Helper function to get category color as RGBA
  function getCategoryRGBA(color) {
    // If it's a hex color, convert to RGB
    if (color && color.startsWith('#')) {
      const hex = color.replace('#', '');
      const r = parseInt(hex.substr(0, 2), 16);
      const g = parseInt(hex.substr(2, 2), 16);
      const b = parseInt(hex.substr(4, 2), 16);
      return `${r}, ${g}, ${b}`;
    }
    
    // Map color name to RGB values for backward compatibility
    const rgbaMap = {
      'purple': '139, 92, 246',
      'blue': '59, 130, 246',
      'green': '16, 185, 129',
      'yellow': '245, 158, 11',
      'amber': '245, 158, 11',
      'red': '239, 68, 68',
      'pink': '236, 72, 153',
      'indigo': '99, 102, 241',
      'gray': '107, 114, 128'
    };
    
    return rgbaMap[color] || '139, 92, 246';
  }
  
  // Function to show momentum section
  function showMomentumSection() {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
      section.style.display = 'none';
    });
    
    // Show momentum section
    const momentumSection = document.getElementById('momentumSections');
    if (momentumSection) {
      momentumSection.style.display = 'block';
    }
    
    // Update sidebar active state
    document.querySelectorAll('.sidebar-link').forEach(link => {
      link.classList.remove('active');
    });
    
    const momentumLink = document.querySelector('[onclick="showSection(\'momentumSections\')"]');
    if (momentumLink) {
      momentumLink.classList.add('active');
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  
  // Set up event listeners for calendar controls
  if (viewMonthBtn) {
    console.log('Setting up month view button');
    viewMonthBtn.addEventListener('click', () => {
      console.log('Month view button clicked');
      switchView('month');
    });
  } else {
    console.log('Month view button not found');
  }
  
  if (viewWeekBtn) {
    console.log('Setting up week view button');
    viewWeekBtn.addEventListener('click', () => {
      console.log('Week view button clicked');
      switchView('week');
    });
  } else {
    console.log('Week view button not found');
  }
  
  if (viewDayBtn) {
    console.log('Setting up day view button');
    viewDayBtn.addEventListener('click', () => {
      console.log('Day view button clicked');
      switchView('day');
    });
  } else {
    console.log('Day view button not found');
  }
  
  if (prevPeriodBtn) prevPeriodBtn.addEventListener('click', goToPrevPeriod);
  if (nextPeriodBtn) nextPeriodBtn.addEventListener('click', goToNextPeriod);
  if (todayBtn) todayBtn.addEventListener('click', goToToday);
  
  // Set up event listeners for sync buttons
  const syncAppleBtn = document.getElementById('sync-apple');
  const syncGoogleBtn = document.getElementById('sync-google');
  
  if (syncAppleBtn) {
    syncAppleBtn.addEventListener('click', () => {
      alert('Syncing with Apple Calendar is not implemented in this demo.');
    });
  }
  
  if (syncGoogleBtn) {
    syncGoogleBtn.addEventListener('click', () => {
      alert('Syncing with Google Calendar is not implemented in this demo.');
    });
  }
  
  // Add CSS for calendar views and goal cards
  document.head.insertAdjacentHTML('beforeend', `
  <style>
    .calendar-view-btn.active {
      background-color: #3b82f6;
      color: white;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }
    
    .calendar-view-btn:hover:not(.active) {
      background-color: #f1f5f9;
      color: #475569;
    }
    
    .calendar-view {
      display: none !important;
    }
    
    .calendar-view.active {
      display: block !important;
    }
    
    .calendar-view.hidden {
      display: none !important;
    }
    
    /* Goal card animations and effects */
    .goal-card-modern {
      animation: fadeInUp 0.6s ease-out forwards;
      opacity: 0;
      transform: translateY(30px);
    }
    
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: visible;
    }
    
    /* Liquid animation effects */
    @keyframes liquid-float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-10px) rotate(1deg); }
      66% { transform: translateY(5px) rotate(-1deg); }
    }
    
    .goal-card-modern:hover .absolute.top-0 {
      animation: liquid-float 3s ease-in-out infinite;
    }
    
    /* Glassmorphism enhancements */
    .goal-card-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      border-radius: 1.5rem;
    }
    
    .goal-card-modern:hover::before {
      opacity: 1;
    }
    
    /* Ensure all text in goal steps is white */
    .goal-step * {
      color: white !important;
    }
    
    .goal-step input, .goal-step select, .goal-step textarea {
      color: #374151 !important;
    }
    
    .goal-step .text-gray-800 {
      color: #374151 !important;
    }
    
    /* Keep arrow buttons with their original colors */
    .goal-step .bg-white .material-icons-outlined,
    .goal-step .bg-white span.material-icons-outlined {
      color: #2563eb !important;
    }
    
    /* Keep Continue button text blue */
    .goal-step .bg-white.text-blue-600,
    .goal-step .bg-white.text-blue-600 span {
      color: #2563eb !important;
    }
    
    /* Weekly day selection styling */
    .weekly-day-btn.bg-white {
      background-color: white !important;
      color: #2563eb !important;
      border-color: #3b82f6 !important;
    }
    
    .weekly-day-btn.bg-white span {
      color: #2563eb !important;
    }
    
    /* Custom calendar styling */
    .calendar-day {
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .calendar-day:hover:not(.selected) {
      background-color: rgba(255, 255, 255, 0.3) !important;
      transform: scale(1.05);
    }
    
    /* Removed second conflicting calendar-day.selected rule - using category-themed one instead */
    
    .calendar-day-empty {
      pointer-events: none;
    }
    
         /* Goal Categories Drop Shadow Effects */
     .category-card h3 {
       text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
     }
     
     .category-card .font-bold.text-3xl {
       text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4) !important;
     }
     
     .category-card .material-icons {
       filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3)) !important;
     }
     
     /* Goal Progress Drop Shadow Effects */
     .goal-card-modern .material-icons {
       filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3)) !important;
     }
    
    /* Mobile Responsive Styles - Make fonts smaller for mobile only */
    @media (max-width: 768px) {
      /* Momentum sections general font scaling */
      .momentum-section h2 {
        font-size: 1.5rem !important; /* text-2xl -> text-xl */
      }
      
      .momentum-section h3 {
        font-size: 1rem !important; /* text-lg -> text-base */
      }
      
      .momentum-section p {
        font-size: 0.75rem !important; /* text-sm -> text-xs */
      }
      
      /* Goal Categories mobile adjustments */
      .category-card h3 {
        font-size: 1rem !important; /* text-lg -> text-base */
      }
      
      .category-card .text-3xl {
        font-size: 1.5rem !important; /* text-3xl -> text-xl */
      }
      
      .category-card .text-xs {
        font-size: 0.625rem !important; /* text-xs -> smaller */
      }
      
      .category-card .text-sm {
        font-size: 0.75rem !important; /* text-sm -> text-xs */
      }
      
      /* Goal Progress section mobile adjustments */
      .goal-card-modern h2 {
        font-size: 1rem !important; /* text-lg -> text-base */
      }
      
      .goal-card-modern h3 {
        font-size: 0.875rem !important; /* text-sm -> smaller */
      }
      
      .goal-card-modern .text-xs {
        font-size: 0.625rem !important; /* text-xs -> smaller */
      }
      
      /* Completion Trends mobile adjustments */
      .completion-trends h2 {
        font-size: 1.5rem !important; /* text-2xl -> text-xl */
      }
      
      .completion-trends .text-lg {
        font-size: 1rem !important; /* text-lg -> text-base */
      }
      
      .completion-trends .text-xs {
        font-size: 0.625rem !important; /* text-xs -> smaller */
      }
      
      /* Calendar section mobile adjustments */
      .calendar-section h2 {
        font-size: 1.5rem !important; /* text-2xl -> text-xl */
      }
      
      .calendar-section .text-lg {
        font-size: 1rem !important; /* text-lg -> text-base */
      }
      
      .calendar-section .text-sm {
        font-size: 0.75rem !important; /* text-sm -> text-xs */
      }
      
      .calendar-section .text-xs {
        font-size: 0.625rem !important; /* text-xs -> smaller */
      }
      
      /* Button text mobile adjustments */
      .momentum-section button {
        font-size: 0.75rem !important; /* text-xs -> smaller */
      }
      
      /* Average completion rate mobile adjustments */
      .momentum-section .text-xl {
        font-size: 1rem !important; /* text-xl -> text-base */
      }
      
               /* Increase padding for bigger containers on mobile */
         .momentum-section {
           padding: 1.5rem !important; /* p-8 -> p-6 (bigger than before) */
         }
         
         .category-card {
           padding: 1.25rem !important; /* p-6 -> p-5 (bigger than before) */
         }
         
         .goal-card-modern {
           padding: 1.25rem !important; /* p-6 -> p-5 (bigger than before) */
         }
       
       /* Goal Calendar Mobile Improvements */
       .calendar-container {
         font-size: 0.75rem !important; /* Make all calendar text smaller */
       }
       
       /* Calendar navigation mobile */
       #calendar-title {
         font-size: 1rem !important; /* text-lg -> text-base */
       }
       
       /* Calendar view buttons mobile */
       .calendar-view-btn {
         font-size: 0.625rem !important; /* text-xs -> smaller */
         padding: 0.375rem 0.75rem !important; /* py-1.5 px-4 -> smaller */
       }
       
       /* Month view mobile improvements */
       #month-view .calendar-grid {
         gap: 0.125rem !important; /* Reduce gap between days */
       }
       
       #month-view .calendar-day {
         font-size: 0.625rem !important; /* Make day numbers smaller */
         padding: 0.25rem !important; /* Reduce padding */
         min-height: 2rem !important; /* Reduce minimum height */
       }
       
       #month-view .calendar-day-header {
         font-size: 0.625rem !important; /* Make day headers smaller */
         padding: 0.25rem !important;
       }
       
       /* Week view mobile improvements */
       #week-view .week-day-column {
         font-size: 0.625rem !important;
         padding: 0.25rem !important;
       }
       
       #week-view .week-day-header {
         font-size: 0.625rem !important;
         padding: 0.25rem !important;
       }
       
       /* Day view mobile improvements */
       #day-view .day-header {
         font-size: 1rem !important; /* text-lg -> text-base */
       }
       
       #day-view .time-slot {
         font-size: 0.625rem !important;
         padding: 0.25rem !important;
       }
       
       /* Goal items in calendar mobile */
       .calendar-goal-item {
         font-size: 0.5rem !important; /* Make goal text very small */
         padding: 0.125rem 0.25rem !important; /* Reduce padding */
         margin: 0.125rem 0 !important; /* Reduce margin */
       }
       
       /* Calendar overview banner mobile */
       .calendar-container .bg-gradient-to-r {
         padding: 0.75rem !important; /* p-4 -> p-3 */
       }
       
       .calendar-container .bg-gradient-to-r h4 {
         font-size: 0.75rem !important; /* text-sm -> text-xs */
       }
       
       .calendar-container .bg-gradient-to-r p {
         font-size: 0.625rem !important; /* text-xs -> smaller */
       }
       
       /* Calendar sync buttons mobile */
       #sync-apple, #sync-google {
         font-size: 0.625rem !important;
         padding: 0.25rem 0.5rem !important;
       }
       
       /* Today button mobile */
       #today-btn {
         font-size: 0.625rem !important;
         padding: 0.25rem 0.5rem !important;
       }
       
       /* Calendar navigation arrows mobile */
       #prev-period, #next-period {
         padding: 0.25rem !important;
       }
       
               #prev-period .material-icons, #next-period .material-icons {
          font-size: 1rem !important; /* text-lg -> text-base */
        }
        
                 /* Mobile Portrait - Day List View Only */
         .calendar-view-btn:not([data-view="day"]) {
           display: none !important; /* Hide Month and Week buttons */
         }
         
         /* Pre-select Day view button */
         #view-day {
           background-color: #3b82f6 !important;
           color: white !important;
         }
         
         /* Pre-select Today button styling */
         #today-btn {
           background-color: #3b82f6 !important;
           color: white !important;
           border-color: #3b82f6 !important;
         }
         
         /* Show orientation message for Month/Week views */
         .orientation-message {
           display: block !important;
           background: rgba(59, 130, 246, 0.1);
           border: 1px solid rgba(59, 130, 246, 0.3);
           border-radius: 0.75rem;
           padding: 0.75rem;
           margin: 0.5rem 0;
           text-align: center;
           color: #3b82f6;
           font-size: 0.75rem;
         }
         
         /* Enhanced Day View for Mobile */
         #day-view {
           display: block !important; /* Always show day view on mobile */
         }
         
         #month-view, #week-view {
           display: none !important; /* Hide other views on mobile portrait */
         }
         
         /* Goal Progress containers mobile portrait adjustments */
         .goal-card-modern {
           height: 11rem !important; /* h-48 -> h-44 (more narrow vertically) */
           min-width: 300px !important; /* More wide horizontally */
         }
         
         .goal-card-modern .relative.overflow-hidden {
           height: 11rem !important; /* Match container height */
         }
         
         /* Category icons in Progress section - make them smaller */
         .goal-card-modern .w-10.h-10 {
           width: 28px !important; /* Smaller than before */
           height: 28px !important; /* Smaller than before */
         }
         
         .goal-card-modern .category-icon .material-icons {
           font-size: 10px !important; /* Even smaller to see how it looks */
         }
         
         /* Progress circle - same size as category icon */
         .goal-card-modern .relative.w-12.h-12 {
           width: 28px !important; /* Same as category icon circle */
           height: 28px !important; /* Same as category icon circle */
         }
         
         /* Category name - make smaller and bring up */
         .goal-card-modern .category-icon + div h3 {
           font-size: 10px !important; /* Smaller category name */
           margin-top: -4px !important; /* Bring up */
         }
         
         /* Header section - bring up */
         .goal-card-modern .flex.items-center.justify-between.mb-4 {
           margin-bottom: 8px !important; /* Less margin bottom */
           margin-top: -8px !important; /* Bring up in container */
         }
         
         /* Goal title and frequency - bring down a tiny bit more */
         .goal-card-modern .flex-1.mb-4 {
           margin-bottom: 8px !important; /* Less margin bottom */
           margin-top: 2px !important; /* Bring down a tiny bit more */
         }
         
         /* Goal title - smaller */
         .goal-card-modern .text-white.font-bold.text-lg {
           font-size: 14px !important; /* Smaller title */
           line-height: 1.2 !important; /* Tighter line height */
         }
         
         /* Frequency text - smaller */
         .goal-card-modern .flex.items-center.gap-1.text-white.text-xs {
           font-size: 9px !important; /* Smaller frequency text */
         }
         
         /* Make container more narrow vertically */
         .goal-card-modern {
           height: 9.5rem !important; /* h-44 -> h-38 (more narrow) */
           min-width: 300px !important; /* Keep wide horizontally */
         }
         
         .goal-card-modern .relative.overflow-hidden {
           height: 9.5rem !important; /* Match container height */
         }
         
         /* FORCE CENTER ALL BUTTONS - NUCLEAR OPTION */
         .momentum-section * {
           text-align: center !important;
         }
         
         .momentum-section > * {
           display: flex !important;
           flex-direction: column !important;
           align-items: center !important;
           justify-content: center !important;
           width: 100% !important;
         }
         
         .momentum-section div:first-child {
           display: flex !important;
           flex-direction: column !important;
           align-items: center !important;
           justify-content: center !important;
           text-align: center !important;
         }
         
         .momentum-section div:first-child > div:last-child {
           display: flex !important;
           justify-content: center !important;
           align-items: center !important;
           width: 100% !important;
           margin: 16px auto !important;
         }
         
         .momentum-section select,
         .momentum-section #momentum-filter {
           display: block !important;
           margin: 0 auto !important;
           text-align: center !important;
         }
         
         /* CONSOLIDATED SHOW ALL BUTTON CENTERING */
         
         /* Override the specific header that uses justify-between */
         .momentum-section .flex.flex-col.md\\:flex-row.justify-between.items-start.md\\:items-center {
           justify-content: center !important;
           align-items: center !important;
           flex-direction: column !important;
           gap: 1rem !important;
         }
         
         /* Center the header children */
         .momentum-section .flex.flex-col.md\\:flex-row.justify-between.items-start.md\\:items-center > div {
           text-align: center !important;
           display: flex !important;
           flex-direction: column !important;
           align-items: center !important;
         }
         
         /* ULTRA AGGRESSIVE BUTTON CENTERING */
         .momentum-section #show-all-container {
           display: flex !important;
           justify-content: center !important;
           align-items: center !important;
           width: 100% !important;
           text-align: center !important;
           margin-left: auto !important;
           margin-right: auto !important;
         }
         
         .momentum-section #show-all-goals-btn {
           display: inline-flex !important;
           margin: 0 auto !important;
           justify-self: center !important;
           align-self: center !important;
           position: relative !important;
           left: 50% !important;
           transform: translateX(-50%) !important;
         }
         
         /* OVERRIDE NUCLEAR OPTION FOR SHOW ALL CONTAINER */
         .momentum-section #show-all-container {
           display: flex !important;
           justify-content: center !important;
           align-items: center !important;
           flex-direction: row !important; /* Override column from nuclear option */
           width: 100% !important;
         }
         
         /* FINAL BUTTON FIX - Center and improve design */
         @media (max-width: 768px) {
           button#show-all-goals-btn {
             display: inline-flex !important;
             align-items: center !important;
             justify-content: center !important;
             margin: 0 auto !important;
             position: static !important;
             left: auto !important;
             transform: none !important;
             float: none !important;
             clear: both !important;
             
             /* Improved design */
             background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)) !important;
             backdrop-filter: blur(20px) !important;
             border: 1px solid rgba(99, 102, 241, 0.2) !important;
             border-radius: 12px !important;
             padding: 10px 20px !important;
             font-size: 14px !important;
             font-weight: 500 !important;
             color: #4F46E5 !important;
             box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1) !important;
             transition: all 0.3s ease !important;
             gap: 8px !important;
           }
           
           button#show-all-goals-btn:hover {
             background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(168, 85, 247, 0.15)) !important;
             transform: translateY(-2px) !important;
             box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15) !important;
             border-color: rgba(99, 102, 241, 0.3) !important;
           }
           
           button#show-all-goals-btn .material-icons {
             color: #4F46E5 !important;
             font-size: 16px !important;
           }
         }
         
         /* Much Smaller Complete Goal Button for Mobile */
         .completed-today-btn {
           font-size: 0.5rem !important; /* Even smaller text */
           padding: 0.25rem 0.375rem !important; /* Much smaller padding */
           min-height: 1.5rem !important; /* Reduce minimum height */
         }
         
         .completed-today-btn .material-icons {
           font-size: 0.625rem !important; /* Much smaller icon */
         }
         
         .update-goal-btn {
           font-size: 0.5rem !important; /* Match complete button size */
           padding: 0.25rem 0.375rem !important; /* Much smaller padding */
           min-height: 1.5rem !important; /* Reduce minimum height */
         }
         
         .update-goal-btn .material-icons {
           font-size: 0.625rem !important; /* Much smaller icon */
         }
         
         /* Goal Calendar Day View - Ultra Small Complete Button for Mobile */
         #day-view .completed-today-btn,
         #day-list .completed-today-btn,
         .calendar-goal-item .completed-today-btn {
           font-size: 0.375rem !important; /* Ultra small text */
           padding: 0.0625rem 0.125rem !important; /* Ultra minimal padding */
           min-height: 1rem !important; /* Ultra compact height */
           border-radius: 0.25rem !important; /* Tiny border radius */
           line-height: 1 !important; /* Tight line height */
         }
         
         #day-view .completed-today-btn .material-icons,
         #day-list .completed-today-btn .material-icons,
         .calendar-goal-item .completed-today-btn .material-icons {
           font-size: 0.375rem !important; /* Ultra small icon */
         }
         
         /* Goal Calendar Day View - Ultra Small Update Button for Mobile */
         #day-view .update-goal-btn,
         #day-list .update-goal-btn,
         .calendar-goal-item .update-goal-btn {
           font-size: 0.375rem !important; /* Ultra small text */
           padding: 0.0625rem 0.125rem !important; /* Ultra minimal padding */
           min-height: 1rem !important; /* Ultra compact height */
           border-radius: 0.25rem !important; /* Tiny border radius */
           line-height: 1 !important; /* Tight line height */
         }
         
         #day-view .update-goal-btn .material-icons,
         #day-list .update-goal-btn .material-icons,
         .calendar-goal-item .update-goal-btn .material-icons {
           font-size: 0.375rem !important; /* Ultra small icon */
         }
         
         /* Goal Calendar Day View - Ultra Small Green Complete Button for Mobile */
         #day-view button[class*="bg-green-50"],
         #day-list button[class*="bg-green-50"] {
           font-size: 0.375rem !important; /* Ultra small text */
           padding: 0.0625rem 0.125rem !important; /* Ultra minimal padding */
           min-height: 1rem !important; /* Ultra compact height */
           border-radius: 0.25rem !important; /* Tiny border radius */
           line-height: 1 !important; /* Tight line height */
           gap: 0.125rem !important; /* Smaller gap between icon and text */
         }
         
         #day-view button[class*="bg-green-50"] .material-icons,
         #day-list button[class*="bg-green-50"] .material-icons {
           font-size: 0.375rem !important; /* Ultra small icon */
         }
         
         #day-view button[class*="bg-green-50"] span:not(.material-icons),
         #day-list button[class*="bg-green-50"] span:not(.material-icons) {
           font-size: 0.375rem !important; /* Ultra small text */
         }
         
         /* Reduce horizontal gaps to page edges - zero margins for all containers */
         .momentum-section {
           margin-left: 0 !important; /* Remove left margin completely */
           margin-right: 0 !important; /* Remove right margin completely */
           padding-left: 0.5rem !important; /* Add minimal internal padding */
           padding-right: 0.5rem !important; /* Add minimal internal padding */
         }
         
         /* Specific container adjustments - touch page edges with bigger internal spacing */
         .bg-white.rounded-\\[35px\\] {
           margin-left: 0 !important;
           margin-right: 0 !important;
           border-radius: 1rem !important; /* Reduce border radius for edge-to-edge */
           padding: 1.5rem !important; /* Increase internal padding for bigger feel */
         }
         
         /* Main momentum sections container with spacing between sections */
         #momentum-sections {
           padding-left: 0 !important;
           padding-right: 0 !important;
           margin-left: 0 !important;
           margin-right: 0 !important;
         }
         
         /* Add spacing between sections */
         .momentum-section + .momentum-section,
         .bg-white.rounded-\\[35px\\] + .bg-white.rounded-\\[35px\\] {
           margin-top: 1rem !important; /* Add gap between sections */
         }
         
         /* Goal cards container adjustments */
         .grid.grid-cols-1 {
           padding-left: 0.5rem !important;
           padding-right: 0.5rem !important;
           margin-left: 0 !important;
           margin-right: 0 !important;
         }
         
         /* Category cards adjustments */
         .category-card {
           margin-left: 0 !important;
           margin-right: 0 !important;
         }
         
         /* Goal progress cards adjustments */
         .goal-card-modern {
           margin-left: 0 !important;
           margin-right: 0 !important;
         }
         
         /* Remove any outer container margins */
         .container, .max-w-7xl, .mx-auto {
           margin-left: 0 !important;
           margin-right: 0 !important;
           max-width: 100% !important;
         }
        
        /* Day List Styling for Mobile */
        .mobile-day-list {
          display: flex !important;
          flex-direction: column;
          gap: 0.5rem;
        }
        
        .mobile-day-item {
          background: rgba(255, 255, 255, 0.05);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 0.75rem;
          padding: 0.75rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .mobile-day-date {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
        }
        
        .mobile-day-number {
          font-size: 1.25rem;
          font-weight: bold;
          color: white;
        }
        
        .mobile-day-name {
          font-size: 0.625rem;
          color: rgba(255, 255, 255, 0.7);
          text-transform: uppercase;
        }
        
        .mobile-day-goals {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          gap: 0.25rem;
        }
        
        .mobile-goal-dot {
          width: 0.5rem;
          height: 0.5rem;
          border-radius: 50%;
          background: rgba(255, 255, 255, 0.6);
        }
        
        .mobile-goal-count {
          font-size: 0.625rem;
          color: rgba(255, 255, 255, 0.7);
        }
      }
      
      /* Mobile Landscape - Show all views */
      @media (max-width: 768px) and (orientation: landscape) {
        .calendar-view-btn {
          display: inline-block !important; /* Show all buttons in landscape */
        }
        
        .orientation-message {
          display: none !important;
        }
        
        #month-view, #week-view {
          display: block !important; /* Show other views in landscape */
        }
      }
  </style>
  `);
  
  // Initial render
  console.log('Setting up initial view');
  
  // Make sure all views are hidden first
  monthView.classList.add('hidden');
  weekView.classList.add('hidden');
  dayView.classList.add('hidden');
  
  // Check if mobile portrait mode and set appropriate initial view
  const isMobilePortrait = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
  
  if (isMobilePortrait) {
    // Mobile portrait: Set Day view as default and trigger Today
    dayView.classList.remove('hidden');
    dayView.classList.add('active');
    viewDayBtn.classList.add('active', 'bg-blue-500', 'text-white');
    calendarState.currentView = 'day';
    
    // Trigger Today button functionality
    calendarState.currentDate = new Date();
    calendarState.selectedDate = new Date();
    
    console.log('Mobile portrait detected: Setting Day view and Today as default');
  } else {
    // Desktop/landscape: Set Month view as default
    monthView.classList.remove('hidden');
    monthView.classList.add('active');
    viewMonthBtn.classList.add('active', 'bg-blue-500', 'text-white');
    calendarState.currentView = 'month';
  }
  
  updateCalendarTitle();
  renderCurrentView();
  
  // Add orientation change listener for mobile
  window.addEventListener('orientationchange', function() {
    setTimeout(() => {
      const isNowMobilePortrait = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
      
      if (isNowMobilePortrait && calendarState.currentView !== 'day') {
        // Switched to portrait: force Day view
        switchView('day');
        goToToday();
      }
    }, 100); // Small delay to ensure orientation change is complete

// Immediate setup as backup
(function() {
})();  });
}

// Initialize Completion Trend Chart
function initializeCompletionTrendChart() {
  console.log('Initializing completion trend chart');
  const ctx = document.getElementById('completion-trend-chart');
  if (!ctx) {
    console.log('Completion trend chart canvas not found');
    return;
  }
  
  // Sample data for the chart
  const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const weekLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
  const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const yearLabels = ['2020', '2021', '2022', '2023', '2024', '2025'];
  
  const dayData = [65, 72, 78, 75, 82, 68, 76];
  const weekData = [70, 65, 75, 62];
  const monthData = [60, 65, 70, 68, 72, 75, 73, 70, 68, 72, 74, 76];
  const yearData = [55, 60, 63, 68, 72, 75];
  
  // Default to day view
  let currentLabels = dayLabels;
  let currentData = dayData;
  
  // Create the chart with minimal white styling
  const completionChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: currentLabels,
      datasets: [{
        label: 'Completion Rate',
        data: currentData,
        borderColor: 'rgba(255, 255, 255, 0.9)',
        backgroundColor: 'rgba(255, 255, 255, 0.2)',
        borderWidth: 3,
        pointBackgroundColor: 'rgba(255, 255, 255, 1)',
        pointBorderColor: 'rgba(255, 255, 255, 1)',
        pointRadius: 5,
        pointHoverRadius: 7,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          grid: {
            color: 'rgba(255, 255, 255, 0.1)',
            borderColor: 'rgba(255, 255, 255, 0.3)'
          },
          ticks: {
            color: 'rgba(255, 255, 255, 0.8)',
            font: {
              family: "'Helvetica Neue', Arial, sans-serif",
              size: 12
            },
            callback: function(value) {
              return value + '%';
            }
          }
        },
        x: {
          grid: {
            color: 'rgba(255, 255, 255, 0.1)',
            borderColor: 'rgba(255, 255, 255, 0.3)'
          },
          ticks: {
            color: 'rgba(255, 255, 255, 0.8)',
            font: {
              family: "'Helvetica Neue', Arial, sans-serif",
              size: 12
            }
          }
        }
      },
      plugins: { whiteGlow: { enabled: true },
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(255, 255, 255, 0.9)',
          titleColor: '#2563eb',
          bodyColor: '#2563eb',
          titleFont: {
            family: "'Helvetica Neue', Arial, sans-serif",
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            family: "'Helvetica Neue', Arial, sans-serif",
            size: 14
          },
          padding: 12,
          cornerRadius: 8,
          displayColors: false,
          callbacks: {
            label: function(context) {
              return 'Completion: ' + context.parsed.y + '%';
            }
          }
        }
      }
    }
  });
  
  // Add event listeners for period buttons
  document.querySelectorAll('.completion-period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all buttons
      document.querySelectorAll('.completion-period-btn').forEach(b => {
        b.classList.remove('active');
        b.classList.remove('bg-white');
        b.classList.remove('text-blue-600');
      });
      
      // Add active class to clicked button
      this.classList.add('active');
      this.classList.add('bg-white');
      this.classList.add('text-blue-600');
      
      // Update chart data based on selected period
      const period = this.getAttribute('data-period');
      switch(period) {
        case 'day':
          currentLabels = dayLabels;
          currentData = dayData;
          break;
        case 'week':
          currentLabels = weekLabels;
          currentData = weekData;
          break;
        case 'month':
          currentLabels = monthLabels;
          currentData = monthData;
          break;
        case 'year':
          currentLabels = yearLabels;
          currentData = yearData;
          break;
      }
      
      // Update chart
      completionChart.data.labels = currentLabels;
      completionChart.data.datasets[0].data = currentData;
      completionChart.update();
    });
  });
  }
  
  // --- Glass Button Interactivity ---
  document.addEventListener('DOMContentLoaded', function() {
    // Get all glass elements
    const glassElements = document.querySelectorAll('.glass-button');
    
    // Add mousemove effect for each glass element
    glassElements.forEach(element => {
      element.addEventListener('mousemove', handleMouseMove);
      element.addEventListener('mouseleave', handleMouseLeave);
    });
    
    // Handle mouse movement over glass elements
    function handleMouseMove(e) {
      const rect = this.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // Add highlight effect
      const specular = this.querySelector('.glass-specular');
      if (specular) {
        specular.style.background = `radial-gradient(
          circle at ${x}px ${y}px,
          rgba(255,255,255,0.15) 0%,
          rgba(255,255,255,0.05) 30%,
          rgba(255,255,255,0) 60%
        )`;
      }
    }
    
    // Reset effects when mouse leaves
    function handleMouseLeave() {
      const filter = document.querySelector('#glass-distortion feDisplacementMap');
      if (filter) {
        filter.setAttribute('scale', '77');
      }
      
      const specular = this.querySelector('.glass-specular');
      if (specular) {
        specular.style.background = 'none';
      }
    }
  });

  // Beehive Grid Function
  function initializeBeehive() {
    const circles = document.getElementsByClassName("circles")[0];
    const overCircles = document.getElementsByClassName("over-circles")[0];
    
    if (!circles || !overCircles) {
      console.log('Beehive elements not found, retrying...');
      setTimeout(() => initializeBeehive(), 100);
      return;
    }
    
    // Clear any existing circles to prevent duplicates
    circles.innerHTML = '';
    
    const SW = document.getElementsByClassName("circles-wrapper")[0].offsetWidth;
    const SH = document.getElementsByClassName("circles-wrapper")[0].offsetHeight;
    let circlesArr = document.getElementsByClassName("circle");
    let cCount = circlesArr.length;

    // Center of screen (approx center of circles)
    let defX = SW / 2;
    let defY = SH / 2;
    const cDim = 100;

    // Adjust positioning for mobile portrait mode
    const isPortraitMobile = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
    if (isPortraitMobile) {
      defX = SW / 2 + 15; // Move very slightly more to the right
      defY = SH / 2 - 20; // Move up less (reduced from -40 to -20, so it's more down)
    }

    // Initialize position
    circles.style.left = `0px`;
    circles.style.top = `0px`;

    const dots = [];
    
    // Categories with their icons and example habits
    const categories = [
      { 
        id: 'heart', 
        name: 'Love', 
        icon: 'favorite', 
        color: '#EF4444',
        bgColor: '#FEE2E2',
        emoji: '‚ù§Ô∏è',
        examples: [
          { title: 'Call or message a loved one', frequency: '3x/week (Tue, Thu, Sun)', time: '18:00' },
          { title: 'Have meaningful conversation', frequency: 'Daily', time: 'Evening' },
          { title: 'Plan quality time with partner/family', frequency: 'Weekly (Saturday)', time: '19:00' },
          { title: 'Express appreciation to someone', frequency: '2x/week (Wed, Sat)', time: 'Afternoon' },
          { title: 'Reply to messages promptly', frequency: 'Daily', time: 'Throughout day' },
          { title: 'Practice acts of kindness', frequency: 'Daily', time: 'Throughout day' }
        ]
      },
      { 
        id: 'finance', 
        name: 'Finance', 
        icon: 'account_balance_wallet', 
        color: '#F59E0B',
        bgColor: '#FEF3C7',
        emoji: 'üí∞',
        examples: [
          { title: 'Track daily expenses', frequency: 'Daily', time: '20:00' },
          { title: 'Review weekly budget', frequency: 'Weekly (Sunday)', time: 'Morning' },
          { title: 'Transfer money to savings', frequency: 'Weekly (Friday)', time: '12:00' },
          { title: 'Read financial education content', frequency: 'Weekly (Wednesday)', time: 'Evening' },
          { title: 'Avoid unnecessary purchases', frequency: 'Daily', time: 'Throughout day' },
          { title: 'Review investment portfolio', frequency: 'Monthly (1st Sunday)', time: 'Afternoon' }
        ]
      },
      { 
        id: 'meditation', 
        name: 'Meditation', 
        icon: 'self_improvement', 
        color: '#6366F1',
        bgColor: '#E0E7FF',
        emoji: 'üßò‚Äç‚ôÄÔ∏è',
        examples: [
          { title: '5-minute meditation', frequency: 'Daily', time: '07:30' },
          { title: 'Evening gratitude practice', frequency: 'Daily', time: '21:30' },
          { title: 'Mindful breathing exercise', frequency: 'Daily', time: 'Morning' },
          { title: 'Body scan meditation', frequency: '3x/week (Mon, Wed, Fri)', time: '20:00' },
          { title: 'Mindful eating practice', frequency: 'Daily', time: 'Lunch' },
          { title: 'Silent walk in nature', frequency: 'Weekly (Saturday)', time: 'Afternoon' }
        ]
      },
      { 
        id: 'fitness', 
        name: 'Fitness', 
        icon: 'fitness_center', 
        color: '#EF4444',
        bgColor: '#FECACA',
        emoji: 'üí™',
        examples: [
          { title: 'Walk 7,000 steps', frequency: 'Daily', time: 'Throughout day' },
          { title: '20-minute workout', frequency: 'Daily', time: '07:00' },
          { title: 'Strength training session', frequency: '3x/week (Mon, Wed, Fri)', time: '18:00' },
          { title: 'Morning stretch routine', frequency: 'Daily', time: '07:00' },
          { title: 'Track workout progress', frequency: 'Daily', time: 'After workout' },
          { title: 'Try a new physical activity', frequency: 'Weekly (Saturday)', time: 'Morning' }
        ]
      },
      { 
        id: 'career', 
        name: 'Career', 
        icon: 'work', 
        color: '#3B82F6',
        bgColor: '#DBEAFE',
        emoji: 'üíº',
        examples: [
          { title: 'Plan daily tasks/priorities', frequency: 'Daily (Workdays)', time: '09:00' },
          { title: 'Deep work session (90 minutes)', frequency: 'Daily (Workdays)', time: '10:00' },
          { title: 'Review and reflect on accomplishments', frequency: 'Daily', time: '18:00' },
          { title: 'Skill development practice', frequency: '3x/week (Mon, Wed, Fri)', time: '16:00' },
          { title: 'Network with one professional contact', frequency: 'Weekly (Thursday)', time: 'Lunch' },
          { title: 'Update career development goals', frequency: 'Weekly (Sunday)', time: 'Evening' }
        ]
      },
      { 
        id: 'studies', 
        name: 'Studies', 
        icon: 'school', 
        color: '#2563EB',
        bgColor: '#DBEAFE',
        emoji: 'üß†',
        examples: [
          { title: 'Read 10 pages of educational book', frequency: 'Daily', time: '20:30' },
          { title: 'Practice a new skill for 15 minutes', frequency: 'Daily', time: '19:00' },
          { title: 'Watch educational video/documentary', frequency: '3x/week (Tue, Thu, Sat)', time: 'Evening' },
          { title: 'Complete online course module', frequency: 'Weekly (Sunday)', time: 'Afternoon' },
          { title: 'Learn 5 new vocabulary words', frequency: 'Daily', time: '08:30' },
          { title: 'Practice coding/programming', frequency: '4x/week (Mon, Tue, Thu, Fri)', time: '16:00' }
        ]
      },
      { 
        id: 'creativity', 
        name: 'Creativity', 
        icon: 'palette', 
        color: '#EC4899',
        bgColor: '#FCE7F3',
        emoji: 'üé®',
        examples: [
          { title: 'Sketch or draw for 15 minutes', frequency: 'Daily', time: '22:00' },
          { title: 'Write in creative journal', frequency: '4x/week (Mon, Tue, Thu, Sat)', time: 'Morning' },
          { title: 'Practice musical instrument', frequency: 'Weekly (Friday, Sunday)', time: '17:00' },
          { title: 'Explore artistic inspiration', frequency: 'Weekly (Saturday)', time: 'Afternoon' },
          { title: 'Try new creative technique/tool', frequency: 'Monthly (15th)', time: 'Weekend' },
          { title: 'Work on creative project', frequency: '3x/week (Wed, Sat, Sun)', time: 'Evening' }
        ]
      },
      { 
        id: 'food', 
        name: 'Food', 
        icon: 'restaurant', 
        color: '#10B981',
        bgColor: '#D1FAE5',
        emoji: 'ü•ó',
        examples: [
          { title: 'Drink 2L of water', frequency: 'Daily', time: 'Throughout day' },
          { title: 'Eat 5 servings of fruits/vegetables', frequency: 'Daily', time: 'With meals' },
          { title: 'Prepare healthy meal', frequency: 'Daily', time: '18:00' },
          { title: 'Track food intake', frequency: 'Daily', time: 'After meals' },
          { title: 'Avoid processed snacks', frequency: 'Daily', time: 'All day' },
          { title: 'Plan weekly meal prep', frequency: 'Weekly (Sunday)', time: '10:00' }
        ]
      },
      { 
        id: 'sleep', 
        name: 'Sleep', 
        icon: 'bedtime', 
        color: '#6b7280',
        bgColor: '#f3f4f6',
        emoji: 'üò¥',
        examples: [
          { title: 'Go to bed by 22:30', frequency: 'Daily', time: '22:30' },
          { title: 'Wake up at consistent time', frequency: 'Daily', time: '07:00' },
          { title: 'Avoid screens 1 hour before bed', frequency: 'Daily', time: '21:30' },
          { title: 'Track sleep quality', frequency: 'Daily', time: 'Morning' },
          { title: 'Create relaxing bedtime routine', frequency: 'Daily', time: '22:00' },
          { title: 'Keep bedroom cool and dark', frequency: 'Daily', time: 'Before sleep' }
        ]
      },
      { 
        id: 'wellness', 
        name: 'Wellness', 
        icon: 'spa', 
        color: '#10b981',
        bgColor: '#d1fae5',
        emoji: 'üåø',
        examples: [
          { title: 'Practice deep breathing', frequency: 'Daily', time: 'Morning & Evening' },
          { title: 'Skincare routine', frequency: 'Daily', time: 'Morning & Night' },
          { title: 'Take relaxing bath/shower', frequency: '3x/week (Mon, Wed, Fri)', time: 'Evening' },
          { title: 'Spend time in nature', frequency: 'Weekly (Sunday)', time: 'Morning' },
          { title: 'Practice self-massage', frequency: '2x/week (Wed, Sat)', time: 'Before bed' },
          { title: 'Digital detox period', frequency: 'Daily', time: '19:00-21:00' }
        ]
      },
      { 
        id: 'exploration', 
        name: 'Exploration', 
        icon: 'explore', 
        color: '#06b6d4',
        bgColor: '#cffafe',
        emoji: '‚úàÔ∏è',
        examples: [
          { title: 'Try something new', frequency: 'Weekly (Friday)', time: 'Afternoon' },
          { title: 'Explore new neighborhood/area', frequency: 'Weekly (Saturday)', time: 'Morning' },
          { title: 'Visit new restaurant/cafe', frequency: 'Weekly (Sunday)', time: 'Lunch' },
          { title: 'Learn about different culture', frequency: '2x/week (Tue, Thu)', time: 'Evening' },
          { title: 'Plan future travel/adventure', frequency: 'Weekly (Wednesday)', time: 'Evening' },
          { title: 'Take different route to work', frequency: 'Daily', time: 'Commute' }
        ]
      },
      { 
        id: 'joy', 
        name: 'Joy / Games', 
        icon: 'sports_esports', 
        color: '#8B5CF6',
        bgColor: '#EDE9FE',
        emoji: 'üéÆ',
        examples: [
          { title: 'Do something purely for fun', frequency: 'Daily', time: 'Evening' },
          { title: 'Play games (video/board/card)', frequency: '3x/week (Mon, Wed, Sun)', time: '20:00' },
          { title: 'Watch comedy/funny videos', frequency: 'Daily', time: '21:00' },
          { title: 'Dance to favorite music', frequency: 'Daily', time: 'Morning' },
          { title: 'Plan fun activity with friends', frequency: 'Weekly (Friday)', time: 'Evening' },
          { title: 'Engage in playful hobby', frequency: '4x/week (Tue, Thu, Sat, Sun)', time: 'Afternoon' }
        ]
      },
      { 
        id: 'social', 
        name: 'Social', 
        icon: 'group', 
        color: '#EC4899',
        bgColor: '#FCE7F3',
        emoji: 'üë•',
        examples: [
          { title: 'Meet up with friends', frequency: 'Weekly (Saturday)', time: 'Afternoon' },
          { title: 'Join social group/club activity', frequency: '2x/week (Wed, Sat)', time: 'Evening' },
          { title: 'Attend networking event', frequency: 'Monthly (2nd Friday)', time: '18:00' },
          { title: 'Call a friend or family member', frequency: '3x/week (Tue, Thu, Sun)', time: '19:00' },
          { title: 'Plan social gathering', frequency: 'Monthly (Last Saturday)', time: 'Morning' },
          { title: 'Join community volunteering', frequency: 'Weekly (Sunday)', time: '10:00' }
        ]
      },
      { 
        id: 'relaxation', 
        name: 'Relaxation', 
        icon: 'beach_access', 
        color: '#C0C9EE',
        bgColor: '#F3F4F6',
        emoji: 'üåä',
        examples: [
          { title: 'Take a relaxing bath', frequency: '3x/week (Mon, Wed, Fri)', time: '21:00' },
          { title: 'Listen to calming music', frequency: 'Daily', time: 'Evening' },
          { title: 'Practice progressive muscle relaxation', frequency: 'Daily', time: '22:00' },
          { title: 'Spend time in nature', frequency: 'Weekly (Sunday)', time: 'Morning' },
          { title: 'Read for pleasure', frequency: 'Daily', time: '20:30' },
          { title: 'Watch sunset/sunrise', frequency: 'Weekly (Friday)', time: 'Evening' }
        ]
      },
      { 
        id: 'pet', 
        name: 'Pet Care', 
        icon: 'pets', 
        color: '#87CEEB',
        bgColor: '#E0F6FF',
        emoji: 'üêæ',
        examples: [
          { title: 'Walk the dog', frequency: 'Daily', time: '07:00 & 18:00' },
          { title: 'Feed pets', frequency: 'Daily', time: '08:00 & 17:00' },
          { title: 'Clean litter box/cage', frequency: 'Daily', time: '19:00' },
          { title: 'Play with pets', frequency: 'Daily', time: 'Afternoon' },
          { title: 'Groom pets', frequency: 'Weekly (Saturday)', time: '10:00' },
          { title: 'Vet checkup/health care', frequency: 'Monthly (1st week)', time: 'Morning' }
        ]
      },
      { 
        id: 'hygiene', 
        name: 'Hygiene', 
        icon: 'clean_hands', 
        color: '#C9E9D2',
        bgColor: '#F0F9F2',
        emoji: 'üßº',
        examples: [
          { title: 'Brush teeth', frequency: 'Daily', time: '08:00 & 22:00' },
          { title: 'Take shower/bath', frequency: 'Daily', time: '19:00' },
          { title: 'Wash hands regularly', frequency: 'Daily', time: 'Throughout day' },
          { title: 'Floss teeth', frequency: 'Daily', time: '22:30' },
          { title: 'Apply skincare routine', frequency: 'Daily', time: 'Morning & Night' },
          { title: 'Wash hair', frequency: '3x/week (Mon, Wed, Fri)', time: 'Evening' }
        ]
      }
    ];

    const genDots = (moreXY = 0) => {
      // Adjust spacing based on screen size
      const isMobile = window.innerWidth <= 768;
      const isPortraitMobile = isMobile && window.innerHeight > window.innerWidth;
      
      // Reduce spacing for mobile portrait mode
      let spacingMultiplier = 1;
      if (isPortraitMobile) {
        spacingMultiplier = 0.6; // 40% tighter spacing for mobile portrait
      } else if (isMobile) {
        spacingMultiplier = 0.8; // 20% tighter spacing for mobile landscape
      }
      
      const adjustedCDim = cDim * spacingMultiplier;
      
      // Extend grid boundaries significantly to allow all items to be centered
      // Calculate how much extra space we need based on container size and number of categories
      const extraSpace = Math.max(SW, SH) * 1.5; // 1.5x container size for better centering freedom
      
      let dotX = -adjustedCDim * 2 - moreXY - extraSpace;
      let dotY = -adjustedCDim - moreXY - extraSpace;
      let line = 1;
      
      // Generate a much larger grid to ensure all items can be centered
      while (dotY - moreXY < SH + extraSpace) {
        dotX += adjustedCDim;
        let dotXY = Math.sqrt(
          (defX + adjustedCDim - dotX) ** 2 + (defY + adjustedCDim - dotY) ** 2
        );
        dots.push({ X: dotX - adjustedCDim / 2, Y: dotY - adjustedCDim / 2, offset: dotXY });
        if (dotX - moreXY > SW + extraSpace) {
          if (line % 2 == 0) dotX = -adjustedCDim * 2 - moreXY - extraSpace;
          else dotX = -adjustedCDim * 1.5 - moreXY - extraSpace;
          line += 1;
          dotY += adjustedCDim;
        }
      }
      dots.sort((a, b) => a.offset - b.offset);
    };

    const drawCircles = (limit = cCount) => {
      circlesArr = document.getElementsByClassName("circle");
      cCount = circlesArr.length;
      if (limit > cCount) limit = cCount;
      
      // Simple positioning - just place circles at their dot positions
      for (let i = 0; i < limit; i++) {
        if (i < dots.length) {
          circlesArr[i].style.left = `${dots[i].X}px`;
          circlesArr[i].style.top = `${dots[i].Y}px`;
        }
      }
    };

    let dragStartX, dragStartY;
    let newX = 0;
    let newY = 0;
    let isDragging = false;
    let dragThreshold = 8; // pixels - optimized for click detection
    let dragStartTime = 0;
    let isMouseDown = false;

    overCircles.addEventListener("mousedown", (e) => {
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      isDragging = false;
      isMouseDown = true;
      dragStartTime = Date.now();
      overCircles.addEventListener("mousemove", dragCircles);
    });

    overCircles.addEventListener("mouseup", (e) => {
      overCircles.removeEventListener("mousemove", dragCircles);
      
      // Handle click if not dragging
      if (!isDragging && isMouseDown) {
        handleContainerClick(e);
      }
      
      isDragging = false;
      isMouseDown = false;
    });

    overCircles.addEventListener("touchstart", (e) => {
      e.preventDefault();
      dragStartX = e.touches[0].clientX;
      dragStartY = e.touches[0].clientY;
      isDragging = false;
      isMouseDown = true;
      dragStartTime = Date.now();
      overCircles.addEventListener("touchmove", dragCircles);
    }, { passive: false });

    overCircles.addEventListener("touchend", (e) => {
      overCircles.removeEventListener("touchmove", dragCircles);
      
      // Handle touch click if not dragging
      if (!isDragging && isMouseDown) {
        handleContainerClick(e.changedTouches[0]);
      }
      
      setTimeout(() => {
        isDragging = false;
        isMouseDown = false;
      }, 50); // Reduced delay for better responsiveness
    });

    let lastDragTime = 0;
    const dragThrottleDelay = window.innerWidth <= 768 && window.innerHeight > window.innerWidth ? 16 : 8; // 60fps for mobile vertical, 120fps for others

    const dragCircles = (e) => {
      const currentTime = Date.now();
      const isMobileVertical = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
      
      // Throttle drag events for mobile vertical to improve performance
      if (isMobileVertical && currentTime - lastDragTime < dragThrottleDelay) {
        return;
      }
      lastDragTime = currentTime;
      
      const currentX = e.touches ? e.touches[0].clientX : e.clientX;
      const currentY = e.touches ? e.touches[0].clientY : e.clientY;
      const deltaX = Math.abs(currentX - dragStartX);
      const deltaY = Math.abs(currentY - dragStartY);
      
      // Only start dragging if moved beyond threshold
      if (!isDragging && (deltaX > dragThreshold || deltaY > dragThreshold)) {
        isDragging = true;
      }
      
      if (isDragging) {
        // Reduce frequency of resizeCircles calls on mobile vertical
        if (!isMobileVertical || currentTime % 2 === 0) {
          resizeCircles();
        }
        
        let posLeft = rPx(circles.style.left);
        let posTop = rPx(circles.style.top);
        let proposedX = posLeft + currentX - dragStartX;
        let proposedY = posTop + currentY - dragStartY;

        // Calculate boundary constraints with mobile-specific logic
        const containerRect = overCircles.getBoundingClientRect();
        const containerWidth = containerRect.width;
        const containerHeight = containerRect.height;
        const isMobile = window.innerWidth <= 768;
        const isSmallMobile = window.innerWidth <= 640;
        const isPortraitMobile = isMobile && window.innerHeight > window.innerWidth;
        
        // Calculate the bounds of all circles based on their actual positions
        let minCircleX = Infinity, maxCircleX = -Infinity;
        let minCircleY = Infinity, maxCircleY = -Infinity;
        
        // Determine circle size based on screen size
        let circleSize = 120; // Desktop default (updated)
        if (isPortraitMobile) {
          circleSize = 60; // Portrait mobile (updated)
        } else if (isSmallMobile) {
          circleSize = 70; // Small mobile (updated)
        } else if (isMobile) {
          circleSize = 80; // Mobile landscape (updated)
        }
        
        for (let i = 0; i < circlesArr.length; i++) {
          const circle = circlesArr[i];
          const circleLeft = rPx(circle.style.left);
          const circleTop = rPx(circle.style.top);
          
          // Calculate absolute positions with proposed offset
          const absoluteLeft = circleLeft + proposedX;
          const absoluteTop = circleTop + proposedY;
          
          minCircleX = Math.min(minCircleX, absoluteLeft);
          maxCircleX = Math.max(maxCircleX, absoluteLeft + circleSize);
          minCircleY = Math.min(minCircleY, absoluteTop);
          maxCircleY = Math.max(maxCircleY, absoluteTop + circleSize);
        }
        
        // Apply more relaxed boundary constraints to allow edge items to be centered
        const margin = isMobile ? 8 : 20;
        let finalX = proposedX;
        let finalY = proposedY;
        
        // Calculate how much space we need to allow edge items to reach center
        const centerBuffer = Math.max(containerWidth, containerHeight) * 0.6;
        
        if (isPortraitMobile) {
          // For portrait mobile: allow more movement but keep at least one item visible
          const minAllowedX = -centerBuffer;
          const maxAllowedX = containerWidth + centerBuffer - circleSize;
          const minAllowedY = -centerBuffer;
          const maxAllowedY = containerHeight + centerBuffer - circleSize;
          
          if (maxCircleX < margin) {
            finalX = proposedX + (margin - maxCircleX);
          }
          if (minCircleX > containerWidth - margin) {
            finalX = proposedX - (minCircleX - (containerWidth - margin));
          }
          if (maxCircleY < margin) {
            finalY = proposedY + (margin - maxCircleY);
          }
          if (minCircleY > containerHeight - margin) {
            finalY = proposedY - (minCircleY - (containerHeight - margin));
          }
        } else if (isMobile) {
          // For landscape mobile: more freedom for centering
          const minAllowedX = -centerBuffer;
          const maxAllowedX = containerWidth + centerBuffer - circleSize;
          const minAllowedY = -centerBuffer * 0.8;
          const maxAllowedY = containerHeight + centerBuffer * 0.8 - circleSize;
          
          if (maxCircleX < margin) {
            finalX = proposedX + (margin - maxCircleX);
          }
          if (minCircleX > containerWidth - margin) {
            finalX = proposedX - (minCircleX - (containerWidth - margin));
          }
          if (maxCircleY < margin / 2) {
            finalY = proposedY + (margin / 2 - maxCircleY);
          }
          if (minCircleY > containerHeight - margin / 2) {
            finalY = proposedY - (minCircleY - (containerHeight - margin / 2));
          }
        } else {
          // For desktop/tablet: maximum freedom for centering all items
          const minAllowedX = -centerBuffer;
          const maxAllowedX = containerWidth + centerBuffer - circleSize;
          const minAllowedY = -centerBuffer;
          const maxAllowedY = containerHeight + centerBuffer - circleSize;
          
          // Only constrain if ALL items would go outside the extended bounds
          if (maxCircleX < margin) {
            finalX = proposedX + (margin - maxCircleX);
          }
          if (minCircleX > containerWidth - margin) {
            finalX = proposedX - (minCircleX - (containerWidth - margin));
          }
          if (maxCircleY < margin) {
            finalY = proposedY + (margin - maxCircleY);
          }
          if (minCircleY > containerHeight - margin) {
            finalY = proposedY - (minCircleY - (containerHeight - margin));
          }
        }
        
        // Use the calculated constrained position
        newX = finalX;
        newY = finalY;

        circles.style.left = `${newX}px`;
        circles.style.top = `${newY}px`;
        dragStartX = currentX;
        dragStartY = currentY;
      }
    };

    const resizeCircles = () => {
      let closestCategory = null;
      let minDistance = Infinity;
      
      const containerWidth = SW;
      const containerHeight = SH;
      const isMobileVertical = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
      
              // Reduced wrap buffer so items appear earlier from opposite side
        const wrapBuffer = isMobileVertical ? 50 : 80;
      
      // Cache center calculations
      const centerX = defX - cDim / 2;
      const centerY = defY - cDim / 2;
      
      for (let i = 0; i < circlesArr.length; i++) {
        const c1 = circlesArr[i];
        let baseX = rPx(c1.style.left);
        let baseY = rPx(c1.style.top);
        let cirX = baseX + newX;
        let cirY = baseY + newY;
        
        // Lightweight wraparound - just teleport to opposite side
        if (cirX > containerWidth + wrapBuffer) {
          // Went off right edge, teleport to left side
          baseX -= (containerWidth + wrapBuffer * 2);
          c1.style.left = `${baseX}px`;
          cirX = baseX + newX;
        } else if (cirX < -wrapBuffer) {
          // Went off left edge, teleport to right side
          baseX += (containerWidth + wrapBuffer * 2);
          c1.style.left = `${baseX}px`;
          cirX = baseX + newX;
        }
        
        if (cirY > containerHeight + wrapBuffer) {
          // Went off bottom edge, teleport to top side
          baseY -= (containerHeight + wrapBuffer * 2);
          c1.style.top = `${baseY}px`;
          cirY = baseY + newY;
        } else if (cirY < -wrapBuffer) {
          // Went off top edge, teleport to bottom side
          baseY += (containerHeight + wrapBuffer * 2);
          c1.style.top = `${baseY}px`;
          cirY = baseY + newY;
        }
        
        // Simple distance calculation
        const deltaX = centerX - cirX;
        const deltaY = centerY - cirY;
        let cirXY = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
        
        // Use appropriate scaling function
        let cirPower = isMobileVertical ? fastScaleDistance(cirXY) : scaleDistance(cirXY);
        c1.style.transform = `scale(${cirPower})`;
        
        // Track closest category
        if (cirXY < minDistance) {
          minDistance = cirXY;
          const categoryId = c1.getAttribute('data-category');
          closestCategory = categories.find(cat => cat.id === categoryId);
        }
      }
      
      // Update category indicator
      if (closestCategory) {
        updateCategoryIndicator(closestCategory);
      }
    };

    const updateCategoryIndicator = (category) => {
      // Update mobile category indicator
      const categoryNameElement = document.getElementById('current-category-name');
      if (categoryNameElement && category) {
        categoryNameElement.textContent = category.name;
        categoryNameElement.style.color = category.color;
      }
      
      // Update desktop category indicator
      const categoryNameDesktopElement = document.getElementById('current-category-name-desktop');
      if (categoryNameDesktopElement && category) {
        categoryNameDesktopElement.textContent = category.name;
        categoryNameDesktopElement.style.color = category.color;
      }
      
      // Update desktop horizontal category indicator with gradient
      const categoryNameDesktopHorizontalElement = document.getElementById('current-category-name-desktop-horizontal');
      if (categoryNameDesktopHorizontalElement && category) {
        categoryNameDesktopHorizontalElement.textContent = category.name;
        
        // Remove all existing gradient classes
        categoryNameDesktopHorizontalElement.classList.remove(
          'category-gradient-heart', 'category-gradient-finance', 'category-gradient-meditation', 
          'category-gradient-fitness', 'category-gradient-career', 'category-gradient-studies', 
          'category-gradient-creativity', 'category-gradient-food', 'category-gradient-sleep', 
          'category-gradient-wellness', 'category-gradient-exploration', 'category-gradient-joy',
          'category-gradient-social', 'category-gradient-relaxation', 'category-gradient-pet', 'category-gradient-hygiene'
        );
        
        // Add the new gradient class based on category
        categoryNameDesktopHorizontalElement.classList.add(`category-gradient-${category.id}`);
      }
      
      // Update section border color
      const heroSection = document.getElementById('habits-hero-section');
      if (heroSection && category) {
        // Remove all existing border classes
        heroSection.classList.remove(
          'border-heart', 'border-finance', 'border-meditation', 'border-fitness',
          'border-career', 'border-studies', 'border-creativity', 'border-food',
          'border-sleep', 'border-wellness', 'border-exploration', 'border-joy',
          'border-social', 'border-relaxation', 'border-pet', 'border-hygiene'
        );
        
        // Add the new border class based on category
        heroSection.classList.add(`border-${category.id}`);
      }
    };

    const handleContainerClick = (event) => {
      // Get click position relative to the container
      const containerRect = overCircles.getBoundingClientRect();
      const clickX = event.clientX - containerRect.left;
      const clickY = event.clientY - containerRect.top;
      
      // Find the closest circle to the click position
      let closestCircle = null;
      let minDistance = Infinity;
      
      for (let i = 0; i < circlesArr.length; i++) {
        const circle = circlesArr[i];
        const circleRect = circle.getBoundingClientRect();
        const circleX = circleRect.left + circleRect.width / 2 - containerRect.left;
        const circleY = circleRect.top + circleRect.height / 2 - containerRect.top;
        
        const distance = Math.sqrt((clickX - circleX) ** 2 + (clickY - circleY) ** 2);
        
        // Check if click is within circle bounds (considering scale)
        const circleRadius = circleRect.width / 2;
        if (distance <= circleRadius && distance < minDistance) {
          minDistance = distance;
          closestCircle = circle;
        }
      }
      
      // Trigger click on the closest circle
      if (closestCircle) {
        const categoryId = closestCircle.getAttribute('data-category');
        const category = categories.find(cat => cat.id === categoryId);
        if (category) {
          // Check if we should center or maintain position
          const isPortraitMobile = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
          
          if (isPortraitMobile) {
            // For portrait mobile: don't center, just show popup immediately and maintain scroll position
            // Update category indicator
            updateCategoryIndicator(category);
            
            // Add visual feedback to clicked circle
            const currentTransform = closestCircle.style.transform || '';
            closestCircle.style.transform = `${currentTransform} scale(0.9)`;
            
            // Show popup immediately without centering
            setTimeout(() => {
              closestCircle.style.transform = currentTransform;
              selectCategory(category);
            }, 150); // Shorter delay for mobile
          } else {
            // For desktop/tablet: center the clicked item first
            const categoryIndex = categories.findIndex(cat => cat.id === categoryId);
            
            if (dots[categoryIndex]) {
              const targetDot = dots[categoryIndex];
              newX = -(targetDot.X - defX + cDim / 2);
              newY = -(targetDot.Y - defY + cDim / 2);
              
              // Animate to center position
              circles.style.transition = 'left 0.5s cubic-bezier(0.25, 0.1, 0.25, 1), top 0.5s cubic-bezier(0.25, 0.1, 0.25, 1)';
              circles.style.left = `${newX}px`;
              circles.style.top = `${newY}px`;
              
              // Update category indicator
              updateCategoryIndicator(category);
              
              // Add visual feedback to clicked circle
              const currentTransform = closestCircle.style.transform || '';
              closestCircle.style.transform = `${currentTransform} scale(0.9)`;
              
              // After centering animation, show popup
              setTimeout(() => {
                closestCircle.style.transform = currentTransform;
                selectCategory(category);
                
                // Remove transition for future drag operations
                setTimeout(() => {
                  circles.style.transition = '';
                }, 100);

// Immediate setup as backup
(function() {
})();              }, 500);
            } else {
              // Fallback if dot not found
              selectCategory(category);
            }
          }
        }
      }
    };

    // Fast scaling function for mobile vertical (optimized performance)
    function fastScaleDistance(x) {
      const minScale = 0.4;
      const maxScale = 1.8;
      const maxInput = 200;
      
      // Simple linear interpolation for better performance
      const normalizedDistance = Math.min(x / maxInput, 1);
      const scale = minScale + (maxScale - minScale) * (1 - normalizedDistance);
      
      return Math.max(minScale, Math.min(maxScale, scale)).toFixed(2);
    }

    function scaleDistance(x) {
      // Enhanced zoom levels based on device type with smoother transitions
      const isMobile = window.innerWidth <= 768;
      const isPortraitMobile = isMobile && window.innerHeight > window.innerWidth;
      
      let minScale, maxScale, maxInput;
      
      if (isPortraitMobile) {
        // Smooth zoom for mobile portrait
        minScale = 0.35;
        maxScale = 2.0;
        maxInput = 220;
      } else if (isMobile) {
        // Smooth zoom for mobile landscape
        minScale = 0.4;
        maxScale = 1.8;
        maxInput = 280;
      } else {
        // Smooth zoom for desktop/tablet
        minScale = 0.45;
        maxScale = 1.5;
        maxInput = 320;
      }

      // Normalize distance to 0-1 range
      const normalizedDistance = Math.min(x / maxInput, 1);
      
      // Apply smooth cubic easing function for natural zoom feel
      const easingPower = 2.5; // Smoother curve
      const easedDistance = 1 - Math.pow(normalizedDistance, 1 / easingPower);
      
      // Calculate final scale with smooth interpolation
      const finalScale = minScale + (maxScale - minScale) * easedDistance;
      
      return Math.max(minScale, Math.min(maxScale, finalScale)).toFixed(3);
    }

    const rPx = (str) => {
      return parseInt(str.replace("px", "")) || 0;
    };

    const spawnCircles = (count = categories.length) => {
      // Create only the original set of circles - no duplicates!
      for (let i = 0; i < count; i++) {
        const category = categories[i % categories.length];
        let divElement = document.createElement("div");
        divElement.setAttribute("class", "circle");
        divElement.setAttribute("data-category", category.id);
        divElement.setAttribute("data-original-index", i.toString());
        
        divElement.innerHTML = `
          <div class="category-icon">
            <span class="material-icons">${category.icon}</span>
        </div>
        `;
        
        circles.appendChild(divElement);
      }
    };

    const ensureInfiniteGrid = () => {
      // Check if we need more circles to fill the extended area
      const containerWidth = SW;
      const containerHeight = SH;
      const currentCircleCount = circlesArr.length;
      const categoriesCount = categories.length;
      
      // Calculate how many grids we might need based on current offset
      const maxOffsetX = Math.abs(newX);
      const maxOffsetY = Math.abs(newY);
      const gridsNeededX = Math.ceil(maxOffsetX / containerWidth) + 2;
      const gridsNeededY = Math.ceil(maxOffsetY / containerHeight) + 2;
      const totalGridsNeeded = gridsNeededX * gridsNeededY;
      const circlesNeeded = totalGridsNeeded * categoriesCount;
      
      // Add more circles if needed
      if (circlesNeeded > currentCircleCount) {
        const circlesToAdd = circlesNeeded - currentCircleCount;
        for (let i = 0; i < circlesToAdd; i++) {
          const categoryIndex = (currentCircleCount + i) % categoriesCount;
          const category = categories[categoryIndex];
          
          let divElement = document.createElement("div");
          divElement.setAttribute("class", "circle");
          divElement.setAttribute("data-category", category.id);
          divElement.setAttribute("data-original-index", categoryIndex.toString());
          
          divElement.innerHTML = `
            <div class="category-icon">
              <span class="material-icons">${category.icon}</span>
              </button>
        </div>
          `;
          
          circles.appendChild(divElement);
          
          // Position the new circle in an available dot position
          const dotIndex = (currentCircleCount + i) % dots.length;
          if (dotIndex < dots.length) {
            divElement.style.left = `${dots[dotIndex].X}px`;
            divElement.style.top = `${dots[dotIndex].Y}px`;
          }
        }
        
        // Update circlesArr reference
        circlesArr = document.getElementsByClassName("circle");
      }
    };

    const selectCategory = (category) => {
      // Start step-by-step habit creation flow
      startHabitFlow(category);
    };

    // Step-by-step habit creation variables
    let currentStep = 1;
    let selectedCategory = null;
    let habitData = {
      name: '',
      frequency: '',
      schedule: {}
    };

    // Start the habit creation flow
    const startHabitFlow = (category) => {
      selectedCategory = category;
      currentStep = 1;
      habitData = {
        name: '',
        frequency: '',
        schedule: {}
      };
      
      // Set CSS custom properties for category colors
      const root = document.documentElement;
      root.style.setProperty('--category-color', category.color);
      root.style.setProperty('--category-color-rgb', category.color.replace('#', '').match(/.{2}/g).map(hex => parseInt(hex, 16)).join(', '));
      
      // Replace beehive container content with step 1
      showStep1();
    };

    // Step 1: Name and Frequency (made global)
    window.showStep1 = () => {
      const heroSection = document.getElementById('habits-hero-section');
      if (!heroSection) return;
      
      heroSection.innerHTML = `
        <div class="habit-step-container">
          <div class="step-header">
            <div class="step-indicator">
              <div class="step-number active">1</div>
              <div class="step-connector"></div>
              <div class="step-number">2</div>
              </button>
        </div>
            <h2 class="step-title">Create ${selectedCategory.name} Habit</h2>
            <p class="step-subtitle">Choose a name and frequency</p>
        </div>
          
          <div class="step-content">
            <div class="category-badge">
              <span class="material-icons" style="color: ${selectedCategory.color}">${selectedCategory.icon}</span>
              <span>${selectedCategory.name}</span>
              </button>
        </div>
            
            <div class="form-group">
              <label class="form-label">Habit Name</label>
              <input type="text" class="form-input" id="habit-name-input" placeholder="Enter your habit name..." maxlength="100">
              </button>
        </div>
            
            <div class="form-group">
              <label class="form-label">Frequency</label>
              <div class="frequency-options">
                <button class="frequency-btn" data-frequency="daily">
                  <img src="https://img.icons8.com/?size=100&id=LLAcm9s81hH9&format=png&color=000000" alt="Daily">
                  <span>Daily</span>
                <button class="frequency-btn" data-frequency="weekly">
                  <img src="https://img.icons8.com/?size=100&id=79394&format=png&color=000000" alt="Weekly">
                  <span>Weekly</span>
                <button class="frequency-btn" data-frequency="monthly">
                  <img src="https://img.icons8.com/?size=100&id=111070&format=png&color=000000" alt="Monthly">
                  <span>Monthly</span>
                <button class="frequency-btn" data-frequency="custom">
                  <img src="https://img.icons8.com/?size=100&id=23&format=png&color=000000" alt="Custom Dates">
                  <span>Custom Dates</span>
                </button>
        </div>
              </button>
        </div>
        </div>
          
          <div class="step-actions">
            <button class="step-btn step-btn-back" onclick="resetToCategories()">
              <span class="material-icons text-lg md:text-xl">arrow_back</span>
            Back
          </button>
              Back to Categories
            <button class="step-btn step-btn-next" id="step1-next" disabled>
              Next
              <span class="material-icons">arrow_forward</span>
        </div>
        </div>
      `;
      
      setupStep1Listeners();
    };

    // Setup Step 1 Event Listeners
    const setupStep1Listeners = () => {
      const nameInput = document.getElementById('habit-name-input');
      const frequencyBtns = document.querySelectorAll('.frequency-btn');
      const nextBtn = document.getElementById('step1-next');
      
      nameInput.addEventListener('input', validateStep1);
      
      frequencyBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          // Remove active class from all buttons
          frequencyBtns.forEach(b => b.classList.remove('active'));
          // Add active class to clicked button
          btn.classList.add('active');
          habitData.frequency = btn.dataset.frequency;
          validateStep1();
        });
      });
      
      nextBtn.addEventListener('click', () => {
        if (nameInput.value.trim() && habitData.frequency) {
          habitData.name = nameInput.value.trim();
          showStep2();
        }
      });
      
      // Restore previously entered name and frequency if they exist
      if (habitData.name) {
        nameInput.value = habitData.name;
      }
      
      if (habitData.frequency) {
        const targetFrequencyBtn = document.querySelector(`.frequency-btn[data-frequency="${habitData.frequency}"]`);
        if (targetFrequencyBtn) {
          frequencyBtns.forEach(b => b.classList.remove('active'));
          targetFrequencyBtn.classList.add('active');
        }
      }
      
      validateStep1();
      
      function validateStep1() {
        const isValid = nameInput.value.trim() && habitData.frequency;
        nextBtn.disabled = !isValid;
        nextBtn.classList.toggle('disabled', !isValid);
      }
    };

    // Step 2: Schedule Details
    const showStep2 = () => {
      const heroSection = document.getElementById('habits-hero-section');
      if (!heroSection) return;
      
      let scheduleContent = '';
      
      if (habitData.frequency === 'daily') {
        scheduleContent = `
          <div class="schedule-section">
            <label class="form-label">Time of Day</label>
            <div class="time-options">
              <button class="time-btn" data-time="morning">
                <img src="https://img.icons8.com/?size=100&id=118932&format=png&color=000000" alt="Morning" class="time-icon">
                <span>Morning</span>
              <button class="time-btn" data-time="afternoon">
                <img src="https://img.icons8.com/?size=100&id=GIywaBFJCJiI&format=png&color=000000" alt="Afternoon" class="time-icon">
                <span>Afternoon</span>
              <button class="time-btn" data-time="evening">
                <img src="https://img.icons8.com/?size=100&id=111581&format=png&color=000000" alt="Evening" class="time-icon">
                <span>Evening</span>
              <button class="time-btn" data-time="night">
                <img src="https://img.icons8.com/?size=100&id=54382&format=png&color=000000" alt="Night" class="time-icon">
                <span>Night</span>
              </button>
        </div>
            <div class="specific-time-container" id="specific-time-container">
              <label class="form-label">Set Your Own Time</label>
              <div class="time-input-wrapper">
                <input type="time" class="form-input time-input-enhanced" id="specific-time-input">
                </button>
        </div>
              </button>
        </div>
        </div>
        `;
      } else if (habitData.frequency === 'weekly') {
        scheduleContent = `
          <div class="schedule-section">
            <label class="form-label">Days of the Week</label>
            <div class="days-grid">
              <button class="day-btn" data-day="monday">Mon</button>
              <button class="day-btn" data-day="tuesday">Tue</button>
              <button class="day-btn" data-day="wednesday">Wed</button>
              <button class="day-btn" data-day="thursday">Thu</button>
              <button class="day-btn" data-day="friday">Fri</button>
              <button class="day-btn" data-day="saturday">Sat</button>
              <button class="day-btn" data-day="sunday">Sun</button>
              </button>
        </div>
            
            <div class="time-section" id="weekly-time-section" style="display: none;">
              <label class="form-label">Time of Day</label>
              <div class="time-options">
                <button class="time-btn" data-time="morning">
                  <img src="https://img.icons8.com/?size=100&id=118932&format=png&color=000000" alt="Morning" class="time-icon">
                  <span>Morning</span>
                <button class="time-btn" data-time="afternoon">
                  <img src="https://img.icons8.com/?size=100&id=GIywaBFJCJiI&format=png&color=000000" alt="Afternoon" class="time-icon">
                  <span>Afternoon</span>
                <button class="time-btn" data-time="evening">
                  <img src="https://img.icons8.com/?size=100&id=111581&format=png&color=000000" alt="Evening" class="time-icon">
                  <span>Evening</span>
                <button class="time-btn" data-time="night">
                  <img src="https://img.icons8.com/?size=100&id=54382&format=png&color=000000" alt="Night" class="time-icon">
                  <span>Night</span>
                </button>
        </div>
              <div class="specific-time-container" id="weekly-specific-time-container">
                <label class="form-label">Set Your Own Time</label>
                <div class="time-input-wrapper">
                  <input type="time" class="form-input time-input-enhanced" id="weekly-specific-time-input">
        </div>
                </button>
        </div>
              </button>
        </div>
        </div>
        `;
      } else if (habitData.frequency === 'monthly') {
        scheduleContent = `
          <div class="schedule-section">
            <label class="form-label">Monthly Recurrence</label>
            <div class="monthly-options">
              <button class="monthly-btn" data-type="weekday">
                <span class="material-icons">view_week</span>
                <span>Weekly Pattern</span>
                <small>First Monday, Second Tuesday, etc.</small>
              <button class="monthly-btn" data-type="multiple">
                <span class="material-icons">event_repeat</span>
                <span>Specific Dates</span>
                <small>Multiple days per month</small>
              </button>
        </div>
            
            <div class="monthly-details" id="monthly-details" style="display: none;">
              <!-- Content will be dynamically populated -->
              </button>
        </div>
            
            <div class="time-section" id="monthly-time-section" style="display: none;">
              <label class="form-label">Time of Day</label>
              <div class="time-options">
                <button class="time-btn" data-time="morning">
                  <img src="https://img.icons8.com/?size=100&id=118932&format=png&color=000000" alt="Morning" class="time-icon">
                  <span>Morning</span>
                <button class="time-btn" data-time="afternoon">
                  <img src="https://img.icons8.com/?size=100&id=GIywaBFJCJiI&format=png&color=000000" alt="Afternoon" class="time-icon">
                  <span>Afternoon</span>
                <button class="time-btn" data-time="evening">
                  <img src="https://img.icons8.com/?size=100&id=111581&format=png&color=000000" alt="Evening" class="time-icon">
                  <span>Evening</span>
                <button class="time-btn" data-time="night">
                  <img src="https://img.icons8.com/?size=100&id=54382&format=png&color=000000" alt="Night" class="time-icon">
                  <span>Night</span>
                </button>
        </div>
              <div class="specific-time-container" id="monthly-specific-time-container">
                <label class="form-label">Set Your Own Time</label>
                <div class="time-input-wrapper">
                  <input type="time" class="form-input time-input-enhanced" id="monthly-specific-time-input">
        </div>
                </button>
        </div>
              </button>
        </div>
        </div>
        `;
      } else if (habitData.frequency === 'custom') {
        scheduleContent = `
          <div class="schedule-section">
            <label class="form-label">Custom Schedule Options</label>
            <div class="custom-options">
              <button class="custom-btn" data-type="pattern">
                <span class="material-icons">repeat</span>
                <span>Recurrence Pattern</span>
                <small>Recurring schedule pattern</small>
              <button class="custom-btn" data-type="dates">
                <span class="material-icons">calendar_month</span>
                <span>Custom Dates</span>
                <small>Pick specific dates</small>
              </button>
        </div>
            
            <div class="custom-details" id="custom-details" style="display: none;">
              <!-- Content will be dynamically populated -->
              </button>
        </div>
            
            <div class="time-section" id="custom-time-section" style="display: none;">
              <label class="form-label">Time of Day</label>
              <div class="time-options">
                <button class="time-btn" data-time="morning">
                  <img src="https://img.icons8.com/?size=100&id=118932&format=png&color=000000" alt="Morning" class="time-icon">
                  <span>Morning</span>
                <button class="time-btn" data-time="afternoon">
                  <img src="https://img.icons8.com/?size=100&id=GIywaBFJCJiI&format=png&color=000000" alt="Afternoon" class="time-icon">
                  <span>Afternoon</span>
                <button class="time-btn" data-time="evening">
                  <img src="https://img.icons8.com/?size=100&id=111581&format=png&color=000000" alt="Evening" class="time-icon">
                  <span>Evening</span>
                <button class="time-btn" data-time="night">
                  <img src="https://img.icons8.com/?size=100&id=54382&format=png&color=000000" alt="Night" class="time-icon">
                  <span>Night</span>
                </button>
        </div>
              <div class="specific-time-container" id="custom-specific-time-container">
                <label class="form-label">Set Your Own Time</label>
                <div class="time-input-wrapper">
                  <input type="time" class="form-input time-input-enhanced" id="custom-specific-time-input">
        </div>
                </button>
        </div>
              </button>
        </div>
        </div>
        `;
      }
      
      heroSection.innerHTML = `
        <div class="habit-step-container">
          <div class="step-header">
            <div class="step-indicator">
              <div class="step-number completed">1</div>
              <div class="step-connector active"></div>
              <div class="step-number active">2</div>
              </button>
        </div>
            <h2 class="step-title">Schedule Your Habit</h2>
            <p class="step-subtitle">${habitData.name} - ${habitData.frequency}</p>
        </div>
          
          <div class="step-content">
            ${scheduleContent}
        </div>
          
          <div class="step-actions">
            <button class="step-btn step-btn-back" onclick="showStep1()">
              <span class="material-icons text-lg md:text-xl">arrow_back</span>
            Back
          </button>
            <button class="step-btn step-btn-next step-btn-create" id="step2-next" disabled>
              <span class="material-icons">check</span>
              Create Habit
        </div>
        </div>
      `;
      
      setupStep2Listeners();
    };

    // Setup Step 2 Event Listeners
    const setupStep2Listeners = () => {
      const nextBtn = document.getElementById('step2-next');
      
      if (habitData.frequency === 'daily') {
        setupDailyListeners();
      } else if (habitData.frequency === 'weekly') {
        setupWeeklyListeners();
      } else if (habitData.frequency === 'monthly') {
        setupMonthlyListeners();
      } else if (habitData.frequency === 'custom') {
        setupCustomListeners();
      }
      
      nextBtn.addEventListener('click', createHabit);
    };

    // Daily frequency listeners
    const setupDailyListeners = () => {
      const timeBtns = document.querySelectorAll('.time-btn');
      const specificTimeInput = document.getElementById('specific-time-input');
      const nextBtn = document.getElementById('step2-next');
      
      // Function to determine time period based on hour
      const getTimePeriod = (timeString) => {
        const hour = parseInt(timeString.split(':')[0]);
        if (hour >= 5 && hour < 12) return 'morning';
        if (hour >= 12 && hour < 17) return 'afternoon';
        if (hour >= 17 && hour < 21) return 'evening';
        return 'night';
      };
      
      // Function to get default time for each period
      const getDefaultTimeForPeriod = (timeType) => {
        switch(timeType) {
          case 'morning': return '08:00';
          case 'afternoon': return '14:00';
          case 'evening': return '19:00';
          case 'night': return '22:00';
          default: return '08:00';
        }
      };
      
              // Function to update active time button
        const updateActiveTimeButton = (timeType, skipTimeUpdate = false) => {
          timeBtns.forEach(b => b.classList.remove('active'));
          const targetBtn = document.querySelector(`.time-btn[data-time="${timeType}"]`);
          if (targetBtn) {
            targetBtn.classList.add('active');
          }
          habitData.schedule.timeType = timeType;
          
          // Auto-set time input to default time for this period (unless skipping)
          if (!skipTimeUpdate) {
            const defaultTime = getDefaultTimeForPeriod(timeType);
            specificTimeInput.value = defaultTime;
            habitData.schedule.specificTime = defaultTime;
          }
        };
      
      timeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          updateActiveTimeButton(btn.dataset.time);
          
          nextBtn.disabled = false;
          nextBtn.classList.remove('disabled');
        });
      });
      
      // Default to morning on load
      updateActiveTimeButton('morning');
      nextBtn.disabled = false;
      nextBtn.classList.remove('disabled');
      
      if (specificTimeInput) {
        // Allow user to edit the time input freely
        specificTimeInput.addEventListener('input', () => {
          const timeValue = specificTimeInput.value;
          if (timeValue) {
            habitData.schedule.specificTime = timeValue;
            
            // Automatically select the appropriate time period based on entered time
            const timePeriod = getTimePeriod(timeValue);
            updateActiveTimeButton(timePeriod, true);
            
            nextBtn.disabled = false;
            nextBtn.classList.remove('disabled');
          }
        });
        
        specificTimeInput.addEventListener('change', () => {
          const timeValue = specificTimeInput.value;
          if (timeValue) {
            habitData.schedule.specificTime = timeValue;
            
            // Automatically select the appropriate time period
            const timePeriod = getTimePeriod(timeValue);
            updateActiveTimeButton(timePeriod, true);
            
            nextBtn.disabled = false;
            nextBtn.classList.remove('disabled');
          }
        });
      }
    };

    // Weekly frequency listeners
    const setupWeeklyListeners = () => {
      const dayBtns = document.querySelectorAll('.day-btn');
      const timeSection = document.getElementById('weekly-time-section');
      const timeBtns = document.querySelectorAll('.time-btn');
      const specificTimeContainer = document.getElementById('weekly-specific-time-container');
      const specificTimeInput = document.getElementById('weekly-specific-time-input');
      const nextBtn = document.getElementById('step2-next');
      
      habitData.schedule.selectedDays = [];
      
      dayBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          btn.classList.toggle('active');
          const day = btn.dataset.day;
          
          if (btn.classList.contains('active')) {
            if (!habitData.schedule.selectedDays.includes(day)) {
              habitData.schedule.selectedDays.push(day);
            }
          } else {
            habitData.schedule.selectedDays = habitData.schedule.selectedDays.filter(d => d !== day);
          }
          
          if (habitData.schedule.selectedDays.length > 0) {
            timeSection.style.display = 'block';
          } else {
            timeSection.style.display = 'none';
            nextBtn.disabled = true;
            nextBtn.classList.add('disabled');
          }
        });
      });
      
      // Function to determine time period based on hour
      const getTimePeriod = (timeString) => {
        const hour = parseInt(timeString.split(':')[0]);
        if (hour >= 5 && hour < 12) return 'morning';
        if (hour >= 12 && hour < 17) return 'afternoon';
        if (hour >= 17 && hour < 21) return 'evening';
        return 'night';
      };
      
      // Function to get default time for each period
      const getDefaultTimeForPeriod = (timeType) => {
        switch(timeType) {
          case 'morning': return '08:00';
          case 'afternoon': return '14:00';
          case 'evening': return '19:00';
          case 'night': return '22:00';
          default: return '08:00';
        }
      };
      
      // Function to update active time button
      const updateActiveTimeButton = (timeType, skipTimeUpdate = false) => {
        timeBtns.forEach(b => b.classList.remove('active'));
        const targetBtn = Array.from(timeBtns).find(btn => btn.dataset.time === timeType);
        if (targetBtn) {
          targetBtn.classList.add('active');
        }
        habitData.schedule.timeType = timeType;
        
        // Auto-set time input to default time for this period (unless skipping)
        if (!skipTimeUpdate) {
          const defaultTime = getDefaultTimeForPeriod(timeType);
          specificTimeInput.value = defaultTime;
          habitData.schedule.specificTime = defaultTime;
        }
      };

      timeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          updateActiveTimeButton(btn.dataset.time);
          
          nextBtn.disabled = false;
          nextBtn.classList.remove('disabled');
        });
      });
      
      // Default to morning when time section becomes visible
      const originalTimeSection = timeSection;
      const observer = new MutationObserver(() => {
        if (timeSection.style.display === 'block') {
          updateActiveTimeButton('morning');
          nextBtn.disabled = false;
          nextBtn.classList.remove('disabled');
        }
      });
      observer.observe(timeSection, { attributes: true, attributeFilter: ['style'] });
      
      if (specificTimeInput) {
        // Allow user to edit the time input freely
        specificTimeInput.addEventListener('input', () => {
          const timeValue = specificTimeInput.value;
          if (timeValue) {
            habitData.schedule.specificTime = timeValue;
            
            // Automatically select the appropriate time period based on entered time
            const timePeriod = getTimePeriod(timeValue);
            updateActiveTimeButton(timePeriod, true);
            
            nextBtn.disabled = false;
            nextBtn.classList.remove('disabled');
          }
        });
        
        specificTimeInput.addEventListener('change', () => {
          const timeValue = specificTimeInput.value;
          if (timeValue) {
            habitData.schedule.specificTime = timeValue;
            
            // Automatically select the appropriate time period
            const timePeriod = getTimePeriod(timeValue);
            updateActiveTimeButton(timePeriod, true);
            
            nextBtn.disabled = false;
            nextBtn.classList.remove('disabled');
          }
        });
      }
    };

    // Monthly frequency listeners
    const setupMonthlyListeners = () => {
      const monthlyBtns = document.querySelectorAll('.monthly-btn');
      const monthlyDetails = document.getElementById('monthly-details');
      const nextBtn = document.getElementById('step2-next');
      
      monthlyBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          monthlyBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const type = btn.dataset.type;
          habitData.schedule.monthlyType = type;
          
          if (type === 'weekday') {
            monthlyDetails.innerHTML = `
              <div class="weekday-patterns">
                <label class="form-label">Weekly Patterns</label>
                <div class="patterns-list" id="patterns-list">
                  <!-- Patterns will be added here -->
        </div>
                <button type="button" class="add-pattern-btn" id="add-pattern-btn">
                  <span class="material-icons">add</span>
                  Add Pattern
                </button>
        </div>
            `;
            
            habitData.schedule.weeklyPatterns = [];
            
            const addPatternBtn = document.getElementById('add-pattern-btn');
            const patternsList = document.getElementById('patterns-list');
            
            function addWeeklyPattern() {
              const patternId = Date.now();
              const patternHTML = `
                <div class="pattern-item" data-pattern-id="${patternId}">
                  <div class="pattern-controls">
                    <select class="form-input pattern-week" data-pattern-id="${patternId}">
                      <option value="">Select week...</option>
                      <option value="every">Every</option>
                      <option value="first">First</option>
                      <option value="second">Second</option>
                      <option value="third">Third</option>
                      <option value="fourth">Fourth</option>
                      <option value="last">Last</option>
                    </select>
                    
                    <select class="form-input pattern-day" data-pattern-id="${patternId}">
                      <option value="">Select day...</option>
                      <option value="monday">Monday</option>
                      <option value="tuesday">Tuesday</option>
                      <option value="wednesday">Wednesday</option>
                      <option value="thursday">Thursday</option>
                      <option value="friday">Friday</option>
                      <option value="saturday">Saturday</option>
                      <option value="sunday">Sunday</option>
                    </select>
                    
                    <button type="button" class="remove-pattern-btn" data-pattern-id="${patternId}">
                      <span class="material-icons">remove</span>
                    </button>
        </div>
        </div>
              `;
              
              patternsList.insertAdjacentHTML('beforeend', patternHTML);
              
              // Add event listeners for this pattern
              const weekSelect = document.querySelector(`select.pattern-week[data-pattern-id="${patternId}"]`);
              const daySelect = document.querySelector(`select.pattern-day[data-pattern-id="${patternId}"]`);
              const removeBtn = document.querySelector(`button.remove-pattern-btn[data-pattern-id="${patternId}"]`);
              
              weekSelect.addEventListener('change', validateWeeklyPatterns);
              daySelect.addEventListener('change', validateWeeklyPatterns);
              
              removeBtn.addEventListener('click', () => {
                const patternElement = document.querySelector(`div.pattern-item[data-pattern-id="${patternId}"]`);
                patternElement.remove();
                habitData.schedule.weeklyPatterns = habitData.schedule.weeklyPatterns.filter(p => p.id !== patternId);
                validateWeeklyPatterns();
              });
            }
            
            function validateWeeklyPatterns() {
              const patterns = [];
              const patternItems = document.querySelectorAll('.pattern-item');
              
              patternItems.forEach(item => {
                const patternId = item.dataset.patternId;
                const weekSelect = item.querySelector('.pattern-week');
                const daySelect = item.querySelector('.pattern-day');
                
                if (weekSelect.value && daySelect.value) {
                  patterns.push({
                    id: patternId,
                    week: weekSelect.value,
                    day: daySelect.value
                  });
                }
              });
              
              habitData.schedule.weeklyPatterns = patterns;
              nextBtn.disabled = patterns.length === 0;
              nextBtn.classList.toggle('disabled', nextBtn.disabled);
            }
            
            addPatternBtn.addEventListener('click', addWeeklyPattern);
            
            // Add first pattern by default
            addWeeklyPattern();
          } else if (type === 'multiple') {
            monthlyDetails.innerHTML = `
              <label class="form-label">Select Specific Days</label>
              <div class="days-grid monthly-days">
                ${Array.from({length: 31}, (_, i) => i + 1).map(day => 
                  `<button class="day-btn monthly-day-btn" data-day="${day}">${day}</button>`
                ).join('')}
                </button>
        </div>
              <p class="selection-hint">Select multiple days of the month</p>
              <p class="month-limitation-note">‚ö†Ô∏è If you select a day (e.g., 31) that a month doesn't have, the recurrence won't take place for that month.</p>
            `;
            
            const dayBtns = document.querySelectorAll('.monthly-day-btn');
            habitData.schedule.monthlyDays = [];
            
            dayBtns.forEach(btn => {
              btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                const day = parseInt(btn.dataset.day);
                
                if (btn.classList.contains('active')) {
                  if (!habitData.schedule.monthlyDays.includes(day)) {
                    habitData.schedule.monthlyDays.push(day);
                  }
                } else {
                  habitData.schedule.monthlyDays = habitData.schedule.monthlyDays.filter(d => d !== day);
                }
                
                nextBtn.disabled = habitData.schedule.monthlyDays.length === 0;
                nextBtn.classList.toggle('disabled', nextBtn.disabled);
              });
            });
          }
          
          monthlyDetails.style.display = 'block';
          
          // Show time section after selecting a pattern type
          const timeSection = document.getElementById('monthly-time-section');
          timeSection.style.display = 'block';
          
          // Setup time listeners for monthly
          setupMonthlyTimeListeners();
        });
      });
      
      function setupMonthlyTimeListeners() {
        const timeBtns = document.querySelectorAll('#monthly-time-section .time-btn');
        const specificTimeInput = document.getElementById('monthly-specific-time-input');
        
        // Function to determine time period based on hour
        const getTimePeriod = (timeString) => {
          const hour = parseInt(timeString.split(':')[0]);
          if (hour >= 5 && hour < 12) return 'morning';
          if (hour >= 12 && hour < 17) return 'afternoon';
          if (hour >= 17 && hour < 21) return 'evening';
          return 'night';
        };
        
        // Function to get default time for each period
        const getDefaultTimeForPeriod = (timeType) => {
          switch(timeType) {
            case 'morning': return '08:00';
            case 'afternoon': return '14:00';
            case 'evening': return '19:00';
            case 'night': return '22:00';
            default: return '08:00';
          }
        };
        
        // Function to update active time button
        const updateActiveTimeButton = (timeType, skipTimeUpdate = false) => {
          timeBtns.forEach(b => b.classList.remove('active'));
          const targetBtn = Array.from(timeBtns).find(btn => btn.dataset.time === timeType);
          if (targetBtn) {
            targetBtn.classList.add('active');
          }
          habitData.schedule.timeType = timeType;
          
          // Auto-set time input to default time for this period (unless skipping)
          if (!skipTimeUpdate) {
            const defaultTime = getDefaultTimeForPeriod(timeType);
            specificTimeInput.value = defaultTime;
            habitData.schedule.specificTime = defaultTime;
          }
        };

        timeBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            updateActiveTimeButton(btn.dataset.time);
          });
        });
        
        // Default to morning on setup
        updateActiveTimeButton('morning');
        
        if (specificTimeInput) {
          // Allow user to edit the time input freely
          specificTimeInput.addEventListener('input', () => {
            const timeValue = specificTimeInput.value;
            if (timeValue) {
              habitData.schedule.specificTime = timeValue;
              
              // Automatically select the appropriate time period based on entered time
              const timePeriod = getTimePeriod(timeValue);
              updateActiveTimeButton(timePeriod, true);
            }
          });
          
          specificTimeInput.addEventListener('change', () => {
            const timeValue = specificTimeInput.value;
            if (timeValue) {
              habitData.schedule.specificTime = timeValue;
              
              // Automatically select the appropriate time period
              const timePeriod = getTimePeriod(timeValue);
              updateActiveTimeButton(timePeriod, true);
            }
          });
        }
      }
    };

    // Custom schedule listeners
    const setupCustomListeners = () => {
      const customBtns = document.querySelectorAll('.custom-btn');
      const customDetails = document.getElementById('custom-details');
      const nextBtn = document.getElementById('step2-next');
      
      customBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          customBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const type = btn.dataset.type;
          habitData.schedule.customType = type;
          
          if (type === 'pattern') {
            customDetails.innerHTML = `
              <div class="custom-pattern">
                <label class="form-label">Recurrence Pattern</label>
                <div class="patterns-list" id="custom-patterns-list">
                  <!-- Patterns will be added here -->
        </div>
                <button type="button" class="add-pattern-btn" id="add-custom-pattern-btn">
                  <span class="material-icons">add</span>
                  Add Pattern
                </button>
        </div>
            `;
            
            setupCustomPatterns();
          } else if (type === 'dates') {
            customDetails.innerHTML = `
              <div class="custom-dates">
                <div class="calendar-navigation">
                  <button type="button" class="nav-btn" id="prev-month-btn">
                    <span class="material-icons">chevron_left</span>
                  <div class="current-month" id="current-month-display"></div>
                  <button type="button" class="nav-btn" id="next-month-btn">
                    <span class="material-icons">chevron_right</span>
        </div>
                <div class="calendar-container">
                  <div class="mini-calendar" id="habit-calendar">
                    <!-- Calendar will be generated here -->
                    </button>
        </div>
        </div>
                <div class="selected-dates-list" id="selected-dates-list">
                  <p class="no-dates">No dates selected</p>
        </div>
                </button>
        </div>
            `;
            
            setupCustomCalendar();
          }
          
          customDetails.style.display = 'block';
          
          // Show time section after selecting a custom type
          const timeSection = document.getElementById('custom-time-section');
          timeSection.style.display = 'block';
          
          // Setup time listeners for custom
          setupCustomTimeListeners();
        });
      });
      
      // Validation function for custom schedules (shared between patterns and dates)
      function validateCustomSchedule() {
        const hasTime = habitData.schedule.timeType || habitData.schedule.specificTime;
        
        if (habitData.schedule.customType === 'pattern') {
          const hasPatterns = habitData.schedule.customPatterns && habitData.schedule.customPatterns.length > 0;
          nextBtn.disabled = !(hasPatterns && hasTime);
        } else if (habitData.schedule.customType === 'dates') {
          const hasDates = habitData.schedule.customDates && habitData.schedule.customDates.length > 0;
          nextBtn.disabled = !(hasDates && hasTime);
        }
        
        nextBtn.classList.toggle('disabled', nextBtn.disabled);
      }
      
      function setupCustomTimeListeners() {
        const timeBtns = document.querySelectorAll('#custom-time-section .time-btn');
        const specificTimeInput = document.getElementById('custom-specific-time-input');
        
        // Function to determine time period based on hour
        const getTimePeriod = (timeString) => {
          const hour = parseInt(timeString.split(':')[0]);
          if (hour >= 5 && hour < 12) return 'morning';
          if (hour >= 12 && hour < 17) return 'afternoon';
          if (hour >= 17 && hour < 21) return 'evening';
          return 'night';
        };
        
        // Function to get default time for each period
        const getDefaultTimeForPeriod = (timeType) => {
          switch(timeType) {
            case 'morning': return '08:00';
            case 'afternoon': return '14:00';
            case 'evening': return '19:00';
            case 'night': return '22:00';
            default: return '08:00';
          }
        };
        
        // Function to update active time button
        const updateActiveTimeButton = (timeType, skipTimeUpdate = false) => {
          timeBtns.forEach(b => b.classList.remove('active'));
          const targetBtn = Array.from(timeBtns).find(btn => btn.dataset.time === timeType);
          if (targetBtn) {
            targetBtn.classList.add('active');
          }
          habitData.schedule.timeType = timeType;
          
          // Auto-set time input to default time for this period (unless skipping)
          if (!skipTimeUpdate) {
            const defaultTime = getDefaultTimeForPeriod(timeType);
            specificTimeInput.value = defaultTime;
            habitData.schedule.specificTime = defaultTime;
          }
          
          // Validate after updating time
          validateCustomSchedule();
        };

        timeBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            updateActiveTimeButton(btn.dataset.time);
          });
        });
        
        // Default to morning on setup
        updateActiveTimeButton('morning');
        
        if (specificTimeInput) {
          // Allow user to edit the time input freely
          specificTimeInput.addEventListener('input', () => {
            const timeValue = specificTimeInput.value;
            if (timeValue) {
              habitData.schedule.specificTime = timeValue;
              
              // Automatically select the appropriate time period based on entered time
              const timePeriod = getTimePeriod(timeValue);
              updateActiveTimeButton(timePeriod, true);
              
              // Validate after manual time input
              validateCustomSchedule();
            }
          });
          
          specificTimeInput.addEventListener('change', () => {
            const timeValue = specificTimeInput.value;
            if (timeValue) {
              habitData.schedule.specificTime = timeValue;
              
              // Automatically select the appropriate time period
              const timePeriod = getTimePeriod(timeValue);
              updateActiveTimeButton(timePeriod, true);
              
              // Validate after manual time input
              validateCustomSchedule();
            }
          });
        }
      }
      
      function setupCustomPatterns() {
        habitData.schedule.customPatterns = [];
        
        const addPatternBtn = document.getElementById('add-custom-pattern-btn');
        const patternsList = document.getElementById('custom-patterns-list');
        
        function addCustomPattern() {
          const patternId = Date.now();
          const patternHTML = `
            <div class="pattern-item" data-pattern-id="${patternId}">
              <div class="pattern-controls">
                <select class="form-input pattern-week" data-pattern-id="${patternId}">
                  <option value="">Select week...</option>
                  <option value="every">Every</option>
                  <option value="first">First</option>
                  <option value="second">Second</option>
                  <option value="third">Third</option>
                  <option value="fourth">Fourth</option>
                  <option value="last">Last</option>
                </select>
                
                <select class="form-input pattern-day" data-pattern-id="${patternId}">
                  <option value="">Select day...</option>
                  <option value="monday">Monday</option>
                  <option value="tuesday">Tuesday</option>
                  <option value="wednesday">Wednesday</option>
                  <option value="thursday">Thursday</option>
                  <option value="friday">Friday</option>
                  <option value="saturday">Saturday</option>
                  <option value="sunday">Sunday</option>
                </select>
                
                <button type="button" class="remove-pattern-btn" data-pattern-id="${patternId}">
                  <span class="material-icons">remove</span>
                </button>
        </div>
              </button>
        </div>
          `;
          
          patternsList.insertAdjacentHTML('beforeend', patternHTML);
          
          // Add event listeners
          const weekSelect = document.querySelector(`select.pattern-week[data-pattern-id="${patternId}"]`);
          const daySelect = document.querySelector(`select.pattern-day[data-pattern-id="${patternId}"]`);
          const removeBtn = document.querySelector(`button.remove-pattern-btn[data-pattern-id="${patternId}"]`);
          
          weekSelect.addEventListener('change', validateCustomPatterns);
          daySelect.addEventListener('change', validateCustomPatterns);
          
          removeBtn.addEventListener('click', () => {
            const patternElement = document.querySelector(`div.pattern-item[data-pattern-id="${patternId}"]`);
            patternElement.remove();
            habitData.schedule.customPatterns = habitData.schedule.customPatterns.filter(p => p.id !== patternId);
            validateCustomPatterns();
          });
        }
        
        function validateCustomPatterns() {
          const patterns = [];
          const patternItems = document.querySelectorAll('#custom-patterns-list .pattern-item');
          
          patternItems.forEach(item => {
            const patternId = item.dataset.patternId;
            const weekSelect = item.querySelector('.pattern-week');
            const daySelect = item.querySelector('.pattern-day');
            
            if (weekSelect.value && daySelect.value) {
              patterns.push({
                id: patternId,
                week: weekSelect.value,
                day: daySelect.value
              });
            }
          });
          
          habitData.schedule.customPatterns = patterns;
          
          // Use the common validation function
          validateCustomSchedule();
        }
        
        addPatternBtn.addEventListener('click', addCustomPattern);
        addCustomPattern(); // Add first pattern
      }
      
      function setupCustomCalendar() {
        habitData.schedule.customDates = [];
        let currentDate = new Date();
        
        const calendarContainer = document.getElementById('habit-calendar');
        const selectedDatesList = document.getElementById('selected-dates-list');
        const currentMonthDisplay = document.getElementById('current-month-display');
        const prevBtn = document.getElementById('prev-month-btn');
        const nextBtn = document.getElementById('next-month-btn');
        
        function generateCalendar(year, month) {
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const startDate = new Date(firstDay);
          // Adjust to start from Monday (0=Sunday, 1=Monday)
          const dayOfWeek = firstDay.getDay();
          const mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          startDate.setDate(startDate.getDate() - mondayOffset);
          
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];
          
          currentMonthDisplay.textContent = `${monthNames[month]} ${year}`;
          
          let calendarHTML = `
            <div class="calendar-grid">
              <div class="calendar-day-header">Mon</div>
              <div class="calendar-day-header">Tue</div>
              <div class="calendar-day-header">Wed</div>
              <div class="calendar-day-header">Thu</div>
              <div class="calendar-day-header">Fri</div>
              <div class="calendar-day-header">Sat</div>
              <div class="calendar-day-header">Sun</div>
          `;
          
          const iterDate = new Date(startDate);
          for (let week = 0; week < 6; week++) {
            for (let day = 0; day < 7; day++) {
              const isCurrentMonth = iterDate.getMonth() === month;
              const isPast = iterDate < new Date().setHours(0,0,0,0);
              const dateStr = iterDate.toISOString().split('T')[0];
              const isSelected = habitData.schedule.customDates.includes(dateStr);
              
              calendarHTML += `
                <button class="calendar-day ${isCurrentMonth ? 'current-month' : 'other-month'} ${isPast ? 'past-day' : ''} ${isSelected ? 'selected' : ''}" 
                        data-date="${dateStr}" ${isPast ? 'disabled' : ''}>
                  ${iterDate.getDate()}
              `;
              iterDate.setDate(iterDate.getDate() + 1);
            }
          }
          
          calendarHTML += '</div>';
          calendarContainer.innerHTML = calendarHTML;
          
          // Add click listeners to calendar days
          const dayBtns = calendarContainer.querySelectorAll('.calendar-day:not([disabled])');
          dayBtns.forEach(btn => {
            btn.addEventListener('click', () => {
              const date = btn.dataset.date;
              
              if (btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                habitData.schedule.customDates = habitData.schedule.customDates.filter(d => d !== date);
              } else {
                btn.classList.add('selected');
                habitData.schedule.customDates.push(date);
              }
              
              updateSelectedDatesList();
              validateCustomDates();
            });
          });
        }
        
        function updateSelectedDatesList() {
          if (habitData.schedule.customDates.length === 0) {
            selectedDatesList.innerHTML = '<p class="no-dates">No dates selected</p>';
          } else {
            const sortedDates = habitData.schedule.customDates.sort();
            selectedDatesList.innerHTML = `
              <p class="selected-count">${sortedDates.length} date(s) selected:</p>
              <div class="selected-dates">
                ${sortedDates.map(date => {
                  const d = new Date(date);
                  return `<span class="selected-date">${d.toLocaleDateString()}</span>`;
                }).join('')}
                </button>
        </div>
            `;
          }
        }
        
        function validateCustomDates() {
          // Use the common validation function
          validateCustomSchedule();
        }
        
        prevBtn.addEventListener('click', () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });
        
        nextBtn.addEventListener('click', () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });
        
        // Generate initial calendar
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
      }
    };

    // Create the habit
    const createHabit = () => {
      const newHabit = {
        id: Date.now(),
        name: habitData.name,
        category: selectedCategory.name,
        categoryId: selectedCategory.id,
        categoryIcon: selectedCategory.icon,
        categoryColor: selectedCategory.color,
        frequency: habitData.frequency,
        schedule: habitData.schedule,
        createdAt: new Date().toISOString(),
        completed: false,
        streak: 0
      };
      
      // Convert beehive habit to momentum goal format and add to progress section
      const newGoal = {
        id: Date.now() + 1, // Ensure unique ID
        title: newHabit.name,
        category: selectedCategory.id,
        priority: 'medium',
        frequency: newHabit.frequency || 'daily',
        deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 days from now
        notes: `Created from ${selectedCategory.name} category`,
        timePeriod: 'anytime',
        time: '',
        scheduledTime: 'anytime',
        progress: 0,
        checkIns: [],
        dateCreated: new Date().toISOString().split('T')[0], // Use dateCreated instead of dateAdded
        completions: []
      };
      
      // Add to momentum state so it appears in Progress section
      momentumState.goals.push(newGoal);
      
      // Update the progress grid if it exists
      const progressGrid = document.getElementById('goals-progress-grid');
      if (progressGrid) {
        progressGrid.innerHTML = renderGoalCards();
      }
      
      console.log('New habit created:', newHabit);
      console.log('Added to progress section:', newGoal);
      
      // Scroll to top of page smoothly
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
      
      // Show success message
      showSuccessAndReturn(newHabit);
    };

    // Show success message and return to categories
    const showSuccessAndReturn = (habit) => {
      const heroSection = document.getElementById('habits-hero-section');
      if (!heroSection) return;
      
      heroSection.innerHTML = `
        <div class="success-container">
          <div class="success-icon">
            <div class="success-icon-wrapper">
              <span class="material-icons">task_alt</span>
              </button>
        </div>
        </div>
          <h2 class="success-title">Habit Created!</h2>
          <p class="success-message">"${habit.name}" has been added to your ${habit.category} habits.</p>
          <button class="success-btn" onclick="resetToCategories()">
            <span class="material-icons text-lg md:text-xl">arrow_back</span>
            Back
          </button>
            Create Another Habit
        </div>
      `;
      
      // Auto-return after 3 seconds
      setTimeout(() => {
        if (typeof resetToCategories === 'function') {
          resetToCategories();
        }
      }, 3000);
    };

    // Toast notification function for habit creation success
    const showToast = (message, type = 'info') => {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
      
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        font-family: 'Inter', sans-serif;
        font-weight: 500;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.style.transform = 'translateX(0)', 100);
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    };

    // Reset to categories view (made global)
    window.resetToCategories = () => {
      const heroSection = document.getElementById('habits-hero-section');
      if (!heroSection) return;
      
      // Reset state
      selectedCategory = null;
      currentStep = 0;
      habitData = {
        name: '',
        frequency: '',
        schedule: {}
      };
      
      // Clear category colors
      const root = document.documentElement;
      root.style.removeProperty('--category-color');
      root.style.removeProperty('--category-color-rgb');
      
      // Remove the momentum-initialized marker to force proper reinitialization
      const momentumSections = document.getElementById('momentum-sections');
      if (momentumSections) {
        const initializedMarker = momentumSections.querySelector('.momentum-initialized');
        if (initializedMarker) {
          initializedMarker.remove();
        }
      }
      
                  // Reset the hero section to show the beehive categories grid
      heroSection.innerHTML = `
        <div class="flex flex-col items-center mb-8" style="margin-top: 1rem;">
          <h2 class="text-xl font-bold text-gray-800 mb-6 text-center" style="font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif; font-weight: 400; letter-spacing: -0.02em;">Introduce a new habit by selecting a category</h2>
          
          <!-- Category indicator for desktop horizontal (between title and grid) -->
          <div class="category-indicator desktop-horizontal-category-indicator">
            <span id="current-category-name-desktop-horizontal" class="category-name-gradient">Fitness</span>
        </div>
          
          <!-- Category indicator moved here for mobile -->
          <div class="category-indicator mobile-category-indicator">
            <span id="current-category-name" class="category-name">Fitness</span>
        </div>
        </div>
        
        <div class="beehive-container">
          <div class="beehive-wrapper">
            <div class="circles-wrapper" id="circles-wrapper">
              <div class="circles" id="circles"></div>
              <div class="over-circles" id="over-circles"></div>
              </button>
        </div>
        </div>
          <!-- Category indicator for desktop (hidden on mobile) -->
          <div class="category-indicator desktop-category-indicator">
            <span id="current-category-name-desktop" class="category-name">Fitness</span>
        </div>
        </div>
      `;
      
      // Now call initializeMomentum to set up the beehive properly
      setTimeout(() => {
        // Since we cleared the momentum-initialized marker and reset the HTML,
        // initializeMomentum will skip creating new HTML and just initialize the beehive
        const heroSectionNew = document.getElementById('habits-hero-section');
        if (heroSectionNew) {
          // Initialize the beehive directly since we already have the HTML structure
          initializeBeehive();
          
          // Ensure proper centering after a short delay
          setTimeout(() => {
            if (dots.length > 0 && categories.length > 0) {
              const isVerticalPhone = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
              
              if (isVerticalPhone) {
                // For vertical phone: center between creativity and finance categories
                const creativityIndex = categories.findIndex(cat => cat.id === 'creativity');
                const financeIndex = categories.findIndex(cat => cat.id === 'finance');
                
                if (creativityIndex !== -1 && financeIndex !== -1 && creativityIndex < dots.length && financeIndex < dots.length) {
                  // Calculate center point between creativity and finance categories
                  const creativityX = dots[creativityIndex].X;
                  const creativityY = dots[creativityIndex].Y;
                  const financeX = dots[financeIndex].X;
                  const financeY = dots[financeIndex].Y;
                  
                  const centerX = (creativityX + financeX) / 2;
                  const centerY = (creativityY + financeY) / 2;
                  
                  // Position this center point at the container center
                  newX = -(centerX - defX + cDim / 2);
                  newY = -(centerY - defY + cDim / 2);
                } else {
                  // Fallback: use geometric center of all categories if specific ones not found
                  let totalX = 0, totalY = 0;
                  const numCategories = Math.min(categories.length, dots.length);
                  
                  for (let i = 0; i < numCategories; i++) {
                    totalX += dots[i].X;
                    totalY += dots[i].Y;
                  }
                  const avgX = totalX / numCategories;
                  const avgY = totalY / numCategories;
                  
                  // Position the geometric center at the container center
                  newX = -(avgX - defX + cDim / 2);
                  newY = -(avgY - defY + cDim / 2);
                }
              } else {
                // For desktop/tablet: use regular centering
                let totalX = 0, totalY = 0;
                const numCategories = Math.min(categories.length, dots.length);
                
                for (let i = 0; i < numCategories; i++) {
                  totalX += dots[i].X;
                  totalY += dots[i].Y;
                }
                const avgX = totalX / numCategories;
                const avgY = totalY / numCategories;
                
                newX = -(avgX - defX + cDim / 2);
                newY = -(avgY - defY + cDim / 2);
              }
              
              const circles = document.getElementById('circles');
              if (circles) {
                circles.style.left = `${newX}px`;
                circles.style.top = `${newY}px`;
              }
              
              // Also ensure all category icons are visible and properly sized
              resizeCircles();
              
              // Set initial category indicator
              if (categories.length > 0) {
                updateCategoryIndicator(categories[0]);
              }
            }
          }, 200);
        }
      }, 100);

// Immediate setup as backup
(function() {
})();    };

    // Initialize
    genDots(0);
    spawnCircles(categories.length);
    drawCircles(categories.length);
    
    // Center the grid on load - position the center of displayed categories in container center
    if (dots.length > 0 && categories.length > 0) {
      const isVerticalPhone = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
      
      if (isVerticalPhone) {
        // For vertical phone: center between creativity and finance categories
        const creativityIndex = categories.findIndex(cat => cat.id === 'creativity');
        const financeIndex = categories.findIndex(cat => cat.id === 'finance');
        
        if (creativityIndex !== -1 && financeIndex !== -1 && creativityIndex < dots.length && financeIndex < dots.length) {
          // Calculate center point between creativity and finance categories
          const creativityX = dots[creativityIndex].X;
          const creativityY = dots[creativityIndex].Y;
          const financeX = dots[financeIndex].X;
          const financeY = dots[financeIndex].Y;
          
          const centerX = (creativityX + financeX) / 2;
          const centerY = (creativityY + financeY) / 2;
          
          // Position this center point at the container center
          newX = -(centerX - defX + cDim / 2);
          newY = -(centerY - defY + cDim / 2);
        } else {
          // Fallback: use geometric center of all categories if specific ones not found
          let totalX = 0, totalY = 0;
          const numCategories = Math.min(categories.length, dots.length);
          
          for (let i = 0; i < numCategories; i++) {
            totalX += dots[i].X;
            totalY += dots[i].Y;
          }
          const avgX = totalX / numCategories;
          const avgY = totalY / numCategories;
          
          // Position the geometric center at the container center
          newX = -(avgX - defX + cDim / 2);
          newY = -(avgY - defY + cDim / 2);
        }
      } else {
        // For desktop/tablet: use regular centering
        let totalX = 0, totalY = 0;
        const numCategories = Math.min(categories.length, dots.length);
        
        for (let i = 0; i < numCategories; i++) {
          totalX += dots[i].X;
          totalY += dots[i].Y;
        }
        const avgX = totalX / numCategories;
        const avgY = totalY / numCategories;
        
        newX = -(avgX - defX + cDim / 2);
        newY = -(avgY - defY + cDim / 2);
      }
      
      circles.style.left = `${newX}px`;
      circles.style.top = `${newY}px`;
    }
    
    resizeCircles();
    
    // Set initial category indicator
    if (categories.length > 0) {
      updateCategoryIndicator(categories[0]);
    }
  }
  
  </script>





<style>
/* Goal Creation Modal Styles */
.goal-creation-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.goal-creation-modal.show {
  opacity: 1;
}

.goal-creation-content {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  transform: translateY(20px);
  transition: transform 0.3s ease;
}

.goal-creation-modal.show .goal-creation-content {
  transform: translateY(0);
}

.goal-creation-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 24px;
  border-bottom: 1px solid #f1f5f9;
}

.example-habits-section {
  padding: 20px 24px;
  border-bottom: 1px solid #f1f5f9;
  background: #fafbfc;
}

.example-habits-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  font-size: 16px;
  font-weight: 600;
  color: #374151;
}

.example-habits-header .material-icons {
  font-size: 20px;
  color: #f59e0b;
}

.example-habits-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
}

.example-habit-item {
  padding: 12px 16px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  cursor: pointer;
  transition: all 0.2s ease;
}

.example-habit-item:hover {
  border-color: #3b82f6;
  background: #f8faff;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
}

.habit-title {
  font-size: 14px;
  font-weight: 500;
  color: #1f2937;
  margin-bottom: 4px;
}

.habit-details {
  display: flex;
  gap: 12px;
  align-items: center;
}

.habit-frequency {
  font-size: 12px;
  color: #6b7280;
  background: #f3f4f6;
  padding: 2px 8px;
  border-radius: 4px;
}

.habit-time {
  font-size: 12px;
  color: #059669;
  background: #d1fae5;
  padding: 2px 8px;
  border-radius: 4px;
}

.goal-category-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

.goal-category-icon {
  font-size: 32px;
  padding: 12px;
  background: rgba(59, 130, 246, 0.1);
  border-radius: 12px;
  color: #3b82f6;
}

.goal-category-label {
  font-size: 14px;
  color: #64748b;
  font-weight: 500;
  margin-bottom: 4px;
}

.goal-category-title {
  font-size: 20px;
  font-weight: 600;
  color: #1e293b;
}

.goal-creation-close {
  background: none;
  border: none;
  padding: 8px;
  border-radius: 8px;
  cursor: pointer;
  color: #64748b;
  transition: all 0.2s ease;
}

.goal-creation-close:hover {
  background: #f1f5f9;
  color: #334155;
}

.goal-creation-form {
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.goal-form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.goal-form-label {
  font-size: 14px;
  font-weight: 600;
  color: #374151;
}

.goal-form-input,
.goal-form-textarea {
  padding: 12px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 16px;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s ease;
  background: #fafafa;
}

.goal-form-input:focus,
.goal-form-textarea:focus {
  outline: none;
  border-color: #3b82f6;
  background: white;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.goal-form-textarea {
  resize: vertical;
  min-height: 80px;
}

.goal-creation-actions {
  display: flex;
  gap: 12px;
  padding: 24px;
  border-top: 1px solid #f1f5f9;
}

.goal-btn {
  flex: 1;
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.goal-btn-cancel {
  background: #f8fafc;
  border: 2px solid #e2e8f0;
  color: #64748b;
}

.goal-btn-cancel:hover {
  background: #f1f5f9;
  border-color: #cbd5e1;
  color: #475569;
}

.goal-btn-create {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  border: none;
  color: white;
}

.goal-btn-create:hover {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.goal-btn-create .material-icons {
  font-size: 20px;
}

/* Mobile Responsive */
@media (max-width: 640px) {
  .goal-creation-content {
    width: 95%;
    margin: 20px;
  }
  
  .goal-creation-header {
    padding: 20px;
  }
  
  .goal-creation-form {
    padding: 20px;
  }
  
  .goal-creation-actions {
    padding: 20px;
    flex-direction: column;
  }
  
  .goal-category-icon {
    font-size: 28px;
    padding: 10px;
  }
  
  .goal-category-title {
    font-size: 18px;
  }
  
  .example-habits-section {
    padding: 16px 20px;
  }
  
  .example-habits-list {
    max-height: 150px;
  }
  
  .example-habit-item {
    padding: 10px 12px;
  }
  
  .habit-details {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}

/* Step-by-step Habit Creation Styles */
.habit-step-container {
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  padding: 32px;
  width: 100%;
  max-width: 550px;
  margin: 0 auto;
  animation: slideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1);
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.step-header {
  text-align: center;
  margin-bottom: 28px;
}

.step-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 14px;
  margin-bottom: 18px;
}

.step-number {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
  border: 1.5px solid #e5e7eb;
  color: #9ca3af;
  background: rgba(255, 255, 255, 0.6);
}

.step-number.active {
  background: var(--category-color, #3b82f6);
  border-color: var(--category-color, #3b82f6);
  color: white;
}

.step-number.completed {
  background: var(--category-color, #10b981);
  border-color: var(--category-color, #10b981);
  color: white;
}

.step-connector {
  width: 50px;
  height: 1.5px;
  background: #e5e7eb;
  transition: all 0.3s ease;
}

.step-connector.active {
  background: var(--category-color, #3b82f6);
}

.step-title {
  font-size: 20px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 6px;
  font-family: 'Inter', sans-serif;
}

.step-subtitle {
  font-size: 14px;
  color: #6b7280;
  font-weight: 400;
}

.step-content {
  margin-bottom: 32px;
}

.category-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.4);
  border-radius: 12px;
  padding: 12px 16px;
  margin: 0 auto 24px auto;
  font-weight: 500;
  font-size: 14px;
  color: #374151;
  width: fit-content;
}

.category-badge .material-icons {
  font-size: 20px;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: #374151;
  margin-bottom: 6px;
}

.form-input {
  width: 100%;
  padding: 12px 16px;
  border: 0.5px solid rgba(200, 200, 200, 0.3);
  border-radius: 8px;
  font-size: 14px;
  font-family: 'Inter', sans-serif;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(16px);
  transition: all 0.3s ease;
  box-sizing: border-box;
}

.form-input:focus {
  outline: none;
  border-color: rgba(59, 130, 246, 0.4);
  background: rgba(255, 255, 255, 0.5);
}

.time-input-wrapper {
  position: relative;
  display: block;
}

.time-input-enhanced {
  position: relative;
  box-shadow: 0 2px 8px rgba(var(--category-color-rgb, 59, 130, 246), 0.1);
  transition: all 0.3s ease;
  background: transparent;
}

.time-placeholder {
  position: absolute;
  top: 50%;
  left: 16px;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: 14px;
  font-family: 'Inter', sans-serif;
  pointer-events: none;
  z-index: 1;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.time-input-enhanced:focus {
  box-shadow: 0 4px 16px rgba(var(--category-color-rgb, 59, 130, 246), 0.2);
  border-color: rgba(var(--category-color-rgb, 59, 130, 246), 0.5);
}

/* Removed duplicate CSS rules - using .time-placeholder span instead */

/* Mobile specific improvements */
@media (max-width: 768px) and (orientation: portrait) {
  .time-input-enhanced {
    min-height: 48px;
    font-size: 16px;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(156, 163, 175, 0.4);
    color: #374151;
    -webkit-appearance: none;
    -moz-appearance: textfield;
  }
  
  /* Custom Schedule Options - Mobile */
  .custom-btn {
    padding: 16px;
    font-size: 14px;
  }
  
  .custom-btn .material-icons {
    font-size: 20px;
  }
  
  .custom-btn small {
    font-size: 11px;
  }
  
  /* Monthly Recurrence Options - Mobile */
  .monthly-btn {
    padding: 16px;
    font-size: 14px;
  }
  
  .monthly-btn .material-icons {
    font-size: 20px;
  }
  
  .monthly-btn small {
    font-size: 11px;
  }
  
  /* Calendar - Mobile */
  .calendar-day {
    padding: 1px;
    font-size: 9px;
    min-height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
  }
  
  .calendar-day-header {
    padding: 1px;
    font-size: 7px;
    min-height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .current-month {
    font-size: 12px;
  }
  
  .calendar-grid {
    gap: 1px;
  }
  
  /* Full-width calendar containers - Mobile */
  .habit-step-container {
    padding-left: 16px;
    padding-right: 16px;
  }
  
  .step-content {
    padding-left: 0;
    padding-right: 0;
  }
  
  .monthly-details {
    margin-left: -16px;
    margin-right: -16px;
    padding-left: 12px;
    padding-right: 12px;
    border-radius: 0;
  }
  
  .custom-dates {
    margin-left: -16px;
    margin-right: -16px;
    padding-left: 12px;
    padding-right: 12px;
  }
  
  .days-grid.monthly-days {
    gap: 2px;
    grid-template-columns: repeat(7, 1fr);
    width: 100%;
    margin: 0;
  }
  
  .calendar-container {
    margin-left: -12px;
    margin-right: -12px;
    padding-left: 8px;
    padding-right: 8px;
    border-radius: 0;
  }
  
  .calendar-grid {
    gap: 1px;
    width: 100%;
  }
  
  /* Pattern Controls - Mobile */
  .pattern-item {
    padding: 12px;
  }
  
  .pattern-controls {
    flex-direction: column;
    gap: 8px;
  }
  
  .pattern-controls select {
    font-size: 14px;
    padding: 10px 12px;
    min-width: auto;
    width: 100%;
  }
  
  .add-pattern-btn, .remove-pattern-btn {
    padding: 10px 12px;
    font-size: 12px;
  }
  
  .add-pattern-btn .material-icons, .remove-pattern-btn .material-icons {
    font-size: 16px;
  }
  
  /* Specific Dates - Mobile */
  .monthly-day-btn {
    padding: 1px;
    font-size: 8px;
    min-width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
  }
  
  .days-grid.monthly-days {
    gap: 2px;
    grid-template-columns: repeat(7, 1fr);
  }
  
  /* Days of Week - Mobile */
  .day-btn {
    padding: 8px 6px;
    font-size: 12px;
    font-weight: 400;
    min-width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .days-grid {
    gap: 6px;
  }
  
  .time-placeholder {
    font-size: 16px;
    color: #6b7280;
    font-weight: 400;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 4px;
    border-radius: 4px;
    opacity: 1;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  .time-input-enhanced::-webkit-datetime-edit {
    color: var(--category-color, #374151);
    font-weight: 500;
    opacity: 1;
  }
  
  .time-input-enhanced::-webkit-datetime-edit-fields-wrapper {
    padding: 0;
  }
  
  .time-input-enhanced::-webkit-datetime-edit-hour-field,
  .time-input-enhanced::-webkit-datetime-edit-minute-field {
    background: rgba(var(--category-color-rgb, 59, 130, 246), 0.1);
    border-radius: 4px;
    padding: 4px 8px;
    margin: 0 2px;
    color: var(--category-color, #374151);
  }
  
  .time-input-enhanced::-webkit-datetime-edit-text {
    color: #6b7280;
    padding: 0 2px;
  }
  
  /* Fallback for when value is empty */
  .time-input-enhanced:invalid {
    color: transparent;
  }
  
  .time-input-enhanced:invalid::before {
    opacity: 1;
    color: #6b7280;
  }
}

.frequency-options {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.frequency-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 10px 6px;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  font-size: 11px;
  color: #374151;
}

.frequency-btn:hover {
  border-color: rgba(var(--category-color-rgb, 59, 130, 246), 0.4);
  background: rgba(255, 255, 255, 0.4);
}

.frequency-btn.active {
  border-color: rgba(var(--category-color-rgb, 59, 130, 246), 0.5);
  background: rgba(var(--category-color-rgb, 59, 130, 246), 0.1);
  backdrop-filter: blur(20px);
  color: var(--category-color, #1d4ed8);
}

.frequency-btn img {
  width: 18px;
  height: 18px;
  opacity: 0.7;
  transition: opacity 0.3s ease;
}

.frequency-btn:hover img,
.frequency-btn.active img {
  opacity: 1;
}

.time-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

/* Horizontal layout for larger screens */
@media (min-width: 769px) {
  .time-options {
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    max-width: 600px;
    margin: 0 auto 20px auto;
  }
}

.time-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 16px 12px;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  color: #374151;
  font-size: 14px;
}

.time-btn:hover {
  border-color: rgba(var(--category-color-rgb, 245, 158, 11), 0.6);
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-1px);
}

.time-btn.active {
  border-color: rgba(var(--category-color-rgb, 245, 158, 11), 0.8);
  background: rgba(var(--category-color-rgb, 245, 158, 11), 0.1);
  backdrop-filter: blur(16px);
  color: var(--category-color, #d97706);
}

.time-btn .time-icon {
  width: 20px;
  height: 20px;
  opacity: 0.7;
  transition: opacity 0.3s ease;
}

.time-btn:hover .time-icon,
.time-btn.active .time-icon {
  opacity: 1;
}

.days-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}

.day-btn {
  padding: 12px 8px;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  color: #374151;
  font-size: 14px;
  text-align: center;
}

.day-btn:hover {
  border-color: rgba(var(--category-color-rgb, 16, 185, 129), 0.6);
  background: rgba(255, 255, 255, 0.95);
}

.day-btn.active {
  border-color: rgba(var(--category-color-rgb, 16, 185, 129), 0.8);
  background: rgba(var(--category-color-rgb, 16, 185, 129), 0.1);
  backdrop-filter: blur(16px);
  color: var(--category-color, #047857);
}

.monthly-options {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.monthly-btn {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  border: 2px solid #e5e7eb;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
  text-align: left;
}

.monthly-btn:hover {
  border-color: rgba(var(--category-color-rgb, 139, 92, 246), 0.6);
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-1px);
}

.monthly-btn.active {
  border-color: rgba(var(--category-color-rgb, 139, 92, 246), 0.8);
  background: rgba(var(--category-color-rgb, 139, 92, 246), 0.1);
  backdrop-filter: blur(16px);
  color: var(--category-color, #7c3aed);
}

.monthly-btn .material-icons {
  font-size: 24px;
  color: var(--category-color, #8b5cf6);
  transition: all 0.3s ease;
}

.monthly-btn.active .material-icons {
  color: white;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.monthly-btn small {
  display: block;
  color: #6b7280;
  font-size: 12px;
  margin-top: 4px;
}

/* Custom Options */
.custom-options {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.custom-btn {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  border: 2px solid #e5e7eb;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
  text-align: left;
}

.custom-btn:hover {
  border-color: rgba(var(--category-color-rgb, 139, 92, 246), 0.6);
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-1px);
}

.custom-btn.active {
  border-color: rgba(var(--category-color-rgb, 139, 92, 246), 0.8);
  background: rgba(var(--category-color-rgb, 139, 92, 246), 0.1);
  backdrop-filter: blur(16px);
  color: var(--category-color, #7c3aed);
}

.custom-btn .material-icons {
  font-size: 24px;
  color: var(--category-color, #8b5cf6);
  transition: all 0.3s ease;
}

.custom-btn.active .material-icons {
  color: white;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.custom-btn small {
  display: block;
  color: #6b7280;
  font-size: 12px;
  margin-top: 4px;
}

/* Pattern Controls */
.weekday-patterns, .custom-pattern {
  padding: 16px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.patterns-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}

.pattern-item {
  padding: 16px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.pattern-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.pattern-controls select {
  flex: 1;
  min-width: 120px;
}

.add-pattern-btn, .remove-pattern-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: rgba(var(--category-color-rgb, 59, 130, 246), 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(var(--category-color-rgb, 59, 130, 246), 0.3);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  color: var(--category-color, #3b82f6);
}

.add-pattern-btn:hover, .remove-pattern-btn:hover {
  background: rgba(var(--category-color-rgb, 59, 130, 246), 0.2);
  border-color: rgba(var(--category-color-rgb, 59, 130, 246), 0.5);
}

.remove-pattern-btn {
  background: rgba(239, 68, 68, 0.1);
  border-color: rgba(239, 68, 68, 0.3);
  color: #dc2626;
  padding: 8px;
  min-width: auto;
}

.remove-pattern-btn:hover {
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.5);
}

/* Calendar Navigation */
.calendar-navigation {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.current-month {
  font-weight: 600;
  color: #374151;
  font-size: 16px;
}

.nav-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: rgba(var(--category-color-rgb, 59, 130, 246), 0.1);
  border: 1px solid rgba(var(--category-color-rgb, 59, 130, 246), 0.3);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--category-color, #3b82f6);
}

.nav-btn:hover {
  background: rgba(var(--category-color-rgb, 59, 130, 246), 0.2);
  border-color: rgba(var(--category-color-rgb, 59, 130, 246), 0.5);
}

/* Custom Details */
.custom-details {
  margin-top: 16px;
}

/* Month Limitation Note */
.month-limitation-note {
  color: #f59e0b;
  font-size: 13px;
  margin-top: 12px;
  margin-bottom: 0;
  padding: 12px;
  background: rgba(251, 191, 36, 0.1);
  border-radius: 8px;
  border-left: 4px solid #f59e0b;
}

  .specific-time-container {
    margin-top: 16px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 12px;
    border: 1px solid #e5e7eb;
  }
  
  /* Mobile specific time container styling */
  @media (max-width: 768px) and (orientation: portrait) {
    .specific-time-container {
      padding: 20px 16px;
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(var(--category-color-rgb, 59, 130, 246), 0.2);
      box-shadow: 0 4px 12px rgba(var(--category-color-rgb, 59, 130, 246), 0.1);
    }
    
    .specific-time-container .form-label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #374151;
    }
  }

/* Calendar Styles */
.calendar-container {
  background: rgba(255, 255, 255, 0.6);
  border-radius: 16px;
  padding: 20px;
  border: 1px solid #e5e7eb;
}

.calendar-header h3 {
  text-align: center;
  margin-bottom: 16px;
  color: #374151;
  font-weight: 600;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.calendar-day-header {
  padding: 8px 4px;
  text-align: center;
  font-weight: 600;
  color: #6b7280;
  font-size: 12px;
}

.calendar-day {
  padding: 8px 4px;
  text-align: center;
  border: 1px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  background: transparent;
}

.calendar-day.current-month {
  color: #374151;
}

.calendar-day.other-month {
  color: #d1d5db;
}

.calendar-day.past-day {
  color: #d1d5db;
  cursor: not-allowed;
}

.calendar-day:not(.past-day):hover {
  background: rgba(var(--category-color-rgb, 59, 130, 246), 0.1);
  border-color: rgba(var(--category-color-rgb, 59, 130, 246), 0.4);
  backdrop-filter: blur(8px);
  transform: none;
}

.calendar-day.selected {
  background: rgba(var(--category-color-rgb, 59, 130, 246), 0.1);
  backdrop-filter: blur(16px);
  color: var(--category-color, #3b82f6);
  border: 2px solid rgba(var(--category-color-rgb, 59, 130, 246), 0.5);
  box-shadow: 
    inset 0 1px 0 rgba(255, 255, 255, 0.3),
    0 2px 8px rgba(var(--category-color-rgb, 59, 130, 246), 0.2);
  transform: none;
  font-weight: 600;
}

.selected-dates-list {
  margin-top: 16px;
  padding: 16px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.no-dates {
  color: #9ca3af;
  font-style: italic;
  margin: 0;
}

.selected-count {
  color: #374151;
  font-weight: 600;
  margin-bottom: 8px;
}

.selected-dates {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.selected-date {
  background: linear-gradient(135deg, 
    rgba(var(--category-color-rgb, 59, 130, 246), 0.2), 
    rgba(var(--category-color-rgb, 59, 130, 246), 0.1));
  color: var(--category-color, #1d4ed8);
  padding: 4px 8px;
  border-radius: 8px;
  border: 1px solid rgba(var(--category-color-rgb, 59, 130, 246), 0.3);
  backdrop-filter: blur(8px);
  font-size: 12px;
  font-weight: 500;
}

/* Monthly Details */
.monthly-details {
  margin-top: 16px;
  padding: 16px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.weekday-pattern {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.selection-hint {
  color: #6b7280;
  font-size: 14px;
  margin-top: 12px;
  margin-bottom: 0;
}

.monthly-days {
  grid-template-columns: repeat(7, 1fr);
}

.monthly-day-btn {
  width: 100%;
  aspect-ratio: 1;
}

.step-actions {
  display: flex;
  gap: 16px;
  justify-content: space-between;
}

.step-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.step-btn-back {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #6b7280;
}

.step-btn-back:hover {
  background: rgba(255, 255, 255, 0.4);
  color: #374151;
}

.step-btn-next {
  background: rgba(var(--category-color-rgb, 59, 130, 246), 0.7);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 
    0 8px 32px rgba(var(--category-color-rgb, 59, 130, 246), 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.4),
    inset 0 -1px 0 rgba(255, 255, 255, 0.1);
  position: relative;
  overflow: hidden;
}

.step-btn-next::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s ease;
}

.step-btn-next:hover:not(.disabled) {
  background: rgba(var(--category-color-rgb, 59, 130, 246), 0.85);
  box-shadow: 
    0 12px 40px rgba(var(--category-color-rgb, 59, 130, 246), 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.5),
    inset 0 -1px 0 rgba(255, 255, 255, 0.15);
  transform: translateY(-1px);
}

.step-btn-next:hover:not(.disabled)::before {
  left: 100%;
}

.step-btn-next.disabled {
  background: rgba(209, 213, 219, 0.6);
  color: #9ca3af;
  cursor: not-allowed;
  transform: none;
}

.step-btn-create {
  background: rgba(var(--category-color-rgb, 16, 185, 129), 0.8);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 
    0 8px 32px rgba(var(--category-color-rgb, 16, 185, 129), 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.4),
    inset 0 -1px 0 rgba(255, 255, 255, 0.1);
}

.step-btn-create:hover:not(.disabled) {
  background: rgba(var(--category-color-rgb, 16, 185, 129), 0.9);
  transform: translateY(-2px);
  box-shadow: 
    0 12px 40px rgba(var(--category-color-rgb, 16, 185, 129), 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.5),
    inset 0 -1px 0 rgba(255, 255, 255, 0.15);
}

/* Success Screen - Modern Gradient Design */
.success-container {
  text-align: center;
  padding: 48px 32px;
  background: linear-gradient(135deg, 
    rgba(255, 255, 255, 0.95) 0%, 
    rgba(249, 250, 251, 0.9) 25%,
    rgba(243, 244, 246, 0.95) 50%,
    rgba(249, 250, 251, 0.9) 75%,
    rgba(255, 255, 255, 0.95) 100%);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  animation: successFadeIn 0.6s ease-out;
  position: relative;
  overflow: hidden;
  margin: 0 auto;
  max-width: 500px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.success-container::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, 
    transparent 30%, 
    rgba(16, 185, 129, 0.05) 40%, 
    rgba(34, 211, 153, 0.08) 50%, 
    rgba(16, 185, 129, 0.05) 60%, 
    transparent 70%);
  animation: shimmer 3s ease-in-out infinite;
  pointer-events: none;
}

@keyframes shimmer {
  0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

@keyframes successFadeIn {
  0% { transform: translateY(20px); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
}

.success-icon {
  margin-bottom: 20px;
  position: relative;
  z-index: 1;
  display: flex;
  justify-content: center;
  width: 100%;
}

.success-icon-wrapper {
  display: inline-block;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, 
    #10b981 0%, 
    #34d399 25%, 
    #6ee7b7 50%, 
    #34d399 75%, 
    #10b981 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  animation: iconPulse 2s ease-in-out infinite;
  position: relative;
  overflow: hidden;
}

.success-icon-wrapper::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, 
    transparent 30%, 
    rgba(255, 255, 255, 0.3) 50%, 
    transparent 70%);
  animation: iconShimmer 2s ease-in-out infinite;
}

@keyframes iconPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes iconShimmer {
  0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.success-icon-wrapper .material-icons {
  font-size: 40px;
  color: white;
  position: relative;
  z-index: 1;
}

.success-title {
  font-size: 24px;
  font-weight: 300;
  color: #1f2937;
  margin-bottom: 8px;
  font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
  letter-spacing: -0.02em;
  text-align: center;
  width: 100%;
}

.success-message {
  font-size: 15px;
  font-weight: 300;
  color: #6b7280;
  margin-bottom: 28px;
  line-height: 1.4;
  font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
  text-align: center;
  width: 100%;
}

.success-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 12px 24px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(29, 78, 216, 0.12));
  color: #3b82f6;
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 12px;
  font-size: 14px;
  font-weight: 400;
  font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
  cursor: pointer;
  transition: all 0.2s ease;
  margin: 0 auto;
}

.success-btn:hover {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(29, 78, 216, 0.16));
  border-color: rgba(59, 130, 246, 0.3);
  transform: translateY(-1px);
}

/* Desktop font size enhancements */
@media (min-width: 769px) {
  .step-title {
    font-size: 22px;
  }
  
  .step-subtitle {
    font-size: 15px;
  }
  
  .form-label {
    font-size: 14px;
  }
  
  .form-input {
    font-size: 15px;
  }
  
  .frequency-btn {
    font-size: 12px;
    padding: 12px 8px;
  }
  
  .step-btn {
    font-size: 14px;
    padding: 12px 24px;
  }
  
  .category-badge {
    font-size: 15px;
  }
}

/* Responsive Design */
@media (max-width: 768px) {
  .habit-step-container {
    padding: 20px;
    margin: 16px;
    border-radius: 16px;
  }
  
  .step-title {
    font-size: 18px;
  }
  
  .frequency-options {
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
  }
  
  .frequency-btn {
    padding: 12px 8px;
    font-size: 10px;
  }
  
  .frequency-btn img {
    width: 16px;
    height: 16px;
  }
  
  .time-options {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  
  .time-btn {
    padding: 12px 8px;
    font-size: 12px;
  }
  
  .days-grid {
    gap: 6px;
  }
  
  .day-btn {
    padding: 10px 6px;
    font-size: 12px;
  }
  
  .step-actions {
    flex-direction: column;
    gap: 12px;
  }
  
  .step-btn {
    width: 100%;
    justify-content: center;
  }
  
  .success-container {
    padding: 32px 20px;
    margin: 16px auto;
    max-width: 90%;
  }
  
  .success-icon-wrapper {
    width: 64px;
    height: 64px;
  }
  
  .success-icon-wrapper .material-icons {
    font-size: 32px;
  }
  
  .success-title {
    font-size: 20px;
    font-weight: 300;
  }
  
  .success-message {
    font-size: 14px;
    font-weight: 300;
  }
}

@media (max-width: 480px) {
  .step-indicator {
    gap: 10px;
  }
  
  .step-number {
    width: 32px;
    height: 32px;
    font-size: 12px;
  }
  
  .step-connector {
    width: 36px;
  }
  
  .time-options {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .category-badge {
    padding: 10px 14px;
    font-size: 13px;
  }
  
  .category-badge .material-icons {
    font-size: 18px;
  }
}
</style>

<!-- ===== CONSOLIDATED HABIT & PROGRESS FIXES ===== -->
<script>
// All habit fixes consolidated into main HTML
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîß Loading Consolidated Habit Fixes...');
  
  // ===== GLASS BUTTON STYLES =====
  function applyGlassyButtonStyles() {
    const mainButtons = [
      {
        id: 'complete-today-btn',
        color: 'rgba(16, 185, 129, 0.85)',
        hoverColor: 'rgba(16, 185, 129, 0.95)'
      },
      {
        id: 'update-progress-btn',
        color: 'rgba(14, 165, 233, 0.85)',
        hoverColor: 'rgba(14, 165, 233, 0.95)'
      },
      {
        id: 'delete-habit-btn',
        color: 'rgba(239, 68, 68, 0.85)',
        hoverColor: 'rgba(239, 68, 68, 0.95)'
      }
    ];

    mainButtons.forEach(btn => {
      const button = document.getElementById(btn.id);
      if (button) {
        button.style.background = btn.color;
        button.style.backdropFilter = 'blur(5px)';
        button.style.WebkitBackdropFilter = 'blur(5px)';
        button.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        button.style.borderWidth = '1px';
        
        button.addEventListener('mouseover', function() {
          this.style.background = btn.hoverColor;
        });
        
        button.addEventListener('mouseout', function() {
          this.style.background = btn.color;
        });
        
        const textElements = button.querySelectorAll('h4, p');
        textElements.forEach(el => {
          el.style.textShadow = '0px 1px 2px rgba(0, 0, 0, 0.2)';
        });
        
        const iconContainer = button.querySelector('div');
        if (iconContainer) {
          const img = iconContainer.querySelector('img');
          if (img) {
            img.style.filter = 'drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3))';
          }
        }
      }
    });
  }
  
  // ===== PROGRESS DATE FIXES =====
  const originalGetExpectedDatesForGoal = window.getExpectedDatesForGoal;
  
  window.getExpectedDatesForGoal = function(goal) {
    if (typeof originalGetExpectedDatesForGoal === 'function') {
      const allDates = originalGetExpectedDatesForGoal(goal);
      const today = new Date().toISOString().split('T')[0];
      return allDates.filter(dateStr => dateStr <= today);
    } else {
      const dates = [];
      const startDate = new Date(goal.dateCreated);
      const today = new Date();
      
      let currentDate = new Date(startDate);
      
      while (currentDate <= today) {
        dates.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      return dates.sort().reverse();
    }
  };
  
  // ===== COMPLETION RATE FIXES =====
  const originalCalculateCompletionRate = window.calculateCompletionRate;
  
  window.calculateCompletionRate = function(goal) {
    if (!goal.completions || goal.completions.length === 0) return 0;
    
    const dateCreated = new Date(goal.dateCreated);
    const today = new Date();
    const daysDiff = Math.ceil((today - dateCreated) / (1000 * 60 * 60 * 24)) + 1;
    
    let expectedCompletions = 0;
    
    switch(goal.frequency) {
      case 'daily':
        expectedCompletions = daysDiff;
        break;
      case 'weekly':
        const weeksDiff = Math.ceil(daysDiff / 7);
        expectedCompletions = weeksDiff * (goal.weeklyTarget || 3);
        break;
      case 'monthly':
        const monthsDiff = Math.ceil(daysDiff / 30);
        expectedCompletions = monthsDiff * (goal.monthlyTarget || 5);
        break;
      default:
        expectedCompletions = daysDiff;
    }
    
    const actualCompletions = goal.completions.filter(c => c.completed).length;
    
    const allPastDates = getExpectedDatesForGoal(goal);
    const allCompleted = allPastDates.every(date => {
      return goal.completions.some(c => c.date === date && c.completed);
    });
    
    if (allCompleted && allPastDates.length > 0) {
      return 100;
    }
    
    return Math.min(100, Math.round((actualCompletions / expectedCompletions) * 100));
  };
  
  // ===== HABIT ORDERING FIXES =====
  const originalRenderGoalCards = window.renderGoalCards;
  
  window.renderGoalCards = function(goals = momentumState.goals, showAll = false) {
    const sortedGoals = [...goals].sort((a, b) => {
      if (!a.dateCreated && !b.dateCreated) return 0;
      if (!a.dateCreated) return 1;
      if (!b.dateCreated) return -1;
      return new Date(b.dateCreated) - new Date(a.dateCreated);
    });
    
    const isMobile = window.innerWidth <= 768;
    const maxVisible = isMobile ? 5 : 9;
    
    const displayGoals = showAll ? sortedGoals : sortedGoals.slice(0, maxVisible);
    const hasMoreGoals = sortedGoals.length > maxVisible;
    
    setTimeout(() => {
      const showAllContainer = document.getElementById('show-all-container');
      if (showAllContainer) {
        showAllContainer.style.display = hasMoreGoals && !showAll ? 'block' : 'none';
      }
    }, 100);

// Immediate setup as backup
(function() {
})();    
    if (typeof originalRenderGoalCards === 'function') {
      return originalRenderGoalCards(displayGoals, showAll);
    }
    
    return displayGoals;
  };
  
  // ===== COMPLETION CHARTS FIXES =====
  const originalRenderCompletionCharts = window.renderCompletionCharts;
  
  window.renderCompletionCharts = function() {
    const chartsContainer = document.getElementById('completion-charts-grid');
    if (!chartsContainer) return;
    
    const completionRates = calculateRealCompletionRates();
    const categoriesToUse = (momentumState && momentumState.categories && momentumState.categories.length > 0) 
      ? momentumState.categories 
      : getDefaultCategories();
    
    chartsContainer.innerHTML = '';
    
    const overallAverage = calculateOverallAverage(completionRates);
    
    const overallHtml = `
      <div class="completion-card transform transition-all duration-300 hover:scale-105 col-span-2">
        <div class="px-3 py-4 rounded-xl shadow-md text-center h-20 flex flex-col justify-center" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.8)); backdrop-filter: blur(10px);">
          <h3 class="text-sm font-medium text-white mb-1" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);">All Categories</h3>
          <p class="text-2xl font-bold text-white" style="text-shadow: 0 1px 3px rgba(0,0,0,0.4);">${overallAverage}%</p>
        </div>
      </div>
    `;
    chartsContainer.innerHTML = overallHtml;
    
    categoriesToUse.forEach((category, index) => {
      const percentage = completionRates[category.id];
      const categoryColor = category.color || '#6B7280';
      
      const rgbaColor = hexToRgba(categoryColor, 0.8);
      const rgbaColorDarker = hexToRgba(getDarkerColor(categoryColor), 0.8);
      
      const hasData = percentage !== undefined && percentage !== null;
      const displayText = hasData ? `${percentage}%` : 'No Habits';
      const textSize = hasData ? 'text-2xl' : 'text-sm';
      
      const cardHtml = `
        <div class="completion-card transform transition-all duration-300 hover:scale-105" style="animation-delay: ${(index + 1) * 0.1}s;">
          <div class="px-3 py-4 rounded-xl shadow-md text-center h-20 flex flex-col justify-center" style="background: linear-gradient(135deg, ${rgbaColor}, ${rgbaColorDarker}); backdrop-filter: blur(10px);">
            <h3 class="text-sm font-medium text-white mb-1" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${category.name}</h3>
            <p class="${textSize} font-bold text-white" style="text-shadow: 0 1px 3px rgba(0,0,0,0.4);">${displayText}</p>
          </div>
        </div>
      `;
      
      chartsContainer.innerHTML += cardHtml;
    });
  };
  
  // Helper functions
  function calculateRealCompletionRates() {
    const rates = {};
    
    if (!momentumState || !momentumState.goals || !momentumState.categories) {
      return rates;
    }
    
    const goalsByCategory = {};
    momentumState.goals.forEach(goal => {
      if (!goalsByCategory[goal.category]) {
        goalsByCategory[goal.category] = [];
      }
      goalsByCategory[goal.category].push(goal);
    });
    
    momentumState.categories.forEach(category => {
      const categoryGoals = goalsByCategory[category.id] || [];
      if (categoryGoals.length > 0) {
        const totalRate = categoryGoals.reduce((sum, goal) => {
          return sum + calculateCompletionRate(goal);
        }, 0);
        rates[category.id] = Math.round(totalRate / categoryGoals.length);
      } else {
        rates[category.id] = null;
      }
    });
    
    return rates;
  }
  
  function calculateOverallAverage(rates) {
    const validRates = Object.values(rates).filter(rate => rate !== null && rate !== undefined);
    if (validRates.length === 0) return 0;
    
    const total = validRates.reduce((sum, rate) => sum + rate, 0);
    return Math.round(total / validRates.length);
  }
  
  function getDefaultCategories() {
    return [
      { id: 'love', name: 'Love', color: '#EF4444' },
      { id: 'health', name: 'Health', color: '#10B981' },
      { id: 'work', name: 'Work', color: '#3B82F6' },
      { id: 'leisure', name: 'Leisure', color: '#8B5CF6' },
      { id: 'finance', name: 'Finance', color: '#F59E0B' },
      { id: 'personal', name: 'Personal', color: '#6B7280' },
      { id: 'social', name: 'Social', color: '#F97316' }
    ];
  }
  
  function getDarkerColor(hexColor) {
    let r = parseInt(hexColor.slice(1, 3), 16);
    let g = parseInt(hexColor.slice(3, 5), 16);
    let b = parseInt(hexColor.slice(5, 7), 16);
    
    r = Math.max(0, r - 40);
    g = Math.max(0, g - 40);
    b = Math.max(0, b - 40);
    
    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
  }
  
  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }
  
  // ===== MUTATION OBSERVER FOR DYNAMIC CONTENT =====
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.addedNodes.length) {
        if (document.getElementById('update-goal-modal')) {
          applyGlassyButtonStyles();
          enhanceMarkAllFunctionality();
        }
      }
    });
  });
  
  function enhanceMarkAllFunctionality() {
    const markAllBtn = document.getElementById('mark-all-btn');
    if (markAllBtn) {
      markAllBtn.addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.date-checkbox:not(:checked):not([disabled])');
        checkboxes.forEach(checkbox => {
          checkbox.checked = true;
        });
        
        if (typeof updateMarkSelectedButton === 'function') {
          updateMarkSelectedButton();
        }
      });
    }
    
    const doneBtn = document.getElementById('done-btn');
    if (doneBtn) {
      doneBtn.addEventListener('click', function() {
        const updateModal = document.getElementById('update-goal-modal');
        if (!updateModal) return;
        
        const goalTitle = updateModal.querySelector('h3.text-lg').textContent;
        if (!goalTitle) return;
        
        const goal = momentumState.goals.find(g => g.title === goalTitle);
        if (!goal) return;
        
        const checkedBoxes = document.querySelectorAll('.date-checkbox:checked');
        checkedBoxes.forEach(checkbox => {
          const date = checkbox.dataset.date;
          if (typeof markHabitCompleteForDate === 'function') {
            markHabitCompleteForDate(goal, date);
          } else {
            if (!goal.completions) {
              goal.completions = [];
            }
            
            const existingCompletion = goal.completions.find(c => c.date === date);
            
            if (existingCompletion) {
              existingCompletion.completed = true;
            } else {
              goal.completions.push({
                date: date,
                completed: true
              });
            }
          }
        });
        
        document.getElementById('progress-calendar-section').classList.add('hidden');
        document.getElementById('progress-overview').style.display = 'block';
        
        const actionButtons = document.getElementById('action-buttons-section');
        if (actionButtons) {
          actionButtons.style.display = 'grid';
        }
        
        if (typeof refreshAllViews === 'function') {
          refreshAllViews();
        }
      });
    }
  }
  
  observer.observe(document.body, { childList: true, subtree: true });
  
  setTimeout(applyGlassyButtonStyles, 500);
  setTimeout(enhanceMarkAllFunctionality, 500);
  
  console.log('‚úÖ Consolidated Habit Fixes Loaded!');
});
</script>

<script>
// ===== UNIFIED THERAPIST FUNCTIONALITY =====
// Clean, organized, conflict-free implementation

document.addEventListener('DOMContentLoaded', function() {
  console.log('üéØ Unified Therapist System Loading...');
  
  // ===== ELEMENT REFERENCES =====
  const step1 = document.getElementById('therapist-step-1');
  const step2 = document.getElementById('therapist-step-2');
  const step3 = document.getElementById('therapist-step-3-location');
  const findTherapistBtn = document.getElementById('find-therapist-btn');
  const backToTherapistsBtn = document.getElementById('back-to-therapists-btn');
  const backToOptionsBtn = document.getElementById('back-to-options-btn');
  const locationOption = document.querySelector('.location-gradient');
  
  console.log('üìã Elements Status:', {
    step1: !!step1, step2: !!step2, step3: !!step3,
    findBtn: !!findTherapistBtn, backBtn: !!backToTherapistsBtn, 
    backOptionsBtn: !!backToOptionsBtn, locationBtn: !!locationOption
  });
  
  // ===== NAVIGATION FUNCTIONS =====
  function showStep(stepToShow, stepsToHide) {
    stepsToHide.forEach(step => {
      if (step) {
        step.style.display = 'none';
        step.classList.add('hidden');
      }
    });
    
    if (stepToShow) {
      stepToShow.style.display = 'block';
      stepToShow.classList.remove('hidden');
    }
  }
  
  window.goToGoalStep2 = function() {
    console.log('üìç Going to Step 2 (Selection Options)');
    showStep(step2, [step1, step3]);
  }
  
  function goToStep1() {
    console.log('üìç Going to Step 1 (Meet Your Therapist)');
    showStep(step1, [step2, step3]);
  }
  
  function goToStep3() {
    console.log('üìç Going to Step 3 (Location & Therapists)');
    showStep(step3, [step1, step2]);
    
    // Initialize location step features
    initializeLocationStep();
  }
  
  // ===== LOCATION STEP INITIALIZATION =====
  function initializeLocationStep() {
    console.log('üó∫Ô∏è Initializing location step...');
    
    // Initialize map placeholder with drop shadow
    initializeMapContainer();
    
    // Populate therapist cards with distance and pagination
    window.forcePopulateLocationCards();
    
    // Initialize pagination controls
    initializePagination();
  }
  
  // ===== MAP FUNCTIONALITY =====
  function initializeMapContainer() {
    const mapContainer = document.getElementById('map-container');
    if (!mapContainer) {
      console.error('‚ùå Map container not found');
      return;
    }
    
    // Add drop shadow styling if not already present
    if (!mapContainer.style.boxShadow) {
      mapContainer.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.15)';
    }
    
    // Check if Google Maps is available
    if (typeof google !== 'undefined' && google.maps) {
      console.log('üó∫Ô∏è Initializing Google Maps...');
      initializeGoogleMap(mapContainer);
    } else {
      console.log('‚è≥ Waiting for Google Maps API...');
      // Wait for Google Maps to load
      const checkGoogle = setInterval(() => {
        if (typeof google !== 'undefined' && google.maps) {
          clearInterval(checkGoogle);
          initializeGoogleMap(mapContainer);
        }
      }, 100);

// Immediate setup as backup
(function() {
})();      
      // Fallback after 5 seconds
      setTimeout(() => {
        clearInterval(checkGoogle);
        if (typeof google === 'undefined' || !google.maps) {
          showMapFallback(mapContainer);
        }
      }, 5000);
    }
  }
  
  function initializeGoogleMap(container) {
    try {
      console.log("üó∫Ô∏è Starting Google Maps initialization with geolocation...");
      
      // Request user location first
      if (navigator.geolocation) {
        console.log("üìç Requesting user location...");
        navigator.geolocation.getCurrentPosition(
          function(position) {
            console.log("‚úÖ Location permission granted!");
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            console.log("üìç User location:", userLat, userLng);
            
            // Initialize map centered on user location
            initializeMapWithLocation(container, userLat, userLng);
          },
          function(error) {
            console.warn("‚ö†Ô∏è Geolocation error:", error.message);
            console.log("üó∫Ô∏è Using default Athens location...");
            // Fallback to Athens
            initializeMapWithLocation(container, 37.9838, 23.7275);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
          }
        );
      } else {
        console.warn("‚ö†Ô∏è Geolocation not supported");
        // Fallback to Athens
        initializeMapWithLocation(container, 37.9838, 23.7275);
      }
      
    } catch (error) {
      console.error("‚ùå Failed to initialize Google Maps:", error);
      showMapFallback(container);
    }
  }
  
  function initializeMapWithLocation(container, lat, lng) {
    console.log("üó∫Ô∏è Creating map at location:", lat, lng);
    
    // First update therapist distances using real addresses
    if (typeof window.updateTherapistDistances === 'function') {
      window.updateTherapistDistances(lat, lng);
    }
    
    const map = new google.maps.Map(container, {
      center: { lat: lat, lng: lng },
      zoom: 13,
      styles: [
        {
          featureType: "all",
          elementType: "geometry.fill",
          stylers: [{ saturation: -40 }, { lightness: 15 }]
        },
        {
          featureType: "water",
          elementType: "geometry.fill",
          stylers: [{ color: "#e3f2fd" }]
        }
      ]
    });
    
    // Add user location marker
    const userMarker = new google.maps.Marker({
      position: { lat: lat, lng: lng },
      map: map,
      title: "Your Location",
      icon: {
        url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
          <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" fill="#4285f4" stroke="white" stroke-width="2"/>
            <circle cx="10" cy="10" r="3" fill="white"/>
          </svg>
        `),
        scaledSize: new google.maps.Size(20, 20)
      }
    });
    
    // Calculate distances and add therapist markers using real addresses
    window.therapistData.forEach((therapist, index) => {
      // Use therapist's real address coordinates (updated by updateTherapistDistances)
      let therapistLat, therapistLng;
      
      if (therapist.lat && therapist.lng) {
        // Use coordinates already set by updateTherapistDistances
        therapistLat = therapist.lat;
        therapistLng = therapist.lng;
      } else {
        // Fallback: get coordinates from address coordinates object
        const addressCoords = window.therapistAddressCoordinates?.[therapist.id];
        if (addressCoords) {
          therapistLat = addressCoords.lat;
          therapistLng = addressCoords.lng;
          therapist.lat = therapistLat;
          therapist.lng = therapistLng;
        } else {
          // Final fallback: use city coordinates
          const cityCoords = window.cityCoordinates?.[therapist.cityKey];
          if (cityCoords) {
            therapistLat = cityCoords.lat;
            therapistLng = cityCoords.lng;
            therapist.lat = therapistLat;
            therapist.lng = therapistLng;
          } else {
            console.warn(`No coordinates found for therapist ${therapist.id}`);
            return;
          }
        }
      }
      
      // Calculate actual distance from user to real address
      const distance = calculateDistance(lat, lng, therapistLat, therapistLng);
      therapist.distance = distance;
      
      const marker = new google.maps.Marker({
        position: { lat: therapistLat, lng: therapistLng },
        map: map,
        title: `Dr. ${therapist.first_name} ${therapist.last_name}`,
        icon: {
          url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
            <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
              <circle cx="15" cy="15" r="12" fill="#10b981" stroke="white" stroke-width="2"/>
              <text x="15" y="20" text-anchor="middle" fill="white" font-size="10">üë®‚Äç‚öïÔ∏è</text>
            </svg>
          `),
          scaledSize: new google.maps.Size(30, 30)
        }
      });
      
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div class="p-3 text-center max-w-xs">
            <img src="${therapist.photo}" alt="Dr. ${therapist.first_name} ${therapist.last_name}" class="w-16 h-16 rounded-full mx-auto mb-2 object-cover">
            <h3 class="font-semibold text-gray-800 mb-1">Dr. ${therapist.first_name} ${therapist.last_name}</h3>
            <p class="text-sm text-blue-600 mb-1">${therapist.title}</p>
            <p class="text-sm text-gray-600 mb-1">${therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy"}</p>
            <p class="text-xs text-gray-500 mb-1">${therapist.address}</p>
            <p class="text-xs text-gray-500 mb-2">${distance.toFixed(1)} km away</p>
            <button onclick="selectTherapist(${therapist.id})" class="px-3 py-1 rounded text-sm" style="background-color: #446081; color: white; border: none; font-family: system-ui, -apple-system, BlinkMacSystemFont;">Select</button>
          </div>
        `
      });
      
      // Close any previously opened info window
        if (window.currentInfoWindow) {
          window.currentInfoWindow.close();
        }
        
        marker.addListener("click", () => {
          // Close any previously opened info window
          if (window.currentInfoWindow) {
            window.currentInfoWindow.close();
          }
          // Set this as the current info window
          window.currentInfoWindow = infoWindow;
        infoWindow.open(map, marker);
      });
    });
    
    console.log("‚úÖ Google Maps initialized successfully with geolocation");
  
  // Calculate distance between two coordinates using Haversine formula
  function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Earth radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  
  function showMapFallback(container) {
    container.innerHTML = `
      <div class="w-full h-full bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg flex items-center justify-center text-gray-700">
        <div class="text-center">
          <div class="text-4xl mb-3">üìç</div>
          <div class="text-lg font-semibold mb-1">Athens, Greece</div>
          <div class="text-sm text-gray-600">Showing nearby therapists</div>
        </div>
      </div>
    `;
    console.log('‚úÖ Map fallback displayed');
  }
  
  // ===== THERAPIST CARDS FUNCTIONALITY =====
  window.currentPage = 0;
  // External therapist data loaded from therapist-data.js
  // No inline definition needed - using external file with new schema
  
  // OLD INLINE DEFINITION REMOVED - Using external file instead
  // window.therapistData is now loaded from therapist-data.js with new schema format
  
  // REMOVED: Duplicate function - using simple populate instead
  // function populateTherapistCards() {
    const container = document.getElementById('therapist-cards-container');
    if (!container) {
      console.error('‚ùå Therapist cards container not found');
      return;
    }
    
    // Sort by distance (nearest first) - use window.therapistData
    const sortedTherapists = [...window.therapistData].sort((a, b) => a.distance - b.distance);
    
    // Cards per page: 3 cards per page for horizontal layout
    const isMobile = window.innerWidth < 768;
    const cardsPerPage = isMobile ? 3 : 6;
    
    // Calculate pagination
    const totalPages = Math.ceil(sortedTherapists.length / cardsPerPage);
    const startIndex = currentPage * cardsPerPage;
    const endIndex = startIndex + cardsPerPage;
    const displayTherapists = sortedTherapists.slice(startIndex, endIndex);
    
    // Update pagination info
    updatePaginationInfo(currentPage + 1, totalPages);
    
    // Clear and populate cards
    container.innerHTML = '';
    
    displayTherapists.forEach(therapist => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1';
      
      const therapyApproach = therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy";
      
      card.innerHTML = `
        <div class="p-4">
          <div class="flex flex-col items-center text-center mb-3">
            <img src="${therapist.image}" alt="${therapist.first_name} ${therapist.last_name}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-300 mb-3">
            <div>
              <h3 class="font-semibold text-gray-800 text-sm">${therapist.first_name} ${therapist.last_name}</h3>
              <p class="text-xs text-gray-600">${therapyApproach}</p>
            </div>
          </div>
          <div class="flex items-center justify-center text-xs text-gray-600 mb-2">
            <span class="material-icons text-gray-400" style="font-size: 14px; margin-right: 4px;">location_on</span>
            ${therapist.distance.toFixed(1)} km
          </div>
          <div class="flex flex-col gap-2">
            <button onclick="viewTherapistProfile(${therapist.id})" class="text-xs py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors bg-white">View Profile</button>
            <button onclick="selectTherapist(${therapist.id})" class="text-xs py-2 rounded-lg transition-colors bg-white hover:bg-gray-50 border border-gray-300" style="background: #002855; border: 1px solid #001d3d; color: white;">Select</button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
    
    console.log(`‚úÖ Displayed ${displayTherapists.length} therapist cards (page ${currentPage + 1}/${totalPages})`);
  }
  
  // ===== PAGINATION FUNCTIONALITY =====
  function updatePaginationInfo(current, total) {
    const paginationInfo = document.getElementById('therapist-pagination-info');
    const prevBtn = document.getElementById('prev-therapists-btn');
    const nextBtn = document.getElementById('next-therapists-btn');
    
    if (paginationInfo) {
      paginationInfo.textContent = `${current} of ${total}`;
    }
    
    if (prevBtn) prevBtn.disabled = currentPage === 0;
    if (nextBtn) nextBtn.disabled = currentPage >= total - 1;
  }
  
  function initializePagination() {
    const prevBtn = document.getElementById('prev-therapists-btn');
    const nextBtn = document.getElementById('next-therapists-btn');
    
    if (prevBtn) {
      prevBtn.onclick = function() {
        if (currentPage > 0) {
          currentPage--;
          window.forcePopulateLocationCards();
        }
      };
    }
    
    if (nextBtn) {
      nextBtn.onclick = function() {
        const isMobile = window.innerWidth < 768;
        const cardsPerPage = isMobile ? 3 : 6;
        const totalPages = Math.ceil(therapistData.length / cardsPerPage);
        
        if (currentPage < totalPages - 1) {
          currentPage++;
          window.forcePopulateLocationCards();
        }
      };
    }
    
    console.log('‚úÖ Pagination controls initialized');
  }
  
  // ===== CLEAN EVENT LISTENERS - DEFINITIVE SETUP =====
  console.log('üéØ Setting up therapist buttons with clean handlers...');
  
  // Setup when elements are available (wait for sessions tab activation)
//   function setupAllButtons() {
//     // First check if sessions-sections is visible
//     const sessionsSections = document.getElementById('sessions-sections');
//     if (!sessionsSections) {
//       console.log('‚ùå Sessions sections not found');
//       return false;
//     }
//     
//     if (sessionsSections.classList.contains('hidden')) {
//       console.log('‚è≥ Sessions section still hidden, waiting...');
//       return false;
//     }
//     
//     const currentFindBtn = document.getElementById('find-therapist-btn');
//     const currentLocationBtn = document.querySelector('.location-gradient');
//     const currentCriteriaBtn = document.querySelector('.criteria-gradient');
//     const currentQuizBtn = document.querySelector('.quiz-gradient');
//     const currentBackToTherapistsBtn = document.getElementById('back-to-therapists-btn');
//     const currentBackToOptionsBtn = document.getElementById('back-to-options-btn');
//     
//     console.log('üîç Sessions visible! Elements status:', {
//       findBtn: !!currentFindBtn,
//       locationBtn: !!currentLocationBtn,
//       criteriaBtn: !!currentCriteriaBtn,
//       quizBtn: !!currentQuizBtn,
//       backToTherapists: !!currentBackToTherapistsBtn,
//       backToOptions: !!currentBackToOptionsBtn
//     });
//     
//     // 1. Find Therapist Button - Clean setup
//     if (currentFindBtn) {
//       // Remove all existing handlers
//       const freshFindBtn = currentFindBtn.cloneNode(true);
//       currentFindBtn.parentNode.replaceChild(freshFindBtn, currentFindBtn);
//       
//       freshFindBtn.addEventListener('click', function(e) {
//         e.preventDefault();
//         e.stopPropagation();
//         console.log('üéØ Find Therapist clicked!');
//         goToGoalStep2();
//       });
//       console.log('‚úÖ Find Therapist button setup complete');
//     }
//     
//     // 2. Location Button
//     if (currentLocationBtn) {
//       currentLocationBtn.onclick = function(e) {
//         e.preventDefault();
//         e.stopPropagation();
//         console.log('üìç Location clicked!');
//         goToStep3();
//       };
//       console.log('‚úÖ Location button setup complete');
//     }
//     
//     // 3. Criteria Button
//     if (currentCriteriaBtn) {
//       currentCriteriaBtn.onclick = function(e) {
//         e.preventDefault();
//         e.stopPropagation();
//         alert('Criteria-based search coming soon! Filter therapists by specialties, experience, and more.');
//       };
//       console.log('‚úÖ Criteria button setup complete');
//     }
//     
//     // 4. Quiz Button
//     if (currentQuizBtn) {
//       currentQuizBtn.onclick = function(e) {
//         e.preventDefault();
//         e.stopPropagation();
//         alert('Personalized matching quiz coming soon! Answer questions to find your perfect therapist.');
//       };
//       console.log('‚úÖ Quiz button setup complete');
//     }
//     
//     // 5. Back Button
//     if (currentBackToTherapistsBtn) {
//       currentBackToTherapistsBtn.onclick = function(e) {
//         e.preventDefault();
//         e.stopPropagation();
//         console.log('üîô Back to therapists clicked');
//         goToGoalStep1();
//       };
//       console.log('‚úÖ Back button setup complete');
//     }
//     
//     // 6. Back to Options Button
//     if (currentBackToOptionsBtn) {
//       currentBackToOptionsBtn.onclick = function(e) {
//         e.preventDefault();
//         e.stopPropagation();
//         console.log('üîô Back to options clicked');
//         showStep(step2, [step1, step3]);
//       };
//       console.log('‚úÖ Back to Options button setup complete');
//     }
//     
//     return true; // Success!
//   }
  
  // Setup buttons when sessions tab is activated - ENHANCED DETECTION
//   function setupSessionsTabListener() {
//     // Multiple ways to detect sessions tab activation
//     const sessionSelectors = [
//       '.sidebar-item',
//       '[onclick*="showTab"]',
//       '[onclick*="sessions"]',
//       'a[href="#sessions"]',
//       'button[data-tab="sessions"]'
//     ];
//     
//     sessionSelectors.forEach(selector => {
//       document.querySelectorAll(selector).forEach(element => {
//         if (element.textContent && element.textContent.toLowerCase().includes('session')) {
//           element.addEventListener('click', function() {
//             console.log('üéØ Sessions tab detected via', selector, '- setting up therapist buttons...');
//             setTimeout(setupAllButtons, 300);
//             setTimeout(setupAllButtons, 800);
//             setTimeout(setupAllButtons, 1500);
//           });
//         }
//       });
//     });
//   }
//   
//   // Enhanced initial setup with multiple attempts
//   setTimeout(setupAllButtons, 500);
//   setTimeout(setupAllButtons, 1000);
//   setTimeout(setupAllButtons, 2000);
//   setTimeout(setupAllButtons, 3000);
//   
//   // Setup session tab listeners
//   setupSessionsTabListener();
  
  // Also try when DOM changes (covers dynamic content loading)
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.addedNodes.length > 0) {
        // Check if any therapist elements were added
        mutation.addedNodes.forEach(node => {
          if (node.nodeType === 1 && (
            node.id && node.id.includes('therapist') ||
            node.querySelector && node.querySelector('[id*="therapist"]')
          )) {
            console.log('üéØ Therapist elements detected in DOM, setting up buttons...');
            setTimeout(setupAllButtons, 200);
          }
        });
      }
    });
  });
  
  // Start observing
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  
  // Therapist cards in step 1 also go to step 2
  const therapistCards = document.querySelectorAll('.landing-therapist-card, .therapist-clickable');
  therapistCards.forEach(card => {
    card.onclick = goToStep2;
  });
  
  // Global therapist selection function
  window.selectTherapist = function(therapistId) {
    console.log('üéØ Global selectTherapist called with ID:', therapistId);
    
    const therapist = window.therapistData.find(t => t.id === therapistId);
    if (!therapist) {
      console.error('‚ùå Therapist not found:', therapistId);
      return;
    }
    
    // Use navigateToBookingStep directly (from therapist-booking.js)
    if (window.navigateToBookingStep && typeof window.navigateToBookingStep === 'function') {
      window.navigateToBookingStep(therapist);
    } else {
      console.error('‚ùå navigateToBookingStep function not available');
    }
  };
  
  // Add resize handler for responsive pagination
  window.addEventListener('resize', function() {
    if (document.getElementById('therapist-step-3-location') && !document.getElementById('therapist-step-3-location').classList.contains('hidden')) {
      // Reset to first page and repopulate cards on resize
      currentPage = 0;
      window.forcePopulateLocationCards();
    }
  });

// ===== GLOBAL THERAPIST NAVIGATION FUNCTIONS =====
//   }
//   const backToOptionsBtn = document.getElementById("back-to-options-btn");
//   if (backToOptionsBtn) {
//     backToOptionsBtn.onclick = function(e) {
//       e.preventDefault(); e.stopPropagation();
//       console.log("üîô Back to options clicked");
//       window.navigateToTherapistStepTwo();
//       return false;
//     };
  }
}, 100);

// Immediate setup as backup
(function() {
})();  
  console.log('üéâ Unified Therapist System Ready!');
// Complete Therapist Fixes - Consolidated
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîß Loading Complete Therapist Fixes...');
  
  // Override the populateTherapistCards function
  window.populateLocationCards = function() {
    console.log("üë• Starting to populate therapist cards...");
    const container = document.getElementById("therapist-cards-container");
    if (!container) {
      console.error("‚ùå Therapist cards container not found");
      return;
    }
    
    console.log("üìä Available therapist data:", window.therapistData.length, "therapists");
    
    // Sort by distance (nearest first)
    const sortedTherapists = [...window.therapistData].sort((a, b) => a.distance - b.distance);
    
    // Responsive cards per page: 6 on desktop, 3 on mobile
    const isMobile = window.innerWidth < 768;
    const cardsPerPage = isMobile ? 3 : 6;
    
    // Calculate pagination
    const totalPages = Math.ceil(sortedTherapists.length / cardsPerPage);
    const startIndex = window.currentPage * cardsPerPage;
    const endIndex = startIndex + cardsPerPage;
    const displayTherapists = sortedTherapists.slice(startIndex, endIndex);
    
    console.log("üìÑ Pagination info:", {
      currentPage: window.currentPage,
      totalPages,
      displayCount: displayTherapists.length,
      isMobile
    });
    
    // Update pagination info
    const paginationInfo = document.getElementById("therapist-pagination-info");
    const prevBtn = document.getElementById("prev-therapists-btn");
    const nextBtn = document.getElementById("next-therapists-btn");
    
    if (paginationInfo) paginationInfo.textContent = `${window.currentPage + 1} of ${totalPages}`;
    if (prevBtn) prevBtn.disabled = window.currentPage === 0;
    if (nextBtn) nextBtn.disabled = window.currentPage >= totalPages - 1;
    
    // Clear and populate cards
    container.innerHTML = "";
    
    // Update container grid for responsive layout
    if (isMobile) {
      container.className = "grid grid-cols-1 gap-4";
    } else {
      container.className = "grid grid-cols-2 lg:grid-cols-3 gap-4";
    }
    
    displayTherapists.forEach(therapist => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1";
      
      // Use horizontal layout for larger screens
      if (isMobile) {
        // Vertical layout for mobile
        card.innerHTML = `
          <div class="p-4">
            <div class="flex flex-col items-center text-center mb-3">
              <img src="${therapist.photo}" alt="${therapist.first_name} ${therapist.last_name}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-300 mb-3">
              <div>
                <h3 class="font-semibold text-gray-800 text-sm">${therapist.first_name} ${therapist.last_name}</h3>
                <p class="text-xs text-blue-600 font-medium">${therapist.title}</p>
                <p class="text-xs text-gray-600">\${therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy"}</p>
              </div>
            </div>
            <div class="flex items-center justify-center text-xs text-gray-600 mb-2">
              ${therapist.distance.toFixed(1)} km ‚Ä¢ ${therapist.area}, ${therapist.city}
            </div>
            <div class="flex flex-col gap-2">
              <button onclick="viewTherapistProfile(${therapist.id})" 
                      class="text-xs py-2 rounded-lg transition-colors"
                      style="background-color: #f5f5f7; color: #446081; border: 1px solid #e5e5e7; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                View Profile
              </button>
              <button onclick="selectTherapist(${therapist.id})" 
                      class="text-xs py-2 rounded-lg transition-all"
                      style="background-color: #446081; color: white; border: none; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                Select
              </button>
            </div>
          </div>
        `;
      } else {
        // Horizontal layout for desktop
        card.innerHTML = `
          <div class="flex p-4 gap-4">
            <div class="flex-shrink-0">
              <img src="${therapist.image}" alt="${therapist.first_name} ${therapist.last_name}" class="w-20 h-20 rounded-full object-cover border-2 border-gray-300">
            </div>
            <div class="flex-grow">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h3 class="font-semibold text-gray-800 text-lg">${therapist.first_name} ${therapist.last_name}</h3>
                  <p class="text-sm text-blue-600 font-medium">${therapist.title}</p>
                </div>
                <div class="text-right">
                  <div class="text-sm text-gray-600 mb-1">
                    ${therapist.distance.toFixed(1)} km
                  </div>
                  <p class="text-xs text-gray-500">${therapist.area}, ${therapist.city}</p>
                </div>
              </div>
              <p class="text-sm text-gray-600 mb-3">${therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy"}</p>
              <div class="flex gap-2">
                <button onclick="viewTherapistProfile(${therapist.id})" 
                        class="flex-1 text-sm py-2 rounded-lg transition-colors"
                        style="background-color: #f5f5f7; color: #446081; border: 1px solid #e5e5e7; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                  View Profile
                </button>
                <button onclick="selectTherapist(${therapist.id})" 
                        class="flex-1 text-sm py-2 rounded-lg transition-all"
                        style="background-color: #446081; color: white; border: none; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                  Select
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      container.appendChild(card);
    });
    
    console.log(`‚úÖ Successfully displayed ${displayTherapists.length} therapist cards (page ${window.currentPage + 1}/${totalPages})`);
  };  };
  
  // Add the popup functionality
  window.viewTherapistProfile = function(therapistId) {
    const therapist = window.therapistData.find(t => t.id === therapistId);
    if (!therapist) return;
    
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    overlay.onclick = function(e) {
      if (e.target === overlay) document.body.removeChild(overlay);
    };
    
    overlay.innerHTML = `
      <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-fadeIn">
        <div class="p-6">
          <div class="flex justify-between items-start mb-4">
            <h2 class="text-2xl font-bold text-gray-800">Therapist Profile</h2>
            <button onclick="document.body.removeChild(this.closest('.fixed'))" class="text-gray-400 hover:text-gray-600 text-2xl transition-colors">&times;</button>
          </div>
          
          <div class="text-center mb-3">
            <img src="${therapist.photo}" alt="${therapist.first_name} ${therapist.last_name}" class="w-24 h-24 rounded-full object-cover border-4 border-gray-300 mx-auto mb-3">
            <h3 class="text-xl font-semibold text-gray-800">${therapist.first_name} ${therapist.last_name}</h3>
            <p class="text-blue-600 font-medium">${therapist.title}</p>
            <div class="flex items-center justify-center text-sm text-gray-500 mt-2">
              <span class="material-icons text-gray-400 mr-1" style="font-size: 16px;">location_on</span>
              ${therapist.area}, ${therapist.city} ‚Ä¢ ${therapist.distance.toFixed(1)} km away
            </div>
          </div>
          
          <div class="space-y-4">
            <div>
              <h4 class="font-semibold text-gray-700 mb-1">Specialty</h4>
        <p class="text-black">${therapist.therapy_approaches ? therapist.therapy_approaches[0] : 'General Therapy'}</p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-700 mb-1">Experience</h4>
              <p class="text-gray-600">${therapist.experience}</p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-700 mb-1">Education</h4>
              <p class="text-gray-600 text-sm">${therapist.education}</p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-700 mb-1">Languages</h4>
              <p class="text-gray-600">${therapist.languages}</p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-700 mb-1">About</h4>
              <p class="text-gray-600 text-sm leading-relaxed">${therapist.bio}</p>
            </div>
          </div>
          
          <div class="flex gap-3 mt-6 pt-4 border-t">
            <button onclick="document.body.removeChild(this.closest('.fixed'))" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
              Close
            <button onclick="selectTherapist(${therapist.id}); document.body.removeChild(this.closest('.fixed'))" class="flex-1 py-2 text-white rounded-lg transition-all shadow-md" style="background-color: #446081; border: none; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
              Select Therapist
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Add animation styles to head if not already present
    if (!document.getElementById('popup-animations')) {
      const style = document.createElement('style');
      style.id = 'popup-animations';
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; transform: scale(0.9); }
          to { opacity: 1; transform: scale(1); }
        }
        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out;
        }
      `;
      document.head.appendChild(style);
    }
  };
  
  // Fix pagination handlers
  const prevBtn = document.getElementById('prev-therapists-btn');
  const nextBtn = document.getElementById('next-therapists-btn');
  
  if (prevBtn) {
    prevBtn.onclick = function() {
      if (window.currentPage > 0) {
        window.currentPage--;
        window.populateTherapistCards();
      }
    };
  }
  
  if (nextBtn) {
    nextBtn.onclick = function() {
      const isMobile = window.innerWidth < 768;
      const cardsPerPage = isMobile ? 3 : 6;
      const totalPages = Math.ceil(window.therapistData.length / cardsPerPage);
      
      if (window.currentPage < totalPages - 1) {
        window.currentPage++;
        window.populateTherapistCards();
      }
    };
  }
  
  // Use the global selectTherapist function defined above
  
  console.log('‚úÖ Complete Therapist Fixes Applied!');
// ===== COMPREHENSIVE FINAL FIXES =====
// Fix habits grid loading and modal popup issues
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîß Loading Final Comprehensive Fixes...');
  
  // ===== FIX HABITS GRID LOADING ISSUE =====
  let originalShowTab = window.showTab;
  
  window.showTab = function(tabId) {
    // Call original function
    if (typeof originalShowTab === 'function') {
      originalShowTab(tabId);
    }
    
    // Additional fixes for habits tab
    if (tabId === 'habits') {
      console.log('üéØ Habits tab activated - ensuring grid loads properly');
      
      // Force refresh the habits grid after a short delay
      setTimeout(() => {
        const goalsGrid = document.getElementById('goals-progress-grid');
        if (goalsGrid && typeof renderGoalCards === 'function') {
          console.log('üîÑ Refreshing habits grid...');
          goalsGrid.innerHTML = renderGoalCards();
        }
        
        // Also refresh the icons grid if it exists
        const iconsGrid = document.querySelector('#habits .grid.grid-cols-3');
        if (iconsGrid && iconsGrid.children.length === 0) {
          console.log('üîÑ Refreshing icons grid...');
          // Force re-render by triggering the habits tab content
          if (typeof refreshAllViews === 'function') {
            refreshAllViews();
          }
        }
      }, 100);

// Immediate setup as backup
(function() {
})();      
      // Double-check after 500ms in case of async issues
      setTimeout(() => {
        const goalsGrid = document.getElementById('goals-progress-grid');
        if (goalsGrid && (!goalsGrid.innerHTML || goalsGrid.innerHTML.trim() === '')) {
          console.log('üîÑ Second attempt at refreshing habits grid...');
          if (typeof renderGoalCards === 'function') {
            goalsGrid.innerHTML = renderGoalCards();
          }
        }
      }, 500);
    }
  };
  
  // ===== FIX MODAL POPUP ISSUES =====
  // Override the updateGoalProgress function to ensure proper modal creation
  let originalUpdateGoalProgress = window.updateGoalProgress;
  
  window.updateGoalProgress = function(goalId) {
    console.log('üìä Opening goal progress modal for:', goalId);
    
    // Find the goal
    const goal = momentumState.goals.find(g => g.id === goalId);
    if (!goal) {
      console.error('‚ùå Goal not found:', goalId);
      return;
    }
    
    // Remove any existing modal
    const existingModal = document.getElementById('update-goal-modal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // Create fresh modal
    const modal = document.createElement('div');
    modal.id = 'update-goal-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    // Get category for styling
    const category = momentumState.categories.find(c => c.id === goal.category);
    const categoryColor = category ? category.color : '#6B7280';
    
    modal.innerHTML = `
      <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-xl font-bold text-gray-800">${goal.title}</h3>
              <p class="text-sm text-gray-600">${category ? category.name : 'General'} ‚Ä¢ ${goal.frequency}</p>
            </div>
            <button onclick="closeUpdateModal()" class="text-gray-400 hover:text-gray-600 text-2xl transition-colors">&times;</button>
          </div>
          
          <!-- Progress Overview -->
          <div id="progress-overview" class="mb-6">
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4">
              <div class="flex justify-between items-center">
                <div>
                  <h4 class="text-lg font-semibold text-gray-800">Progress Overview</h4>
                  <p class="text-gray-600">Current completion rate</p>
                </div>
                <div class="text-right">
                  <div class="text-3xl font-bold" style="color: ${categoryColor};">${calculateCompletionRate(goal)}%</div>
                  <p class="text-sm text-gray-500">completed</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div id="action-buttons-section" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <button id="complete-today-btn" onclick="markTodayComplete('${goal.id}')" class="flex flex-col items-center p-4 bg-green-100 rounded-xl border-2 border-green-200 hover:border-green-300 transition-all">
              <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mb-2">
                <span class="material-icons text-white">check_circle</span>
              </div>
              <h4 class="font-semibold text-gray-800">Complete Today</h4>
              <p class="text-sm text-gray-600 text-center">Mark today as completed</p>
            
            <button id="update-progress-btn" onclick="showProgressCalendar('${goal.id}')" class="flex flex-col items-center p-4 bg-blue-100 rounded-xl border-2 border-blue-200 hover:border-blue-300 transition-all">
              <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mb-2">
                <span class="material-icons text-white">calendar_month</span>
              </div>
              <h4 class="font-semibold text-gray-800">Update Progress</h4>
              <p class="text-sm text-gray-600 text-center">Mark multiple dates</p>
            
            <button id="delete-habit-btn" onclick="deleteGoal('${goal.id}')" class="flex flex-col items-center p-4 bg-red-100 rounded-xl border-2 border-red-200 hover:border-red-300 transition-all">
              <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center mb-2">
                <span class="material-icons text-white">delete</span>
              </div>
              <h4 class="font-semibold text-gray-800">Delete Habit</h4>
              <p class="text-sm text-gray-600 text-center">Remove this habit</p>
          </div>
          
          <!-- Progress Calendar (Initially Hidden) -->
          <div id="progress-calendar-section" class="hidden">
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
              <div class="flex justify-between items-center mb-4">
                <h4 class="text-lg font-semibold text-gray-800">Mark Completion Dates</h4>
                <div class="flex gap-2">
                  <button id="mark-all-btn" class="px-3 py-1 bg-gray-200 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                    <span class="material-icons text-xs mr-1">select_all</span>
                    Mark All
                  <button id="back-to-overview-btn" onclick="hideProgressCalendar()" class="px-3 py-1 bg-gray-200 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                    <span class="material-icons text-xs mr-1">arrow_back</span>
                </div>
              </div>
              
              <div id="dates-grid" class="grid grid-cols-7 gap-2 max-h-64 overflow-y-auto">
                <!-- Dates will be populated here -->
              </div>
              
              <div class="flex justify-end gap-2 mt-4">
                <button id="done-btn" onclick="saveProgress('${goal.id}')" class="px-6 py-2 rounded-lg text-white font-semibold" style="background-color: ${categoryColor};">
                  Done
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Setup event handlers
    setupModalEventHandlers(goal);
    
    console.log('‚úÖ Modal created successfully for:', goal.title);
  };
  
  // ===== MODAL HELPER FUNCTIONS =====
  window.closeUpdateModal = function() {
    const modal = document.getElementById('update-goal-modal');
    if (modal) {
      modal.remove();
    }
  };
  
  window.markTodayComplete = function(goalId) {
    const goal = momentumState.goals.find(g => g.id === goalId);
    if (!goal) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    if (!goal.completions) {
      goal.completions = [];
    }
    
    const existingCompletion = goal.completions.find(c => c.date === today);
    
    if (existingCompletion) {
      existingCompletion.completed = true;
    } else {
      goal.completions.push({
        date: today,
        completed: true
      });
    }
    
    // Refresh the modal
    updateGoalProgress(goalId);
    
    // Refresh the main grid
    if (typeof refreshAllViews === 'function') {
      refreshAllViews();
    }
    
    console.log('‚úÖ Marked today as complete for:', goal.title);
  };
  
  window.showProgressCalendar = function(goalId) {
    document.getElementById('progress-overview').style.display = 'none';
    document.getElementById('action-buttons-section').style.display = 'none';
    document.getElementById('progress-calendar-section').classList.remove('hidden');
    
    // Populate the calendar
    populateProgressCalendar(goalId);
  };
  
  window.hideProgressCalendar = function() {
    document.getElementById('progress-overview').style.display = 'block';
    document.getElementById('action-buttons-section').style.display = 'grid';
    document.getElementById('progress-calendar-section').classList.add('hidden');
  };
  
  function populateProgressCalendar(goalId) {
    const goal = momentumState.goals.find(g => g.id === goalId);
    if (!goal) return;
    
    const datesGrid = document.getElementById('dates-grid');
    const expectedDates = getExpectedDatesForGoal(goal);
    
    datesGrid.innerHTML = '';
    
    expectedDates.forEach(date => {
      const isCompleted = goal.completions?.some(c => c.date === date && c.completed);
      const dateObj = new Date(date);
      const isToday = date === new Date().toISOString().split('T')[0];
      const isFuture = date > new Date().toISOString().split('T')[0];
      
      const dateButton = document.createElement('div');
      dateButton.className = `p-2 rounded-lg text-center cursor-pointer transition-all ${
        isCompleted ? 'bg-green-200 text-green-800' : 
        isToday ? 'bg-blue-200 text-blue-800' : 
        isFuture ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 
        'bg-gray-200 hover:bg-gray-300'
      }`;
      
      dateButton.innerHTML = `
        <div class="text-xs font-medium">${dateObj.toLocaleDateString('en-US', { weekday: 'short' })}</div>
        <div class="text-sm">${dateObj.getDate()}</div>
        <input type="checkbox" class="date-checkbox mt-1" data-date="${date}" ${isCompleted ? 'checked' : ''} ${isFuture ? 'disabled' : ''}>
      `;
      
      datesGrid.appendChild(dateButton);
    });
  }
  
  window.saveProgress = function(goalId) {
    const goal = momentumState.goals.find(g => g.id === goalId);
    if (!goal) return;
    
    const checkboxes = document.querySelectorAll('.date-checkbox:checked');
    
    if (!goal.completions) {
      goal.completions = [];
    }
    
    checkboxes.forEach(checkbox => {
      const date = checkbox.dataset.date;
      const existingCompletion = goal.completions.find(c => c.date === date);
      
      if (existingCompletion) {
        existingCompletion.completed = true;
      } else {
        goal.completions.push({
          date: date,
          completed: true
        });
      }
    });
    
    hideProgressCalendar();
    updateGoalProgress(goalId); // Refresh the modal
    
    if (typeof refreshAllViews === 'function') {
      refreshAllViews();
    }
    
    console.log('‚úÖ Progress saved for:', goal.title);
  };
  
  function setupModalEventHandlers(goal) {
    // Mark All button
    const markAllBtn = document.getElementById('mark-all-btn');
    if (markAllBtn) {
      markAllBtn.onclick = function() {
        const checkboxes = document.querySelectorAll('.date-checkbox:not(:checked):not([disabled])');
        checkboxes.forEach(checkbox => {
          checkbox.checked = true;
        });
      };
    }
  }
  
  // ===== FORCE REFRESH ON TAB SWITCH =====
  // Add mutation observer to watch for tab changes
  const tabObserver = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.target.classList && mutation.target.classList.contains('tab-content')) {
        if (!mutation.target.classList.contains('hidden') && mutation.target.id === 'habits') {
          // Habits tab just became visible
          setTimeout(() => {
            const goalsGrid = document.getElementById('goals-progress-grid');
            if (goalsGrid && typeof renderGoalCards === 'function') {
              console.log('üîÑ Tab observer: Refreshing habits grid...');
              goalsGrid.innerHTML = renderGoalCards();
            }
          }, 50);
        }
      }
    });
  });
  
  // Observe all tab content areas
  document.querySelectorAll('.tab-content').forEach(tab => {
    tabObserver.observe(tab, { attributes: true, attributeFilter: ['class'] });
  });
  
  console.log('‚úÖ Final Comprehensive Fixes Applied!');

// ===== TARGETED FIXES FOR PROGRESS MODAL AND FIND THERAPIST BUTTON =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('üéØ Loading Targeted Modal and Button Fixes...');
  
  // ===== FIX 1: PROGRESS MODAL ISSUE =====
  // The showUpdateGoalModal function exists but it's broken due to HTML corruption
  // Let's replace it with a working version
  
  // First, check if the function works by testing the modal creation
  setTimeout(() => {
    if (typeof showUpdateGoalModal === 'function') {
      console.log('‚úÖ showUpdateGoalModal function found');
      
      // Test if it creates modals properly
      const testGoal = momentumState.goals && momentumState.goals[0];
      if (testGoal) {
        console.log('üß™ Testing modal creation...');
        
        // Override the broken modal function with a simplified working version
        window.showUpdateGoalModal = function(goal) {
          console.log('üìä Opening progress modal for:', goal.title);
          
          // Remove any existing modal
          const existingModal = document.getElementById('update-goal-modal');
          if (existingModal) {
            existingModal.remove();
          }
          
          // Create a simple, working modal
          const modal = document.createElement('div');
          modal.id = 'update-goal-modal';
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
          
          const category = momentumState.categories.find(c => c.id === goal.category);
          const completionRate = calculateCompletionRate(goal);
          
          modal.innerHTML = `
            <div class="bg-white rounded-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">${goal.title}</h3>
                <button onclick="document.getElementById('update-goal-modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>
              
              <div class="mb-6">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                  <div class="text-3xl font-bold text-blue-600">${completionRate}%</div>
                  <div class="text-gray-600">Complete</div>
                </div>
              </div>
              
              <div class="space-y-3">
                <button onclick="markHabitCompleteToday({id: ${goal.id}}); document.getElementById('update-goal-modal').remove(); refreshAllViews();" 
                        class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-all">
                  ‚úì Complete Today
                </button>
                
                <button onclick="showProgressCalendar(${goal.id})" 
                        class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-all">
                  üìÖ Update Progress
                </button>
                
                <button onclick="if(confirm('Delete this habit?')) { deleteHabit(${goal.id}); document.getElementById('update-goal-modal').remove(); refreshAllViews(); }" 
                        class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-all">
                  üóëÔ∏è Delete Habit
                </button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          console.log('‚úÖ Working modal created');
        };
        
        console.log('‚úÖ Progress modal fix applied');
      }
    } else {
      console.error('‚ùå showUpdateGoalModal function not found');
    }
  }, 100);

// Immediate setup as backup
(function() {
})();  
  // ===== REMOVED DUPLICATE FIND THERAPIST SETUP =====
  // Using unified setup in therapist system above
  
  // ===== HELPER FUNCTIONS =====
  if (typeof showProgressCalendar === 'undefined') {
    window.showProgressCalendar = function(goalId) {
      alert('Progress calendar feature coming soon!');
    };
  }
  
  if (typeof markHabitCompleteToday === 'undefined') {
    window.markHabitCompleteToday = function(goal) {
      const today = new Date().toISOString().split('T')[0];
      const actualGoal = momentumState.goals.find(g => g.id === goal.id);
      
      if (actualGoal) {
        if (!actualGoal.completions) {
          actualGoal.completions = [];
        }
        
        const existing = actualGoal.completions.find(c => c.date === today);
        if (existing) {
          existing.completed = true;
        } else {
          actualGoal.completions.push({ date: today, completed: true });
        }
        
        console.log('‚úÖ Marked today complete for:', actualGoal.title);
      }
    };
  }
  
  if (typeof deleteHabit === 'undefined') {
    window.deleteHabit = function(goalId) {
      const index = momentumState.goals.findIndex(g => g.id === goalId);
      if (index !== -1) {
        const deletedGoal = momentumState.goals.splice(index, 1)[0];
        console.log('‚úÖ Deleted habit:', deletedGoal.title);
      }
    };
  }
  
  console.log('‚úÖ Targeted fixes applied successfully!');

  // ===== SPECIFIC FIXES FOR REMAINING ISSUES =====
  
  // FIX 1: HABITS GRID LOADING ISSUE
  // Force grid to load every time habits tab is shown
  const originalShowTab = window.showTab;
  window.showTab = function(tabId) {
    console.log('üéØ Tab switched to:', tabId);
    
    // Call original function if it exists
    if (typeof originalShowTab === 'function') {
      originalShowTab(tabId);
    }
    
    // FORCE habits grid refresh when habits tab is shown
    if (tabId === 'habits') {
      console.log('üìä FORCING habits grid refresh...');
      
      // Multiple attempts to ensure grid loads
      setTimeout(() => {
        const grid = document.getElementById('goals-progress-grid');
        if (grid && typeof renderGoalCards === 'function') {
          console.log('üîÑ Attempt 1: Refreshing habits grid');
          grid.innerHTML = renderGoalCards();
        }
      }, 50);
      
      setTimeout(() => {
        const grid = document.getElementById('goals-progress-grid');
        if (grid && typeof renderGoalCards === 'function') {
          console.log('üîÑ Attempt 2: Ensuring habits grid is populated');
          if (!grid.innerHTML || grid.innerHTML.trim() === '') {
            grid.innerHTML = renderGoalCards();
          }
        }
      }, 200);
      
      setTimeout(() => {
        const grid = document.getElementById('goals-progress-grid');
        if (grid && typeof renderGoalCards === 'function') {
          console.log('üîÑ Attempt 3: Final habits grid check');
          if (!grid.innerHTML || grid.innerHTML.trim() === '') {
            grid.innerHTML = renderGoalCards();
          }
        }
      }, 500);
    }
  };
  
  console.log('‚úÖ SPECIFIC fixes for habits grid applied');
});
</script>

<!-- Enhanced Therapist Cards Script -->
<!-- External script consolidated into main HTML -->

<script>
// ===== UNIFIED THERAPIST NAVIGATION FIX - ALL BUTTONS =====
console.log('üöÄ Loading UNIFIED Therapist Navigation Fix...');

// Single comprehensive fix for ALL therapist buttons
// function fixAllTherapistButtons() {
//   console.log('üîß Fixing ALL therapist navigation buttons...');
//   
//   // Find all the buttons we need to fix
//   const findTherapistBtn = document.getElementById('find-therapist-btn');
//   const locationBtn = document.querySelector('.location-gradient');
//   const criteriaBtn = document.querySelector('.criteria-gradient'); 
//   const quizBtn = document.querySelector('.quiz-gradient');
//   const backToTherapistsBtn = document.getElementById('back-to-therapists-btn');
//   const backToOptionsBtn = document.getElementById('back-to-options-btn');
//   
//   // Check sessions visibility
//   const sessionsDiv = document.getElementById('sessions-sections');
//   const sessionsVisible = sessionsDiv && !sessionsDiv.classList.contains('hidden');
//   
//   console.log('üîç Button Status:', {
//     sessionsVisible,
//     findTherapist: !!findTherapistBtn,
//     location: !!locationBtn,
//     criteria: !!criteriaBtn,
//     quiz: !!quizBtn,
//     backToTherapists: !!backToTherapistsBtn,
//     backToOptions: !!backToOptionsBtn
//   });
//   
//   // Only proceed if sessions are visible
//   if (!sessionsVisible) {
//     console.log('‚è≥ Sessions not visible yet, skipping...');
//     return false;
//   }
//   
//   // 1. Fix Find Therapist Button (Step 1 ‚Üí Step 2)
//   if (findTherapistBtn) {
//     const newFindBtn = findTherapistBtn.cloneNode(true);
//     findTherapistBtn.parentNode.replaceChild(newFindBtn, findTherapistBtn);
//     
//     newFindBtn.onclick = function(e) {
//       e.preventDefault();
//       e.stopPropagation();
//       console.log('üéØ Find Therapist clicked!');
//       
//       const step1 = document.getElementById('therapist-step-1');
//       const step2 = document.getElementById('therapist-step-2');
//       
//       if (step1 && step2) {
//         step1.style.display = 'none';
//         step1.classList.add('hidden');
//         step2.style.display = 'block';
//         step2.classList.remove('hidden');
//         console.log('‚úÖ Navigated to Step 2');
//       }
//       return false;
//     };
//     console.log('‚úÖ Find Therapist button fixed');
//   }
  
      // Fix Location Button
      const locationBtn = document.querySelector(".location-gradient");
      if (locationBtn) {
        locationBtn.onclick = function(e) {
          e.preventDefault();
          console.log("üéØ Location clicked!");
          const step2 = document.getElementById("therapist-step-2");
          const step3 = document.getElementById("therapist-step-3-location");
          if (step2 && step3) {
            step2.style.display = "none";
            step2.classList.add("hidden");
            step3.style.display = "block";
            step3.classList.remove("hidden");
            console.log("‚úÖ Navigated to Step 3");
            
            // Enhanced map and cards initialization
            setTimeout(function() {
              console.log("üó∫Ô∏è Initializing map and cards...");
              
              // Force map initialization
              if (typeof initializeMapContainer === "function") {
                console.log("üìç Calling initializeMapContainer...");
                try {
                  initializeMapContainer();
                  console.log("‚úÖ Map initialized successfully");
                } catch (e) {
                  console.error("‚ùå Map initialization error:", e);
                }
              } else {
                console.error("‚ùå initializeMapContainer function not found");
              }
              
              // Force therapist cards population
              if (typeof window.forcePopulateLocationCards === "function") {
                console.log("üë• Calling window.forcePopulateLocationCards...");
                try {
                  window.forcePopulateLocationCards();
                  console.log("‚úÖ Location therapist cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Cards population error:", e);
                }
              } else if (typeof window.populateLocationCards === "function") {
                console.log("üë• Calling window.populateLocationCards fallback...");
                try {
                  window.populateLocationCards();
                  console.log("‚úÖ Fallback location cards populated successfully");
                } catch (e) {
                  console.error("‚ùå Fallback cards population error:", e);
                }
              } else {
                console.error("‚ùå No therapist card population function found");
              }
              
            }, 200);
            
            // Backup attempt
            setTimeout(function() {
              console.log("üîÑ Backup attempt for map and cards...");
              if (typeof initializeMapContainer === "function") initializeMapContainer();
              if (typeof window.forcePopulateLocationCards === "function") window.forcePopulateLocationCards();
              if (typeof window.populateLocationCards === "function") window.populateLocationCards();
            }, 500);
            
          }
          return false;
        };
        console.log("‚úÖ Location button fixed");
// ===== AGGRESSIVE DEBUGGING FOR LOCATION STEP =====
console.log('üîß Loading Location Step Debugger...');

function debugLocationStep() {
  console.log('üîç DEBUGGING LOCATION STEP...');
  
  // Check if we're on step 3
  const step3 = document.getElementById('therapist-step-3-location');
  if (!step3) {
    console.error('‚ùå Step 3 element not found!');
    return;
  }
  
  const isStep3Visible = !step3.classList.contains('hidden') && step3.style.display !== 'none';
  console.log('üîç Step 3 visibility:', isStep3Visible);
  
  if (isStep3Visible) {
    console.log('üéØ Step 3 is visible! Forcing map and cards initialization...');
    
    // Force map container check
    const mapContainer = document.getElementById('map-container');
    console.log('üó∫Ô∏è Map container found:', !!mapContainer);
    
    if (mapContainer) {
      console.log('üó∫Ô∏è Map container size:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
      
      // Force geolocation request
      if (navigator.geolocation) {
        console.log('üìç Forcing geolocation request...');
        navigator.geolocation.getCurrentPosition(
          function(position) {
            console.log('‚úÖ GOT LOCATION:', position.coords.latitude, position.coords.longitude);
            forceInitializeMap(mapContainer, position.coords.latitude, position.coords.longitude);
          },
          function(error) {
            console.error('‚ùå Geolocation error:', error);
            console.log('üó∫Ô∏è Using Athens fallback...');
            forceInitializeMap(mapContainer, 37.9838, 23.7275);
          },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
      } else {
        console.error('‚ùå Geolocation not supported');
        forceInitializeMap(mapContainer, 37.9838, 23.7275);
      }
    }
    
    // Force therapist cards
    const cardsContainer = document.getElementById('therapist-cards-container');
    console.log('üë• Cards container found:', !!cardsContainer);
    
    if (cardsContainer) {
      console.log('üë• Forcing therapist cards population...');
      forcePopulateCards(cardsContainer);
    }
  }
}

function forceInitializeMap(container, lat, lng) {
  console.log('üó∫Ô∏è FORCING map initialization at:', lat, lng);
  
  if (typeof google !== 'undefined' && google.maps) {
    console.log('‚úÖ Google Maps API available');
    
    const map = new google.maps.Map(container, {
      center: { lat: lat, lng: lng },
      zoom: 13,
      mapTypeControl: false,
      streetViewControl: false
    });
    
    console.log('‚úÖ Map created successfully');
    
    // Add user marker
    new google.maps.Marker({
      position: { lat: lat, lng: lng },
      map: map,
      title: 'Your Location',
      icon: {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#4285f4" stroke="white" stroke-width="2"/><circle cx="10" cy="10" r="3" fill="white"/></svg>'),
        scaledSize: new google.maps.Size(20, 20)
      }
    });
    
    console.log('‚úÖ User marker added');
    
  } else {
    console.error('‚ùå Google Maps not available, showing fallback');
    container.innerHTML = '<div class="w-full h-full bg-blue-100 rounded-lg flex items-center justify-center"><div class="text-center"><div class="text-4xl mb-2">üìç</div><div>Map Loading...</div></div></div>';
  }
}

function forcePopulateCards(container) {
  console.log('üë• FORCING therapist cards population...');
  
  // Simple therapist data for testing
  const testTherapists = [
    { id: 1, name: "Dr. Maria Test", specialty: "Anxiety", photo: "therapist1.png", distance: 1.2, area: "Kolonaki", city: "Athens", title: "Psychologist" },
    { id: 2, name: "Dr. John Test", specialty: "Depression", photo: "therapist2.png", distance: 2.1, area: "Kifisia", city: "Athens", title: "Therapist" },
    { id: 3, name: "Dr. Elena Test", specialty: "Couples", photo: "therapist3.png", distance: 3.5, area: "Glyfada", city: "Athens", title: "Counselor" }
  ];
  
  container.innerHTML = '';
  container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
  
  testTherapists.forEach(therapist => {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-all ';
    card.innerHTML = `
      <div class="text-center">
        <div class="w-16 h-16 bg-blue-500 rounded-full mx-auto mb-3 flex items-center justify-center text-white text-2xl">üë®‚Äç‚öïÔ∏è</div>
        <h3 class="font-semibold text-gray-800">${therapist.first_name} ${therapist.last_name}</h3>
        <p class="text-sm text-blue-600">${therapist.title}</p>
        <p class="text-sm text-gray-600">\${therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy"}</p>
        <p class="text-xs text-gray-500 mt-2">${therapist.distance} km ‚Ä¢ ${therapist.area}</p>
        <button onclick="alert('Selected: ${therapist.first_name} ${therapist.last_name}')" class="mt-3 bg-white hover:bg-gray-50 border border-gray-300 px-4 py-2 rounded-lg text-sm transition-colors" style="background: #002855; border: 1px solid #001d3d; color: white;">
          Select
        </button>
      </div>
    `;
    container.appendChild(card);
  });
  
  console.log('‚úÖ Test therapist cards created');
}

// Run debugger every 2 seconds
setInterval(debugLocationStep, 2000);

// Also run immediately
setTimeout(debugLocationStep, 1000);

console.log('‚úÖ Location Step Debugger loaded');

// ===== ESSENTIAL FUNCTIONS FOR THERAPIST NAVIGATION =====
console.log('üîß Loading essential functions...');

// Simple working map initialization
if (typeof initializeMapContainer === 'undefined') {
  window.initializeMapContainer = function() {
    console.log('üó∫Ô∏è Simple map initialization...');
    const mapContainer = document.getElementById('map-container');
    if (!mapContainer) {
      console.error('‚ùå Map container not found');
      return;
    }
    
    // Request geolocation
    if (navigator.geolocation) {
      console.log('üìç Requesting location...');
      navigator.geolocation.getCurrentPosition(
        function(position) {
          console.log('‚úÖ Location obtained!', position.coords);
          createSimpleMap(mapContainer, position.coords.latitude, position.coords.longitude);
        },
        function(error) {
          console.log('‚ö†Ô∏è Location error, using Athens:', error.message);
          createSimpleMap(mapContainer, 37.9838, 23.7275);
        },
        { enableHighAccuracy: true, timeout: 5000 }
      );
    } else {
      console.log('‚ö†Ô∏è No geolocation, using Athens');
      createSimpleMap(mapContainer, 37.9838, 23.7275);
    }
  };
}

function createSimpleMap(container, lat, lng) {
  console.log('üó∫Ô∏è Creating map at:', lat, lng);
  
  if (typeof google !== 'undefined' && google.maps) {
    const map = new google.maps.Map(container, {
      center: { lat: lat, lng: lng },
      zoom: 13
    });
    
    // Add user marker
    new google.maps.Marker({
      position: { lat: lat, lng: lng },
      map: map,
      title: 'Your Location'
    });
    
    console.log('‚úÖ Map created successfully');
  } else {
    container.innerHTML = '<div class="w-full h-full bg-blue-100 rounded-lg flex items-center justify-center"><div class="text-center"><div class="text-4xl mb-2">üìç</div><div>Map Loading...</div></div></div>';
  }
}

// Simple working therapist cards population
if (typeof populateTherapistCards === 'undefined') {
  window.populateLocationCards = function() {
    console.log('üë• Simple cards population...');
    const container = document.getElementById('therapist-cards-container');
    if (!container) {
      console.error('‚ùå Cards container not found');
      return;
    }
    
    // Use our comprehensive therapist dataset
    const therapists = window.therapistData || [];
    
    container.innerHTML = '';
    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
    
    therapists.slice(0, 6).forEach(therapist => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-2xl p-5 hover:shadow-lg transition-all duration-300 h-full';
      card.style.cssText = 'border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);';
      
      // Use new schema format
      const fullName = `Dr. ${therapist.first_name} ${therapist.last_name}`;
      const primaryApproach = therapist.therapy_approaches ? therapist.therapy_approaches[0] : 'General Therapy';
      const distance = therapist.distance || 0;
      
      card.innerHTML = `
        <div class="h-full flex flex-col">
          <!-- Therapist Image -->
          <div class="mb-4">
            <img src="${therapist.image || 'User Panel Media/therapist1.png'}" alt="${fullName}" 
                 class="w-20 h-20 rounded-2xl mx-auto object-cover shadow-sm"
                 style="border: 1px solid rgba(0, 0, 0, 0.08);">
          </div>
          
          <!-- Therapist Info -->
          <div class="flex-1 text-center px-2">
            <h3 class="font-semibold text-base mb-1" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
              ${fullName}
            </h3>
            <p class="text-sm font-medium mb-2" style="color: #446081;">
              ${therapist.title}
            </p>
            <p class="text-xs mb-3" style="color: #86868b; line-height: 1.4;">
              ${primaryApproach}
            </p>
            
            <!-- Location & Price -->
            <div class="space-y-1 mb-4">
              <p class="text-xs" style="color: #86868b;">
                <span style="color: #1d1d1f; font-weight: 500;">${distance.toFixed(1)} km</span> ‚Ä¢ ${therapist.area}
              </p>
              <p class="text-sm font-medium" style="color: #1d1d1f;">
                ‚Ç¨${therapist.cost || 75}<span class="text-xs font-normal" style="color: #86868b;">/session</span>
              </p>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="space-y-2 mt-auto">
            <button onclick="window.selectTherapist(${therapist.id})" 
                    class="w-full py-2.5 rounded-xl font-medium text-sm transition-all duration-200"
                    style="background-color: #446081; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
              Select Therapist
            </button>
            <button onclick="window.viewTherapistProfile(${therapist.id})" 
                    class="w-full py-2 rounded-xl font-medium text-sm transition-all duration-200"
                    style="background-color: #f5f5f7; color: #446081; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
              View Profile
            </button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
    
    console.log('‚úÖ Cards populated successfully');
  };
  
  // Create the force populate function that many parts of the code are looking for
  window.forcePopulateLocationCards = window.populateLocationCards;
}

console.log('‚úÖ Essential functions loaded');

// ===== FORCE OVERRIDE ALL LOCATION BUTTON HANDLERS =====
console.log('üöÄ FORCE OVERRIDING location button...');

function forceOverrideLocationButton() {
  // Find location button with multiple selectors
  const selectors = [
    '.location-gradient',
    '[class*="location-gradient"]',
    'button[onclick*="location"]',
    'div[onclick*="location"]'
  ];
  
  let locationBtn = null;
  for (const selector of selectors) {
    locationBtn = document.querySelector(selector);
    if (locationBtn) {
      console.log('üéØ Found location button with:', selector);
      break;
    }
  }
  
  if (!locationBtn) {
    // Find by text content
    const allClickable = document.querySelectorAll('button, div[class*="gradient"]');
    for (const el of allClickable) {
      if (el.textContent && el.textContent.toLowerCase().includes('location')) {
        locationBtn = el;
        console.log('üéØ Found location button by text');
        break;
      }
    }
  }
  
  if (locationBtn) {
    console.log('üîß FORCING location button override...');
    
    // Remove ALL existing handlers by cloning
    const newBtn = locationBtn.cloneNode(true);
    locationBtn.parentNode.replaceChild(newBtn, locationBtn);
    
    // Add our handler
    newBtn.onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('üöÄ FORCE OVERRIDE: Location button clicked!');
      
      // Navigate to step 3
      const step2 = document.getElementById('therapist-step-2');
      const step3 = document.getElementById('therapist-step-3-location');
      
      if (step2 && step3) {
        step2.style.display = 'none';
        step2.classList.add('hidden');
        step3.style.display = 'block';
        step3.classList.remove('hidden');
        console.log('‚úÖ Navigated to step 3');
        
        // IMMEDIATELY request location and initialize
        setTimeout(function() {
          console.log('üöÄ FORCING geolocation request...');
          
          if (navigator.geolocation) {
            console.log('üìç Geolocation available, requesting...');
            navigator.geolocation.getCurrentPosition(
              function(position) {
                console.log('‚úÖ LOCATION RECEIVED!', position.coords.latitude, position.coords.longitude);
                // Use the real address system from therapist-data.js
                if (typeof window.initializeEverything === 'function') {
                  window.initializeEverything(position.coords.latitude, position.coords.longitude);
                } else {
                  // Fallback to clean system
                  initializeCleanLocationSystem(position.coords.latitude, position.coords.longitude);
                }
              },
              function(error) {
                console.error('‚ùå Geolocation error:', error.message);
                console.log('‚ö†Ô∏è Using Athens fallback...');
                // Use the real address system from therapist-data.js
                if (typeof window.initializeEverything === 'function') {
                  window.initializeEverything(37.9838, 23.7275);
                } else {
                  // Fallback to clean system
                  initializeCleanLocationSystem(37.9838, 23.7275);
                }
              },
              {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
              }
            );
          } else {
            console.error('‚ùå Geolocation not supported');
            // Use the real address system from therapist-data.js
            if (typeof window.initializeEverything === 'function') {
              window.initializeEverything(37.9838, 23.7275);
            } else {
              // Fallback to clean system
              initializeCleanLocationSystem(37.9838, 23.7275);
            }
          }
        }, 100);

// Immediate setup as backup
(function() {
})();      }
      
      return false;
    };
    
    console.log('‚úÖ Location button FORCE OVERRIDE complete');
    return true;
  }
  
  console.log('‚ùå Location button not found');
  return false;
}

function initializeEverything(lat, lng) {
  console.log('üöÄ Initializing everything at:', lat, lng);
  
  // Initialize map
  const mapContainer = document.getElementById('map-container');
  if (mapContainer) {
    console.log('üó∫Ô∏è Initializing map...');
    if (typeof google !== 'undefined' && google.maps) {
      const map = new google.maps.Map(mapContainer, {
        center: { lat: lat, lng: lng },
        zoom: 13
      });
      
      new google.maps.Marker({
        position: { lat: lat, lng: lng },
        map: map,
        title: 'Your Location'
      });
      
      console.log('‚úÖ Map initialized');
    } else {
      mapContainer.innerHTML = '<div class="w-full h-full bg-blue-100 rounded-lg flex items-center justify-center"><div class="text-center"><div class="text-4xl mb-2">üìç</div><div>Map at ' + lat.toFixed(2) + ', ' + lng.toFixed(2) + '</div></div></div>';
      console.log('‚úÖ Map fallback shown');
    }
  }
  
  // Initialize cards
  const cardsContainer = document.getElementById('therapist-cards-container');
  if (cardsContainer) {
    console.log('üë• Initializing therapist cards...');
    cardsContainer.innerHTML = '';
    cardsContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
    
    const therapists = [
      { name: "Dr. Maria Test", specialty: "Anxiety", distance: 1.2 },
      { name: "Dr. John Test", specialty: "Depression", distance: 2.1 },
      { name: "Dr. Elena Test", specialty: "Couples", distance: 3.5 }
    ];
    
    therapists.forEach(therapist => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-md p-4 ';
      card.innerHTML = `
        <div class="text-center">
          <div class="w-16 h-16 bg-blue-500 rounded-full mx-auto mb-3 flex items-center justify-center text-white text-2xl">üë®‚Äç‚öïÔ∏è</div>
          <h3 class="font-semibold">${therapist.first_name} ${therapist.last_name}</h3>
          <p class="text-sm text-blue-600">\${therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy"}</p>
          <p class="text-xs text-gray-500">${therapist.distance} km away</p>
          <button onclick="alert('Selected: ${therapist.first_name} ${therapist.last_name}')" class="mt-3 bg-white hover:bg-gray-50 border border-gray-300 px-4 py-2 rounded-lg text-sm transition-colors" style="background: #002855; border: 1px solid #001d3d; color: white;">Select</button>
        </div>
      `;
      cardsContainer.appendChild(card);
    });
    
    console.log('‚úÖ Therapist cards initialized');
  }
}

// Try to override immediately and keep trying
forceOverrideLocationButton();
setInterval(forceOverrideLocationButton, 2000);

console.log('‚úÖ Force override system loaded');


<script>
// ===== CLEAN LOCATION SYSTEM OVERRIDE =====
// This overrides the existing location system with a clean, working implementation

document.addEventListener('DOMContentLoaded', function() {
  console.log('üßπ Loading Clean Location System Override...');
    if (step1) { step1.style.display = 'none'; step1.classList.add('hidden'); }
    if (step2) { step2.style.display = 'none'; step2.classList.add('hidden'); }
    if (step3) { step3.style.display = 'block'; step3.classList.remove('hidden'); }
    
    // Update map container to show permission request
    const mapContainer = document.getElementById('map-container');
    if (mapContainer) {
      mapContainer.innerHTML = `
        <div class="text-center p-8">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
          <div class="text-lg font-semibold text-gray-700 mb-2">Requesting Location Permission</div>
          <div class="text-sm text-gray-500">Please allow location access to find nearby therapists</div>
        </div>
      `;
    }
    
    // Immediately request geolocation permission
    if (navigator.geolocation) {
      console.log('üåç CLEAN: Requesting geolocation permission...');
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          console.log('‚úÖ CLEAN: Geolocation permission granted!', position);
          
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          
          console.log(`üìç CLEAN: User location: ${userLat}, ${userLng}`);
          
          // Initialize everything with user location
          initializeCleanLocationSystem(userLat, userLng);
        },
        function(error) {
          console.error('‚ùå CLEAN: Geolocation permission denied or failed:', error);
          
          // Show error message
          if (mapContainer) {
            mapContainer.innerHTML = `
              <div class="text-center p-8">
                <div class="text-yellow-500 text-4xl mb-4">‚ö†Ô∏è</div>
                <div class="text-lg font-semibold text-gray-700 mb-2">Location Access Denied</div>
                <div class="text-sm text-gray-500 mb-4">Using default location (Athens, Greece)</div>
              </div>
            `;
          }
          
          // Use default Athens location after delay
          setTimeout(() => {
            initializeCleanLocationSystem(37.9838, 23.7275);
          }, 2000);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    } else {
      console.error('‚ùå CLEAN: Geolocation not supported');
      
      // Show not supported message
      if (mapContainer) {
        mapContainer.innerHTML = `
          <div class="text-center p-8">
            <div class="text-red-500 text-4xl mb-4">‚ùå</div>
            <div class="text-lg font-semibold text-gray-700 mb-2">Geolocation Not Supported</div>
            <div class="text-sm text-gray-500 mb-4">Using default location (Athens, Greece)</div>
          </div>
        `;
      }
      
      // Use default Athens location
      setTimeout(() => {
        initializeCleanLocationSystem(37.9838, 23.7275);
      }, 2000);
    }
  };
  
  // Clean function to initialize everything with user coordinates
  window.initializeCleanLocationSystem = function(userLat, userLng) {
    console.log('üó∫Ô∏è CLEAN: Initializing location step with coordinates:', userLat, userLng);
    
    // Calculate distances for therapists and sort them
    calculateCleanTherapistDistances(userLat, userLng);
    
    // Initialize the map
    initializeCleanMapSystem(userLat, userLng);
    
    // Populate therapist cards (now sorted by distance)
    if (typeof window.forcePopulateLocationCards === 'function') {
      window.forcePopulateLocationCards();
    } else if (typeof window.populateLocationCards === 'function') {
      window.populateLocationCards();
    } else {
      populateCleanTherapistCards();
    }
    
    // Initialize pagination controls
    if (typeof initializePagination === 'function') {
      initializePagination();
    }
  };
  
  // Calculate distances and sort therapists by proximity using REAL addresses
  window.calculateCleanTherapistDistances = function(userLat, userLng) {
    if (!window.therapistData) {
      console.warn('‚ö†Ô∏è CLEAN: No therapist data available');
      return;
    }
    
    console.log('üìä CLEAN: Calculating distances using REAL therapist addresses...');
    
    // Use the real address distance calculation from therapist-data.js
    if (typeof window.updateTherapistDistances === 'function') {
      window.updateTherapistDistances(userLat, userLng);
    } else {
      // Fallback: Calculate distances for each therapist using real address coordinates
    window.therapistData.forEach((therapist, index) => {
        const addressCoords = window.therapistAddressCoordinates?.[therapist.id];
        if (addressCoords) {
          // Use exact address coordinates
          therapist.lat = addressCoords.lat;
          therapist.lng = addressCoords.lng;
          therapist.distance = calculateDistance(userLat, userLng, addressCoords.lat, addressCoords.lng);
        } else {
          console.warn(`‚ö†Ô∏è No address coordinates found for therapist ID ${therapist.id}`);
          // Fallback to city coordinates
          const cityCoords = window.cityCoordinates?.[therapist.cityKey];
          if (cityCoords) {
            therapist.lat = cityCoords.lat;
            therapist.lng = cityCoords.lng;
            therapist.distance = calculateDistance(userLat, userLng, cityCoords.lat, cityCoords.lng);
          }
        }
    });
    
    // Sort by distance (closest first)
    window.therapistData.sort((a, b) => a.distance - b.distance);
    }
    
    console.log('‚úÖ CLEAN: Therapists sorted by REAL address distance:', 
      window.therapistData.map(t => `${t.first_name} ${t.last_name}: ${t.distance.toFixed(1)}km`));
  };
  
  // Initialize map with user location
  window.initializeCleanMapSystem = function(userLat, userLng) {
    const mapContainer = document.getElementById('map-container');
    if (!mapContainer) {
      console.error('‚ùå CLEAN: Map container not found');
      return;
    }
    
    // Check if Google Maps is available
    if (typeof google !== 'undefined' && google.maps) {
      createCleanGoogleMap(userLat, userLng);
    } else {
      console.log('‚è≥ CLEAN: Waiting for Google Maps API...');
      
      let attempts = 0;
      const checkGoogle = setInterval(() => {
        attempts++;
        if (typeof google !== 'undefined' && google.maps) {
          clearInterval(checkGoogle);
          createCleanGoogleMap(userLat, userLng);
        } else if (attempts > 50) { // 5 seconds timeout
          clearInterval(checkGoogle);
          showCleanMapFallback(userLat, userLng);
        }
      }, 100);

// Immediate setup as backup
(function() {
})();    }
  };
  
  // Create the actual Google Map with user location and therapist markers
  window.createCleanGoogleMap = function(userLat, userLng) {
    const mapContainer = document.getElementById('map-container');
    
    try {
      console.log('üó∫Ô∏è CLEAN: Creating Google Map with user location...');
      
      const map = new google.maps.Map(mapContainer, {
        center: { lat: userLat, lng: userLng },
        zoom: 14,
        styles: [
          {
            featureType: "all",
            elementType: "geometry.fill",
            stylers: [{ saturation: -20 }, { lightness: 10 }]
          },
          {
            featureType: "water",
            elementType: "geometry.fill",
            stylers: [{ color: "#e3f2fd" }]
          }
        ]
      });
      
      // Add user location marker
      new google.maps.Marker({
        position: { lat: userLat, lng: userLng },
        map: map,
        title: "Your Location",
        icon: {
          url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
            <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" fill="#4285f4" stroke="white" stroke-width="3"/>
              <circle cx="12" cy="12" r="4" fill="white"/>
            </svg>
          `),
          scaledSize: new google.maps.Size(24, 24)
        }
      });
      
      // Add therapist markers
      if (window.therapistData) {
        window.therapistData.forEach((therapist) => {
          if (therapist.lat && therapist.lng) {
            const marker = new google.maps.Marker({
              position: { lat: therapist.lat, lng: therapist.lng },
              map: map,
              title: therapist.name,
              icon: {
                url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
                  <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="14" cy="14" r="12" fill="#10b981" stroke="white" stroke-width="2"/>
                    <text x="14" y="19" text-anchor="middle" fill="white" font-size="8">üë®‚Äç‚öïÔ∏è</text>
                  </svg>
                `),
                scaledSize: new google.maps.Size(28, 28)
              }
            });
            
            // Add info window for each therapist
            const infoWindow = new google.maps.InfoWindow({
              content: `
                <div class="p-3 text-center max-w-xs">
                  <img src="${therapist.photo}" alt="${therapist.first_name} ${therapist.last_name}" class="w-16 h-16 rounded-full mx-auto mb-2 object-cover">
                  <h3 class="font-semibold text-gray-800 mb-1">${therapist.first_name} ${therapist.last_name}</h3>
                  <p class="text-sm text-blue-600 mb-1">${therapist.title}</p>
                  <p class="text-sm text-gray-600 mb-1">\${therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy"}</p>
                  <p class="text-xs text-gray-500 mb-2">${therapist.distance ? therapist.distance.toFixed(1) + ' km away' : ''}</p>
                  <button onclick="selectTherapist(${therapist.id})" class="px-3 py-1 rounded text-sm" style="background-color: #446081; color: white; border: none; font-family: system-ui, -apple-system, BlinkMacSystemFont;">Select</button>
                </div>
              `
            });
            
            // Close any previously opened info window
        if (window.currentInfoWindow) {
          window.currentInfoWindow.close();
        }
        
        marker.addListener("click", () => {
          // Close any previously opened info window
          if (window.currentInfoWindow) {
            window.currentInfoWindow.close();
          }
          // Set this as the current info window
          window.currentInfoWindow = infoWindow;
              infoWindow.open(map, marker);
            });
          }
        });
      }
      
      console.log('‚úÖ CLEAN: Google Map created successfully with user location and therapist markers');
      
    } catch (error) {
      console.error('‚ùå CLEAN: Error creating Google Map:', error);
      showCleanMapFallback(userLat, userLng);
    }
  };
  
  // Show fallback message when map fails to load
  window.showCleanMapFallback = function(userLat, userLng) {
    const mapContainer = document.getElementById('map-container');
    if (mapContainer) {
      mapContainer.innerHTML = `
        <div class="text-center p-8">
          <div class="text-blue-500 text-4xl mb-4">üìç</div>
          <div class="text-lg font-semibold text-gray-700 mb-2">Location Found</div>
          <div class="text-sm text-gray-600 mb-2">Lat: ${userLat.toFixed(4)}, Lng: ${userLng.toFixed(4)}</div>
          <div class="text-xs text-gray-500">Map temporarily unavailable</div>
        </div>
      `;
    }
  };
  
  // Fallback therapist cards function
  window.populateCleanTherapistCards = function() {
    const container = document.getElementById('therapist-cards-container');
    if (!container || !window.therapistData) return;
    
    container.innerHTML = '';
    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
    
    window.therapistData.slice(0, 6).forEach(therapist => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-md p-4 ';
      card.innerHTML = `
        <div class="text-center">
          <div class="w-16 h-16 bg-blue-500 rounded-full mx-auto mb-3 flex items-center justify-center text-white text-2xl">üë®‚Äç‚öïÔ∏è</div>
          <h3 class="font-semibold">${therapist.first_name} ${therapist.last_name}</h3>
          <p class="text-sm text-blue-600">\${therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy"}</p>
          <p class="text-xs text-gray-500">${therapist.distance ? therapist.distance.toFixed(1) + ' km away' : ''}</p>
          <button onclick="alert('Selected: ${therapist.first_name} ${therapist.last_name}')" class="mt-3 bg-white hover:bg-gray-50 border border-gray-300 px-4 py-2 rounded-lg text-sm transition-colors" style="background: #002855; border: 1px solid #001d3d; color: white;">Select</button>
        </div>
      `;
      container.appendChild(card);
    });
  };
  
  console.log('‚úÖ Clean Location System Override loaded');
  
  // Test the override by trying to setup location button
  setTimeout(() => {
    const locationBtns = document.querySelectorAll('.location-gradient');
    locationBtns.forEach(btn => {
      if (btn) {
        btn.onclick = window.goToStep3;
        console.log('‚úÖ CLEAN: Location button override applied');
      }
    });
  }, 100);

// Immediate setup as backup
(function() {
})();});
</script>

</script>

<script>
// ===== MISSING LOCATION FUNCTIONS =====
// These functions were missing and causing the location system to not work

function initializeMapContainer() {
  console.log('üó∫Ô∏è initializeMapContainer called - requesting geolocation immediately...');
  
  const mapContainer = document.getElementById('map-container');
  if (!mapContainer) {
    console.error('‚ùå Map container not found');
    return;
  }
  
  // Show loading state
  mapContainer.innerHTML = `
    <div class="text-center p-8">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
      <div class="text-lg font-semibold text-gray-700 mb-2">Requesting Location Permission</div>
      <div class="text-sm text-gray-500">Please allow location access to find nearby therapists</div>
    </div>
  `;
  
  // Immediately request geolocation
  if (navigator.geolocation) {
    console.log('üåç Requesting geolocation permission...');
    
    navigator.geolocation.getCurrentPosition(
      function(position) {
        console.log('‚úÖ Geolocation permission granted!', position);
        
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;
        
        console.log(`üìç User location: ${userLat}, ${userLng}`);
        
        // Initialize map and sort therapists by distance
        initializeMapWithUserLocation(userLat, userLng);
        sortTherapistsByDistance(userLat, userLng);
        
        // Repopulate therapist cards with sorted data
        if (typeof window.forcePopulateLocationCards === 'function') {
          window.forcePopulateLocationCards();
        } else if (typeof window.populateLocationCards === 'function') {
          window.populateLocationCards();
        }
      },
      function(error) {
        console.error('‚ùå Geolocation permission denied or failed:', error);
        
        let errorMsg = 'Location access denied';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMsg = 'Location access denied - Please enable location in browser settings';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMsg = 'Location unavailable - Check GPS/internet connection';
            break;
          case error.TIMEOUT:
            errorMsg = 'Location request timed out - Please try again';
            break;
        }
        
        // Show error message
        mapContainer.innerHTML = `
          <div class="text-center p-8">
            <div class="text-yellow-500 text-4xl mb-4">‚ö†Ô∏è</div>
            <div class="text-lg font-semibold text-gray-700 mb-2">Location Access Issue</div>
            <div class="text-sm text-gray-500 mb-4">${errorMsg}</div>
            <div class="text-xs text-gray-400">Using default location (Athens, Greece)</div>
          </div>
        `;
        
        // Use default Athens location
        setTimeout(() => {
          initializeMapWithUserLocation(37.9838, 23.7275);
          sortTherapistsByDistance(37.9838, 23.7275);
          if (typeof populateTherapistCards === 'function') {
            window.forcePopulateLocationCards();
          }
        }, 2000);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  } else {
    console.error('‚ùå Geolocation not supported');
    
    // Show not supported message
    mapContainer.innerHTML = `
      <div class="text-center p-8">
        <div class="text-red-500 text-4xl mb-4">‚ùå</div>
        <div class="text-lg font-semibold text-gray-700 mb-2">Geolocation Not Supported</div>
        <div class="text-sm text-gray-500 mb-4">Your browser doesn't support location services</div>
        <div class="text-xs text-gray-400">Using default location (Athens, Greece)</div>
      </div>
    `;
    
    // Use default Athens location
    setTimeout(() => {
      initializeMapWithUserLocation(37.9838, 23.7275);
      sortTherapistsByDistance(37.9838, 23.7275);
      if (typeof populateTherapistCards === 'function') {
        window.forcePopulateLocationCards();
      }
    }, 2000);
  }
}

function initializeMapWithUserLocation(userLat, userLng) {
  console.log('üó∫Ô∏è initializeMapWithUserLocation called with:', userLat, userLng);
  
  const mapContainer = document.getElementById('map-container');
  if (!mapContainer) {
    console.error('‚ùå Map container not found');
    return;
  }
  
  // Check if Google Maps is available
  if (typeof google !== 'undefined' && google.maps) {
    createMapWithLocation(userLat, userLng);
  } else {
    console.log('‚è≥ Waiting for Google Maps API...');
    
    let attempts = 0;
    const checkGoogle = setInterval(() => {
      attempts++;
      if (typeof google !== 'undefined' && google.maps) {
        clearInterval(checkGoogle);
        createMapWithLocation(userLat, userLng);
      } else if (attempts > 50) { // 5 seconds timeout
        clearInterval(checkGoogle);
        showMapFallback(userLat, userLng);
      }
    }, 100);

// Immediate setup as backup
(function() {
})();  }
}

function createMapWithLocation(userLat, userLng) {
  const mapContainer = document.getElementById('map-container');
  
  try {
    console.log('üó∫Ô∏è Creating Google Map...');
    
    const map = new google.maps.Map(mapContainer, {
      center: { lat: userLat, lng: userLng },
      zoom: 14,
      styles: [
        {
          featureType: "all",
          elementType: "geometry.fill",
          stylers: [{ saturation: -20 }, { lightness: 10 }]
        },
        {
          featureType: "water",
          elementType: "geometry.fill",
          stylers: [{ color: "#e3f2fd" }]
        }
      ]
    });
    
    // Add user location marker
    new google.maps.Marker({
      position: { lat: userLat, lng: userLng },
      map: map,
      title: "Your Location",
      icon: {
        url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
          <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" fill="#4285f4" stroke="white" stroke-width="3"/>
            <circle cx="12" cy="12" r="4" fill="white"/>
          </svg>
        `),
        scaledSize: new google.maps.Size(24, 24)
      }
    });
    
    // Add therapist markers if they exist
    if (window.therapistData) {
      window.therapistData.forEach((therapist) => {
        if (therapist.lat && therapist.lng) {
          const marker = new google.maps.Marker({
            position: { lat: therapist.lat, lng: therapist.lng },
            map: map,
            title: therapist.name,
            icon: {
              url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
                <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="14" cy="14" r="12" fill="#10b981" stroke="white" stroke-width="2"/>
                  <text x="14" y="19" text-anchor="middle" fill="white" font-size="8">üë®‚Äç‚öïÔ∏è</text>
                </svg>
              `),
              scaledSize: new google.maps.Size(28, 28)
            }
          });
          
          const infoWindow = new google.maps.InfoWindow({
            content: `
              <div class="p-3 text-center max-w-xs">
                <img src="${therapist.photo}" alt="${therapist.first_name} ${therapist.last_name}" class="w-16 h-16 rounded-full mx-auto mb-2 object-cover">
                <h3 class="font-semibold text-gray-800 mb-1">${therapist.first_name} ${therapist.last_name}</h3>
                <p class="text-sm text-blue-600 mb-1">${therapist.title}</p>
                <p class="text-sm text-gray-600 mb-1">\${therapist.therapy_approaches && therapist.therapy_approaches.length > 0 ? therapist.therapy_approaches[0] : "General Therapy"}</p>
                <p class="text-xs text-gray-500 mb-2">${therapist.distance ? therapist.distance.toFixed(1) + ' km away' : ''}</p>
                <button onclick="selectTherapist(${therapist.id})" class="px-3 py-1 rounded text-sm" style="background-color: #446081; color: white; border: none; font-family: system-ui, -apple-system, BlinkMacSystemFont;">Select</button>
              </div>
            `
          });
          
          // Close any previously opened info window
        if (window.currentInfoWindow) {
          window.currentInfoWindow.close();
        }
        
        marker.addListener("click", () => {
          // Close any previously opened info window
          if (window.currentInfoWindow) {
            window.currentInfoWindow.close();
          }
          // Set this as the current info window
          window.currentInfoWindow = infoWindow;
            infoWindow.open(map, marker);
          });
        }
      });
    }
    
    console.log('‚úÖ Google Map created successfully');
    
  } catch (error) {
    console.error('‚ùå Error creating Google Map:', error);
    showMapFallback(userLat, userLng);
  }
}

function showMapFallback(userLat, userLng) {
  const mapContainer = document.getElementById('map-container');
  if (mapContainer) {
    mapContainer.innerHTML = `
      <div class="text-center p-8">
        <div class="text-blue-500 text-4xl mb-4">üìç</div>
        <div class="text-lg font-semibold text-gray-700 mb-2">Location Found</div>
        <div class="text-sm text-gray-600 mb-2">Lat: ${userLat.toFixed(4)}, Lng: ${userLng.toFixed(4)}</div>
        <div class="text-xs text-gray-500">Map temporarily unavailable</div>
      </div>
    `;
  }
}

function sortTherapistsByDistance(userLat, userLng) {
  if (!window.therapistData) {
    console.warn('‚ö†Ô∏è No therapist data available for sorting');
    return;
  }
  
  console.log('üìä Calculating distances using REAL therapist addresses...');
  
  // Use the real address distance calculation from therapist-data.js
  if (typeof window.updateTherapistDistances === 'function') {
    window.updateTherapistDistances(userLat, userLng);
  } else {
    // Fallback: Calculate distances for each therapist using real address coordinates
  window.therapistData.forEach((therapist, index) => {
      const addressCoords = window.therapistAddressCoordinates?.[therapist.id];
      if (addressCoords) {
        // Use exact address coordinates
        therapist.lat = addressCoords.lat;
        therapist.lng = addressCoords.lng;
    
    // Calculate distance using existing calculateDistance function if available
    if (typeof calculateDistance === 'function') {
          therapist.distance = calculateDistance(userLat, userLng, addressCoords.lat, addressCoords.lng);
    } else {
      // Fallback distance calculation
      const R = 6371; // Earth radius in km
          const dLat = (addressCoords.lat - userLat) * Math.PI / 180;
          const dLng = (addressCoords.lng - userLng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(userLat * Math.PI / 180) * Math.cos(addressCoords.lat * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      therapist.distance = R * c;
        }
      } else {
        console.warn(`‚ö†Ô∏è No address coordinates found for therapist ID ${therapist.id}`);
        // Fallback to city coordinates
        const cityCoords = window.cityCoordinates?.[therapist.cityKey];
        if (cityCoords) {
          therapist.lat = cityCoords.lat;
          therapist.lng = cityCoords.lng;
          
          if (typeof calculateDistance === 'function') {
            therapist.distance = calculateDistance(userLat, userLng, cityCoords.lat, cityCoords.lng);
          } else {
            // Fallback distance calculation
            const R = 6371; // Earth radius in km
            const dLat = (cityCoords.lat - userLat) * Math.PI / 180;
            const dLng = (cityCoords.lng - userLng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(userLat * Math.PI / 180) * Math.cos(cityCoords.lat * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            therapist.distance = R * c;
          }
        }
    }
  });
  
  // Sort by distance (closest first)
  window.therapistData.sort((a, b) => a.distance - b.distance);
  }
  
  console.log('‚úÖ Therapists sorted by REAL address distance:', 
    window.therapistData.map(t => `${t.first_name} ${t.last_name}: ${t.distance.toFixed(1)}km`));
}

console.log('‚úÖ Missing location functions created');
</script>

<script>
// ===== THERAPIST CARDS FUNCTIONALITY =====

function populateTherapistCards() {
  console.log('üë• populateTherapistCards called');
  
  const container = document.getElementById('therapist-cards-container');
  if (!container) {
    console.error('‚ùå Therapist cards container not found');
    return;
  }
  
  if (!window.therapistData || window.therapistData.length === 0) {
    console.warn('‚ö†Ô∏è No therapist data available');
    container.innerHTML = `
      <div class="col-span-full text-center p-8">
        <div class="text-gray-500 text-4xl mb-4">üë®‚Äç‚öïÔ∏è</div>
        <div class="text-lg font-semibold text-gray-700 mb-2">No Therapists Available</div>
        <div class="text-sm text-gray-500">Please try again later</div>
      </div>
    `;
    return;
  }
  
  console.log(`üìä Populating ${window.therapistData.length} therapist cards`);
  
  // Clear container and set grid layout
  container.innerHTML = '';
  container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6';
  
  // Create cards for all therapists (they're already sorted by distance)
  window.therapistData.forEach((therapist, index) => {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden';
    card.style.border = '1px solid #001233';  // Thin border with specified color
    
    const distanceText = therapist.distance ? `${therapist.distance.toFixed(1)} km away` : 'Distance unknown';
    const photoSrc = therapist.photo || 'therapist1.png';
    const therapistTitle = therapist.title || 'Therapist';
    const therapistArea = therapist.area || 'Athens';
    const therapistCity = therapist.city || 'Athens';
    const therapistSpecialty = therapist.therapy_approaches ? therapist.therapy_approaches[0] : 'General Therapy';
    
    card.innerHTML = `
      <div class="p-6">
        <!-- Header with photo and basic info -->
        <div class="flex items-center space-x-4 mb-4">
          <div>
            <img src="${photoSrc}" alt="${therapist.first_name} ${therapist.last_name}" 
                 class="w-16 h-16 rounded-full object-cover border-2 border-gray-300"
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSIyMCIgeT0iMjAiPgo8cGF0aCBkPSJNMTIgMTJDMTQuMjA5MSAxMiAxNiAxMC4yMDkxIDE2IDhDMTYgNS43OTA5IDE0LjIwOTEgNCAxMiA0QzkuNzkwODYgNCA4IDUuNzkwOSA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSIjOUI5Qzk5Ii8+CjxwYXRoIGQ9Ik0xMiAxNEM5LjMzIDEyIDQgMTUuMzMgNCAyMFYyMEgxMkwyMCAyMFYyMEMyMCAxNS4zMyAxNC42NyAxNCAxMiAxNFoiIGZpbGw9IiM5QjlDOTkiLz4KPC9zdmc+Cjwvc3ZnPgo='">
          </div>
          <div class="flex-1 min-w-0">
            <h3 class="text-lg font-semibold break-words" style="color: #0a2342;">${therapist.first_name} ${therapist.last_name}</h3>
            <p class="text-sm text-blue-600 font-medium">${therapistTitle}</p>
            <p class="text-xs" style="color: #6b7280;">${therapistArea}, ${therapistCity}</p>
          </div>
        </div>
        
        <!-- Distance and specialty info (NO STARS/RATINGS) -->
        <div class="mb-4 space-y-2">
          <div class="flex items-center space-x-2">
            <span class="text-sm font-medium" style="color: #6b7280;">${distanceText}</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-sm" style="color: #6b7280;">${therapistSpecialty}</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-xs font-medium" style="color: #6b7280;">‚Ç¨${therapist.cost || 75}/session</span>
          </div>
        </div>
        
        <!-- Action buttons -->
        <div class="flex space-x-3">
          <button onclick="viewTherapistProfile(${therapist.id})" 
                  class="flex-1 px-4 py-2 text-sm font-medium rounded-lg transition-colors duration-200"
                  style="background-color: #f5f5f7; color: #446081; border: 1px solid #e5e5e7; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
            View Profile
          </button>
          <button onclick="selectTherapist(${therapist.id})" 
                  class="flex-1 px-4 py-2 text-white text-sm font-medium rounded-lg transition-colors duration-200"
                  style="background-color: #446081; border: none; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
            Select
          </button>
        </div>
      </div>
    `;
    
    container.appendChild(card);
  });
  
  console.log(`‚úÖ ${window.therapistData.length} therapist cards populated successfully`);
}

// Function to view therapist profile
function viewTherapistProfile(therapistId) {
  console.log('üë§ Viewing profile for therapist ID:', therapistId);
  
  const therapist = window.therapistData.find(t => t.id === therapistId);
  if (!therapist) {
    alert('Therapist not found');
    return;
  }
  
  // Create modal for therapist profile
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
  modal.onclick = function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  };
  
  const distanceText = therapist.distance ? `${therapist.distance.toFixed(1)} km away` : 'Distance unknown';
  
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-900">Therapist Profile</h2>
          <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </div>
        
        <!-- Profile content -->
        <div class="space-y-6">
          <!-- Basic info -->
          <div class="flex items-center space-x-4">
            <img src="${therapist.photo || 'therapist1.png'}" alt="${therapist.first_name} ${therapist.last_name}" 
                 class="w-24 h-24 rounded-full object-cover border-4 border-gray-300">
            <div>
              <h3 class="text-xl font-semibold text-gray-900">${therapist.first_name} ${therapist.last_name}</h3>
              <p class="text-blue-600 font-medium">${therapist.title || 'Therapist'}</p>
              <p class="text-gray-600">${therapist.area || 'Athens'}, ${therapist.city || 'Athens'}</p>
              <p class="text-green-600 font-medium">üìç ${distanceText}</p>
            </div>
          </div>
          
          <!-- Details -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-semibold text-gray-900 mb-2">Specialty</h4>
        <p class="text-gray-600">${therapist.therapy_approaches ? therapist.therapy_approaches[0] : 'General Therapy'}</p>
            </div>
            
            ${therapist.experience ? `
              <div>
                <h4 class="font-semibold text-gray-900 mb-2">Experience</h4>
                <p class="text-gray-600">${therapist.experience}</p>
              </div>
            ` : ''}
            
            ${therapist.education ? `
              <div class="md:col-span-2">
                <h4 class="font-semibold text-gray-900 mb-2">Education</h4>
                <p class="text-gray-600">${therapist.education}</p>
              </div>
            ` : ''}
            
            ${therapist.languages ? `
              <div>
                <h4 class="font-semibold text-gray-900 mb-2">Languages</h4>
                <p class="text-gray-600">${therapist.languages}</p>
              </div>
            ` : ''}
          </div>
          
          ${therapist.bio ? `
            <div>
              <h4 class="font-semibold text-gray-900 mb-2">About</h4>
              <p class="text-gray-600">${therapist.bio}</p>
            </div>
          ` : ''}
          
          <!-- Action buttons -->
          <div class="flex space-x-4 pt-4 border-t border-gray-200">
            <button onclick="this.closest('.fixed').remove()" 
                    class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors">
              Close
            </button>
            <button onclick="selectTherapist(${therapist.id}); this.closest('.fixed').remove();" 
                    class="flex-1 px-6 py-3 text-white font-medium rounded-lg transition-colors" style="background-color: #446081; border: none; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
              Select Therapist
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// (Removed duplicate selectTherapist function - using the global window.selectTherapist instead)

console.log('‚úÖ Therapist cards functionality created');
</script>

<script>
// ===== EXTERNAL THERAPIST DATASET =====
// Therapist data is loaded from external therapist-data.js file
// This loads and merges therapists from both static data and localStorage registration system

console.log('üìÑ Using external therapist data from therapist-data.js with localStorage integration');

// Manually trigger localStorage integration when this script loads
setTimeout(() => {
  if (window.loadAndMergeLocalStorageTherapists) {
    console.log('üîÑ USER-PANEL: Manually triggering localStorage integration...');
    const addedTherapists = window.loadAndMergeLocalStorageTherapists();
    if (addedTherapists.length > 0) {
      console.log(`‚úÖ USER-PANEL: Added ${addedTherapists.length} therapists from registration system`);
      
      // Force repopulate cards to show new therapists using direct container targeting
      setTimeout(() => {
        console.log('üéØ USER-PANEL: Force repopulating with new therapists using direct targeting...');
        
        // Target location container directly with simplePopulate
        const locationContainer = document.getElementById('therapist-cards-container');
        if (locationContainer && window.simplePopulate) {
          console.log('üéØ USER-PANEL: Populating location container directly');
          window.simplePopulate(locationContainer, true); // true = show distance
        }
        
        // Target criteria container
        const criteriaContainer = document.getElementById('criteria-therapist-cards-container');
        if (criteriaContainer && window.populateCriteriaCards) {
          console.log('üéØ USER-PANEL: Populating criteria container');
          window.populateCriteriaCards();
        }
        
        // Also call other functions as backup
        if (window.populateTherapistCards) window.populateTherapistCards();
        if (window.populateLocationCards) window.populateLocationCards();
        if (window.forcePopulateLocationCards) window.forcePopulateLocationCards();
        
      }, 500);
    } else {
      console.log('‚ÑπÔ∏è USER-PANEL: No new therapists found in localStorage');
    }
  } else {
    console.log('‚ö†Ô∏è USER-PANEL: localStorage integration function not available yet');
  }
}, 1000);

// Debug function to check current therapist data
window.debugTherapistData = function() {
  console.log('üîç THERAPIST DATA DEBUG:');
  console.log(`üìä Total therapists: ${window.therapistData ? window.therapistData.length : 0}`);
  
  if (window.therapistData && window.therapistData.length > 0) {
    const recentTherapists = window.therapistData.slice(-5);
    console.log('üìã Last 5 therapists:');
    recentTherapists.forEach(t => {
      console.log(`  - Dr. ${t.first_name} ${t.last_name} (ID: ${t.id}) - ${t.area}, ${t.city}`);
    });
  }
  
  // Check localStorage
  const savedData = localStorage.getItem('therapistData');
  if (savedData) {
    try {
      const localTherapists = JSON.parse(savedData);
      console.log(`üíæ localStorage has ${localTherapists.length} therapists`);
    } catch (e) {
      console.log('‚ùå Error reading localStorage therapist data');
    }
  } else {
    console.log('üì≠ No therapist data in localStorage');
  }
  
  return window.therapistData;
};

// Manual test function to force refresh localStorage data and repopulate cards
window.testLocalStorageIntegration = function() {
  console.log('üß™ TESTING localStorage integration...');
  
  // First, check current state
  const currentCount = window.therapistData ? window.therapistData.length : 0;
  console.log(`üìä Current therapists: ${currentCount}`);
  
  // Force reload from localStorage
  if (window.loadAndMergeLocalStorageTherapists) {
    const added = window.loadAndMergeLocalStorageTherapists();
    console.log(`‚ûï Added from localStorage: ${added.length}`);
    
    if (added.length > 0) {
      // Force repopulate location cards immediately
      const locationContainer = document.getElementById('therapist-cards-container');
      if (locationContainer && window.simplePopulate) {
        console.log('üéØ TEST: Force populating location container...');
        window.simplePopulate(locationContainer, true);
        console.log('‚úÖ TEST: Location cards updated');
      } else {
        console.log('‚ùå TEST: Location container or simplePopulate function not found');
      }
      
      // Force repopulate criteria cards
      const criteriaContainer = document.getElementById('criteria-therapist-cards-container');
      if (criteriaContainer && window.populateCriteriaCards) {
        console.log('üéØ TEST: Force populating criteria container...');
        window.populateCriteriaCards();
        console.log('‚úÖ TEST: Criteria cards updated');
      } else {
        console.log('‚ùå TEST: Criteria container or populateCriteriaCards function not found');
      }
      
      return `‚úÖ Successfully added ${added.length} therapists from localStorage and updated both location and criteria cards`;
    } else {
      return '‚ÑπÔ∏è No new therapists found in localStorage';
    }
  } else {
    return '‚ùå localStorage integration function not available';
  }
};

// Test function specifically for criteria step
window.testCriteriaStep = function() {
  console.log('üß™ TESTING criteria step specifically...');
  
  // Check if criteria container exists
  const criteriaContainer = document.getElementById('criteria-therapist-cards-container');
  if (!criteriaContainer) {
    return '‚ùå Criteria container not found - make sure you are on the criteria step';
  }
  
  // Force load localStorage data
  if (window.loadAndMergeLocalStorageTherapists) {
    const added = window.loadAndMergeLocalStorageTherapists();
    console.log(`‚ûï Added ${added.length} therapists from localStorage`);
  }
  
  // Check current therapist count
  const currentCount = window.therapistData ? window.therapistData.length : 0;
  console.log(`üìä Total therapists available: ${currentCount}`);
  
  // Force refresh criteria
  if (window.initializeDynamicFilters) {
    console.log('üîÑ Refreshing dynamic filters...');
    window.initializeDynamicFilters();
  }
  
  if (window.populateCriteriaCards) {
    console.log('üîÑ Refreshing criteria cards...');
    window.populateCriteriaCards();
  }
  
  return `‚úÖ Criteria step refreshed with ${currentCount} total therapists`;
};

console.log('‚úÖ User panel therapist integration setup complete');
console.log('üí° To test integration manually, run: window.testLocalStorageIntegration()');

// ===== SIMPLIFIED BOOKING RESET FIX =====
// Define the missing agreeAndReturnToTherapists function
window.agreeAndReturnToTherapists = function() {
  console.log("üîÑ Browse Therapists clicked - returning to selection");
  
  // CRITICAL: Completely reset booking state to ensure clean slate
  window.bookingState = {
    currentTherapist: null,
    selectedDate: null,
    selectedTime: null,
    selectedDuration: 1,
    selectedService: null,
    currentMonth: new Date().getMonth(),
    currentYear: new Date().getFullYear()
  };
  
  // Hide booking completion section
  const bookingCompleted = document.getElementById('booking-completed-section');
  if (bookingCompleted) {
    bookingCompleted.classList.add('hidden');
    bookingCompleted.style.display = 'none';
  }
  
  // Hide booking step
  const bookingStep = document.getElementById('therapist-step-booking');
  if (bookingStep) {
    bookingStep.classList.add('hidden');
    bookingStep.style.display = 'none';
  }
  
  // CRITICAL: Clear only the content that needs to be reset, not the containers themselves
  // Clear therapist info and services - these will be repopulated
  const therapistInfo = document.getElementById('booking-therapist-info');
  if (therapistInfo) {
    therapistInfo.innerHTML = '';
  }
  
  const servicesContainer = document.getElementById('booking-services-container');
  if (servicesContainer) {
    servicesContainer.innerHTML = '';
  }
  
  // Clear appointment summary if visible
  const appointmentSummary = document.getElementById('appointment-summary');
  if (appointmentSummary) {
    appointmentSummary.classList.add('hidden');
    const appointmentDetails = document.getElementById('appointment-details');
    if (appointmentDetails) {
      appointmentDetails.innerHTML = '';
    }
  }
  
  // Clear all time slot period containers
  const timePeriods = ['morning-slots', 'noon-slots', 'afternoon-slots', 'evening-slots', 'night-slots'];
  timePeriods.forEach(periodId => {
    const periodContainer = document.getElementById(periodId);
    if (periodContainer) {
      periodContainer.classList.add('hidden');
      const slotsContainer = periodContainer.querySelector(`[data-period]`);
      if (slotsContainer) slotsContainer.innerHTML = '';
    }
  });
  
  // Reset all service options to default state
  document.querySelectorAll('.service-option').forEach(option => {
    option.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200', 'hidden');
    option.classList.add('border-gray-200', 'bg-gray-50');
  });
  
  // Remove any change service buttons
  document.querySelectorAll('.change-service-btn').forEach(btn => btn.remove());
  
  // Hide booking sections that should be hidden initially
  const sectionsToHide = [
    'service-notes-section',
    'quick-appointments-section', 
    'calendar-section',
    'appointment-summary',
    'time-slots-container'
  ];
  
  sectionsToHide.forEach(sectionId => {
    const section = document.getElementById(sectionId);
    if (section) {
      section.classList.add('hidden');
      section.style.display = 'none';
    }
  });
  
  // Show the service selection container parent (it might have been hidden)
  const serviceContainer = document.getElementById('booking-services-container');
  if (serviceContainer) {
    let parent = serviceContainer.parentElement;
    while (parent && !parent.classList.contains('bg-white')) {
      parent = parent.parentElement;
    }
    if (parent) {
      parent.style.display = '';
      parent.classList.remove('hidden');
    }
  }
  
  // CRITICAL: Clear all dynamic content that might have stale event handlers
  const calendarDays = document.getElementById('calendar-days-container');
  if (calendarDays) {
    calendarDays.innerHTML = '';
    console.log('‚úÖ Calendar days container cleared');
  }
  
  const quickAppointments = document.getElementById('quick-appointments-container');
  if (quickAppointments) {
    quickAppointments.innerHTML = '';
    console.log('‚úÖ Quick appointments container cleared');
  }
  
  const timeSlots = document.getElementById('time-slots-container');
  if (timeSlots) {
    timeSlots.innerHTML = '';
    console.log('‚úÖ Time slots container cleared');
  }
  
  // Clear all time period containers
  const timePeriods = ['morning-slots', 'noon-slots', 'afternoon-slots', 'evening-slots', 'night-slots'];
  timePeriods.forEach(periodId => {
    const periodContainer = document.getElementById(periodId);
    if (periodContainer) {
      const slotsContainer = periodContainer.querySelector('[data-period]');
      if (slotsContainer) {
        slotsContainer.innerHTML = '';
      }
    }
  });
  
  // Use the existing goBackFromBooking function from therapist-booking.js
  // It already handles navigation back to the appropriate step
  if (window.goBackFromBooking && typeof window.goBackFromBooking === 'function') {
    window.goBackFromBooking();
  } else {
    // Fallback: Navigate to step 2 directly
    window.navigateToTherapistStepTwo();
  }
  
  console.log("‚úÖ Returned to therapist selection with completely cleared booking state and UI");
};
</script>

<script>
// ===== OVERRIDING THERAPIST FUNCTIONS WITH IMPROVEMENTS =====

// Load the improvements
eval(fetch('/therapist_improvements.js').then(r => r.text()).catch(() => ''));

// Enhanced profile modal with smaller fonts and more details
function viewTherapistProfile(therapistId) {
  console.log('üë§ Viewing enhanced profile for therapist ID:', therapistId);
  
  const therapist = window.therapistData.find(t => t.id === therapistId);
  if (!therapist) {
    alert('Therapist not found');
    return;
  }
  
  // Create modal for therapist profile
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
  modal.onclick = function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  };
  
  const distanceText = therapist.distance ? `${therapist.distance.toFixed(1)} km away` : 'Distance unknown';
  const isMobile = window.innerWidth < 768;
  
  // Update modal padding for proper spacing
  modal.className = `fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center ${isMobile ? 'p-4' : 'p-8'}`;
  
  // Mobile-responsive text sizes
  const textSizes = isMobile ? {
    header: 'text-lg',
    name: 'text-base',
    title: 'text-xs',
    section: 'text-xs font-semibold',
    content: 'text-xs',
    button: 'text-xs'
  } : {
    header: 'text-xl',
    name: 'text-lg',
    title: 'text-sm',
    section: 'text-sm font-semibold',
    content: 'text-sm',
    button: 'text-sm'
  };
  
  modal.innerHTML = `
    <div class="bg-white rounded-3xl shadow-xl ${isMobile ? 'max-w-xs' : 'max-w-4xl'} w-full ${isMobile ? 'max-h-[85vh]' : 'max-h-[75vh]'} overflow-hidden" style="border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);">
      <div class="${isMobile ? 'p-4' : 'p-6'}">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <h2 class="${isMobile ? 'text-lg' : 'text-xl'} font-semibold" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
            Profile
          </h2>
          <button onclick="this.closest('.fixed').remove()" 
                  class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors duration-200" 
                  style="color: #86868b;">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        ${isMobile ? `
        <!-- Mobile: Vertical layout -->
        <div class="max-h-[55vh] overflow-y-auto pr-1" style="-webkit-overflow-scrolling: touch;">
          <div class="space-y-4">
            <!-- Basic info with compact photo -->
            <div class="text-center">
              <img src="${therapist.photo || therapist.image || 'User Panel Media/therapist1.png'}" 
                   alt="Dr. ${therapist.first_name} ${therapist.last_name}" 
                   class="w-16 h-16 rounded-2xl mx-auto mb-3 object-cover shadow-sm"
                   style="border: 1px solid rgba(0, 0, 0, 0.08);">
              <h3 class="text-base font-semibold mb-1" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
                Dr. ${therapist.first_name} ${therapist.last_name}
              </h3>
              <p class="text-sm font-medium mb-2" style="color: #446081;">
                ${therapist.title || 'Therapist'}
              </p>
              <div class="space-y-0.5 mb-3">
                <p class="text-xs" style="color: #86868b;">
                  ${therapist.area || 'Athens'}, ${therapist.city || 'Athens'}
                </p>
                <p class="text-xs font-medium" style="color: #1d1d1f;">
                  ${distanceText}
                </p>
                ${therapist.cost ? `<p class="text-xs font-medium" style="color: #1d1d1f;">‚Ç¨${therapist.cost}<span class="font-normal" style="color: #86868b;">/session</span></p>` : ''}
              </div>
            </div>
            
            <!-- Details sections with compact spacing -->
            <div class="space-y-3">
        ` : `
        <!-- Desktop: Horizontal layout -->
        <div class="flex gap-6 max-h-[55vh]">
          <!-- Left side: Photo and basic info -->
          <div class="flex-shrink-0 w-64 text-center">
            <img src="${therapist.photo || therapist.image || 'User Panel Media/therapist1.png'}" 
                 alt="Dr. ${therapist.first_name} ${therapist.last_name}" 
                 class="w-32 h-32 rounded-2xl mx-auto mb-4 object-cover shadow-sm"
                 style="border: 1px solid rgba(0, 0, 0, 0.08);">
            <h3 class="text-xl font-semibold mb-2" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
              Dr. ${therapist.first_name} ${therapist.last_name}
            </h3>
            <p class="text-base font-medium mb-3" style="color: #446081;">
              ${therapist.title || 'Therapist'}
            </p>
            <div class="space-y-1">
              <p class="text-sm" style="color: #86868b;">
                ${therapist.area || 'Athens'}, ${therapist.city || 'Athens'}
              </p>
              <p class="text-sm font-medium" style="color: #1d1d1f;">
                ${distanceText}
              </p>
              ${therapist.cost ? `<p class="text-sm font-medium" style="color: #1d1d1f;">‚Ç¨${therapist.cost}<span class="font-normal" style="color: #86868b;">/session</span></p>` : ''}
            </div>
          </div>
          
          <!-- Right side: Details -->
          <div class="flex-1 overflow-y-auto pr-2" style="-webkit-overflow-scrolling: touch;">
            <div class="grid grid-cols-1 gap-4">
        `}
              <div class="bg-gray-50 rounded-xl p-3">
                <h4 class="${isMobile ? 'text-xs' : 'text-sm'} font-semibold mb-1" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                  Specialty
                </h4>
                <p class="${isMobile ? 'text-xs' : 'text-sm'}" style="color: #86868b; line-height: 1.3;">
                  ${therapist.therapy_approaches ? therapist.therapy_approaches.join(', ') : 'General Therapy'}
                </p>
              </div>
              
              ${therapist.experience ? `
                <div class="bg-gray-50 rounded-xl p-3">
                  <h4 class="${isMobile ? 'text-xs' : 'text-sm'} font-semibold mb-1" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                    Experience
                  </h4>
                  <p class="${isMobile ? 'text-xs' : 'text-sm'}" style="color: #86868b; line-height: 1.3;">
                    ${therapist.experience}
                  </p>
                </div>
              ` : ''}
              
              ${therapist.education ? `
                <div class="bg-gray-50 rounded-xl p-3">
                  <h4 class="${isMobile ? 'text-xs' : 'text-sm'} font-semibold mb-1" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                    Education
                  </h4>
                  <p class="${isMobile ? 'text-xs' : 'text-sm'}" style="color: #86868b; line-height: 1.3;">
                    ${therapist.education}
                  </p>
                </div>
              ` : ''}
              
              ${therapist.languages ? `
                <div class="bg-gray-50 rounded-xl p-3">
                  <h4 class="${isMobile ? 'text-xs' : 'text-sm'} font-semibold mb-1" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                    Languages
                  </h4>
                  <p class="${isMobile ? 'text-xs' : 'text-sm'}" style="color: #86868b; line-height: 1.3;">
                    ${Array.isArray(therapist.languages) ? therapist.languages.join(', ') : therapist.languages}
                  </p>
                </div>
              ` : ''}
              
              ${therapist.about || therapist.bio ? `
                <div class="bg-gray-50 rounded-xl p-3">
                  <h4 class="${isMobile ? 'text-xs' : 'text-sm'} font-semibold mb-1" style="color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
                    About
                  </h4>
                  <p class="${isMobile ? 'text-xs' : 'text-sm'}" style="color: #86868b; line-height: 1.3;">
                    ${therapist.about || therapist.bio}
                  </p>
                </div>
              ` : ''}
            </div>
            ${isMobile ? '</div>' : '</div>'}
          </div>
        ${isMobile ? '</div>' : '</div>'}
        
        <!-- Action buttons -->
        <div class="flex space-x-3 pt-4 border-t border-gray-100 mt-4 ${isMobile ? 'pb-4 px-2' : 'pb-5 px-4'}">
          <button onclick="this.closest('.fixed').remove()" 
                  class="flex-1 ${isMobile ? 'py-2.5 px-3' : 'py-3 px-4'} rounded-xl font-medium ${isMobile ? 'text-xs' : 'text-sm'} transition-all duration-200 hover:opacity-90"
                  style="background-color: #f5f5f7; color: #446081; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
            Close
          </button>
          <button onclick="selectTherapist(${therapist.id}); this.closest('.fixed').remove();" 
                  class="flex-1 ${isMobile ? 'py-2.5 px-3' : 'py-3 px-4'} rounded-xl font-medium ${isMobile ? 'text-xs' : 'text-sm'} transition-all duration-200 hover:opacity-90"
                  style="background-color: #446081; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont;">
            Select Therapist
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Enhanced map creation with blue markers and larger info windows
function createMapWithLocation(userLat, userLng) {
  const mapContainer = document.getElementById('map-container');
  
  try {
    console.log('üó∫Ô∏è Creating Google Map with blue markers...');
    
    const map = new google.maps.Map(mapContainer, {
      center: { lat: userLat, lng: userLng },
      zoom: 14,
      styles: [
        {
          featureType: "all",
          elementType: "geometry.fill",
          stylers: [{ saturation: -20 }, { lightness: 10 }]
        },
        {
          featureType: "water",
          elementType: "geometry.fill",
          stylers: [{ color: "#e3f2fd" }]
        }
      ]
    });
    
    // Add user location marker
    new google.maps.Marker({
      position: { lat: userLat, lng: userLng },
      map: map,
      title: "Your Location",
      icon: {
        url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
          <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" fill="#4285f4" stroke="white" stroke-width="3"/>
            <circle cx="12" cy="12" r="4" fill="white"/>
          </svg>
        `),
        scaledSize: new google.maps.Size(24, 24)
      }
    });
    
    // Add therapist markers with BLUE color and larger info windows
    if (window.therapistData) {
      window.therapistData.forEach((therapist) => {
        if (therapist.lat && therapist.lng) {
          const marker = new google.maps.Marker({
            position: { lat: therapist.lat, lng: therapist.lng },
            map: map,
            title: therapist.name,
            icon: {
              url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
                <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="14" cy="14" r="12" fill="#3b82f6" stroke="white" stroke-width="2"/>
                  <text x="14" y="19" text-anchor="middle" fill="white" font-size="8">üë®‚Äç‚öïÔ∏è</text>
                </svg>
              `),
              scaledSize: new google.maps.Size(28, 28)
            }
          });
          
          // Larger info window
          const infoWindow = new google.maps.InfoWindow({
            content: `
              <div class="p-2 text-center" style="min-width: 180px; max-width: 220px; height: auto; max-height: none;">
                <img src="${therapist.photo}" alt="${therapist.first_name} ${therapist.last_name}" class="w-10 h-10 rounded-full mx-auto mb-1 object-cover border border-gray-300">
                <h3 class="font-semibold text-gray-800 mb-1 text-xs leading-tight">${therapist.first_name} ${therapist.last_name}</h3>
                <p class="text-xs text-blue-600 mb-1 font-medium leading-tight">${therapist.title}</p>
                
                <p class="text-xs text-gray-500 mb-1 leading-tight">${therapist.area}, ${therapist.city}</p>
                
                ${therapist.cost ? `<p class="text-xs text-black font-medium mb-1 leading-tight">${therapist.cost}/session</p>` : ''}
                <div class="flex space-x-1 mt-1">
                  <button onclick="viewTherapistProfile(${therapist.id})" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-xs font-medium transition-colors">Profile</button>
                  <button onclick="selectTherapist(${therapist.id})" class="flex-1 px-3 py-2 rounded text-xs font-medium transition-colors" style="background-color: #446081; color: white; border: none; font-family: system-ui, -apple-system, BlinkMacSystemFont;">Select</button>
                </div>
              </div>
            `
          });
          
          // Close any previously opened info window
        if (window.currentInfoWindow) {
          window.currentInfoWindow.close();
        }
        
        marker.addListener("click", () => {
          // Close any previously opened info window
          if (window.currentInfoWindow) {
            window.currentInfoWindow.close();
          }
          // Set this as the current info window
          window.currentInfoWindow = infoWindow;
            infoWindow.open(map, marker);
          });
        }
      });
    }
    
    console.log('‚úÖ Google Map created successfully with blue markers and enhanced info windows');
    
  } catch (error) {
    console.error('‚ùå Error creating Google Map:', error);
    showMapFallback(userLat, userLng);
  }
}

// Apply improvements automatically
setTimeout(() => {
  if (typeof window.populateLocationCards === 'function') {
    console.log('‚úÖ populateLocationCards function is available');
  } else if (typeof populateTherapistCards === 'function') {
    // Only use as fallback if no better option exists
    console.log('‚ö†Ô∏è Using populateTherapistCards as fallback');
  }
}, 100);

// Immediate setup as backup
(function() {
})();
console.log('‚úÖ All therapist improvements applied');

// Responsive map sizing function
window.adjustMapSize = function(mapElement) {
  function updateMapSize() {
    const mapContainer = mapElement || document.getElementById('map-container');
    if (!mapContainer) return;
    
    if (window.innerWidth >= 640) {
      // Desktop/tablet: normal centered layout
      mapContainer.style.width = '100%';
      mapContainer.className = mapContainer.className.replace('-mx-12', '').replace('sm:mx-0', '');
      mapContainer.classList.add('mx-0');
    } else {
      // Mobile: full-width layout
      mapContainer.style.width = 'calc(100% + 6rem)';
      mapContainer.className = mapContainer.className.replace('mx-0', '-mx-12');
    }
  }
  
  // Initial adjustment
  updateMapSize();
  
  // Listen for window resize
  window.addEventListener('resize', updateMapSize);
};

// Auto-adjust map on page load
document.addEventListener('DOMContentLoaded', function() {
  const mapContainer = document.getElementById('map-container');
  if (mapContainer) {
    window.adjustMapSize(mapContainer);
  }
});
</script>

<!-- Removed problematic pagination script that created cards without Dr. prefix and had numbered photos -->
<script>

<!-- FINAL THERAPIST NAVIGATION FIX -->
<script>
// FINAL OVERRIDE - This runs last and should work
(function() {
    console.log("üîß FINAL THERAPIST NAVIGATION OVERRIDE STARTING...");
    
    // Define the navigation functions with absolute priority
    window.navigateToTherapistStepOne = function() {
        console.log("üìç [FINAL] Navigating to Therapist Step 1 with booking state reset");
        try {
            // RESET BOOKING STATE WHEN RETURNING TO THERAPIST LIST
            if (window.bookingState) {
                window.bookingState = {
                    currentTherapist: null,
                    selectedDate: null,
                    selectedTime: null,
                    selectedDuration: 1,
                    selectedService: null,
                    currentMonth: new Date().getMonth(),
                    currentYear: new Date().getFullYear()
                };
                console.log("‚úÖ [FINAL] Booking state reset");
            }
            
            // Hide all booking-related steps
            const step1 = document.getElementById("therapist-step-1");
            const step2 = document.getElementById("therapist-step-2"); 
            const step3 = document.getElementById("therapist-step-3-location");
            const step3Criteria = document.getElementById("therapist-step-3-criteria");
            const step3Quiz = document.getElementById("therapist-step-3-quiz");
            const stepBooking = document.getElementById("therapist-step-booking");
            const bookingCompleted = document.getElementById("booking-completed-section");
            
            if (step1) {
                step1.classList.remove("hidden");
                step1.style.display = "block";
                console.log("‚úÖ [FINAL] Step 1 shown");
            }
            if (step2) {
                step2.classList.add("hidden");
                step2.style.display = "none";
                console.log("‚úÖ [FINAL] Step 2 hidden");
            }
            if (step3) {
                step3.classList.add("hidden");
                step3.style.display = "none";
                console.log("‚úÖ [FINAL] Step 3 hidden");
            }
            if (step3Criteria) {
                step3Criteria.classList.add("hidden");
                step3Criteria.style.display = "none";
                console.log("‚úÖ [FINAL] Step 3 Criteria hidden");
            }
            if (step3Quiz) {
                step3Quiz.classList.add("hidden");
                step3Quiz.style.display = "none";
                console.log("‚úÖ [FINAL] Step 3 Quiz hidden");
            }
            if (stepBooking) {
                stepBooking.classList.add("hidden");
                stepBooking.style.display = "none";
                console.log("‚úÖ [FINAL] Booking step hidden");
            }
            if (bookingCompleted) {
                bookingCompleted.classList.add("hidden");
                bookingCompleted.style.display = "none";
                console.log("‚úÖ [FINAL] Booking completed section hidden");
            }
            
        } catch (error) {
            console.error("‚ùå [FINAL] Error in navigateToTherapistStepOne:", error);
        }
    };
    
    window.navigateToTherapistStepTwo = function() {
        console.log("üìç [FINAL] Navigating to Therapist Step 2");
        try {
            const step1 = document.getElementById("therapist-step-1");
            const step2 = document.getElementById("therapist-step-2");
            const step3 = document.getElementById("therapist-step-3-location");
            
            if (step1) {
                step1.classList.add("hidden");
                step1.style.display = "none";
                console.log("‚úÖ [FINAL] Step 1 hidden");
            }
            if (step2) {
                step2.classList.remove("hidden");
                step2.style.display = "block";
                console.log("‚úÖ [FINAL] Step 2 shown");
            }
            if (step3) {
                step3.classList.add("hidden");
                step3.style.display = "none";
                console.log("‚úÖ [FINAL] Step 3 hidden");
            }
        } catch (error) {
            console.error("‚ùå [FINAL] Error in navigateToTherapistStepTwo:", error);
        }
    };
    
    window.navigateToTherapistStepThree = function() {
        console.log("üìç [FINAL] Navigating to Therapist Step 3");
        try {
            const step1 = document.getElementById("therapist-step-1");
            const step2 = document.getElementById("therapist-step-2");
            const step3 = document.getElementById("therapist-step-3-location");
            
            if (step1) {
                step1.classList.add("hidden");
                step1.style.display = "none";
                console.log("‚úÖ [FINAL] Step 1 hidden");
            }
            if (step2) {
                step2.classList.add("hidden");
                step2.style.display = "none";
                console.log("‚úÖ [FINAL] Step 2 hidden");
            }
            if (step3) {
                step3.classList.remove("hidden");
                step3.style.display = "block";
                console.log("‚úÖ [FINAL] Step 3 shown");
            }
        } catch (error) {
            console.error("‚ùå [FINAL] Error in navigateToTherapistStepThree:", error);
        }
    };
    
    // Setup button event listeners with priority
    function setupButtons() {
        const backToTherapistsBtn = document.getElementById("back-to-therapists-btn");
        const backToOptionsBtn = document.getElementById("back-to-options-btn");
        
        if (backToTherapistsBtn) {
            // Remove any existing listeners
            backToTherapistsBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log("üîô [FINAL] Back to therapists clicked");
                window.navigateToTherapistStepOne();
                return false;
            };
            console.log("‚úÖ [FINAL] Back to therapists button configured");
        }
        
        if (backToOptionsBtn) {
            // Remove any existing listeners  
            backToOptionsBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log("üîô [FINAL] Back to options clicked");
                window.navigateToTherapistStepTwo();
                return false;
            };
            console.log("‚úÖ [FINAL] Back to options button configured");
        }
    }
    
    // Run immediately if DOM is ready, otherwise wait
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", setupButtons);
    } else {
        setupButtons();
    }
    
    // Also run after a short delay to ensure everything is loaded
    setTimeout(setupButtons, 500);
    
    console.log("‚úÖ [FINAL] Therapist navigation override complete!");
})();
</script>

<!-- Initialize Therapist Data for Location and Criteria Steps -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('üè• Initializing therapist data system...');
  
  // Initialize location step to use new data
  setTimeout(function() {
    const locationBtn = document.querySelector('.location-gradient');
    if (locationBtn) {
      const originalLocationClick = locationBtn.onclick;
      locationBtn.onclick = function(e) {
        if (originalLocationClick) originalLocationClick.call(this, e);
        
        // Populate location cards after navigation
        setTimeout(function() {
          if (typeof window.populateLocationCards === 'function') {
            window.forcePopulateLocationCards();
            console.log('‚úÖ Location therapist cards populated with proper data format');
          } else if (typeof window.populateLocationCards === 'function') {
            window.populateLocationCards();
            console.log('‚úÖ Fallback location cards populated');
          }
        }, 200);
      };
      console.log('‚úÖ Location button enhanced with therapist data');
    }
  }, 1000);
  
  console.log('‚úÖ Therapist data system initialized successfully');
});
</script>
<style>
/* ===== ULTRA STRONG APPLE-LIKE DESIGN - COMPLETE OVERRIDE ===== */
/* Using maximum CSS specificity to override all conflicting styles */

/* Step 2 Main Container - Maximum Specificity */
html body #therapist-step-2,
body #therapist-step-2,
#therapist-step-2.therapist-step-2,
#therapist-step-2 {
  background: transparent !important;
  background-image: none !important;
  background-color: transparent !important;
  background-color: rgba(255, 255, 255, 0) !important;
  padding: 2rem 1rem !important;
  margin: 0 !important;
  border: none !important;
  border-color: transparent !important;
  border-width: 0 !important;
  border-radius: 0 !important;
  box-shadow: none !important;
}

/* Step 2 Heading */
#therapist-step-2 h3 {
  color: #111827 !important;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  font-weight: 500 !important;
  font-size: 1.5rem !important;
  text-align: center !important;
}

/* Reset all gradient containers with Maximum Specificity */
html body #therapist-step-2 .location-gradient,
html body #therapist-step-2 .criteria-gradient,
html body #therapist-step-2 .quiz-gradient,
body #therapist-step-2 .location-gradient,
body #therapist-step-2 .criteria-gradient,
body #therapist-step-2 .quiz-gradient,
#therapist-step-2 .location-gradient,
#therapist-step-2 .criteria-gradient,
#therapist-step-2 .quiz-gradient {
  transform: scale(1) !important;
  transition: all 0.2s ease-in-out !important;
  opacity: 1 !important;
  background: none !important;
  background-color: transparent !important;
  background-image: none !important;
  border: none !important;
  border-width: 0 !important;
  border-color: transparent !important;
  box-shadow: none !important;
  cursor: pointer !important;
}

#therapist-step-2 .location-gradient:hover,
#therapist-step-2 .criteria-gradient:hover,
#therapist-step-2 .quiz-gradient:hover {
  transform: scale(1.02) !important;
}

#therapist-step-2 .location-gradient:active,
#therapist-step-2 .criteria-gradient:active,
#therapist-step-2 .quiz-gradient:active {
  transform: scale(0.98) !important;
}

/* Photo containers - Apple style with Maximum Specificity */
html body #therapist-step-2 .location-photo-container,
html body #therapist-step-2 .criteria-photo-container,
html body #therapist-step-2 .quiz-photo-container,
body #therapist-step-2 .location-photo-container,
body #therapist-step-2 .criteria-photo-container,
body #therapist-step-2 .quiz-photo-container,
#therapist-step-2 .location-photo-container,
#therapist-step-2 .criteria-photo-container,
#therapist-step-2 .quiz-photo-container {
  border-radius: 1rem !important;
  height: 200px !important;
  min-height: 200px !important;
  max-height: 200px !important;
  width: 100% !important;
  min-width: 100% !important;
  max-width: 100% !important;
  border: 1px solid rgba(0, 0, 0, 0.06) !important;
  border-color: rgba(0, 0, 0, 0.06) !important;
  border-width: 1px !important;
  border-style: solid !important;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
  transition: all 0.2s ease-in-out !important;
  opacity: 1 !important;
  background-color: transparent !important;
  background: transparent !important;
  position: relative !important;
  overflow: hidden !important;
  display: block !important;
}

#therapist-step-2 .location-photo-container:hover,
#therapist-step-2 .criteria-photo-container:hover,
#therapist-step-2 .quiz-photo-container:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
}

/* Text overlays - Apple style */
#therapist-step-2 .location-gradient h4,
#therapist-step-2 .criteria-gradient h4,
#therapist-step-2 .quiz-gradient h4 {
  color: white !important;
  font-size: 1.125rem !important;
  font-weight: 600 !important;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  margin-bottom: 0.25rem !important;
}

#therapist-step-2 .location-gradient p,
#therapist-step-2 .criteria-gradient p,
#therapist-step-2 .quiz-gradient p {
  color: rgba(255, 255, 255, 0.9) !important;
  font-size: 0.875rem !important;
  font-weight: 500 !important;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  margin: 0 !important;
}

/* Grid layout - Apple spacing */
#therapist-step-2 .grid {
  gap: 1.5rem !important;
  max-width: 80rem !important;
}

/* Apple-like Quiz Section Styles */
#therapist-step-3-quiz {
  background: transparent !important;
}

#therapist-step-3-quiz h2,
#therapist-step-3-quiz h3 {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  font-weight: 500 !important;
  color: #111827 !important;
}

#quiz-question-container .bg-white {
  border: 1px solid rgba(0, 0, 0, 0.06) !important;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
}

#quiz-question-container button {
  background: #f9fafb !important;
  border: 1px solid rgba(0, 0, 0, 0.08) !important;
  border-radius: 0.75rem !important;
  transition: all 0.2s ease-in-out !important;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
}

#quiz-question-container button:hover {
  background: #f3f4f6 !important;
  border-color: rgba(0, 0, 0, 0.12) !important;
  transform: scale(1.01) !important;
}

#quiz-question-container button:active {
  transform: scale(0.99) !important;
}

#quiz-progress-bar {
  background: #6b7280 !important;
}

/* Therapist Card Button Styling - Location and Criteria Steps */
/* Select Button - Apple-like color #446081 */
#therapist-cards-container button[onclick*="select"],
#therapist-cards-container button[onclick*="Select"],
#criteria-therapist-cards-container button[onclick*="select"],
#criteria-therapist-cards-container button[onclick*="Select"],
button[onclick*="selectTherapist"],
button[onclick*="navigateToBookingStep"],
.bg-gradient-to-r.from-blue-500.to-blue-600,
button[style*="background: #002855"],
button[style*="background: rgba(28, 181, 224, 0.1)"] {
  background: #446081 !important;
  background-image: none !important;
  border: none !important;
  color: white !important;
  font-family: system-ui, -apple-system, BlinkMacSystemFont !important;
}

/* Select Button Hover State */
#therapist-cards-container button[onclick*="select"]:hover,
#therapist-cards-container button[onclick*="Select"]:hover,
#criteria-therapist-cards-container button[onclick*="select"]:hover,
#criteria-therapist-cards-container button[onclick*="Select"]:hover,
button[onclick*="selectTherapist"]:hover,
button[onclick*="navigateToBookingStep"]:hover,
.bg-gradient-to-r.from-blue-500.to-blue-600:hover,
button[style*="background: #002855"]:hover,
button[style*="background: rgba(28, 181, 224, 0.1)"]:hover {
  background: #365870 !important;
  background-image: none !important;
  border: none !important;
}

/* Profile Button - Very thin border with same color as Find Therapist button */
#therapist-cards-container button[onclick*="Profile"],
#therapist-cards-container button[onclick*="viewTherapistProfile"],
#criteria-therapist-cards-container button[onclick*="Profile"],
#criteria-therapist-cards-container button[onclick*="viewTherapistProfile"],
button[onclick*="viewTherapistProfile"],
.bg-gray-100.text-gray-700 {
  background: white !important;
  border: 1px solid #212529 !important;
  color: #212529 !important;
}

/* Profile Button Hover State */
#therapist-cards-container button[onclick*="Profile"]:hover,
#therapist-cards-container button[onclick*="viewTherapistProfile"]:hover,
#criteria-therapist-cards-container button[onclick*="Profile"]:hover,
#criteria-therapist-cards-container button[onclick*="viewTherapistProfile"]:hover,
button[onclick*="viewTherapistProfile"]:hover,
.bg-gray-100.text-gray-700:hover {
  background: #f8f9fa !important;
  border: 1px solid #212529 !important;
  color: #212529 !important;
}
</style>
<script src="smooth-navigation.js"></script>
